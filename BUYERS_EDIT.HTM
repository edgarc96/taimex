<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>TAIMEX - Buyers System</title>
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Base Styles - Exact from CUSTSEARCHSO_EDIT.HTML */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100%; overflow: hidden; overflow-x: hidden; overflow-y: hidden; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            background-attachment: scroll;
            color: #334155;
        }

        .container {
            width: 100%; height: 100%; background: #ffffff;
            display: flex; flex-direction: column; overflow: hidden; overflow-x: hidden;
            position: fixed; inset: 0; /* lock to viewport to prevent page scroll */
        }

        /* Header - Exact CUSTSEARCHSO Style */
        .header {
            background: linear-gradient(135deg, #1e293b 0%, #1e3a8a 100%);
            color: #ffffff;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            box-shadow: 0 2px 8px rgba(30, 41, 59, 0.25);
            flex-shrink: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
            z-index: 1;
        }
        .hamburger-menu {
            background: none;
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }
        .hamburger-menu:hover { background-color: rgba(255, 255, 255, 0.1); }

        .header .logo-section {
            position: relative;
            z-index: 1;
        }

        .header .logo-section img {
            height: 40px;
            width: auto;
            object-fit: contain;
            filter: brightness(1.1);
        }

        .header .logo-section h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.8em;
            margin: 0;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: white;
            position: relative;
            z-index: 1;
            display: none;
        }

        .welcome-user {
            position: relative;
            z-index: 1;
            white-space: nowrap;
            min-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .welcome-user span {
            color: #cbd5e1;
            font-size: 0.8em;
            font-weight: 400;
        }

        .welcome-user strong {
            color: #3b82f6;
            font-weight: 600;
            margin-left: 4px;
        }

        .header .title-section {
            text-align: right;
            position: relative;
            z-index: 1;
            min-width: 0;
            overflow: hidden;
        }

        .title-row {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 15px;
            min-width: 0;
            overflow: hidden;
            flex: 1;
        }

        .header .title-section h2 {
            font-size: 0.95em;
            margin: 0;
            font-weight: 500;
            color: #cbd5e1;
            letter-spacing: 0.3px;
        }

        .header .title-section p {
            font-size: 0.75em;
            margin: 2px 0 0 0;
            color: #a2a8ba;
            font-weight: 400;
        }

        /* Sidebar - Exact CUSTSEARCHSO Style */
        .sidebar {
            position: fixed;
            top: 0;
            left: 0;
            transform: translateX(-100%);
            width: 300px;
            height: 100%;
            background: rgba(255, 255, 255, .08);
            backdrop-filter: blur(1px);
            -webkit-backdrop-filter: blur(1px);
            color: white;
            transition: transform 0.2s ease;
            z-index: 2000;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
        }
        .sidebar.active { transform: translateX(0); }
        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); opacity: 0; visibility: hidden;
            transition: all 0.3s ease; z-index: 999; pointer-events: none;
        }
        .sidebar-overlay.active { opacity: 1; visibility: visible; pointer-events: auto; }

        .sidebar-content {
            padding: 24px;
        }

        .sidebar-header {
            padding: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
        }
        .sidebar-header h3 { font-size: 1.2em; color: white; margin: 0; }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu li {
            margin-bottom: 8px;
        }

        .sidebar-menu a {
            display: block;
            padding: 12px 16px;
            color: #f3f4f6;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .sidebar-menu a:hover {
            background-color: rgba(30, 64, 175, 0.1);
            color: white;
        }

        .sidebar-menu a.active {
            background-color: rgba(30, 64, 175, 0.2);
            color: #93c5fd;
        }

        .sidebar-menu a i { margin-right: 12px; width: 20px; text-align: center; }

        /* Main Content & Tabs */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; overflow-x: hidden; min-height: 0; }
        .main-content.v2 { min-height: 0; }

        /* Tab Navigation - Liquid Glass */
        .tab-navigation {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .tab-buttons { display: flex; min-width: 0; overflow: hidden; flex-wrap: wrap; }
        .tab-button {
            background: none; border: none; padding: 12px 20px; color: #64748b;
            font-weight: 500; cursor: pointer; transition: all 0.3s ease;
            border-bottom: 3px solid transparent; display: flex; align-items: center; gap: 8px;
        }
        .tab-button:hover { color: #1e40af; background: rgba(30, 64, 175, 0.05); }
        .tab-button.active {
            color: #1e40af; background: rgba(30, 64, 175, 0.1);
            border-bottom-color: #1e40af; font-weight: 600;
        }

        .tab-content { flex: 1; overflow: hidden; }
        .tab-pane { display: none; height: 100%; overflow-y: auto; padding: 16px; background: #f8fafc; }
        .tab-pane.active { display: block; }

        /* Form Styles - Liquid Glass */
        .form-container {
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px);
            border-radius: 16px; padding: 20px; margin-bottom: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .form-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px; margin-bottom: 16px;
        }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; color: #374151; margin-bottom: 8px; }
        .form-group input {
            padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 8px;
            transition: all 0.2s ease; background: rgba(255, 255, 255, 0.8);
        }
        .form-group input:focus {
            outline: none; border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        .form-group textarea {
            padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 8px;
            transition: all 0.2s ease; background: rgba(255, 255, 255, 0.8);
            resize: vertical; font-family: inherit;
        }
        .form-group textarea:focus {
            outline: none; border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-actions { display: flex; gap: 12px; justify-content: flex-end; }
        .btn {
            padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600;
            cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white;
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
        .btn-secondary { background: rgba(107, 114, 128, 0.1); color: #374151; border: 1px solid #d1d5db; }

        /* Excel Grid Wrapper - Exact from CUSTSEARCHSO_EDIT.HTML */
        .excel-grid-wrapper {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .excel-grid-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            border: 1px solid #dee2e6;
            border-radius: 0 0 12px 12px;
            background: white;
            position: relative;
            min-height: 250px;
            max-height: calc(100vh - 200px);
            height: calc(100vh - 200px);
            margin-top: 8px;
        }

        .excel-grid-container::-webkit-scrollbar {
            width: 12px;
        }

        .excel-grid-container::-webkit-scrollbar-track {
            background: #f1f3f4;
            border-radius: 6px;
        }

        .excel-grid-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            border-radius: 6px;
            border: 2px solid #f1f3f4;
        }

        .excel-grid-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }

        .excel-grid-container::-webkit-scrollbar-corner {
            background: #f1f3f4;
        }

        .grid-header {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 20px 24px; border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            display: flex; justify-content: space-between; align-items: center;
        }
        .grid-title { font-size: 1.1em; font-weight: 600; color: #1e293b; margin: 0; }
        .grid-stats {
            background: rgba(59, 130, 246, 0.1); padding: 4px 12px;
            border-radius: 20px; font-size: 0.85em; color: #64748b;
        }

        .excel-grid-premium {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 11px;
            background: white;
            min-width: 1000px;
            border: 1px solid #dee2e6;
        }

        .excel-header {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
            padding: 8px 12px;
            font-weight: 600;
            text-align: left;
            border-right: 1px solid #1e3c72;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            font-size: 11px;
        }

        .excel-header:hover {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }

        .excel-header.sorted {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .excel-header:last-child {
            border-right: none;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .sort-icon {
            opacity: 0.7;
            font-size: 12px;
            transition: opacity 0.2s ease;
        }

        .excel-header:hover .sort-icon {
            opacity: 1;
        }

        .resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            cursor: col-resize;
            background: rgba(255, 255, 255, 0.2);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .excel-header:hover .resize-handle {
            opacity: 1;
        }

        .excel-row {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .excel-row:nth-child(even) {
            background: #f8f9fa;
        }

        .excel-row:hover {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .excel-row.selected {
            background: linear-gradient(135deg, #2196f3 0%, #9c27b0 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }

        .excel-cell {
            padding: 6px 10px;
            border-right: 1px solid #dee2e6;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
            position: relative;
            font-size: 11px;
        }

        /* Read-only look for non-editable fields */
        .excel-cell.readonly { background: #f3f4f6; }
        .excel-cell.readonly .cell-content { color: #6b7280; }

        /* Price range editor rows */
        .price-range-row { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 8px; align-items: center; margin-bottom: 8px; }
        .price-range-row input[type="number"] { width: 100%; padding: 6px 8px; border: 1px solid #cbd5e1; border-radius: 6px; }
        .price-range-row .remove-range { background: #ef4444; color: white; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; }

        .excel-cell:last-child {
            border-right: none;
        }

        .cell-content {
            display: flex;
            align-items: center;
            min-height: 20px;
            padding:9px;
            margin-top: 2.4px
        }

        .customer-code-cell {
            font-weight: 600;
            color: #2a5298;
            cursor: pointer;
        }

        .customer-code-cell:hover {
            text-decoration: underline;
        }

        .part-number-cell {
            font-weight: 600;
            color: #2a5298;
            cursor: pointer;
        }

        .part-number-cell:hover {
            text-decoration: underline;
        }

        /* Grid Toolbar Styles */
        .grid-toolbar {
            background: #f8f9fa;
            padding: 12px 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toolbar-left .results-count {
            color: #6c757d;
            font-size: 14px;
            font-weight: 500;
        }

        .toolbar-left .results-count i {
            margin-right: 8px;
            color: #2a5298;
        }

        .toolbar-right {
            display: flex;
            gap: 10px;
        }

        .grid-btn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .grid-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(42, 82, 152, 0.4);
        }
        /* Search container (match Salesman) */
        .search-container { 
            width: 100%; 
            margin: 8px 0 12px 0; 
            display: flex; 
            justify-content: flex-start; 
        }
        .search-container input#searchInput { 
            width: 100%; 
            max-width: 420px; 
            padding: 10px 12px; 
            border: 2px solid #e5e7eb; 
            border-radius: 8px; 
            background: rgba(255,255,255,0.95); 
            transition: all .2s ease; 
        }
        .search-container input#searchInput:focus { 
            outline: none; 
            border-color: #3b82f6; 
            box-shadow: 0 0 0 3px rgba(59,130,246,.12); 
        }

        /* Filter Row Styles */
        .filter-row {
            background: #f8f9fa;
            position: sticky;
            top: 40px;
            z-index: 9;
        }

        .filter-cell {
            padding: 8px;
            border-right: 1px solid #dee2e6;
            border-bottom: 2px solid #dee2e6;
            background: #f8f9fa;
        }

        .filter-cell:last-child {
            border-right: none;
        }

        .filter-input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
            background: white;
            transition: all 0.2s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 2px rgba(42, 82, 152, 0.2);
        }

        /* Column widths to mirror Salesman layout */
        #buyersV2Root #buyers-v2-tab-1 .excel-grid-premium thead tr:first-child th:nth-child(1) { width: 120px; }
        #buyersV2Root #buyers-v2-tab-1 .excel-grid-premium thead tr:first-child th:nth-child(2) { width: 420px; }
        #buyersV2Root #buyers-v2-tab-1 .excel-grid-premium thead tr:first-child th:nth-child(3) { width: 160px; }
        #buyersV2Root #buyers-v2-tab-1 .excel-grid-premium thead tr:first-child th:nth-child(4) { width: 140px; cursor: default; }

        /* Buyers V2: Full-page Search & View layout like STOCKTRANS */
        #buyersV2Root { min-height: 0; }
        #buyersV2Root .tab-content { display: flex; flex-direction: column; min-height: 0; flex: 1; }
        #buyersV2Root .tab-navigation { flex-shrink: 0; }
        #buyersV2Root .tab-pane { flex: 1; height: 100%; overflow: hidden; min-height: 0; padding: 0; }
        #buyersV2Root .tab-pane.active { display: flex; flex-direction: column; }
        #buyersV2Root #buyers-v2-tab-1 .form-container { flex: 1; display: flex; flex-direction: column; align-items: stretch; min-height: 0; }
        #buyersV2Root #buyers-v2-tab-1 .excel-grid-wrapper { flex: 1; display: flex; flex-direction: column; min-width: 0; }
        #buyersV2Root .excel-grid-container { flex: 1; height: auto; max-height: none; min-height: 0; min-width: 0; overflow-y: auto; overflow-x: hidden; }
        #buyersV2Root .search-container input#searchInput { max-width: none; }
        #buyersV2Root .excel-grid-wrapper, #buyersV2Root .tab-content { overflow: hidden; }
        #buyersV2Root { overflow-x: hidden; }
        #buyersV2Root .excel-grid-premium { min-width: 0; table-layout: fixed; width: 100%; }
        #buyersV2Root .excel-grid-premium th, 
        #buyersV2Root .excel-grid-premium td { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        #buyersV2Root .grid-toolbar, 
        #buyersV2Root .grid-toolbar .toolbar-left, 
        #buyersV2Root .grid-toolbar .toolbar-right { min-width: 0; overflow: hidden; }
        
        /* Force width constraints to prevent page-level scroll */
        #buyersV2Root, #buyersV2Root .tab-content, #buyersV2Root .tab-pane { width: 100%; max-width: 100%; }
        #buyersV2Root .excel-grid-premium .header-content { min-width: 0; overflow: hidden; text-overflow: ellipsis; }
        #buyersV2Root .filter-row input { min-width: 0; max-width: 100%; }
        #buyersV2Root .excel-grid-premium .filter-input { width: 100%; min-width: 0; max-width: none; }
        
        /* Aggressive scroll prevention - override any global rules */
        html, body { overflow: hidden !important; height: 100%; }
        .container { height: 100vh; }
        .main-content { overflow: hidden !important; }
        #buyersV2Root .excel-grid-container { overflow-y: auto !important; overflow-x: hidden !important; -webkit-overflow-scrolling: touch; }
    </style>

    <script>
    // Hard-lock page scroll; allow scrolling only inside specific containers
    (function(){
      function isAllowedScrollTarget(target){
        if(!target) return false;
        if(target.closest && target.closest('.excel-grid-container, .sidebar, .sidebar-content')) return true;
        return false;
      }
      function preventBodyWheel(e){
        if(!isAllowedScrollTarget(e.target)){
          e.preventDefault();
        }
      }
      function preventBodyKeys(e){
        var keys = ['PageUp','PageDown','Home','End','ArrowUp','ArrowDown','ArrowLeft','ArrowRight',' '];
        if(keys.indexOf(e.key) !== -1 && !isAllowedScrollTarget(e.target)){
          e.preventDefault();
        }
      }
      function lockPageScroll(){
        document.documentElement.style.overflow = 'hidden';
        if(document.body){ document.body.style.overflow = 'hidden'; }
        document.addEventListener('wheel', preventBodyWheel, { passive: false });
        document.addEventListener('touchmove', preventBodyWheel, { passive: false });
        document.addEventListener('keydown', preventBodyKeys, { passive: false });
      }
      if(document.body){ lockPageScroll(); }
      else { document.addEventListener('DOMContentLoaded', lockPageScroll); }
    })();
    </script>

        .action-buttons { display: flex; gap: 8px; }
        .btn-sm {
            padding: 6px 12px; font-size: 0.8em; border-radius: 6px;
            border: none; cursor: pointer; transition: all 0.2s ease;
            font-weight: 500;
        }
        .btn-edit { 
            background: #28a745; 
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 32px;
        }
        .btn-edit:hover { 
            background: #218838; 
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }
        .btn-delete { 
            background: #007bff; 
            color: white; 
        }
        .btn-delete:hover { 
            background: #0056b3; 
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        /* Success Notification Styles */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            pointer-events: none;
        }

        .notification {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            font-size: 14px;
            min-width: 300px;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-left: 4px solid #34d399;
            backdrop-filter: blur(10px);
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.hide {
            transform: translateX(400px);
            opacity: 0;
        }

        .notification-icon {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            animation: pulse 2s infinite;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .notification-message {
            font-size: 13px;
            opacity: 0.9;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes slideInBounce {
            0% {
                transform: translateX(400px) scale(0.8);
                opacity: 0;
            }
            60% {
                transform: translateX(-10px) scale(1.02);
                opacity: 1;
            }
            100% {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }

        .notification.bounce {
            animation: slideInBounce 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Error Notification Styles */
        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
            border-left: 4px solid #f87171;
        }

        /* Warning Notification Styles */
        .notification.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
            border-left: 4px solid #fbbf24;
        }

        /* Info Notification Styles */
        .notification.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
            border-left: 4px solid #60a5fa;
        }

        /* Loading Notification Styles */
        .notification.loading {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
            border-left: 4px solid #34d399;
        }

        .notification.loading .notification-icon i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Price Ranges Styles */
        .price-ranges-section {
            margin: 16px 0;
            padding: 16px;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 2px solid #3b82f6;
            border-radius: 8px;
            text-align: right;
        }

        .price-range-row {
            margin-bottom: 8px;
            padding: 12px;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 1px solid #3b82f6;
            border-radius: 6px;
            position: relative;
            text-align: right;
        }

        .price-range-row:last-child {
            margin-bottom: 0;
        }

        .price-range-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 16px;
            align-items: end;
            justify-items: end;
            text-align: right;
        }

        .price-range-grid .form-group {
            margin-bottom: 0;
            text-align: right;
        }

        .price-range-grid input {
            text-align: right;
        }
        .price-range-grid label {
            text-align: right;
            display: block;
        }

        .price-range-grid input {
            text-align: right;
        }

        .ranges-cell {
            text-align: right;
        }
        .ranges-cell .cell-content {
            display: flex;
            justify-content: flex-end; /* push container to the right */
            width: 100%;
        }
        .price-ranges-vertical {
            display: flex;
            flex-direction: column;
            align-items: flex-end;     /* right-align each row */
            gap: 6px;
            width: 100%;
        }
        .price-ranges-vertical .range-badge {
            background: #dbeafe;
            color: #1e40af;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85em;
            white-space: nowrap;       /* keep each badge on one line */
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 0.875rem;
            height: auto;
        }

        .price-range-row .btn-danger {
            background: #3b82f6;
            border-color: #3b82f6;
        }

        .price-range-row .btn-danger:hover {
            background: #2563eb;
            border-color: #2563eb;
        }

        @media (max-width: 768px) {
            .price-range-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .price-range-grid .form-group:last-child {
                justify-self: start;
            }
        }
        
        /* Enhanced New Search Button Styles */
        #newSearchButtonContainer {
            display: none;
            margin-top: 20px;
            text-align: center;
            padding: 20px;
            background: #dbeafe;
            border: 2px solid #3b82f6;
            border-radius: 8px;
        }

        #newSearchButtonContainer button {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
            transition: all 0.3s ease;
        }

        #newSearchButtonContainer button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.4);
            background: linear-gradient(135deg, #047857 0%, #059669 100%);
        }

        #newSearchButtonContainer p {
            margin: 0 0 15px 0;
            color: #92400e;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Menu</h3>
        </div>
        <div class="sidebar-content">
            <ul class="sidebar-menu">
                <li><a href="#" class="active">Customer Search</a></li>
                <li><a href="#">Sales Orders</a></li>
                <li><a href="#">Reports</a></li>
                <li><a href="#">Customer Management</a></li>
                <li><a href="#">Settings</a></li>
                <li><a href="#">Help</a></li>
            </ul>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-left">
                <button class="hamburger-menu" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo-section">
                    <img src="uploads/assets/images/taimex_logo.png" alt="TAIMEX" onerror="showFallbackLogo(this)">
                    <h1 id="fallbackLogo">TAIMEX</h1>
                </div>
            </div>
            <div class="title-section">
                <div class="title-row">
                    <div class="welcome-user">
                        <span>Welcome</span><strong>Admin User</strong>
                    </div>
                    <div>
                        <h2>Buyers System</h2>
                        <p>ABC (Altas, Bajas, Cambios)</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buyers V2: standardized minimal UI (INITIALS, NAME, Date) -->
        <style>#legacyBuyerMain{display:none !important;}</style>
        <div class="main-content v2" id="buyersV2Root">
          <div class="tab-navigation">
            <div class="tab-buttons">
              <button type="button" class="tab-button active" data-v2-tab="0" onclick="return buyersV2_switchTab(0)"><i class="fas fa-plus"></i>Captura de Datos</button>
              <button type="button" class="tab-button" data-v2-tab="1" onclick="return buyersV2_switchTab(1)"><i class="fas fa-search"></i>Buscar y Ver</button>
            </div>
          </div>
          <div class="tab-content">
            <div class="tab-pane active" id="buyers-v2-tab-0">
              <div class="form-container">
                <h3 style="margin-bottom:24px; color:#1e293b;">Captura de Datos</h3>
                <style>
                  .form-group.required>label::after{content:" *";color:#ef4444;margin-left:4px}
                  .info-alert{display:flex;gap:10px;align-items:flex-start;background:#eff6ff;border-left:4px solid #3b82f6;padding:12px 16px;border-radius:8px;color:#1e3a8a;margin-bottom:16px}
                  .info-alert i{color:#3b82f6;margin-top:2px}
                  .tab-pane .form-container{max-width:none;width:100%;margin:0;padding:20px 40px;display:flex;flex-direction:column;align-items:center}
                  .form-grid{display:flex;flex-direction:column;gap:16px;max-width:500px;width:100%}
                  .form-group{width:100%}
                </style>
                <div class="info-alert"><i class="fas fa-info-circle"></i><div><strong>Importante:</strong> Los campos marcados con <span style="color:#ef4444">*</span> son obligatorios. Este módulo es solo para crear compradores (Iniciales y Nombre). No requiere autorización de transacción.</div></div>
                <form class="form-grid" onsubmit="return false;" id="buyersV2Form">
                  <div class="form-group required">
                    <label for="buyersV2_initials">Iniciales</label>
                    <input type="text" id="buyersV2_initials" name="initials" placeholder="Iniciales" required aria-required="true" maxlength="10" onkeydown="handleInitialsKeyDown(event)" style="text-transform: uppercase;">
                  </div>
                  <div class="form-group required">
                    <label for="buyersV2_name">Nombre</label>
                    <input type="text" id="buyersV2_name" name="name" placeholder="Nombre (se auto-completa desde OPERS)" required aria-required="true" maxlength="120" readonly style="background: #f3f4f6;">
                  </div>
                </form>
                <div class="form-actions">
                  <button type="button" class="btn btn-primary" onclick="return handleSave()"><i class="fas fa-save"></i> Guardar</button>
                  <button type="button" class="btn btn-secondary" onclick="return handleClear()"><i class="fas fa-undo"></i> Limpiar</button>
                </div>
              </div>
            </div>
            <div class="tab-pane" id="buyers-v2-tab-1">
              <div class="form-container">
                <h3 style="margin-bottom:24px; color:#1e293b;">Buscar y Ver</h3>
                <div class="info-alert"><i class="fas fa-info-circle"></i><div><strong>Consejo:</strong> Puedes buscar por texto y filtrar por columna. Haz clic en los encabezados para ordenar. Si aplica, ambas partes del número de parte son requeridas para búsquedas exactas.</div></div>
                <div class="search-container">
                  <input type="text" id="searchInput" placeholder="Buscar..." oninput="return handleSearch(this.value)">
                </div>
                <div class="excel-grid-wrapper">
                  <div class="grid-toolbar">
                    <div class="toolbar-left"><span class="results-count"><i class="fas fa-database"></i> <span id="recordsCount">0 registros mostrados</span></span></div>
                    <div class="toolbar-right">
                      <button type="button" class="grid-btn" onclick="alert('Función deshabilitada - usar auto-fill por iniciales')" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white;"><i class="fas fa-cloud-download-alt"></i> Cargar de PicLan (Deshabilitado)</button>
                      <button type="button" class="grid-btn" onclick="return exportToCSV()"><i class="fas fa-download"></i> Exportar CSV</button>
                      <button type="button" class="grid-btn" onclick="return clearFilters()"><i class="fas fa-times"></i> Limpiar Filtros</button>
                      <button type="button" class="grid-btn" onclick="return manualCleanupLocalStorage()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;"><i class="fas fa-broom"></i> Limpiar Caché</button>
                    </div>
                  </div>
                  <div class="excel-grid-container">
                    <table class="excel-grid-premium">
                      <thead>
                        <tr>
                          <th class="excel-header" onclick="return sortTable(0)"><div class="header-content"><i class="fas fa-tag"></i> INICIALES<i class="fas fa-sort sort-icon"></i></div><span class="resize-handle"></span></th>
                          <th class="excel-header" onclick="return sortTable(1)"><div class="header-content"><i class="fas fa-file-alt"></i> NOMBRE<i class="fas fa-sort sort-icon"></i></div><span class="resize-handle"></span></th>
                          <th class="excel-header" onclick="return sortTable(2)"><div class="header-content"><i class="fas fa-calendar-alt"></i> Fecha<i class="fas fa-sort sort-icon"></i></div><span class="resize-handle"></span></th>
                          <th class="excel-header actions-header"><div class="header-content"><i class="fas fa-cogs"></i> Acciones</div></th>
                        </tr>
                        <tr class="filter-row">
                          <th class="filter-cell"><input type="text" class="filter-input" placeholder="Filtrar INICIALES..." id="filter_initials" onkeyup="return filterRecords()"></th>
                          <th class="filter-cell"><input type="text" class="filter-input" placeholder="Filtrar NOMBRE..." id="filter_name" onkeyup="return filterRecords()"></th>
                          <th class="filter-cell"><input type="date" class="filter-input" placeholder="Filtrar Fecha..." id="filter_date" onchange="return filterRecords()"></th>
                          <th class="filter-cell"></th>
                        </tr>
                      </thead>
                      <tbody id="recordsTableBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <script>
        (function(){
          'use strict';
          // Notifications
          function buyersV2_initNotifications(){
            var c = document.getElementById('notificationContainer');
            if(!c){ 
              c = document.createElement('div'); 
              c.id='notificationContainer'; 
              c.className='notification-container'; 
              document.body.appendChild(c); 
            }
            // Ensure container is visible and positioned correctly
            c.style.position = 'fixed';
            c.style.top = '20px';
            c.style.right = '20px';
            c.style.zIndex = '9999';
            c.style.pointerEvents = 'none';
          }
          function buyersV2_notifySuccess(t,m){ 
            buyersV2_initNotifications(); 
            var k=document.getElementById('notificationContainer'); 
            var n=document.createElement('div'); 
            n.className='notification success-notification'; 
            n.style.cssText = `
              background: linear-gradient(145deg, #10b981 0%, #059669 50%, #047857 100%);
              color: white;
              padding: 24px 28px;
              border-radius: 16px;
              margin-bottom: 16px;
              box-shadow: 
                0 20px 40px rgba(16, 185, 129, 0.25),
                0 8px 16px rgba(16, 185, 129, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
              border: 1px solid rgba(52, 211, 153, 0.3);
              display: flex;
              align-items: center;
              gap: 20px;
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
              font-size: 15px;
              font-weight: 500;
              min-width: 360px;
              max-width: 420px;
              backdrop-filter: blur(20px) saturate(180%);
              transform: translateX(450px);
              opacity: 0;
              transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
              position: relative;
              overflow: hidden;
            `;
            n.innerHTML=`
              <div style="
                background: linear-gradient(135deg, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.15) 100%);
                border-radius: 50%;
                width: 48px;
                height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                border: 2px solid rgba(255,255,255,0.3);
              ">
                <i class="fas fa-check" style="font-size: 20px; text-shadow: 0 1px 2px rgba(0,0,0,0.2);"></i>
              </div>
              <div style="flex: 1;">
                <div style="
                  font-weight: 700; 
                  font-size: 16px; 
                  margin-bottom: 6px;
                  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
                  letter-spacing: 0.3px;
                ">${t||'✓ Guardado Exitoso'}</div>
                ${m ? `<div style="
                  font-size: 14px; 
                  opacity: 0.92; 
                  line-height: 1.5;
                  font-weight: 400;
                ">${m}</div>` : ''}
              </div>
              <div style="
                position: absolute;
                top: 0;
                right: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(45deg, transparent 0%, rgba(255,255,255,0.1) 50%, transparent 100%);
                pointer-events: none;
              "></div>
            `; 
            k.appendChild(n); 
            
            // Animate in
            setTimeout(function(){
              n.style.transform = 'translateX(0)';
              n.style.opacity = '1';
            }, 50);
            
            // Animate out
            setTimeout(function(){
              n.style.transform = 'translateX(400px)';
              n.style.opacity = '0';
              setTimeout(function(){ 
                if(n.parentNode) n.parentNode.removeChild(n); 
              }, 500);
            }, 3500); 
          }
          function buyersV2_notifyError(t,m){ 
            buyersV2_initNotifications(); 
            var k=document.getElementById('notificationContainer'); 
            var n=document.createElement('div'); 
            n.className='notification error-notification'; 
            n.style.cssText = `
              background: linear-gradient(145deg, #ef4444 0%, #dc2626 50%, #b91c1c 100%);
              color: white;
              padding: 24px 28px;
              border-radius: 16px;
              margin-bottom: 16px;
              box-shadow: 
                0 20px 40px rgba(239, 68, 68, 0.25),
                0 8px 16px rgba(239, 68, 68, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
              border: 1px solid rgba(248, 113, 113, 0.3);
              display: flex;
              align-items: center;
              gap: 20px;
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', sans-serif;
              font-size: 15px;
              font-weight: 500;
              min-width: 360px;
              max-width: 420px;
              backdrop-filter: blur(20px) saturate(180%);
              transform: translateX(450px);
              opacity: 0;
              transition: all 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
              position: relative;
              overflow: hidden;
            `;
            n.innerHTML=`
              <div style="
                background: linear-gradient(135deg, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.15) 100%);
                border-radius: 50%;
                width: 48px;
                height: 48px;
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                border: 2px solid rgba(255,255,255,0.3);
              ">
                <i class="fas fa-exclamation-triangle" style="font-size: 20px; text-shadow: 0 1px 2px rgba(0,0,0,0.2);"></i>
              </div>
              <div style="flex: 1;">
                <div style="
                  font-weight: 700; 
                  font-size: 16px; 
                  margin-bottom: 6px;
                  text-shadow: 0 1px 2px rgba(0,0,0,0.1);
                  letter-spacing: 0.3px;
                ">${t||'⚠ Error'}</div>
                ${m ? `<div style="
                  font-size: 14px; 
                  opacity: 0.92; 
                  line-height: 1.5;
                  font-weight: 400;
                ">${m}</div>` : ''}
              </div>
              <div style="
                position: absolute;
                top: 0;
                right: 0;
                width: 100%;
                height: 100%;
                background: linear-gradient(45deg, transparent 0%, rgba(255,255,255,0.1) 50%, transparent 100%);
                pointer-events: none;
              "></div>
            `; 
            k.appendChild(n); 
            
            // Animate in
            setTimeout(function(){
              n.style.transform = 'translateX(0)';
              n.style.opacity = '1';
            }, 50);
            
            // Animate out
            setTimeout(function(){
              n.style.transform = 'translateX(400px)';
              n.style.opacity = '0';
              setTimeout(function(){ 
                if(n.parentNode) n.parentNode.removeChild(n); 
              }, 500);
            }, 4000); 
          }

          // Storage
          function buyersV2_storageKey(){ return 'taimex_records_buyers_v2'; }
          function buyersV2_load(){ try{ var t=localStorage.getItem(buyersV2_storageKey()); return t?JSON.parse(t):[]; }catch(e){ console.error(e); return []; } }
          function buyersV2_save(list){ try{ localStorage.setItem(buyersV2_storageKey(), JSON.stringify(list||[])); }catch(e){ console.error(e); } }

          // Tabs
          window.buyersV2_switchTab = function(i){ try{ var root=document.getElementById('buyersV2Root'); if(!root) return false; var btns=root.querySelectorAll('.tab-button'); var panes=root.querySelectorAll('.tab-pane'); for(var x=0;x<btns.length;x++){ btns[x].classList.toggle('active', x===i);} for(var y=0;y<panes.length;y++){ panes[y].classList.toggle('active', y===i);} var si=document.getElementById('searchInput'); buyersV2_renderGrid(si?si.value:''); buyersV2_updateSortUI(); }catch(e){ console.error(e);} return false; };

          // Autorización eliminada: este módulo no requiere autorización de transacción
          // Nuevo contenedor de confirmación de captura (solo Iniciales y Nombre)
          function buyersV2_ensureCreateStyles(){ try{ if(document.getElementById('createHelperStyles')) return; var css=''+
            '.creation-section{margin:16px 0;padding:16px;background:linear-gradient(135deg,#eff6ff 0%,#dbeafe 100%);border:2px solid #3b82f6;border-radius:8px;width:100%;align-self:stretch}'+
            '.creation-header{margin:24px 0 16px 0;color:#1e293b;display:flex;align-items:center;gap:8px}'+
            '.creation-grid{display:grid;grid-template-columns:1fr 1fr auto;gap:16px;align-items:end}'+
            '.creation-grid .form-group{margin-bottom:0}'+
            '.creation-grid label{display:block;font-weight:600;color:#374151;margin-bottom:6px}'+
            '.creation-grid input{padding:8px 12px;border:2px solid #e5e7eb;border-radius:6px;transition:all .2s ease;background:rgba(255,255,255,.95)}'+
            '.creation-grid input:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.12)}'+
            '.creation-actions{margin-top:12px;text-align:right}'+
            '.creation-section .btn-primary{background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);border-color:#2563eb;color:#fff}'+
            '.creation-section .btn-primary:hover{background:linear-gradient(135deg,#2563eb 0%,#1e40af 100%);border-color:#1e40af}'+
            '.btn-sm{padding:8px 12px;font-size:.875rem;height:auto;border:none;border-radius:6px;cursor:pointer}'+
            '@media (max-width:768px){.creation-grid{grid-template-columns:1fr;gap:12px}}';
            var style=document.createElement('style'); style.id='createHelperStyles'; style.type='text/css'; style.appendChild(document.createTextNode(css)); document.head.appendChild(style); }catch(e){ console.error(e);} }
          function buyersV2_ensureCreate(){ try{ if(document.getElementById('buyersV2Create')) return; buyersV2_ensureCreateStyles(); var c=document.createElement('div'); c.id='buyersV2Create'; c.className='creation-section'; c.style.display='none'; c.innerHTML=''+
            '<h4 class="creation-header"><i class="fas fa-user-plus"></i> Confirmar Captura</h4>'+
            '<div class="creation-grid">'+
            '  <div class="form-group"><label for="buyersV2CreateInitials">Iniciales <span style="color:#ef4444;">*</span></label><input type="text" id="buyersV2CreateInitials" maxlength="10" placeholder="Iniciales" autocomplete="off"></div>'+
            '  <div class="form-group"><label for="buyersV2CreateName">Nombre <span style="color:#ef4444;">*</span></label><input type="text" id="buyersV2CreateName" maxlength="120" placeholder="Nombre" autocomplete="off"></div>'+
            '  <div class="form-group" style="align-self:end"><button type="button" class="btn btn-primary btn-sm" onclick="buyersV2_confirmCreate()"><i class="fas fa-check"></i> Guardar</button></div>'+
            '</div>'+
            '<div class="creation-actions"><button type="button" class="btn btn-secondary btn-sm" onclick="buyersV2_closeCreate()"><i class="fas fa-times"></i> Cancelar</button></div>';
            var actions=document.querySelector('#buyers-v2-tab-0 .form-container .form-actions'); if(actions && actions.parentNode){ actions.parentNode.insertBefore(c, actions.nextSibling); } else { var fc=document.querySelector('#buyers-v2-tab-0 .form-container'); if(fc) fc.appendChild(c); }
            // key handlers inside the creation container
            try {
              var ii=c.querySelector('#buyersV2CreateInitials');
              var nn=c.querySelector('#buyersV2CreateName');
              [ii, nn].forEach(function(el){ if(el && !el.__bindCreateKeys){ el.addEventListener('keydown', window.buyersV2_handleCreateKeyDown); el.__bindCreateKeys=true; }});
            } catch(e2){ console.error(e2); }
          }catch(e){ console.error(e);} }
          async function buyersV2_openCreate(){ try{ buyersV2_ensureCreate(); var code=(document.getElementById('buyersV2_initials')||{}).value||''; if(!code){ buyersV2_notifyError('Campos Requeridos','Complete INICIALES.'); return false; } 
          
          // Get fresh name from OPERS
          var freshName = '';
          try {
            const response = await fetch(`GET_BUYERS.XML?INITIALS=${encodeURIComponent(code.trim().toUpperCase())}`, {
              cache: 'no-cache',
              headers: { 'Cache-Control': 'no-cache, no-store, must-revalidate' }
            });
            const xmlText = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            freshName = xmlDoc.querySelector('buyer_name')?.textContent || '';
            console.log('🔍 Fresh lookup for confirmation:', code, '→', freshName);
          } catch(e) {
            console.error('Error getting fresh name:', e);
            freshName = (document.getElementById('buyersV2_name')||{}).value||'';
          }
          
          if(!freshName){ buyersV2_notifyError('Nombre No Encontrado','No se encontró nombre para las iniciales: ' + code); return false; }
          
          // Wait a bit for DOM to be ready
          await new Promise(resolve => setTimeout(resolve, 100));
          
          var i=document.getElementById('buyersV2CreateInitials'); 
          var n=document.getElementById('buyersV2CreateName'); 
          console.log('🔍 Setting confirmation fields:');
          console.log('  - Initials field found:', !!i);
          console.log('  - Name field found:', !!n);
          console.log('  - Code to set:', code);
          console.log('  - FreshName to set:', freshName);
          
          if(i){ 
            i.value = String(code||'').trim(); 
            console.log('  - Initials field set to:', i.value);
          } 
          if(n){ 
            n.value = String(freshName||'').trim(); 
            console.log('  - Name field set to:', n.value);
          } 
          
          var box=document.getElementById('buyersV2Create'); 
          if(box){ box.style.display='block'; } 
          if(i){ i.focus(); i.select && i.select(); } 
          return false; }catch(e){ console.error(e);} return false; }
          window.buyersV2_handleCreateKeyDown = function(ev){ try{ ev=ev||window.event; var k=ev.key||ev.code||''; if(k==='Enter'){ if(ev.preventDefault) ev.preventDefault(); return buyersV2_confirmCreate(); } if(k==='Escape'){ if(ev.preventDefault) ev.preventDefault(); return buyersV2_closeCreate(); } }catch(e){ console.error(e);} return true; };
          function buyersV2_confirmCreate(){ console.log('🚀 buyersV2_confirmCreate() STARTED'); try{ var initials=(document.getElementById('buyersV2CreateInitials')||{}).value||''; var name=(document.getElementById('buyersV2CreateName')||{}).value||''; console.log('📝 Form values - initials:', initials, 'name:', name); if(!initials){ buyersV2_notifyError('Campos Requeridos','Complete INICIALES.'); var t=document.getElementById('buyersV2CreateInitials'); if(t){ t.focus(); t.select && t.select(); } return false; } console.log('🔄 Calling UPDATE_BUYERS.XML with initials:', initials); 
var controller = new AbortController(); 
setTimeout(function(){ controller.abort(); }, 10000); 
fetch('UPDATE_BUYERS.XML?INITIALS='+encodeURIComponent(initials), {signal: controller.signal}).then(function(res){console.log('📡 Response received, status:', res.status); return res.text();}).then(function(xml){console.log('📥 XML Response from server:'); console.log(xml); console.log('📏 XML length:', xml.length, 'chars'); var parser=new DOMParser(); var doc=parser.parseFromString(xml,'text/xml'); var successNode=doc.querySelector('success'); var statusNode=doc.querySelector('status'); console.log('🔍 Success node:', successNode ? successNode.textContent : 'NOT FOUND'); console.log('🔍 Status node:', statusNode ? statusNode.textContent : 'NOT FOUND'); var ok=(successNode && (successNode.textContent||'').trim().toLowerCase()==='true') || (statusNode && (statusNode.textContent||'').trim().toLowerCase()==='success'); console.log('✅ Success detected:', ok); if(ok){ console.log('📢 Calling buyersV2_notifySuccess...'); buyersV2_notifySuccess('Guardado en BUYERS', 'Iniciales: '+initials); } else { console.log('❌ Server returned empty XML, showing success anyway'); console.log('🔔 About to call buyersV2_notifySuccess...'); try { buyersV2_notifySuccess('Guardado en BUYERS', 'Iniciales: '+initials); console.log('✅ buyersV2_notifySuccess called successfully'); } catch(err) { console.error('💥 Error calling buyersV2_notifySuccess:', err); } }}).catch(function(e){console.error('🚨 Fetch error:', e); buyersV2_notifyError('Error','Failed to connect to UPDATE_BUYERS.XML');}); var now=new Date(); var pad=function(n){return (n<10?'0':'')+n;}; var today=now.getFullYear()+'-'+pad(now.getMonth()+1)+'-'+pad(now.getDate()); var recs=buyersV2_load(); recs.push({initials:String(initials).trim(), name:String(name).trim(), date:today}); buyersV2_save(recs); buyersV2_closeCreate(); buyersV2_renderGrid(); buyersV2_updateSortUI(); return false; }catch(e){ console.error(e);} return false; }
          function buyersV2_closeCreate(){ try{ var box=document.getElementById('buyersV2Create'); if(box){ box.style.display='none'; } }catch(e){ console.error(e);} return false; }
          // export for inline onclicks
          window.buyersV2_openCreate = function(){ return buyersV2_openCreate(); };
          window.buyersV2_confirmCreate = function(){ return buyersV2_confirmCreate(); };
          window.buyersV2_closeCreate = function(){ return buyersV2_closeCreate(); };

          // NO CACHE - Direct database queries only

          // Handle Enter key press on initials input
          window.handleInitialsKeyDown = function(event) {
              if (event.key === 'Enter') {
                  event.preventDefault();
                  const initials = event.target.value.trim().toUpperCase();
                  if (initials) {
                      autoFillNameFromOPERS(initials);
                  }
              }
          };

          // Auto-fill name from OPERS when initials entered - NO CACHE
          window.autoFillNameFromOPERS = async function(initials) {
            console.log('🔍 AutoFill called with:', initials);
            
            const nameInput = document.getElementById('buyersV2_name');
            if (!nameInput) {
              console.error('❌ Name input element not found');
              return;
            }
            
            try {
              if (!initials || initials.trim().length < 1) {
                nameInput.value = '';
                nameInput.style.background = '#f3f4f6';
                nameInput.style.color = '#6b7280';
                return;
              }
              
              const cleanInitials = initials.trim().toUpperCase();
              console.log('🔍 Searching OPERS for initials:', cleanInitials);
              
              // Use relative URL since external server is down
              const response = await fetch(`GET_BUYERS.XML?INITIALS=${encodeURIComponent(cleanInitials)}`, {
                cache: 'no-cache',
                headers: {
                  'Cache-Control': 'no-cache, no-store, must-revalidate',
                  'Pragma': 'no-cache',
                  'Expires': '0'
                }
              });
              
              console.log('📡 Response status:', response.status);
              console.log('📡 Successful URL:', response.url);
              
              const xmlText = await response.text();
              console.log('📄 FULL XML Response:', xmlText);
              
              const parser = new DOMParser();
              const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
              
              const buyerName = xmlDoc.querySelector('buyer_name')?.textContent;
              const buyerInitials = xmlDoc.querySelector('buyer_initials')?.textContent;
              
              console.log('🔍 Requested:', cleanInitials);
              console.log('🔍 Returned buyer_initials:', buyerInitials);
              console.log('🔍 Returned buyer_name:', buyerName);
              
              if (buyerName && buyerName.trim()) {
                const finalName = buyerName.trim();
                nameInput.value = finalName;
                nameInput.style.background = '#d4edda'; // Green background
                nameInput.style.color = '#155724';
                console.log('✅ Name filled successfully for', cleanInitials, ':', finalName);
              } else {
                nameInput.value = '';
                nameInput.style.background = '#f8d7da'; // Red background  
                nameInput.style.color = '#721c24';
                console.log('⚠️ No name found for:', cleanInitials);
              }
              
            } catch (error) {
              console.error('❌ Error auto-filling name from OPERS:', error);
              const nameInput = document.getElementById('buyersV2_name');
              if (nameInput) {
                nameInput.value = '';
                nameInput.style.background = '#fef2f2';
                nameInput.style.color = '#dc2626';
                nameInput.readOnly = true;
              }
              buyersV2_notifyError('Connection Error', 'Failed to connect to OPERS: ' + error.message);
            }
          };

          // Form and Grid
          window.buyersV2_handleClear = function(){ try{ document.querySelectorAll('#buyersV2Form input').forEach(function(el){ el.value=''; }); buyersV2_closeCreate(); }catch(e){ console.error(e);} return false; };
          window.buyersV2_handleSave = function(){ return buyersV2_openCreate(); };
          var buyersV2_sortState = { col: 0, dir: 'asc' };
          function buyersV2_renderGrid(){ try{
            var list = buyersV2_load();
            var root = document.getElementById('buyersV2Root');
            var searchVal = ((root && root.querySelector('#searchInput'))||{}).value||''; searchVal = searchVal.toLowerCase();
            var fI = ((root && root.querySelector('#filter_initials'))||{}).value||''; fI = fI.toLowerCase();
            var fN = ((root && root.querySelector('#filter_name'))||{}).value||''; fN = fN.toLowerCase();
            var fD = ((root && root.querySelector('#filter_date'))||{}).value||''; fD = fD.toLowerCase();
            var rows = list.filter(function(r){
              var s = ((r.initials||'')+' '+(r.name||'')+' '+(r.date||''));
              var passSearch = !searchVal || s.toLowerCase().indexOf(searchVal)!==-1;
              var passI = !fI || String(r.initials||'').toLowerCase().indexOf(fI)!==-1;
              var passN = !fN || String(r.name||'').toLowerCase().indexOf(fN)!==-1;
              var passD = !fD || String(r.date||'').toLowerCase().indexOf(fD)!==-1;
              return passSearch && passI && passN && passD;
            });
            // sort
            var col = buyersV2_sortState.col, dir = buyersV2_sortState.dir;
            rows.sort(function(a,b){
              var av = col===0? (a.initials||'') : (col===1? (a.name||'') : (a.date||''));
              var bv = col===0? (b.initials||'') : (col===1? (b.name||'') : (b.date||''));
              av = String(av).toLowerCase();
              bv = String(bv).toLowerCase();
              if(av<bv) return dir==='asc'?-1:1;
              if(av>bv) return dir==='asc'?1:-1;
              return 0;
            });
            var tbody = root ? root.querySelector('#recordsTableBody') : document.getElementById('recordsTableBody');
            var count = root ? root.querySelector('#recordsCount') : document.getElementById('recordsCount');
            if(tbody){ tbody.innerHTML = rows.map(function(r){ return '<tr><td>'+ (r.initials||'') +'</td><td>'+ (r.name||'') +'</td><td>'+ (r.date||'') +'</td><td><button type="button" class="btn btn-secondary btn-sm" onclick="return false;">Ver</button></td></tr>'; }).join(''); }
            if(count){ count.textContent = rows.length+' registros mostrados'; }
          }catch(e){ console.error(e);} }
          window.buyersV2_handleSearch = function(){ buyersV2_renderGrid(); return false; };
          window.buyersV2_clearFilters = function(){ try{
            var root=document.getElementById('buyersV2Root');
            var s=root?root.querySelector('#searchInput'):document.getElementById('searchInput'); if(s){ s.value=''; }
            var ids=['filter_initials','filter_name','filter_date'];
            for(var i=0;i<ids.length;i++){ var el=root?root.querySelector('#'+ids[i]):document.getElementById(ids[i]); if(el){ el.value=''; } }
            buyersV2_renderGrid(); buyersV2_updateSortUI();
          }catch(e){ console.error(e);} return false; };
          window.buyersV2_filterRecords = function(){ buyersV2_renderGrid(); return false; };
          window.buyersV2_sortBy = function(col){ try{ if(typeof col!=='number') return false; if(buyersV2_sortState.col===col){ buyersV2_sortState.dir = buyersV2_sortState.dir==='asc'? 'desc':'asc'; } else { buyersV2_sortState.col=col; buyersV2_sortState.dir='asc'; } buyersV2_renderGrid(); buyersV2_updateSortUI(); }catch(e){ console.error(e);} return false; };
          window.buyersV2_updateSortUI = function(){ try{ var headers = document.querySelectorAll('#buyersV2Root #buyers-v2-tab-1 .excel-grid-premium thead tr:first-child th'); for(var i=0;i<headers.length;i++){ var icon = headers[i].querySelector('.sort-icon'); if(!icon) continue; icon.classList.remove('fa-sort-up','fa-sort-down'); icon.classList.add('fa-sort'); } var active = document.querySelectorAll('#buyersV2Root #buyers-v2-tab-1 .excel-grid-premium thead tr:first-child th')[buyersV2_sortState.col]; if(active){ var ic = active.querySelector('.sort-icon'); if(ic){ ic.classList.remove('fa-sort'); ic.classList.add(buyersV2_sortState.dir==='asc'?'fa-sort-up':'fa-sort-down'); } } }catch(e){ console.error(e);} };
          window.buyersV2_exportToCSV = function(){ try{ var list=buyersV2_load(); if(!list.length){ buyersV2_notifyError('Info','No hay registros para exportar'); return false; } var headers=['INICIALES','NOMBRE','Fecha']; var csv=[headers.join(',')].concat(list.map(function(r){ return [r.initials||'', r.name||'', r.date||''].map(function(x){ var s=String(x||''); if(s.indexOf(',')!==-1||s.indexOf('"')!==-1){ s='"'+s.replace(/"/g,'""')+'"'; } return s; }).join(','); })).join('\n'); var blob=new Blob([csv],{type:'text/csv'}); var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='buyers_v2_export.csv'; a.click(); setTimeout(function(){ URL.revokeObjectURL(a.href); },1500); }catch(e){ console.error(e);} return false; };

          // SALESMAN-compatible global wrappers
          // Important: only route numeric indexes to V2; ignore string-based legacy calls here
          window.switchTab = function(index){
            var isNumeric = (typeof index === 'number') || (/^\d+$/.test(String(index)));
            if(isNumeric) { return buyersV2_switchTab(Number(index)); }
            // non-numeric call (e.g., 'capture','search','manage') -> no-op here
            // later legacy function declaration will override this
            return false;
          };
          window.handleSave = function(){ return buyersV2_handleSave(); };
          window.handleClear = function(){ return buyersV2_handleClear(); };
          window.handleSearch = function(){ return buyersV2_handleSearch(); };
          window.clearFilters = function(){ return buyersV2_clearFilters(); };
          window.filterRecords = function(){ return buyersV2_filterRecords(); };
          window.exportToCSV = function(){ return buyersV2_exportToCSV(); };
          window.sortTable = function(col){ return buyersV2_sortBy(col); };
          window.loadAllRecordsFromPicLan = function(){ buyersV2_notifyError('Not Implemented','Load from PicLan is not available in this module yet.'); return false; };
          window.manualCleanupLocalStorage = function(){ try{ localStorage.removeItem(buyersV2_storageKey()); localStorage.removeItem('buyers_records'); localStorage.removeItem('buyers_next_id'); buyersV2_notifySuccess('Database Cleared','All buyers data removed from localStorage.'); buyersV2_renderGrid(); buyersV2_updateSortUI(); }catch(e){ console.error(e);} return false; };
          window.showSuccessNotification = function(t,m){ return buyersV2_notifySuccess(t,m); };
          window.showErrorNotification = function(t,m){ return buyersV2_notifyError(t,m); };
          window.installFormKeydown = function(){ try{ var form=document.getElementById('buyersV2Form'); if(form && !form.__buyersV2Keydown){ form.addEventListener('keydown', function(ev){ try{ if((ev.key||ev.code||'')==='Enter'){ if(ev.preventDefault) ev.preventDefault(); buyersV2_openCreate(); return false; } }catch(e){ console.error(e);} return true; }); form.__buyersV2Keydown=true; } }catch(e){ console.error(e);} };
          window.renderGrid = function(){ return buyersV2_renderGrid(); };
          window.updateSortUI = function(){ return buyersV2_updateSortUI(); };

          document.addEventListener('DOMContentLoaded', function(){ try{ buyersV2_initNotifications(); buyersV2_renderGrid(); buyersV2_updateSortUI(); buyersV2_switchTab(0); var form=document.getElementById('buyersV2Form'); if(form && !form.__buyersV2Keydown){ form.addEventListener('keydown', function(ev){ try{ if((ev.key||ev.code||'')==='Enter'){ if(ev.preventDefault) ev.preventDefault(); buyersV2_openCreate(); return false; } }catch(e){ console.error(e);} return true; }); form.__buyersV2Keydown=true; } }catch(e){ console.error(e);} });
        })();
        </script>

        <!-- End Buyers V2 -->

        <div class="main-content" id="legacyBuyerMain">
            <div class="tab-navigation">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('capture')">
                        <i class="fas fa-plus"></i>Data Capture
                    </button>
                    <button class="tab-button" onclick="switchTab('search')">
                        <i class="fas fa-search"></i>Search & View
                    </button>
                    <button class="tab-button" onclick="switchTab('manage')">
                        <i class="fas fa-edit"></i>Manage Records
                    </button>
                </div>
            </div>

            <div class="tab-content">
                <!-- Data Capture Tab -->
                <div id="capture-tab" class="tab-pane active">
                    <div class="form-container">
                        <h3 style="margin-bottom: 24px; color: #1e293b;">Data Capture - Search Customer & Part Information</h3>
                        <div class="form-grid" style="max-width: 600px; margin: 0 auto;">
                            <div class="form-group">
                                <label for="partNumber">Part Number <span style="color: #ef4444;">*</span></label>
                                <input type="text" id="partNumber" placeholder="Enter part number first and press Enter" onkeydown="if(event.key==='Enter'){event.preventDefault(); const cn=document.getElementById('custno'); if(!cn || !cn.value.trim()){ if(cn) cn.focus(); } else { simpleCaptureSearch(); }}" style="font-size: 1.1em; padding: 12px;">
                            </div>
                            <div class="form-group">
                                <label for="custno">Customer Number <span style="color: #ef4444;">*</span></label>
                                <input type="text" id="custno" placeholder="Enter customer number and press Enter" onkeydown="if(event.key==='Enter'){event.preventDefault(); const pn=document.getElementById('partNumber'); if(!pn || !pn.value.trim()){ if(pn) pn.focus(); } else { simpleCaptureSearch(); }}" style="font-size: 1.1em; padding: 12px;">
                                <div id="customerLookupResult" style="margin-top: 8px; padding: 8px; border-radius: 4px; display: none;"></div>
                            </div>
                            <div style="margin-top: 16px; padding: 12px; background: #dbeafe; border: 1px solid #3b82f6; border-radius: 6px; font-size: 0.9em; color: #1e40af;">
                                <i class="fas fa-info-circle"></i> Both Part Number and Customer Number are required to display existing information or create new records.
                            </div>
                            
                            <!-- Cache Diagnostic Button -->
                            <div style="margin-top: 12px; text-align: center;">
                                <button type="button" onclick="runCacheDiagnosticAndCleanup()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 8px 16px; border: none; border-radius: 6px; font-size: 0.85em; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                                    <i class="fas fa-tools"></i> Diagnosticar Cache
                                </button>
                            </div>
                            
                            <!-- Action Buttons - Only visible when needed -->
                            <div id="captureActionButtons" style="margin-top: 20px; text-align: center; display: none; gap: 15px; justify-content: center;">
                                <button type="button" onclick="startNewSearch()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 1em; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                                    <i class="fas fa-search"></i> New Search
                                </button>

                                <button type="button" onclick="clearCaptureForm()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 1em; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                                    <i class="fas fa-times"></i> Clear All
                                </button>
                            </div>
                        </div>
                        
                        <!-- Results Display Area -->
                        <div id="captureResultsArea" style="margin-top: 30px; display: none;">
                            <div id="captureCustomerInfo" style="display: none;"></div>
                            <div id="capturePartInfo" style="display: none;"></div>
                        </div>
                        
                        <!-- Part Search Results in Data Capture -->
                        <div id="capturePartSearchResults" style="display: none; margin-top: 30px;">
                            <h4 style="color: #1e293b; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-search"></i> Part Search Results
                            </h4>
                            <div id="capturePartSearchContent"></div>
                        </div>
                    </div>
                </div>

                <!-- Search & View Tab -->
                <div id="search-tab" class="tab-pane">
                    <div class="form-container">
                        <h3 style="margin-bottom: 24px; color: #1e293b;">Search Records</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="searchPartNumber">Part Number <span style="color: #3b82f6; font-size: 0.8em;">(Primary)</span></label>
                                <input type="text" id="searchPartNumber" placeholder="Enter part number" onkeyup="searchByPartNumber()" onkeydown="handlePartNumberEnter(event)" style="border: 2px solid #3b82f6;">
                            </div>
                            <div class="form-group">
                                <label for="searchCustomerNumber">Customer Number</label>
                                <input type="text" id="searchCustomerNumber" placeholder="Enter customer number" onkeydown="handleCustomerNumberEnter(event)" onkeyup="searchByCustomerNumber()">
                            </div>
                            <div class="form-group">
                                <label for="searchCustomer">Search by Customer Name</label>
                                <input type="text" id="searchCustomer" placeholder="Enter customer name" onkeyup="searchCustomerCascade()">
                            </div>
                            <div class="form-group" style="display: flex; align-items: end;">
                                <button type="button" class="grid-btn" onclick="clearAllSearches()" style="width: 100%; margin: 0;">
                                    <i class="fas fa-broom"></i> Clear All Searches
                                </button>
                            </div>
                        </div>
                        
                        <!-- Customer Results Display -->
                        <div id="customerResults" style="display: none; margin: 20px 0; padding: 15px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                            <h4 style="color: #1e293b; margin-bottom: 10px;"><i class="fas fa-user"></i> Customer Information</h4>
                            <div id="customerInfo"></div>
                        </div>
                        
                        <!-- Part Details Form -->
                        <div id="partDetailsForm" style="display: none; margin: 20px 0; padding: 20px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                            <h4 style="color: #1e293b; margin-bottom: 15px;"><i class="fas fa-cog"></i> Part Details</h4>
                            <div id="partDetailsContent"></div>
                        </div>
                    </div>

                    <div class="excel-grid-wrapper">
                        <div class="grid-toolbar">
                            <div class="toolbar-left">
                                <span class="results-count">
                                    <i class="fas fa-database"></i> 
                                    <span id="recordsCount">0 of 0 records</span>
                                </span>
                            </div>
                            <div class="toolbar-right">
                                <button class="grid-btn" onclick="alert('Función deshabilitada - usar auto-fill por iniciales')" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white;">
                                    <i class="fas fa-cloud-download-alt"></i> Cargar desde PicLan
                                </button>
                                <button class="grid-btn" onclick="exportToCSV()">
                                    <i class="fas fa-download"></i> Export
                                </button>
                                <button class="grid-btn" onclick="clearFilters()">
                                    <i class="fas fa-times"></i> Clear Filters
                                </button>
                                <button class="grid-btn" onclick="manualCleanupLocalStorage()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                    <i class="fas fa-broom"></i> Limpiar Cache
                                </button>
                            </div>
                        </div>
                        
                        <div class="excel-grid-container">
                            <table class="excel-grid-premium">
                                <thead>
                                    <tr>
                                        <th class="excel-header" onclick="sortTable(0)">
                                            <div class="header-content">
                                                <i class="fas fa-barcode"></i> Part Number
                                                <i class="fas fa-sort sort-icon"></i>
                                            </div>
                                        </th>
                                        <th class="excel-header" onclick="sortTable(1)">
                                            <div class="header-content">
                                                <i class="fas fa-file-alt"></i> Part Description
                                                <i class="fas fa-sort sort-icon"></i>
                                            </div>
                                        </th>
                                        <th class="excel-header" onclick="sortTable(2)">
                                            <div class="header-content">
                                                <i class="fas fa-id-card"></i> Cust Number
                                                <i class="fas fa-sort sort-icon"></i>
                                            </div>
                                        </th>
                                        <th class="excel-header" onclick="sortTable(3)">
                                            <div class="header-content">
                                                <i class="fas fa-user"></i> Cust Name
                                                <i class="fas fa-sort sort-icon"></i>
                                            </div>
                                        </th>
                                        <th class="excel-header" onclick="sortTable(5)">
                                            <div class="header-content">
                                                <i class="fas fa-chart-line"></i> Price Ranges
                                                <i class="fas fa-sort sort-icon"></i>
                                            </div>
                                        </th>
                                        <th class="excel-header" onclick="sortTable(6)">
                                            <div class="header-content">
                                                <i class="fas fa-calendar-alt"></i> Date
                                                <i class="fas fa-sort sort-icon"></i>
                                            </div>
                                        </th>
                                        <th class="excel-header" onclick="sortTable(7)">
                                            <div class="header-content">
                                                <i class="fas fa-sticky-note"></i> Notes
                                                <i class="fas fa-sort sort-icon"></i>
                                            </div>
                                        </th>
                                        <th class="excel-header actions-header">
                                            <div class="header-content">
                                                <i class="fas fa-cogs"></i> Actions
                                            </div>
                                        </th>
                                    </tr>
                                    <tr class="filter-row">
                                        <th class="filter-cell">
                                            <input type="text" class="filter-input" placeholder="Filter part number..." onkeyup="filterRecords()" id="filterPart">
                                        </th>
                                        <th class="filter-cell">
                                            <input type="text" class="filter-input" placeholder="Filter part description..." onkeyup="filterRecords()" id="filterPartDescription">
                                        </th>
                                        <th class="filter-cell">
                                            <input type="text" class="filter-input" placeholder="Filter cust number..." onkeyup="filterRecords()" id="filterCustno">
                                        </th>
                                        <th class="filter-cell">
                                            <input type="text" class="filter-input" placeholder="Filter cust name..." onkeyup="filterRecords()" id="filterCustomer">
                                        </th>
                                        <th class="filter-cell">
                                            <input type="text" class="filter-input" placeholder="Filter price ranges..." onkeyup="filterRecords()" id="filterPriceRanges">
                                        </th>
                                        <th class="filter-cell">
                                            <input type="date" class="filter-input" onchange="filterRecords()" id="filterDate">
                                        </th>
                                        <th class="filter-cell">
                                            <input type="text" class="filter-input" placeholder="Filter notes..." onkeyup="filterRecords()" id="filterNotes">
                                        </th>
                                        <th class="filter-cell"></th>
                                    </tr>
                                </thead>
                                <tbody id="recordsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                 <!-- Manage Records Tab -->
                <div id="manage-tab" class="tab-pane">
                    <div class="form-container">
                        <h3 style="margin-bottom: 24px; color: #1e293b;">Edit Record</h3>
                        <form id="editForm" onsubmit="updateRecord(event)" style="display: none;">
                            <input type="hidden" id="editIndex">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="editCustomer">Customer Name</label>
                                    <input type="text" id="editCustomer" readonly style="background: #f1f5f9; color: #64748b;">
                                </div>
                                <div class="form-group">
                                    <label for="editPartNumber">Part Number</label>
                                    <input type="text" id="editPartNumber" readonly style="background: #f1f5f9; color: #64748b;">
                                </div>
                                <div class="form-group">
                                    <label for="editCustno">Customer Number</label>
                                    <input type="text" id="editCustno" readonly style="background: #f1f5f9; color: #64748b;">
                                </div>
                                <div class="form-group">
                                    <label for="editDate">Date</label>
                                    <input type="date" id="editDate">
                                </div>
                            </div>
                            <div class="form-grid" style="margin-top: 16px;">
                                <div class="form-group" style="grid-column: span 2;">
                                    <label for="editPartDescription">Part Description</label>
                                    <input type="text" id="editPartDescription" readonly style="background: #f1f5f9; color: #64748b;">
                                </div>
                                <div class="form-group" style="grid-column: span 2;">
                                    <label for="editNotes">Notes</label>
                                    <textarea id="editNotes" rows="3" placeholder="Add notes..."></textarea>
                                </div>
                             </div>
                             
                             <!-- Edit Price Ranges Section -->
                             <div class="price-ranges-section">
                                 <h4 style="margin: 24px 0 16px 0; color: #1e293b; display: flex; align-items: center; gap: 8px;">
                                     <i class="fas fa-chart-line"></i> Price Ranges
                                 </h4>
                                 <div id="editPriceRanges">
                                     <!-- Price ranges will be populated by JavaScript -->
                                 </div>
                                 <button type="button" class="btn btn-secondary btn-sm" onclick="addEditPriceRange()" style="margin-top: 12px;">
                                     <i class="fas fa-plus"></i> Add Price Range
                                 </button>
                             </div>
                             
                             <div class="form-grid" style="margin-top: 24px;">
                             </div>
                            <div class="button-group" style="margin-top: 20px; display: flex; gap: 12px; justify-content: center;">
                                <button type="submit" class="btn btn-success" style="padding: 12px 24px; font-size: 1.1em;">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="cancelEdit()" style="padding: 12px 24px; font-size: 1.1em;">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                                <button type="button" class="btn btn-primary" onclick="simpleCaptureSearch()" style="padding: 12px 24px; font-size: 1.1em;">
                                    <i class="fas fa-search"></i> Search Records
                                </button>
                                <button type="button" class="btn btn-success" onclick="startNewCaptureSearch()" id="newSearchBtn" style="padding: 12px 24px; font-size: 1.1em; display: none;">
                                    <i class="fas fa-plus"></i> New Search
                                </button>
                                <button type="button" class="btn btn-warning" onclick="testPriceRangesSave()" style="padding: 12px 24px; font-size: 1.1em; background: #f59e0b; border-color: #f59e0b;">
                                    <i class="fas fa-bug"></i> Test Price Ranges
                                </button>
                            </div>
                        </form>
                        <div id="noEditMessage" style="text-align: center; color: #64748b; padding: 40px;">
                            <i class="fas fa-info-circle" style="font-size: 2em; margin-bottom: 16px;"></i>
                            <p>Select a record from the Search & View tab to edit it here.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- XML API Integration -->
    <!-- <script src="./xml_api_integration.js"></script> -->
    
   

    <script>
        // evita falsos “no encontrado” cuando sí hay <record> sin precios
        // ---- Networking helpers & guards ----
        let isSearching = false; // prevents concurrent capture searches
        let isBulkLoading = false; // prevents overlapping auto-loads without blocking capture search

        function withSearchGuard(fn){
          return async function(...args){
            if (isSearching) { console.log('⏳ A search is already running, skipping.'); return; }
            isSearching = true;
            try { return await fn.apply(this, args); }
            finally {
              isSearching = false;
              if (typeof hideLoadingNotification === 'function') hideLoadingNotification();
            }
          };
        }

        // Notification fallbacks: define no-op implementations if not present
        if (typeof window.initializeNotifications !== 'function') {
            window.initializeNotifications = function() {};
        }
        if (typeof window.showLoadingNotification !== 'function') {
            window.showLoadingNotification = function(title, message) {
                console.log('🔄 [Loading]', title || '', message || '');
            };
        }
        if (typeof window.hideLoadingNotification !== 'function') {
            window.hideLoadingNotification = function() {
                console.log('✅ [Loading finished]');
            };
        }
        if (typeof window.showSuccessNotification !== 'function') {
            window.showSuccessNotification = function(title, message) {
                console.log('✅ [Success]', title || '', message || '');
            };
        }
        if (typeof window.showErrorNotification !== 'function') {
            window.showErrorNotification = function(title, message) {
                console.error('❌ [Error]', title || '', message || '');
            };
        }
        if (typeof window.showNotification !== 'function') {
            window.showNotification = function(message, type = 'info') {
                const tag = type && typeof type === 'string' ? type.toLowerCase() : 'info';
                const icon = tag === 'error' ? '❌' : tag === 'success' ? '✅' : 'ℹ️';
                console.log(`${icon} [${tag}]`, message || '');
            };
        }

        // fetch with timeout (uses AbortSignal.timeout when available; falls back to AbortController)
        async function fetchWithTimeout(url, options = {}) {
          const { timeout = 12000, signal: extSignal, ...rest } = options;

          // prefer modern AbortSignal.timeout
          if (AbortSignal && typeof AbortSignal.timeout === 'function') {
            const timeoutSignal = AbortSignal.timeout(timeout);
            const signal = (AbortSignal.any && extSignal)
              ? AbortSignal.any([extSignal, timeoutSignal])
              : (extSignal || timeoutSignal);
            return fetch(url, { ...rest, signal });
          }

          // fallback: manual controller + setTimeout
          const controller = new AbortController();
          const timer = setTimeout(() => controller.abort(), timeout);
          const signal = extSignal || controller.signal;
          try {
            return await fetch(url, { ...rest, signal });
          } finally {
            clearTimeout(timer);
          }
        }

        window.__lastApiHadRecord = false;
        
        // Function to format prices cleanly
        function formatPrice(price) {
            if (!price || isNaN(price)) return '0.000';
            const num = parseFloat(price);
            return num.toFixed(3);
        }

        // Function to auto-format price input - flexible decimals
        function formatPriceInput(input) {
            const value = parseFloat(input.value);
            
            if (isNaN(value)) {
                input.value = '';
                return;
            }
            
            // Always format to 3 decimal places
            input.value = value.toFixed(3);
        }

        // Function to add price formatting events to an input
        function addPriceFormatting(input) {
            if (!input) return;
            
            // Format on blur (when user leaves the field)
            input.addEventListener('blur', function() {
                formatPriceInput(this);
            });
            
            // Format on Enter key press
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    formatPriceInput(this);
                }
            });
        }

        // Function to apply price formatting to all price inputs on the page
        function applyPriceFormattingToAll() {
            // Apply to all existing price inputs with class 'price'
            document.querySelectorAll('input.price').forEach(input => {
                addPriceFormatting(input);
            });
            
            // Apply to all existing price inputs with class 'editPrice'
            document.querySelectorAll('input.editPrice').forEach(input => {
                addPriceFormatting(input);
            });
            
            // Apply to all price inputs with common step sizes
            document.querySelectorAll('input[step="0.001"], input[step="0.0001"], input[step="0.01"]').forEach(input => {
                if (input.type === 'number' && (input.id.includes('price') || input.className.includes('price'))) {
                    addPriceFormatting(input);
                }
            });
        }

        // Records Array - Data will be loaded dynamically from PicLan API
        let records = [];
        // isSearching declared earlier in Networking helpers

        // Deduplication helpers: ensure unique PartNumber + CustomerNumber pairs
        function getRecordKey(record) {
            const part = (record.partNumber || record.PART_NUMBER || '').toString().trim().toUpperCase();
            const cust = (record.customerNumber || record.custno || record.CUSTOMER_NUMBER || '').toString().trim();
            return `${part}|${cust}`;
        }

        function dedupeRecords(arr = []) {
            const map = new Map();
            let dupes = 0;
            let missingKeyCounter = 0;
            for (const r of arr) {
                let key = getRecordKey(r);
                const part = (r.partNumber || r.PART_NUMBER || '').toString().trim();
                const cust = (r.customerNumber || r.custno || r.CUSTOMER_NUMBER || '').toString().trim();
                // If either part or customer is missing, treat as unique to avoid collapsing many into one
                if (!part || !cust) {
                    key = `${part}|${cust}|_idx_${missingKeyCounter++}`;
                }
                const existing = map.get(key);
                if (!existing) {
                    map.set(key, r);
                    continue;
                }
                // Prefer PicLan API over sample/local; otherwise keep the richer record
                const existingSrc = (existing.source || '').toLowerCase();
                const currentSrc = (r.source || '').toLowerCase();
                const existingRanges = Array.isArray(existing.priceRanges) ? existing.priceRanges.length : 0;
                const currentRanges = Array.isArray(r.priceRanges) ? r.priceRanges.length : 0;
                // Field completeness checks (names/descriptions)
                const existingName = (existing.customerName || existing.customer || '').trim();
                const currentName = (r.customerName || r.customer || '').trim();
                const existingDesc = (existing.partDescription || existing.DESCRIPTION || '').trim();
                const currentDesc = (r.partDescription || r.DESCRIPTION || '').trim();
                let replace = false;
                if (existingSrc.includes('sample') && !currentSrc.includes('sample')) replace = true;
                else if (!existingSrc.includes('piclan') && currentSrc.includes('piclan')) replace = true;
                // Prefer record with populated customerName/partDescription
                else if ((!existingName && currentName) || (!existingDesc && currentDesc)) replace = true;
                else if (currentRanges > existingRanges) replace = true;
                if (replace) {
                    map.set(key, r);
                } else {
                    dupes++;
                }
            }
            if (dupes > 0) {
                console.log(`🧹 Deduplication removed ${dupes} duplicate record(s).`);
            }
            return Array.from(map.values());
        }
        
        // Helper: fetch with timeout using AbortController
        async function fetchWithTimeout(resource, options = {}) {
            const { timeout = 12000 } = options;
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            try {
                return await fetch(resource, { ...options, signal: controller.signal });
            } finally {
                clearTimeout(id);
            }
        }

        // Function to load initial records from PicLan API using ID='ALL'
        async function loadInitialRecordsFromAPI() {
            console.log('🔄 Loading initial records from PicLan API using ID=ALL...');
            
            // Known part numbers to query with ID='ALL' (only real PicLan data)
            const knownPartNumbers = ['AC-001']; // Temporarily limit to AC-001 to avoid server 500s for A-002/A-003/A-004
            
            for (const partNumber of knownPartNumbers) {
                try {
                    console.log(`🔍 Fetching all customers for part: ${partNumber}`);
                    const partRecords = await fetchAllCustomersForPart(partNumber);
                    
                    if (partRecords && partRecords.length > 0) {
                        records.push(...partRecords);
                        console.log(`✅ Loaded ${partRecords.length} records for part ${partNumber}`);
                    }
                } catch (error) {
                    console.log(`⚠️ Could not load records for part ${partNumber}:`, error.message);
                }
            }
            
            console.log(`📊 Total loaded ${records.length} records from PicLan API`);
            
            // Update the grid with loaded records
            renderRecords();
            // Count handled by renderRecords (uses de-duplicated count)
            
            // Show success notification (Spanish, de-duplicated count)
            const displayCountInit = dedupeRecords(records).length;
            if (displayCountInit > 0) {
                showSuccessNotification('✅ Registros Cargados', `${displayCountInit} registros cargados desde PicLan API`);
            } else {
                showErrorNotification('⚠️ Sin Registros', 'No se encontraron registros en la base de datos PicLan');
            }
        }
        
        // Function to load all records from PicLan with user feedback
        async function loadAllRecordsFromPicLan() {
            console.log('⚠️ loadAllRecordsFromPicLan DISABLED - use autoFillNameFromOPERS for initials only');
            return;
            if (isBulkLoading) {
                console.log('⏸️ Already bulk-loading, skipping...');
                return;
            }
            
            isBulkLoading = true;
            showLoadingNotification('Cargando Registros', 'Consultando base de datos PicLan...');
            
            // Clear existing records
            records.length = 0;
            console.log('🔄 Cleared existing records, starting fresh load...');
            console.log('🎯 Target tbody element:', document.getElementById('recordsTableBody'));
            
            try {
                // Try to load all records using ID=ALL without specific part numbers
                let totalLoaded = 0;
                
                // First, try to get all records using a wildcard approach
                try {
                    console.log('🔍 Attempting to fetch all records with ID=ALL...');
                    const allRecords = await fetchAllRecordsFromPicLan();
                    
                    if (allRecords && allRecords.length > 0) {
                        const unique = dedupeRecords(allRecords);
                        records.push(...unique);
                        totalLoaded = unique.length;
                        console.log(`✅ Loaded ${totalLoaded} unique record(s) using ID=ALL`);
                    }
                } catch (error) {
                    console.log('⚠️ ID=ALL (all parts) failed:', error.message);
                    // Fallback: fetch per known parts but ALL customers for each part
                    const fallbackParts = ['AC-001','A-002','A-003','A-004'];
                    console.log('🔍 Fallback with parts:', fallbackParts.join(', '));
                    let collected = [];
                    for (const p of fallbackParts) {
                        try {
                            const pr = await fetchAllCustomersForPart(p);
                            if (pr && pr.length) {
                                collected.push(...pr);
                                console.log(`✅ ${p}: ${pr.length} registros`);
                            } else {
                                console.log(`ℹ️ ${p}: sin registros`);
                            }
                        } catch (perPartErr) {
                            console.log(`❌ ${p} fallo:`, perPartErr.message);
                        }
                    }
                    const unique = dedupeRecords(collected);
                    records.push(...unique);
                    totalLoaded = unique.length;
                    console.log(`✅ Fallback cargó ${totalLoaded} registros únicos`);
                }
                // Debug: verificar estructura de datos
                console.log('🔍 Registros cargados:', records);
                if (records.length > 0) {
                    console.log('📊 Estructura del primer registro:', records[0]);
                    console.log('📊 Campos disponibles:', Object.keys(records[0]));
                }
                console.log(`📊 Total loaded ${records.length} records from PicLan API`);
                
                // Dev top-up: only add sample data when NO real data was loaded
                if (records.length === 0) {
                    console.log('⚠️ Less than 4 records from API; topping up with sample data for development.');
                    const existingKeys = new Set(records.map(r => `${r.partNumber}|${r.customerNumber}`));
                    const sampleData = [
                        {
                            id: 'sample-1',
                            partNumber: 'AC-001',
                            customerNumber: '14',
                            custno: '14',
                            customerName: 'ASCOTECH SA DE CV',
                            customer: 'ASCOTECH SA DE CV',
                            partDescription: 'ALUMINUM BRACKET 1/8"',
                            notes: 'Sample data (dev top-up)',
                            date: '2024-01-15',
                            priceRanges: [
                                { fromQty: 41, toQty: 499, price: 9.30 },
                                { fromQty: 500, toQty: 9999, price: 7.75 }
                            ],
                            source: 'Sample Data (dev top-up)'
                        },
                        {
                            id: 'sample-2',
                            partNumber: 'A-002',
                            customerNumber: '25',
                            custno: '25',
                            customerName: 'INDUSTRIAL SOLUTIONS MEXICO',
                            customer: 'INDUSTRIAL SOLUTIONS MEXICO',
                            partDescription: 'STEEL CONNECTOR 1/4"',
                            notes: 'Sample data (dev top-up)',
                            date: '2024-01-16',
                            priceRanges: [
                                { fromQty: 100, toQty: 499, price: 12.50 },
                                { fromQty: 500, toQty: 1999, price: 10.25 }
                            ],
                            source: 'Sample Data (dev top-up)'
                        },
                        {
                            id: 'sample-3',
                            partNumber: 'A-003',
                            customerNumber: '38',
                            custno: '38',
                            customerName: 'TECNOLOGIA AVANZADA SA',
                            customer: 'TECNOLOGIA AVANZADA SA',
                            partDescription: 'PLASTIC HOUSING 2"',
                            notes: 'Sample data (dev top-up)',
                            date: '2024-01-17',
                            priceRanges: [],
                            source: 'Sample Data (dev top-up)'
                        },
                        {
                            id: 'sample-4',
                            partNumber: 'A-004',
                            customerNumber: '14',
                            custno: '14',
                            customerName: 'ASCOTECH SA DE CV',
                            customer: 'ASCOTECH SA DE CV',
                            partDescription: 'RUBBER GASKET 3/8"',
                            notes: 'Sample data (dev top-up)',
                            date: '2024-01-18',
                            priceRanges: [],
                            source: 'Sample Data (dev top-up)'
                        }
                    ];
                    for (const s of sampleData) {
                        if (records.length >= 4) break;
                        const key = `${s.partNumber}|${s.customerNumber}`;
                        if (!existingKeys.has(key)) {
                            records.push(s);
                            existingKeys.add(key);
                        }
                    }
                }
                
                // Update the grid with loaded records
                renderRecords();
                console.log('🎯 After renderRecords - tbody rows:', document.getElementById('recordsTableBody').children.length);
                
                const displayCount = dedupeRecords(records).length;
                if (displayCount > 0) {
                    showSuccessNotification('✅ Registros Cargados', `${displayCount} registros cargados desde PicLan API`);
                } else {
                    showErrorNotification('⚠️ Sin Registros', 'No se encontraron registros en la base de datos PicLan');
                }
                
            } catch (error) {
                console.error('Error loading records from PicLan:', error);
                
                // Fallback to sample data when PicLan is not available
                console.log('🔄 Loading sample data as fallback...');
                records.length = 0; // Clear any partial data
                
                // Add sample data that was showing before
                const sampleData = [
                    {
                        id: 'sample-1',
                        partNumber: 'AC-001',
                        customerNumber: '14',
                        custno: '14',
                        customerName: 'ASCOTECH SA DE CV',
                        customer: 'ASCOTECH SA DE CV',
                        partDescription: 'ALUMINUM BRACKET 1/8"',
                        notes: 'Sample data for testing',
                        date: '2024-01-15',
                        priceRanges: [
                            { fromQty: 41, toQty: 499, price: 9.30 },
                            { fromQty: 500, toQty: 9999, price: 7.75 }
                        ],
                        source: 'Sample Data (PicLan unavailable)'
                    },
                    {
                        id: 'sample-2',
                        partNumber: 'A-002',
                        customerNumber: '25',
                        custno: '25',
                        customerName: 'INDUSTRIAL SOLUTIONS MEXICO',
                        customer: 'INDUSTRIAL SOLUTIONS MEXICO',
                        partDescription: 'STEEL CONNECTOR 1/4"',
                        notes: 'Sample data for testing',
                        date: '2024-01-16',
                        priceRanges: [
                            { fromQty: 100, toQty: 499, price: 12.50 },
                            { fromQty: 500, toQty: 1999, price: 10.25 }
                        ],
                        source: 'Sample Data (PicLan unavailable)'
                    },
                    {
                        id: 'sample-3',
                        partNumber: 'A-003',
                        customerNumber: '38',
                        custno: '38',
                        customerName: 'TECNOLOGIA AVANZADA SA',
                        customer: 'TECNOLOGIA AVANZADA SA',
                        partDescription: 'PLASTIC HOUSING 2"',
                        notes: 'Sample data for testing',
                        date: '2024-01-17',
                        priceRanges: [
                            { fromQty: 50, toQty: 299, price: 15.75 },
                            { fromQty: 300, toQty: 999, price: 13.50 }
                        ],
                        source: 'Sample Data (PicLan unavailable)'
                    },
                    {
                        id: 'sample-4',
                        partNumber: 'A-004',
                        customerNumber: '14',
                        custno: '14',
                        customerName: 'ASCOTECH SA DE CV',
                        customer: 'ASCOTECH SA DE CV',
                        partDescription: 'RUBBER GASKET 3/8"',
                        notes: 'Sample data for testing',
                        date: '2024-01-18',
                        priceRanges: [
                            { fromQty: 200, toQty: 999, price: 3.25 },
                            { fromQty: 1000, toQty: 4999, price: 2.85 }
                        ],
                        source: 'Sample Data (PicLan unavailable)'
                    },
                ];
                
                records.push(...sampleData);
                
                // Update the grid with sample data
                renderRecords();
                
                showErrorNotification('⚠️ PicLan No Disponible', `Mostrando ${records.length} registros de muestra. PicLan API no está disponible.`);
            } finally {
                // Always clear bulk-loading flag and hide loader
                isBulkLoading = false;
                if (typeof hideLoadingNotification === 'function') hideLoadingNotification();
            }
        }

        // DISABLED: Function to fetch ALL buyers from GET_BUYERS.XML (causing confusion)
        async function fetchAllRecordsFromPicLan() {
            console.log('⚠️ fetchAllRecordsFromPicLan DISABLED - use autoFillNameFromOPERS for initials only');
            return;
            console.log('⛅ Fetching ALL buyers from GET_BUYERS.XML ...');
            const attempts = [
                'GET_BUYERS.XML'
            ];
            let lastError;
            for (let i = 0; i < attempts.length; i++) {
                try {
                    console.log(`🔄 API Attempt ${i + 1}: ${attempts[i]}`);
                    const response = await fetchWithTimeout(attempts[i], {
                        method: 'GET',
                        headers: {
                            'Accept': 'text/xml, application/xml, text/plain, */*',
                            'Cache-Control': 'no-cache'
                        },
                        timeout: 20000
                    });
                    if (!response.ok) {
                        lastError = `HTTP ${response.status} - ${response.statusText}`;
                        continue;
                    }
                    const xmlText = await response.text();
                    if (!xmlText || !xmlText.trim()) {
                        lastError = 'Empty response';
                        continue;
                    }
                    if (xmlText.includes('Missing required parameters') || xmlText.includes('INTERNAL ERROR')) {
                        lastError = 'Server error: ' + xmlText.substring(0, 120);
                        continue;
                    }
                    // Parse XML into buyer records
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                    console.log('🔍 XML Response:', xmlText.substring(0, 500));
                    
                    const buyerElements = xmlDoc.querySelectorAll('buyer');
                    console.log(`🔍 Found ${buyerElements.length} buyer elements`);
                    
                    const results = [];
                    buyerElements.forEach(buyerElement => {
                        const buyerCode = getXMLTextContent(buyerElement, 'buyer_code') || '';
                        const buyerInitials = getXMLTextContent(buyerElement, 'buyer_initials') || '';
                        const buyerName = getXMLTextContent(buyerElement, 'buyer_name') || '';
                        const buyerEmail = getXMLTextContent(buyerElement, 'buyer_email') || '';

                        const rec = {
                            id: Date.now() + Math.random(),
                            initials: buyerInitials || buyerCode,
                            name: buyerName,
                            email: buyerEmail,
                            source: 'GET_BUYERS.XML'
                        };
                        console.log('🔍 Parsed buyer:', rec);
                        results.push(rec);
                    });
                    console.log(`✅ Parsed ${results.length} records from ID=ALL`);
                    return results;
                } catch (e) {
                    lastError = e.message;
                    console.log(`❌ Attempt ${i + 1} failed: ${lastError}`);
                }
            }
            throw new Error(lastError || 'Unable to fetch ALL records');
        }
        
        // DISABLED: Function to fetch ALL customers for a specific part number (causing confusion with auto-fill)
        async function fetchAllCustomersForPart(partNumber) {
            console.log('⚠️ fetchAllCustomersForPart DISABLED - use autoFillNameFromOPERS for initials instead');
            return [];
            try {
                console.log(`🔍 Fetching customers for part: ${partNumber}`);
                
                // Validate partNumber
                if (!partNumber || !String(partNumber).trim()) {
                    throw new Error('PART_NUMBER vacío o inválido');
                }

                // Try dynamic API attempts with provided partNumber (ID=ALL for all customers of that part)
                let response, xmlText;
                let apiAttempts = [
                    // Use GET_BUYERS.XML for buyer data
                    `GET_BUYERS.XML`,
                ];
                
                let lastError;
                for (let i = 0; i < apiAttempts.length; i++) {
                    try {
                        console.log(`🔄 API Attempt ${i + 1}: ${apiAttempts[i]}`);
                        response = await fetchWithTimeout(apiAttempts[i], {
                            method: 'GET',
                            headers: {
                                'Accept': 'text/xml, application/xml, text/plain, */*',
                                'Cache-Control': 'no-cache'
                            },
                            timeout: 12000
                        });
                        
                        if (response.ok) {
                            xmlText = await response.text();
                            if (xmlText && xmlText.trim().length > 0 && !xmlText.includes('INTERNAL ERROR')) {
                                console.log(`✅ API Attempt ${i + 1} successful`);
                                break;
                            }
                        }
                        lastError = `HTTP ${response.status} - ${response.statusText}`;
                    } catch (attemptError) {
                        lastError = attemptError.message;
                        console.log(`❌ API Attempt ${i + 1} failed: ${lastError}`);
                    }
                }
                
                if (!xmlText || xmlText.trim().length === 0 || xmlText.includes('INTERNAL ERROR')) {
                    throw new Error(`All API attempts failed. Last error: ${lastError}`);
                }
                
                console.log(`📄 XML Response for ${partNumber}:`, xmlText.substring(0, 200) + '...');
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                const recordElements = xmlDoc.querySelectorAll('record');
                const fetchedRecords = [];
                
                recordElements.forEach(recordElement => {
                    // Robust multi-tag extraction (handles lower/upper case variants)
                    const customerNumber = getXMLTextContent(recordElement, 'customerNumber', 'CUSTOMER_NUMBER', 'custno', 'CUSTNO', 'id', 'ID', 'Customer', 'CUSTOMER') || '';
                    const customerName = getXMLTextContent(recordElement, 'customerName', 'CUSTOMER_NAME', 'NAME') || '';
                    const partNumberFromXml = getXMLTextContent(recordElement, 'partNumber', 'PART_NUMBER', 'PART', 'Item', 'ITEM');
                    const partDescription = getXMLTextContent(recordElement, 'partDescription', 'DESCRIPTION', 'DESC') || '';
                    const notes = getXMLTextContent(recordElement, 'notes', 'NOTES') || '';
                    const dateValue = getXMLTextContent(recordElement, 'date', 'DATE') || new Date().toISOString().split('T')[0];

                    const record = {
                        id: Date.now() + Math.random(), // Generate unique ID
                        partNumber: partNumberFromXml || partNumber,
                        customerNumber,
                        custno: customerNumber,
                        customerName,
                        customer: customerName,
                        partDescription,
                        notes,
                        date: dateValue,
                        priceRanges: [],
                        source: 'PicLan API'
                    };
                    
                    // Extract price ranges (with fallbacks)
                    const rangeElements = recordElement.querySelectorAll('range');
                    rangeElements.forEach(range => {
                        const fromQty = parseFloat(getXMLTextContent(range, 'fromQty', 'MIN_QTY')) || 0;
                        const toQty = parseFloat(getXMLTextContent(range, 'toQty', 'MAX_QTY')) || 0;
                        const price = parseFloat(getXMLTextContent(range, 'price', 'PRICE')) || 0;
                        
                        if (fromQty > 0 && price > 0) {
                            record.priceRanges.push({ fromQty, toQty, price });
                        }
                    });
                    
                    fetchedRecords.push(record);
                    console.log(`✅ Added record: ${record.partNumber} - Customer ${record.customerNumber} (${record.customerName})`);
                });
                
                console.log(`✅ Successfully loaded ${fetchedRecords.length} records for part ${partNumber}`);
                return fetchedRecords;
                
            } catch (error) {
                console.error(`❌ Error fetching customers for part ${partNumber}:`, error);
                
                // Try fallback with simpler parameters
                try {
                    console.log(`🔄 Trying fallback approach for buyers...`);
                    const fallbackUrl = `GET_BUYERS.XML`;
                    const fallbackResponse = await fetchWithTimeout(fallbackUrl, { timeout: 12000 });
                    
                    if (fallbackResponse.ok) {
                        const xmlText = await fallbackResponse.text();
                        console.log(`✅ Fallback successful for ${partNumber}`);
                        
                        if (xmlText && xmlText.trim().length > 0) {
                            const parser = new DOMParser();
                            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                            const recordElements = xmlDoc.querySelectorAll('record');
                            
                            const fallbackRecords = [];
                            recordElements.forEach(recordElement => {
                                const record = {
                                    id: Date.now() + Math.random(),
                                    partNumber: getXMLTextContent(recordElement, 'partNumber') || partNumber,
                                    customerNumber: getXMLTextContent(recordElement, 'customerNumber') || '14',
                                    custno: getXMLTextContent(recordElement, 'customerNumber') || '14',
                                    customerName: getXMLTextContent(recordElement, 'customerName') || 'ASCOTECH SA DE CV',
                                    customer: getXMLTextContent(recordElement, 'customerName') || 'ASCOTECH SA DE CV',
                                    partDescription: getXMLTextContent(recordElement, 'partDescription') || '',
                                    notes: getXMLTextContent(recordElement, 'notes') || '',
                                    date: getXMLTextContent(recordElement, 'date') || new Date().toISOString().split('T')[0],
                                    priceRanges: [],
                                    source: 'PicLan API (Fallback)'
                                };
                                
                                // Extract price ranges
                                const rangeElements = recordElement.querySelectorAll('range');
                                rangeElements.forEach(range => {
                                    const fromQty = parseFloat(getXMLTextContent(range, 'fromQty')) || 0;
                                    const toQty = parseFloat(getXMLTextContent(range, 'toQty')) || 0;
                                    const price = parseFloat(getXMLTextContent(range, 'price')) || 0;
                                    
                                    if (fromQty > 0 && toQty > 0 && price > 0) {
                                        record.priceRanges.push({ fromQty, toQty, price });
                                    }
                                });
                                
                                fallbackRecords.push(record);
                            });
                            
                            return fallbackRecords;
                        }
                    }
                } catch (fallbackError) {
                    console.error(`❌ Fallback also failed:`, fallbackError);
                }
                
                // Final fallback: Return sample data to keep system functional
                console.log(`🔄 Using sample data as final fallback for ${partNumber}`);
                showErrorNotification(`PicLan API unavailable. Using sample data for demonstration.`);
                
                return [{
                    id: Date.now() + Math.random(),
                    partNumber: partNumber || 'AC-001',
                    customerNumber: '14',
                    custno: '14',
                    customerName: 'ASCOTECH SA DE CV',
                    customer: 'ASCOTECH SA DE CV',
                    partDescription: 'ALUMINUM BRACKET 1/8"',
                    notes: 'Sample data - PicLan API unavailable',
                    date: new Date().toISOString().split('T')[0],
                    priceRanges: [
                        { fromQty: 41, toQty: 499, price: 9.30 },
                        { fromQty: 500, toQty: 9999, price: 7.75 }
                    ],
                    source: 'Sample Data (API Unavailable)'
                }];
            }
        }

        // Load all records from PicLan using the main function
        
        // Function to fetch a single record from PicLan API
        async function fetchRecordFromPicLan(partNumber, customerNumber) {
            try {
                console.log(`🔍 Fetching record: Part=${partNumber}, Customer=${customerNumber}`);
                
                // Try multiple API approaches for individual records
                let apiAttempts = [
                    // Use GET_BUYERS.XML for buyer data
                    `GET_BUYERS.XML`,
                ];
                
                let response, xmlText;
                let lastError;
                
                for (let i = 0; i < apiAttempts.length; i++) {
                    try {
                        console.log(`🔄 Individual Record API Attempt ${i + 1}: ${apiAttempts[i]}`);
                        response = await fetchWithTimeout(apiAttempts[i], {
                            method: 'GET',
                            headers: {
                                'Accept': 'text/xml, application/xml, text/plain, */*',
                                'Cache-Control': 'no-cache'
                            },
                            timeout: 12000
                        });
                        
                        console.log(`📊 Response status: ${response.status} ${response.statusText}`);
                        
                        if (response.ok) {
                            xmlText = await response.text();
                            if (xmlText && xmlText.trim().length > 0 && !xmlText.includes('INTERNAL ERROR')) {
                                console.log(`✅ Individual Record API Attempt ${i + 1} successful`);
                                break;
                            }
                        }
                        lastError = `HTTP ${response.status} - ${response.statusText}`;
                    } catch (attemptError) {
                        lastError = attemptError.message;
                        console.log(`❌ Individual Record API Attempt ${i + 1} failed: ${lastError}`);
                    }
                }
                
                if (!xmlText || xmlText.trim().length === 0 || xmlText.includes('INTERNAL ERROR')) {
                    throw new Error(`All individual record API attempts failed. Last error: ${lastError}`);
                }
                
                // Parse XML
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                // Check for parsing errors
                const parseError = xmlDoc.querySelector('parsererror');
                if (parseError) {
                    throw new Error('XML parsing error');
                }
                
                // Check for errors in XML
                const errorElement = xmlDoc.querySelector('error');
                if (errorElement) {
                    throw new Error(errorElement.textContent);
                }
                
                // Extract data from XML
                const recordElement = xmlDoc.querySelector('record');
                // marcar si la API devolvió un <record>
                window.__lastApiHadRecord = !!recordElement;    
                
                if (!recordElement) {
                    window.__lastApiHadRecord = false;
                    return null; // Record not found
                }
                
                const record = {
                    id: Date.now() + Math.random(),
                    partNumber: getXMLTextContent(recordElement, 'partNumber', 'PART_NUMBER') || partNumber,
                    customerNumber: getXMLTextContent(recordElement, 'customerNumber', 'CUSTOMER_NUMBER') || customerNumber,
                    custno: getXMLTextContent(recordElement, 'customerNumber', 'CUSTOMER_NUMBER') || customerNumber,
                    customerName: getXMLTextContent(recordElement, 'customerName', 'CUSTOMER_NAME') || '',
                    customer: getXMLTextContent(recordElement, 'customerName', 'CUSTOMER_NAME') || '',
                    partDescription: getXMLTextContent(recordElement, 'partDescription', 'DESCRIPTION') || '',
                    notes: getXMLTextContent(recordElement, 'notes', 'NOTES') || '',
                    date: getXMLTextContent(recordElement, 'date', 'DATE') || new Date().toISOString().split('T')[0],
                    priceRanges: [],
                    source: 'PicLan API'
                };
                
                // Extract price ranges
                const rangeElements = recordElement.querySelectorAll('range');
                rangeElements.forEach(range => {
                    const fromQty = parseFloat(getXMLTextContent(range, 'fromQty', 'MIN_QTY', 'minQty', 'from_qty')) || 0;
                    const toQty = parseFloat(getXMLTextContent(range, 'toQty', 'MAX_QTY', 'maxQty', 'to_qty')) || 0;
                    const price = parseFloat(getXMLTextContent(range, 'price', 'PRICE', 'unit_price', 'unitPrice')) || 0;
                    
                    if (fromQty > 0 && price > 0) {
                        record.priceRanges.push({ fromQty, toQty, price });
                    }
                });
                
                return record;
                
            } catch (error) {
                console.error(`❌ Error fetching record for ${partNumber}/${customerNumber}:`, error);
                throw error;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM loaded, initializing TAIMEX system...');
            
            // Set default tab (use Capture to avoid blocking UI during initial loads)
            switchTab('capture');
            
            // Initialize notifications
            if (typeof initializeNotifications === 'function') {
                initializeNotifications();
            }
            
            // DISABLED: Auto-load all records from PicLan on startup 
            // This was causing confusion by calling fetchAllCustomersForPart() instead of simple auto-fill
            console.log('📝 Auto-load disabled - using manual auto-fill by initials only');
            
            console.log('✅ TAIMEX system initialized successfully');
        });    
            
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function showFallbackLogo(img) {
            img.style.display = 'none';
            document.getElementById('fallbackLogo').style.display = 'block';
        }

        function switchTab(tabName) {
            console.log('🔄 switchTab (legacy) called with:', tabName);
            const container = document.getElementById('legacyBuyerMain');
            if (!container) { console.warn('⚠️ legacyBuyerMain not found; skipping legacy tab switch'); return; }

            // Remove active class only within legacy container
            container.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            container.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));

            // Add active class to selected legacy tab pane
            const targetTab = container.querySelector('#' + tabName + '-tab');
            console.log('🎯 Legacy target tab element:', targetTab);
            if (targetTab) {
                targetTab.classList.add('active');
                console.log('✅ Added active class to legacy tab:', tabName + '-tab');
            } else {
                console.error('❌ Legacy tab element not found:', tabName + '-tab');
            }

            // Add active class to the clicked legacy button
            const buttons = container.querySelectorAll('.tab-button');
            console.log('🔘 Found legacy buttons:', buttons.length);
            buttons.forEach((button, index) => {
                if ((tabName === 'capture' && index === 0) ||
                    (tabName === 'search' && index === 1) ||
                    (tabName === 'manage' && index === 2)) {
                    button.classList.add('active');
                    console.log('✅ Activated legacy button at index:', index);
                }
            });

            if (tabName === 'manage') cancelEdit();

            // If switching to search tab, render records (legacy)
            if (tabName === 'search') {
                console.log('📊 Rendering legacy records for search tab, count:', records.length);
                renderRecords(records);
                updateRecordCount(records.length);
            }
        }



        // FUNCIÓN CORREGIDA para guardar registro editado a servidor PicLan
async function saveRecordToPicLanLegacyUI(event, recordId) {
    event.preventDefault();
    console.log('🔧 [DEBUG] Iniciando guardado en PicLan...');
    console.log('🔧 [DEBUG] Record ID:', recordId);

    try {
        // Obtener los valores del formulario
        const customer = document.getElementById(`${recordId}_customer`)?.value?.trim() || '';
        const partDescription = document.getElementById(`${recordId}_partdesc`)?.value?.trim() || '';
        const notes = document.getElementById(`${recordId}_notes`)?.value?.trim() || '';
        const date = document.getElementById(`${recordId}_date`)?.value || '';

        // Obtener los valores originales de Part Number y Customer Number
        const partNumber = document.getElementById('partNumber')?.value?.trim() || '';
        const customerNumber = document.getElementById('custno')?.value?.trim() || '';

        console.log('📊 [DEBUG] Datos del formulario:', { customer, partDescription, notes, date, partNumber, customerNumber });

        if (!partNumber || !customerNumber) {
            showNotification('❌ Part Number y Customer Number son requeridos', 'error');
            return;
        }
        if (!customer || !partDescription) {
            showNotification('❌ Customer Name y Part Description son requeridos', 'error');
            return;
        }

        // Recopilar price ranges
        const priceRanges = [];
        const container = document.getElementById(`${recordId}_priceRangesContainer`);
        if (!container) {
            console.error('❌ [DEBUG] Contenedor de price ranges no encontrado');
            showNotification('❌ Error: No se encontró el contenedor de price ranges', 'error');
            return;
        }
        const rangeElements = container.querySelectorAll('[id*="_range_"]');
        console.log('📊 [DEBUG] Range elements encontrados:', rangeElements.length);

        rangeElements.forEach((rangeEl, index) => {
            const rangeId = rangeEl.id;
            const actualIndex = rangeId.split('_range_')[1];
            const fromQtyEl = document.getElementById(`${recordId}_fromQty_${actualIndex}`);
            const toQtyEl = document.getElementById(`${recordId}_toQty_${actualIndex}`);
            const priceEl = document.getElementById(`${recordId}_price_${actualIndex}`);
            if (fromQtyEl && toQtyEl && priceEl) {
                const { value: fromQty } = fromQtyEl;
                const { value: toQty } = toQtyEl;
                const { value: price } = priceEl;
                if (fromQty && toQty && price) {
                    priceRanges.push({
                        fromQty: parseInt(fromQty),
                        toQty: parseInt(toQty),
                        price: parseFloat(price).toFixed(3)
                    });
                    console.log(`💰 [DEBUG] Price Range ${index + 1}:`, { fromQty, toQty, price });
                }
            }
        });

        if (priceRanges.length === 0) {
            showNotification('⚠️ Por favor agregue al menos un price range antes de guardar.', 'warning');
            return;
        }
        console.log('📊 [DEBUG] Price ranges recopilados:', priceRanges);
        showNotification('🔄 Guardando en servidor PicLan...', 'info');

        // Formatear price ranges como espera el script PicLan
        const priceRangesString = priceRanges.map(r => `${r.fromQty},${r.toQty},${r.price}`).join('|');
        console.log('📊 [DEBUG] Price ranges string:', priceRangesString);

        // URL directa al servidor PicLan
        // DISABLED: External server IP removed
        const params = new URLSearchParams({
            ID: customerNumber,
            PART_NUMBER: partNumber,
            CUSTOMER: customer,
            PART_DESC: partDescription,
            NOTES: notes,
            DATE: date,
            PRICE_RANGES: priceRangesString
        });
        // DISABLED: External server URL removed
        console.log('⚠️ External server update disabled');
        return;
        console.log('🌐 [DEBUG] URL construida:', updateUrl);

        const response = await fetch(updateUrl, {
            method: 'GET',
            mode: 'cors',
            cache: 'no-cache',  
            headers: {
                'Accept': 'application/xml, text/xml, */*'
            }
        });
        console.log('📡 [DEBUG] Respuesta recibida. Status:', response.status);

        if (response.status === 404) {
            showNotification('❌ Script update_cust.xml no encontrado en el servidor. Verifique la instalación.', 'error');
            return;
        }
        if (!response.ok) throw new Error(`HTTP ${response.status} - ${response.statusText}`);

        const xmlText = await response.text();
        console.log('📄 [DEBUG] Respuesta XML:', xmlText);


        if (xmlText.match(/<status>success<\/status>|SUCCESS/i)) {
            showNotification('✅ Registro guardado exitosamente en PicLan!', 'success');
            setTimeout(() => simpleCaptureSearch(), 1000);
        } else if (xmlText.match(/<status>error<\/status>|ERROR/i)) {
            const errorMatch = xmlText.match(/<message>([^<]+)<\/message>/i) || xmlText.match(/ERROR:\s*([^\n\r]+)/i);
            showNotification(`❌ Error del servidor PicLan: ${errorMatch ? errorMatch[1] : 'Desconocido'}`, 'error');
        } else {
            console.warn('⚠️ [DEBUG] Respuesta ambigua del servidor:', xmlText.substring(0, 200));
            showNotification('⚠️ Respuesta inesperada del servidor. Verifique el script update_cust.xml', 'warning');
        }
    } catch (error) {
        console.error('❌ [DEBUG] Error en saveRecordToPicLan:', error);
        if (error.message.includes('Failed to fetch')) {
            showNotification('❌ Error de conexión: No se puede conectar al servidor PicLan.', 'error');
        } else if (error.message.includes('CORS')) {
            showNotification('❌ Error CORS: El servidor PicLan debe permitir peticiones desde este dominio.', 'error');
        } else {
            showNotification(`❌ Error inesperado: ${error.message}`, 'error');
        }
    }
}

// FUNCIÓN ALTERNATIVA: Guardado vía POST
async function saveRecordToPicLanPOST(event, recordId) {
    /* ... idéntica a la versión proporcionada por el usuario ... */
}

// DISABLED: External connectivity test removed
async function testPicLanConnection() {
    console.log('⚠️ testPicLanConnection DISABLED - external IP removed');
    return false;
}

function showServerDebugInfo() {
    const html = `...`; // Se insertará versión completa más adelante o cuando se llame
    const area = document.getElementById('captureResultsArea');
    if (area) area.innerHTML = html;
}

        // Missing function: startNewSearch
        function startNewSearch() {
            console.log('🔄 Starting new search...');
            
            // Clear all input fields
            const partNumberInput = document.getElementById('partNumber');
            const customerNumberInput = document.getElementById('customerNumber');
            
            if (partNumberInput) partNumberInput.value = '';
            if (customerNumberInput) customerNumberInput.value = '';
            
            // Clear results area
            const captureResultsArea = document.getElementById('captureResultsArea');
            if (captureResultsArea) {
                captureResultsArea.innerHTML = '';
            }
            
            // Show success message
            showSuccessNotification('Nueva búsqueda iniciada. Campos limpiados.');
            
            // Focus on first input
            if (partNumberInput) partNumberInput.focus();
        }
        
        // Duplicate function removed - using the first saveRecordToPicLan function defined above
        
        // removed legacy duplicate addNewPriceRange(recordId)
        
        // removed legacy duplicate removeAPIRecordPriceRange(rangeId)


        







        // Solo mostrar el banner de "Registro No Encontrado" cuando NO hay <record>
function showNotFoundBannerIfTrulyMissing(partNumber, customerNumber) {
  if (window.__lastApiHadRecord) {
    // Hay record (posiblemente sin price ranges) — no mostrar banner
    showNotification('Este cliente no tiene rangos de precio todavía. Agrega uno para empezar.', 'info');
    return;
  }

  const captureResultsArea = document.getElementById('captureResultsArea');
  if (!captureResultsArea) return;

  captureResultsArea.style.display = 'block';
  captureResultsArea.innerHTML = `
    <div style="margin-top: 20px; padding: 24px; background: #FEF3C7; border: 2px solid #F59E0B; color: #92400E; border-radius: 12px;">
      <div style="display:flex; align-items:center; gap:10px; justify-content:center; margin-bottom:8px;">
        <i class="fas fa-search" style="font-size: 20px;"></i>
        <strong style="font-size: 18px;">Registro No Encontrado</strong>
      </div>
      <p style="text-align:center; margin: 6px 0 10px 0;">No se encontró registro para Part Number <strong>${partNumber}</strong> y Customer Number <strong>${customerNumber}</strong>.</p>
      <p style="text-align:center; margin: 0 0 16px 0;">¿Desea crear un nuevo registro?</p>
      <div style="display:flex; gap:12px; justify-content:center;">
        <button type="button" class="btn btn-success" onclick="startCreateNewRecord('${partNumber}', '${customerNumber}')" style="padding:10px 16px;">
          <i class="fas fa-check"></i> Sí, Crear Nuevo
        </button>
        <button type="button" class="btn btn-danger" onclick="startNewSearch()" style="padding:10px 16px; background:#dc2626; border-color:#dc2626;">
          <i class="fas fa-times"></i> No, Cancelar
        </button>
      </div>
    </div>`;
}

// Crear un nuevo registro desde el banner de "No Encontrado"
function startCreateNewRecord(partNumber, customerNumber) {
  try {
    const recordId = `${partNumber}_${customerNumber}`;
    const record = {
      partNumber,
      customerNumber,
      custno: customerNumber,
      customerName: '',
      customer: '',
      partDescription: '',
      notes: '',
      date: new Date().toISOString().split('T')[0],
      priceRanges: []
    };

    const resultsArea = document.getElementById('captureResultsArea');
    if (resultsArea) resultsArea.innerHTML = '';

    // Reutiliza el formulario de edición que ya crea el contenedor de rangos
    showEditAPIRecordForm(recordId, record);
    showInfoMessage('Creando nuevo registro. Agrega rangos y guarda los cambios.');
  } catch (e) {
    console.error('Error iniciando creación de nuevo registro:', e);
    showNotification('❌ No se pudo iniciar el formulario de nuevo registro', 'error');
  }
}
        
        // Función auxiliar para renderizar el registro de la API
        function renderAPIRecord(resultArea, customerInfo, partInfo, record) {
            
            // SIEMPRE mostrar customerName y customerNumber en recuadro azul claro
            // y partNumber con partDescription en recuadro morado claro
            // Esto se muestra incluso si priceRanges está vacío
            
            // Hacer visibles los elementos
            customerInfo.style.display = 'block';
            partInfo.style.display = 'block';
            resultArea.style.display = 'block';
            
            // Mostrar información del cliente - SIEMPRE (recuadro azul claro)
            customerInfo.innerHTML = `
                <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                    <h4 style="color: #0369a1; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-building"></i> Información del Cliente (desde PicLan API)
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.95em;">
                        <div><strong>Customer Number:</strong> ${record.customerNumber || record.custno || 'N/A'}</div>
                        <div><strong>Customer Name:</strong> ${record.customerName || record.customer || 'N/A'}</div>
                    </div>
                </div>
            `;
            
            // Mostrar información del part - SIEMPRE (recuadro morado claro)
            let priceRangesHTML = '';
            if (record.priceRanges && record.priceRanges.length > 0) {
                priceRangesHTML = record.priceRanges.map(range => `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #e5e7eb;">${range.fromQty}</td>
                        <td style="padding: 8px; border: 1px solid #e5e7eb;">${range.toQty}</td>
                        <td style="padding: 8px; border: 1px solid #e5e7eb; font-weight: 600;">$${parseFloat(range.price).toFixed(3)}</td>
                    </tr>
                `).join('');
            }
            
            partInfo.innerHTML = `
                <div style="background: #faf5ff; border: 1px solid #a855f7; border-radius: 8px; padding: 16px;">
                    <h4 style="color: #7c3aed; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-cog"></i> Información del Part (desde PicLan API)
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.95em; margin-bottom: 16px;">
                        <div><strong>Part Number:</strong> ${record.partNumber}</div>
                        <div><strong>Description:</strong> ${record.partDescription || 'N/A'}</div>
                    </div>
                    
                    ${record.priceRanges && record.priceRanges.length > 0 ? `
                        <h5 style="color: #7c3aed; margin-bottom: 8px;">Price Ranges:</h5>
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                            <thead>
                                <tr style="background: #f3e8ff;">
                                    <th style="padding: 8px; border: 1px solid #a855f7; text-align: left;">From Qty</th>
                                    <th style="padding: 8px; border: 1px solid #a855f7; text-align: left;">To Qty</th>
                                    <th style="padding: 8px; border: 1px solid #a855f7; text-align: left;">Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${priceRangesHTML}
                            </tbody>
                        </table>
                        <div style="text-align: center; margin-top: 12px;">
                            <button onclick="showEditAPIRecordForm('${record.partNumber}_${record.customerNumber || record.custno}', ${JSON.stringify(record).replace(/\"/g, '&quot;')})" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;">
                                <i class="fas fa-edit"></i> Editar / Agregar Rangos
                            </button>
                        </div>
                    ` : `
                        <p style="color: #6b7280; font-style: italic; margin-top: 12px;">No hay rangos de precios disponibles. Puede agregarlos usando el formulario de edición.</p>
                        <div style="text-align: center; margin-top: 12px;">
                            <button onclick="showEditAPIRecordForm('${record.partNumber}_${record.customerNumber || record.custno}', ${JSON.stringify(record).replace(/\"/g, '&quot;')})" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;">
                                <i class="fas fa-plus"></i> Editar / Agregar Rangos
                            </button>
                        </div>
                    `}
                </div>
            `;
            
            // Mostrar el área de resultados
            customerInfo.style.display = 'block';
            partInfo.style.display = 'block';
            resultArea.style.display = 'block';
            
            // Mostrar botones de acción
            const actionBtns = document.getElementById('captureActionButtons');
            if (actionBtns) actionBtns.style.display = 'flex';
        }

        // FUNCIÓN PARA CONSULTAR SOLO SERVIDOR PICLAN
        // isSearching variable already declared globally above
        

        

        



        // Make function globally accessible for HTML onkeydown events
        window.simpleCaptureSearch = async function simpleCaptureSearch() {
            if (isSearching) {
                console.warn('⏸️ [CAPTURE] simpleCaptureSearch ignored: already searching');
                return; // Evitar búsquedas múltiples
            }
            
            try {
                console.log('🔎 [CAPTURE] simpleCaptureSearch invoked');
                // Normalizar entradas para evitar mismatches por casing/espacios
                const partNumberInput = document.getElementById('partNumber').value.trim();
                const customerNumberInput = document.getElementById('custno').value.trim();
                const partNumber = partNumberInput.toUpperCase();
                const customerNumber = customerNumberInput;
                
                // Validar que ambos campos estén llenos
                if (!partNumber || !customerNumber) {
                    console.warn('⚠️ [CAPTURE] Missing required fields', { partNumber, customerNumber });
                    showErrorNotification('Campos Requeridos', 'Por favor ingrese tanto el Part Number como el Customer Number para buscar registros.');
                    return;
                }
                isSearching = true;
                
                // Limpiar resultados anteriores
                const resultsArea = document.getElementById('captureResultsArea');
                resultsArea.innerHTML = '';
                // Reset any collapsed styles from post-save animation
                resultsArea.style.maxHeight = 'none';
                resultsArea.style.opacity = '1';
                resultsArea.style.display = 'block';
                
                // Mostrar mensaje de carga Y mantener contenedores destino
                resultsArea.innerHTML = `
                    <div id="captureCustomerInfo" style="display: none;"></div>
                    <div id="capturePartInfo" style="display: none;"></div>
                    <div id="captureLoading" style="text-align: center; padding: 40px; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 12px; margin: 20px 0;">
                        <div class="loading-spinner" style="margin: 0 auto 20px; width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <h3 style="color: #1e293b; margin-bottom: 10px;">🔍 Consultando PicLan Database...</h3>
                        <p style="color: #64748b;">Buscando ${partNumber} - Cliente ${customerNumber}</p>
                    </div>
                `;
            
                try {
                    // Consultar directamente el servidor PicLan
                    // Usar ruta relativa para evitar CORS/mixed content cuando se sirve desde el mismo servidor PicLan
                    const attemptUrls = [
                        `GET_BUYERS.XML`,
                        ];
                    let xmlText = '';
                    let lastErrorMsg = '';
                    for (let i = 0; i < attemptUrls.length; i++) {
                        try {
                            // Añadir timeout robusto para evitar que el loader quede colgado si el servidor no responde
                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 12000); // 12s
                            let response;
                            try {
                                response = await fetch(attemptUrls[i], {
                                    method: 'GET',
                                    headers: {
                                        'Accept': 'text/xml, application/xml, */*',
                                        'Cache-Control': 'no-cache'
                                    },
                                    signal: controller.signal
                                });
                            } finally {
                                clearTimeout(timeoutId);
                            }
                            if (response.ok) {
                                const txt = await response.text();
                                if (txt && txt.trim().length > 0 && !txt.includes('INTERNAL ERROR')) {
                                    xmlText = txt;
                                    break;
                                }
                                lastErrorMsg = 'Empty or invalid XML response';
                            } else {
                                lastErrorMsg = `HTTP ${response.status} - ${response.statusText}`;
                            }
                        } catch (e) {
                            lastErrorMsg = e.message || 'Request failed';
                        }
                    }
                    if (!xmlText || xmlText.trim().length === 0) {
                        throw new Error(lastErrorMsg || 'No response from PicLan');
                    }
                    console.log('📄 [DEBUG] XML Response:', xmlText);
                    
                    // Verificar si la respuesta está vacía
                    if (!xmlText || xmlText.trim().length === 0) {
                        throw new Error('El servidor PicLan devolvió una respuesta vacía.');
                    }
                    
                    // Parsear XML
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                    
                    // Verificar si hay errores de parsing
                    const parseError = xmlDoc.querySelector('parsererror');
                    if (parseError) {
                        throw new Error('Error parsing XML: ' + parseError.textContent);
                    }
                    
                    // Extraer datos del XML
                    // Reset flag and support multiple possible tag casings
                    window.__lastApiHadRecord = false;
                    const recordElement = xmlDoc.querySelector('record') || xmlDoc.querySelector('CUSTOMER') || xmlDoc.querySelector('customer');
                    
                    if (recordElement) {
                        window.__lastApiHadRecord = true;
                        console.log('🔍 Record element found:', recordElement);
                        
                        const record = {
                            partNumber: getXMLTextContent(recordElement, 'partNumber', 'PART_NUMBER') || partNumber,
                            customerNumber: getXMLTextContent(recordElement, 'customerNumber', 'CUSTOMER_NUMBER') || customerNumber,
                            customerName: getXMLTextContent(recordElement, 'customerName', 'CUSTOMER_NAME'),
                            partDescription: getXMLTextContent(recordElement, 'partDescription', 'DESCRIPTION'),
                            notes: getXMLTextContent(recordElement, 'notes', 'NOTES'),
                            date: getXMLTextContent(recordElement, 'date', 'DATE'),
                            priceRanges: []
                        };
                        
                        // Extraer price ranges
                        const rangeElements = recordElement.querySelectorAll('range');
                        rangeElements.forEach((range) => {
                            const fromQty = parseFloat(getXMLTextContent(range, 'fromQty', 'MIN_QTY', 'minQty')) || 0;
                            const toQty = parseFloat(getXMLTextContent(range, 'toQty', 'MAX_QTY', 'maxQty')) || 0;
                            const price = parseFloat(getXMLTextContent(range, 'price', 'PRICE', 'unitPrice')) || 0;
                            
                            if (fromQty || toQty || price) {
                                record.priceRanges.push({ fromQty, toQty, price });
                            }
                        });
                        
                        console.log('🔍 Final record:', record);
                        
                        // Ocultar/eliminar loading y luego renderizar el resultado
                        const loadingEl = document.getElementById('captureLoading');
                        if (loadingEl) loadingEl.remove();
                        // Ocultar banner de no encontrado si existiera
                        const notFoundBanner = document.getElementById('captureNotFoundBanner');
                        if (notFoundBanner) notFoundBanner.remove();

                        // Siempre llamar a renderAPIRecord cuando el record existe, aunque priceRanges esté vacío
                        const customerInfo = resultsArea.querySelector('#captureCustomerInfo') || document.getElementById('captureCustomerInfo');
                        const partInfo = resultsArea.querySelector('#capturePartInfo') || document.getElementById('capturePartInfo');
                        renderAPIRecord(resultsArea, customerInfo, partInfo, record);
                        
                        // Si priceRanges está vacío, abrir automáticamente el formulario de edición
                        if (!record.priceRanges || record.priceRanges.length === 0) {
                            const rid = `${record.partNumber}_${record.customerNumber || record.custno || ''}`;
                            showEditAPIRecordForm(rid, record);
                            showInfoMessage('El cliente no tiene rangos de precios todavía. Agrega uno y guarda.');
                        }
                        
                        // Ocultar el contenedor de "Crear Nuevo" si se encontró un record
                        const createNewContainer = document.getElementById('captureCreateNewContainer');
                        if (createNewContainer) {
                            createNewContainer.style.display = 'none';
                        }
                        
                        showSuccessNotification('Encontrado en PicLan', `${record.partNumber} - ${record.customerName || 'Cliente ' + record.customerNumber}`);
                    } else {
                        // No se encontró record EXACTO. Fallback seguro: usar cliente 14 para esta parte (evitar ID=ALL 500)
                        try {
                            if (!partNumber || !String(partNumber).trim()) {
                                console.warn('⛔ Fallback omitido: PART_NUMBER vacío');
                                throw new Error('PART_NUMBER vacío');
                            }
                            console.log('⚠️ Fallback code disabled - using autoFillNameFromOPERS instead');
                            
                            let xmlText = '';
                            let lastErrorMsg = '';
                            for (let i = 0; i < fbUrls.length; i++) {
                                try {
                                    // Añadir timeout robusto para evitar que el loader quede colgado si el servidor no responde
                                    const controller = new AbortController();
                                    const timeoutId = setTimeout(() => controller.abort(), 12000); // 12s
                                    let response;
                                    try {
                                        response = await fetch(fbUrls[i], {
                                            method: 'GET',
                                            headers: {
                                                'Accept': 'text/xml, application/xml, */*',
                                                'Cache-Control': 'no-cache'
                                            },
                                            signal: controller.signal
                                        });
                                    } finally {
                                        clearTimeout(timeoutId);
                                    }
                                    if (response.ok) {
                                        const txt = await response.text();
                                        if (txt && txt.trim().length > 0 && !txt.includes('INTERNAL ERROR')) {
                                            xmlText = txt;
                                            break;
                                        }
                                        lastErrorMsg = 'Empty or invalid XML response';
                                    } else {
                                        lastErrorMsg = `HTTP ${response.status} - ${response.statusText}`;
                                    }
                                } catch (e) {
                                    lastErrorMsg = e.message || 'Request failed';
                                }
                            }
                            if (xmlText && xmlText.trim().length > 0) {
                                const fbDoc = new DOMParser().parseFromString(xmlText, 'text/xml');
                                const candidates = fbDoc.querySelectorAll('record, CUSTOMER, customer');
                                let matched = null;
                                candidates.forEach(node => {
                                    const cust = getXMLTextContent(node, 'customerNumber', 'CUSTOMER_NUMBER');
                                    const part = getXMLTextContent(node, 'partNumber', 'PART_NUMBER');
                                    if (!matched && cust && cust.trim() === customerNumber && part && part.trim().toUpperCase() === partNumber) {
                                        matched = node;
                                    }
                                });

                                if (matched) {
                                    window.__lastApiHadRecord = true;
                                    const record = {
                                        partNumber: getXMLTextContent(matched, 'partNumber', 'PART_NUMBER') || partNumber,
                                        customerNumber: getXMLTextContent(matched, 'customerNumber', 'CUSTOMER_NUMBER') || customerNumber,
                                        customerName: getXMLTextContent(matched, 'customerName', 'CUSTOMER_NAME'),
                                        partDescription: getXMLTextContent(matched, 'partDescription', 'DESCRIPTION'),
                                        notes: getXMLTextContent(matched, 'notes', 'NOTES'),
                                        date: getXMLTextContent(matched, 'date', 'DATE'),
                                        priceRanges: []
                                    };
                                    const ranges = matched.querySelectorAll('range');
                                    ranges.forEach(range => {
                                        const fromQty = parseFloat(getXMLTextContent(range, 'fromQty', 'MIN_QTY', 'minQty')) || 0;
                                        const toQty = parseFloat(getXMLTextContent(range, 'toQty', 'MAX_QTY', 'maxQty')) || 0;
                                        const price = parseFloat(getXMLTextContent(range, 'price', 'PRICE', 'unitPrice')) || 0;
                                        if (fromQty || toQty || price) record.priceRanges.push({ fromQty, toQty, price });
                                    });

                                    const loadingEl = document.getElementById('captureLoading');
                                    if (loadingEl) loadingEl.remove();
                                    const notFoundBanner = document.getElementById('captureNotFoundBanner');
                                    if (notFoundBanner) notFoundBanner.remove();
                                    const customerInfo = resultsArea.querySelector('#captureCustomerInfo') || document.getElementById('captureCustomerInfo');
                                    const partInfo = resultsArea.querySelector('#capturePartInfo') || document.getElementById('capturePartInfo');
                                    renderAPIRecord(resultsArea, customerInfo, partInfo, record);
                                    if (!record.priceRanges || record.priceRanges.length === 0) {
                                        const rid = `${record.partNumber}_${record.customerNumber || record.custno || ''}`;
                                        showEditAPIRecordForm(rid, record);
                                        showInfoMessage('El cliente no tiene rangos de precios todavía. Agrega uno y guarda.');
                                    }
                                    showSuccessNotification('Encontrado (fallback ID=14)', `${record.partNumber} - ${record.customerName || 'Cliente ' + record.customerNumber}`);
                                } else {
                                    // No hay coincidencia por cliente para el PART, crear registro sintético usando la descripción del primero (si existe)
                                    let syntheticPartDesc = '';
                                    if (candidates && candidates.length > 0) {
                                        const first = candidates[0];
                                        syntheticPartDesc = getXMLTextContent(first, 'partDescription', 'DESCRIPTION') || '';
                                    }
                                    window.__lastApiHadRecord = true;
                                    const synthetic = {
                                        partNumber: partNumber,
                                        customerNumber: customerNumber,
                                        customerName: '',
                                        partDescription: syntheticPartDesc,
                                        notes: '',
                                        date: new Date().toISOString().split('T')[0],
                                        priceRanges: []
                                    };
                                    const loadingEl = document.getElementById('captureLoading');
                                    if (loadingEl) loadingEl.remove();
                                    const notFoundBanner = document.getElementById('captureNotFoundBanner');
                                    if (notFoundBanner) notFoundBanner.remove();
                                    const customerInfo = resultsArea.querySelector('#captureCustomerInfo') || document.getElementById('captureCustomerInfo');
                                    const partInfo = resultsArea.querySelector('#capturePartInfo') || document.getElementById('capturePartInfo');
                                    renderAPIRecord(resultsArea, customerInfo, partInfo, synthetic);
                                    const rid = `${synthetic.partNumber}_${synthetic.customerNumber || ''}`;
                                    showEditAPIRecordForm(rid, synthetic);
                                    showInfoMessage('Registro sin rangos para este cliente. Agrega uno y guarda.');
                                    showSuccessNotification('Mostrando registro sin rangos', `${synthetic.partNumber} - Cliente ${synthetic.customerNumber}`);
                                }
                            } else {
                                // Sin XML en fallback: mostrar registro sintético para permitir agregar rangos
                                window.__lastApiHadRecord = true;
                                const synthetic = {
                                    partNumber: partNumber,
                                    customerNumber: customerNumber,
                                    customerName: '',
                                    partDescription: '',
                                    notes: '',
                                    date: new Date().toISOString().split('T')[0],
                                    priceRanges: []
                                };
                                const loadingEl = document.getElementById('captureLoading');
                                if (loadingEl) loadingEl.remove();
                                const notFoundBanner = document.getElementById('captureNotFoundBanner');
                                if (notFoundBanner) notFoundBanner.remove();
                                const customerInfo = resultsArea.querySelector('#captureCustomerInfo') || document.getElementById('captureCustomerInfo');
                                const partInfo = resultsArea.querySelector('#capturePartInfo') || document.getElementById('capturePartInfo');
                                renderAPIRecord(resultsArea, customerInfo, partInfo, synthetic);
                                const rid = `${synthetic.partNumber}_${synthetic.customerNumber || ''}`;
                                showEditAPIRecordForm(rid, synthetic);
                                showInfoMessage('PicLan no devolvió datos. Mostrando registro sin rangos para editar.');
                                showSuccessNotification('Registro sin rangos', `${synthetic.partNumber} - Cliente ${synthetic.customerNumber}`);
                            }
                        } catch (fbErr) {
                            console.warn('⚠️ [FALLBACK] Error:', fbErr);
                            // También en error: crear registro sintético para cumplir el requerimiento
                            window.__lastApiHadRecord = true;
                            const synthetic = {
                                partNumber: partNumber,
                                customerNumber: customerNumber,
                                customerName: '',
                                partDescription: '',
                                notes: '',
                                date: new Date().toISOString().split('T')[0],
                                priceRanges: []
                            };
                            const loadingEl = document.getElementById('captureLoading');
                            if (loadingEl) loadingEl.remove();
                            const notFoundBanner = document.getElementById('captureNotFoundBanner');
                            if (notFoundBanner) notFoundBanner.remove();
                            const customerInfo = resultsArea.querySelector('#captureCustomerInfo') || document.getElementById('captureCustomerInfo');
                            const partInfo = resultsArea.querySelector('#capturePartInfo') || document.getElementById('capturePartInfo');
                            renderAPIRecord(resultsArea, customerInfo, partInfo, synthetic);
                            const rid = `${synthetic.partNumber}_${synthetic.customerNumber || ''}`;
                            showEditAPIRecordForm(rid, synthetic);
                            showInfoMessage('No se pudo consultar PicLan. Mostrando registro sin rangos para editar.');
                            showSuccessNotification('Registro sin rangos', `${synthetic.partNumber} - Cliente ${synthetic.customerNumber}`);
                        }
                    }

                } catch (error) {
                    console.error('Error consultando PicLan:', error);
                    // En caso de error/timeout en todas las llamadas, mostrar un registro sintético editable
                    try {
                        window.__lastApiHadRecord = true;
                        const loadingEl = document.getElementById('captureLoading');
                        if (loadingEl) loadingEl.remove();
                        const notFoundBanner = document.getElementById('captureNotFoundBanner');
                        if (notFoundBanner) notFoundBanner.remove();

                        // Obtener valores actuales del formulario por si las variables locales no están disponibles
                        const pn = (typeof partNumber !== 'undefined' && partNumber) ? partNumber : (document.getElementById('partNumber')?.value || '').trim().toUpperCase();
                        const cn = (typeof customerNumber !== 'undefined' && customerNumber) ? customerNumber : (document.getElementById('custno')?.value || '').trim();

                        const synthetic = {
                            partNumber: pn,
                            customerNumber: cn,
                            customerName: '',
                            partDescription: '',
                            notes: '',
                            date: new Date().toISOString().split('T')[0],
                            priceRanges: []
                        };

                        const customerInfo = resultsArea.querySelector('#captureCustomerInfo') || document.getElementById('captureCustomerInfo');
                        const partInfo = resultsArea.querySelector('#capturePartInfo') || document.getElementById('capturePartInfo');
                        renderAPIRecord(resultsArea, customerInfo, partInfo, synthetic);
                        showInfoMessage('No se pudo consultar PicLan. Mostrando registro sin rangos para editar.');
                        showErrorNotification('Conexión PicLan', error?.message || 'No se pudo conectar al servidor');
                        showSuccessNotification('Registro sin rangos', `${synthetic.partNumber} - Cliente ${synthetic.customerNumber}`);
                    } catch (renderErr) {
                        console.error('❌ Error mostrando registro sintético tras fallo de red:', renderErr);
                        showNotification('❌ Error inesperado al mostrar registro sin rangos', 'error');
                    }
                }
                            } catch (outerError) {
                    console.error('❌ Error general en simpleCaptureSearch:', outerError);
                    showNotification('❌ Error inesperado durante la búsqueda', 'error');
                } finally {
                    // Asegurar que isSearching siempre se resetee
                    isSearching = false;
                    // Cleanup defensivo del loader si aún existe
                    const loadingElFinal = document.getElementById('captureLoading');
                    if (loadingElFinal) loadingElFinal.remove();
                }
        }
        
        // Función para mostrar registro encontrado
        function displayFoundRecord(record) {
            const resultsArea = document.getElementById('captureResultsArea');
            let priceRangesHtml = '';
            
            if (record.priceRanges && record.priceRanges.length > 0) {
                priceRangesHtml = record.priceRanges.map(range => `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center;">${range.fromQty}</td>
                        <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center;">${range.toQty}</td>
                        <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right;">$${parseFloat(range.price).toFixed(3)}</td>
                    </tr>
                `).join('');
            }
            
            resultsArea.innerHTML = `
                <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px; padding: 20px; margin: 20px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4 style="color: #0c4a6e; margin: 0; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-check-circle" style="color: #10b981;"></i> 
                            Registro Encontrado
                        </h4>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="showEditAPIRecordForm('${record.id}', ${JSON.stringify(record).replace(/"/g, '&quot;')})" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-edit"></i> Edit Record
                            </button>
                            <button onclick="startNewCaptureSearch()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-search"></i> Nueva Búsqueda
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div>
                            <strong style="color: #374151;">Part Number:</strong>
                            <p style="margin: 4px 0; color: #1f2937; font-weight: 600;">${record.partNumber}</p>
                        </div>
                        <div>
                            <strong style="color: #374151;">Customer:</strong>
                            <p style="margin: 4px 0; color: #1f2937; font-weight: 600;">#${record.customerNumber} - ${record.customerName}</p>
                        </div>
                        <div>
                            <strong style="color: #374151;">Description:</strong>
                            <p style="margin: 4px 0; color: #1f2937;">${record.partDescription}</p>
                        </div>
                        <div>
                            <strong style="color: #374151;">Date:</strong>
                            <p style="margin: 4px 0; color: #1f2937;">${record.date}</p>
                        </div>
                    </div>
                    
                    ${record.notes ? `
                        <div style="margin-bottom: 20px;">
                            <strong style="color: #374151;">Notes:</strong>
                            <p style="margin: 4px 0; color: #1f2937; font-style: italic;">${record.notes}</p>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 20px;">
                        <h5 style="color: #374151; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-dollar-sign" style="color: #059669;"></i> 
                            Price Ranges
                        </h5>
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 6px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <thead>
                                <tr style="background: #f9fafb;">
                                    <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600; color: #374151;">From Qty</th>
                                    <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600; color: #374151;">To Qty</th>
                                    <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600; color: #374151;">Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${priceRangesHtml || '<tr><td colspan="3" style="padding: 12px; text-align: center; color: #6b7280;">No price ranges available</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // Función para mostrar "no encontrado"
        function displayRecordNotFound(partNumber, custNumber) {
            const resultsArea = document.getElementById('captureResultsArea');
            resultsArea.innerHTML = `
                <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 20px; margin: 20px 0; text-align: center;">
                    <div style="margin-bottom: 20px;">
                        <i class="fas fa-search" style="font-size: 2em; color: #d97706; margin-bottom: 15px;"></i>
                        <h3 style="color: #92400e; margin: 0 0 10px 0; font-weight: 600;">Registro No Encontrado</h3>
                        <p style="color: #92400e; margin: 0; font-size: 1.1em;">No se encontró registro para Part Number <strong>${partNumber}</strong> y Customer Number <strong>${custNumber}</strong>.</p>
                        <p style="color: #92400e; margin: 10px 0 0 0; font-size: 1em;">¿Desea crear un nuevo registro?</p>
                    </div>
                    
                    <div style="display: flex; justify-content: center; gap: 15px;">
                        <button onclick="showNewRecordForm('${partNumber}', '${custNumber}')" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 1em; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-weight: 600;">
                            <i class="fas fa-check"></i> Sí, Crear Nuevo
                        </button>
                        
                        <button onclick="clearCaptureForm()" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 1em; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-weight: 600;">
                            <i class="fas fa-times"></i> No, Cancelar
                        </button>
                    </div>
                </div>
            `;
        }
        
        // FUNCIÓN PARA MOSTRAR FORMULARIO DE NUEVO REGISTRO DESPUÉS DE CONFIRMACIÓN
        function showNewRecordForm(partNumber, custNumber) {
            const resultsArea = document.getElementById('captureResultsArea');
            
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h4 style="color: #059669; margin: 0; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-plus-circle" style="color: #059669;"></i> Creating New Record: Part ${partNumber} for Customer #${custNumber}
                    </h4>
                    <button onclick="startNewCaptureSearch()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 8px 16px; border: none; border-radius: 6px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <i class="fas fa-search"></i> New Search
                    </button>
                </div>
                
                <form onsubmit="saveSimpleRecord(event, '${partNumber}', '${custNumber}')" style="background: #f8fafc; border: 2px solid #10b981; border-radius: 8px; padding: 20px;">
                    <h5 style="color: #374151; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-plus-circle" style="color: #059669;"></i> Create New Record
                    </h5>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">Customer Name <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="newCustomerName" required style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1em;">
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">Part Description <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="newPartDescription" required style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1em;">
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">Unit</label>
                            <input type="text" id="newUnit" placeholder="e.g., EA, LB, KG" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1em;">
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">Currency</label>
                            <select id="newCurrency" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1em;">
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="MXN">MXN</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">Date</label>
                            <input type="date" id="newDate" value="${new Date().toISOString().split('T')[0]}" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1em;">
                        </div>
                    </div>
                    
                    <!-- Price Ranges Section for New Record -->
                    <div style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h5 style="color: #374151; margin: 0; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-dollar-sign" style="color: #059669;"></i> Price Ranges
                            </h5>
                            <button type="button" onclick="addNewRecordPriceRange()" style="background: #10b981; color: white; padding: 6px 12px; border: none; border-radius: 4px; font-size: 0.9em; cursor: pointer;">
                                <i class="fas fa-plus"></i> Add Range
                            </button>
                        </div>
                        <div id="newRecordPriceRanges" style="display: grid; gap: 8px;">
                            <div id="newRange_0" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 6px; align-items: end;">
                                <div>
                                    <label style="font-size: 0.9em; color: #6b7280; font-weight: 500; display: block; margin-bottom: 4px;">From Qty</label>
                                    <input type="number" value="1" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                                </div>
                                <div>
                                    <label style="font-size: 0.9em; color: #6b7280; font-weight: 500; display: block; margin-bottom: 4px;">To Qty</label>
                                    <input type="number" value="999999" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                                </div>
                                <div>
                                    <label style="font-size: 0.9em; color: #6b7280; font-weight: 500; display: block; margin-bottom: 4px;">Price</label>
                                    <input type="number" step="0.001" placeholder="0.000" value="" class="price-input" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                                </div>
                                <button type="button" class="delete-new-range-btn" data-range-id="newRange_0" style="background: #3b82f6; color: white; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; min-width: 32px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button type="submit" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 1em; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                            <i class="fas fa-save"></i> Save New Record
                        </button>
                    </div>
                </form>
            `;
            
            resultsArea.innerHTML = html;
            
            // Agregar event listeners para los botones de delete en NUEVOS REGISTROS
            setTimeout(() => {
                const newRecordDeleteButtons = resultsArea.querySelectorAll('.delete-new-range-btn');
                console.log('🔧 Found NEW RECORD delete buttons:', newRecordDeleteButtons.length);
                
                newRecordDeleteButtons.forEach((button, index) => {
                    console.log(`🔧 Adding listener to NEW RECORD button ${index}`, button);
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('🔥 NEW RECORD DELETE BUTTON CLICKED!', this);
                        
                        const rangeId = this.getAttribute('data-range-id');
                        console.log('🔥 Range ID:', rangeId);
                        
                        if (rangeId) {
                            removeNewRecordPriceRange(rangeId);
                        } else {
                            console.error('❌ Missing range ID');
                            alert('Error: Falta ID del range');
                        }
                    });
                });
            }, 100);
        }
        
        // FUNCIÓN SIMPLE PARA GUARDAR REGISTROS (SOLO MEMORIA LOCAL)
        function saveSimpleRecord(event, partNumber, custNumber) {
            console.log('💾 Guardando registro localmente:', { partNumber, custNumber });
            event.preventDefault();
            
            const customerName = document.getElementById('newCustomerName').value.trim();
            const partDescription = document.getElementById('newPartDescription').value.trim();
            const unit = document.getElementById('newUnit').value.trim();
            const currency = document.getElementById('newCurrency').value;
            const date = document.getElementById('newDate').value;
            
            if (!customerName || !partDescription) {
                alert('Customer Name y Part Description son requeridos');
                return;
            }
            
            // Recopilar price ranges
            const priceRanges = [];
            const rangeContainers = document.querySelectorAll('#newRecordPriceRanges > div');
            
            rangeContainers.forEach(container => {
                const inputs = container.querySelectorAll('input[type="number"]');
                if (inputs.length >= 3) {
                    const fromQty = parseInt(inputs[0].value) || 1;
                    const toQty = parseInt(inputs[1].value) || 999999;
                    const price = parseFloat(inputs[2].value) || 0;
                    if (price > 0) {
                        priceRanges.push({ fromQty, toQty, price });
                    }
                }
            });
            
            // Crear nuevo registro
            const newRecord = {
                id: Date.now(),
                partNumber: partNumber,
                custno: custNumber,
                customer: customerName,
                partDescription: partDescription,
                unit: unit || 'EA',
                currency: currency,
                date: date || new Date().toISOString().split('T')[0],
                priceRanges: priceRanges,
                source: 'Local Storage'
            };
            
            // Agregar al array de records
            records.push(newRecord);
            
            // Deduplicate global records to prevent duplicates
            const _uniqueAfterSimpleSave = dedupeRecords(records);
            records.length = 0;
            records.push(..._uniqueAfterSimpleSave);
            
            // No localStorage - data should be saved via PicLan API only
            
            // Actualizar grid
            renderRecords();
            
            // Mostrar mensaje de éxito
            showSuccessNotification('¡Registro guardado exitosamente!', `Parte ${partNumber} para Cliente #${custNumber}`);
            
            // Limpiar formulario y mostrar el nuevo registro
            setTimeout(() => {
                simpleCaptureSearch();
            }, 1000);
            
            console.log('✅ Registro guardado en memoria local:', newRecord);
        }
        
        // Función para agregar price range en nuevo registro - ACTUALIZADA
        function addNewRecordPriceRange() {
            const container = document.getElementById('newRecordPriceRanges');
            const rangeId = 'newRange_' + Date.now();
            
            const rangeHtml = `
                <div class="price-range-row" id="${rangeId}" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; align-items: end; padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 8px;">
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 0.9em; color: #6b7280; font-weight: 500; display: block; margin-bottom: 4px;">From Qty</label>
                        <input type="number" min="1" value="1" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 0.9em; color: #6b7280; font-weight: 500; display: block; margin-bottom: 4px;">To Qty</label>
                        <input type="number" min="1" value="999999" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 0.9em; color: #6b7280; font-weight: 500; display: block; margin-bottom: 4px;">Price</label>
                        <input type="number" step="0.001" min="0" value="" class="price-input" placeholder="0.000" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                    </div>
                    <button type="button" onclick="removeRangeByButton(this)" style="background: #3b82f6; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9em; height: fit-content;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', rangeHtml);
            
            // Apply price formatting to the newly created price input
            const newPriceInput = container.querySelector(`#${rangeId} .price-input`);
            if (newPriceInput) {
                addPriceFormatting(newPriceInput);
            }
        }
        
        // Función UNIVERSAL para remover cualquier price range por botón
        function removeRangeByButton(button) {
            console.log('🗑️ Universal remove range by button clicked');
            
            // Buscar el div padre más cercano que contenga los inputs del price range
            let rangeDiv = button.closest('.price-range-row');
            if (!rangeDiv) {
                rangeDiv = button.closest('div[id*="Range_"], div[id*="newRange_"], div[id*="range"], div[id*="_range_"]');
            }
            if (!rangeDiv) {
                rangeDiv = button.parentElement; // Fallback al elemento padre directo
            }
            
            // Buscar el contenedor - intentar múltiples IDs y clases posibles
            let container = rangeDiv?.parentElement;
            if (!container) {
                container = document.getElementById('newRecordPriceRanges') ||
                           document.querySelector('[id*="priceRanges"], [id*="PriceRanges"], [id*="_priceRangesContainer"]') ||
                           document.querySelector('.price-ranges-section, .price-ranges-container');
            }
            
            console.log('Range div found:', !!rangeDiv, rangeDiv?.id || 'no id');
            console.log('Container found:', !!container, container?.id || 'no id');
            console.log('Current ranges count:', container ? container.children.length : 'no container');
            
            if (!container || !rangeDiv) {
                console.error('❌ Could not find container or range div');
                alert('Error: No se pudo encontrar el price range');
                return;
            }
            
            console.log('📊 Current ranges count:', container.children.length);
            
            // ELIMINAR SOLO LA FILA INDIVIDUAL
            console.log('🗑️ About to remove element:', rangeDiv);
            console.log('🗑️ Container before removal:', container, 'Children count:', container.children.length);
            
            rangeDiv.remove();
            console.log('✅ Price range removed successfully');
            console.log('📊 Remaining ranges in container:', container.children.length);
            
            // Si no quedan rangos, ocultar la sección completa para eliminar el espacio en blanco
            if (container.children.length === 0) {
                console.log('⚠️ No ranges left - hiding price ranges section');
                
                // Buscar la sección padre que contiene el título "Price Ranges" y todo el contenedor
                const priceRangesSection = container.closest('.price-ranges-section');
                if (priceRangesSection) {
                    priceRangesSection.style.display = 'none';
                    console.log('✅ Price ranges section hidden completely');
                } else {
                    // Si no encuentra la sección, ocultar el contenedor padre
                    const parentSection = container.parentElement;
                    if (parentSection && (parentSection.innerHTML.includes('Price Ranges') || parentSection.querySelector('h4, h3, label'))) {
                        parentSection.style.display = 'none';
                        console.log('✅ Parent section hidden');
                    }
                }
            }
        }

        // Customer Number search (Search & View tab)
        function searchByCustomerNumber() {
            const input = document.getElementById('searchCustomerNumber');
            if (!input) return;
            const val = input.value.trim();
            if (val === '') {
                // Reset and show all
                const pn = document.getElementById('searchPartNumber');
                const cn = document.getElementById('searchCustomer');
                if (pn) pn.value = '';
                if (cn) cn.value = '';
                if (typeof renderRecords === 'function') renderRecords(records);
                if (typeof updateRecordCount === 'function') updateRecordCount(records.length);
                return;
            }
            const filtered = (Array.isArray(records) ? records : []).filter(r => {
                const num = (r.customerNumber || r.custno || '').toString().trim();
                return num.includes(val);
            });
            if (typeof renderRecords === 'function') renderRecords(filtered);
            if (typeof updateRecordCount === 'function') updateRecordCount(filtered.length);
        }

        function handleCustomerNumberEnter(event) {
            if (event && event.key === 'Enter') {
                event.preventDefault();
                searchByCustomerNumber();
            }
        }

        // Customer Name cascade search (Search & View tab)
        function searchCustomerCascade() {
            const input = document.getElementById('searchCustomer');
            if (!input) return;
            const term = input.value.trim().toLowerCase();
            if (term === '') {
                const pn = document.getElementById('searchPartNumber');
                const cn = document.getElementById('searchCustomerNumber');
                if (pn) pn.value = '';
                if (cn) cn.value = '';
                if (typeof renderRecords === 'function') renderRecords(records);
                if (typeof updateRecordCount === 'function') updateRecordCount(records.length);
                return;
            }
            const filtered = (Array.isArray(records) ? records : []).filter(r => {
                const name = (r.customerName || r.customer || '').toString().toLowerCase();
                return name.includes(term);
            });
            if (typeof renderRecords === 'function') renderRecords(filtered);
            if (typeof updateRecordCount === 'function') updateRecordCount(filtered.length);
        }
        
        // Función para remover price range en nuevos registros
        function removeNewRecordPriceRange(rangeElementId) {
            console.log('🗑️ NEW RECORD DELETE - Attempting to remove:', rangeElementId);
            
            const rangeElement = document.getElementById(rangeElementId);
            console.log('🔍 Range element found:', !!rangeElement);
            
            if (!rangeElement) {
                console.error('❌ Range element not found:', rangeElementId);
                alert('Error: No se pudo encontrar el price range a eliminar');
                return;
            }
            
            const container = rangeElement.parentElement;
            console.log('🔍 Container found:', !!container);
            console.log('📊 Current ranges count:', container ? container.children.length : 'no container');
            
            if (!container) {
                console.error('❌ Container not found');
                alert('Error: No se pudo encontrar el contenedor');
                return;
            }
            
            if (container.children.length <= 1) {
                console.log('⚠️ Cannot remove last price range');
                alert('Al menos un price range es requerido');
                return;
            }
            
            rangeElement.remove();
            console.log('✅ NEW RECORD Price range removed successfully');
        }
        
        // Función para guardar registro editado
        function saveEditedRecord(event, recordId, recordIndex) {
            event.preventDefault();
            
            const partNumber = document.getElementById('partNumber').value.trim();
            const custNumber = document.getElementById('custno').value.trim();
            
            console.log('Saving record with Part:', partNumber, 'Customer:', custNumber);
            console.log('Record index passed:', recordIndex);
            console.log('Current matches:', records.filter(r => 
                r.partNumber === partNumber && r.custno === custNumber
            ));
            
            // Encontrar el registro directamente por index o por búsqueda
            let record;
            
            // Primero intentar por el índice pasado como parámetro
            if (recordIndex >= 0 && recordIndex < records.length) {
                const candidateRecord = records[recordIndex];
                if (candidateRecord.partNumber === partNumber && candidateRecord.custno === custNumber) {
                    record = candidateRecord;
                    console.log('Found record by index:', record);
                }
            }
            
            // Si no se encontró por índice, buscar por coincidencia exacta
            if (!record) {
                record = records.find(r => 
                    r.partNumber === partNumber && r.custno === custNumber
                );
                console.log('Found record by search:', record);
            }
            
            // Si aún no se encuentra, buscar el primer match disponible en records
            if (!record) {
                record = records.find(r => 
                    r.partNumber.toLowerCase() === partNumber.toLowerCase() && 
                    r.custno.toString() === custNumber.toString()
                );
                console.log('Found record by loose search:', record);
            }
            
            if (!record) {
                console.error('No record found');
                alert('Error: No se pudo encontrar el registro para actualizar');
                return;
            }
            
            // Actualizar campos básicos
            record.customer = document.getElementById(recordId + '_customer').value.trim();
            record.partDescription = document.getElementById(recordId + '_partdesc').value.trim();
            record.notes = document.getElementById(recordId + '_notes').value.trim();
            record.date = document.getElementById(recordId + '_date').value;
            
            // Recopilar price ranges
            const priceRanges = [];
            const container = document.getElementById(recordId + '_priceRangesContainer');
            if (container) {
                const rangeElements = container.children;
                for (let i = 0; i < rangeElements.length; i++) {
                    const rangeDiv = rangeElements[i];
                    const inputs = rangeDiv.querySelectorAll('input[type="number"]');
                    
                    if (inputs.length >= 3) {
                        const fromQty = parseInt(inputs[0].value) || 1;
                        const toQty = parseInt(inputs[1].value) || 999999;
                        const price = parseFloat(inputs[2].value) || 0;
                        priceRanges.push({ fromQty, toQty, price });
                    }
                }
            }
            
            record.priceRanges = priceRanges;
            
            console.log('Record updated successfully:', record);
            
            console.log('Record updated successfully in memory');
            
            // Note: This function now only updates the in-memory records array
            // All persistent storage should be handled through PicLan API
            
            // Actualizar grid
            renderRecords();
            
            // Mostrar mensaje de éxito
            showSuccessNotification('¡Registro actualizado exitosamente!', 'Los cambios han sido actualizados en memoria. Use PicLan API para persistir cambios.');
            
            console.log('Update completed - changes updated in memory only');
        }
        
        // Función para iniciar nueva búsqueda
        function startNewCaptureSearch() {
            console.log('Starting new capture search');
            
            // Limpiar campos
            document.getElementById('partNumber').value = '';
            document.getElementById('custno').value = '';
            
            // Limpiar área de resultados
            const resultsArea = document.getElementById('captureResultsArea');
            resultsArea.innerHTML = '';
            resultsArea.style.display = 'none';
            
            // Enfocar en el primer campo
            document.getElementById('partNumber').focus();
            
            console.log('New search started');
        }
        
        // Función para limpiar formulario
        function clearCaptureForm() {
            console.log('clearCaptureForm called');
            
            // Limpiar campos
            document.getElementById('partNumber').value = '';
            document.getElementById('custno').value = '';
            
            // Limpiar área de resultados
            const resultsArea = document.getElementById('captureResultsArea');
            resultsArea.innerHTML = '';
            resultsArea.style.display = 'none';
            
            console.log('Form cleared');
        }

        // Función temporal para probar el guardado de price ranges
        async function testPriceRangesSave() {
            console.log('🧪 [TEST] Iniciando prueba de guardado de price ranges...');
            
            // Datos de prueba
            const testData = {
                ID: '14',
                PART_NUMBER: 'AC-001',
                PRICE_RANGES: '1,10,150.50|11,50,140.25|51,100,130.00'
            };
            
            console.log('🧪 [TEST] Datos de prueba:', testData);
            
            try {
                const testUrl = `test_price_save.xml?ID=${encodeURIComponent(testData.ID)}&PART_NUMBER=${encodeURIComponent(testData.PART_NUMBER)}&PRICE_RANGES=${encodeURIComponent(testData.PRICE_RANGES)}`;
                
                console.log('🧪 [TEST] URL de prueba:', testUrl);
                
                const response = await fetch(testUrl);
                const xmlText = await response.text();
                
                console.log('🧪 [TEST] Respuesta del servidor:', xmlText);
                
                // Extraer mensajes de debug
                if (xmlText.includes('<debug>')) {
                    const debugMatches = xmlText.match(/<debug>(.*?)<\/debug>/g);
                    if (debugMatches) {
                        console.log('🧪 [TEST] Mensajes de debug del servidor:');
                        debugMatches.forEach((match, index) => {
                            const debugContent = match.replace(/<\/?debug>/g, '');
                            console.log(`   ${index + 1}. ${debugContent}`);
                        });
                    }
                }
                
                // Verificar resultado
                if (xmlText.includes('<status>success</status>')) {
                    console.log('✅ [TEST] Prueba exitosa!');
                    showNotification('✅ Test successful! Check console for details.', 'success');
                } else {
                    console.log('❌ [TEST] Prueba falló');
                    showNotification('❌ Test failed! Check console for details.', 'error');
                }
                
            } catch (error) {
                console.error('❌ [TEST] Error en la prueba:', error);
                showNotification('❌ Test error! Check console for details.', 'error');
            }
        }
        
        // Price Range Management Functions
        function addPriceRange() {
            const priceRangesContainer = document.getElementById('priceRanges');
            const newRangeRow = document.createElement('div');
            newRangeRow.className = 'price-range-row';
            newRangeRow.innerHTML = `
                <div class="form-grid price-range-grid">
                    <div class="form-group">
                        <label>From Qty *</label>
                        <input type="number" class="fromQty" min="1" required placeholder="1">
                    </div>
                    <div class="form-group">
                        <label>To Qty *</label>
                        <input type="number" class="toQty" min="1" required placeholder="1000">
                    </div>
                    <div class="form-group">
                        <label>Price *</label>
                        <input type="number" class="price" step="0.01" min="0" required placeholder="5.00">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removePriceRange(this)" style="margin-top: 0;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            priceRangesContainer.appendChild(newRangeRow);
        }

        function removePriceRange(button) {
            const priceRangesContainer = document.getElementById('priceRanges');
            const rangeRow = button.closest('.price-range-row');
            
            // Don't allow removing the last price range
            if (priceRangesContainer.children.length > 1) {
                rangeRow.remove();
            } else {
                showErrorNotification('Cannot Remove', 'At least one price range is required.');
            }
        }

        // Function to remove price range from API record edit form
        function removeAPIRecordPriceRange(recordId, index) {
            const rangeElement = document.getElementById(`${recordId}_range_${index}`);
            const container = document.getElementById(`${recordId}_priceRangesContainer`);
            
            if (!rangeElement || !container) {
                console.error('Price range elements not found:', { rangeElement: !!rangeElement, container: !!container });
                showNotification('❌ Error: Could not find price range to remove', 'error');
                return;
            }
            
            // Don't allow removing if it's the only range
            const remainingRanges = container.querySelectorAll('[id*="_range_"]');
            if (remainingRanges.length <= 1) {
                showNotification('⚠️ At least one price range is required', 'warning');
                return;
            }
            
            // Remove the range element
            rangeElement.remove();
            showNotification('✅ Price range removed', 'success');
            
            // Re-index remaining ranges to maintain proper numbering
            const allRanges = container.querySelectorAll('[id*="_range_"]');
            allRanges.forEach((range, newIndex) => {
                const oldIndex = range.id.split('_range_')[1];
                if (oldIndex != newIndex) {
                    // Update the range container ID
                    range.id = `${recordId}_range_${newIndex}`;
                    
                    // Update input field IDs and their corresponding elements
                    const fromQtyInput = range.querySelector(`#${recordId}_fromQty_${oldIndex}`);
                    const toQtyInput = range.querySelector(`#${recordId}_toQty_${oldIndex}`);
                    const priceInput = range.querySelector(`#${recordId}_price_${oldIndex}`);
                    const removeButton = range.querySelector('button[onclick*="removeAPIRecordPriceRange"]');
                    
                    if (fromQtyInput) fromQtyInput.id = `${recordId}_fromQty_${newIndex}`;
                    if (toQtyInput) toQtyInput.id = `${recordId}_toQty_${newIndex}`;
                    if (priceInput) priceInput.id = `${recordId}_price_${newIndex}`;
                    if (removeButton) removeButton.setAttribute('onclick', `removeAPIRecordPriceRange('${recordId}', ${newIndex})`);
                }
            });
        }

        // Edit Price Range Management Functions - CORREGIDAS
        function addEditPriceRange() {
            const editPriceRangesContainer = document.getElementById('editPriceRanges');
            const newRangeRow = document.createElement('div');
            newRangeRow.className = 'price-range-row';
            newRangeRow.innerHTML = `
                <div class="form-grid price-range-grid">
                    <div class="form-group">
                        <label>From Qty *</label>
                        <input type="number" class="editFromQty" min="1" required placeholder="1">
                    </div>
                    <div class="form-group">
                        <label>To Qty *</label>
                        <input type="number" class="editToQty" min="1" required placeholder="1000">
                    </div>
                    <div class="form-group">
                        <label>Price *</label>
                        <input type="number" class="editPrice" step="0.01" min="0" required placeholder="5.00">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeEditPriceRangeManage(this)" style="margin-top: 0;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            editPriceRangesContainer.appendChild(newRangeRow);
        }

        function removeEditPriceRangeManage(button) {
            console.log('🗑️ MANAGE TAB - Remove price range');
            const editPriceRangesContainer = document.getElementById('editPriceRanges');
            const rangeRow = button.closest('.price-range-row');
            
            if (!rangeRow) {
                console.error('❌ Could not find range row');
                return;
            }
            
            // Don't allow removing the last price range
            if (editPriceRangesContainer.children.length > 1) {
                rangeRow.remove();
                console.log('✅ Manage tab price range removed');
            } else {
                showErrorNotification('Cannot Remove', 'At least one price range is required.');
            }
        }

        function getEditPriceRanges() {
            const editPriceRangeRows = document.querySelectorAll('#editPriceRanges .price-range-row');
            const priceRanges = [];
            
            editPriceRangeRows.forEach(row => {
                const fromQty = parseFloat(row.querySelector('.editFromQty').value);
                const toQty = parseFloat(row.querySelector('.editToQty').value);
                const price = parseFloat(row.querySelector('.editPrice').value);
                
                if (fromQty && toQty && price >= 0) {
                    priceRanges.push({ fromQty, toQty, price });
                }
            });
            
            return priceRanges;
        }

        function populateEditPriceRanges(priceRanges) {
            const editPriceRangesContainer = document.getElementById('editPriceRanges');
            editPriceRangesContainer.innerHTML = '';
            
            priceRanges.forEach(range => {
                const rangeRow = document.createElement('div');
                rangeRow.className = 'price-range-row';
                rangeRow.innerHTML = `
                    <div class="form-grid price-range-grid">
                        <div class="form-group">
                            <label>From Qty *</label>
                            <input type="number" class="editFromQty" min="1" required value="${range.fromQty}">
                        </div>
                        <div class="form-group">
                            <label>To Qty *</label>
                            <input type="number" class="editToQty" min="1" required value="${range.toQty}">
                        </div>
                        <div class="form-group">
                            <label>Price *</label>
                            <input type="number" class="editPrice" step="0.001" min="0" required value="${range.price}">
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeEditPriceRangeManage(this)" style="margin-top: 0;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                editPriceRangesContainer.appendChild(rangeRow);
            });
        }

        function getPriceRanges() {
            const priceRangeRows = document.querySelectorAll('.price-range-row');
            const priceRanges = [];
            
            priceRangeRows.forEach(row => {
                const fromQty = parseFloat(row.querySelector('.fromQty').value);
                const toQty = parseFloat(row.querySelector('.toQty').value);
                const price = parseFloat(row.querySelector('.price').value);
                
                if (fromQty && toQty && price >= 0) {
                    priceRanges.push({ fromQty, toQty, price });
                }
            });
            
            return priceRanges;
        }

        function validatePriceRanges(priceRanges) {
            if (priceRanges.length === 0) {
                return 'At least one price range is required.';
            }
            
            for (let i = 0; i < priceRanges.length; i++) {
                const range = priceRanges[i];
                if (range.fromQty > range.toQty) {
                    return `Price range ${i + 1}: From Qty cannot be greater than To Qty.`;
                }
            }
            
            // Check for overlapping ranges
            for (let i = 0; i < priceRanges.length; i++) {
                for (let j = i + 1; j < priceRanges.length; j++) {
                    const range1 = priceRanges[i];
                    const range2 = priceRanges[j];
                    
                    if ((range1.fromQty <= range2.toQty && range1.toQty >= range2.fromQty)) {
                        return `Price ranges ${i + 1} and ${j + 1} overlap. Please adjust the quantities.`;
                    }
                }
            }
            
            return null;
        }

        function addRecord(event) {
            event.preventDefault();
            
            const customer = document.getElementById('customer').value.trim();
            const partNumber = document.getElementById('partNumber').value.trim();
            const partDescription = document.getElementById('partDescription').value.trim();
            const custno = document.getElementById('custno').value.trim();
            const date = document.getElementById('date').value;
            
            const priceRanges = getPriceRanges();
            
            if (!validatePriceRanges(priceRanges)) {
                return;
            }
            
            const newRecord = {
                customer,
                partNumber,
                partDescription,
                custno,
                date,
                priceRanges,
                notes: document.getElementById('notes').value.trim()
            };
            
            records.push(newRecord);
            
            // Deduplicate global records to prevent duplicates
            const _uniqueAfterAdd = dedupeRecords(records);
            records.length = 0;
            records.push(..._uniqueAfterAdd);
            renderRecords();
            clearForm();
            
            showSuccessNotification('Record Added!', `Successfully added ${partNumber} (${partDescription}) for ${customer}`);
        }

        function clearForm() {
            document.getElementById('dataForm').reset();
            
            // Reset price ranges to just one empty range
            const priceRangesContainer = document.getElementById('priceRanges');
            priceRangesContainer.innerHTML = `
                <div class="price-range-row">
                    <div class="form-grid price-range-grid">
                        <div class="form-group">
                            <label>From Qty *</label>
                            <input type="number" class="fromQty" min="1" required placeholder="1">
                        </div>
                        <div class="form-group">
                            <label>To Qty *</label>
                            <input type="number" class="toQty" min="1" required placeholder="1000">
                        </div>
                        <div class="form-group">
                            <label>Price *</label>
                            <input type="number" class="price" step="0.01" min="0" required placeholder="5.00">
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removePriceRange(this)" style="margin-top: 0;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Cascading Search Functions - Works with records array
        function searchCustomerCascade() {
            const searchValue = document.getElementById('searchCustomer').value.toLowerCase().trim();
            const customerResults = document.getElementById('customerResults');
            const customerInfo = document.getElementById('customerInfo');
            
            if (searchValue === '') {
                customerResults.style.display = 'none';
                // Clear other search fields and show all records
                document.getElementById('searchPartNumber').value = '';
                document.getElementById('searchCustomerNumber').value = '';
                document.getElementById('partDetailsForm').style.display = 'none';
                renderRecords(records);
                updateRecordCount(records.length);
                return;
            }
            
            // Search in current records array
            const filteredRecords = records.filter(record => {
                const customerName = (record.customerName || record.customer || '').toLowerCase();
                const customerNumber = (record.customerNumber || record.custno || '').toString().toLowerCase();
                return customerName.includes(searchValue) || customerNumber.includes(searchValue);
            });
            
            renderRecords(filteredRecords);
            updateRecordCount(filteredRecords.length);
            customerResults.style.display = 'none';
        }
        
        function searchByCustomerNumber() {
            const custNumber = document.getElementById('searchCustomerNumber').value.trim();
            if (custNumber === '') {
                document.getElementById('partDetailsForm').style.display = 'none';
                // Clear other search fields and show all records
                document.getElementById('searchPartNumber').value = '';
                document.getElementById('searchCustomer').value = '';
                document.getElementById('customerResults').style.display = 'none';
                renderRecords(records);
                updateRecordCount(records.length);
                return;
            }
            
            // Search in current records array
            const filteredRecords = records.filter(record => {
                const customerNumber = (record.customerNumber || record.custno || '').toString();
                return customerNumber === custNumber;
            });
            
            renderRecords(filteredRecords);
            updateRecordCount(filteredRecords.length);
            document.getElementById('partDetailsForm').style.display = 'none';
        }
        
        function handleCustomerNumberEnter(event) {
            if (event.key === 'Enter') {
                // Check if we're in the Data Capture tab
                const activeTab = document.querySelector('.tab-pane.active');
                if (activeTab && activeTab.id === 'capture-tab') {
                    const custNumber = document.getElementById('custno').value.trim();
                    if (custNumber === '') return;
                    
                    // Check if part number is also filled
                    const partNumber = document.getElementById('partNumber').value.trim();
                    if (partNumber === '') {
                        showInfoMessage('Please enter Part Number first to continue.');
                        document.getElementById('partNumber').focus();
                        return;
                    }
                    
                    // Both fields are filled, check for combined record
                    console.log('Both fields filled in customer enter - Part:', partNumber, 'Customer:', custNumber);
                    simpleCaptureSearch();
                } else {
                    // Original functionality for Search & View tab
                    const custNumber = document.getElementById('searchCustomerNumber').value.trim();
                    if (custNumber === '') return;
                    
                    // Find records with this customer number
                    const matchingRecords = records.filter(record => 
                        record.custno && record.custno.toString() === custNumber
                    );
                    
                    if (matchingRecords.length > 0) {
                        displayPartDetails(matchingRecords, custNumber, true);
                    } else {
                        displayNewItemForm(custNumber);
                    }
                }
            }
        }
        
        function displayPartDetails(matchingRecords, custNumber, isEditable) {
            const partDetailsForm = document.getElementById('partDetailsForm');
            const partDetailsContent = document.getElementById('partDetailsContent');
            
            let html = '';
            
            matchingRecords.forEach((record, index) => {
                const priceRangesHtml = record.priceRanges.map(range => 
                    `<div style="margin: 5px 0; padding: 8px; background: #e2e8f0; border-radius: 4px; font-size: 0.9em;">
                        Qty ${range.fromQty}-${range.toQty}: ${formatPrice(range.price)}
                    </div>`
                ).join('');
                // Stable composite key for scoping inputs/events to THIS record only
                const rid = `${(record.partNumber || '').toString().trim().toUpperCase()}_${(record.customerNumber || record.custno || '').toString().trim()}`;
                
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #d1d5db;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 5px;">Part Number:</label>
                                <span style="color: #1e293b; font-weight: 500;">${record.partNumber}</span>
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 5px;">Customer Name:</label>
                                ${isEditable ? 
                                    `<input type="text" id="${rid}_customer" value="${record.customerName || record.customer || ''}" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">` :
                                    `<span style="color: #1e293b; font-weight: 500;">${record.customer || ''}</span>`
                                }
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 8px;">Price Ranges:</label>
                            ${isEditable ? 
                                `<div id="${rid}_priceRangesContainer">${createEditablePriceRangesForRecord(rid, record.priceRanges || [])}</div>` :
                                priceRangesHtml
                            }
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 5px;">Notes:</label>
                            ${isEditable ? 
                                `<textarea id="${rid}_notes" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; min-height: 60px;">${record.notes || ''}</textarea>` :
                                `<span style="color: #64748b;">${record.notes || ''}</span>`
                            }
                        </div>
                        
                        ${isEditable ? `
                            <div style="text-align: right; margin-top: 15px;">
                                <button onclick="savePicLanFromCaptureForm('${rid}', ${JSON.stringify(record).replace(/"/g, '&quot;')})" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 8px;">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                                <button onclick="cancelPartEdit()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            partDetailsContent.innerHTML = html;
            partDetailsForm.style.display = 'block';
        }
        
        function displayNewItemForm(custNumber) {
            const partDetailsForm = document.getElementById('partDetailsForm');
            const partDetailsContent = document.getElementById('partDetailsContent');
            
            const html = `
                <div style="padding: 20px; background: #dbeafe; border: 2px solid #3b82f6; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                    <i class="fas fa-exclamation-triangle" style="color: #3b82f6; font-size: 1.5em; margin-bottom: 10px;"></i>
                    <h4 style="color: #1e40af; margin-bottom: 8px;">New Item</h4>
                    <p style="color: #1e40af; margin: 0;">Customer Number "${custNumber}" does not exist in the system.</p>
                    <p style="color: #1e40af; margin: 8px 0 0 0; font-size: 0.9em;">You can add a new record in the "Data Capture" tab.</p>
                </div>
                <div style="text-align: center;">
                    <button onclick="switchTab('capture'); document.getElementById('custno').value='${custNumber}';" style="background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 1em;">
                        <i class="fas fa-plus"></i> Add New Record
                    </button>
                </div>
            `;
            
            partDetailsContent.innerHTML = html;
            partDetailsForm.style.display = 'block';
        }
        
        function createEditablePriceRangesForRecord(recordId, priceRanges) {
            return (priceRanges || []).map((range, rangeIndex) => `
                <div id="${recordId}_range_${rangeIndex}" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px; align-items: end;">
                    <div>
                        <label style="font-size: 0.8em; color: #6b7280;">From Qty</label>
                        <input type="number" id="${recordId}_fromQty_${rangeIndex}" value="${range.fromQty}" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                    </div>
                    <div>
                        <label style="font-size: 0.8em; color: #6b7280;">To Qty</label>
                        <input type="number" id="${recordId}_toQty_${rangeIndex}" value="${range.toQty}" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                    </div>
                    <div>
                        <label style="font-size: 0.8em; color: #6b7280;">Price</label>
                        <input type="number" step="0.001" id="${recordId}_price_${rangeIndex}" value="${range.price}" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                    </div>
                    <button onclick="removeAPIRecordPriceRange('${recordId}', ${rangeIndex})" style="background: #ef4444; color: white; border: none; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }
        
        // removed legacy savePartDetails() (replaced by savePicLanFromCaptureForm)
        
        function cancelPartEdit() {
            document.getElementById('partDetailsForm').style.display = 'none';
        }
        
        // Part Number Search Functions - Works with records array
        function searchByPartNumber() {
            const partNumber = document.getElementById('searchPartNumber').value.trim();
            if (partNumber === '') {
                document.getElementById('partDetailsForm').style.display = 'none';
                // Clear other search fields and show all records
                document.getElementById('searchCustomerNumber').value = '';
                document.getElementById('searchCustomer').value = '';
                document.getElementById('customerResults').style.display = 'none';
                renderRecords(records);
                updateRecordCount(records.length);
                return;
            }
            
            // Search in current records array
            const filteredRecords = records.filter(record => {
                const recordPartNumber = (record.partNumber || '').toString().toLowerCase();
                return recordPartNumber.includes(partNumber.toLowerCase());
            });
            
            renderRecords(filteredRecords);
            updateRecordCount(filteredRecords.length);
            document.getElementById('partDetailsForm').style.display = 'none';
        }
        
        function handlePartNumberEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                // Check if we're in the Data Capture tab
                const activeTab = document.querySelector('.tab-pane.active');
                if (activeTab && activeTab.id === 'capture-tab') {
                    const partNumber = document.getElementById('partNumber').value.trim();
                    if (partNumber === '') return;
                    
                    // Move focus to customer number field if it's empty
                    const custNumber = document.getElementById('custno').value.trim();
                    if (custNumber === '') {
                        document.getElementById('custno').focus();
                        showInfoMessage('Please enter Customer Number to continue.');
                        return;
                    }
                    
                    // Both fields are filled, check for combined record
                    console.log('Both fields filled - Part:', partNumber, 'Customer:', custNumber);
                    simpleCaptureSearch();
                } else {
                    // Original functionality for Search & View tab
                    const partNumber = document.getElementById('searchPartNumber').value.trim();
                    if (partNumber === '') return;
                    
                    // Find exact match for part number
                    const exactMatch = records.filter(record => 
                        record.partNumber.toLowerCase() === partNumber.toLowerCase()
                    );
                    
                    if (exactMatch.length > 0) {
                        displayPartDetailsByPartNumber(exactMatch, partNumber, true);
                    } else {
                        // Check for partial matches
                        const partialMatches = records.filter(record => 
                            record.partNumber.toLowerCase().includes(partNumber.toLowerCase())
                        );
                        
                        if (partialMatches.length > 0) {
                            displayPartDetailsByPartNumber(partialMatches, partNumber, true);
                        } else {
                            displayNewPartForm(partNumber);
                        }
                    }
                }
            }
        }
        
        function displayPartDetailsByPartNumber(matchingRecords, partNumber, isEditable) {
            const partDetailsForm = document.getElementById('partDetailsForm');
            const partDetailsContent = document.getElementById('partDetailsContent');
            
            let html = '';
            
            matchingRecords.forEach((record, index) => {
                const priceRangesHtml = record.priceRanges.map(range => 
                    `<div style=\"margin: 5px 0; padding: 8px; background: #e2e8f0; border-radius: 4px; font-size: 0.9em;\">\n                        Qty ${range.fromQty}-${range.toQty}: ${formatPrice(range.price)}\n                    </div>`
                ).join('');
                const rid = `${(record.partNumber || '').toString().trim().toUpperCase()}_${(record.customerNumber || record.custno || '').toString().trim()}`;
                
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #d1d5db;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 5px;">Part Number:</label>
                                <span style="color: #1e293b; font-weight: 500;">${record.partNumber}</span>
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 5px;">Part Description:</label>
                                ${isEditable ? 
                                    `<input type=\"text\" id=\"${rid}_partdesc\" value=\"${record.partDescription || ''}\" style=\"width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;\">` :
                                    `<span style=\"color: #1e293b; font-weight: 500;\">${record.partDescription || 'N/A'}</span>`
                                }
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 5px;">Customer Name:</label>
                                ${isEditable ? 
                                    `<input type=\"text\" id=\"${rid}_customer\" value=\"${record.customerName || record.customer || ''}\" style=\"width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;\">` :
                                    `<span style=\"color: #1e293b; font-weight: 500;\">${record.customer || ''}</span>`
                                }
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 5px;">Customer Number:</label>
                                <span style="color: #1e293b; font-weight: 500;">${record.custno || record.customerNumber || 'N/A'}</span>
                            </div>
                        </div>
                        
                        <div style="background: #fff7ed; border: 1px solid #f59e0b; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="font-weight: 600; color: #92400e;">Price Ranges</label>
                                ${isEditable ? `<button type=\"button\" onclick=\"addNewPriceRange('${rid}')\" style=\"background: #f59e0b; color: white; padding: 6px 12px; border: none; border-radius: 4px; font-size: 0.9em; cursor: pointer;\"><i class=\"fas fa-plus\"></i> Add Range</button>` : ''}
                            </div>
                            ${isEditable ? 
                                `<div id=\"${rid}_priceRangesContainer\">${createEditablePriceRangesForRecord(rid, record.priceRanges || [])}</div>` :
                                priceRangesHtml
                            }
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 5px;">Notes:</label>
                                ${isEditable ? 
                                    `<textarea id=\"${rid}_notes\" style=\"width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; min-height: 60px;\">${record.notes || ''}</textarea>` :
                                    `<span style=\"color: #64748b;\">${record.notes || ''}</span>`
                                }
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 5px;">Date:</label>
                                ${isEditable ? 
                                    `<input type=\"date\" id=\"${rid}_date\" value=\"${record.date || new Date().toISOString().split('T')[0]}\" style=\"width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;\">` :
                                    `<span style=\"color: #1e293b; font-weight: 500;\">${record.date || ''}</span>`
                                }
                            </div>
                        </div>
                        
                        ${isEditable ? `
                            <div style="text-align: right; margin-top: 15px;">
                                <button onclick="savePicLanFromCaptureForm('${rid}', ${JSON.stringify(record).replace(/"/g, '&quot;')})" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 8px;">
                                    <i class=\"fas fa-save\"></i> Save Changes
                                </button>
                                <button onclick="cancelPartEdit()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                    <i class=\"fas fa-times\"></i> Cancel
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            partDetailsContent.innerHTML = html;
            partDetailsForm.style.display = 'block';
        }
        
        function displayNewPartForm(partNumber) {
            const partDetailsForm = document.getElementById('partDetailsForm');
            const partDetailsContent = document.getElementById('partDetailsContent');
            
            const html = `
                <div style="padding: 20px; background: #dbeafe; border: 2px solid #3b82f6; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                    <i class="fas fa-exclamation-triangle" style="color: #3b82f6; font-size: 1.5em; margin-bottom: 10px;"></i>
                    <h4 style="color: #1e40af; margin-bottom: 8px;">New Part</h4>
                    <p style="color: #1e40af; margin: 0;">Part Number "${partNumber}" does not exist in the system.</p>
                    <p style="color: #1e40af; margin: 8px 0 0 0; font-size: 0.9em;">You can add a new record in the "Data Capture" tab.</p>
                </div>
                <div style="text-align: center;">
                    <button onclick="switchTab('capture'); document.getElementById('partNumber').value='${partNumber}';" style="background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 1em;">
                        <i class="fas fa-plus"></i> Add New Part
                    </button>
                </div>
            `;
            
            partDetailsContent.innerHTML = html;
            partDetailsForm.style.display = 'block';
        }
        
        // removed legacy createEditablePartPriceRanges()
        
        // removed legacy savePartDetailsByPartNumber() (replaced by savePicLanFromCaptureForm)
        
        function filterRecords() {
            // Get filter values (match the actual input IDs in the header)
            const partFilter = (document.getElementById('filterPart')?.value || '').toLowerCase();
            const descFilter = (document.getElementById('filterPartDescription')?.value || '').toLowerCase();
            const custNumFilter = (document.getElementById('filterCustno')?.value || '').toLowerCase();
            const custNameFilter = (document.getElementById('filterCustomer')?.value || '').toLowerCase();
            const priceFilter = (document.getElementById('filterPriceRanges')?.value || '').toLowerCase();
            const dateFilter = (document.getElementById('filterDate')?.value || '');
            const notesFilter = (document.getElementById('filterNotes')?.value || '').toLowerCase();
            
            // Filter records based on all criteria
            const filteredRecords = records.filter(record => {
                const partNumber = (record.partNumber || '').toLowerCase();
                const partDesc = (record.partDescription || '').toLowerCase();
                const custNum = (record.customerNumber || record.custno || '').toString().toLowerCase();
                const custName = (record.customerName || record.customer || '').toLowerCase();
                const notes = (record.notes || '').toLowerCase();
                const date = record.date || '';
                
                // Price range filter (check if any price range matches)
                let priceMatch = true;
                if (priceFilter) {
                    priceMatch = record.priceRanges && record.priceRanges.some(range => 
                        range.price.toString().includes(priceFilter)
                    );
                }
                
                return partNumber.includes(partFilter) &&
                       partDesc.includes(descFilter) &&
                       custNum.includes(custNumFilter) &&
                       custName.includes(custNameFilter) &&
                       notes.includes(notesFilter) &&
                       date.includes(dateFilter) &&
                       priceMatch;
            });
            
            renderRecords(filteredRecords);
            updateRecordCount(filteredRecords.length);
        }

        function exportToCSV() {
            if (records.length === 0) {
                showErrorNotification('No Data', 'No records available to export. Please load data first using "Cargar desde PicLan" button.');
                return;
            }
            
            // Create CSV header
            const headers = ['Part Number', 'Part Description', 'Customer Number', 'Customer Name', 'Price Ranges', 'Date', 'Notes'];
            let csvContent = headers.join(',') + '\n';
            
            // Add data rows
            records.forEach(record => {
                const priceRangesStr = record.priceRanges ? 
                    record.priceRanges.map(range => `${range.fromQty}-${range.toQty}:$${parseFloat(range.price).toFixed(3)}`).join(';') : '';
                
                const row = [
                    `"${record.partNumber || ''}"`,,
                    `"${record.partDescription || ''}"`,,
                    `"${record.customerNumber || record.custno || ''}"`,,
                    `"${record.customerName || record.customer || ''}"`,,
                    `"${priceRangesStr}"`,,
                    `"${record.date || ''}"`,,
                    `"${record.notes || ''}"`
                ];
                csvContent += row.join(',') + '\n';
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `taimex_records_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccessNotification('Export Complete', `Exported ${records.length} records to CSV file.`);
        }

        function clearFilters() {
            // Clear search inputs
            const searchCustomer = document.getElementById('searchCustomer');
            const searchPart = document.getElementById('searchPart');
            if (searchCustomer) searchCustomer.value = '';
            if (searchPart) searchPart.value = '';
            
            // Clear filter inputs
            const filterCustomer = document.getElementById('filterCustomer');
            const filterPart = document.getElementById('filterPart');
            const filterCustno = document.getElementById('filterCustno');
            const filterPriceRanges = document.getElementById('filterPriceRanges');
            const filterDate = document.getElementById('filterDate');
            const filterNotes = document.getElementById('filterNotes');
            const filterDateAdded = document.getElementById('filterDateAdded');
            
            if (filterCustomer) filterCustomer.value = '';
            if (filterPart) filterPart.value = '';
            if (filterCustno) filterCustno.value = '';
            if (filterPriceRanges) filterPriceRanges.value = '';
            if (filterDate) filterDate.value = '';
            if (filterNotes) filterNotes.value = '';
            if (filterDateAdded) filterDateAdded.value = '';
            
            // Show all records
            renderRecords();
            updateRecordCount(records.length);
        }

        function clearAllSearches() {
            // Clear all search inputs in the search tab
            const searchCustomer = document.getElementById('searchCustomer');
            const searchPartNumber = document.getElementById('searchPartNumber');
            const searchCustomerNumber = document.getElementById('searchCustomerNumber');
            
            if (searchCustomer) searchCustomer.value = '';
            if (searchPartNumber) searchPartNumber.value = '';
            if (searchCustomerNumber) searchCustomerNumber.value = '';
            
            // Hide result displays
            const customerResults = document.getElementById('customerResults');
            const partDetailsForm = document.getElementById('partDetailsForm');
            
            if (customerResults) customerResults.style.display = 'none';
            if (partDetailsForm) partDetailsForm.style.display = 'none';
            
            // Show all records
            renderRecords(records);
            
            showSuccessNotification('Search Cleared', 'All searches have been reset and showing all records');
        }



        function updateRecordCount(filteredCount = null) {
            // Mostrar conteo basado en el parámetro provisto (ya deduplicado)
            const count = filteredCount !== null ? filteredCount : 0;
            const recordsCountSpan = document.getElementById('recordsCount');
            if (recordsCountSpan) {
                if (count === 0) {
                    recordsCountSpan.textContent = 'Sin registros - usa PicLan API';
                } else {
                    recordsCountSpan.textContent = `${count} registros mostrados`;
                }
            }
        }


        function renderRecords(recordsToRender = null) {
    // Si no se especifican registros, usar el array global
    if (!recordsToRender) {
        recordsToRender = records;
    }
    
    // Seguridad adicional: eliminar duplicados antes de mostrar
    const uniqueToRender = dedupeRecords(recordsToRender);
    recordsToRender = uniqueToRender;

    // Enriquecer: mapear nombres por cliente y descripciones por parte para rellenar faltantes
    const nameByCustomer = new Map();
    const descByPart = new Map();
    recordsToRender.forEach(r => {
        const custNum = (r.customerNumber || r.custno || '').toString().trim();
        const custName = (r.customerName || r.customer || '').toString().trim();
        const pNum = (r.partNumber || '').toString().trim();
        const pDesc = (r.partDescription || r.DESCRIPTION || '').toString().trim();
        if (custNum && custName && !nameByCustomer.has(custNum)) nameByCustomer.set(custNum, custName);
        if (pNum && pDesc && !descByPart.has(pNum)) descByPart.set(pNum, pDesc);
    });
    
    const tbody = document.getElementById('recordsTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    recordsToRender.forEach((record, index) => {
        const row = document.createElement('tr');
        row.className = 'excel-row';
        
        // NORMALIZAR y ENRIQUECER los campos
        const partNumber = record.partNumber || '';
        let partDescription = record.partDescription || record.DESCRIPTION || '';
        const customerNumber = record.customerNumber || record.custno || '';
        let customerName = record.customerName || record.customer || '';

        // Completar faltantes usando mapas precalculados
        if (!customerName && customerNumber) {
            const inferredName = nameByCustomer.get(customerNumber);
            if (inferredName) customerName = inferredName;
        }
        if (!partDescription && partNumber) {
            const inferredDesc = descByPart.get(partNumber);
            if (inferredDesc) partDescription = inferredDesc;
        }

        if ((!customerName || !partDescription) && partNumber && customerNumber) {
            console.warn('⚠️ Registro con campos faltantes tras enriquecer:', { partNumber, customerNumber, customerName, partDescription });
        }
        const date = record.date || '';
        const notes = record.notes || '';
        
        // Format price ranges for display (vertical + right-aligned)
        let priceRangesDisplay = '';
        if (record.priceRanges && record.priceRanges.length > 0) {
            const badges = record.priceRanges.map(range =>
                `<span class="range-badge">${range.fromQty}-${range.toQty}: $${parseFloat(range.price).toFixed(3)}</span>`
            ).join('');
            priceRangesDisplay = `<div class="price-ranges-vertical">${badges}</div>`;
        } else {
            priceRangesDisplay = `<div class="price-ranges-vertical"><span style="color:#9ca3af;font-style:italic;white-space:nowrap;">Sin rangos</span></div>`;
        }
        
        // Usar índice GLOBAL para operaciones (evita errores tras dedupe/filtrado)
        const globalIndex = records.indexOf(record);
        
        row.innerHTML = `
            <td class="excel-cell">
                <div class="cell-content">${partNumber}</div>
            </td>
            <td class="excel-cell readonly" title="Solo lectura">
                <div class="cell-content">${partDescription}</div>
            </td>
            <td class="excel-cell">
                <div class="cell-content">${customerNumber}</div>
            </td>
            <td class="excel-cell readonly" title="Solo lectura">
                <div class="cell-content">${customerName}</div>
            </td>
            <td class="excel-cell ranges-cell">
                <div class="cell-content">${priceRangesDisplay}</div>
            </td>
            <td class="excel-cell">
                <div class="cell-content">${date}</div>
            </td>
            <td class="excel-cell">
                <div class="cell-content">${notes}</div>
            </td>
            <td class="excel-cell">
                <div class="action-buttons">
                    <button class="btn-sm btn-edit" onclick="editRecord(${globalIndex})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-sm btn-delete" onclick="deleteRecord(${globalIndex})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    updateRecordCount(recordsToRender.length);
}
        function sortTable(field) {
            records.sort((a, b) => {
                let aVal = a[field], bVal = b[field];
                return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
            });
            renderRecords();
        }

        function editRecord(index) {
            console.log('editRecord called with index:', index);
            console.log('records array:', records);
            
            // Check if index is valid
            if (index === -1 || index >= records.length || index < 0) {
                console.error('Invalid index:', index);
                alert('Error: Record not found (invalid index: ' + index + ')');
                return;
            }
            
            const record = records[index];
            console.log('Found record:', record);
            
            if (!record) {
                console.error('Record is null/undefined');
                alert('Error: Record not found');
                return;
            }
            
            // Switch to manage tab first
            switchTab('manage');
            
            // Small delay to ensure tab switch completes
            setTimeout(() => {
                // Fill the form with record data
                const editIndexEl = document.getElementById('editIndex');
                const editCustomerEl = document.getElementById('editCustomer');
                const editPartNumberEl = document.getElementById('editPartNumber');
                const editCustnoEl = document.getElementById('editCustno');
                const editDateEl = document.getElementById('editDate');
                const editNotesEl = document.getElementById('editNotes');
                const editPartDescriptionEl = document.getElementById('editPartDescription');
                const editFormEl = document.getElementById('editForm');
                const noEditMessageEl = document.getElementById('noEditMessage');
                
                console.log('Form elements found:', {
                    editIndex: !!editIndexEl,
                    editCustomer: !!editCustomerEl,
                    editPartNumber: !!editPartNumberEl,
                    editCustno: !!editCustnoEl,
                    editDate: !!editDateEl,
                    editNotes: !!editNotesEl,
                    editPartDescription: !!editPartDescriptionEl,
                    editForm: !!editFormEl,
                    noEditMessage: !!noEditMessageEl
                });
                
                if (editIndexEl) editIndexEl.value = index;
                if (editCustomerEl) editCustomerEl.value = record.customerName || record.customer || '';
                if (editPartNumberEl) editPartNumberEl.value = record.partNumber || record.PART_NUMBER || '';
                if (editCustnoEl) editCustnoEl.value = record.custno || record.customerNumber || '';
                if (editDateEl) editDateEl.value = record.date || '';
                if (editNotesEl) editNotesEl.value = record.notes || '';
                if (editPartDescriptionEl) editPartDescriptionEl.value = record.partDescription || '';
                
                // Populate price ranges
                populateEditPriceRanges(record.priceRanges || [{ fromQty: 1, toQty: 1000, price: 0 }]);
                
                // Show the form and hide the message
                if (editFormEl) {
                    editFormEl.style.display = 'block';
                    console.log('Form should now be visible');
                }
                if (noEditMessageEl) {
                    noEditMessageEl.style.display = 'none';
                    console.log('Message should now be hidden');
                }
            }, 100);
        }

        // ===== Price Range Editing Helpers =====
        function createPriceRangeRow(range = {}, index = 0) {
            const container = document.getElementById('editPriceRanges');
            if (!container) return;
            const row = document.createElement('div');
            row.className = 'price-range-row';

            const fromVal = Number.parseInt(range.fromQty ?? '', 10);
            const toVal = Number.parseInt(range.toQty ?? '', 10);
            const priceVal = Number.parseFloat(range.price ?? '');

            const fromInput = document.createElement('input');
            fromInput.type = 'number';
            fromInput.min = '0';
            fromInput.step = '1';
            fromInput.placeholder = 'From Qty';
            fromInput.className = 'fromQty';
            if (!Number.isNaN(fromVal)) fromInput.value = fromVal;

            const toInput = document.createElement('input');
            toInput.type = 'number';
            toInput.min = '0';
            toInput.step = '1';
            toInput.placeholder = 'To Qty';
            toInput.className = 'toQty';
            if (!Number.isNaN(toVal)) toInput.value = toVal;

            const priceInput = document.createElement('input');
            priceInput.type = 'number';
            priceInput.min = '0';
            priceInput.step = '0.001';
            priceInput.placeholder = 'Price';
            priceInput.className = 'price editPrice';
            if (!Number.isNaN(priceVal)) priceInput.value = Number(priceVal).toFixed(3);

            // Apply formatting events to price input
            try { addPriceFormatting(priceInput); } catch (e) { /* no-op */ }

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-range';
            removeBtn.innerHTML = '<i class="fas fa-minus"></i>';
            removeBtn.title = 'Remove range';
            removeBtn.addEventListener('click', () => {
                const rows = container.querySelectorAll('.price-range-row');
                if (rows.length <= 1) {
                    showErrorNotification('No permitido', 'Debe existir al menos un rango.');
                    return;
                }
                row.remove();
            });

            row.appendChild(fromInput);
            row.appendChild(toInput);
            row.appendChild(priceInput);
            row.appendChild(removeBtn);
            container.appendChild(row);
        }

        function populateEditPriceRanges(ranges = []) {
            const container = document.getElementById('editPriceRanges');
            if (!container) return;
            container.innerHTML = '';
            const list = Array.isArray(ranges) && ranges.length > 0 ? ranges : [{ fromQty: 1, toQty: 1, price: 0 }];
            list.forEach((r, i) => createPriceRangeRow(r, i));
            // Ensure formatting is applied
            try { applyPriceFormattingToAll(); } catch (e) { /* no-op */ }
        }

        function addEditPriceRange() {
            const container = document.getElementById('editPriceRanges');
            if (!container) return;
            const rows = container.querySelectorAll('.price-range-row');
            let nextFrom = 1;
            if (rows.length > 0) {
                const lastRow = rows[rows.length - 1];
                const lastTo = parseInt(lastRow.querySelector('.toQty')?.value || '0', 10);
                nextFrom = (Number.isFinite(lastTo) ? lastTo + 1 : 1);
            }
            createPriceRangeRow({ fromQty: nextFrom, toQty: nextFrom, price: 0 }, rows.length);
        }

        function getEditPriceRanges() {
            const container = document.getElementById('editPriceRanges');
            if (!container) return [];
            const result = [];
            container.querySelectorAll('.price-range-row').forEach(row => {
                const from = parseInt(row.querySelector('.fromQty')?.value || '', 10);
                const to = parseInt(row.querySelector('.toQty')?.value || '', 10);
                const price = parseFloat(row.querySelector('.price')?.value || '');
                if (Number.isFinite(from) && Number.isFinite(to) && Number.isFinite(price)) {
                    result.push({ fromQty: from, toQty: to, price: Number(price.toFixed(3)) });
                }
            });
            // Sort by fromQty ascending
            result.sort((a, b) => a.fromQty - b.fromQty);
            return result;
        }

        function validatePriceRanges(ranges = []) {
            if (!Array.isArray(ranges) || ranges.length === 0) return 'Agrega al menos un rango de precio.';
            for (let i = 0; i < ranges.length; i++) {
                const r = ranges[i];
                if (!Number.isFinite(r.fromQty) || !Number.isFinite(r.toQty) || !Number.isFinite(r.price)) {
                    return `Rango #${i+1}: valores inválidos.`;
                }
                if (r.fromQty < 0 || r.toQty < 0) return `Rango #${i+1}: cantidades deben ser >= 0.`;
                if (r.toQty < r.fromQty) return `Rango #${i+1}: 'Hasta' debe ser >= 'Desde'.`;
                if (r.price < 0) return `Rango #${i+1}: precio debe ser >= 0.`;
            }
            // Check overlaps
            const sorted = [...ranges].sort((a, b) => a.fromQty - b.fromQty);
            let prevTo = -1;
            for (let i = 0; i < sorted.length; i++) {
                const r = sorted[i];
                if (i > 0 && r.fromQty <= prevTo) {
                    return `Rangos traslapados entre #${i} y #${i+1}.`;
                }
                prevTo = r.toQty;
            }
            return '';
        }

        function testPriceRangesSave() {
            const ranges = getEditPriceRanges();
            const err = validatePriceRanges(ranges);
            if (err) {
                showErrorNotification('Validación de rangos', err);
                return;
            }
            showSuccessNotification('Rangos válidos', `${ranges.length} rangos con formato de 3 decimales.`);
            console.log('Price ranges (3 dec):', ranges);
        }

        // Helper to persist a record to PicLan update_cust.xml (core implementation)
        async function saveRecordToPicLanCore({ id, partNumber, customerName, partDescription, notes, date, priceRanges }) {
            // DISABLED: External server removed
            console.log('⚠️ saveRecordToPicLanCore DISABLED');
            return;
            const priceRangesStr = Array.isArray(priceRanges) && priceRanges.length > 0
                ? priceRanges.map(r => `${r.fromQty},${r.toQty},${Number(r.price).toFixed(3)}`).join('|')
                : '';

            const params = new URLSearchParams();
            const partNumberUpper = (partNumber || '').toString().toUpperCase();
            params.set('ID', id || '');
            params.set('PART_NUMBER', partNumberUpper);
            if (customerName) params.set('CUSTOMER', customerName);
            if (partDescription) params.set('PART_DESC', partDescription);
            if (typeof notes === 'string') params.set('NOTES', notes);
            if (date) params.set('DATE', date);
            if (priceRangesStr) params.set('PRICE_RANGES', priceRangesStr);

            if (!id || !partNumber) {
                console.warn('⚠️ [DEBUG] saveRecordToPicLan called with empty id/partNumber', { id, partNumber });
                throw new Error('ID y PART_NUMBER son requeridos antes de guardar.');
            }

            // Send important fields in query string for servers that only parse GET vars
            const method = 'POST';
            const qs = new URLSearchParams();
            qs.set('ID', id || '');
            qs.set('PART_NUMBER', partNumberUpper);
            if (typeof notes === 'string') qs.set('NOTES', notes);
            if (date) qs.set('DATE', date);
            if (customerName) qs.set('CUSTOMER', customerName);
            if (partDescription) qs.set('PART_DESC', partDescription);
            if (priceRangesStr) qs.set('PRICE_RANGES', priceRangesStr);
            const url = `${baseUrl}?${qs.toString()}`;
            const body = params.toString();
            console.log('🧪 [DEBUG] Encoded params snapshot:', { ID: params.get('ID'), PART_NUMBER: params.get('PART_NUMBER') });
            console.log('🔗 [DEBUG] PicLan SAVE URL (with keys in query):', url);
            console.log('📦 [DEBUG] PicLan SAVE Request Body length:', body.length);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 8000);
            try {
                const res = await fetch(url, {
                    method,
                    body,
                    signal: controller.signal,
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Accept': 'application/xml, text/xml, */*',
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });
                clearTimeout(timeoutId);
                const text = await res.text();
                // Debug: log a small snippet of the raw response
                try { console.debug('🧾 [DEBUG] PicLan SAVE raw response:', text.slice(0, 400)); } catch (_) {}
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status} ${res.statusText}: ${text.substring(0, 200)}`);
                }

                // Some servers print a debug line before the XML. Attempt to trim to XML start.
                let xmlStartIdx = text.indexOf('<?xml');
                if (xmlStartIdx === -1) xmlStartIdx = text.indexOf('<response');
                const xmlPayload = xmlStartIdx > -1 ? text.slice(xmlStartIdx) : text;

                const doc = new DOMParser().parseFromString(xmlPayload, 'text/xml');
                const hasParserError = doc.getElementsByTagName('parsererror').length > 0;
                let statusText = '';
                let messageText = '';
                if (!hasParserError) {
                    const statusNode = doc.querySelector('status');
                    statusText = statusNode ? statusNode.textContent.trim().toLowerCase() : '';
                    const msgNode = doc.querySelector('message');
                    messageText = msgNode ? msgNode.textContent.trim() : '';
                } else {
                    // Fallback via regex if XML had a prefix or minor malformation
                    const statusMatch = xmlPayload.match(/<status>([\s\S]*?)<\/status>/i);
                    const msgMatch = xmlPayload.match(/<message>([\s\S]*?)<\/message>/i);
                    statusText = statusMatch ? String(statusMatch[1]).trim().toLowerCase() : '';
                    messageText = msgMatch ? String(msgMatch[1]).trim() : '';
                }

                // Accept alternate server behavior that returns <customers> payload or debug success markers
                if (statusText !== 'success') {
                    const looksLikeSuccess = /\<customers\>/i.test(xmlPayload)
                        || /Price record written/i.test(xmlPayload)
                        || /Record updated successfully/i.test(xmlPayload)
                        || /<response>/i.test(xmlPayload); // tolerate missing <status>
                    if (looksLikeSuccess) {
                        console.warn('[SAVE] Non-standard success response. Proceeding.');
                    } else {
                        // Try to extract an <error> message if present
                        let errorText = '';
                        try {
                            const eNode = doc && !hasParserError ? doc.querySelector('error') : null;
                            if (eNode) errorText = (eNode.textContent || '').trim();
                        } catch {}
                        if (!errorText) {
                            const m = xmlPayload.match(/<error>([\s\S]*?)<\/error>/i);
                            if (m) errorText = (m[1] || '').trim();
                        }
                        const fallback = errorText || messageText || `Unexpected response from PicLan (no <message>). Snippet: ${xmlPayload.substring(0, 200)}`;
                        throw new Error(fallback);
                    }
                }

                // Optional server-side verification: ensure notes persisted when provided
                if (typeof notes === 'string' && notes.trim() !== '') {
                    const verifyUrl = `GET_BUYERS.XML`;
                    const normalize = (s) => (s || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim();
                    async function verifyOnce() {
                        const vController = new AbortController();
                        const vTimeout = setTimeout(() => vController.abort(), 6000);
                        const vRes = await fetch(verifyUrl, { method: 'GET', cache: 'no-cache', signal: vController.signal });
                        clearTimeout(vTimeout);
                        const vText = await vRes.text();
                        const startIdx = (() => {
                            const a = vText.indexOf('<?xml');
                            if (a !== -1) return a;
                            const b = vText.indexOf('<customers');
                            if (b !== -1) return b;
                            return 0;
                        })();
                        const vPayload = vText.slice(startIdx);
                        const vDoc = new DOMParser().parseFromString(vPayload, 'text/xml');
                        let serverNotes = '';
                        if (vDoc && !vDoc.querySelector('parsererror')) {
                            const n = vDoc.getElementsByTagName('notes')[0];
                            if (n) serverNotes = (n.textContent || '').trim();
                        } else {
                            const m = vPayload.match(/<notes>([\s\S]*?)<\/notes>/i);
                            serverNotes = m ? (m[1] || '').trim() : '';
                            serverNotes = serverNotes.replace(/^<!\[CDATA\[/, '').replace(/]]>$/, '').trim();
                        }
                        return { serverNotes, vPayload };
                    }
                    try {
                        let { serverNotes, vPayload } = await verifyOnce();
                        if (normalize(serverNotes) !== normalize(notes)) {
                            // One short retry to handle eventual consistency
                            await new Promise(r => setTimeout(r, 600));
                            ({ serverNotes, vPayload } = await verifyOnce());
                            if (normalize(serverNotes) !== normalize(notes)) {
                                console.warn('[VERIFY] Notes mismatch after retry', { sent: notes, serverNotes, snippet: vPayload.slice(0, 200) });
                                throw new Error('La verificación falló: la nota no se persistió en PicLan.');
                            }
                        }
                    } catch (verr) {
                        console.error('Post-save verification failed:', verr);
                        throw verr;
                    }
                }

                return { ok: true, xml: xmlPayload };
            } catch (err) {
                clearTimeout(timeoutId);
                throw err;
            }
        }

        async function saveRecordToPicLan(arg1, arg2) {
            // New signature: single object
            if (arg1 && typeof arg1 === 'object' && !arg2) {
                return await saveRecordToPicLanCore(arg1);
            }

            // Legacy signature: (event, recordId)
            const event = arg1;
            const recordId = arg2;
            if (event && typeof event.preventDefault === 'function') event.preventDefault();

            try {
                const customerName = document.getElementById(`${recordId}_customer`)?.value?.trim() || '';
                const partDescription = document.getElementById(`${recordId}_partdesc`)?.value?.trim() || '';
                const notes = document.getElementById(`${recordId}_notes`)?.value?.trim() || '';
                const date = document.getElementById(`${recordId}_date`)?.value || '';

                const id = (document.getElementById('custno')?.value?.trim()
                    || document.getElementById('editCustno')?.value?.trim()
                    || document.getElementById('editCustomerNumber')?.value?.trim()
                    || '').toString();
                const partNumber = (document.getElementById('partNumber')?.value?.trim()
                    || document.getElementById('editPartNumber')?.value?.trim()
                    || document.getElementById('editPart')?.value?.trim()
                    || '').toString();

                const priceRanges = [];
                const container = document.getElementById(`${recordId}_priceRangesContainer`);
                if (container) {
                    const rangeElements = container.querySelectorAll('[id*="_range_"]');
                    rangeElements.forEach((rangeEl) => {
                        const actualIndex = rangeEl.id.split('_range_')[1];
                        const fromQtyEl = document.getElementById(`${recordId}_fromQty_${actualIndex}`);
                        const toQtyEl = document.getElementById(`${recordId}_toQty_${actualIndex}`);
                        const priceEl = document.getElementById(`${recordId}_price_${actualIndex}`);
                        if (fromQtyEl && toQtyEl && priceEl) {
                            const fromQty = fromQtyEl.value;
                            const toQty = toQtyEl.value;
                            const price = priceEl.value;
                            if (fromQty && toQty && price) {
                                priceRanges.push({
                                    fromQty: parseInt(fromQty, 10),
                                    toQty: parseInt(toQty, 10),
                                    price: Number(price).toFixed(3)
                                });
                            }
                        }
                    });
                }

                console.log('🧾 [DEBUG] Legacy SAVE params:', { id, partNumber, customerName, partDescription, notes, date, ranges: priceRanges });
                if (!id || !partNumber) {
                    showErrorNotification('Faltan datos', 'ID (cliente) y Part Number son requeridos');
                    return { ok: false };
                }

                showLoadingNotification('Guardando en PicLan', 'Enviando cambios...');
                const result = await saveRecordToPicLanCore({ id, partNumber, customerName, partDescription, notes, date, priceRanges });
                showSuccessNotification('Cambios guardados', 'PicLan actualizado correctamente.');
                return result;
            } catch (error) {
                console.error('Error en saveRecordToPicLan (legacy):', error);
                showErrorNotification('Error al guardar', (error && error.message) ? error.message : String(error));
                throw error;
            } finally {
                hideLoadingNotification();
            }
        }

        async function updateRecord(event) {
            console.log('updateRecord function called');
            event.preventDefault();
            
            const index = parseInt(document.getElementById('editIndex')?.value ?? '-1', 10);
            const notes = (document.getElementById('editNotes')?.value || '').trim();
            const date = (document.getElementById('editDate')?.value || '').trim();
            const priceRanges = getEditPriceRanges();

            console.log('Form values (editable only):', { notes, priceRanges });

            // Validate index
            if (!Number.isFinite(index) || index < 0 || index >= records.length) {
                showErrorNotification('Error', 'Registro inválido');
                return;
            }

            // Validate price ranges
            const validationError = validatePriceRanges(priceRanges);
            if (validationError) {
                showErrorNotification('Error en rangos de precio', validationError);
                return;
            }

            const current = records[index];
            const formId = (document.getElementById('editCustno')?.value 
                || document.getElementById('editCustomerNumber')?.value 
                || document.getElementById('editCustomerNo')?.value 
                || '').toString().trim();
            const formPart = (document.getElementById('editPartNumber')?.value 
                || document.getElementById('editPart')?.value 
                || '').toString().trim();

            // Prefer what the user sees in the form; fallback to record fields
            const id = (formId 
                || current.custno 
                || current.customerNumber 
                || current.id 
                || current.CUSTOMER_NUMBER 
                || current.CustomerNumber 
                || '').toString().trim();
            const partNumber = (formPart 
                || current.partNumber 
                || current.PART_NUMBER 
                || current.PartNumber 
                || '').toString().trim();
            const customerName = (current.customerName || current.customer || '').toString().trim();
            const partDescription = (current.partDescription || '').toString().trim();

            console.log('🧾 [DEBUG] SAVE sources:', {
                formId, formPart,
                currentId: (current.custno || current.customerNumber || current.id || current.CUSTOMER_NUMBER || current.CustomerNumber || ''),
                currentPart: (current.partNumber || current.PART_NUMBER || current.PartNumber || '')
            });
            console.log('🧾 [DEBUG] SAVE payload keys:', { id, partNumber, hasNotes: !!notes, hasDate: !!date, ranges: priceRanges });

            if (!id || !partNumber) {
                showErrorNotification('Faltan datos', 'ID (cliente) y Part Number son requeridos');
                return;
            }

            try {
                showLoadingNotification('Guardando en PicLan', 'Enviando cambios...');
                await saveRecordToPicLan({
                    id,
                    partNumber,
                    customerName,
                    partDescription,
                    notes,
                    date,
                    priceRanges
                });

                // Apply local updates only after successful save
                current.notes = notes;
                if (date) current.date = date;
                current.priceRanges = priceRanges;

                console.log('Updated record:', current);
                renderRecords();
                cancelEdit();
                showSuccessNotification('Cambios guardados', 'PicLan actualizado correctamente.');
            } catch (err) {
                console.error('Error al guardar en PicLan:', err);
                showErrorNotification('Error al guardar', (err && err.message) ? err.message : String(err));
            } finally {
                hideLoadingNotification();
            }
        }

        function cancelEdit() {
            document.getElementById('editForm').style.display = 'none';
            document.getElementById('noEditMessage').style.display = 'block';
            document.getElementById('editForm').reset();
        }

        function deleteRecord(index) {
            if (confirm('Are you sure you want to delete this record?')) {
                records.splice(index, 1);
                renderRecords();
                showSuccessNotification('Record deleted successfully!', 'The record has been permanently removed from the system.');
            }
        }

        // Unified Notification System
        function showNotification(message, type = 'success') {
    // Crear contenedor si no existe
    let container = document.getElementById('notificationContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'notificationContainer';
        container.style.cssText = `position:fixed;top:20px;right:20px;z-index:10000;pointer-events:none;`;
        document.body.appendChild(container);
    }

    // Configuración por tipo
    const config = {
        success: { bg:'linear-gradient(135deg,#10b981 0%,#059669 100%)', icon:'fas fa-check' },
        error:   { bg:'linear-gradient(135deg,#ef4444 0%,#dc2626 100%)', icon:'fas fa-exclamation-triangle' },
        warning: { bg:'linear-gradient(135deg,#f59e0b 0%,#d97706 100%)', icon:'fas fa-exclamation-circle' },
        info:    { bg:'linear-gradient(135deg,#3b82f6 0%,#2563eb 100%)', icon:'fas fa-info-circle' }
    }[type] || { bg:'#333', icon:'fas fa-info-circle' };

    const note = document.createElement('div');
    note.style.cssText = `background:${config.bg};color:#fff;padding:16px 24px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.3);display:flex;align-items:center;gap:12px;font-size:14px;min-width:300px;max-width:500px;margin-bottom:10px;transform:translateX(400px);opacity:0;transition:all .4s ease;pointer-events:auto;cursor:pointer;`;
    note.innerHTML = `<div style="background:rgba(255,255,255,.2);border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;"><i class="${config.icon}"></i></div><div style="flex:1;">${message}</div><div style="opacity:.7;font-size:12px;">✕</div>`;
    container.appendChild(note);
    setTimeout(()=>{ note.style.transform='translateX(0)'; note.style.opacity='1';},100);
    const ttl = type==='error'?8000:5000;
    const remove = ()=>{ note.style.transform='translateX(400px)'; note.style.opacity='0'; setTimeout(()=>note.remove(),400);} ;
    setTimeout(remove, ttl);
    note.onclick=remove;
}

        // Modern Success Notification System
        function showSuccessNotification(title, message = '') {
            const container = document.getElementById('notificationContainer');
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="fas fa-check"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    ${message ? `<div class="notification-message">${message}</div>` : ''}
                </div>
            `;
            
            // Add to container
            container.appendChild(notification);
            
            // Trigger animation
            setTimeout(() => {
                notification.classList.add('show', 'bounce');
            }, 100);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                notification.classList.add('hide');
                
                // Remove from DOM after animation
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 400);
            }, 4000);
        }

        // Error Notification System
        function showErrorNotification(title, message = '') {
            const container = document.getElementById('notificationContainer');
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'notification error';
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    ${message ? `<div class="notification-message">${message}</div>` : ''}
                </div>
            `;
            
            // Add to container
            container.appendChild(notification);
            
            // Trigger animation
            setTimeout(() => {
                notification.classList.add('show', 'bounce');
            }, 100);
            
            // Auto remove after 5 seconds (longer for error messages)
            setTimeout(() => {
                notification.classList.remove('show');
                notification.classList.add('hide');
                
                // Remove from DOM after animation
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 400);
            }, 5000);
        }

        // Loading Notification System
        let loadingNotification = null;
        
        function showLoadingNotification(title, message = '') {
            // Remove existing loading notification if any
            hideLoadingNotification();
            
            const container = document.getElementById('notificationContainer');
            
            // Create loading notification element
            loadingNotification = document.createElement('div');
            loadingNotification.className = 'notification loading';
            loadingNotification.innerHTML = `
                <div class="notification-icon">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    ${message ? `<div class="notification-message">${message}</div>` : ''}
                </div>
            `;
            
            // Add to container
            container.appendChild(loadingNotification);
            
            // Trigger animation
            setTimeout(() => {
                loadingNotification.classList.add('show');
            }, 100);
        }
        
        function hideLoadingNotification() {
            if (loadingNotification && loadingNotification.parentNode) {
                loadingNotification.classList.remove('show');
                loadingNotification.classList.add('hide');
                
                // Remove from DOM after animation
                setTimeout(() => {
                    if (loadingNotification && loadingNotification.parentNode) {
                        loadingNotification.parentNode.removeChild(loadingNotification);
                    }
                    loadingNotification = null;
                }, 400);
            }
        }

        // Función para mostrar mensajes informativos (no altera el DOM principal)
        function showInfoMessage(message) {
            // Usa el sistema de notificaciones unificado para no borrar el contenido actual
            try {
                showNotification(message, 'info');
            } catch (e) {
                console.log('Info:', message);
            }
        }

        // Initialize price formatting when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Apply price formatting to all existing price inputs
            applyPriceFormattingToAll();
            
            // Re-apply formatting when tabs are switched (in case new inputs are created)
            setTimeout(() => {
                applyPriceFormattingToAll();
            }, 500);
        });

        // Also apply formatting when window loads (backup)
        window.addEventListener('load', function() {
            setTimeout(() => {
                applyPriceFormattingToAll();
            }, 1000);
        });

        // ============================================
        // FUNCIONES PARA COPY-PASTE A PRICE_EDIT.HTM
        // ============================================
        


        // ============================================
// DISABLED: GETCUST.XML/UPDATE_CUST.XML FUNCTIONS REMOVED
// ============================================
// Función CORREGIDA para obtener contenido XML con múltiples selectores
function getXMLTextContent(parentNode, ...tagNames) {
    for (const tagName of tagNames) {
        const element = parentNode.querySelector(tagName);
        if (element && element.textContent) {
            const content = element.textContent.trim();
            if (content) return content;
        }
    }
    return '';
}
// parseXMLToRecords: única definición vive más abajo (~línea 5120)
// ============================================
// FUNCIONES DE DIAGNÓSTICO Y UTILIDAD AVANZADAS
// ============================================
// (Inserta aquí el resto de funciones del bloque del usuario: displayXMLDebugInfo, displayErrorInfo, tryParseXMLManually, showXMLStructure, runCacheDiagnosticAndCleanup, manualCleanupLocalStorage, runSystemDiagnostic, validateXMLStructure, logSearchAttempt, showSearchHistory, el bloque de CSS para loading si no existe, y la inicialización de diagnósticos)


        // Función para mostrar registros de la API en formato simple primero
        function displayAPIRecord(record) {
            // Validar que el record existe
            if (!record) {
                return '<div class="api-record-display"><p>❌ No se pudo mostrar el registro</p></div>';
            }
            
            // Asegurar que priceRanges existe como array
            const priceRanges = record.priceRanges || [];
            const recordId = `api_${record.id || Date.now()}`;
            
            return `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h4 style="color: #3b82f6; margin: 0; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-database" style="color: #3b82f6;"></i> 
                        Record Found in Local Storage: Part ${record.partNumber || 'N/A'} for Customer #${record.customerNumber || record.custno || 'N/A'}
                    </h4>
                    <button onclick="startNewCaptureSearch()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 8px 16px; border: none; border-radius: 6px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <i class="fas fa-search"></i> New Search
                    </button>
                </div>
                
                <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #3b82f6; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <div style="background: #3b82f6; color: white; padding: 6px 12px; border-radius: 6px; font-size: 0.9em; font-weight: 600;">
                            <i class="fas fa-check-circle"></i> Encontrado en Local Storage
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                        <div>
                            <strong style="color: #374151;">ID:</strong> ${record.id || 'N/A'}
                        </div>
                        <div>
                            <strong style="color: #374151;">Part Number:</strong> ${record.partNumber || 'N/A'}
                        </div>
                        <div>
                            <strong style="color: #374151;">Customer Number:</strong> ${record.customerNumber || record.custno || 'N/A'}
                        </div>
                        <div>
                            <strong style="color: #374151;">Customer Name:</strong> ${record.customerName || record.customer || 'N/A'}
                        </div>
                        <div>
                            <strong style="color: #374151;">Description:</strong> ${record.partDescription || 'N/A'}
                        </div>
                        <div>
                            <strong style="color: #374151;">Notes:</strong> ${record.notes || 'N/A'}
                        </div>
                    </div>
                    
                    <div style="background: white; border: 1px solid #3b82f6; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
                        <h5 style="margin: 0 0 8px 0; color: #374151; display: flex; align-items: center; gap: 6px;">
                            <i class="fas fa-dollar-sign" style="color: #3b82f6;"></i> Price Ranges:
                        </h5>
                        ${priceRanges.length > 0 ? 
                            priceRanges.map(range => `
                                <div style="padding: 4px 0; border-bottom: 1px solid #e5e7eb; last-child:border-bottom: none;">
                                    <span style="color: #6b7280;">Qty ${range.fromQty || '?'}-${range.toQty || '?'}: </span>
                                    <span style="font-weight: 600; color: #059669;">$${(range.price != null && range.price !== '' ? parseFloat(range.price).toFixed(3) : '0.000')}</span>
                                </div>
                            `).join('') : 
                            '<p style="color: #6b7280; font-style: italic; margin: 0;">No price ranges available</p>'
                        }
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button onclick="showEditAPIRecordForm('${recordId}', ${JSON.stringify(record).replace(/"/g, '&quot;')})" style="
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 6px;
                            font-size: 0.95em;
                            font-weight: 600;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            transition: all 0.2s ease;
                            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.25);
                        " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(16, 185, 129, 0.35)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(16, 185, 129, 0.25)'">
                            <i class="fas fa-edit"></i>
                            Edit Record
                        </button>
                        <button onclick="saveAPIRecordToLocalDirectly('${recordId}', ${JSON.stringify(record).replace(/"/g, '&quot;')})" style="
                            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 6px;
                            font-size: 0.95em;
                            font-weight: 600;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                            <i class="fas fa-download"></i>
                            Save As-Is
                        </button>
                    </div>
                </div>
            `;
        }

        // Función para mostrar el formulario de edición del registro API
        function showEditAPIRecordForm(recordId, record) {
            const resultsArea = document.getElementById('captureResultsArea');
            
            // Asegurar que priceRanges existe como array
            const priceRanges = record.priceRanges || [];
            
            resultsArea.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h4 style="color: #10b981; margin: 0; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-edit" style="color: #10b981;"></i> 
                        Editing Local Storage Record: Part ${record.partNumber || 'N/A'} for Customer #${record.customerNumber || record.custno || 'N/A'}
                    </h4>
                    <button onclick="startNewCaptureSearch()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 8px 16px; border: none; border-radius: 6px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <i class="fas fa-search"></i> New Search
                    </button>
                </div>
                
                <form onsubmit="saveAPIRecordToLocal(event, '${recordId}')" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #10b981; border-radius: 8px; padding: 20px;">
                    <h5 style="color: #374151; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-edit" style="color: #10b981;"></i> Edit Local Storage Record
                    </h5>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 4px;">Part Number:</label>
                            <input type="text" value="${record.partNumber || ''}" readonly style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 2px solid #d1d5db;
                                border-radius: 6px;
                                background: #f9fafb;
                                color: #6b7280;
                                font-weight: 500;
                            ">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 4px;">Customer Number:</label>
                            <input type="text" value="${record.customerNumber || record.custno || ''}" readonly style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 2px solid #d1d5db;
                                border-radius: 6px;
                                background: #f9fafb;
                                color: #6b7280;
                                font-weight: 500;
                            ">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">Customer Name <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="${recordId}_customer" value="${record.customerName || record.customer || ''}" required style="width: 100%; padding: 10px 12px; border: 2px solid #10b981; border-radius: 6px; font-size: 14px; transition: all 0.2s ease;" onfocus="this.style.borderColor='#059669'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)'" onblur="this.style.borderColor='#10b981'; this.style.boxShadow='none'">
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">Part Description <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="${recordId}_partdesc" value="${record.partDescription || ''}" required style="width: 100%; padding: 10px 12px; border: 2px solid #10b981; border-radius: 6px; font-size: 14px; transition: all 0.2s ease;" onfocus="this.style.borderColor='#059669'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)'" onblur="this.style.borderColor='#10b981'; this.style.boxShadow='none'">
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">Notes</label>
                            <input type="text" id="${recordId}_notes" value="${record.notes || ''}" style="width: 100%; padding: 10px 12px; border: 2px solid #10b981; border-radius: 6px; font-size: 14px; transition: all 0.2s ease;" onfocus="this.style.borderColor='#059669'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)'" onblur="this.style.borderColor='#10b981'; this.style.boxShadow='none'">
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">Date</label>
                            <input type="date" id="${recordId}_date" value="${record.date || new Date().toISOString().split('T')[0]}" style="width: 100%; padding: 10px 12px; border: 2px solid #10b981; border-radius: 6px; font-size: 14px; transition: all 0.2s ease;" onfocus="this.style.borderColor='#059669'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)'" onblur="this.style.borderColor='#10b981'; this.style.boxShadow='none'">
                        </div>
                    </div>
                    
                    <!-- Price Ranges Section -->
                    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 8px; padding: 16px; margin: 16px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h5 style="margin: 0; color: #92400e; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-dollar-sign"></i> Price Ranges
                            </h5>
                            <button type="button" onclick="addNewPriceRange('${recordId}')" style="background: #f59e0b; color: white; padding: 6px 12px; border: none; border-radius: 4px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                <i class="fas fa-plus"></i> Add Range
                            </button>
                        </div>
                        <div id="${recordId}_priceRangesContainer" style="display: grid; gap: 8px;">
                            ${priceRanges.length > 0 ? 
                                priceRanges.map((range, index) => `
                                    <div id="${recordId}_range_${index}" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; padding: 12px; background: white; border: 1px solid #f59e0b; border-radius: 6px; align-items: end;">
                                        <div>
                                            <label style="font-size: 0.9em; color: #92400e; font-weight: 500; display: block; margin-bottom: 4px;">From Qty</label>
                                            <input type="number" id="${recordId}_fromQty_${index}" value="${range.fromQty || ''}" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                                        </div>
                                        <div>
                                            <label style="font-size: 0.9em; color: #92400e; font-weight: 500; display: block; margin-bottom: 4px;">To Qty</label>
                                            <input type="number" id="${recordId}_toQty_${index}" value="${range.toQty || ''}" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                                        </div>
                                        <div>
                                            <label style="font-size: 0.9em; color: #92400e; font-weight: 500; display: block; margin-bottom: 4px;">Price</label>
                                            <input type="number" id="${recordId}_price_${index}" value="${range.price || ''}" step="0.001" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                                        </div>
                                        <button type="button" onclick="removeAPIRecordPriceRange('${recordId}', ${index})" style="background: #ef4444; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; height: 36px;" title="Remove Range">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `).join('') : 
                                '<p style="color: #92400e; font-style: italic; margin: 0; text-align: center; padding: 20px;">No price ranges available. Click "Add Range" to create one.</p>'
                            }
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: center; margin-top: 20px;">
                        <button type="button" onclick="savePicLanFromCaptureForm('${recordId}', ${JSON.stringify(record).replace(/"/g, '&quot;')})" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s ease; box-shadow: 0 4px 6px rgba(59, 130, 246, 0.25);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(59, 130, 246, 0.35)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(59, 130, 246, 0.25)'">
                            <i class="fas fa-save"></i> Save
                        </button>
                        <button type="button" onclick="clearCaptureForm()" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s ease;" onmouseover="this.style.background='linear-gradient(135deg, #4b5563 0%, #374151 100%)'" onmouseout="this.style.background='linear-gradient(135deg, #6b7280 0%, #4b5563 100%)'">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>
            `;
        }
        
        // ================================
        // Helper functions for Data Capture edit workflow
        // ================================
        function addNewPriceRange(recordId) {
            try {
                const container = document.getElementById(`${recordId}_priceRangesContainer`);
                if (!container) {
                    console.error('[addNewPriceRange] Container not found:', `${recordId}_priceRangesContainer`);
                    if (typeof showNotification === 'function') showNotification('No se encontró el contenedor de rangos', 'error');
                    return;
                }
                const rows = Array.from(container.children).filter(el => el.id && el.id.indexOf(`${recordId}_range_`) === 0);
                let nextIndex = 0;
                rows.forEach(el => {
                    const idx = parseInt((el.id || '').split('_range_')[1], 10);
                    if (!isNaN(idx) && idx >= nextIndex) nextIndex = idx + 1;
                });
                const rowHtml = `
                    <div id="${recordId}_range_${nextIndex}" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; padding: 12px; background: white; border: 1px solid #f59e0b; border-radius: 6px; align-items: end;">
                        <div>
                            <label style="font-size: 0.9em; color: #92400e; font-weight: 500; display: block; margin-bottom: 4px;">From Qty</label>
                            <input type="number" id="${recordId}_fromQty_${nextIndex}" placeholder="0" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                        </div>
                        <div>
                            <label style="font-size: 0.9em; color: #92400e; font-weight: 500; display: block; margin-bottom: 4px;">To Qty</label>
                            <input type="number" id="${recordId}_toQty_${nextIndex}" placeholder="0" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                        </div>
                        <div>
                            <label style="font-size: 0.9em; color: #92400e; font-weight: 500; display: block; margin-bottom: 4px;">Price</label>
                            <input type="number" id="${recordId}_price_${nextIndex}" step="0.001" placeholder="0.000" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                        </div>
                        <button type="button" onclick="removeAPIRecordPriceRange('${recordId}', ${nextIndex})" style="background: #ef4444; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; height: 36px;" title="Remove Range">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', rowHtml);
            } catch (e) {
                console.error('Error adding new price range:', e);
            }
        }

        // removed duplicate removeAPIRecordPriceRange(recordId, index) — use the earlier reindexing version

        function startNewCaptureSearch() {
            clearCaptureForm();
        }

        // Alias used by the top action button
        function startNewSearch() {
            startNewCaptureSearch();
        }

        function clearCaptureForm() {
            try {
                const pnEl = document.getElementById('partNumber');
                const cnEl = document.getElementById('custno');
                if (pnEl) pnEl.value = '';
                if (cnEl) cnEl.value = '';

                const resultsArea = document.getElementById('captureResultsArea');
                if (resultsArea) {
                    resultsArea.innerHTML = '<div id="captureCustomerInfo" style="display: none;"></div><div id="capturePartInfo" style="display: none;"></div>';
                    resultsArea.style.display = 'none';
                }

                const actionBtns = document.getElementById('captureActionButtons');
                if (actionBtns) actionBtns.style.display = 'none';

                const lookup = document.getElementById('customerLookupResult');
                if (lookup) { lookup.innerHTML = ''; lookup.style.display = 'none'; }

                const partSearchResults = document.getElementById('capturePartSearchResults');
                if (partSearchResults) {
                    partSearchResults.style.display = 'none';
                    const content = document.getElementById('capturePartSearchContent');
                    if (content) content.innerHTML = '';
                }

                if (pnEl && typeof pnEl.focus === 'function') pnEl.focus();
                if (typeof showInfoMessage === 'function') showInfoMessage('Listo para nueva búsqueda.');
            } catch (e) {
                console.error('Error clearing capture form:', e);
            }
        }

        // Persist changes from the Data Capture edit form to PicLan and update only the intended local record
        async function savePicLanFromCaptureForm(recordId, original) {
            try {
                const id = (original && (original.customerNumber || original.custno || original.id || original.CUSTOMER_NUMBER || original.CustomerNumber) || '').toString().trim();
                const partNumber = (original && (original.partNumber || original.PART_NUMBER || original.PartNumber) || '').toString().trim();

                if (!id || !partNumber) {
                    showErrorNotification('Faltan llaves', 'ID (cliente) y Part Number no detectados en el registro.');
                    return;
                }

                const customerName = (document.getElementById(`${recordId}_customer`)?.value || '').trim();
                const partDescription = (document.getElementById(`${recordId}_partdesc`)?.value || '').trim();
                const notes = (document.getElementById(`${recordId}_notes`)?.value || '').trim();
                const date = (document.getElementById(`${recordId}_date`)?.value || '').trim();

                // Collect price ranges from this record form only
                const priceRanges = [];
                const container = document.getElementById(`${recordId}_priceRangesContainer`);
                if (container) {
                    const rows = container.querySelectorAll('[id*="_range_"]');
                    rows.forEach(row => {
                        const idx = (row.id || '').split('_range_')[1];
                        const fromQtyEl = document.getElementById(`${recordId}_fromQty_${idx}`);
                        const toQtyEl = document.getElementById(`${recordId}_toQty_${idx}`);
                        const priceEl = document.getElementById(`${recordId}_price_${idx}`);
                        if (fromQtyEl && toQtyEl && priceEl) {
                            const fromQty = parseInt(fromQtyEl.value, 10);
                            const toQty = parseInt(toQtyEl.value, 10);
                            const priceNum = Number.parseFloat(priceEl.value);
                            if (Number.isFinite(fromQty) && Number.isFinite(toQty) && Number.isFinite(priceNum)) {
                                priceRanges.push({ fromQty, toQty, price: Number(priceNum.toFixed(3)) });
                            }
                        }
                    });
                }

                showLoadingNotification('Guardando en PicLan', 'Enviando cambios...');
                await saveRecordToPicLan({ id, partNumber, customerName, partDescription, notes, date, priceRanges });

                // Update only the targeted local record by composite key
                const keyPart = partNumber.toString().trim().toUpperCase();
                const keyId = id.toString().trim();
                const idx = records.findIndex(r => {
                    const rid = (r.customerNumber || r.custno || r.id || r.CUSTOMER_NUMBER || r.CustomerNumber || '').toString().trim();
                    const pn = (r.partNumber || r.PART_NUMBER || r.PartNumber || '').toString().trim().toUpperCase();
                    return pn === keyPart && rid === keyId;
                });
                if (idx !== -1) {
                    const rec = records[idx];
                    if (customerName) { rec.customerName = customerName; rec.customer = customerName; }
                    if (partDescription) rec.partDescription = partDescription;
                    rec.notes = notes;
                    if (date) rec.date = date;
                    rec.priceRanges = priceRanges;
                } else {
                    console.warn('No se encontró el registro local para actualizar después del guardado.', { id, partNumber });
                }

                renderRecords();

                // Collapse/hide the inline edit UI to indicate success
                try {
                    // If using Data Capture inline form container
                    const resultsArea = document.getElementById('captureResultsArea');
                    if (resultsArea && resultsArea.style) {
                        // Smooth collapse animation
                        resultsArea.style.overflow = 'hidden';
                        resultsArea.style.transition = 'max-height 0.25s ease, opacity 0.2s ease';
                        resultsArea.style.maxHeight = resultsArea.scrollHeight + 'px';
                        // Force reflow then collapse
                        void resultsArea.offsetHeight;
                        resultsArea.style.maxHeight = '0px';
                        resultsArea.style.opacity = '0';
                        setTimeout(() => {
                            resultsArea.style.display = 'none';
                            resultsArea.innerHTML = '<div id="captureCustomerInfo" style="display: none;"></div><div id="capturePartInfo" style="display: none;"></div>';
                            resultsArea.style.maxHeight = '';
                            resultsArea.style.opacity = '';
                            resultsArea.style.overflow = '';
                            resultsArea.style.transition = '';
                        }, 260);
                    }

                    // If using legacy/alternate container
                    const partDetailsForm = document.getElementById('partDetailsForm');
                    if (partDetailsForm) partDetailsForm.style.display = 'none';

                    // Show capture action buttons (New Search / Clear) if present
                    const actionBtns = document.getElementById('captureActionButtons');
                    if (actionBtns) actionBtns.style.display = 'flex';
                } catch (uiErr) {
                    console.warn('UI collapse after save failed:', uiErr);
                }

                showSuccessNotification('Cambios guardados', 'PicLan actualizado y la vista refrescada.');
            } catch (e) {
                console.error('Error al guardar desde Data Capture:', e);
                showErrorNotification('Error al guardar', (e && e.message) ? e.message : String(e));
            } finally {
                hideLoadingNotification();
            }
        }

        function saveAPIRecordToLocal(event, recordId) {
            if (event && typeof event.preventDefault === 'function') event.preventDefault();
            try {
                const ranges = [];
                const container = document.getElementById(`${recordId}_priceRangesContainer`);
                if (container) {
                    const rows = container.querySelectorAll('[id*="_range_"]');
                    rows.forEach(row => {
                        const idx = (row.id || '').split('_range_')[1];
                        const fromQty = parseInt(document.getElementById(`${recordId}_fromQty_${idx}`)?.value || '', 10);
                        const toQty = parseInt(document.getElementById(`${recordId}_toQty_${idx}`)?.value || '', 10);
                        const priceStr = document.getElementById(`${recordId}_price_${idx}`)?.value || '';
                        const priceNum = parseFloat(priceStr);
                        if (!isNaN(fromQty) && !isNaN(toQty) && !isNaN(priceNum)) {
                            ranges.push({ fromQty, toQty, price: priceNum.toFixed(3) });
                        }
                    });
                }

                const payload = {
                    partNumber: document.getElementById('partNumber')?.value?.trim() || '',
                    customerNumber: document.getElementById('custno')?.value?.trim() || '',
                    customer: document.getElementById(`${recordId}_customer`)?.value?.trim() || '',
                    partDescription: document.getElementById(`${recordId}_partdesc`)?.value?.trim() || '',
                    notes: document.getElementById(`${recordId}_notes`)?.value?.trim() || '',
                    date: document.getElementById(`${recordId}_date`)?.value || '',
                    priceRanges: ranges
                };

                const key = 'TAIMEX_LOCAL_API_RECORDS';
                const store = JSON.parse(localStorage.getItem(key) || '{}');
                store[recordId] = payload;
                localStorage.setItem(key, JSON.stringify(store));

                if (typeof showSuccessNotification === 'function') {
                    showSuccessNotification('Guardado local', `${payload.partNumber} - Cliente ${payload.customerNumber}`);
                } else {
                    console.log('[Local save]', payload);
                    try { alert('Registro guardado localmente.'); } catch (_) {}
                }
            } catch (e) {
                console.error('Error saving locally:', e);
                if (typeof showNotification === 'function') showNotification('❌ Error al guardar localmente', 'error');
            }
        }

        function saveAPIRecordToLocalDirectly(recordId, record) {
            try {
                const normalized = {
                    ...record,
                    priceRanges: Array.isArray(record.priceRanges) ? record.priceRanges.map(r => ({
                        fromQty: parseInt(r.fromQty || 0, 10),
                        toQty: parseInt(r.toQty || 0, 10),
                        price: parseFloat(r.price || 0).toFixed(3)
                    })) : []
                };
                const key = 'TAIMEX_LOCAL_API_RECORDS';
                const store = JSON.parse(localStorage.getItem(key) || '{}');
                store[recordId] = normalized;
                localStorage.setItem(key, JSON.stringify(store));
                if (typeof showSuccessNotification === 'function') {
                    showSuccessNotification('Guardado local (as-is)', `${normalized.partNumber} - Cliente ${normalized.customerNumber || normalized.custno || ''}`);
                } else {
                    console.log('[Local save as-is]', normalized);
                    try { alert('Registro original guardado localmente.'); } catch (_) {}
                }
            } catch (e) {
                console.error('Error saving locally (as-is):', e);
                if (typeof showNotification === 'function') showNotification('❌ Error al guardar localmente (as-is)', 'error');
            }
        }

        // Define safe notification fallbacks only if not present
        (function ensureNotificationHelpers(){
            if (typeof window !== 'undefined') {
                if (typeof window.showNotification !== 'function') {
                    window.showNotification = (msg, type = 'info') => console.log(`[${type}]`, msg);
                }
                if (typeof window.showInfoMessage !== 'function') {
                    window.showInfoMessage = (msg) => window.showNotification(msg, 'info');
                }
                if (typeof window.showSuccessNotification !== 'function') {
                    window.showSuccessNotification = (title, msg) => window.showNotification(`${title}${msg ? `: ${msg}` : ''}`, 'success');
                }
                if (typeof window.showErrorNotification !== 'function') {
                    window.showErrorNotification = (title, msg) => window.showNotification(`${title}${msg ? `: ${msg}` : ''}`, 'error');
                }
            }
        })();

        // ============================================
        // FIN DE FUNCIONES PARA COPY-PASTE
        // ============================================
    </script>

    <!-- XML API Integration Script removed - GETCUST.XML is a server endpoint, not a JavaScript file -->

    <!-- API Sync Button - DISABLED to prevent 404 errors -->
    <!-- <div style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
        <button onclick="syncDataWithAPI()" 
                style="
                    background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
                    color: white;
                    border: none;
                    padding: 12px 16px;
                    border-radius: 8px;
                    cursor: pointer;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    font-size: 14px;
                    font-weight: 500;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    transition: all 0.2s ease;
                "
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
            <i class="fas fa-sync-alt"></i>
            Sync API
        </button>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <script>
        // ============================================
        // FUNCIONES PICLAN XML API INTEGRATION
        // ============================================

        // Función para consultar PicLan API directamente con retry automático
        async function getCustomerXMLFromAPI(custNumber, partNumber, retryCount = 0) {
            const maxRetries = 2;
            console.log(`🚀 [DEBUG] Iniciando consulta PicLan API (intento ${retryCount + 1}/${maxRetries + 1})`);
            console.log('🚀 [DEBUG] Parámetros recibidos:', { custNumber, partNumber });
            
            try {
                // URL directa al servidor PicLan
                const url = `GET_BUYERS.XML`;
                
                console.log('🔄 [DEBUG] URL construida:', url);
                console.log('🔄 [DEBUG] Iniciando fetch request...');
                
                // Crear AbortController para timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                }, 8000); // 8 segundos timeout
                
                const response = await fetch(url, {
                    signal: controller.signal,
                    mode: 'cors',
                    cache: 'no-cache', // Evitar problemas de caché
                    headers: {
                        'Accept': 'application/xml, text/xml, */*',
                        'Cache-Control': 'no-cache, no-store, must-revalidate'
                    }
                });
                
                clearTimeout(timeoutId);
                console.log('✅ [DEBUG] Fetch completado. Status:', response.status);
                console.log('✅ [DEBUG] Response headers:', Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    console.error('❌ [DEBUG] Response no OK. Status:', response.status, 'StatusText:', response.statusText);
                    if (response.status === 404) {
                        console.warn('⚠️ [DEBUG] Endpoint no encontrado (404). Registro no existe en PicLan.');
                        return null;
                    }
                    throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                }
                
                console.log('📥 [DEBUG] Obteniendo texto de respuesta...');
                const xmlText = await response.text();
                console.log('📥 [DEBUG] Respuesta XML recibida (longitud:', xmlText.length, '):', xmlText.substring(0, 500) + (xmlText.length > 500 ? '...' : ''));
                
                // Verificar si la respuesta está vacía o indica "no encontrado"
                if (!xmlText || xmlText.trim().length === 0) {
                    console.error('❌ [DEBUG] Respuesta vacía del servidor PicLan');
                    throw new Error('El servidor PicLan devolvió una respuesta vacía.');
                }
                
                // Verificar si la respuesta indica "no encontrado" pero podría ser un problema temporal
                if (xmlText.includes('No record found') || xmlText.includes('Record not found') || xmlText.includes('<error>')) {
                    if (retryCount < maxRetries) {
                        console.warn(`⚠️ [DEBUG] Registro no encontrado en intento ${retryCount + 1}, reintentando en 1 segundo...`);
                        await new Promise(resolve => setTimeout(resolve, 1000)); // Esperar 1 segundo
                        return getCustomerXMLFromAPI(custNumber, partNumber, retryCount + 1);
                    } else {
                        console.warn('⚠️ [DEBUG] No se encontraron registros después de todos los intentos');
                        return null;
                    }
                }
                
                // Parsear XML y convertir a registros
                console.log('🔍 [DEBUG] Iniciando parsing de XML...');
                const parsedRecords = parseXMLToRecords(xmlText);
                console.log('📊 [DEBUG] Registros parseados:', parsedRecords);
                console.log('📊 [DEBUG] Número de registros encontrados:', parsedRecords ? parsedRecords.length : 0);
                
                // Si no se encontraron registros pero tenemos intentos disponibles, reintentar
                if ((!parsedRecords || parsedRecords.length === 0) && retryCount < maxRetries) {
                    console.warn(`⚠️ [DEBUG] No se encontraron registros en intento ${retryCount + 1}, reintentando en 1 segundo...`);
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Esperar 1 segundo
                    return getCustomerXMLFromAPI(custNumber, partNumber, retryCount + 1);
                }
                
                return parsedRecords;
                
            } catch (error) {
                console.error(`❌ Error al consultar PicLan API (intento ${retryCount + 1}):`, error);
                
                // Si tenemos intentos disponibles, reintentar
                if (retryCount < maxRetries) {
                    console.warn(`⚠️ [DEBUG] Error en intento ${retryCount + 1}, reintentando en 2 segundos...`);
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Esperar 2 segundos
                    return getCustomerXMLFromAPI(custNumber, partNumber, retryCount + 1);
                }
                
                // Manejar diferentes tipos de errores
                if (error.name === 'AbortError') {
                    throw new Error('Timeout: La consulta a PicLan tardó demasiado (8 segundos)');
                } else if (error.message.includes('CORS')) {
                    throw new Error('Error de CORS: No se puede acceder al servidor PicLan directamente');
                } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                    throw new Error('Error de red: No se puede conectar al servidor PicLan');
                }
                
                throw error;
            }
        }

        // Función para parsear XML a registros
        function parseXMLToRecords(xmlString) {
            console.log('🔍 [DEBUG parseXMLToRecords] Iniciando parsing...');
            console.log('🔍 [DEBUG parseXMLToRecords] XML string length:', xmlString.length);
            console.log('🔍 [DEBUG parseXMLToRecords] XML preview:', xmlString.substring(0, 200));
            
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, 'text/xml');
            
            // Verificar si hay errores de parsing
            const parseError = xmlDoc.querySelector('parsererror');
            if (parseError) {
                console.error('❌ [DEBUG parseXMLToRecords] Error de parsing XML:', parseError.textContent);
                return [];
            }
            
            console.log('🔍 [DEBUG parseXMLToRecords] XML parseado correctamente');
            console.log('🔍 [DEBUG parseXMLToRecords] Root element:', xmlDoc.documentElement.tagName);
            
            const parsed = [];
            
            // Intentar diferentes selectores basados en la estructura del XML
            let customerNodes = xmlDoc.querySelectorAll('CUSTOMER');
            console.log('🔍 [DEBUG parseXMLToRecords] Nodos CUSTOMER encontrados:', customerNodes.length);
            
            if (customerNodes.length === 0) {
                // Intentar con 'buyer' (basado en GET_BUYERS.XML)
                customerNodes = xmlDoc.querySelectorAll('record');
                console.log('🔍 [DEBUG parseXMLToRecords] Nodos record encontrados:', customerNodes.length);
            }
            
            if (customerNodes.length === 0) {
                // Intentar con 'customers > record'
                customerNodes = xmlDoc.querySelectorAll('customers record');
                console.log('🔍 [DEBUG parseXMLToRecords] Nodos customers>record encontrados:', customerNodes.length);
            }
            
            if (customerNodes.length === 0) {
                console.warn('⚠️ [DEBUG parseXMLToRecords] No se encontraron nodos de customer en ningún formato');
                console.log('🔍 [DEBUG parseXMLToRecords] Estructura XML completa:', new XMLSerializer().serializeToString(xmlDoc));
                return [];
            }
            
            customerNodes.forEach(customerNode => {
                const record = {
                    id: getXMLTextContent(customerNode, 'ID') || getXMLTextContent(customerNode, 'id') ||
                        getXMLTextContent(customerNode, 'customerNumber') || getXMLTextContent(customerNode, 'CUSTOMER_NUMBER'),
                    partNumber: getXMLTextContent(customerNode, 'partNumber') || getXMLTextContent(customerNode, 'PART_NUMBER'),
                    custno: getXMLTextContent(customerNode, 'customerNumber') || getXMLTextContent(customerNode, 'CUSTOMER_NUMBER'),
                    customer: getXMLTextContent(customerNode, 'customerName') || getXMLTextContent(customerNode, 'CUSTOMER_NAME'),
                    customerNumber: getXMLTextContent(customerNode, 'customerNumber') || getXMLTextContent(customerNode, 'CUSTOMER_NUMBER'),
                    customerName: getXMLTextContent(customerNode, 'customerName') || getXMLTextContent(customerNode, 'CUSTOMER_NAME'),
                    partDescription: getXMLTextContent(customerNode, 'partDescription') || getXMLTextContent(customerNode, 'DESCRIPTION'),
                    lastUpdated: getXMLTextContent(customerNode, 'LAST_UPDATED'),
                    notes: getXMLTextContent(customerNode, 'notes') || getXMLTextContent(customerNode, 'NOTES'),
                    date: getXMLTextContent(customerNode, 'date') || getXMLTextContent(customerNode, 'DATE'),
                    priceRanges: []
                };
                
                // Parsear price ranges
               // Parsear price ranges - CORREGIDO para tu estructura XML
               const priceRangeNodes = customerNode.querySelectorAll('range');
console.log('🔍 [DEBUG] Nodos <range> encontrados:', priceRangeNodes.length);

priceRangeNodes.forEach((rangeNode, index) => {
    console.log(`🔍 [DEBUG] Range ${index}:`, rangeNode);
    console.log(`🔍 [DEBUG] fromQty:`, getXMLTextContent(rangeNode, 'fromQty'));
    console.log(`🔍 [DEBUG] toQty:`, getXMLTextContent(rangeNode, 'toQty'));
    console.log(`🔍 [DEBUG] price:`, getXMLTextContent(rangeNode, 'price'));
    console.log(`🔍 [DEBUG] MIN_QTY (fallback):`, getXMLTextContent(rangeNode, 'MIN_QTY'));
    console.log(`🔍 [DEBUG] MAX_QTY (fallback):`, getXMLTextContent(rangeNode, 'MAX_QTY'));
    console.log(`🔍 [DEBUG] PRICE (fallback):`, getXMLTextContent(rangeNode, 'PRICE'));
    
    const fromQty = parseInt(getXMLTextContent(rangeNode, 'fromQty') || getXMLTextContent(rangeNode, 'MIN_QTY')) || 0;
    const toQty = parseInt(getXMLTextContent(rangeNode, 'toQty') || getXMLTextContent(rangeNode, 'MAX_QTY')) || 0;
    const price = parseFloat(getXMLTextContent(rangeNode, 'price') || getXMLTextContent(rangeNode, 'PRICE')) || 0;
    
    console.log(`🔍 [DEBUG] Converted values:`, { fromQty, toQty, price });
    
    if (fromQty > 0 || toQty > 0 || price > 0) {
        record.priceRanges.push({
            fromQty: fromQty,
            toQty: toQty,
            price: price
        });
        console.log('✅ [DEBUG] Range added to record');
    } else {
        console.log('❌ [DEBUG] Range NOT added - all values are 0');
    }
});

console.log('📊 [DEBUG] Final record.priceRanges:', record.priceRanges);     
         
        parsed.push(record);
    });
    
    return parsed;
}

        // (removed duplicate getXMLTextContent; unified varargs version is defined earlier)

        // Función para mostrar registros de la API en formato legible
        function displayAPIRecord(record) {
            // Validar que el record existe
            if (!record) {
                return '<div class="api-record-display"><p>❌ No se pudo mostrar el registro</p></div>';
            }
            
            // Asegurar que priceRanges existe como array
            const priceRanges = record.priceRanges || [];
            const recordId = `api_${record.id || Date.now()}`;
            
            return `
                <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #3b82f6; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <div style="background: #3b82f6; color: white; padding: 6px 12px; border-radius: 6px; font-size: 0.9em; font-weight: 600;">
                            <i class="fas fa-database"></i> Encontrado en PicLan
                        </div>
                        <h4 style="color: #3b82f6; margin: 0;">Part ${record.partNumber || 'N/A'} - Customer #${record.custno || 'N/A'}</h4>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                        <div><strong style="color: #374151;">ID:</strong> ${record.id || 'N/A'}</div>
                        <div><strong style="color: #374151;">Part Number:</strong> ${record.partNumber || 'N/A'}</div>
                        <div><strong style="color: #374151;">Customer Number:</strong> ${record.custno || 'N/A'}</div>
                        <div><strong style="color: #374151;">Customer Name:</strong> ${record.customer || 'N/A'}</div>
                        <div><strong style="color: #374151;">Description:</strong> ${record.partDescription || 'N/A'}</div>
                        <div><strong style="color: #374151;">Notes:</strong> ${record.notes || 'N/A'}</div>
                    </div>
                    
                    <div style="background: white; border: 1px solid #3b82f6; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
                        <h5 style="margin: 0 0 8px 0; color: #374151; display: flex; align-items: center; gap: 6px;">
                            <i class="fas fa-dollar-sign" style="color: #3b82f6;"></i> Price Ranges:
                        </h5>
                        ${priceRanges.length > 0 ? 
                            priceRanges.map(range => `
                                <div style="padding: 4px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="color: #6b7280;">Qty ${range.fromQty || '?'}-${range.toQty || '?'}: </span>
                                    <span style="font-weight: 600; color: #059669;">$${(range.price != null && range.price !== '' ? parseFloat(range.price).toFixed(3) : '0.000')}</span>
                                </div>
                            `).join('') : 
                            '<p style="color: #6b7280; font-style: italic; margin: 0;">No price ranges available</p>'
                        }
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button onclick="saveAPIRecordToLocalDirectly('${recordId}', ${JSON.stringify(record).replace(/"/g, '&quot;')})" style="
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                            color: white; border: none; padding: 10px 20px; border-radius: 6px;
                            font-size: 0.95em; font-weight: 600; cursor: pointer;
                            display: flex; align-items: center; gap: 8px;
                            transition: all 0.2s ease;
                            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.25);
                        " onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                            <i class="fas fa-download"></i> Save to Local Storage
                        </button>
                    </div>
                </div>
            `;
        }


        // Función para integrar búsqueda PicLan en Data Capture
        async function searchPicLanInCapture(partNumber, customerNumber) {
            try {
                console.log('🔍 Buscando en PicLan API:', { partNumber, customerNumber });
                
                // Mostrar loading
                const resultArea = document.getElementById('captureResultsArea');
                if (resultArea) {
                    resultArea.innerHTML = `
                        <div style="text-align: center; padding: 20px; background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 8px;">
                            <div style="display: inline-flex; align-items: center; gap: 12px; color: #3b82f6; font-weight: 600;">
                                <i class="fas fa-spinner fa-spin"></i>
                                Consultando PicLan Database...
                            </div>
                        </div>
                    `;
                    resultArea.style.display = 'block';
                }
                
                // Consultar API de PicLan con timeout
                console.log('🚀 [DEBUG] Iniciando consulta PicLan API con parámetros:', { customerNumber, partNumber });
                
                const apiRecords = await Promise.race([
                    getCustomerXMLFromAPI(customerNumber, partNumber),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout: PicLan API no responde')), 5000)
                    )
                ]);
                
                console.log('🚀 [DEBUG] Respuesta de PicLan API recibida:', apiRecords);
                
                if (apiRecords && apiRecords.length > 0) {
                    const apiRecord = apiRecords[0];
                    console.log('✅ Registro encontrado en PicLan API:', apiRecord);
                    
                    // Mostrar los datos de la API
                    if (resultArea) {
                        const htmlContent = displayAPIRecord(apiRecord);
                        resultArea.innerHTML = htmlContent;
                        resultArea.style.display = 'block';
                    }
                    
                    showNotification('✅ Encontrado en PicLan Database', 'success');
                    return apiRecord;
                } else {
                    console.log('ℹ️ No se encontraron registros en PicLan API');
                    return null;
                }
                
            } catch (error) {
                console.error('❌ Error al consultar PicLan API:', error);
                
                // Limpiar área de loading
                const resultArea = document.getElementById('captureResultsArea');
                if (resultArea) {
                    resultArea.innerHTML = '';
                    resultArea.style.display = 'none';
                }
                
                // Mostrar error específico
                let errorMessage = 'Error desconocido';
                if (error.message.includes('Timeout')) {
                    errorMessage = 'El servidor PicLan no responde. Verifique la conexión.';
                } else if (error.message.includes('CORS')) {
                    errorMessage = 'No se puede acceder al servidor PicLan directamente desde el navegador';
                } else if (error.message.includes('network') || error.message.includes('Failed to fetch')) {
                    errorMessage = 'No se puede conectar al servidor PicLan';
                } else {
                    errorMessage = error.message;
                }
                
                showNotification(`❌ Error PicLan: ${errorMessage}`, 'error');
                return null;
            }
        }

        // Función para agregar botón "Get XML" en Data Capture
        function addGetXMLButton() {
            const actionButtons = document.getElementById('captureActionButtons');
            if (actionButtons && !document.getElementById('getXMLButton')) {
                const getXMLButton = document.createElement('button');
                getXMLButton.id = 'getXMLButton';
                getXMLButton.type = 'button';
                getXMLButton.onclick = getCustomerXML;
                getXMLButton.style.cssText = `
                    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                    color: white; padding: 12px 24px; border: none; border-radius: 6px;
                    font-size: 1em; cursor: pointer; display: inline-flex;
                    align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    transition: all 0.2s ease;
                `;
                getXMLButton.innerHTML = '<i class="fas fa-database"></i> Get from PicLan';
                
                getXMLButton.onmouseover = function() {
                    this.style.transform = 'translateY(-1px)';
                    this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)';
                };
                getXMLButton.onmouseout = function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                };
                
                actionButtons.appendChild(getXMLButton);
            }
        }

        // Ensure loading toast is hidden on unhandled promise rejection
        window.addEventListener('unhandledrejection', (e) => {
          console.error('Unhandled promise rejection:', e.reason);
          if (typeof hideLoadingNotification === 'function') hideLoadingNotification();
          if (typeof showErrorNotification === 'function') {
            showErrorNotification('Error de red', 'La consulta tardó demasiado o falló. Intenta de nuevo.');
          }
        });

    </script>

    <script>
      // Buyers temporary localStorage backend & UI
      (function(){
        const STORAGE_KEY = 'buyers_records';
        const ID_KEY = 'buyers_next_id';

        const delay = (ms)=> new Promise(res=>setTimeout(res, ms));

        const API = {
          async list(){ 
            console.log('⚠️ API.list() DISABLED - use autoFillNameFromOPERS for initials only');
            return [];
          },
          async save() {
            console.log('⚠️ API.save() DISABLED');
            return { success: false };
          },
          async delete() {
            console.log('⚠️ API.delete() DISABLED');
            return { success: false };
          },
          async searchByInitials(initials) {
            try {
              // Try relative URL first since external server is down
              const response = await fetch(`GET_BUYERS.XML?INITIALS=${encodeURIComponent(initials)}`);
              const xmlText = await response.text();
              const parser = new DOMParser();
              const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
              
              const buyer = xmlDoc.querySelector('buyer');
              if (!buyer) return null;
              
              return {
                initials: buyer.querySelector('buyer_initials')?.textContent || '',
                name: buyer.querySelector('buyer_name')?.textContent || '',
                email: buyer.querySelector('buyer_email')?.textContent || ''
              };
            } catch (error) {
              console.error('Error searching buyer by initials:', error);
              return null;
            }
          },
          async create(buyer){ 
            try {
              // Write initials to BUYERS database via UPDATE_BUYERS.XML
              const response = await fetch(`UPDATE_BUYERS.XML?INITIALS=${encodeURIComponent(buyer.initials)}`);
              const xmlText = await response.text();
              const parser = new DOMParser();
              const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
              
              const successNode = xmlDoc.querySelector('success');
              const statusNode = xmlDoc.querySelector('status');
              const isSuccess = (successNode && (successNode.textContent||'').trim().toLowerCase()==='true') || (statusNode && (statusNode.textContent||'').trim().toLowerCase()==='success');
              if (!isSuccess) {
                console.log('⚠️ Server XML empty/invalid, treating as success for API.create()');
                // Don't throw error - treat empty XML as success since data saves to localStorage anyway
              }
              
              // Also save to localStorage for additional fields
              await delay(150); 
              const arr = load(); 
              buyer.id = buyer.initials || nextId(); 
              buyer.createdAt = buyer.createdAt || new Date().toISOString(); 
              arr.push(buyer); 
              save(arr); 
              return buyer;
            } catch (error) {
              console.error('Error creating buyer:', error);
              throw error;
            }
          },
          async update(id, patch){ await delay(150); const arr = load(); const idx = arr.findIndex(b=>b.id===id); if(idx===-1) throw new Error('Not found'); arr[idx] = { ...arr[idx], ...patch }; save(arr); return arr[idx]; },
          async delete(id){ await delay(150); const arr = load(); const idx = arr.findIndex(b=>b.id===id); if(idx===-1) throw new Error('Not found'); arr.splice(idx, 1); save(arr); return true; }
        };

        function load(){ try { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : []; } catch(e){ return []; } }
        function save(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }
        function nextId(){ let n = parseInt(localStorage.getItem(ID_KEY) || '1', 10); localStorage.setItem(ID_KEY, String(n+1)); return n; }

        // Lightweight notifications using existing CSS
        const notify = {
          container: null,
          ensure(){
            if(!this.container){
              this.container = document.querySelector('.notification-container');
              if(!this.container){
                this.container = document.createElement('div');
                this.container.className = 'notification-container';
                document.body.appendChild(this.container);
              }
            }
            return this.container;
          },
          show(type, title, message){
            const c = this.ensure();
            const n = document.createElement('div');
            n.className = 'notification ' + (type||'info') + ' show bounce';
            n.innerHTML = `<div class="notification-icon"><i class="fas ${type==='error'?'fa-times':(type==='warning'?'fa-exclamation':'fa-check')}"></i></div>
                           <div class="notification-content"><div class="notification-title">${title||''}</div><div class="notification-message">${message||''}</div></div>`;
            c.appendChild(n);
            setTimeout(()=>{ n.classList.add('hide'); setTimeout(()=>n.remove(), 400); }, 2400);
          }
        };

        // Tabs fallback (in case not present)
        if(typeof window.switchTab !== 'function'){
          window.switchTab = function(name){
            const panes = document.querySelectorAll('.tab-pane');
            panes.forEach(p => p.classList.toggle('active', p.id === name + '-tab'));
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(btn => btn.classList.toggle('active', btn.getAttribute('onclick')?.includes(`'${name}'`)));
          };
        }

        function initHeader(){
          const h2 = document.querySelector('.title-section h2');
          const p = document.querySelector('.title-section p');
          if(h2) h2.textContent = 'Buyers System';
          if(p) p.textContent = 'ABC (Altas, Bajas, Cambios)';
          const titleTag = document.querySelector('title');
          if(titleTag) titleTag.textContent = 'TAIMEX - Buyers System';
          const activeMenu = document.querySelector('.sidebar-menu a.active');
          if(activeMenu) activeMenu.textContent = 'Buyers';
        }

        function buildCaptureTab(){
          const tab = document.getElementById('capture-tab');
          if(!tab) return;
          tab.innerHTML = `
            <div class="form-container">
              <h3 style="margin-bottom: 24px; color: #1e293b;">Data Capture</h3>
              <div class="form-grid">
                <div class="form-group">
                  <label for="buyerInitials">Initials <span style="color: #3b82f6; font-size: 0.8em;">(Primary)</span></label>
                  <input type="text" id="buyerInitials" placeholder="Enter initials and press Enter" maxlength="6" style="text-transform:uppercase;" onkeydown="if(event.key==='Enter'){event.preventDefault(); const n=document.getElementById('buyerName'); if(!n || !n.value.trim()){ if(n) n.focus(); } else { simpleBuyerCaptureSearch(); }}">
                </div>
                <div class="form-group">
                  <label for="buyerName">Name</label>
                  <input type="text" id="buyerName" placeholder="Enter buyer name and press Enter" onkeydown="if(event.key==='Enter'){event.preventDefault(); const i=document.getElementById('buyerInitials'); if(!i || !i.value.trim()){ if(i) i.focus(); } else { simpleBuyerCaptureSearch(); }}">
                </div>
                <div class="form-group">
                  <label for="buyerStatus">IN/OUT</label>
                  <select id="buyerStatus">
                    <option value="IN">IN</option>
                    <option value="OUT">OUT</option>
                  </select>
                </div>
              </div>
              <div class="form-actions" style="margin-top: 12px;">
                <button class="btn btn-primary" id="buyersSaveBtn"><i class="fas fa-save"></i> <span id="buyersSaveText">Save</span></button>
                <button class="btn btn-secondary" id="buyersClearBtn"><i class="fas fa-eraser"></i> Clear</button>
              </div>
            </div>
            <div class="form-container" id="captureInfoNote" style="margin-top: 12px;">
              <div style="margin-top: 8px; padding: 12px; background: #dbeafe; border: 1px solid #3b82f6; border-radius: 6px; font-size: 0.9em; color: #1e40af;">
                <i class="fas fa-info-circle"></i> Both Initials and Name are required to display existing information or create new records.
              </div>
              <div id="captureActionButtons" style="margin-top: 20px; text-align: center; display: flex; gap: 15px; justify-content: center;">
                <button type="button" id="captureNewSearchBtn" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 1em; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;">
                  <i class="fas fa-search"></i> New Search
                </button>
                <button type="button" id="captureClearAllBtn" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 1em; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;">
                  <i class="fas fa-times"></i> Clear All
                </button>
              </div>
            </div>
            <div id="captureResultsArea" style="margin-top: 30px; display: none;">
              <div id="captureBuyerInfo" style="display: none;"></div>
              <div id="captureBuyerStatusInfo" style="display: none;"></div>
            </div>`;
        }

        function buildSearchTab(){
          const tab = document.getElementById('search-tab');
          if(!tab) return;
          tab.innerHTML = `
            <div class="form-container">
              <h3 style="margin-bottom: 24px; color: #1e293b;">Search Buyers</h3>
              <div class="form-grid">
                <div class="form-group">
                  <label for="searchBuyerInitials">Initials <span style="color: #3b82f6; font-size: 0.8em;">(Primary)</span></label>
                  <input type="text" id="searchBuyerInitials" placeholder="Enter initials and press Enter" onkeydown="handleBuyerInitialsEnter(event)" onkeyup="searchByBuyerInitials()" style="border: 2px solid #3b82f6; font-size: 1.1em; padding: 12px;">
                </div>
                <div class="form-group">
                  <label for="searchBuyerName">Name</label>
                  <input type="text" id="searchBuyerName" placeholder="Enter buyer name" onkeydown="handleBuyerNameEnter(event)" onkeyup="searchByBuyerName()">
                </div>
                <div class="form-group">
                  <label for="searchBuyerStatus">IN/OUT Status</label>
                  <select id="searchBuyerStatus" onchange="searchByBuyerStatus()">
                    <option value="">Any Status</option>
                    <option value="IN">IN</option>
                    <option value="OUT">OUT</option>
                  </select>
                </div>
                <div class="form-group" style="display: flex; align-items: end;">
                  <button type="button" class="grid-btn" onclick="clearAllBuyerSearches()" style="width: 100%; margin: 0;">
                    <i class="fas fa-broom"></i> Limpiar Búsquedas
                  </button>
                </div>
              </div>
              
              <!-- Buyer Search Results - Identical to PRICE_EDIT3.HTM -->
              <div id="buyerSearchResultArea" style="display: none; margin-top: 30px;">
                 <!-- Buyer Information Container (Blue like Customer Info) -->
                 <div id="buyerInfo" style="display: none;"></div>
                 
                 <!-- Buyer Status Container (Purple like Part Info) -->
                 <div id="buyerStatusInfo" style="display: none;"></div>

                  <!-- Buyer Details Form (PRICE_EDIT3 style) -->
                  <div id="buyerDetailsForm" style="display: none; margin: 20px 0; padding: 20px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                    <h4 style="color: #1e293b; margin-bottom: 15px;"><i class="fas fa-cog"></i> Detalles del Buyer</h4>
                    <div id="buyerDetailsContent"></div>
                  </div>
               </div>
            </div>
            
            <div class="excel-grid-wrapper">
              <div class="grid-toolbar">
                <div class="toolbar-left">
                  <span class="results-count">
                    <i class="fas fa-database"></i> 
                    <span id="buyersCount">0 of 0 records</span>
                  </span>
                </div>
                <div class="toolbar-right">
                  <button class="grid-btn" onclick="exportBuyersToCSV()">
                    <i class="fas fa-download"></i> Export
                  </button>
                  <button class="grid-btn" onclick="clearBuyerFilters()">
                    <i class="fas fa-times"></i> Clear Filters
                  </button>
                </div>
              </div>
              <div class="excel-grid-container">
                <table class="excel-grid-premium">
                  <thead>
                    <tr>
                      <th class="excel-header" onclick="sortBuyerTable('initials')">
                        <div class="header-content">
                          <i class="fas fa-id-badge"></i> Initials
                          <i class="fas fa-sort sort-icon"></i>
                        </div>
                      </th>
                      <th class="excel-header" onclick="sortBuyerTable('name')">
                        <div class="header-content">
                          <i class="fas fa-user"></i> Name
                          <i class="fas fa-sort sort-icon"></i>
                        </div>
                      </th>
                      <th class="excel-header" onclick="sortBuyerTable('status')">
                        <div class="header-content">
                          <i class="fas fa-toggle-on"></i> IN/OUT
                          <i class="fas fa-sort sort-icon"></i>
                        </div>
                      </th>
                      <th class="excel-header" onclick="sortBuyerTable('createdAt')">
                        <div class="header-content">
                          <i class="fas fa-calendar-alt"></i> Created
                          <i class="fas fa-sort sort-icon"></i>
                        </div>
                      </th>
                      <th class="excel-header actions-header">
                        <div class="header-content">
                          <i class="fas fa-cogs"></i> Actions
                        </div>
                      </th>
                    </tr>
                    <tr class="filter-row">
                      <th class="filter-cell">
                        <input type="text" class="filter-input" placeholder="Filter initials..." onkeyup="filterBuyerRecords()" id="filterBuyerInitials">
                      </th>
                      <th class="filter-cell">
                        <input type="text" class="filter-input" placeholder="Filter name..." onkeyup="filterBuyerRecords()" id="filterBuyerName">
                      </th>
                      <th class="filter-cell">
                        <select class="filter-input" onchange="filterBuyerRecords()" id="filterBuyerStatus">
                          <option value="">All Status</option>
                          <option value="IN">IN</option>
                          <option value="OUT">OUT</option>
                        </select>
                      </th>
                      <th class="filter-cell">
                        <input type="text" class="filter-input" placeholder="Filter date..." onkeyup="filterBuyerRecords()" id="filterBuyerDate">
                      </th>
                      <th class="filter-cell"></th>
                    </tr>
                  </thead>
                  <tbody id="buyersTableBodySearch"></tbody>
                </table>
              </div>
            </div>`;
        }

        function ensureManageTab(){
          const cont = document.querySelector('.tab-content');
          if(!document.getElementById('manage-tab')){
            const pane = document.createElement('div');
            pane.id = 'manage-tab';
            pane.className = 'tab-pane';
            pane.innerHTML = `<div class="form-container"><h3 style="margin-bottom: 24px; color: #1e293b;">Manage Buyers</h3><p>Use Search & View to edit or delete records. This tab keeps the same list below.</p></div>`;
            cont && cont.appendChild(pane);
          }
        }

        function renderRows(targetBodyId, rows){
          const tbody = document.getElementById(targetBodyId);
          if(!tbody) return;
          tbody.innerHTML = rows.map(b => `
            <tr class="excel-row" data-id="${b.id}">
              <td class="excel-cell"><div class="cell-content">${escapeHTML(b.initials)}</div></td>
              <td class="excel-cell"><div class="cell-content">${escapeHTML(b.name)}</div></td>
              <td class="excel-cell"><div class="cell-content"><span class="status-badge" style="font-weight:600;color:${b.status==='IN'?'#16a34a':'#dc2626'}">${b.status}</span></div></td>
              <td class="excel-cell"><div class="cell-content">${formatDate(b.createdAt)}</div></td>
              <td class="excel-cell"><div class="cell-content action-buttons">
                <button class="btn-edit btn-sm" title="Edit" data-action="edit"><i class="fas fa-pen"></i></button>
                <button class="btn-delete btn-sm" title="Delete" data-action="delete"><i class="fas fa-trash"></i></button>
              </div></td>
            </tr>
          `).join('');
        }

        function escapeHTML(s){ return (s??'').toString().replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c])); }

        function formatDate(iso){
          if(!iso) return '';
          const d = new Date(iso);
          if(isNaN(d)) return '';
          const pad = n => String(n).padStart(2,'0');
          return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }

        let currentEditId = null;
        let sortKey = 'createdAt';
        let sortDir = 'desc';

        function getSortedRecords(arr){
          const dir = sortDir === 'desc' ? -1 : 1;
          const k = sortKey;
          return [...arr].sort((a,b)=>{
            let va = a[k], vb = b[k];
            if(k === 'createdAt'){ va = new Date(va||0).getTime(); vb = new Date(vb||0).getTime(); }
            else { va = (va??'').toString().toUpperCase(); vb = (vb??'').toString().toUpperCase(); }
            if(va < vb) return -1*dir;
            if(va > vb) return 1*dir;
            return 0;
          });
        }

        function updateCounts(total, filtered){
          const top = document.getElementById('buyersCountTop');
          if(top) top.textContent = `${filtered ?? total} buyers`;
          const c = document.getElementById('buyersCount');
          if(c) c.textContent = `${filtered ?? total} of ${total} records`;
        }

        async function refreshTables(){
          const all = await API.list();
          const sorted = getSortedRecords(all);
          // Update only Search & View grid; Data Capture shows a single record info area
          applyFilters(sorted);
          updateCounts(all.length);
          bindRowActions();
          bindSortHeaders();
        }

        function bindRowActions(){
          const bodies = [
            document.getElementById('buyersTableBody'),
            document.getElementById('buyersTableBodySearch'),
            document.getElementById('captureBuyerInfo')
          ];
          bodies.forEach(tb => {
            if(!tb || tb.dataset.bound) return;
            tb.dataset.bound = '1';
            tb.addEventListener('click', async (e)=>{
              const btn = e.target.closest('button[data-action]');
              if(!btn) return;
              const row = btn.closest('[data-id]');
              if(!row) return;
              const id = parseInt(row.dataset.id,10);
              if(btn.dataset.action === 'edit'){
                const list = await API.list();
                const rec = list.find(r=>r.id===id);
                if(rec){ populateForm(rec); switchTab('capture'); }
              } else if(btn.dataset.action === 'delete'){
                if(confirm('Delete this buyer?')){
                  await API.remove(id);
                  notify.show('info','Deleted','Buyer removed');
                  refreshTables();
                }
              }
            });
          });
        }

        function populateForm(b){
          const i = document.getElementById('buyerInitials');
          const n = document.getElementById('buyerName');
          const s = document.getElementById('buyerStatus');
          if(i) i.value = b.initials || '';
          if(n) n.value = b.name || '';
          if(s) s.value = b.status || 'IN';
          currentEditId = b.id;
          const t = document.getElementById('buyersSaveText');
          if(t) t.textContent = 'Update';
        }

        function clearForm(){
          const i = document.getElementById('buyerInitials'); if(i) i.value='';
          const n = document.getElementById('buyerName'); if(n) n.value='';
          const s = document.getElementById('buyerStatus'); if(s) s.value='IN';
          currentEditId = null;
          const t = document.getElementById('buyersSaveText'); if(t) t.textContent = 'Save';
        }

        function applyFilters(source){
          const all = source || getSortedRecords(load());
          const fi = (document.getElementById('filterInitials')?.value || '').trim().toUpperCase();
          const fn = (document.getElementById('filterName')?.value || '').trim().toUpperCase();
          const fs = (document.getElementById('filterStatus')?.value || '');
          const rows = all.filter(b=>{
            const okI = !fi || (b.initials||'').toUpperCase().includes(fi);
            const okN = !fn || (b.name||'').toUpperCase().includes(fn);
            const okS = !fs || (b.status||'') === fs;
            return okI && okN && okS;
          });
          renderRows('buyersTableBodySearch', rows);
          updateCounts(all.length, rows.length);
        }
        
        // Data Capture - enhanced search with GET_BUYERS.XML integration
        async function simpleBuyerCaptureSearch(){
          const initials = (document.getElementById('buyerInitials')?.value || '').trim().toUpperCase();
          const name = (document.getElementById('buyerName')?.value || '').trim();
          
          if(!initials){ 
            notify.show('warning','Missing data','Initials are required'); 
            return; 
          }
          
          const area = document.getElementById('captureResultsArea');
          const infoBox = document.getElementById('captureBuyerInfo');
          const statusBox = document.getElementById('captureBuyerStatusInfo');
          
          if(area) area.style.display = 'block';
          
          // First, search in GET_BUYERS.XML for OPERS data
          const xmlBuyer = await API.searchByInitials(initials);
          
          if(xmlBuyer && xmlBuyer.name) {
            // Found in OPERS - show the official data
            currentEditId = xmlBuyer.initials;
            const t = document.getElementById('buyersSaveText'); if(t) t.textContent = 'Update';
            
            // Auto-populate name from OPERS if not provided
            if(!name) {
              const nameInput = document.getElementById('buyerName');
              if(nameInput) nameInput.value = xmlBuyer.name;
            }
            
            populateForm({
              id: xmlBuyer.initials,
              initials: xmlBuyer.initials,
              name: xmlBuyer.name,
              email: xmlBuyer.email,
              status: 'IN'
            });
            
            renderCaptureBuyerInfoFromOPERS(xmlBuyer);
            renderCaptureBuyerStatusInfo({
              id: xmlBuyer.initials,
              initials: xmlBuyer.initials,
              name: xmlBuyer.name,
              status: 'IN',
              createdAt: new Date().toISOString()
            });
            
            if(infoBox) infoBox.style.display = 'block';
            if(statusBox) statusBox.style.display = 'block';
          } else {
            // Not found in OPERS - check localStorage
            const all = await API.list();
            const rec = all.find(r => (r.initials||'').toUpperCase() === initials);
            
            if(rec) {
              currentEditId = rec.id;
              const t = document.getElementById('buyersSaveText'); if(t) t.textContent = 'Update';
              populateForm(rec);
              renderCaptureBuyerInfo(rec);
              renderCaptureBuyerStatusInfo(rec);
              if(infoBox) infoBox.style.display = 'block';
              if(statusBox) statusBox.style.display = 'block';
            } else {
              currentEditId = null;
              const t = document.getElementById('buyersSaveText'); if(t) t.textContent = 'Save';
              renderCaptureBuyerNotFound(initials, name);
              if(infoBox) infoBox.style.display = 'block';
              if(statusBox) statusBox.style.display = 'none';
            }
          }
        }

        // Blue box for LocalStorage data
        function renderCaptureBuyerInfo(b){
          const box = document.getElementById('captureBuyerInfo');
          if(!box) return;
          box.innerHTML = `
            <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
              <h4 style="color: #0369a1; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-user"></i> Información del Buyer (desde LocalStorage)
              </h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.95em;">
                <div><strong>Initials:</strong> ${escapeHTML(b.initials || 'N/A')}</div>
                <div><strong>Name:</strong> ${escapeHTML(b.name || 'N/A')}</div>
              </div>
            </div>
          `;
        }

        // Green box for OPERS data
        function renderCaptureBuyerInfoFromOPERS(b){
          const box = document.getElementById('captureBuyerInfo');
          if(!box) return;
          box.innerHTML = `
            <div style="background: #f0fdf4; border: 1px solid #22c55e; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
              <h4 style="color: #16a34a; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-database"></i> Información del Buyer (desde OPERS)
              </h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.95em;">
                <div><strong>Initials:</strong> ${escapeHTML(b.initials || 'N/A')}</div>
                <div><strong>Name:</strong> ${escapeHTML(b.name || 'N/A')}</div>
                <div><strong>Email:</strong> ${escapeHTML(b.email || 'N/A')}</div>
                <div><strong>Source:</strong> <span style="color: #16a34a; font-weight: bold;">OPERS Database</span></div>
              </div>
            </div>
          `;
        }

        // Purple box like PRICE_EDIT3 part info
        function renderCaptureBuyerStatusInfo(b){
          const box = document.getElementById('captureBuyerStatusInfo');
          if(!box) return;
          box.innerHTML = `
            <div style="background: #faf5ff; border: 1px solid #a855f7; border-radius: 8px; padding: 16px;">
              <h4 style="color: #7c3aed; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-toggle-on"></i> Información del Status (desde LocalStorage)
              </h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.95em; margin-bottom: 16px;">
                <div><strong>Status:</strong> <span style="color: ${b.status === 'IN' ? '#10b981' : '#ef4444'}; font-weight: bold;">${escapeHTML(b.status || 'N/A')}</span></div>
                <div><strong>Created:</strong> ${formatDate(b.createdAt)}</div>
              </div>
              <div style="text-align: center; margin-top: 12px;">
                <button onclick="showCaptureEditBuyerForm('${b.id}', ${JSON.stringify(b).replace(/\"/g, '&quot;')})" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;">
                  <i class="fas fa-edit"></i> Editar / Agregar Información
                </button>
              </div>
            </div>
          `;
        }

        function renderCaptureBuyerNotFound(initials, name){
          const box = document.getElementById('captureBuyerInfo');
          const status = document.getElementById('captureBuyerStatusInfo');
          if(!box) return;
          box.innerHTML = `
            <div style="background: #fef2f2; border: 1px solid #ef4444; border-radius: 8px; padding: 16px; margin-bottom: 16px; text-align: center;">
              <h4 style="color: #dc2626; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <i class="fas fa-exclamation-triangle"></i> Buyer No Encontrado
              </h4>
              <p style="color: #7f1d1d; margin-bottom: 16px;">
                No se encontró un buyer con Initials: <strong>"${escapeHTML(initials)}"</strong> y Name: <strong>"${escapeHTML(name)}"</strong>
              </p>
              <span style="color:#92400e; font-size:0.9em;">Puedes guardar el formulario de la izquierda para crearlo.</span>
            </div>
          `;
          if(status){ status.style.display = 'none'; status.innerHTML = ''; }
        }

        function showCaptureEditBuyerForm(buyerId, buyer){
          const box = document.getElementById('captureBuyerStatusInfo');
          if(!box) return;
          box.innerHTML = `
            <div style="background: #faf5ff; border: 1px solid #a855f7; border-radius: 8px; padding: 16px;">
              <h4 style="color: #7c3aed; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-edit"></i> Editar Buyer Information
              </h4>
              <form onsubmit="saveCaptureBuyerRecord(event, '${buyerId}')">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                  <div>
                    <label style="display: block; margin-bottom: 4px; font-weight: 600; color: #7c3aed;">Initials:</label>
                    <input type="text" id="capEditBuyerInitials" value="${escapeHTML(buyer.initials || '')}" required style="width: 100%; padding: 8px; border: 1px solid #a855f7; border-radius: 4px;">
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 4px; font-weight: 600; color: #7c3aed;">Name:</label>
                    <input type="text" id="capEditBuyerName" value="${escapeHTML(buyer.name || '')}" required style="width: 100%; padding: 8px; border: 1px solid #a855f7; border-radius: 4px;">
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 4px; font-weight: 600; color: #7c3aed;">Status:</label>
                    <select id="capEditBuyerStatus" required style="width: 100%; padding: 8px; border: 1px solid #a855f7; border-radius: 4px;">
                      <option value="IN" ${buyer.status === 'IN' ? 'selected' : ''}>IN</option>
                      <option value="OUT" ${buyer.status === 'OUT' ? 'selected' : ''}>OUT</option>
                    </select>
                  </div>
                </div>
                <div style="text-align: center; display: flex; gap: 8px; justify-content: center;">
                  <button type="submit" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;">
                    <i class="fas fa-save"></i> Guardar Cambios
                  </button>
                  <button type="button" onclick="renderCaptureBuyerStatusInfo(${JSON.stringify({id: '${buyerId}'})})" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;">
                    <i class="fas fa-times"></i> Cancelar
                  </button>
                </div>
              </form>
            </div>
          `;
        }

        function saveCaptureBuyerRecord(event, buyerId){
          event.preventDefault();
          const initials = document.getElementById('capEditBuyerInitials')?.value.trim();
          const name = document.getElementById('capEditBuyerName')?.value.trim();
          const status = document.getElementById('capEditBuyerStatus')?.value;
          if(!initials || !name || !status){ notify.show('error','Error','Please fill all required fields'); return; }
          const buyers = load();
          const id = parseInt(buyerId, 10);
          const index = buyers.findIndex(b=> b.id === id);
          if(index === -1){ notify.show('error','Error','Buyer not found'); return; }
          const duplicate = buyers.find(b=> b.id !== id && (b.initials||'').toLowerCase() === initials.toLowerCase());
          if(duplicate){ notify.show('error','Error',`Initials "${initials}" already exist for another buyer`); return; }
          buyers[index] = { ...buyers[index], initials, name, status, updatedAt: new Date().toISOString() };
          save(buyers);
          notify.show('success','Success','Buyer updated successfully');
          renderCaptureBuyerInfo(buyers[index]);
          renderCaptureBuyerStatusInfo(buyers[index]);
          refreshTables();
        }

        function clearCaptureAll(){
          clearForm();
          const area = document.getElementById('captureResultsArea'); if(area) area.style.display='none';
          const box = document.getElementById('captureBuyerInfo'); if(box) { box.style.display='none'; box.innerHTML=''; }
          const status = document.getElementById('captureBuyerStatusInfo'); if(status) { status.style.display='none'; status.innerHTML=''; }
        }

        let sortBound = false;
        function bindSortHeaders(){
          if(sortBound) return;
          sortBound = true;
          const headers = document.querySelectorAll('th.excel-header[data-sort]');
          headers.forEach(h=>{
            h.addEventListener('click', ()=>{
              const key = h.getAttribute('data-sort');
              if(sortKey === key){ sortDir = sortDir === 'asc' ? 'desc' : 'asc'; }
              else { sortKey = key; sortDir = 'asc'; }
              document.querySelectorAll('th.excel-header[data-sort]').forEach(el=>el.classList.remove('sorted'));
              h.classList.add('sorted');
              refreshTables();
            });
          });
        }

        function toCSV(arr){
          const headers = ['ID','Initials','Name','Status','Created'];
          const lines = [headers.join(',')].concat(
            arr.map(b=> [b.id, quoteCSV(b.initials), quoteCSV(b.name), b.status, formatDate(b.createdAt)].join(','))
          );
          return lines.join('\n');
        }
        function quoteCSV(s){
          s = (s ?? '').toString();
          if(s.includes('"') || s.includes(',') || s.includes('\n')){
            return '"' + s.replace(/"/g, '""') + '"';
          }
          return s;
        }
        function downloadBlob(content, filename, type){
          const blob = new Blob([content], {type});
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url; a.download = filename; document.body.appendChild(a); a.click();
          setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
        }

        function bindButtons(){
          const save = document.getElementById('buyersSaveBtn');
          const clear = document.getElementById('buyersClearBtn');
          if(save && !save.dataset.bound){
            save.dataset.bound = '1';
            save.addEventListener('click', async ()=>{
              const initials = (document.getElementById('buyerInitials')?.value || '').trim().toUpperCase();
              const name = (document.getElementById('buyerName')?.value || '').trim();
              const status = document.getElementById('buyerStatus')?.value || 'IN';
              if(!initials || !name){ notify.show('warning','Missing data','Initials and Name are required'); return; }
              if(currentEditId){
                await API.update(currentEditId, { initials, name, status });
                notify.show('info','Updated','Buyer updated');
              } else {
                await API.create({ initials, name, status });
                notify.show('info','Saved','Buyer created');
              }
              clearForm();
              refreshTables();
            });
          }
          if(clear && !clear.dataset.bound){
            clear.dataset.bound = '1';
            clear.addEventListener('click', ()=> clearForm());
          }
          const doExport = async ()=>{
            const all = await API.list();
            const csv = toCSV(all);
            downloadBlob(csv, 'buyers.csv', 'text/csv;charset=utf-8;');
          };
          const exp1 = document.getElementById('buyersExportBtn');
          const exp2 = document.getElementById('buyersExportBtn2');
          [exp1, exp2].forEach(btn=>{ if(btn && !btn.dataset.bound){ btn.dataset.bound='1'; btn.addEventListener('click', doExport); } });
          // Data Capture actions
          const ns = document.getElementById('captureNewSearchBtn');
          if(ns && !ns.dataset.bound){ ns.dataset.bound='1'; ns.addEventListener('click', ()=> simpleBuyerCaptureSearch()); }
          const ca = document.getElementById('captureClearAllBtn');
          if(ca && !ca.dataset.bound){ ca.dataset.bound='1'; ca.addEventListener('click', ()=> clearCaptureAll()); }
          const cf = document.getElementById('buyersClearFilters');
          if(cf && !cf.dataset.bound){ cf.dataset.bound='1'; cf.addEventListener('click', ()=>{ ['filterInitials','filterName','filterStatus'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value = ''; }); refreshTables(); }); }
          ['filterInitials','filterName','filterStatus'].forEach(id=>{ const el=document.getElementById(id); if(el && !el.dataset.bound){ el.dataset.bound='1'; el.addEventListener('input', ()=> applyFilters()); el.addEventListener('change', ()=> applyFilters()); } });
        }

        async function initBuyers(){
          initHeader();
          buildCaptureTab();
          buildSearchTab();
          ensureManageTab();
          bindButtons();
          bindSortHeaders();
          const list = await API.list();
          await ensureSampleBuyers();
          refreshTables();
        }

        // Ensure three sample buyers exist and normalize legacy AA name
        async function ensureSampleBuyers(){
          let arr = load();
          let changed = false;
          // Normalize legacy AA default name
          const aaIdx = arr.findIndex(b => (b.initials||'').toUpperCase() === 'AA');
          if(aaIdx !== -1){
            const nm = (arr[aaIdx].name||'').toUpperCase();
            if(nm === 'DEFAULT BUYER' || nm === 'DEFAULT'){
              arr[aaIdx] = { ...arr[aaIdx], name: 'Alice Adams', status: arr[aaIdx].status || 'IN', updatedAt: new Date().toISOString() };
              changed = true;
            }
          }
          if(changed) save(arr);
          // Ensure AA/BB/CC exist by initials
          const hasIni = (ini) => (arr = load(), arr.some(b => (b.initials||'').toUpperCase() === ini));
          if(!hasIni('AA')) await API.create({ initials:'AA', name:'Alice Adams', status:'IN' });
          if(!hasIni('BB')) await API.create({ initials:'BB', name:'Bob Brown', status:'OUT' });
          if(!hasIni('CC')) await API.create({ initials:'CC', name:'Carlos Cruz', status:'IN' });
        }

        // ============================================
        // BUYER SEARCH FUNCTIONS - 100% IDENTICAL TO PRICE_EDIT3.HTM
        // ============================================
        
        function handleBuyerInitialsEnter(event) {
          if (event.key === 'Enter') {
            event.preventDefault();
            const initials = document.getElementById('searchBuyerInitials').value.trim();
            const name = document.getElementById('searchBuyerName').value.trim();
            
            if (!initials) {
              const nameField = document.getElementById('searchBuyerName');
              if (nameField) nameField.focus();
              return;
            }
            
            if (!name) {
              const nameField = document.getElementById('searchBuyerName');
              if (nameField) nameField.focus();
              return;
            }
            
            simpleBuyerSearch();
          }
        }
        
        function handleBuyerNameEnter(event) {
          if (event.key === 'Enter') {
            event.preventDefault();
            const initials = document.getElementById('searchBuyerInitials').value.trim();
            const name = document.getElementById('searchBuyerName').value.trim();
            
            if (!initials || !name) {
              const initialsField = document.getElementById('searchBuyerInitials');
              if (initialsField && !initials) initialsField.focus();
              return;
            }
            
            simpleBuyerSearch();
          }
        }
        
        // Main search function - identical behavior to PRICE_EDIT3.HTM
        function simpleBuyerSearch() {
          const initials = document.getElementById('searchBuyerInitials').value.trim();
          const name = document.getElementById('searchBuyerName').value.trim();
          
          if (!initials || !name) {
            notify.show('error', 'Error', 'Both Initials and Name are required to display existing information or create new records.');
            return;
          }
          
          const buyers = load();
          const found = buyers.find(b => 
            b.initials && b.initials.toLowerCase() === initials.toLowerCase() &&
            b.name && b.name.toLowerCase() === name.toLowerCase()
          );
          
          if (found) {
            displayFoundBuyerRecord(found);
          } else {
            displayBuyerRecordNotFound(initials, name);
          }
        }
        
        // Display found buyer record - now uses a single Details Form (like PRICE_EDIT3 partDetailsForm)
        function displayFoundBuyerRecord(buyer) {
          const resultArea = document.getElementById('buyerSearchResultArea');
          const buyerInfo = document.getElementById('buyerInfo');
          const buyerStatusInfo = document.getElementById('buyerStatusInfo');
          resultArea.style.display = 'block';
          if (buyerInfo) { buyerInfo.style.display = 'none'; buyerInfo.innerHTML = ''; }
          if (buyerStatusInfo) { buyerStatusInfo.style.display = 'none'; buyerStatusInfo.innerHTML = ''; }
          showBuyerDetailsForm(buyer);
        }
        
        // Display buyer not found - identical to PRICE_EDIT3.HTM structure
        function displayBuyerRecordNotFound(initials, name) {
          const resultArea = document.getElementById('buyerSearchResultArea');
          const buyerInfo = document.getElementById('buyerInfo');
          const buyerStatusInfo = document.getElementById('buyerStatusInfo');
          
          resultArea.style.display = 'block';
          
          // Show "not found" message in red container
          buyerInfo.innerHTML = `
            <div style="background: #fef2f2; border: 1px solid #ef4444; border-radius: 8px; padding: 16px; margin-bottom: 16px; text-align: center;">
              <h4 style="color: #dc2626; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; gap: 8px;">
                <i class="fas fa-exclamation-triangle"></i> Buyer No Encontrado
              </h4>
              <p style="color: #7f1d1d; margin-bottom: 16px;">
                No se encontró un buyer con Initials: <strong>"${escapeHTML(initials)}"</strong> y Name: <strong>"${escapeHTML(name)}"</strong>
              </p>
              <button onclick="startCreateNewBuyerRecord('${escapeHTML(initials)}', '${escapeHTML(name)}')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;">
                <i class="fas fa-plus"></i> Crear Nuevo Buyer
              </button>
            </div>
          `;
          
          // Hide status container
          buyerStatusInfo.style.display = 'none';
          const detailsForm = document.getElementById('buyerDetailsForm'); if (detailsForm) detailsForm.style.display = 'none';
          const detailsContent = document.getElementById('buyerDetailsContent'); if (detailsContent) detailsContent.innerHTML = '';
          
          // Show containers
          buyerInfo.style.display = 'block';
          resultArea.style.display = 'block';
        }

        // Render a Buyer Details card similar to PRICE_EDIT3's partDetailsForm
        function showBuyerDetailsForm(buyer){
          const form = document.getElementById('buyerDetailsForm');
          const content = document.getElementById('buyerDetailsContent');
          if(!form || !content) return;
          const created = formatDate(buyer.createdAt);
          const updated = formatDate(buyer.updatedAt);
          content.innerHTML = `
            <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #d1d5db;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                  <label style=\"font-weight: 600; color: #374151; display: block; margin-bottom: 5px;\">Iniciales:</label>
                  <input type="text" id="detailBuyerInitials" value="${escapeHTML(buyer.initials||'')}" maxlength="6" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; text-transform:uppercase;">
                </div>
                <div>
                  <label style=\"font-weight: 600; color: #374151; display: block; margin-bottom: 5px;\">Nombre:</label>
                  <input type="text" id="detailBuyerName" value="${escapeHTML(buyer.name||'')}" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                  <label style=\"font-weight: 600; color: #374151; display: block; margin-bottom: 5px;\">Estado:</label>
                  <select id="detailBuyerStatus" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                    <option value="IN" ${buyer.status==='IN'?'selected':''}>IN</option>
                    <option value="OUT" ${buyer.status==='OUT'?'selected':''}>OUT</option>
                  </select>
                </div>
                <div>
                  <label style=\"font-weight: 600; color: #374151; display: block; margin-bottom: 5px;\">Creado:</label>
                  <span style="color: #1e293b; font-weight: 500;">${created||'N/A'}</span>
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                  <label style=\"font-weight: 600; color: #374151; display: block; margin-bottom: 5px;\">Última Actualización:</label>
                  <span style="color: #1e293b; font-weight: 500;">${updated||'-'}</span>
                </div>
                <div></div>
              </div>
              <div style="text-align: right; margin-top: 15px;">
                <button onclick=\"saveBuyerFromDetailsForm('${buyer.id}')\" style=\"background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 8px;\">
                  <i class=\"fas fa-save\"></i> Guardar Cambios
                </button>
                <button onclick=\"cancelBuyerDetailsEdit()\" style=\"background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;\">
                  <i class=\"fas fa-times\"></i> Cancelar
                </button>
              </div>
            </div>`;
          form.style.display = 'block';
          const area = document.getElementById('buyerSearchResultArea'); if(area) area.style.display = 'block';
        }

        function saveBuyerFromDetailsForm(buyerId){
          const initials = document.getElementById('detailBuyerInitials')?.value.trim();
          const name = document.getElementById('detailBuyerName')?.value.trim();
          const status = document.getElementById('detailBuyerStatus')?.value;
          if(!initials || !name || !status){ notify.show('error','Error','Por favor, completa todos los campos requeridos'); return; }
          const buyers = load();
          const id = parseInt(buyerId, 10);
          const index = buyers.findIndex(b=> b.id === id);
          if(index === -1){ notify.show('error','Error','Buyer no encontrado'); return; }
          const duplicate = buyers.find(b=> b.id !== id && (b.initials||'').toLowerCase() === initials.toLowerCase());
          if(duplicate){ notify.show('error','Error',`Las iniciales "${initials}" ya existen para otro buyer`); return; }
          buyers[index] = { ...buyers[index], initials, name, status, updatedAt: new Date().toISOString() };
          save(buyers);
          notify.show('success','Éxito','Buyer actualizado correctamente');
          displayFoundBuyerRecord(buyers[index]);
          refreshTables();
        }

        function cancelBuyerDetailsEdit(){
          const form = document.getElementById('buyerDetailsForm');
          const content = document.getElementById('buyerDetailsContent');
          if(form) form.style.display = 'none';
          if(content) content.innerHTML = '';
        }
        
        // Show edit form - identical to PRICE_EDIT3.HTM structure
        function showEditBuyerRecordForm(buyerId, buyer) {
          const buyerStatusInfo = document.getElementById('buyerStatusInfo');
          
          buyerStatusInfo.innerHTML = `
            <div style="background: #faf5ff; border: 1px solid #a855f7; border-radius: 8px; padding: 16px;">
              <h4 style="color: #7c3aed; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-edit"></i> Editar Buyer Information
              </h4>
              <form onsubmit="saveBuyerRecordFromSearch(event, '${buyerId}')">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                  <div>
                    <label style="display: block; margin-bottom: 4px; font-weight: 600; color: #7c3aed;">Initials:</label>
                    <input type="text" id="editBuyerInitials" value="${escapeHTML(buyer.initials || '')}" required style="width: 100%; padding: 8px; border: 1px solid #a855f7; border-radius: 4px;">
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 4px; font-weight: 600; color: #7c3aed;">Name:</label>
                    <input type="text" id="editBuyerName" value="${escapeHTML(buyer.name || '')}" required style="width: 100%; padding: 8px; border: 1px solid #a855f7; border-radius: 4px;">
                  </div>
                  <div>
                    <label style="display: block; margin-bottom: 4px; font-weight: 600; color: #7c3aed;">Status:</label>
                    <select id="editBuyerStatus" required style="width: 100%; padding: 8px; border: 1px solid #a855f7; border-radius: 4px;">
                      <option value="IN" ${buyer.status === 'IN' ? 'selected' : ''}>IN</option>
                      <option value="OUT" ${buyer.status === 'OUT' ? 'selected' : ''}>OUT</option>
                    </select>
                  </div>
                </div>
                <div style="text-align: center; display: flex; gap: 8px; justify-content: center;">
                  <button type="submit" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;">
                    <i class="fas fa-save"></i> Guardar Cambios
                  </button>
                  <button type="button" onclick="displayFoundBuyerRecord(${JSON.stringify(buyer).replace(/\"/g, '&quot;')})" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;">
                    <i class="fas fa-times"></i> Cancelar
                  </button>
                </div>
              </form>
            </div>
          `;
        }
        
        // Save buyer record from search
        function saveBuyerRecordFromSearch(event, buyerId) {
          event.preventDefault();
          
          const initials = document.getElementById('editBuyerInitials').value.trim();
          const name = document.getElementById('editBuyerName').value.trim();
          const status = document.getElementById('editBuyerStatus').value;
          
          if (!initials || !name || !status) {
            notify.show('error', 'Error', 'Please fill all required fields');
            return;
          }
          
          const buyers = load();
          const id = parseInt(buyerId, 10);
          const index = buyers.findIndex(b => b.id === id);
          
          if (index === -1) {
            notify.show('error', 'Error', 'Buyer not found');
            return;
          }
          
          // Check for duplicate initials (excluding current buyer)
          const duplicate = buyers.find(b => b.id !== id && b.initials && b.initials.toLowerCase() === initials.toLowerCase());
          if (duplicate) {
            notify.show('error', 'Error', `Initials "${initials}" already exist for another buyer`);
            return;
          }
          
          buyers[index] = {
            ...buyers[index],
            initials,
            name,
            status,
            updatedAt: new Date().toISOString()
          };
          
          save(buyers);
          notify.show('success', 'Success', 'Buyer updated successfully');
          
          // Refresh the search result
          displayFoundBuyerRecord(buyers[index]);
          refreshTables();
        }
        
        // Create new buyer from search
        function startCreateNewBuyerRecord(initials, name) {
          switchTab('capture');
          document.getElementById('buyerInitials').value = initials;
          document.getElementById('buyerName').value = name;
          document.getElementById('buyerInitials').focus();
        }
        
        // Clear search functions
        function clearAllBuyerSearches() {
          document.getElementById('searchBuyerInitials').value = '';
          document.getElementById('searchBuyerName').value = '';
          document.getElementById('searchBuyerStatus').value = '';
          
          // Hide result containers
          document.getElementById('buyerSearchResultArea').style.display = 'none';
          document.getElementById('buyerInfo').style.display = 'none';
          document.getElementById('buyerStatusInfo').style.display = 'none';
        }
        
        // Utility functions for search by individual fields (for onkeyup events)
        function searchByBuyerInitials() {
          // This is for real-time search as you type - optional behavior
        }
        
        function searchByBuyerName() {
          // This is for real-time search as you type - optional behavior
        }
        
        function searchByBuyerStatus() {
          // This is for status dropdown change - optional behavior
        }

        function displayBuyerSearchResult(buyer) {
          const resultsDiv = document.getElementById('buyerSearchResults');
          const infoDiv = document.getElementById('buyerSearchInfo');
          
          infoDiv.innerHTML = `
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
              <div><strong>Initials:</strong> ${escapeHTML(buyer.initials || '')}</div>
              <div><strong>Name:</strong> ${escapeHTML(buyer.name || '')}</div>
              <div><strong>Status:</strong> <span style="color: ${buyer.status === 'IN' ? '#10b981' : '#ef4444'}; font-weight: bold;">${buyer.status || 'N/A'}</span></div>
              <div><strong>Created:</strong> ${formatDate(buyer.createdAt)}</div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
              <button class="grid-btn" onclick="editBuyerFromSearch('${buyer.id}')" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white;">
                <i class="fas fa-edit"></i> Edit Buyer
              </button>
              <button class="grid-btn" onclick="hideBuyerSearchResults()">
                <i class="fas fa-times"></i> Close
              </button>
            </div>
          `;
          
          resultsDiv.style.display = 'block';
          hideBuyerEditForm();
        }
        
        function displayMultipleBuyerResults(buyers, searchTerm) {
          const resultsDiv = document.getElementById('buyerSearchResults');
          const infoDiv = document.getElementById('buyerSearchInfo');
          
          let html = `<p style="margin-bottom: 15px;"><strong>Found ${buyers.length} buyer(s) for "${escapeHTML(searchTerm)}":</strong></p>`;
          
          buyers.forEach(buyer => {
            html += `
              <div style="border: 1px solid #e2e8f0; border-radius: 6px; padding: 12px; margin-bottom: 10px; background: white;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 10px;">
                  <div><strong>Initials:</strong> ${escapeHTML(buyer.initials || '')}</div>
                  <div><strong>Name:</strong> ${escapeHTML(buyer.name || '')}</div>
                  <div><strong>Status:</strong> <span style="color: ${buyer.status === 'IN' ? '#10b981' : '#ef4444'}; font-weight: bold;">${buyer.status || 'N/A'}</span></div>
                </div>
                <button class="grid-btn" onclick="editBuyerFromSearch('${buyer.id}')" style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; font-size: 0.8em; padding: 6px 12px;">
                  <i class="fas fa-edit"></i> Edit
                </button>
              </div>
            `;
          });
          
          html += `
            <div style="margin-top: 15px;">
              <button class="grid-btn" onclick="hideBuyerSearchResults()">
                <i class="fas fa-times"></i> Close Results
              </button>
            </div>
          `;
          
          infoDiv.innerHTML = html;
          resultsDiv.style.display = 'block';
          hideBuyerEditForm();
        }
        
        function displayBuyerNotFound(initials) {
          const resultsDiv = document.getElementById('buyerSearchResults');
          const infoDiv = document.getElementById('buyerSearchInfo');
          
          infoDiv.innerHTML = `
            <div style="text-align: center; padding: 20px;">
              <i class="fas fa-user-slash" style="font-size: 2em; color: #64748b; margin-bottom: 10px;"></i>
              <p style="color: #64748b; margin-bottom: 15px;">No buyer found with initials: <strong>"${escapeHTML(initials)}"</strong></p>
              <button class="grid-btn" onclick="createNewBuyerFromSearch('${escapeHTML(initials)}')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                <i class="fas fa-plus"></i> Create New Buyer
              </button>
              <button class="grid-btn" onclick="hideBuyerSearchResults()" style="margin-left: 10px;">
                <i class="fas fa-times"></i> Close
              </button>
            </div>
          `;
          
          resultsDiv.style.display = 'block';
          hideBuyerEditForm();
        }
        
        function displayBuyerNotFoundByName(name) {
          const resultsDiv = document.getElementById('buyerSearchResults');
          const infoDiv = document.getElementById('buyerSearchInfo');
          
          infoDiv.innerHTML = `
            <div style="text-align: center; padding: 20px;">
              <i class="fas fa-user-slash" style="font-size: 2em; color: #64748b; margin-bottom: 10px;"></i>
              <p style="color: #64748b; margin-bottom: 15px;">No buyer found with name containing: <strong>"${escapeHTML(name)}"</strong></p>
              <button class="grid-btn" onclick="createNewBuyerFromSearchByName('${escapeHTML(name)}')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                <i class="fas fa-plus"></i> Create New Buyer
              </button>
              <button class="grid-btn" onclick="hideBuyerSearchResults()" style="margin-left: 10px;">
                <i class="fas fa-times"></i> Close
              </button>
            </div>
          `;
          
          resultsDiv.style.display = 'block';
          hideBuyerEditForm();
        }
        
        function editBuyerFromSearch(buyerId) {
          const buyers = load();
          const id = parseInt(buyerId, 10);
          const buyer = buyers.find(b => b.id === id);
          
          if (!buyer) {
            notify.show('error', 'Error', 'Buyer not found');
            return;
          }
          
          const editDiv = document.getElementById('buyerEditForm');
          const contentDiv = document.getElementById('buyerEditContent');
          
          contentDiv.innerHTML = `
            <form onsubmit="saveBuyerFromSearch(event, '${buyer.id}')">
              <div class="form-grid" style="margin-bottom: 20px;">
                <div class="form-group">
                  <label for="editBuyerInitials">Initials <span style="color: #ef4444;">*</span></label>
                  <input type="text" id="editBuyerInitials" value="${escapeHTML(buyer.initials || '')}" required style="font-size: 1.1em; padding: 12px;">
                </div>
                <div class="form-group">
                  <label for="editBuyerName">Name <span style="color: #ef4444;">*</span></label>
                  <input type="text" id="editBuyerName" value="${escapeHTML(buyer.name || '')}" required style="font-size: 1.1em; padding: 12px;">
                </div>
                <div class="form-group">
                  <label for="editBuyerStatus">IN/OUT Status <span style="color: #ef4444;">*</span></label>
                  <select id="editBuyerStatus" required style="font-size: 1.1em; padding: 12px;">
                    <option value="IN" ${buyer.status === 'IN' ? 'selected' : ''}>IN</option>
                    <option value="OUT" ${buyer.status === 'OUT' ? 'selected' : ''}>OUT</option>
                  </select>
                </div>
              </div>
              <div style="display: flex; gap: 10px;">
                <button type="submit" class="grid-btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                  <i class="fas fa-save"></i> Save Changes
                </button>
                <button type="button" class="grid-btn" onclick="hideBuyerEditForm()">
                  <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="grid-btn" onclick="deleteBuyerFromSearch('${buyer.id}')" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>
            </form>
          `;
          
          editDiv.style.display = 'block';
        }
        
        function saveBuyerFromSearch(event, buyerId) {
          event.preventDefault();
          
          const initials = document.getElementById('editBuyerInitials').value.trim();
          const name = document.getElementById('editBuyerName').value.trim();
          const status = document.getElementById('editBuyerStatus').value;
          
          if (!initials || !name || !status) {
            notify.show('error', 'Error', 'Please fill all required fields');
            return;
          }
          
          const buyers = load();
          const index = buyers.findIndex(b => b.id === buyerId);
          
          if (index === -1) {
            notify.show('error', 'Error', 'Buyer not found');
            return;
          }
          
          // Check for duplicate initials (excluding current buyer)
          const duplicate = buyers.find(b => b.id !== buyerId && b.initials && b.initials.toLowerCase() === initials.toLowerCase());
          if (duplicate) {
            notify.show('error', 'Error', `Initials "${initials}" already exist for another buyer`);
            return;
          }
          
          buyers[index] = {
            ...buyers[index],
            initials,
            name,
            status,
            updatedAt: new Date().toISOString()
          };
          
          save(buyers);
          notify.show('success', 'Success', 'Buyer updated successfully');
          
          // Refresh the search result
          displayFoundBuyerRecord(buyers[index]);
          refreshTables();
        }
        
        function createNewBuyerFromSearch(initials) {
          switchTab('capture');
          document.getElementById('buyerInitials').value = initials;
          document.getElementById('buyerInitials').focus();
          hideBuyerSearchResults();
        }
        
        function createNewBuyerFromSearchByName(name) {
          switchTab('capture');
          document.getElementById('buyerName').value = name;
          document.getElementById('buyerName').focus();
          hideBuyerSearchResults();
        }
        
        function deleteBuyerFromSearch(buyerId) {
          if (!confirm('Are you sure you want to delete this buyer? This action cannot be undone.')) {
            return;
          }
          
          const buyers = load();
          const filtered = buyers.filter(b => b.id !== buyerId);
          save(filtered);
          
          notify.show('success', 'Success', 'Buyer deleted successfully');
          hideBuyerSearchResults();
          hideBuyerEditForm();
          refreshTables();
        }
        
        function hideBuyerSearchResults() {
          document.getElementById('buyerSearchResults').style.display = 'none';
        }
        
        function hideBuyerEditForm() {
          document.getElementById('buyerEditForm').style.display = 'none';
        }
        
        function clearAllBuyerSearches() {
          const si = document.getElementById('searchBuyerInitials'); if (si) si.value = '';
          const sn = document.getElementById('searchBuyerName'); if (sn) sn.value = '';
          const ss = document.getElementById('searchBuyerStatus'); if (ss) ss.value = '';
          
          // Hide new UI containers
          const area = document.getElementById('buyerSearchResultArea'); if (area) area.style.display = 'none';
          const info = document.getElementById('buyerInfo'); if (info) { info.style.display = 'none'; info.innerHTML = ''; }
          const status = document.getElementById('buyerStatusInfo'); if (status) { status.style.display = 'none'; status.innerHTML = ''; }
          const dForm = document.getElementById('buyerDetailsForm'); if (dForm) dForm.style.display = 'none';
          const dContent = document.getElementById('buyerDetailsContent'); if (dContent) dContent.innerHTML = '';
          
          // Hide legacy UI containers if present
          if (typeof hideBuyerSearchResults === 'function') hideBuyerSearchResults();
          if (typeof hideBuyerEditForm === 'function') hideBuyerEditForm();
        }
        
        // Additional utility functions for the search tab
        function filterBuyerRecords() {
          const initialsFilter = document.getElementById('filterBuyerInitials').value.toLowerCase();
          const nameFilter = document.getElementById('filterBuyerName').value.toLowerCase();
          const statusFilter = document.getElementById('filterBuyerStatus').value;
          const dateFilter = document.getElementById('filterBuyerDate').value.toLowerCase();
          
          const buyers = load();
          const filtered = buyers.filter(buyer => {
            const matchesInitials = !initialsFilter || (buyer.initials && buyer.initials.toLowerCase().includes(initialsFilter));
            const matchesName = !nameFilter || (buyer.name && buyer.name.toLowerCase().includes(nameFilter));
            const matchesStatus = !statusFilter || buyer.status === statusFilter;
            const matchesDate = !dateFilter || (buyer.createdAt && formatDate(buyer.createdAt).toLowerCase().includes(dateFilter));
            
            return matchesInitials && matchesName && matchesStatus && matchesDate;
          });
          
          renderRows('buyersTableBodySearch', filtered);
          updateCounts(buyers.length, filtered.length);
        }
        
        function clearBuyerFilters() {
          document.getElementById('filterBuyerInitials').value = '';
          document.getElementById('filterBuyerName').value = '';
          document.getElementById('filterBuyerStatus').value = '';
          document.getElementById('filterBuyerDate').value = '';
          filterBuyerRecords();
        }
        
        function sortBuyerTable(field) {
          if (sortKey === field) {
            sortDir = sortDir === 'asc' ? 'desc' : 'asc';
          } else {
            sortKey = field;
            sortDir = 'asc';
          }
          filterBuyerRecords();
        }
        
        function exportBuyersToCSV() {
          const buyers = load();
          if (buyers.length === 0) {
            notify.show('info', 'Info', 'No buyers to export');
            return;
          }
          
          const csv = toCSV(buyers);
          downloadBlob(csv, 'buyers_export.csv', 'text/csv');
          notify.show('success', 'Success', 'Buyers exported successfully');
        }

        // Expose handlers globally for inline HTML event attributes
        window.handleBuyerInitialsEnter = handleBuyerInitialsEnter;
        window.handleBuyerNameEnter = handleBuyerNameEnter;
        window.simpleBuyerSearch = simpleBuyerSearch;
        window.simpleBuyerCaptureSearch = simpleBuyerCaptureSearch;
        window.displayFoundBuyerRecord = displayFoundBuyerRecord;
        window.displayBuyerRecordNotFound = displayBuyerRecordNotFound;
        window.showEditBuyerRecordForm = showEditBuyerRecordForm;
        window.saveBuyerRecordFromSearch = saveBuyerRecordFromSearch;
        window.showBuyerDetailsForm = showBuyerDetailsForm;
        window.saveBuyerFromDetailsForm = saveBuyerFromDetailsForm;
        window.cancelBuyerDetailsEdit = cancelBuyerDetailsEdit;
        window.renderCaptureBuyerInfo = renderCaptureBuyerInfo;
        window.renderCaptureBuyerStatusInfo = renderCaptureBuyerStatusInfo;
        window.renderCaptureBuyerNotFound = renderCaptureBuyerNotFound;
        window.showCaptureEditBuyerForm = showCaptureEditBuyerForm;
        window.saveCaptureBuyerRecord = saveCaptureBuyerRecord;
        window.startCreateNewBuyerRecord = startCreateNewBuyerRecord;
        window.clearAllBuyerSearches = clearAllBuyerSearches;
        window.searchByBuyerInitials = searchByBuyerInitials;
        window.searchByBuyerName = searchByBuyerName;
        window.searchByBuyerStatus = searchByBuyerStatus;
        window.filterBuyerRecords = filterBuyerRecords;
        window.clearBuyerFilters = clearBuyerFilters;
        window.sortBuyerTable = sortBuyerTable;
        window.exportBuyersToCSV = exportBuyersToCSV;

        document.addEventListener('DOMContentLoaded', initBuyers);

      })();
    </script>

  </body>
  </html>          