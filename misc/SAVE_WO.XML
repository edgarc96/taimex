<pre>

PicLan-IP/BASIC ^ ^
*
OPEN 'XMLDATA' TO XMLDATAF ELSE STOP 201,'XMLDATA'
OPEN 'WO' TO WOF ELSE STOP 201,'WO'

PL_GETVAR WORK_NUMBER FROM 'WORK_NUMBER' ELSE WORK_NUMBER = ''
PL_GETVAR WO_DATE FROM 'WO_DATE' ELSE WO_DATE = ''
PL_GETVAR WO_TYPE FROM 'WO_TYPE' ELSE WO_TYPE = ''
PL_GETVAR ASSY_NO FROM 'ASSY_NO' ELSE ASSY_NO = ''
PL_GETVAR SCHEDULE_DATE FROM 'SCHEDULE_DATE' ELSE SCHEDULE_DATE = ''
PL_GETVAR SCHEDULE_QTY FROM 'SCHEDULE_QTY' ELSE SCHEDULE_QTY = ''
PL_GETVAR ORD_QTY FROM 'ORD_QTY' ELSE ORD_QTY = ''
PL_GETVAR YIELD FROM 'YIELD' ELSE YIELD = ''
PL_GETVAR START_DATE FROM 'START_DATE' ELSE START_DATE = ''
PL_GETVAR NOTES FROM 'NOTES' ELSE NOTES = ''
PL_GETVAR ACTION FROM 'ACTION' ELSE ACTION = ''

PL_ADD_HDR '"Content-Type: application/xml"'

CRLF = CHAR(13):CHAR(10)
XML.RESPONSE = '<?xml version="1.0" encoding="UTF-8"?>':CRLF
XML.RESPONSE = XML.RESPONSE:'<WorkOrderSave>':CRLF
XML.RESPONSE = XML.RESPONSE:'  <version>SAVE_WO_V1.0</version>':CRLF
XML.RESPONSE = XML.RESPONSE:'  <timestamp>':DATE():' ':TIME():'</timestamp>':CRLF
XML.RESPONSE = XML.RESPONSE:'  <action>':ACTION:'</action>':CRLF
XML.RESPONSE = XML.RESPONSE:'  <work_number>':WORK_NUMBER:'</work_number>':CRLF

* Validation
ERRORS = ''
IF WORK_NUMBER = '' THEN
    ERRORS = ERRORS:'Work Number is required; '
END
IF WO_DATE = '' THEN
    ERRORS = ERRORS:'WO Date is required; '
END
IF WO_TYPE = '' THEN
    ERRORS = ERRORS:'WO Type is required; '
END
IF ASSY_NO = '' THEN
    ERRORS = ERRORS:'Assembly Number is required; '
END

IF ERRORS <> '' THEN
    XML.RESPONSE = XML.RESPONSE:'  <status>ERROR</status>':CRLF
    XML.RESPONSE = XML.RESPONSE:'  <message>Validation failed</message>':CRLF
    XML.RESPONSE = XML.RESPONSE:'  <errors>':ERRORS:'</errors>':CRLF
    GOTO FINISH
END

* Convert dates from YYYY-MM-DD to internal format
WO_DATE_INTERNAL = ''
IF WO_DATE <> '' THEN
    IF INDEX(WO_DATE, '-', 1) > 0 THEN
        YEAR = FIELD(WO_DATE, '-', 1)
        MONTH = FIELD(WO_DATE, '-', 2)
        DAY = FIELD(WO_DATE, '-', 3)
        WO_DATE_INTERNAL = ICONV(MONTH:'/':DAY:'/':YEAR, 'D')
    END ELSE
        WO_DATE_INTERNAL = WO_DATE
    END
END

START_DATE_INTERNAL = ''
IF START_DATE <> '' THEN
    IF INDEX(START_DATE, '-', 1) > 0 THEN
        YEAR = FIELD(START_DATE, '-', 1)
        MONTH = FIELD(START_DATE, '-', 2)
        DAY = FIELD(START_DATE, '-', 3)
        START_DATE_INTERNAL = ICONV(MONTH:'/':DAY:'/':YEAR, 'D')
    END ELSE
        START_DATE_INTERNAL = START_DATE
    END
END

SCHEDULE_DATE_INTERNAL = ''
IF SCHEDULE_DATE <> '' THEN
    IF INDEX(SCHEDULE_DATE, '-', 1) > 0 THEN
        YEAR = FIELD(SCHEDULE_DATE, '-', 1)
        MONTH = FIELD(SCHEDULE_DATE, '-', 2)
        DAY = FIELD(SCHEDULE_DATE, '-', 3)
        SCHEDULE_DATE_INTERNAL = ICONV(MONTH:'/':DAY:'/':YEAR, 'D')
        IF SCHEDULE_QTY <> '' THEN
            SCHEDULE_DATE_INTERNAL = SCHEDULE_DATE_INTERNAL:'*':SCHEDULE_QTY
        END
    END ELSE
        SCHEDULE_DATE_INTERNAL = SCHEDULE_DATE
        IF SCHEDULE_QTY <> '' AND INDEX(SCHEDULE_DATE_INTERNAL, '*', 1) = 0 THEN
            SCHEDULE_DATE_INTERNAL = SCHEDULE_DATE_INTERNAL:'*':SCHEDULE_QTY
        END
    END
END

* Check if record exists
READ EXISTING.RECORD FROM WOF, WORK_NUMBER ELSE EXISTING.RECORD = ''

* Build new record
NEW.RECORD = ''
NEW.RECORD<1> = WO_DATE_INTERNAL
NEW.RECORD<20> = WO_TYPE
NEW.RECORD<25> = NOTES
NEW.RECORD<32> = ASSY_NO
NEW.RECORD<34> = SCHEDULE_DATE_INTERNAL
NEW.RECORD<35> = ORD_QTY
NEW.RECORD<36> = YIELD
NEW.RECORD<104> = START_DATE_INTERNAL

* Write record
WRITE NEW.RECORD ON WOF, WORK_NUMBER

XML.RESPONSE = XML.RESPONSE:'  <status>SUCCESS</status>':CRLF
IF EXISTING.RECORD <> '' THEN
    XML.RESPONSE = XML.RESPONSE:'  <message>Work Order updated successfully</message>':CRLF
ELSE
    XML.RESPONSE = XML.RESPONSE:'  <message>Work Order created successfully</message>':CRLF
END
XML.RESPONSE = XML.RESPONSE:'  <wo_id>':WORK_NUMBER:'</wo_id>':CRLF

FINISH:
XML.RESPONSE = XML.RESPONSE:'</WorkOrderSave>':CRLF

WRITE XML.RESPONSE ON XMLDATAF,'SAVE_WO.XML'
ERR = ''
CALL PLW.PAGE('/XMLDATA/SAVE_WO.XML','',ERR)
RETURN
</pre>
