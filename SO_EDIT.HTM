<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TAIMEX - PURCHASE ORDERS</title>
  
  <!-- üöÄ CACHE BUSTING HEADERS - NO M√ÅS PROBLEMAS DE CACH√â -->
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta http-equiv="Last-Modified" content="0">
  <meta http-equiv="If-Modified-Since" content="0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- No external PDF libraries needed - using native HTML/Print method -->
  
  <style>
*{margin:0;padding:0;box-sizing:border-box}html,body{height:100vh;overflow:hidden;width:100%}body{font-family:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif;background:linear-gradient(135deg,#f1f5f9 0%,#e2e8f0 100%);color:#334155;width:100%}.container{width:100%;height:100vh;background:#fff;display:flex;flex-direction:column;overflow:hidden}.header{background:linear-gradient(135deg,#1e293b 0%,#1e3a8a 100%);color:#fff;padding:12px 24px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 8px rgba(30,41,59,.25);position:relative;z-index:100;width:100%}.header-left{display:flex;align-items:center;gap:20px;position:relative;z-index:1}.logo-section img{height:40px;width:auto;object-fit:contain;filter:brightness(1.05)}.title-section{text-align:right;position:relative;z-index:1}.title-row{display:flex;align-items:center;justify-content:flex-end;gap:15px}.welcome-user{white-space:nowrap}.welcome-user span{color:#cbd5e1;font-size:.8em;font-weight:400}.welcome-user strong{color:#3b82f6;margin-left:4px;font-weight:600}.title-section h2{font-size:.95em;margin:0;font-weight:500;color:#cbd5e1;letter-spacing:.3px}.title-section p{font-size:.75em;margin:2px 0 0 0;color:#a2a8ba;font-weight:400}.hamburger-menu{background:none;border:none;color:#fff;font-size:1.2em;cursor:pointer;padding:8px;border-radius:6px;transition:background-color .2s ease}.hamburger-menu:hover{background-color:rgba(255,255,255,.12)}.main-content{flex:1;display:flex;flex-direction:column;overflow:hidden;width:100%}.sidebar{position:fixed;top:0;left:-300px;width:300px;height:100vh;background:rgba(255,255,255,.08);backdrop-filter:blur(1px);-webkit-backdrop-filter:blur(1px);color:#fff;transition:left .2s ease;z-index:2000;box-shadow:2px 0 12px rgba(0,0,0,.35)}.sidebar.active{left:0}.sidebar-overlay{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.55);opacity:0;visibility:hidden;transition:all .25s ease;z-index:1500;pointer-events:none}.sidebar.active~.sidebar-overlay{opacity:1;visibility:visible;pointer-events:auto}.sidebar-header{padding:20px;border-bottom:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.05)}.sidebar-header h3{font-size:1.2em;color:#fff;margin:0}.sidebar-content{padding:24px}.sidebar-menu{list-style:none;padding:0;margin:0}.sidebar-menu li{margin-bottom:8px}.sidebar-menu a,.sidebar-menu label{display:block;padding:12px 16px;color:#f3f4f6;text-decoration:none;border-radius:8px;transition:all .2s ease;font-weight:500}.sidebar-menu a:hover,.sidebar-menu label:hover{background-color:rgba(30,64,175,.1);color:#fff}.sidebar-menu a.active,.sidebar-menu label.active{background-color:rgba(30,64,175,.2);color:#93c5fd}.sidebar-menu a i,.sidebar-menu label i{margin-right:12px;width:20px;text-align:center}.sidebar-menu label{cursor:pointer}.tab-navigation{background:#fff;border-bottom:1px solid #e2e8f0;width:100%}.tab-buttons{display:flex;flex-wrap:wrap;width:100%}.tab-button{background:none;border:none;padding:10px 18px;color:#64748b;font-weight:500;cursor:pointer;transition:all .3s ease;border-bottom:3px solid transparent;display:flex;align-items:center;gap:8px;font-size:.9em;line-height:1.1}.tab-button:hover{color:#1e40af;background:rgba(30,64,175,.05)}.tab-button.active{color:#1e40af;background:rgba(30,64,175,.1);border-bottom-color:#1e40af;font-weight:600}.tab-content{flex:1;overflow:hidden;width:100%}.tab-pane{display:none;height:100%;overflow-y:auto;padding:16px 20px;background:#f8fafc;width:100%}.tab-pane.active{display:block}.form-container{max-width:1200px;margin:0 auto;padding:20px;background:#fff;border-radius:12px;box-shadow:0 4px 16px rgba(0,0,0,.08)}.form-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:20px}.form-group{display:flex;flex-direction:column}.form-group.span-2{grid-column:span 2}.form-group.span-3{grid-column:span 3}.form-group.span-full{grid-column:1/-1}.form-group label{font-size:13px;font-weight:600;color:#374151;margin-bottom:6px}.form-group input,.form-group select,.form-group textarea{padding:8px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:13px;transition:all .2s ease}.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.1)}.form-group input[readonly]{background-color:#f9fafb;color:#6b7280;cursor:not-allowed}.form-group textarea{min-height:60px;resize:vertical}.form-group.required label::after{content:" *";color:#ef4444}.btn{padding:10px 20px;border:none;border-radius:6px;font-weight:600;cursor:pointer;transition:all .2s ease;display:inline-flex;align-items:center;gap:8px}.btn-primary{background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);color:#fff}.btn-primary:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(59,130,246,.4)}.btn-secondary{background:#6b7280;color:#fff}.btn-secondary:hover{background:#4b5563}.form-actions{display:flex;gap:12px;margin-top:20px}.notification-container{position:fixed;top:20px;right:20px;z-index:9999;pointer-events:none}.notification{background:#fff;border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,.15);padding:16px;margin-bottom:12px;display:flex;align-items:flex-start;gap:12px;min-width:300px;max-width:400px;opacity:0;transform:translateX(100%);transition:all .3s ease;pointer-events:auto}.notification.show{opacity:1;transform:translateX(0)}.notification.hide{opacity:0;transform:translateX(100%)}.notification.error{border-left:4px solid #ef4444}.notification.loading{border-left:4px solid #3b82f6}.notification-icon{font-size:18px;margin-top:2px}.notification.error .notification-icon{color:#ef4444}.notification.loading .notification-icon{color:#3b82f6}.notification:not(.error):not(.loading) .notification-icon{color:#10b981}.notification-content{flex:1}.notification-title{font-weight:600;color:#1f2937;margin-bottom:4px}.notification-message{font-size:13px;color:#6b7280}.search-section{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:16px;margin-bottom:16px}.search-section label{font-weight:600;color:#374151;margin-bottom:8px;display:block}.search-section .search-controls{display:flex;gap:8px;align-items:center}.search-section input{flex:1;padding:8px 12px;border:1px solid #d1d5db;border-radius:6px;font-size:13px}.search-section button{padding:8px 16px;font-size:13px}.info-alert{display:flex;gap:10px;align-items:flex-start;background:#eff6ff;border-left:4px solid #3b82f6;padding:12px 16px;border-radius:8px;color:#1e3a8a;margin-bottom:16px}.info-alert i{color:#3b82f6;margin-top:2px}

    /* Excel Grid Wrapper - From PRICE_EDIT3.HTM */
.excel-grid-wrapper {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    flex: 1;
    display: flex;
    flex-direction: column;
    min-height: 0;
    width: 100%;
    margin: 0 auto;
}

.excel-grid-container {
    flex: 1;
    overflow-y: auto;
    overflow-x: hidden;
    border: 1px solid #dee2e6;
    border-radius: 0 0 12px 12px;
    background: white;
    position: relative;
    min-height: 250px;
    max-height: calc(100vh - 450px);
}

.excel-grid-container::-webkit-scrollbar {
    width: 12px;
}

.excel-grid-container::-webkit-scrollbar-track {
    background: #f1f3f4;
    border-radius: 6px;
}

.excel-grid-container::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
    border-radius: 6px;
    border: 2px solid #f1f3f4;
}

.excel-grid-container::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
}

.excel-grid-container::-webkit-scrollbar-corner {
    background: #f1f3f4;
}

.grid-toolbar {
    background: #f8f9fa;
    padding: 12px 20px;
    border-bottom: 1px solid #dee2e6;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.toolbar-left .results-count {
    color: #6c757d;
    font-size: 14px;
    font-weight: 500;
}

.toolbar-left .results-count i {
    margin-right: 8px;
    color: #2a5298;
}

/* Excel Grid Premium - EXACT COPY FROM PRICE_EDIT3 */
.excel-grid-premium{width:100%;border-collapse:collapse;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;font-size:11px;background:white;min-width:1000px;border:1px solid #dee2e6;table-layout:fixed}

.excel-header{background:linear-gradient(135deg,#2a5298 0%,#1e3c72 100%);color:white;padding:8px 12px;font-weight:600;text-align:left;border-right:1px solid #1e3c72;cursor:pointer;user-select:none;transition:all 0.2s ease;font-size:11px;box-sizing:border-box;white-space:nowrap}

.excel-header:hover{background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%)}

.excel-header.sorted{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)}

.excel-header:last-child{border-right:none}

.header-content{display:flex;align-items:center;justify-content:space-between;gap:8px}

.sort-icon{opacity:0.7;font-size:12px;transition:opacity 0.2s ease}

.excel-header:hover .sort-icon{opacity:1}

.excel-row{transition:all 0.2s ease;cursor:pointer}

.excel-row:nth-child(even){background:#f8f9fa}

.excel-row:hover{background:linear-gradient(135deg,#e3f2fd 0%,#f3e5f5 100%);transform:translateX(2px);box-shadow:0 2px 8px rgba(0,0,0,0.1)}

.excel-row.selected{background:linear-gradient(135deg,#2196f3 0%,#9c27b0 100%);color:white;box-shadow:0 4px 12px rgba(33,150,243,0.3)}

.excel-cell{padding:8px 12px;border-right:1px solid #dee2e6;border-bottom:1px solid #dee2e6;vertical-align:middle;position:relative;font-size:11px;box-sizing:border-box;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

.excel-cell:last-child{border-right:none}

.excel-cell.readonly{background:#f3f4f6;color:#6b7280}

.grid-btn{background:linear-gradient(135deg,#007bff 0%,#0056b3 100%);color:white;border:none;padding:8px 16px;border-radius:6px;font-size:12px;font-weight:600;cursor:pointer;transition:all 0.3s ease;display:flex;align-items:center;gap:6px}

.grid-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(42,82,152,0.4)}
.section-label{grid-column:1/-1;font-size:11px;font-weight:700;letter-spacing:.3px;text-transform:uppercase;color:#0f172a;background:#f8fafc;border:1px solid #e2e8f0;border-left:4px solid #3b82f6;border-radius:6px;padding:6px 10px;margin:4px 0}
.action-footer{position:sticky;bottom:0;background:rgba(255,255,255,.92);backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px);border-top:1px solid #e2e8f0;padding:12px 16px;display:flex;justify-content:flex-end;gap:12px;z-index:50}
.action-footer .btn{padding:10px 20px;border-radius:10px;font-size:13px}
#tab-2.compact .form-container{padding:12px}
#tab-2.compact h3{margin-bottom:6px}
#tab-2.compact .info-alert{padding:8px 10px;margin-bottom:8px}
#tab-2.compact [style*="padding: 24px"]{padding:12px !important}
#tab-2.compact [style*="padding: 20px 24px"]{padding:12px !important}
#tab-2.compact [style*="padding: 20px"]{padding:12px !important}
#tab-2.compact [style*="padding: 16px 24px"]{padding:10px 12px !important}
#tab-2.compact [style*="padding: 16px"]{padding:10px !important}
#tab-2.compact [style*="gap: 16px"]{gap:8px !important}
#tab-2.compact [style*="margin-bottom: 16px"]{margin-bottom:8px !important}
#tab-2.compact [style*="margin-top: 16px"]{margin-top:8px !important}
#tab-2.compact [style*="min-height: 60px"]{min-height:40px !important}
#tab-2.compact [style*="min-height: 40px"]{min-height:28px !important}
#tab-2.compact .line-item-form{max-height:calc(100vh - 220px);overflow-y:auto}
#tab-2.compact .line-items-table .table-header{padding:6px !important}
#tab-2.overview{overflow:hidden}
#tab-2.overview .line-item-form{max-height:none !important;overflow:hidden !important}
#tab-2.overview .track-block,#tab-2.overview .bottom-block{display:none !important}
#tab-2.overview .line-header{padding:10px 12px !important}
#tab-2.overview .action-footer{padding:8px 12px}
#tab-2.overview .action-footer .btn{padding:8px 12px;font-size:12px}

/* FORCE LINE ITEMS TO BE VISIBLE - Override any conflicting rules */
#lineItemsTable, .line-items-table {
  overflow: visible !important;
  display: block !important;
  visibility: visible !important;
  min-height: 40px !important;
  height: auto !important;
}

#lineItemsBody {
  overflow: visible !important;
  display: block !important;
  visibility: visible !important;
  min-height: 40px !important;
}
#tab-2.overview [style*="padding: 24px"]{padding:12px !important}
#tab-2.overview h6{margin-bottom:8px !important}

/* ========== WALKTHROUGH GUIDED DESIGN ========== */
.walkthrough-container {
  max-width: 1800px;
  margin: 0 auto;
  padding: 20px;
  height: 100%;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.progress-bar-container {
  background: white;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 24px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  flex-shrink: 0;
}

/* Scrollbar styling for steps container */
.walkthrough-container > div[style*="overflow-y: auto"]::-webkit-scrollbar {
  width: 8px;
}

.walkthrough-container > div[style*="overflow-y: auto"]::-webkit-scrollbar-track {
  background: #f1f5f9;
  border-radius: 4px;
}

.walkthrough-container > div[style*="overflow-y: auto"]::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 4px;
  transition: background 0.2s;
}

.walkthrough-container > div[style*="overflow-y: auto"]::-webkit-scrollbar-thumb:hover {
  background: #94a3b8;
}

.progress-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: relative;
  margin-bottom: 12px;
}

.progress-bar::before {
  content: '';
  position: absolute;
  top: 20px;
  left: 60px;
  right: 60px;
  height: 3px;
  background: #e5e7eb;
  z-index: 0;
}

.progress-bar-fill {
  position: absolute;
  top: 20px;
  left: 60px;
  height: 3px;
  background: linear-gradient(90deg, #3b82f6, #10b981);
  z-index: 1;
  transition: width 0.4s ease;
  max-width: calc(100% - 120px);
}

.step-indicator {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  position: relative;
  z-index: 2;
  cursor: pointer;
  transition: transform 0.2s ease;
}

.step-indicator:hover {
  transform: scale(1.05);
}

.step-number {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: #e5e7eb;
  color: #9ca3af;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  font-size: 16px;
  transition: all 0.3s ease;
  border: 3px solid white;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.step-indicator.active .step-number {
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: white;
  box-shadow: 0 4px 12px rgba(59,130,246,0.4);
}

.step-indicator.completed .step-number {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
}

.step-indicator.completed .step-number::before {
  content: '‚úì';
  font-size: 18px;
}

.step-label {
  font-size: 11px;
  font-weight: 600;
  color: #6b7280;
  text-align: center;
  max-width: 100px;
  transition: color 0.3s ease;
}

.step-indicator.active .step-label {
  color: #1e293b;
  font-weight: 700;
}

.step-indicator.completed .step-label {
  color: #059669;
}

.step-card {
  background: white;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 12px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.04);
  border: 1px solid transparent;
  transition: all 0.2s ease;
  display: none;
  max-width: 95%;
  margin-left: auto;
  margin-right: auto;
}

.step-card.active {
  display: block;
  border-color: #3b82f6;
  box-shadow: 0 2px 8px rgba(59,130,246,0.1);
}

.step-card-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
  padding-bottom: 10px;
  border-bottom: 1px solid #f1f5f9;
}

.step-icon {
  width: 36px;
  height: 36px;
  border-radius: 6px;
  background: linear-gradient(135deg, #eff6ff, #dbeafe);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  color: #3b82f6;
}

.step-title {
  flex: 1;
}

.step-title h3 {
  margin: 0;
  font-size: 15px;
  font-weight: 700;
  color: #1e293b;
  display: flex;
  align-items: center;
  gap: 6px;
}

.step-title p {
  margin: 2px 0 0 0;
  font-size: 11px;
  color: #64748b;
}

.field-group {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 12px;
  margin-bottom: 12px;
}

.field-wrapper {
  position: relative;
}

.field-wrapper label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: #374151;
  margin-bottom: 5px;
}

.field-wrapper label .required-mark {
  color: #ef4444;
  margin-left: 2px;
}

.field-wrapper input,
.field-wrapper select,
.field-wrapper textarea {
  width: 100%;
  border: 1px solid #e5e7eb;
  border-radius: 4px;
  padding: 7px 10px;
  font-size: 13px;
  transition: all 0.15s ease;
  background: white;
}

.field-wrapper input:focus,
.field-wrapper select:focus,
.field-wrapper textarea:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 2px rgba(59,130,246,0.1);
}

.field-wrapper input.valid {
  border-color: #10b981;
}

.field-wrapper input.invalid {
  border-color: #ef4444;
}

.field-hint {
  font-size: 10.5px;
  color: #9ca3af;
  margin-top: 4px;
  display: flex;
  align-items: center;
  gap: 4px;
}

.field-hint i {
  color: #3b82f6;
}

.info-box {
  background: linear-gradient(135deg, #eff6ff, #dbeafe);
  border-left: 3px solid #3b82f6;
  border-radius: 6px;
  padding: 10px 12px;
  margin: 10px 0;
  display: flex;
  gap: 10px;
}

.info-box-icon {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: white;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #3b82f6;
  font-size: 12px;
  flex-shrink: 0;
}

.info-box-content {
  flex: 1;
}

.info-box-content strong {
  display: block;
  color: #1e3a8a;
  margin-bottom: 2px;
  font-size: 12px;
}

.info-box-content p {
  color: #1e40af;
  font-size: 11px;
  margin: 0;
  line-height: 1.4;
}

.step-navigation {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 24px;
  border-top: 2px solid #f1f5f9;
  margin-top: 24px;
}

.btn-step {
  padding: 12px 24px;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  border: none;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.btn-step-primary {
  background: linear-gradient(135deg, #3b82f6, #2563eb);
  color: white;
  box-shadow: 0 4px 12px rgba(59,130,246,0.3);
}

.btn-step-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(59,130,246,0.4);
}

.btn-step-secondary {
  background: #f1f5f9;
  color: #64748b;
}

.btn-step-secondary:hover {
  background: #e2e8f0;
  color: #475569;
}

.btn-step:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.summary-section {
  background: #f8fafc;
  border-radius: 12px;
  padding: 20px;
  margin-top: 20px;
}

.summary-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-top: 16px;
}

.summary-item {
  background: white;
  padding: 12px;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}

.summary-item-label {
  font-size: 11px;
  color: #6b7280;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 6px;
}

.summary-item-value {
  font-size: 15px;
  color: #1e293b;
  font-weight: 600;
}

/* Validation badges */
.validation-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  margin-top: 8px;
}

.validation-badge.success {
  background: #d1fae5;
  color: #065f46;
}

.validation-badge.error {
  background: #fee2e2;
  color: #991b1b;
}

.validation-badge.warning {
  background: #fef3c7;
  color: #92400e;
}

  </style>
  <!-- UI Overrides for readability -->
  <style>
    body { font-size: 16px; }
    
    /* Titles and Headers */
    h1 { font-size: 28px !important; }
    h2 { font-size: 24px !important; }
    h3 { font-size: 22px !important; }
    h4 { font-size: 20px !important; }
    h5 { font-size: 18px !important; }
    h6 { font-size: 18px !important; }
    
    /* Labels and Form Elements */
    label { font-size: 17px !important; font-weight: 600 !important; }
    input, select, textarea { font-size: 16px !important; padding: 10px 12px !important; }
    input::placeholder { font-size: 15px; opacity: 0.6; }
    textarea::placeholder { font-size: 15px; opacity: 0.6; }
    .field-hint { font-size: 14px; }
    
    /* Line items specific */
    #lineQuantity { font-size: 17px; padding: 12px 14px; }
    
    /* Buttons */
    button { font-size: 15px !important; }
    .btn-step { font-size: 15px !important; }
    
    /* Step titles */
    .step-title h3 { font-size: 22px !important; }
    .step-title p { font-size: 15px !important; }
  </style>

  <!-- Print-specific CSS for PDF export -->
  <style>
    @media print {
      /* Hide everything except printView */
      body * {
        visibility: hidden !important;
      }
      
      /* Show only printView and its children */
      #printView, #printView * {
        visibility: visible !important;
      }
      
      /* Full page usage - no scaling to prevent horizontal overflow */
      #printView {
        position: absolute !important;
        left: 0 !important;
        top: 0 !important;
        transform: none !important;
        width: 100% !important;
        max-width: 100% !important;
        padding: 15px !important;
        margin: 0 !important;
        background: white !important;
        height: auto !important;
        overflow: hidden !important;
        display: block !important;
        font-family: Arial, sans-serif !important;
        box-sizing: border-box !important;
      }

      /* Preserve exact layout and scaling for Chrome print/PDF */
      html, body {
        width: 100% !important;
        height: auto !important;
        zoom: 1 !important;
        transform: none !important;
        -webkit-transform: none !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }

      /* Prevent Chrome print compression */
      @page {
        size: A4 portrait;
        margin: 0; /* remove extra margins */
      }

      #printView {
        transform: scale(1) !important;
        zoom: 1 !important;
        page-break-after: auto !important;
      }

      /* Force flex/grid containers to not collapse in print */
      #printView > div, #printView .container, #printView .form-container {
        display: block !important;
        width: 100% !important;
        max-width: 100% !important;
      }
      
      /* Clean body for print */
      body {
        margin: 0 !important;
        padding: 0 !important;
        background: white !important;
        color: black !important;
      }
      
      /* Hide print controls */
      button, 
      div[style*="print: none"] {
        display: none !important;
        visibility: hidden !important;
      }
      
      /* Fix gradients and colors for print */
      div[style*="linear-gradient"] {
        background: linear-gradient(135deg,#1e293b 0%,#1e3a8a 100%) !important;
        color: white !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      /* Ensure all colors print correctly */
      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      /* Force blue headers to show */
      div[style*="background: linear-gradient(135deg,#1e293b 0%,#1e3a8a 100%)"] {
        background: linear-gradient(135deg,#1e293b 0%,#1e3a8a 100%) !important;
        color: white !important;
      }
      
      /* Force borders to show */
      div[style*="border"] {
        border: 2px solid #3b82f6 !important;
      }
      
      /* Ensure logo and image display */
      img {
        display: inline !important;
        visibility: visible !important;
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      /* Keep TAIMEX logo exactly as preview */
      img[alt="TAIMEX INDUSTRIAL"] {
        height: 40px !important;
        width: auto !important;
        object-fit: contain !important;
        filter: brightness(1.05) !important;
      }
      
      /* Smaller fonts to match HTML preview exactly */
      #printView * {
        font-size: 0.9em !important;
      }
      
      /* Keep original margins exactly as preview */
      #printView div[style*="margin-bottom: 20px"] {
        margin-bottom: 20px !important;
      }
      
      #printView div[style*="margin-top: 40px"] {
        margin-top: 40px !important;
      }
      
      #printView div[style*="margin-bottom: 60px"] {
        margin-bottom: 60px !important;
      }
      
      /* Keep original padding exactly as preview */
      #printView div[style*="padding: 20px"] {
        padding: 20px !important;
      }
      
      #printView div[style*="padding: 15px"] {
        padding: 15px !important;
      }
      
      #printView div[style*="padding: 8px"] {
        padding: 8px !important;
      }
      
      /* Table optimized for full page width without overflow */
      #printView table {
        width: 100% !important;
        border-collapse: collapse !important;
        margin-bottom: 15px !important;
        table-layout: fixed !important;
        font-size: 12px !important;
      }
      
      /* Compact cells to match HTML preview exactly */
      #printView th,
      #printView td {
        padding: 8px 6px !important;
        border: 1px solid #ccc !important;
        text-align: left !important;
        vertical-align: top !important;
        font-size: 11px !important;
        line-height: 1.3 !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        height: auto !important;
        min-height: 30px !important;
      }
      
      /* Compact blue headers to match preview */
      #printView th {
        background: linear-gradient(135deg,#1e293b 0%,#1e3a8a 100%) !important;
        color: white !important;
        font-weight: bold !important;
        font-size: 10px !important;
        padding: 8px 6px !important;
        min-height: 35px !important;
      }
      
      /* Optimize line items table column distribution */
      #printView table.line-items-table,
      #printView table[style*="width: 100%"] {
        table-layout: fixed !important;
      }
      
      /* Much wider columns for better readability */
      #printView table th:first-child,
      #printView table td:first-child { 
        width: 8% !important; 
        text-align: center !important;
        min-width: 60px !important;
      }
      
      #printView table th:nth-child(2),
      #printView table td:nth-child(2) { 
        width: 12% !important; 
        text-align: center !important;
        min-width: 80px !important;
      }
      
      #printView table th:nth-child(3),
      #printView table td:nth-child(3) { 
        width: 12% !important; 
        text-align: center !important;
        min-width: 80px !important;
      }
      
      #printView table th:nth-child(4),
      #printView table td:nth-child(4) { 
        width: 12% !important; 
        text-align: center !important;
        min-width: 80px !important;
      }
      
      #printView table th:nth-child(5),
      #printView table td:nth-child(5) { 
        width: 34% !important; 
        white-space: normal !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        hyphens: auto !important;
        min-width: 200px !important;
      }
      
      #printView table th:nth-child(6),
      #printView table td:nth-child(6) { 
        width: 11% !important; 
        text-align: right !important;
        white-space: nowrap !important;
        min-width: 80px !important;
      }
      
      #printView table th:nth-child(7),
      #printView table td:nth-child(7) { 
        width: 11% !important; 
        text-align: right !important;
        white-space: nowrap !important;
        min-width: 80px !important;
      }
      
      
      /* Ultra minimal page margins for maximum table space */
      @page {
        size: letter;
        margin: 0.2in;
      }
      
      /* Allow page breaks for better table display */
      #printView {
        page-break-inside: auto !important;
      }
      
      /* Allow table to break across pages if needed */
      #printView table {
        page-break-inside: auto !important;
      }
      
      /* Keep table headers when page breaks */
      #printView thead {
        display: table-header-group !important;
      }
      
      /* Prevent individual rows from breaking */
      #printView tr {
        page-break-inside: avoid !important;
      }
      
      /* Preserve line items visibility */
      #printView tbody tr,
      #printView .line-item-row,
      #printView tr[id*="lineItem"] {
        display: table-row !important;
        visibility: visible !important;
      }

      /* --- BEGIN: Force line items grid to behave like on-screen preview --- */
      /* The following rules preserve the grid layout for the line items section in print */
      #lineItemsTable {
        display: grid !important;
        grid-template-rows: auto 1fr !important;
        width: 100% !important;
        background: white !important;
      }

      #lineItemsBody {
        display: grid !important;
        grid-auto-rows: min-content !important;
        gap: 0 !important;
        background: white !important;
      }

      #lineItemsBody > div.li-row {
        display: grid !important;
        grid-template-columns: var(--li-cols) !important;
        align-items: center !important;
        border-bottom: 1px solid #f3f4f6 !important;
        padding: 8px 8px !important;
        background: transparent !important;
        visibility: visible !important;
      }

      #lineItemsBody > div.li-row:nth-child(even) {
        background: #fcfcfd !important;
      }

      #lineItemsBody .li-cell {
        display: block !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
        font-size: 12px !important;
      }
      /* --- END: Force line items grid to behave like on-screen preview --- */
      
      /* Compact company section to match preview */
      #printView div[style*="display: grid; grid-template-columns: 350px 1fr"] {
        display: grid !important;
        grid-template-columns: 300px 1fr !important;
        gap: 15px !important;
        margin-bottom: 15px !important;
        min-height: 100px !important;
      }
      
      /* Compact main title to match preview */
      #printView h1 {
        color: #3b82f6 !important;
        font-size: 20px !important;
        font-weight: bold !important;
        margin: 0 0 10px 0 !important;
        text-align: center !important;
      }
      
      /* Force visibility of all content sections */
      #printView div,
      #printView table,
      #printView tr,
      #printView td,
      #printView th {
        visibility: visible !important;
      }
      /* Only set display:block for div, not for table/tr/td/th, to allow grid or table as needed */
      #printView div {
        display: block !important;
      }
      /* Only set display:table/table-row/table-cell for actual tables, not for grid-based line items */
      #printView table {
        display: table !important;
      }
      #printView tr {
        display: table-row !important;
      }
      #printView td,
      #printView th {
        display: table-cell !important;
      }

      /* Keep trailing spacer visible to prevent cutting */
      #printView > div[style*="height: 300px"] {
        display: block !important;
        height: 300px !important;
        page-break-inside: avoid !important;
      }
      
      /* Ensure Notes section doesn't get cut off */
      #printNotes {
        max-height: none !important;
        overflow: visible !important;
        page-break-inside: avoid !important;
      }
      
      /* Ensure line items table shows all content */
      #printView table tbody {
        display: table-row-group !important;
      }
      #printView table tbody tr {
        display: table-row !important;
      }
      #printView table tbody td {
        display: table-cell !important;
      }
      /* Remove/override any display:block !important for #printView table tr/td, so only grid-based line items use grid, and tables use table */
      #printView table tr,
      #printView table td,
      #printView table th {
        display: revert !important;
      }
    }
  </style>
</head>
<body>
  <input type="checkbox" id="sb-toggle" />
  <label for="sb-toggle" class="sidebar-overlay"></label>
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h3>Menu</h3>
    </div>
    <div class="sidebar-content">
      <ul class="sidebar-menu">
        <li><label for="sb-toggle">Main Menu</label></li>
        <li><label for="sb-toggle">Parts Management</label></li>
        <li><label for="sb-toggle">Work Orders</label></li>
        <li><label for="sb-toggle" class="active">Sales Orders</label></li>
        <li><label for="sb-toggle">Stock Transactions</label></li>
        <li><label for="sb-toggle">Commodities</label></li>
      </ul>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <div class="header-left">
        <label class="hamburger-menu" for="sb-toggle" aria-label="Open menu">
          <svg viewBox="0 0 448 512" role="img" aria-hidden="true" focusable="false">
            <path d="M0 96C0 78.3 14.3 64 32 64H416C433.7 64 448 78.3 448 96C448 113.7 433.7 128 416 128H32C14.3 128 0 113.7 0 96zM0 256C0 238.3 14.3 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.3 288 0 273.7 0 256zM448 416C448 433.7 433.7 448 416 448H32C14.3 448 0 433.7 0 416C0 398.3 14.3 384 32 384H416C433.7 384 448 398.3 448 416z"></path>
          </svg>
        </label>
        <div class="logo-section">
          <img src="http://54.189.226.145/uploads/assets/images/taimex_logo.png" alt="TAIMEX INDUSTRIAL" onerror="this.onerror=null;this.src='http://54.189.226.145/uploads/assets/images/taimex_logo.png';">
        </div>
      </div>
      <div class="title-section">
        <div class="title-row">
          <div class="welcome-user">
            <span>Welcome,</span>
            <strong id="currentUserDisplay">Loading...</strong>
          </div>
          <div>
            <h2>TAIMEX - PURCHASE ORDERS</h2>
            <p>TAIMEX - MANAGEMENT</p>
          </div>
        </div>
      </div>
    </div>
    
    <main class="main-content">
      <div class="tab-navigation">
        <div class="tab-buttons">
          <button type="button" class="tab-button active" data-tab-index="0">
            + Data Capture
          </button>
          <button type="button" class="tab-button" data-tab-index="1">
            üîç Search & View
          </button>
          <button type="button" class="tab-button" data-tab-index="2">
            üìã Line Items
          </button>
          
        </div>
      </div>
      <div class="tab-content">
        <div class="tab-pane active" id="tab-0">
          <div class="walkthrough-container">
            
            <!-- Progress Bar -->
            <div class="progress-bar-container">
              <div class="progress-bar">
                <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
                
                <div class="step-indicator active" data-step="1" onclick="goToStep(1)">
                  <div class="step-number">1</div>
                  <div class="step-label">Order Info</div>
                </div>
                
                <div class="step-indicator" data-step="2" onclick="goToStep(2)">
                  <div class="step-number">2</div>
                  <div class="step-label">Client</div>
                </div>
                
                <div class="step-indicator" data-step="3" onclick="goToStep(3)">
                  <div class="step-number">3</div>
                  <div class="step-label">Shipping</div>
                </div>
                
                <div class="step-indicator" data-step="4" onclick="goToStep(4)">
                  <div class="step-number">4</div>
                  <div class="step-label">Line Items</div>
                </div>
                
                <div class="step-indicator" data-step="5" onclick="goToStep(5)">
                  <div class="step-number">5</div>
                  <div class="step-label">Review</div>
                </div>
              </div>
              
              
            </div>
            
            <!-- Search Section (Always visible at top) -->
            <div style="background: white; border-radius: 12px; padding: 16px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); flex-shrink: 0;">
              <div style="display: flex; gap: 12px; align-items: center;">
                <input type="text" placeholder="üîç Search existing SO..." id="soSearchInput" style="flex: 1; border: 2px solid #e5e7eb; border-radius: 8px; padding: 10px 16px; font-size: 14px;">
                <button type="button" onclick="searchSO()" class="btn-step btn-step-secondary" style="padding: 10px 20px;">
                  <i class="fas fa-search"></i> Search
                </button>
                <button type="button" onclick="showSavedDrafts()" class="btn-step" style="padding: 10px 20px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; border: none;">
                  <i class="fas fa-clock"></i> My Drafts
                </button>
                <button type="button" onclick="startNewSO()" class="btn-step btn-step-primary">
                  <i class="fas fa-plus"></i> New SO
                </button>
              </div>
            </div>
            
            <!-- Steps Container with Scroll -->
            <div style="flex: 1; overflow-y: auto; overflow-x: hidden; padding-right: 8px;">
            
            <!-- STEP 1: Order Information -->
            <div class="step-card active" id="step-1">
              <!-- NEW SO Banner - Minimalist Professional Design -->
              <div id="newSOBanner" style="background: #f8fafc; border-left: 4px solid #3b82f6; border-radius: 6px; padding: 16px 20px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.08); display: none;">
                <div style="display: flex; align-items: center; gap: 16px;">
                  <div style="flex-shrink: 0;">
                    <div style="width: 40px; height: 40px; background: #dbeafe; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                      <i class="fas fa-file-alt" style="font-size: 18px; color: #3b82f6;"></i>
                    </div>
                  </div>
                  <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                      <h3 style="margin: 0; color: #1e293b; font-size: 15px; font-weight: 600;">Creating New Sales Order</h3>
                      <span style="background: #dbeafe; color: #1e40af; font-size: 11px; font-weight: 600; padding: 3px 8px; border-radius: 4px; text-transform: uppercase; letter-spacing: 0.5px;">New</span>
                    </div>
                    <p style="margin: 0; color: #64748b; font-size: 13px; line-height: 1.4;">
                      SO number will be assigned automatically upon saving
                    </p>
                  </div>
                </div>
              </div>
              
              <div class="step-card-header">
                <div class="step-icon">
                  <i class="fas fa-file-alt"></i>
                </div>
                <div class="step-title">
                  <h3>üìã Step 1: Order Information</h3>
                  <p>Let's start with the basic order details</p>
                </div>
              </div>
              
              <div class="info-box">
                <div class="info-box-icon">
                  <i class="fas fa-lightbulb"></i>
                </div>
                <div class="info-box-content">
                  <strong>Quick Tip</strong>
                  <p>SO Number is assigned automatically by the system. Just enter the date and status to begin.</p>
                </div>
              </div>
              
              <div class="field-group">
                <div class="field-wrapper">
                  <label>SO Number</label>
                  <input type="text" id="soNumberInput" readonly placeholder="Auto-generated by LIID system" style="background-color: #f5f5f5; cursor: not-allowed;">
                  <div class="field-hint"><i class="fas fa-lock"></i> Auto-assigned by system</div>
                </div>
                
                <div class="field-wrapper">
                  <label>SO Date <span class="required-mark">*</span></label>
                  <input type="date" id="soDateInput" onchange="validateStep1()">
                  <div class="field-hint"><i class="fas fa-calendar"></i> Order date</div>
                </div>
              </div>
              
              <div class="field-group">
                <div class="field-wrapper">
                  <label>Status <span class="required-mark">*</span></label>
                  <select id="soStatusInput" onchange="validateStep1()">
                    <option value="">Select Status...</option>
                    <option value="N">New</option>
                    <option value="B">Backordered</option>
                    <option value="C">Closed</option>
                    <option value="X">X Cancelled</option>
                    <option value="H">Hold</option>
                  </select>
                </div>
                
              </div>
              
              <div class="step-navigation">
                <div></div>
                <button class="btn-step btn-step-primary" onclick="nextStep()" id="step1NextBtn" disabled>
                  Next: Client <i class="fas fa-arrow-right"></i>
                </button>
              </div>
            </div>
            
            <!-- STEP 2: Client Information -->
            <div class="step-card" id="step-2">
              <div class="step-card-header">
                <div class="step-icon">
                  <i class="fas fa-building"></i>
                </div>
                <div class="step-title">
                  <h3>üè¢ Step 2: Client Information</h3>
                  <p>Select or search for the client (Ship To)</p>
                </div>
              </div>
              
              <div class="info-box">
                <div class="info-box-icon">
                  <i class="fas fa-search"></i>
                </div>
                <div class="info-box-content">
                  <strong>How to Search</strong>
                  <p>Start typing the client code or name and press ENTER to search. The system will show matching results.</p>
                </div>
              </div>
              
              <div class="field-group">
                <div class="field-wrapper" style="grid-column: 1 / -1; position: relative;">
                  <label>Ship To <span class="required-mark">*</span></label>
                  <input type="text" id="customerCodeInput" placeholder="Enter Ship To code or name and press ENTER..." onkeydown="handleCustomerKeyDown(event)" onblur="onCustomerChange()" autocomplete="off">
                  <div class="field-hint"><i class="fas fa-keyboard"></i> Press ENTER to search</div>
                  <div id="customerSuggestions" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #e5e7eb; border-radius: 8px; max-height: 200px; overflow-y: auto; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 4px;"></div>
                </div>
              </div>
              
              <!-- Client Info Display -->
              <div id="customerInfoSection" style="display: none; background: linear-gradient(135deg, #eff6ff, #dbeafe); border: 2px solid #3b82f6; border-radius: 12px; padding: 20px; margin-top: 16px;">
                <h4 style="color: #1e293b; font-size: 16px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                  <i class="fas fa-check-circle" style="color: #10b981;"></i>
                  Client Details
                </h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; font-size: 13px;">
                  <div>
                    <strong style="color: #374151; display: block; margin-bottom: 4px;">Number:</strong>
                    <div id="customerNumber" style="color: #6b7280;">-</div>
                  </div>
                  <div>
                    <strong style="color: #374151; display: block; margin-bottom: 4px;">Name:</strong>
                    <div id="customerName" style="color: #6b7280;">-</div>
                  </div>
                  <div style="grid-column: 1 / -1;">
                    <strong style="color: #374151; display: block; margin-bottom: 4px;">Address:</strong>
                    <div id="customerAddress" style="color: #6b7280;">-</div>
                  </div>
                  <div style="grid-column: 1 / -1;">
                    <strong style="color: #374151; display: block; margin-bottom: 4px;">City:</strong>
                    <div id="customerCity" style="color: #6b7280;">-</div>
                  </div>
                </div>
              </div>
              
              <!-- Bill To Info Display - AZUL como Customer -->
              <div id="shipToInfoSection" style="display: none; background: linear-gradient(135deg, #eff6ff, #dbeafe); border: 2px solid #3b82f6; border-radius: 12px; padding: 20px; margin-top: 16px;">
                <h4 style="color: #1e293b; font-size: 16px; font-weight: 700; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                  <i class="fas fa-file-invoice-dollar" style="color: #3b82f6;"></i>
                  Bill To Details
                </h4>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; font-size: 13px;">
                  <div>
                    <strong style="color: #374151; display: block; margin-bottom: 4px;">Number:</strong>
                    <div id="shipToNumber" style="color: #6b7280;">-</div>
                  </div>
                  <div>
                    <strong style="color: #374151; display: block; margin-bottom: 4px;">Name:</strong>
                    <div id="shipToName" style="color: #6b7280;">-</div>
                  </div>
                  <div style="grid-column: 1 / -1;">
                    <strong style="color: #374151; display: block; margin-bottom: 4px;">Address:</strong>
                    <div id="shipToAddress" style="color: #6b7280;">-</div>
                  </div>
                  <div style="grid-column: 1 / -1;">
                    <strong style="color: #374151; display: block; margin-bottom: 4px;">City:</strong>
                    <div id="shipToCity" style="color: #6b7280;">-</div>
                  </div>
                </div>
              </div>
              
              <!-- Bill To Input Field -->
              <div class="field-group" style="margin-top: 16px;">
                <div class="field-wrapper" style="grid-column: 1 / -1;">
                  <label>Bill To Code</label>
                  <input type="text" id="shipToCodeInput" readonly style="background-color: #f9fafb; cursor: not-allowed;" placeholder="Auto-populated from Ship To (position 8)...">
                  <div class="field-hint"><i class="fas fa-link"></i> Automatically filled from customer selection</div>
                </div>
              </div>
              
              <!-- Email Addresses (moved from Step 1) -->
              <div class="field-group" style="margin-top: 12px;">
                <div class="field-wrapper" style="grid-column: 1 / -1;">
                  <label>Email Addresses</label>
                  <textarea id="emailInput" rows="2" placeholder="Enter email addresses separated by commas" style="font-size: 15px;"></textarea>
                  <div class="field-hint"><i class="fas fa-envelope"></i> Separate multiple emails with commas</div>
                </div>
              </div>
              
              <div class="step-navigation">
                <button class="btn-step btn-step-secondary" onclick="prevStep()">
                  <i class="fas fa-arrow-left"></i> Back
                </button>
                <button class="btn-step btn-step-primary" onclick="nextStep()" id="step2NextBtn" disabled>
                  Next:  Shipping Method <i class="fas fa-arrow-right"></i>
                </button>
              </div>
            </div>
            
            <!-- STEP 3: Shipping & Payment -->
            <div class="step-card" id="step-3">
              <div class="step-card-header">
                <div class="step-icon">
                  <i class="fas fa-truck"></i>
                </div>
                <div class="step-title">
                  <h3>üöö Step 3: Shipping Details</h3>
                  <p>Configure shipping method and payment information</p>
                </div>
              </div>
              
              <div class="field-group">
                <div class="field-wrapper">
                  <label>Ship Via</label>
                  <select id="shipViaSelect" onchange="onShipViaChange()">
                    <option value="">Select Ship Via...</option>
                  </select>
                  <div class="field-hint"><i class="fas fa-shipping-fast"></i> Shipping method</div>
                </div>
                
                <div class="field-wrapper">
                  <label>Carrier Account</label>
                  <input type="text" id="carrierAccountInput" placeholder="Enter carrier account number">
                  <div class="field-hint"><i class="fas fa-id-card"></i> Account number for shipping</div>
                </div>
              </div>
              
              <div class="field-group">
                <div class="field-wrapper">
                  <label>Payment Terms</label>
                  <input type="text" id="termsInput" placeholder="e.g., Net 30, COD">
                  <div class="field-hint"><i class="fas fa-credit-card"></i> Payment terms</div>
                </div>
                
                <div class="field-wrapper">
                  <label>Notes</label>
                  <textarea id="notesInput" rows="2" placeholder="Additional notes or special instructions"></textarea>
                  <div class="field-hint"><i class="fas fa-sticky-note"></i> Optional special instructions</div>
                </div>
              </div>
              
              <div class="step-navigation">
                <button class="btn-step btn-step-secondary" onclick="prevStep()">
                  <i class="fas fa-arrow-left"></i> Back
                </button>
                <button class="btn-step btn-step-primary" onclick="nextStep()">
                  Next: Line Items <i class="fas fa-arrow-right"></i>
                </button>
              </div>
            </div>
            
            <!-- STEP 4: Line Items -->
            <div class="step-card" id="step-4">
              <div class="step-card-header">
                <div class="step-icon">
                  <i class="fas fa-list"></i>
                </div>
                <div class="step-title">
                  <h3>üì¶ Step 4: Line Items</h3>
                  <p>Add products to your sales order</p>
                </div>
              </div>
              
              <div class="info-box">
                <div class="info-box-icon">
                  <i class="fas fa-plus-circle"></i>
                </div>
                <div class="info-box-content">
                  <strong>Adding Line Items</strong>
                  <p>Click "Add Line Item" to add products. You can add multiple items to complete your order.</p>
                </div>
              </div>
              
              <!-- Excel Grid Wrapper - EXACT COPY FROM PRICE_EDIT3 -->
              <div class="excel-grid-wrapper">
                <div class="grid-toolbar">
                  <div class="toolbar-left">
                    <span class="results-count">
                      <i class="fas fa-database"></i> 
                      <span id="lineItemsCount">0 items</span>
                    </span>
                  </div>
                  <div class="toolbar-right">
                    <button class="grid-btn" onclick="showAddLineItemForm()">
                      <i class="fas fa-plus"></i> Add Line Item
                    </button>
                  </div>
                </div>
                
                <div class="excel-grid-container">
                  <!-- GRID HEADER -->
                  <div style="display: grid; grid-template-columns: 60px 100px 120px 100px 1fr 120px 120px 100px; gap: 0; position: sticky; top: 0; z-index: 10;">
                    <div class="excel-header" style="text-align: center;">
                      <div class="header-content" style="justify-content: center;">
                        <i class="fas fa-hashtag"></i> ITEM
                      </div>
                    </div>
                    <div class="excel-header" style="text-align: center;">
                      <div class="header-content" style="justify-content: center;">
                        <i class="fas fa-sort-numeric-up"></i> TOTAL QTY
                      </div>
                    </div>
                    <div class="excel-header" style="text-align: center;">
                      <div class="header-content" style="justify-content: center;">
                        <i class="fas fa-calendar-check"></i> DATE REQD
                      </div>
                    </div>
                    <div class="excel-header" style="text-align: center;">
                      <div class="header-content" style="justify-content: center;">
                        <i class="fas fa-box"></i> RELEASE QTY
                      </div>
                    </div>
                    <div class="excel-header">
                      <div class="header-content">
                        <i class="fas fa-barcode"></i> PART NUMBER AND DESCRIPTION
                      </div>
                    </div>
                    <div class="excel-header" style="text-align: right;">
                      <div class="header-content" style="justify-content: flex-end;">
                        <i class="fas fa-dollar-sign"></i> UNIT PRICE
                      </div>
                    </div>
                    <div class="excel-header" style="text-align: right;">
                      <div class="header-content" style="justify-content: flex-end;">
                        <i class="fas fa-calculator"></i> TOTAL
                      </div>
                    </div>
                    <div class="excel-header" style="text-align: center;">
                      <div class="header-content" style="justify-content: center;">
                        <i class="fas fa-cogs"></i> ACTIONS
                      </div>
                    </div>
                  </div>
                  
                  <!-- GRID BODY -->
                  <div id="lineItemsBody"></div>
                </div>
              </div>
              
              <div class="step-navigation">
                <button class="btn-step btn-step-secondary" onclick="prevStep()">
                  <i class="fas fa-arrow-left"></i> Back
                </button>
                <button class="btn-step btn-step-primary" onclick="nextStep()">
                  Review Order <i class="fas fa-arrow-right"></i>
                </button>
              </div>
            </div>
            
            <!-- STEP 5: Review & Submit -->
            <div class="step-card" id="step-5">
              <div class="step-card-header">
                <div class="step-icon">
                  <i class="fas fa-check-circle"></i>
                </div>
                <div class="step-title">
                  <h3>‚úÖ Step 5: Review & Submit</h3>
                  <p>Review all details before submitting your order</p>
                </div>
              </div>
              
              <div class="summary-section">
                <h4 style="color: #1e293b; font-size: 16px; font-weight: 700; margin-bottom: 12px;">Order Summary</h4>
                
                <div class="summary-grid">
                  <div class="summary-item">
                    <div class="summary-item-label">SO Number</div>
                    <div class="summary-item-value" id="reviewSONumber">-</div>
                  </div>
                  <div class="summary-item">
                    <div class="summary-item-label">SO Date</div>
                    <div class="summary-item-value" id="reviewSODate">-</div>
                  </div>
                  <div class="summary-item">
                    <div class="summary-item-label">Status</div>
                    <div class="summary-item-value" id="reviewStatus">-</div>
                  </div>
                  <div class="summary-item">
                    <div class="summary-item-label">Ship To</div>
                    <div class="summary-item-value" id="reviewCustomer">-</div>
                  </div>
                  <div class="summary-item">
                    <div class="summary-item-label">Ship Via</div>
                    <div class="summary-item-value" id="reviewShipVia">-</div>
                  </div>
                  <div class="summary-item">
                    <div class="summary-item-label">Line Items</div>
                    <div class="summary-item-value" id="reviewLineItems">0</div>
                  </div>
                </div>
              </div>
              
              <div style="background: white; border-radius: 12px; padding: 20px; margin-top: 20px; border: 2px solid #e5e7eb;">
                <h4 style="color: #1e293b; font-size: 16px; font-weight: 700; margin-bottom: 16px;">Actions</h4>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                  <button type="button" onclick="showSaveOptionsModal()" class="btn-step btn-step-primary" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                    <i class="fas fa-save"></i> Save & Continue
                  </button>
                  <button type="button" onclick="showPrintView()" class="btn-step btn-step-secondary">
                    <i class="fas fa-print"></i> Print Preview
                  </button>
                  <button type="button" onclick="handleClear()" class="btn-step btn-step-secondary">
                    <i class="fas fa-eraser"></i> Clear Form
                  </button>
                </div>
              </div>
              
              <div class="step-navigation">
                <button class="btn-step btn-step-secondary" onclick="prevStep()">
                  <i class="fas fa-arrow-left"></i> Back
                </button>
                <div></div>
              </div>
            </div>
            
            <!-- Elegant SO Display -->
            <div class="po-header-display" id="soHeaderDisplay" style="display: none; margin-bottom: 24px;">
              
              <!-- Header Card -->
              <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 16px; overflow: hidden; border: 1px solid #f1f5f9;">
                <div style="padding: 24px; border-bottom: 1px solid #f1f5f9;">
                  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 32px;">
                    <div>
                      <div style="color: #6b7280; font-size: 12px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Sales Order Date</div>
                      <div id="displaySODate" style="font-size: 18px; font-weight: 600; color: #1f2937;">-</div>
                    </div>
                  </div>
                </div>
                
                <div style="display: flex; justify-content: center; padding: 16px;">
                  <div style="display: flex; align-items: center; gap: 12px;">
                    <div style="color: #6b7280; font-size: 12px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px;">Status</div>
                    <select id="displayStatusSelect" style="font-size: 14px; padding: 8px 16px; border: 1px solid #e5e7eb; border-radius: 6px; background: white; color: #374151; font-weight: 500;">
                      <option>New</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <!-- Client & Ship To Cards -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                
                <!-- Client Card -->
                <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid #f1f5f9; overflow: hidden;">
                  <div style="padding: 20px 24px 16px; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-bottom: 1px solid #bbf7d0;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                      <div style="color: #166534; font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Client Information</div>
                      <button style="font-size: 11px; padding: 6px 12px; background: #22c55e; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">Update</button>
                    </div>
                    <input type="text" id="displayCustomerCode" style="width: 100%; font-size: 14px; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 6px; background: white; font-weight: 500;" readonly>
                  </div>
                  <div style="padding: 20px 24px;">
                    <div id="displayCustomerName" style="font-weight: 600; font-size: 16px; color: #1f2937; margin-bottom: 8px;">-</div>
                    <div id="displayCustomerAddress" style="font-size: 14px; color: #6b7280; line-height: 1.5; white-space: pre-line;">-</div>
                  </div>
                </div>
                
                
              </div>
            </div>
            
            <!-- Saved Drafts Modal -->
            <div id="savedDraftsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.6); z-index: 10000; align-items: center; justify-content: center;">
              <div style="background: white; border-radius: 16px; max-width: 800px; width: 90%; max-height: 80vh; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); overflow: hidden; display: flex; flex-direction: column;">
                <div style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; padding: 20px 24px; display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <h2 style="margin: 0; font-size: 20px; font-weight: 700;"><i class="fas fa-clock"></i> My Saved Drafts</h2>
                    <p style="margin: 4px 0 0 0; font-size: 12px; opacity: 0.9;">Continue editing your saved orders</p>
                  </div>
                  <button onclick="closeSavedDraftsModal()" style="background: rgba(255,255,255,0.2); border: none; color: white; font-size: 20px; cursor: pointer; padding: 8px 12px; border-radius: 6px; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)';" onmouseout="this.style.background='rgba(255,255,255,0.2)';">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                
                <div id="draftsListContainer" style="flex: 1; overflow-y: auto; padding: 20px;">
                  <div style="text-align: center; padding: 40px; color: #6b7280;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 12px;"></i>
                    <p>Loading drafts...</p>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Save Options Modal -->
            <div id="saveOptionsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0, 0, 0, 0.6); z-index: 10000; align-items: center; justify-content: center;">
              <div style="background: white; border-radius: 16px; max-width: 500px; width: 90%; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); overflow: hidden;">
                <div style="background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%); color: white; padding: 24px; text-align: center;">
                  <i class="fas fa-save" style="font-size: 48px; margin-bottom: 12px;"></i>
                  <h2 style="margin: 0; font-size: 24px; font-weight: 700;">Save Sales Order</h2>
                  <p style="margin: 8px 0 0 0; font-size: 14px; opacity: 0.9;">Choose how you want to save this order</p>
                </div>
                
                <div style="padding: 32px 24px;">
                  <div style="margin-bottom: 20px;">
                    <button onclick="saveForLater()" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 12px; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 10px;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 8px 16px rgba(251, 191, 36, 0.4)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                      <i class="fas fa-clock"></i>
                      <span>Save for Later</span>
                    </button>
                    <p style="margin: 0 0 20px 0; font-size: 12px; color: #6b7280; text-align: center;">Save as temporary draft in TMP database</p>
                    
                    <button onclick="saveFinal()" style="width: 100%; padding: 16px; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; gap: 10px;" onmouseover="this.style.transform='scale(1.02)'; this.style.boxShadow='0 8px 16px rgba(16, 185, 129, 0.4)';" onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='none';">
                      <i class="fas fa-check-circle"></i>
                      <span>Save Final</span>
                    </button>
                    <p style="margin: 0; font-size: 12px; color: #6b7280; text-align: center;">Create final SO and generate SO number</p>
                  </div>
                  
                  <button onclick="closeSaveOptionsModal()" style="width: 100%; padding: 12px; background: #6b7280; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='#4b5563';" onmouseout="this.style.background='#6b7280';">
                    <i class="fas fa-times"></i> Cancel
                  </button>
                </div>
              </div>
            </div>
            
            </div> <!-- Close Steps Container with Scroll -->
          </div> <!-- Close walkthrough-container -->
          </div>
        </div>
        
        <div class="tab-pane" id="tab-1">
          <div class="form-container">
            <h3 style="margin-bottom:8px; color:#1e293b; font-size:14px; font-weight:600;">Search & View Sales Orders</h3>
            <p style="color:#6b7280; font-size:12px; margin-bottom:12px;">Search and view existing sales orders in the system.</p>
            
            <!-- Search Controls -->
            <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; align-items: end;">
                <div>
                  <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">SO Number:</label>
                  <input type="text" id="searchSONumber" placeholder="Enter SO Number" style="width: 100%; border: 1px solid #cbd5e1; border-radius: 4px; padding: 8px; font-size: 12px;">
                </div>
                <div>
                  <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Ship To Code:</label>
                  <input type="text" id="searchCustomerCode" placeholder="Ship To Code" style="width: 100%; border: 1px solid #cbd5e1; border-radius: 4px; padding: 8px; font-size: 12px;">
                </div>
                <div>
                  <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Status:</label>
                  <select id="searchStatus" style="width: 100%; border: 1px solid #cbd5e1; border-radius: 4px; padding: 8px; font-size: 12px;">
                    <option value="">All Status</option>
                    <option value="OPEN">Open</option>
                    <option value="PENDING">Pending</option>
                    <option value="APPROVED">Approved</option>
                    <option value="SENT">Sent</option>
                    <option value="RECEIVED">Received</option>
                    <option value="CLOSED">Closed</option>
                    <option value="CANCELLED">Cancelled</option>
                  </select>
                </div>
                <div style="display: flex; gap: 8px;">
                  <button onclick="searchPurchaseOrders()" class="btn btn-primary" style="padding: 8px 16px; font-size: 12px;">
                    <i class="fas fa-search"></i> Search
                  </button>
                  <button onclick="clearSearchForm()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px;">
                    <i class="fas fa-times"></i> Clear
                  </button>
                  <button onclick="showSavedDrafts()" style="padding: 8px 16px; font-size: 12px; background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                    <i class="fas fa-clock"></i> My Drafts
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Search Results -->
            <div id="searchResults" style="background: white; border-radius: 8px; border: 1px solid #e2e8f0; overflow: hidden;">
              <div style="background: #f8fafc; padding: 12px; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                <h4 style="margin: 0; font-size: 13px; font-weight: 600; color: #374151;">Search Results</h4>
                <span id="searchResultsCount" style="font-size: 11px; color: #6b7280;">Ready to search</span>
              </div>
              
              <!-- Results Table Header -->
              <div style="padding: 8px; display: grid; grid-template-columns: 100px 100px 1fr 80px 100px 80px; gap: 8px; font-size: 11px; font-weight: 600; color: #374151; background: #f9fafb; border-bottom: 1px solid #f3f4f6;">
                <div>SO Number</div>
                <div>Customer</div>
                <div>Description</div>
                <div>Status</div>
                <div>Total</div>
                <div>Actions</div>
              </div>
              
              <!-- Results Body -->
              <div id="searchResultsBody" style="min-height: 200px; display: flex; align-items: center; justify-content: center; color: #9ca3af; font-size: 12px;">
                Enter search criteria and click Search to find sales orders
              </div>
            </div>
          </div>
        </div>
        
        <div class="tab-pane" id="tab-2">
          <div class="form-container" style="max-width: 1450px; margin: 0 auto; padding: 12px;">
            
            <!-- Header Section -->
            <div style="background: linear-gradient(135deg, #1e293b 0%, #1e3a8a 100%); border-radius: 8px; padding: 12px; margin-bottom: 12px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <h3 style="margin: 0; color: white; font-size: 14px; font-weight: 700;">Line Item Editor</h3>
                  <p style="margin: 3px 0 0 0; color: #cbd5e1; font-size: 11px;">Line Number: <span id="displayLineNumber" style="color: #60a5fa; font-weight: 600;">NEW</span></p>
                </div>
                <div style="display: flex; gap: 12px;">
                  <button type="button" onclick="addLineItem()" class="btn-step btn-step-primary" style="padding: 6px 12px; font-size: 12px;">
                    <i class="fas fa-save"></i> Save Line Item
                  </button>
                  <button type="button" onclick="hideAddLineItemForm()" class="btn-step btn-step-secondary" style="padding: 6px 12px; font-size: 12px;">
                    <i class="fas fa-arrow-left"></i> Back to List
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Line Item Form -->
            <div id="lineItemForm" class="line-item-form" style="display: block;">
              
              <!-- Basic Information Section -->
              <div style="background: white; border-radius: 8px; padding: 12px; margin-bottom: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); border: 1px solid #e5e7eb;">
                <h4 style="margin: 0 0 10px 0; color: #1e293b; font-size: 14px; font-weight: 700; display: flex; align-items: center; gap: 8px;">
                  <i class="fas fa-info-circle" style="color: #3b82f6;"></i>
                  Basic Information
                </h4>
                
                <!-- Form Grid -->
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px;">
                  
                  <div class="field-wrapper">
                    <label>Part Number <span class="required-mark">*</span></label>
                    <input type="text" id="linePartNumber" name="linePartNumber" placeholder="Enter part number" onkeydown="handlePartNumberKeyDown(event)" onblur="lookupPartInfo()">
                    <div class="field-hint"><i class="fas fa-box"></i> Product part number - Press ENTER to auto-fill</div>
                  </div>
                  
                  <div class="field-wrapper">
                    <label>Quantity <span class="required-mark">*</span></label>
                    <input type="number" id="lineQuantity" name="lineQuantity" step="0.01" oninput="calculateLineTotal()" onchange="lookupPriceFromDatabase()" placeholder="0" style="font-size: 16px; padding: 12px 14px; width: 180px;">
                    <div class="field-hint"><i class="fas fa-hashtag"></i> Quantity ordered - Auto-fills price from database</div>
                  </div>
                  
                  <div class="field-wrapper">
                    <label>Unit Price <span class="required-mark">*</span></label>
                    <input type="number" id="lineUnitPrice" name="lineUnitPrice" step="0.0001" oninput="calculateLineTotal()" onchange="calculateLineTotal()" placeholder="0.0000">
                    <div class="field-hint"><i class="fas fa-dollar-sign"></i> Price per unit</div>
                  </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                  <div class="field-wrapper">
                    <label>UOM</label>
                    <input type="text" id="lineUOM" name="lineUOM" placeholder="EA, LB, KG, etc.">
                    <div class="field-hint"><i class="fas fa-ruler"></i> Unit of measure</div>
                  </div>
                  
                  <div style="background: linear-gradient(135deg, #dbeafe, #bfdbfe); border-radius: 6px; padding: 10px; border: 2px solid #3b82f6;">
                    <label style="display: block; font-size: 13px; font-weight: 600; color: #1e40af; margin-bottom: 8px;">Line Total</label>
                    <div style="font-size: 20px; font-weight: 700; color: #1e3a8a;">$<span id="lineTotal">0.00</span></div>
                  </div>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr; gap: 12px;">
                  <div class="field-wrapper">
                    <label>Description</label>
                    <textarea id="lineDescription" name="lineDescription" rows="2" placeholder="Product description"></textarea>
                    <div class="field-hint"><i class="fas fa-align-left"></i> Detailed product description</div>
                  </div>
                  
                  <div class="field-wrapper">
                    <label>Line Notes</label>
                    <textarea rows="2" name="lineNotes" id="lineNotes" placeholder="Additional notes for this line item"></textarea>
                    <div class="field-hint"><i class="fas fa-sticky-note"></i> Optional notes</div>
                  </div>
                </div>
                
                <input type="hidden" id="lineNumber" name="lineNumber" value="1">
              </div>
              
              <!-- Production Notes Section -->
              <div style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 2px solid #e5e7eb;">
                <h4 style="margin: 0 0 20px 0; color: #1e293b; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                  <i class="fas fa-industry" style="color: #f59e0b;"></i>
                  Production Notes
                </h4>
                
                <div class="field-wrapper">
                  <label>Production Notes</label>
                  <textarea rows="3" name="lineProdNotes" id="lineProdNotes" placeholder="Special production instructions or requirements"></textarea>
                  <div class="field-hint"><i class="fas fa-tools"></i> Manufacturing notes and special instructions</div>
                </div>
              </div>
              
              <!-- Tracking Information Section -->
              <div style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 2px solid #e5e7eb;">
                <h4 style="margin: 0 0 20px 0; color: #1e293b; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                  <i class="fas fa-chart-line" style="color: #10b981;"></i>
                  Tracking Information
                </h4>
                
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px;">
                  
                  <!-- Need Info Section -->
                  <div style="background: linear-gradient(135deg, #d1fae5, #a7f3d0); border-radius: 10px; padding: 16px; border: 2px solid #10b981;">
                    <h6 style="margin: 0 0 12px 0; color: #065f46; font-size: 17px; font-weight: 700; text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px;">
                      <i class="fas fa-calendar-check"></i> Need Info
                    </h6>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 15px; font-weight: 600; color: #065f46; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #10b981;">
                      <div>Date</div>
                      <div>Quantity</div>
                    </div>
                    <div id="needRowsContainer" style="max-height: 300px; overflow-y: auto;"></div>
                    <button type="button" onclick="addNeedRow()" class="btn-step btn-step-primary" style="width: 100%; margin-top: 12px; padding: 10px; font-size: 13px; background: #10b981;">
                      <i class="fas fa-plus"></i> Add Need Date
                    </button>
                  </div>
                  
                  <!-- Schedules Section -->
                  <div style="background: linear-gradient(135deg, #e9d5ff, #ddd6fe); border-radius: 10px; padding: 16px; border: 2px solid #8b5cf6;">
                    <h6 style="margin: 0 0 12px 0; color: #5b21b6; font-size: 17px; font-weight: 700; text-align: center; display: flex; align-items: center; justify-content: center; gap: 8px;">
                      <i class="fas fa-clock"></i> Schedules Info
                    </h6>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 40px; gap: 8px; font-size: 15px; font-weight: 600; color: #5b21b6; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 2px solid #8b5cf6;">
                      <div>Date</div>
                      <div>Quantity</div>
                      <div>RS</div>
                    </div>
                    <div id="schedRowsContainer" style="max-height: 300px; overflow-y: auto;"></div>
                    <button type="button" onclick="addSchedRow()" class="btn-step btn-step-primary" style="width: 100%; margin-top: 12px; padding: 10px; font-size: 13px; background: #8b5cf6;">
                      <i class="fas fa-plus"></i> Add Schedule
                    </button>
                  </div>
                </div>
              </div>
              
              <!-- Shipments Section -->
              <div style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 2px solid #10b981;">
                <h4 style="margin: 0 0 20px 0; color: #065f46; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                  <i class="fas fa-shipping-fast" style="color: #10b981;"></i>
                  Shipments
                </h4>
                
                <div style="overflow-x: auto;">
                  <table style="width: 100%; border-collapse: collapse; font-size: 14px; background: white;">
                    <thead>
                      <tr style="background: linear-gradient(135deg, #10b981, #059669); color: white;">
                        <th style="padding: 12px 16px; font-weight: 600; text-align: left; border-bottom: 2px solid #047857;">Date</th>
                        <th style="padding: 12px 16px; font-weight: 600; text-align: left; border-bottom: 2px solid #047857;">Shipped Qty</th>
                        <th style="padding: 12px 16px; font-weight: 600; text-align: left; border-bottom: 2px solid #047857;">Invoice No.</th>
                        <th style="padding: 12px 16px; font-weight: 600; text-align: left; border-bottom: 2px solid #047857;">Waybill No.</th>
                      </tr>
                    </thead>
                    <tbody id="shipmentsTableBody">
                      <tr>
                        <td colspan="4" style="padding: 40px; text-align: center; color: #9ca3af; font-style: italic; font-size: 14px;">
                          <i class="fas fa-box-open" style="font-size: 48px; color: #d1fae5; display: block; margin-bottom: 12px;"></i>
                          No shipments recorded yet
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              
              <!-- Pickslips Section -->
              <div style="background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 2px solid #f59e0b;">
                <h4 style="margin: 0 0 20px 0; color: #92400e; font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 10px;">
                  <i class="fas fa-clipboard-list" style="color: #f59e0b;"></i>
                  Pickslips
                </h4>
                
                <div style="overflow-x: auto;">
                  <table style="width: 100%; border-collapse: collapse; font-size: 14px; background: white;">
                    <thead>
                      <tr style="background: linear-gradient(135deg, #f59e0b, #d97706); color: white;">
                        <th style="padding: 12px 16px; font-weight: 600; text-align: left; border-bottom: 2px solid #b45309;">Pickslip Date</th>
                        <th style="padding: 12px 16px; font-weight: 600; text-align: left; border-bottom: 2px solid #b45309;">Pickslip Qty</th>
                        <th style="padding: 12px 16px; font-weight: 600; text-align: left; border-bottom: 2px solid #b45309;">Pickslip No.</th>
                      </tr>
                    </thead>
                    <tbody id="pickslipsTableBody">
                      <tr>
                        <td colspan="3" style="padding: 40px; text-align: center; color: #9ca3af; font-style: italic; font-size: 14px;">
                          <i class="fas fa-clipboard" style="font-size: 48px; color: #fef3c7; display: block; margin-bottom: 12px;"></i>
                          No pickslips recorded yet
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              
            </div>
          </div>
        </div>
            
          </div>
        </div>
        
      </div>
    </div>
  </div>


  <script>
    function switchTab(index) {
      try {
        var buttons = document.querySelectorAll('.tab-button');
        var panes = document.querySelectorAll('.tab-pane');
        
        buttons.forEach(function(btn, i) {
          if (i === index) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
        
        panes.forEach(function(pane, i) {
          if (i === index) {
            pane.classList.add('active');
          } else {
            pane.classList.remove('active');
          }
        });
      } catch (e) {
        console.error('switchTab error:', e);
      }
    }

    function switchLineTab(index) {
      try {
        var buttons = document.querySelectorAll('#tab-2 .line-tab-button');
        var panes = document.querySelectorAll('#tab-2 .line-tab-pane');
        
        buttons.forEach(function(btn, i) {
          if (i === index) {
            btn.classList.add('active');
          } else {
            btn.classList.remove('active');
          }
        });
        
        panes.forEach(function(pane, i) {
          if (i === index) {
            pane.classList.add('active');
          } else {
            pane.classList.remove('active');
          }
        });
      } catch (e) {
        console.error('switchLineTab error:', e);
      }
    }

    // ========== WALKTHROUGH NAVIGATION FUNCTIONS ==========
    let currentStep = 1;
    const totalSteps = 5;

    function goToStep(stepNumber) {
      if (stepNumber < 1 || stepNumber > totalSteps) return;
      
      // Hide all steps
      for (let i = 1; i <= totalSteps; i++) {
        const stepCard = document.getElementById('step-' + i);
        const stepIndicator = document.querySelector('.step-indicator[data-step="' + i + '"]');
        
        if (stepCard) stepCard.classList.remove('active');
        if (stepIndicator) {
          stepIndicator.classList.remove('active');
          if (i < stepNumber) {
            stepIndicator.classList.add('completed');
          } else {
            stepIndicator.classList.remove('completed');
          }
        }
      }
      
      // Show target step
      const targetStep = document.getElementById('step-' + stepNumber);
      const targetIndicator = document.querySelector('.step-indicator[data-step="' + stepNumber + '"]');
      
      if (targetStep) targetStep.classList.add('active');
      if (targetIndicator) targetIndicator.classList.add('active');
      
      currentStep = stepNumber;
      updateProgressBar();
      updateReviewSummary();
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function nextStep() {
      if (currentStep < totalSteps) {
        goToStep(currentStep + 1);
      }
    }

    function prevStep() {
      if (currentStep > 1) {
        goToStep(currentStep - 1);
      }
    }

    function updateProgressBar() {
      const progressFill = document.getElementById('progressBarFill');
      if (progressFill) {
        // Calculate progress but ensure it doesn't exceed 100%
        const progress = Math.min(((currentStep - 1) / (totalSteps - 1)) * 100, 100);
        // Apply the width relative to the container (already limited by max-width in CSS)
        progressFill.style.width = progress + '%';
      }
    }

    // ========== VALIDATION FUNCTIONS ==========
    function validateStep1() {
      const soDate = document.getElementById('soDateInput').value;
      const soStatus = document.getElementById('soStatusInput').value;
      const nextBtn = document.getElementById('step1NextBtn');
      
      if (soDate && soStatus) {
        nextBtn.disabled = false;
        nextBtn.style.opacity = '1';
      } else {
        nextBtn.disabled = true;
        nextBtn.style.opacity = '0.5';
      }
    }

    function validateStep2() {
      const customerCode = document.getElementById('customerCodeInput').value;
      const nextBtn = document.getElementById('step2NextBtn');
      
      if (customerCode && customerCode.trim() !== '') {
        nextBtn.disabled = false;
        nextBtn.style.opacity = '1';
      } else {
        nextBtn.disabled = true;
        nextBtn.style.opacity = '0.5';
      }
    }

    // ========== REVIEW SUMMARY UPDATE ==========
    function updateReviewSummary() {
      if (currentStep !== 5) return;
      
      // Update SO Number
      const soNumber = document.getElementById('soNumberInput').value;
      document.getElementById('reviewSONumber').textContent = soNumber || '-';
      
      // Update SO Date
      const soDate = document.getElementById('soDateInput').value;
      document.getElementById('reviewSODate').textContent = soDate || '-';
      
      // Update Status
      const soStatus = document.getElementById('soStatusInput');
      const statusText = soStatus.options[soStatus.selectedIndex]?.text || '-';
      document.getElementById('reviewStatus').textContent = statusText;
      
      // Update Customer
      const customerName = document.getElementById('customerName').textContent;
      document.getElementById('reviewCustomer').textContent = customerName !== '-' ? customerName : '-';
      
      // Update Ship Via
      const shipVia = document.getElementById('shipViaSelect');
      const shipViaText = shipVia.options[shipVia.selectedIndex]?.text || '-';
      document.getElementById('reviewShipVia').textContent = shipViaText;
      
      // Update Line Items Count from window.lineItems array
      let lineItemsCount = 0;
      if (typeof lineItems !== 'undefined' && Array.isArray(lineItems)) {
        lineItemsCount = lineItems.length;
        console.log('üìä Line Items Count from window.lineItems:', lineItemsCount);
      } else if (typeof window.lineItems !== 'undefined' && Array.isArray(window.lineItems)) {
        lineItemsCount = window.lineItems.length;
        console.log('üìä Line Items Count from window.lineItems:', lineItemsCount);
      } else {
        console.log('‚ö†Ô∏è No line items found in global scope');
        lineItemsCount = 0;
      }
      document.getElementById('reviewLineItems').textContent = lineItemsCount;
    }

    // ========== GET NEXT SO NUMBER FROM LIID (FOR FINAL SUBMIT) ==========
    function getNextSONumberForSubmit() {
      console.log('üî¢ Getting next SO Number from LIID for final submit...');
      
      showNotification('‚è≥ Getting SO Number from system...', 'loading');
      
      const xhr = new XMLHttpRequest();
      const liidUrl = 'GET_LIID_CLEAN.XML?TYPE=SO&_cb=' + Date.now();
      console.log('üì° LIID Request URL:', liidUrl);
      xhr.open('GET', liidUrl, true);
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            try {
              const parser = new DOMParser();
              const xmlDoc = parser.parseFromString(xhr.responseText, 'text/xml');
              
              const status = xmlDoc.querySelector('status')?.textContent;
              const nextId = xmlDoc.querySelector('next_id')?.textContent;
              const idType = xmlDoc.querySelector('id_type')?.textContent;
              
              console.log('üì• LIID Response:', xhr.responseText);
              console.log('üìä Parsed LIID: status=' + status + ', id_type=' + idType + ', next_id=' + nextId);
              
              if (status === 'success' && nextId) {
                console.log('‚úÖ Got SO Number from LIID:', nextId);
                
                // Set the SO Number in the input field
                const soNumberInput = document.getElementById('soNumberInput');
                if (soNumberInput) {
                  soNumberInput.value = nextId;
                  soNumberInput.style.backgroundColor = '#e8f5e9'; // Light green
                  soNumberInput.style.fontWeight = 'bold';
                  soNumberInput.style.color = '#2e7d32';
                }
                
                showNotification('‚úÖ SO Number assigned: ' + nextId, 'success');
                
                // Now proceed with the save
                setTimeout(() => {
                  proceedWithSOSave();
                }, 500);
              } else {
                console.error('‚ùå Failed to get SO Number from LIID');
                showNotification('‚ùå Could not generate SO Number. Cannot save.', 'error');
              }
            } catch (error) {
              console.error('‚ùå Error parsing LIID response:', error);
              showNotification('‚ùå Error getting SO Number. Cannot save.', 'error');
            }
          } else {
            console.error('‚ùå LIID request failed with status:', xhr.status);
            showNotification('‚ùå Could not connect to LIID database. Cannot save.', 'error');
          }
        }
      };
      
      xhr.send();
    }

    // ========== GET NEXT SO NUMBER FROM LIID (FOR DISPLAY ONLY - NOT USED) ==========
    function getNextSONumber() {
      console.log('üî¢ Getting next SO Number from LIID database...');
      
      const xhr = new XMLHttpRequest();
      xhr.open('GET', 'GET_LIID_CLEAN.XML?TYPE=SO&_cb=' + Date.now(), true);
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            try {
              const parser = new DOMParser();
              const xmlDoc = parser.parseFromString(xhr.responseText, 'text/xml');
              
              const status = xmlDoc.querySelector('status')?.textContent;
              const nextId = xmlDoc.querySelector('next_id')?.textContent;
              
              if (status === 'success' && nextId) {
                console.log('‚úÖ Got next SO Number from LIID:', nextId);
                
                // Set the SO Number in the input field
                const soNumberInput = document.getElementById('soNumberInput');
                if (soNumberInput) {
                  soNumberInput.value = nextId;
                  soNumberInput.style.backgroundColor = '#e8f5e9'; // Light green
                  soNumberInput.style.fontWeight = 'bold';
                  soNumberInput.style.color = '#2e7d32';
                }
                
                showNotification('‚úÖ SO Number assigned: ' + nextId, 'success');
              } else {
                console.warn('‚ö†Ô∏è LIID not available, using temporary SO Number');
                
                // Fallback: Generate temporary SO Number
                const tempSONumber = 'TEMP-' + Date.now();
                const soNumberInput = document.getElementById('soNumberInput');
                if (soNumberInput) {
                  soNumberInput.value = tempSONumber;
                  soNumberInput.style.backgroundColor = '#fff3cd'; // Light yellow
                  soNumberInput.style.fontWeight = 'bold';
                  soNumberInput.style.color = '#856404';
                }
                
                showNotification('‚ö†Ô∏è Using temporary SO Number. Final number will be assigned when saved.', 'warning');
              }
            } catch (error) {
              console.error('‚ùå Error parsing LIID response:', error);
              showNotification('‚ö†Ô∏è Error getting SO Number', 'error');
            }
          } else {
            console.error('‚ùå LIID request failed with status:', xhr.status);
            console.warn('‚ö†Ô∏è Using temporary SO Number as fallback');
            
            // Fallback: Generate temporary SO Number
            const tempSONumber = 'TEMP-' + Date.now();
            const soNumberInput = document.getElementById('soNumberInput');
            if (soNumberInput) {
              soNumberInput.value = tempSONumber;
              soNumberInput.style.backgroundColor = '#fff3cd'; // Light yellow
              soNumberInput.style.fontWeight = 'bold';
              soNumberInput.style.color = '#856404';
            }
            
            showNotification('‚ö†Ô∏è LIID database unavailable. Using temporary SO Number.', 'warning');
          }
        }
      };
      
      xhr.send();
    }

    // ========== START NEW SO FUNCTION ==========
    function startNewSO() {
      // Reset form
      handleClear();
      
      // Go to step 1
      goToStep(1);
      
      // Show NEW SO Banner
      const banner = document.getElementById('newSOBanner');
      if (banner) {
        banner.style.display = 'block';
        // Add fade-in animation
        banner.style.opacity = '0';
        banner.style.transform = 'translateY(-20px)';
        banner.style.transition = 'all 0.5s ease-out';
        setTimeout(() => {
          banner.style.opacity = '1';
          banner.style.transform = 'translateY(0)';
        }, 100);
      }
      
      // Set default date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('soDateInput').value = today;
      
      // Clear SO Number field (will be assigned on final submit, not on draft save)
      const soNumberInput = document.getElementById('soNumberInput');
      if (soNumberInput) {
        soNumberInput.value = '';
        soNumberInput.placeholder = 'Will be assigned on submit';
        soNumberInput.style.backgroundColor = '#f5f5f5';
        soNumberInput.style.fontWeight = 'normal';
        soNumberInput.style.color = '#666';
      }
      
      // Trigger validation
      validateStep1();
      
      // Show notification
      showNotification('New Sales Order form ready', 'success');
    }

    // Override existing customer change handler to enable Step 2 next button
    const originalOnCustomerChange = window.onCustomerChange;
    window.onCustomerChange = function() {
      if (originalOnCustomerChange) originalOnCustomerChange();
      validateStep2();
    };

    // Initialize walkthrough on page load
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üéØ SO_EDIT.HTM - DOMContentLoaded fired');
      console.log('üì¶ Checking sessionStorage...');
      console.log('   userInitials:', sessionStorage.getItem('userInitials'));
      console.log('   userName:', sessionStorage.getItem('userName'));
      
      // Check user session - redirect to login if not authenticated
      if (!checkUserSession()) {
        console.log('‚ùå checkUserSession returned false - stopping initialization');
        return; // Stop initialization if not logged in
      }
      
      console.log('‚úÖ Session check passed - continuing initialization');
      
      // Display logged in user
      const userInitials = getUserInitials();
      const userName = getUserName();
      console.log('üë§ Logged in user:', userInitials, '-', userName);
      
      // Update header with user name
      const userDisplayElement = document.getElementById('currentUserDisplay');
      if (userDisplayElement) {
        // Show full name if available, otherwise show initials
        const displayName = userName || userInitials || 'User';
        userDisplayElement.textContent = displayName;
        console.log('‚úÖ Updated header display:', displayName);
      }
      
      // Initialize to step 1
      goToStep(1);
      
      // Set today's date as default
      const today = new Date().toISOString().split('T')[0];
      const soDateInput = document.getElementById('soDateInput');
      if (soDateInput && !soDateInput.value) {
        soDateInput.value = today;
        validateStep1();
      }
      
      // Add input listeners for real-time validation
      const soStatusInput = document.getElementById('soStatusInput');
      if (soStatusInput) {
        soStatusInput.addEventListener('change', validateStep1);
      }
      
      if (soDateInput) {
        soDateInput.addEventListener('change', validateStep1);
      }
      
      const customerInput = document.getElementById('customerCodeInput');
      if (customerInput) {
        customerInput.addEventListener('input', validateStep2);
        customerInput.addEventListener('change', validateStep2);
      }
      
      console.log('‚úÖ Walkthrough initialized successfully');
    });

    // Event listeners
    document.addEventListener("click", function(ev) {
      try {
        var btn = ev.target.closest && ev.target.closest(".tab-button");
        if (btn) {
          var list = document.querySelectorAll(".tab-button");
          var idx = Array.prototype.indexOf.call(list, btn);
          if (typeof window.switchTab === "function") {
            window.switchTab(idx);
          }
          ev.preventDefault();
          return false;
        }
        
        var menuLink = ev.target.closest && ev.target.closest(".sidebar-menu a, .sidebar-menu label");
        if (menuLink) {
          var links = document.querySelectorAll(".sidebar-menu a, .sidebar-menu label");
          for (var k = 0; k < links.length; k++) {
            links[k].classList.remove("active");
          }
          menuLink.classList.add("active");
          if (menuLink.tagName && menuLink.tagName.toLowerCase() === 'a') {
            try { 
              var toggle = document.getElementById('sb-toggle');
              if (toggle) toggle.checked = false;
            } catch (e2) { /* noop */ }
            ev.preventDefault();
            return false;
          }
          return;
        }
      } catch (e) {
        console.error("Event listener error:", e);
      }
    });

    // Scoped event delegation for Line Item modal tabs
    document.addEventListener("click", function(ev) {
      try {
        var lineBtn = ev.target.closest && ev.target.closest('#tab-2 .line-tab-button');
        if (lineBtn) {
          var list = document.querySelectorAll('#tab-2 .line-tab-button');
          var idx = Array.prototype.indexOf.call(list, lineBtn);
          if (typeof window.switchLineTab === 'function') {
            window.switchLineTab(idx);
          }
          ev.preventDefault();
          return false;
        }
      } catch (e) {
        console.error('Line tab event listener error:', e);
      }
    });

    // Form handling functions
    function handleSave() {
      saveSO();
      return false;
    }

    function handleClear() {
      try {
        var form = document.querySelector('.form-grid');
        if (form) {
          var inputs = form.querySelectorAll('input, select, textarea');
          inputs.forEach(function(input) {
            if (input.type === 'date') {
              input.value = '';
            } else if (input.tagName === 'SELECT') {
              input.selectedIndex = 0;
            } else {
              input.value = '';
            }
          });
        }
        
        // Clear line items
        lineItems = [];
        renderLineItems();
      } catch (e) {
        console.error('handleClear error:', e);
      }
      return false;
    }

    // Collect all form data for preview
    function collectSOData() {
      console.log('=== COLLECTING SO DATA FOR PREVIEW ===');
      
      const soData = {
        // Header information
        header: {
          soNumber: document.getElementById('soNumberInput')?.value || '',
          customerCode: document.getElementById('customerCodeInput')?.value || '',
          customerName: document.getElementById('customerName')?.textContent || '',
          shipToCode: document.getElementById('shipToCode')?.value || '',
          shipToName: document.getElementById('shipToName')?.textContent || '',
          shipVia: document.getElementById('shipViaSelect')?.selectedOptions[0]?.text || '',
          shipViaCode: document.getElementById('shipViaSelect')?.value || '',
          terms: document.getElementById('termsInput')?.value || '',
          poDate: document.getElementById('soDateInput')?.value || '',
          email: document.getElementById('emailInput')?.value || '',
          carrierAccount: document.getElementById('carrierAccountInput')?.value || '',
          soStatus: document.getElementById('soStatusInput')?.value || '',
          totalAmount: document.getElementById('totalAmountInput')?.value || '0.00',
          headerNotes: document.getElementById('notesInput')?.value || ''
        },
        
        // Line items
        lineItems: lineItems ? [...lineItems] : [],
        
        // Tracking information
        tracking: {
          needInfo: [],
          acknowledgments: [],
          schedules: []
        }
      };
      
      // CRITICAL FIX: Collect tracking data from lineItems structure (same as SAVE)
      console.log('üîç PREVIEW DEBUG: Collecting tracking data from lineItems structure...');
      
      // Process each line item and extract tracking data
      if (lineItems && lineItems.length > 0) {
        lineItems.forEach((item, lineIndex) => {
          console.log(`üîç PREVIEW DEBUG: Processing line item ${lineIndex}: ${item.partNumber}`);
          
          // Extract needs data from needEntries
          if (item.needEntries && item.needEntries.length > 0) {
            item.needEntries.forEach((needEntry, entryIndex) => {
              if (needEntry.date || needEntry.qty) {
                soData.tracking.needInfo.push({
                  index: `Line ${lineIndex + 1} Entry ${entryIndex + 1}`,
                  line: lineIndex + 1,
                  entryIndex: entryIndex + 1,
                  date: needEntry.date,
                  quantity: needEntry.qty,
                  partNumber: item.partNumber
                });
                console.log(`‚úÖ PREVIEW: Added need from line ${lineIndex + 1}: date="${needEntry.date}", qty="${needEntry.qty}"`);
              }
            });
          }
          
          // Extract acknowledgments from ackEntries
          if (item.ackEntries && item.ackEntries.length > 0) {
            item.ackEntries.forEach((ackEntry, entryIndex) => {
              if (ackEntry.date || ackEntry.qty) {
                soData.tracking.acknowledgments.push({
                  index: `Line ${lineIndex + 1} Entry ${entryIndex + 1}`,
                  line: lineIndex + 1,
                  entryIndex: entryIndex + 1,
                  date: ackEntry.date,
                  quantity: ackEntry.qty,
                  partNumber: item.partNumber
                });
                console.log(`‚úÖ PREVIEW: Added ack from line ${lineIndex + 1}: date="${ackEntry.date}", qty="${ackEntry.qty}"`);
              }
            });
          }
          
          // Extract schedules from scheduleEntries
          if (item.scheduleEntries && item.scheduleEntries.length > 0) {
            item.scheduleEntries.forEach((schedEntry, entryIndex) => {
              if (schedEntry.date || schedEntry.qty) {
                soData.tracking.schedules.push({
                  index: `Line ${lineIndex + 1} Entry ${entryIndex + 1}`,
                  line: lineIndex + 1,
                  entryIndex: entryIndex + 1,
                  date: schedEntry.date,
                  quantity: schedEntry.qty,
                  partNumber: item.partNumber
                });
                console.log(`‚úÖ PREVIEW: Added schedule from line ${lineIndex + 1}: date="${schedEntry.date}", qty="${schedEntry.qty}"`);
              }
            });
          }
        });
      } else {
        console.log('‚ö†Ô∏è PREVIEW DEBUG: No lineItems found or empty array');
      }
      
      console.log('üîç PREVIEW DEBUG: Final tracking data summary:');
      console.log(`üîç PREVIEW DEBUG: needInfo entries: ${soData.tracking.needInfo.length}`);
      console.log(`üîç PREVIEW DEBUG: acknowledgments entries: ${soData.tracking.acknowledgments.length}`);
      console.log(`üîç PREVIEW DEBUG: schedules entries: ${soData.tracking.schedules.length}`);
      console.log('üîç PREVIEW DEBUG: Full tracking object:', soData.tracking);
      
      console.log('Collected SO data:', soData);
      return soData;
    }

    // Navigate to preview page
    function continueWithSO() {
      console.log('=== CONTINUE WITH SO CLICKED ===');
      
      // Validate required fields
      const soNumber = document.getElementById('soNumberInput')?.value;
      const customerCode = document.getElementById('customerCodeInput')?.value;
      
      // SO Number validation removed - it will be generated on save
      // For new SOs, the number is assigned by the system when saving
      
      if (!customerCode) {
        alert('Please select a Customer');
        return;
      }
      
      // Validate SO Date
      const soDateInput = document.getElementById('soDateInput');
      const soDateValue = soDateInput?.value || '';
      
      if (soDateValue) {
        // Parse date and check year
        const dateParts = soDateValue.split('-');
        if (dateParts.length === 3) {
          const year = parseInt(dateParts[0], 10);
          if (year < 2020 || year > 2030) {
            alert('‚ö†Ô∏è Invalid date year: ' + year + '\n\nPlease enter a date between 2020 and 2030.');
            soDateInput.focus();
            return;
          }
        }
      }
      
      if (!lineItems || lineItems.length === 0) {
        alert('Please add at least one line item');
        return;
      }
      
      // Show save options modal instead of directly saving
      showSaveOptionsModal();
    }

    // Save Options Modal Functions
    function showSaveOptionsModal() {
      const modal = document.getElementById('saveOptionsModal');
      if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
    }

    function closeSaveOptionsModal() {
      const modal = document.getElementById('saveOptionsModal');
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
      }
    }

    function saveForLater() {
      console.log('=== SAVE FOR LATER CLICKED ===');
      closeSaveOptionsModal();
      
      // Get user initials from session/cookie
      const userInitials = getUserInitials();
      
      if (!userInitials) {
        showNotification('‚ùå User session not found. Please log in again.', 'error');
        return;
      }
      
      // DRAFT: Use fixed temp_id per user (so*EC)
      // FINAL SO: Will get LIID incremental number when converting to final
      const tempId = 'so*' + userInitials.toUpperCase();
      console.log('üíæ Draft temp_id:', tempId);
      
      // Check backend for existing draft to warn user
      fetch(`GET_SO_TMP.XML?user_initials=${encodeURIComponent(userInitials)}`)
        .then(response => response.text())
        .then(text => {
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(text, 'text/xml');
          const drafts = xmlDoc.querySelectorAll('temp_so');
          
          if (drafts.length > 0) {
            console.log('‚ö†Ô∏è User already has a draft saved');
            
            // Get existing draft data to show in confirmation
            const existingDraft = drafts[0];
            const existingCustomer = existingDraft.querySelector('customer_code')?.textContent || 'Unknown';
            const existingDate = existingDraft.querySelector('save_date')?.textContent || 'Unknown';
            const existingTime = existingDraft.querySelector('save_time')?.textContent || 'Unknown';
            
            // Show confirmation dialog with details
            const confirmMsg = `‚ö†Ô∏è You already have a draft saved!

üìã Existing Draft:
‚Ä¢ Customer: ${existingCustomer}
‚Ä¢ Saved: ${existingDate} at ${existingTime}

üîÑ NEW DATA will OVERWRITE the old draft.

Do you want to continue?`;
            
            if (!confirm(confirmMsg)) {
              console.log('‚ùå User cancelled save');
              return;
            }
            
            console.log('‚úÖ User confirmed overwrite');
          }
          
          // Proceed with save
          console.log('‚úÖ Proceeding with save...');
          
          // Collect SO data
          const soData = collectSOData();
          soData.save_mode = 'TEMP';
          
          console.log('üìä SO data collected:');
          console.log('  Customer Code:', soData.header?.customerCode || '(empty)');
          console.log('  Line Items:', soData.lineItems?.length || 0);
          
          // Fixed temp_id: Only ONE draft per user (so*EC)
          // This will OVERWRITE any existing draft for this user
          soData.temp_id = tempId;
          
          console.log('üíæ Saving draft with temp_id:', soData.temp_id);
          console.log('üìä Data to save:', soData);
          
          // Show loading
          showNotification('Saving to TMP database...', 'loading');
          
          // Send to backend with TEMP flag
          saveSODataToTMP(soData);
        })
        .catch(error => {
          console.error('‚ùå Error checking for existing draft:', error);
          // If check fails, proceed anyway
          const soData = collectSOData();
          soData.save_mode = 'TEMP';
          soData.temp_id = tempId;
          
          showNotification('Saving to TMP database...', 'loading');
          saveSODataToTMP(soData);
        });
    }

    function saveFinal() {
      console.log('=== SAVE FINAL CLICKED ===');
      closeSaveOptionsModal();
      
      // Collect SO data
      const soData = collectSOData();
      soData.save_mode = 'FINAL';
      
      // Store in sessionStorage for preview page
      sessionStorage.setItem('soPreviewData', JSON.stringify(soData));
      
      // Show preview before final save
      showSOPreview(soData);
    }

    function getCookie(name) {
      // Helper function to get cookie value
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
      return null;
    }
    
    function getUserInitials() {
      // Try sessionStorage first, then cookies
      let initials = sessionStorage.getItem('userInitials');
      
      if (!initials) {
        // Try to get from cookie
        initials = getCookie('userInitials');
        
        if (initials) {
          console.log('üìù Found initials in cookie, restoring to sessionStorage:', initials);
          sessionStorage.setItem('userInitials', initials);
        } else {
          console.error('‚ùå No user initials found in sessionStorage or cookies');
          return '';
        }
      }
      
      return initials.toUpperCase();
    }
    
    function getUserName() {
      // Try sessionStorage first, then cookies
      let userName = sessionStorage.getItem('userName');
      
      if (!userName) {
        // Try to get from cookie
        userName = getCookie('userName');
        
        if (userName) {
          userName = decodeURIComponent(userName);
          console.log('üìù Found userName in cookie, restoring to sessionStorage:', userName);
          sessionStorage.setItem('userName', userName);
        }
      }
      
      return userName || '';
    }
    
    function checkUserSession() {
      // Try to get initials from sessionStorage or cookies
      let initials = sessionStorage.getItem('userInitials');
      
      if (!initials) {
        // Try cookie as fallback
        initials = getCookie('userInitials');
        
        if (initials) {
          console.log('üìù Restored session from cookie:', initials);
          sessionStorage.setItem('userInitials', initials);
          
          // Also restore userName if available
          const userName = getCookie('userName');
          if (userName) {
            sessionStorage.setItem('userName', decodeURIComponent(userName));
          }
        }
      }
      
      if (!initials) {
        console.error('‚ùå No user session found in sessionStorage or cookies. Redirecting to login...');
        window.location.href = '/LOGINEDIT.HTM';
        return false;
      }
      
      console.log('‚úÖ User session active:', initials);
      return true;
    }

    // Extract tracking data (needs/schedules) from form inputs
    function extractTrackingData(type) {
      const data = [];
      let prefix, qtyPrefix;
      
      if (type === 'need') {
        prefix = 'needDate';
        qtyPrefix = 'needQty';
      } else if (type === 'schedule') {
        prefix = 'lineScheduleDate';  // CORRECTED: schedules use lineScheduleDate
        qtyPrefix = 'lineScheduleQty'; // CORRECTED: schedules use lineScheduleQty
      }
      
      console.log(`üìÖ Extracting ${type} data from fields: ${prefix}1-5, ${qtyPrefix}1-5`);
      
      // Collect all tracking entries from the form
      for (let i = 1; i <= 5; i++) {
        const dateField = document.getElementById(prefix + i);
        const qtyField = document.getElementById(qtyPrefix + i);
        
        if (dateField && qtyField && dateField.value && qtyField.value) {
          const dateValue = dateField.value; // YYYY-MM-DD format
          const qtyValue = qtyField.value;
          
          console.log(`  ‚úÖ Found ${type} entry ${i}: date=${dateValue}, qty=${qtyValue}`);
          
          // Convert date to Julian format for backend
          const julianDate = convertDateToJulian(dateValue);
          
          // For SO, assign to line item 1 (can be enhanced later for multiple line items)
          data.push({
            lineIndex: 1,
            date: julianDate,
            qty: qtyValue
          });
        }
      }
      
      if (data.length === 0) {
        console.log(`  ‚ö†Ô∏è No ${type} data found`);
        return '';
      }
      
      // Group by line index and format as "lineIdx:date*qty^date*qty|lineIdx:date*qty"
      const grouped = {};
      data.forEach(entry => {
        if (!grouped[entry.lineIndex]) {
          grouped[entry.lineIndex] = [];
        }
        grouped[entry.lineIndex].push(`${entry.date}*${entry.qty}`);
      });
      
      // Build final format: "1:date*qty^date*qty|2:date*qty"
      const result = Object.keys(grouped).map(lineIdx => {
        return `${lineIdx}:${grouped[lineIdx].join('^')}`;
      }).join('|');
      
      console.log(`  üì§ ${type} data formatted:`, result);
      return result;
    }

    function saveSODataToTMP(soData) {
      console.log('üì¶ Preparing data for TMP save...');
      console.log('Input soData:', soData);
      
      // Extract line items data into pipe-separated format
      const partNumbers = [];
      const descriptions = [];
      const lineQuantities = [];
      const linePrices = [];
      const lineUoms = [];
      const lineTotals = [];
      const lineNotes = [];
      const prodNotes = [];
      
      if (soData.lineItems && soData.lineItems.length > 0) {
        soData.lineItems.forEach(item => {
          partNumbers.push(item.partNumber || '');
          descriptions.push(item.description || '');
          lineQuantities.push(item.quantity || '0');
          linePrices.push(item.unitPrice || item.price || '0.00');
          lineUoms.push(item.uom || '');
          lineTotals.push(item.total || '0.00');
          lineNotes.push(item.lineNotes || '');
          prodNotes.push(item.prodNotes || '');
        });
      }
      
      console.log('üìä Extracted line items:');
      console.log('  Part Numbers:', partNumbers.join('|'));
      console.log('  Descriptions:', descriptions.join('|'));
      console.log('  Quantities:', lineQuantities.join('|'));
      console.log('  Prices:', linePrices.join('|'));
      console.log('  UOMs:', lineUoms.join('|'));
      console.log('  Totals:', lineTotals.join('|'));
      console.log('  Line Notes:', lineNotes.join('|'));
      
      // Build params matching SAVE_SO_TMP.XML expected format
      const params = new URLSearchParams();
      params.append('temp_id', soData.temp_id || '');
      params.append('save_mode', soData.save_mode || 'TEMP');
      params.append('so_number', soData.header?.soNumber || '');
      params.append('so_status', soData.header?.soStatus || '');
      params.append('customer_code', soData.header?.customerCode || '');
      params.append('shipto_code', soData.header?.shipToCode || '');
      params.append('billto_code', document.getElementById('shipToCodeInput')?.value || soData.header?.customerCode || '');
      params.append('ship_via', soData.header?.shipViaCode || '');
      params.append('terms', soData.header?.terms || '');
      params.append('email', soData.header?.email || '');
      params.append('carrier_account', soData.header?.carrierAccount || '');
      params.append('header_notes', soData.header?.headerNotes || '');
      
      // Add line items as pipe-separated strings
      params.append('part_numbers', partNumbers.join('|'));
      params.append('descriptions', descriptions.join('|'));
      params.append('line_quantities', lineQuantities.join('|'));
      params.append('line_prices', linePrices.join('|'));
      params.append('line_uoms', lineUoms.join('|'));
      params.append('line_totals', lineTotals.join('|'));
      params.append('line_notes', lineNotes.join('|'));
      params.append('prod_notes', prodNotes.join('|'));
      
      // Extract tracking data from lineItems objects (NOT from DOM fields which may be cleared)
      const needDataArray = [];
      const scheduleDataArray = [];
      
      if (soData.lineItems && soData.lineItems.length > 0) {
        soData.lineItems.forEach((item, index) => {
          const lineIdx = index + 1;
          
          // Extract need data (stored as "date~qty\\date~qty" in needData field)
          if (item.needData && item.needData.length > 0) {
            const needEntries = item.needData.split('\\').filter(e => e.trim());
            if (needEntries.length > 0) {
              const formattedNeeds = needEntries.map(entry => {
                const [date, qty] = entry.split('~');
                return `${date}*${qty}`;
              }).join('^');
              needDataArray.push(`${lineIdx}:${formattedNeeds}`);
            }
          }
          
          // Extract schedule data (stored as "date~qty~rs\\date~qty~rs" in schedData field)
          if (item.schedData && item.schedData.length > 0) {
            const schedEntries = item.schedData.split('\\').filter(e => e.trim());
            if (schedEntries.length > 0) {
              const formattedScheds = schedEntries.map(entry => {
                const parts = entry.split('~');
                const date = parts[0];
                const qty = parts[1];
                return `${date}*${qty}`;
              }).join('^');
              scheduleDataArray.push(`${lineIdx}:${formattedScheds}`);
            }
          }
        });
      }
      
      const needData = needDataArray.join('|');
      const scheduleData = scheduleDataArray.join('|');
      
      if (needData) {
        params.append('need_data', needData);
        console.log('üìÖ Need Data (from lineItems):', needData);
      } else {
        console.log('  ‚ö†Ô∏è No need data found in lineItems');
      }
      
      if (scheduleData) {
        params.append('schedule_data', scheduleData);
        console.log('üìÖ Schedule Data (from lineItems):', scheduleData);
      } else {
        console.log('  ‚ö†Ô∏è No schedule data found in lineItems');
      }
      
      console.log('‚úÖ Params to send:', params.toString());
      
      const xhr = new XMLHttpRequest();
      // Add cache-busting to ensure we get the latest compiled version
      const cacheBuster = '?_cb=' + Date.now();
      xhr.open('POST', 'SAVE_SO_TMP.XML' + cacheBuster, true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      
      console.log('üî• Cache-busted URL:', 'SAVE_SO_TMP.XML' + cacheBuster);
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          console.log('üì• SAVE Response received - Status:', xhr.status);
          console.log('üìÑ SAVE Response text:', xhr.responseText);
          
          if (xhr.status === 200) {
            // WORKAROUND: Backend always returns <tmp_list> but save DOES work
            // So we assume success if status is 200
            console.log('‚úÖ SAVE request completed with status 200');
            console.log('üéâ Assuming save was successful (backend works but returns wrong XML)');
            
            // SUCCESS - Show GREEN notification with summary
            const summary = `‚úÖ Draft Saved Successfully!
            
üì¶ Saved Data:
‚Ä¢ Customer: ${soData.header?.customerCode || 'N/A'}
‚Ä¢ Status: ${soData.header?.soStatus || 'N/A'}
‚Ä¢ Ship Via: ${soData.header?.shipViaCode || 'N/A'}
‚Ä¢ Line Items: ${soData.lineItems?.length || 0}

You can reload this draft anytime from "My Drafts".`;
            showNotification(summary, 'success');
            
            // Auto-reload drafts list after successful save
            console.log('üîÑ Auto-reloading drafts list after save...');
            setTimeout(() => {
              loadSavedDrafts();
            }, 500);
            
            // Ask if user wants to reload the draft or create new SO
            setTimeout(() => {
              const userChoice = confirm('‚úÖ Draft saved successfully!\n\nüìã Options:\n‚Ä¢ Click OK to CREATE A NEW SO (form will be cleared)\n‚Ä¢ Click Cancel to STAY on current form\n\nCreate new SO now?');
              
              if (userChoice) {
                console.log('üÜï User chose to create new SO - resetting form...');
                setTimeout(() => {
                  resetFormForNewSO();
                }, 300);
              } else {
                console.log('üìù User chose to stay on current form');
              }
            }, 1500);
          } else if (xhr.status === 0) {
            console.error('‚ùå Status 0: SAVE_SO_TMP.XML not found or not compiled');
            showNotification('‚ùå Backend Error: SAVE_SO_TMP.XML may not be compiled.\n\nPlease contact system administrator.', 'error');
          } else {
            console.error('‚ùå Server error:', xhr.status);
            showNotification('Server error: ' + xhr.status, 'error');
          }
        }
      };
      
      console.log('üöÄ Sending save request to SAVE_SO_TMP.XML...');
      xhr.send(params.toString());
    }

    // Reset form to create new SO
    function resetFormForNewSO() {
      console.log('üîÑ Resetting form for new SO...');
      
      // Clear all input fields
      document.getElementById('soNumberInput').value = '';
      document.getElementById('soDateInput').value = '';
      document.getElementById('soStatusInput').value = '';
      document.getElementById('emailInput').value = '';
      document.getElementById('customerCodeInput').value = '';
      document.getElementById('shipToCodeInput').value = '';
      document.getElementById('shipViaSelect').value = '';
      document.getElementById('carrierAccountInput').value = '';
      document.getElementById('termsInput').value = '';
      document.getElementById('headerNotesInput').value = '';
      
      // Clear display fields
      document.getElementById('customerNumber').textContent = '-';
      document.getElementById('customerName').textContent = '-';
      document.getElementById('customerAddress').textContent = '-';
      document.getElementById('customerCity').textContent = '-';
      document.getElementById('shipToName').textContent = '-';
      document.getElementById('shipToAddress').textContent = '-';
      document.getElementById('shipToCity').textContent = '-';
      document.getElementById('displayCustomerCode').value = '';
      document.getElementById('displayCustomerName').textContent = '-';
      document.getElementById('displayCustomerAddress').textContent = '-';
      
      // Clear line items
      lineItems = [];
      editingLineIndex = -1;
      renderLineItems();
      
      // Clear line item form fields
      if (document.getElementById('linePartNumber')) document.getElementById('linePartNumber').value = '';
      if (document.getElementById('lineDescription')) document.getElementById('lineDescription').value = '';
      if (document.getElementById('lineQuantity')) document.getElementById('lineQuantity').value = '';
      if (document.getElementById('lineUnitPrice')) document.getElementById('lineUnitPrice').value = '';
      if (document.getElementById('lineUOM')) document.getElementById('lineUOM').value = '';
      if (document.getElementById('lineNotes')) document.getElementById('lineNotes').value = '';
      if (document.getElementById('lineProdNotes')) document.getElementById('lineProdNotes').value = '';
      
      // Clear all tracking rows (Need, Schedule, Ack)
      for (let i = 1; i <= 10; i++) {
        const needDate = document.getElementById(`needDate${i}`);
        const needQty = document.getElementById(`needQty${i}`);
        const schedDate = document.getElementById(`lineScheduleDate${i}`);
        const schedQty = document.getElementById(`lineScheduleQty${i}`);
        const ackDate = document.getElementById(`ackDate${i}`);
        const ackQty = document.getElementById(`ackQty${i}`);
        
        if (needDate) needDate.value = '';
        if (needQty) needQty.value = '';
        if (schedDate) schedDate.value = '';
        if (schedQty) schedQty.value = '';
        if (ackDate) ackDate.value = '';
        if (ackQty) ackQty.value = '';
      }
      
      // Clear tracking cache
      localStorage.removeItem('po_tracking_cache');
      lineItemTrackingCache = { needs: {}, acknowledgments: {}, schedules: {} };
      
      // Clear draft ID
      window.currentDraftId = '';
      
      // Reset to Step 1
      currentStep = 1;
      goToStep(1);
      
      // Show success notification
      showNotification('‚úÖ Form cleared! Ready to create a new SO.', 'success');
      
      console.log('‚úÖ Form reset complete');
    }

    function deleteTempRecord(tempId) {
      console.log('üóëÔ∏è Deleting temp record from TMP database:', tempId);
      
      const xhr = new XMLHttpRequest();
      xhr.open('POST', 'DELETE_SO_TMP.XML', true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            console.log('‚úÖ Temp record deleted from TMP database');
            showNotification('‚úÖ Draft Deleted Successfully!', 'success');
            
            // Auto-reload drafts list after successful delete
            console.log('üîÑ Auto-reloading drafts list after delete...');
            setTimeout(() => {
              loadSavedDrafts();
            }, 500);
          } else {
            console.warn('‚ö†Ô∏è Could not delete temp record:', xhr.status);
            showNotification('‚ö†Ô∏è Error deleting draft', 'error');
          }
        }
      };
      
      const params = new URLSearchParams();
      params.append('temp_id', tempId);
      xhr.send(params.toString());
    }

    // Saved Drafts Functions
    function showSavedDrafts() {
      console.log('=== SHOWING SAVED DRAFTS ===');
      
      const modal = document.getElementById('savedDraftsModal');
      if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
        
        // Load drafts from backend
        loadSavedDrafts();
      }
    }

    function closeSavedDraftsModal() {
      const modal = document.getElementById('savedDraftsModal');
      if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = '';
      }
    }

    function loadSavedDrafts() {
      const container = document.getElementById('draftsListContainer');
      const userInitials = getUserInitials();
      
      console.log('üîç Loading drafts for user:', userInitials);
      
      // Check if we have valid user initials
      if (!userInitials) {
        console.error('‚ùå No user initials available to load drafts');
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #ef4444;">
            <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 12px;"></i>
            <p>Error: User session not found. Please log in again.</p>
          </div>
        `;
        return;
      }
      
      // Show loading
      container.innerHTML = `
        <div style="text-align: center; padding: 40px; color: #6b7280;">
          <i class="fas fa-spinner fa-spin" style="font-size: 32px; margin-bottom: 12px;"></i>
          <p>Loading your drafts...</p>
        </div>
      `;
      
      // Fetch drafts from backend
      const url = `GET_SO_TMP.XML?user_initials=${encodeURIComponent(userInitials)}`;
      console.log('üì° Fetching drafts from:', url);
      
      const xhr = new XMLHttpRequest();
      xhr.open('GET', url, true);
      
      // Add timeout
      xhr.timeout = 10000; // 10 seconds
      
      xhr.ontimeout = function() {
        console.error('‚ùå Request timed out');
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #ef4444;">
            <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 12px;"></i>
            <p>Request timed out. Please try again.</p>
            <button onclick="loadSavedDrafts()" style="margin-top: 12px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
              Retry
            </button>
          </div>
        `;
      };
      
      xhr.onerror = function() {
        console.error('‚ùå Network error');
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #ef4444;">
            <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 12px;"></i>
            <p>Network error. Please try again.</p>
            <button onclick="loadSavedDrafts()" style="margin-top: 12px; padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 6px; cursor: pointer;">
              Retry
            </button>
          </div>
        `;
      };
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          console.log('üì• Response received - Status:', xhr.status);
          console.log('üìÑ Response text:', xhr.responseText.substring(0, 500));
          
          if (xhr.status === 200) {
            try {
              const parser = new DOMParser();
              const xmlDoc = parser.parseFromString(xhr.responseText, 'text/xml');
              
              const drafts = xmlDoc.querySelectorAll('temp_so');
              console.log('‚úÖ Found drafts:', drafts.length);
              
              if (drafts.length === 0) {
                console.log('üì≠ No drafts found for user:', userInitials);
                container.innerHTML = `
                  <div style="text-align: center; padding: 60px 20px; color: #6b7280;">
                    <i class="fas fa-inbox" style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;"></i>
                    <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600; color: #374151;">No Saved Drafts</h3>
                    <p style="margin: 0; font-size: 14px;">You don't have any saved drafts yet.</p>
                    <button onclick="closeSavedDraftsModal()" style="margin-top: 20px; padding: 10px 24px; background: #3b82f6; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer;">
                      Create New SO
                    </button>
                  </div>
                `;
                return;
              }
              
              let html = '<div style="display: flex; flex-direction: column; gap: 12px;">';
              
              drafts.forEach(draft => {
                const tempId = draft.querySelector('temp_id')?.textContent || '';
                const customerCode = draft.querySelector('customer_code')?.textContent || 'N/A';
                const saveDate = draft.querySelector('save_date')?.textContent || '';
                const saveTime = draft.querySelector('save_time')?.textContent || '';
                const numItems = draft.querySelector('num_items')?.textContent || '0';
                
                // IMPORTANT: Drafts should NOT show so_number, show DRAFT ID instead
                const displayTitle = tempId || 'Draft';
                
                html += `
                  <div class="draft-item" data-temp-id="${tempId}" style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; transition: all 0.2s; cursor: pointer;" onmouseover="this.style.background='#f3f4f6'; this.style.borderColor='#fbbf24';" onmouseout="this.style.background='#f9fafb'; this.style.borderColor='#e5e7eb';" onclick="loadDraftSO('${tempId}')">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                      <div>
                        <div style="font-size: 14px; font-weight: 600; color: #1f2937; margin-bottom: 4px;">
                          <i class="fas fa-file-alt" style="color: #fbbf24;"></i> ${displayTitle}
                        </div>
                        <div style="font-size: 12px; color: #6b7280;">
                          <i class="fas fa-building"></i> Customer: ${customerCode}
                        </div>
                      </div>
                      <button onclick="event.stopPropagation(); deleteDraft('${tempId}')" style="padding: 6px 10px; background: #ef4444; color: white; border: none; border-radius: 4px; font-size: 11px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='#dc2626';" onmouseout="this.style.background='#ef4444';">
                        <i class="fas fa-trash"></i> Delete
                      </button>
                    </div>
                    <div style="display: flex; gap: 16px; font-size: 11px; color: #6b7280;">
                      <div><i class="fas fa-clock"></i> Saved: ${saveDate} ${saveTime}</div>
                      <div><i class="fas fa-list"></i> ${numItems} items</div>
                    </div>
                  </div>
                `;
              });
              
              html += '</div>';
              container.innerHTML = html;
              
            } catch (error) {
              console.error('Error parsing drafts:', error);
              container.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #ef4444;">
                  <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 12px;"></i>
                  <p>Error loading drafts: ${error.message}</p>
                </div>
              `;
            }
          } else {
            container.innerHTML = `
              <div style="text-align: center; padding: 40px; color: #ef4444;">
                <i class="fas fa-exclamation-triangle" style="font-size: 32px; margin-bottom: 12px;"></i>
                <p>Server error: ${xhr.status}</p>
              </div>
            `;
          }
        }
      };
      
      console.log('üöÄ Sending request to GET_SO_TMP.XML...');
      xhr.send();
      console.log('‚úÖ Request sent, waiting for response...');
    }

    function processDraftData(draftData) {
      console.log('‚úÖ Processing draft data...');
      console.log('üìÑ Draft data element:', draftData);
      console.log('üìÑ Draft data HTML:', draftData.outerHTML?.substring(0, 500));
      
      // Extract data from XML
      const customerCode = draftData.querySelector('customer_code')?.textContent || '';
      const shipToCode = draftData.querySelector('shipto_code')?.textContent || '';
      const billToCode = draftData.querySelector('billto_code')?.textContent || '';
      const shipVia = draftData.querySelector('ship_via')?.textContent || '';
      const terms = draftData.querySelector('terms')?.textContent || '';
      const email = draftData.querySelector('email')?.textContent || '';
      const headerNotes = draftData.querySelector('header_notes')?.textContent || '';
      
      // Parse line items (using √æ separator from backend)
      const partNumbersText = draftData.querySelector('part_numbers')?.textContent || '';
      const descriptionsText = draftData.querySelector('descriptions')?.textContent || '';
      const quantitiesText = draftData.querySelector('line_quantities')?.textContent || '';
      const pricesText = draftData.querySelector('line_prices')?.textContent || '';
      
      console.log('üîç Raw field values:', {
        customerCode,
        shipVia,
        terms,
        email,
        partNumbersText: partNumbersText.substring(0, 50),
        descriptionsText: descriptionsText.substring(0, 50)
      });
      
      // Split by VM (char 253)
      const partNumbers = partNumbersText ? partNumbersText.split(String.fromCharCode(253)) : [];
      const descriptions = descriptionsText ? descriptionsText.split(String.fromCharCode(253)) : [];
      const quantities = quantitiesText ? quantitiesText.split(String.fromCharCode(253)) : [];
      const prices = pricesText ? pricesText.split(String.fromCharCode(253)) : [];
      
      console.log('üì¶ Draft data extracted:', {
        customerCode,
        shipToCode,
        billToCode,
        shipVia,
        terms,
        email,
        lineItemsCount: partNumbers.length,
        partNumbers,
        descriptions,
        quantities,
        prices
      });
      
      // Clear form first
      handleClear();
      
      // Populate Step 1 - Basic Info
      const soDateInput = document.getElementById('soDateInput');
      if (soDateInput) {
        const today = new Date().toISOString().split('T')[0];
        soDateInput.value = today;
      }
      
      // Populate Step 2 - Customer
      if (customerCode) {
        const customerCodeInput = document.getElementById('customerCodeInput');
        console.log('üîç Customer input element:', customerCodeInput);
        if (customerCodeInput) {
          customerCodeInput.value = customerCode;
          customerCodeInput.setAttribute('data-customer-code', customerCode);
          console.log('‚úÖ Set customer code to:', customerCode);
          
          // Simulate ENTER key press to trigger full customer lookup
          const enterEvent = new KeyboardEvent('keydown', {
            key: 'Enter',
            code: 'Enter',
            keyCode: 13,
            which: 13,
            bubbles: true
          });
          customerCodeInput.dispatchEvent(enterEvent);
          console.log('‚úÖ Triggered customer lookup with ENTER key');
        } else {
          console.error('‚ùå customerCodeInput not found!');
        }
      }
      
      // Populate Bill To Code
      if (billToCode) {
        const billToInput = document.getElementById('billToCodeInput');
        console.log('üîç Bill To input element:', billToInput);
        if (billToInput) {
          billToInput.value = billToCode;
          console.log('‚úÖ Set bill to code to:', billToCode);
        } else {
          console.error('‚ùå billToCodeInput not found!');
        }
      }
      
      // Populate Ship Via
      if (shipVia) {
        const shipViaSelect = document.getElementById('shipViaSelect');
        console.log('üîç Ship Via element:', shipViaSelect);
        if (shipViaSelect) {
          shipViaSelect.value = shipVia;
          console.log('‚úÖ Set ship via to:', shipVia);
        } else {
          console.error('‚ùå shipViaSelect not found!');
        }
      }
      
      // Populate Terms
      if (terms) {
        const termsInput = document.getElementById('paymentTermsInput');
        console.log('üîç Terms element:', termsInput);
        if (termsInput) {
          termsInput.value = terms;
          console.log('‚úÖ Set terms to:', terms);
        } else {
          console.error('‚ùå paymentTermsInput not found!');
        }
      }
      
      // Populate Email
      if (email) {
        const emailInput = document.getElementById('emailInput');
        console.log('üîç Email element:', emailInput);
        if (emailInput) {
          emailInput.value = email;
          console.log('‚úÖ Set email to:', email);
        } else {
          console.error('‚ùå emailInput not found!');
        }
      }
      
      // Populate Header Notes
      if (headerNotes) {
        const notesInput = document.getElementById('headerNotesInput');
        console.log('üîç Notes element:', notesInput);
        if (notesInput) {
          notesInput.value = headerNotes;
          console.log('‚úÖ Set notes to:', headerNotes);
        } else {
          console.error('‚ùå headerNotesInput not found!');
        }
      }
      
      // Populate Line Items
      lineItems = [];
      for (let i = 0; i < partNumbers.length; i++) {
        if (partNumbers[i] && partNumbers[i].trim() !== '') {
          const lineItem = {
            lineNumber: i + 1,
            partNumber: partNumbers[i] || '',
            description: descriptions[i] || '',
            quantity: quantities[i] || '',
            unitPrice: prices[i] || '',
            unitOfMeasure: 'EA',
            lineNotes: '',
            prodNotes: '',
            needInfo: [],
            acknowledgments: [],
            schedules: []
          };
          lineItems.push(lineItem);
          console.log(`‚úÖ Loaded line item ${i + 1}:`, lineItem);
        }
      }
      
      // Render line items in the table
      renderLineItems();
      
      console.log('üìä Final state before navigation:');
      console.log('  - Customer code input value:', document.getElementById('customerCodeInput')?.value);
      console.log('  - Ship via select value:', document.getElementById('shipViaSelect')?.value);
      console.log('  - Line items count:', lineItems.length);
      
      // Go to Step 1
      goToStep(1);
      
      showNotification('‚úÖ Draft loaded successfully! (' + lineItems.length + ' line items)', 'success');
    }

    function loadDraftFromTMPDirect(tempId) {
      console.warn('‚ö†Ô∏è GET_SO_TMP.XML detail mode not working, using SAVE_SO_TMP.XML in READ mode...');
      
      // Use SAVE_SO_TMP.XML in READ mode as workaround
      const xhr = new XMLHttpRequest();
      xhr.open('POST', 'SAVE_SO_TMP.XML', true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            try {
              const parser = new DOMParser();
              const xmlDoc = parser.parseFromString(xhr.responseText, 'text/xml');
              
              console.log('üìÑ TMP Record Response:', xhr.responseText.substring(0, 500));
              
              // Check if we got data
              const tmpRecord = xmlDoc.querySelector('tmp_record');
              if (tmpRecord) {
                // Process as normal tmp_record
                processDraftData(tmpRecord);
              } else {
                console.error('‚ùå Could not read TMP record');
                showNotification('‚ùå Draft loading not available. Server update required.', 'error');
              }
            } catch (error) {
              console.error('‚ùå Error:', error);
              showNotification('‚ùå Error loading draft', 'error');
            }
          } else {
            console.error('‚ùå Failed to read TMP');
            showNotification('‚ùå Draft loading requires server update', 'error');
          }
        }
      };
      
      // Send temp_id and mode=read
      xhr.send('temp_id=' + encodeURIComponent(tempId) + '&mode=read');
    }

    function loadDraftSO(tempId) {
      console.log('=== LOADING DRAFT SO:', tempId, '===');
      
      // Store draft ID so saveSO() knows to generate new SO number
      window.currentDraftId = tempId;
      console.log('‚úÖ Set window.currentDraftId:', tempId);
      
      closeSavedDraftsModal();
      
      // Show loading notification
      showNotification('Loading draft...', 'loading');
      
      // Use dedicated endpoint to load full draft (same format as GET_SO.XML)
      const xhr = new XMLHttpRequest();
      console.log('üì° Loading draft from GET_SO_TMP_DETAIL.XML:', tempId);
      const url = 'GET_SO_TMP_DETAIL.XML?temp_id=' + encodeURIComponent(tempId);
      xhr.open('GET', url, true);
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            console.log('‚úÖ Draft data received');
            
            try {
              const parser = new DOMParser();
              const xmlDoc = parser.parseFromString(xhr.responseText, 'text/xml');
              
              console.log('üìÑ XML Response:', xhr.responseText.substring(0, 500));
              
              // Check for error
              const errorNode = xmlDoc.querySelector('error');
              if (errorNode) {
                console.error('‚ùå Draft not found:', tempId);
                showNotification('‚ùå Draft not found', 'error');
                return;
              }
              
              // Get so_data (same format as GET_SO.XML)
              const soData = xmlDoc.querySelector('so_data');
              if (!soData) {
                console.error('‚ùå so_data not found in XML');
                console.error('XML structure:', xhr.responseText);
                showNotification('‚ùå Invalid draft data format', 'error');
                return;
              }
              
              console.log('‚úÖ Draft loaded successfully, processing...');
              console.log('üì¶ so_data element:', soData);
              console.log('üì¶ Customer code:', soData.querySelector('customer_code')?.textContent);
              console.log('üì¶ Customer name:', soData.querySelector('customer_name')?.textContent);
              
              // Parse XML into JavaScript object for loadSOData
              const draftDataObj = {
                customer_code: soData.querySelector('customer_code')?.textContent || '',
                customer_name: soData.querySelector('customer_name')?.textContent || '',
                shipto_code: soData.querySelector('shipto_code')?.textContent || '',
                billto_code: soData.querySelector('billto_code')?.textContent || '',
                ship_via: soData.querySelector('ship_via')?.textContent || '',
                terms: soData.querySelector('terms')?.textContent || '',
                email: soData.querySelector('email')?.textContent || '',
                carrier_account: soData.querySelector('carrier_account')?.textContent || '',
                header_notes: soData.querySelector('header_notes')?.textContent || '',
                so_status: soData.querySelector('so_status')?.textContent || '',
                customer_info: {
                  name: soData.querySelector('customer_info name')?.textContent || '',
                  address1: soData.querySelector('customer_info address1')?.textContent || '',
                  address2: soData.querySelector('customer_info address2')?.textContent || '',
                  city: soData.querySelector('customer_info city')?.textContent || '',
                  state: soData.querySelector('customer_info state')?.textContent || '',
                  zip: soData.querySelector('customer_info zip')?.textContent || ''
                },
                shipto_info: {
                  number: soData.querySelector('shipto_code')?.textContent || '',
                  name: soData.querySelector('shipto_info name')?.textContent || '',
                  address1: soData.querySelector('shipto_info address1')?.textContent || '',
                  address2: soData.querySelector('shipto_info address2')?.textContent || '',
                  city: soData.querySelector('shipto_info city')?.textContent || '',
                  state: soData.querySelector('shipto_info state')?.textContent || '',
                  zip: soData.querySelector('shipto_info zip')?.textContent || ''
                },
                line_items: []
              };
              
              // Parse line items
              const lineItemNodes = soData.querySelectorAll('line_item');
              lineItemNodes.forEach(item => {
                // Parse need entries
                const needEntriesNode = item.querySelector('need_entries');
                const needEntries = needEntriesNode ? {
                  need_entry: Array.from(needEntriesNode.querySelectorAll('need_entry')).map(entry => ({
                    need_date: entry.querySelector('need_date')?.textContent || '',
                    need_qty: entry.querySelector('need_qty')?.textContent || ''
                  }))
                } : null;
                
                // Parse schedule entries
                const scheduleEntriesNode = item.querySelector('schedule_entries');
                const scheduleEntries = scheduleEntriesNode ? {
                  schedule_entry: Array.from(scheduleEntriesNode.querySelectorAll('schedule_entry')).map(entry => ({
                    schedule_date: entry.querySelector('schedule_date')?.textContent || '',
                    schedule_qty: entry.querySelector('schedule_qty')?.textContent || ''
                  }))
                } : null;
                
                draftDataObj.line_items.push({
                  line_number: item.querySelector('line_number')?.textContent || '',
                  part_number: item.querySelector('part_number')?.textContent || '',
                  description: item.querySelector('description')?.textContent || '',
                  quantity: item.querySelector('quantity')?.textContent || '',
                  unit_price: item.querySelector('unit_price')?.textContent || '',
                  uom: item.querySelector('uom')?.textContent || 'EA',
                  line_notes: item.querySelector('line_notes')?.textContent || '',
                  prod_notes: item.querySelector('prod_notes')?.textContent || '',
                  total: item.querySelector('total')?.textContent || '',
                  need_entries: needEntries,
                  schedule_entries: scheduleEntries
                });
              });
              
              console.log('üì¶ Parsed draft object:', draftDataObj);
              
              // Use existing loadSOData function (same as loading existing SO)
              if (typeof loadSOData === 'function') {
                console.log('‚úÖ Calling loadSOData()...');
                loadSOData(draftDataObj);
              } else {
                console.error('‚ùå loadSOData function not found!');
                showNotification('‚ùå Error: loadSOData function not available', 'error');
              }
              
              // Populate editable form fields
              console.log('‚úÖ Populating editable form fields...');
              
              // Populate Ship To input (Step 2)
              const shipToInput = document.getElementById('customerCodeInput');
              console.log('üîç Looking for customerCodeInput element:', shipToInput);
              if (shipToInput && draftDataObj.customer_code) {
                console.log('üìù Setting Ship To input value to:', draftDataObj.customer_code);
                shipToInput.value = draftDataObj.customer_code;
                console.log('‚úÖ Ship To input value set. Current value:', shipToInput.value);
                
                // Fill Customer Details directly from draft (don't call selectCustomer to avoid overwriting Bill To)
                console.log('üîç Filling Customer Details from draft data...');
                
                // Fill Customer Details box
                const customerDetailsSection = document.getElementById('customerInfoSection');
                if (customerDetailsSection) {
                  customerDetailsSection.style.display = 'block';
                  
                  // Customer Number
                  const customerNumberEl = document.getElementById('customerNumber');
                  if (customerNumberEl) {
                    customerNumberEl.textContent = draftDataObj.customer_code || '-';
                    console.log('‚úÖ Set Customer Number:', draftDataObj.customer_code);
                  }
                  
                  // Customer Name
                  const customerNameEl = document.getElementById('customerName');
                  if (customerNameEl) {
                    customerNameEl.textContent = draftDataObj.customer_info?.name || draftDataObj.customer_name || '-';
                    console.log('‚úÖ Set Customer Name:', draftDataObj.customer_info?.name);
                  }
                  
                  // Customer Address
                  const customerAddressEl = document.getElementById('customerAddress');
                  if (customerAddressEl) {
                    customerAddressEl.textContent = draftDataObj.customer_info?.address1 || '-';
                    console.log('‚úÖ Set Customer Address:', draftDataObj.customer_info?.address1);
                  }
                  
                  // Customer City
                  const customerCityEl = document.getElementById('customerCity');
                  if (customerCityEl) {
                    const cityText = draftDataObj.customer_info?.address2 || '-';
                    customerCityEl.textContent = cityText;
                    console.log('‚úÖ Set Customer City:', cityText);
                  }
                  
                  console.log('‚úÖ Customer Details filled from draft');
                } else {
                  console.error('‚ùå customerInfoSection not found!');
                }
              } else {
                if (!shipToInput) {
                  console.error('‚ùå customerCodeInput element not found!');
                } else {
                  console.error('‚ùå No customer_code in draft data:', draftDataObj.customer_code);
                }
              }
              
              // Populate Bill To Code input (Step 2)
              // Backend (GET_SO_TMP_DETAIL.XML) now reads real Bill To Code from CUSTOMER.RECORD<8>
              const billToInput = document.getElementById('shipToCodeInput');
              console.log('üîç Looking for shipToCodeInput element:', billToInput);
              console.log('üì¶ Bill To Code from draft (from CUSTOMER.RECORD<8>):', draftDataObj.billto_code);
              if (billToInput && draftDataObj.billto_code) {
                billToInput.value = draftDataObj.billto_code;
                console.log('‚úÖ Set Bill To Code input:', draftDataObj.billto_code);
                
                // Fill Bill To Details directly from draft (use same data as Customer since it's the same entity)
                console.log('üîç Filling Bill To Details from draft data...');
                const billToSection = document.getElementById('shipToInfoSection');
                if (billToSection) {
                  billToSection.style.display = 'block';
                  
                  // Bill To Number - use the billto_code from draft (already corrected by backend)
                  const billToNumberEl = document.getElementById('shiptoNumber') || document.getElementById('shipToNumber');
                  if (billToNumberEl) {
                    billToNumberEl.textContent = draftDataObj.billto_code || '-';
                    console.log('‚úÖ Set Bill To Number:', draftDataObj.billto_code);
                  }
                  
                  // Bill To Name - use customer name (same entity)
                  const billToNameEl = document.getElementById('shipToName') || document.getElementById('shiptoName');
                  if (billToNameEl) {
                    billToNameEl.textContent = draftDataObj.customer_info?.name || draftDataObj.customer_name || '-';
                    console.log('‚úÖ Set Bill To Name:', draftDataObj.customer_info?.name);
                  }
                  
                  // Bill To Address - use customer address
                  const billToAddressEl = document.getElementById('shipToAddress') || document.getElementById('shiptoAddress1');
                  if (billToAddressEl) {
                    billToAddressEl.textContent = draftDataObj.customer_info?.address1 || '-';
                    console.log('‚úÖ Set Bill To Address:', draftDataObj.customer_info?.address1);
                  }
                  
                  // Bill To City - use customer city
                  const billToCityEl = document.getElementById('shipToCity') || document.getElementById('shiptoCity');
                  if (billToCityEl) {
                    const cityText = draftDataObj.customer_info?.address2 || '-';
                    billToCityEl.textContent = cityText;
                    console.log('‚úÖ Set Bill To City:', cityText);
                  }
                  
                  console.log('‚úÖ Bill To Details filled from draft');
                } else {
                  console.error('‚ùå shipToInfoSection not found!');
                }
              } else {
                if (!billToInput) {
                  console.error('‚ùå shipToCodeInput element not found!');
                }
                if (!draftDataObj.billto_code) {
                  console.log('‚ö†Ô∏è No billto_code in draft data');
                }
              }
              
              // Populate Status (Step 1)
              const statusSelect = document.getElementById('soStatusInput');
              console.log('üîç Setting Status to:', draftDataObj.so_status);
              if (statusSelect && draftDataObj.so_status) {
                statusSelect.value = draftDataObj.so_status;
                console.log('‚úÖ Set Status dropdown:', draftDataObj.so_status);
              } else {
                console.log('‚ö†Ô∏è No Status in draft data');
              }
              
              // Populate Email Addresses (Step 1)
              const emailInput = document.getElementById('emailInput');
              console.log('üîç Setting Email to:', draftDataObj.email);
              if (emailInput && draftDataObj.email) {
                emailInput.value = draftDataObj.email;
                console.log('‚úÖ Set Email:', draftDataObj.email);
              } else {
                console.log('‚ö†Ô∏è No Email in draft data');
              }
              
              // Populate Ship Via (Step 3)
              const shipViaSelect = document.getElementById('shipViaSelect');
              console.log('üîç Setting Ship Via to:', draftDataObj.ship_via);
              if (shipViaSelect && draftDataObj.ship_via) {
                shipViaSelect.value = draftDataObj.ship_via;
                console.log('‚úÖ Set Ship Via dropdown:', draftDataObj.ship_via);
              } else {
                console.log('‚ö†Ô∏è No Ship Via in draft data');
              }
              
              // Populate Payment Terms (Step 3)
              const termsInput = document.getElementById('termsInput');
              console.log('üîç Setting Payment Terms to:', draftDataObj.terms);
              if (termsInput && draftDataObj.terms) {
                termsInput.value = draftDataObj.terms;
                console.log('‚úÖ Set Payment Terms:', draftDataObj.terms);
              } else {
                console.log('‚ö†Ô∏è No Payment Terms in draft data');
              }
              
              // Populate Carrier Account (Step 3)
              const carrierInput = document.getElementById('carrierAccountInput');
              console.log('üîç Setting Carrier Account to:', draftDataObj.carrier_account);
              if (carrierInput && draftDataObj.carrier_account) {
                carrierInput.value = draftDataObj.carrier_account;
                console.log('‚úÖ Set Carrier Account:', draftDataObj.carrier_account);
              } else {
                console.log('‚ö†Ô∏è No Carrier Account in draft data');
              }
              
              // Populate Notes (Step 3)
              const notesInput = document.getElementById('notesInput');
              console.log('üîç Setting Notes to:', draftDataObj.header_notes);
              if (notesInput && draftDataObj.header_notes) {
                notesInput.value = draftDataObj.header_notes;
                console.log('‚úÖ Set Notes:', draftDataObj.header_notes);
              } else {
                console.log('‚ö†Ô∏è No Notes in draft data');
              }
              
              // Populate Line Items (Step 4)
              lineItems = [];
              if (draftDataObj.line_items && draftDataObj.line_items.length > 0) {
                draftDataObj.line_items.forEach((item, index) => {
                  console.log(`üîç DEBUG: Processing line item ${index}:`, item);
                  console.log(`üîç DEBUG: item.need_entries:`, item.need_entries);
                  console.log(`üîç DEBUG: item.schedule_entries:`, item.schedule_entries);
                  
                  // Parse need entries
                  const needData = [];
                  if (item.need_entries && item.need_entries.need_entry) {
                    const needEntries = Array.isArray(item.need_entries.need_entry) ? 
                      item.need_entries.need_entry : [item.need_entries.need_entry];
                    console.log(`‚úÖ Found ${needEntries.length} need entries:`, needEntries);
                    needEntries.forEach(entry => {
                      if (entry.need_date && entry.need_qty) {
                        needData.push(`${entry.need_date}~${entry.need_qty}`);
                        console.log(`‚úÖ Added need entry: ${entry.need_date}~${entry.need_qty}`);
                      }
                    });
                  } else {
                    console.log(`‚ö†Ô∏è No need_entries found for line item ${index}`);
                  }
                  
                  // Parse schedule entries
                  const schedData = [];
                  if (item.schedule_entries && item.schedule_entries.schedule_entry) {
                    const schedEntries = Array.isArray(item.schedule_entries.schedule_entry) ? 
                      item.schedule_entries.schedule_entry : [item.schedule_entries.schedule_entry];
                    console.log(`‚úÖ Found ${schedEntries.length} schedule entries:`, schedEntries);
                    schedEntries.forEach(entry => {
                      if (entry.schedule_date && entry.schedule_qty) {
                        schedData.push(`${entry.schedule_date}~${entry.schedule_qty}~`);
                        console.log(`‚úÖ Added schedule entry: ${entry.schedule_date}~${entry.schedule_qty}`);
                      }
                    });
                  } else {
                    console.log(`‚ö†Ô∏è No schedule_entries found for line item ${index}`);
                  }
                  
                  lineItems.push({
                    lineNumber: index + 1,
                    partNumber: item.part_number || '',
                    description: item.description || '',
                    quantity: parseFloat(item.quantity) || 0,
                    unitPrice: parseFloat(item.unit_price) || 0,
                    uom: item.unit_of_measure || '',
                    total: parseFloat(item.total) || 0,
                    lineNotes: item.line_notes || '',
                    prodNotes: item.prod_notes || '',
                    needData: needData.join('\\'),
                    ackData: '',
                    schedData: schedData.join('\\'),
                    needInfo: [],
                    ackInfo: [],
                    schedules: []
                  });
                });
                console.log('‚úÖ Loaded', lineItems.length, 'line items from draft');
                console.log('üìä Line items data:', lineItems);
                renderLineItems();
              }
              
              // Navigate to Step 1
              goToStep(1);
              
              showNotification('‚úÖ Draft loaded successfully!', 'success');
              
            } catch (error) {
              console.error('‚ùå Error parsing draft data:', error);
              showNotification('‚ùå Error loading draft', 'error');
            }
          } else {
            console.error('‚ùå Failed to load draft, status:', xhr.status);
            showNotification('‚ùå Failed to load draft', 'error');
          }
        }
      };
      
      xhr.send();
    }

    function deleteDraft(tempId) {
      if (!confirm('Are you sure you want to delete this draft?\n\nThis action cannot be undone.')) {
        return;
      }
      
      console.log('=== DELETING DRAFT:', tempId, '===');
      
      // Validate temp_id
      if (!tempId || tempId.trim() === '') {
        console.error('‚ùå Invalid temp_id:', tempId);
        showNotification('‚ùå Error: Invalid draft ID', 'error');
        return;
      }
      
      showNotification('Deleting draft...', 'loading');
      
      const xhr = new XMLHttpRequest();
      // Add cache-busting to ensure we get the latest compiled version
      const cacheBuster = '?_cb=' + Date.now();
      xhr.open('POST', 'DELETE_SO_TMP.XML' + cacheBuster, true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      
      console.log('üî• Cache-busted DELETE URL:', 'DELETE_SO_TMP.XML' + cacheBuster);
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          console.log('üì• DELETE Response - Status:', xhr.status);
          console.log('üìÑ DELETE Response text:', xhr.responseText);
          
          if (xhr.status === 200) {
            // WORKAROUND: Backend always returns <tmp_list> but delete DOES work
            // So we assume success if status is 200
            console.log('‚úÖ DELETE request completed with status 200');
            console.log('üéâ Assuming delete was successful (backend works but returns wrong XML)');
            
            // Show success notification
            showNotification('‚úÖ Draft deleted successfully!', 'success');
            
            // Find and remove the deleted draft item by data-temp-id
            const draftElement = document.querySelector(`.draft-item[data-temp-id="${tempId}"]`);
            
            if (draftElement) {
              console.log('‚úÖ Found draft element in DOM, animating removal...');
              
              // Animate fade out
              draftElement.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
              draftElement.style.opacity = '0';
              draftElement.style.transform = 'translateX(20px)';
              
              // Remove from DOM after animation
              setTimeout(() => {
                draftElement.remove();
                
                // Check if there are any drafts left
                const container = document.getElementById('draftsListContainer');
                const remainingDrafts = document.querySelectorAll('.draft-item');
                
                console.log('üìä Remaining drafts:', remainingDrafts.length);
                
                if (remainingDrafts.length === 0) {
                  console.log('üì≠ No more drafts - closing modal after showing message');
                  
                  // Show "no drafts" message briefly then close modal
                  container.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; color: #6b7280;">
                      <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 16px; color: #10b981;"></i>
                      <h3 style="margin: 0 0 8px 0; font-size: 18px; font-weight: 600; color: #374151;">Draft Deleted!</h3>
                      <p style="margin: 0; font-size: 14px;">No more saved drafts.</p>
                    </div>
                  `;
                  
                  // Close modal after 1.5 seconds
                  setTimeout(() => {
                    closeSavedDraftsModal();
                  }, 1500);
                }
              }, 300);
            } else {
              console.warn('‚ö†Ô∏è Draft element not found in DOM, reloading list...');
              // Reload the entire list if element wasn't found
              setTimeout(() => {
                loadSavedDrafts();
              }, 300);
            }
          } else if (xhr.status === 500) {
            console.error('‚ùå Server error 500 - DELETE_SO_TMP.XML may not be compiled');
            showNotification('‚ùå Server Error: DELETE_SO_TMP.XML may not be compiled.\n\nPlease contact system administrator.', 'error');
          } else {
            console.error('‚ùå HTTP Error:', xhr.status);
            showNotification('‚ùå Error deleting draft (Status: ' + xhr.status + ')', 'error');
          }
        }
      };
      
      const params = new URLSearchParams();
      params.append('temp_id', tempId);
      
      console.log('üóëÔ∏è Sending delete request for:', tempId);
      xhr.send(params.toString());
    }

    function searchSO() {
      const soNumber = document.getElementById('soSearchInput').value.trim();
      
      if (!soNumber) {
        // Show enhanced search results interface
        showEnhancedSearchResults();
        return;
      }
      
      console.log('Searching for SO:', soNumber);
      
      // Make AJAX request to get SO data
      const xhr = new XMLHttpRequest();
      xhr.open('GET', `GET_SO.XML?SO_NUMBER=${encodeURIComponent(soNumber)}`, true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            try {
              const parser = new DOMParser();
              const xmlDoc = parser.parseFromString(xhr.responseText, 'text/xml');
              
              // Check for parsing errors
              const parseError = xmlDoc.querySelector('parsererror');
              if (parseError) {
                alert('Error parsing SO data: ' + parseError.textContent);
                return;
              }
              
              console.log('=== DEBUG: Checking for so elements ===');
              const soElements = xmlDoc.getElementsByTagName('so');
              console.log('Found so elements:', soElements.length);
              console.log('soElements:', soElements);
              
              if (soElements.length > 0) {
                const soElement = soElements[0];
                
                // Extract SO data
                console.log('=== DEBUG: Raw XML Response ===');
                console.log(xhr.responseText);
                console.log('=== DEBUG: Parsed XML Document ===');
                console.log(xmlDoc);
                console.log('=== DEBUG: SO Element ===');
                console.log(soElement);
                console.log('=== DEBUG: Looking for line_items section ===');
                const lineItemsCheck = soElement.querySelector('line_items');
                console.log('Found line_items section:', lineItemsCheck);
                if (lineItemsCheck) {
                  const lineItemsElements = Array.from(lineItemsCheck.querySelectorAll('line_item'));
                  console.log('Found line_item elements:', lineItemsElements.length);
                  lineItemsElements.forEach((item, i) => {
                    console.log(`Line item ${i}:`, item);
                  });
                }
                
                const soData = extractSOData(soElement);
                console.log('Extracted SO data:', soData);
                
                // PERSISTENT CACHE: Load cached data for this SO
                loadCacheFromStorage();
                
                // Fix missing so_number from server response
                if (!soData.so_number && soNumber) {
                  soData.so_number = soNumber;
                  console.log('Fixed missing so_number using search value:', soNumber);
                }
                
                // Hide NEW SO Banner when loading existing SO
                const banner = document.getElementById('newSOBanner');
                if (banner) {
                  banner.style.display = 'none';
                }
                
                // Show SO data in form
                fillFormWithSOData(soData);
                
                // üîß Ensure ack field listeners are setup after initial SO load
                if (typeof window.setupAckFieldListeners === 'function') {
                  setTimeout(() => window.setupAckFieldListeners(), 100);
                }
                
                // Load SO data to show info sections (customer, ship to, salesperson)
                loadSOData(soData);
                
                // Validate Step 2 to enable Continue button
                if (typeof validateStep2 === 'function') {
                  setTimeout(() => {
                    validateStep2();
                    console.log('‚úÖ Step 2 validated after SO load (searchSO)');
                  }, 500);
                }
                
              } else {
                alert('SO not found or invalid response format');
              }
            } catch (error) {
              console.error('Error processing SO data:', error);
              alert('Error processing SO data: ' + error.message);
            }
          } else {
            alert('Error loading SO data: ' + xhr.status + ' - ' + xhr.statusText);
          }
        }
      };
      
      xhr.ontimeout = function() {
        alert('Request timed out. Please try again.');
      };
      
      xhr.onerror = function() {
        alert('Network error occurred. Please check your connection.');
      };
      
      xhr.send();
    }

    // Function to reload SO data after save without showing alerts
    function reloadSOData(soNumber) {
      if (!soNumber) {
        console.error('‚ùå reloadSOData: No SO number provided');
        return;
      }
      
      // Make AJAX request to get SO data with cache busting
      const xhr = new XMLHttpRequest();
      const cacheBuster = '_reload_' + Date.now();
      xhr.open('GET', `GET_SO.XML?SO_NUMBER=${encodeURIComponent(soNumber)}&${cacheBuster}`, true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            try {
              // Check if response is empty or invalid
              if (!xhr.responseText || xhr.responseText.trim() === '') {
                console.error('‚ùå Empty response from server on reload');
                console.warn('‚ö†Ô∏è Skipping reload to prevent blank page');
                return;
              }
              
              const parser = new DOMParser();
              const xmlDoc = parser.parseFromString(xhr.responseText, 'text/xml');
              
              // Check for parsing errors
              const parseError = xmlDoc.querySelector('parsererror');
              if (parseError) {
                console.error('‚ùå Error parsing SO data on reload:', parseError.textContent);
                console.warn('‚ö†Ô∏è Skipping reload to prevent blank page');
                return;
              }
              
              const soElements = xmlDoc.getElementsByTagName('so');
              
              if (soElements.length > 0) {
                const soElement = soElements[0];
                
                // Extract SO data (same as searchSO but without alerts)
                const soData = extractSOData(soElement);
                
                // Fix missing so_number from server response
                if (!soData.so_number && soNumber) {
                  soData.so_number = soNumber;
                }
                
                // üîß Ensure ack field listeners are setup after SO reload
                if (typeof window.setupAckFieldListeners === 'function') {
                  setTimeout(() => window.setupAckFieldListeners(), 100);
                }
                
                // Show SO data in form
                try {
                  fillFormWithSOData(soData);
                } catch (error) {
                  console.error('‚ùå Error in fillFormWithSOData:', error);
                }
                
                // Load SO data to show info sections (customer, ship to, salesperson)
                try {
                  loadSOData(soData);
                  
                  // Validate Step 2 to enable Continue button
                  if (typeof validateStep2 === 'function') {
                    setTimeout(() => {
                      validateStep2();
                      console.log('‚úÖ Step 2 validated after SO load (alt path)');
                    }, 500);
                  }
                } catch (error) {
                  console.error('‚ùå Error in loadSOData:', error);
                }
                
                // CRITICAL: Force renderLineItems() after reload to ensure UI shows data
                setTimeout(() => {
                  try {
                    renderLineItems();
                    
                    // Force switch to Line Items tab to show the reloaded data
                    switchTab(2); // Line Items tab
                  } catch (error) {
                    console.error('‚ùå Error in post-reload UI update:', error);
                  }
                }, 200); // Small delay to ensure DOM is ready
              } else {
                console.error('‚ùå No SO found with number:', soNumber);
              }
            } catch (error) {
              console.error('‚ùå Error processing SO data on reload:', error);
            }
          } else {
            console.error('‚ùå Network error during SO reload. Status:', xhr.status);
          }
        }
      };
      
      xhr.onerror = function() {
        console.error('‚ùå Network error occurred during SO reload');
      };
      
      xhr.send();
    }

    function showEnhancedSearchResults() {
      // Create overlay for search results
      const overlay = document.createElement('div');
      overlay.id = 'searchResultsOverlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.6);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      `;
      
      overlay.innerHTML = `
        <div style="background: white; border-radius: 16px; box-shadow: 0 20px 40px rgba(0,0,0,0.15); width: 100%; max-width: 1000px; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
          <div style="padding: 20px 24px; background: linear-gradient(135deg, #1e293b 0%, #1e3a8a 100%); color: white; display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 18px; font-weight: 600;">Search Sales Orders</h3>
            <button onclick="closeSearchResults()" style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; padding: 4px;">
              <i class="fas fa-times"></i>
            </button>
          </div>
          
          <div style="padding: 20px 24px; border-bottom: 1px solid #e2e8f0;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; align-items: end;">
              <div>
                <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">SO Number:</label>
                <input type="text" id="enhancedSearchPONumber" placeholder="Enter SO Number" style="width: 100%; border: 1px solid #cbd5e1; border-radius: 4px; padding: 8px; font-size: 12px;">
              </div>
              <div>
                <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Ship To Code:</label>
                <input type="text" id="enhancedSearchCustomerCode" placeholder="Ship To Code" style="width: 100%; border: 1px solid #cbd5e1; border-radius: 4px; padding: 8px; font-size: 12px;">
              </div>
              <div>
                <label style="display: block; font-size: 12px; font-weight: 500; color: #374151; margin-bottom: 4px;">Status:</label>
                <select id="enhancedSearchStatus" style="width: 100%; border: 1px solid #cbd5e1; border-radius: 4px; padding: 8px; font-size: 12px;">
                  <option value="">All Status</option>
                  <option value="OPEN">Open</option>
                  <option value="PENDING">Pending</option>
                  <option value="APPROVED">Approved</option>
                  <option value="SENT">Sent</option>
                  <option value="RECEIVED">Received</option>
                  <option value="CLOSED">Closed</option>
                  <option value="CANCELLED">Cancelled</option>
                </select>
              </div>
              <div style="display: flex; gap: 8px;">
                <button onclick="performEnhancedSearch()" class="btn btn-primary" style="padding: 8px 16px; font-size: 12px;">
                  <i class="fas fa-search"></i> Search
                </button>
                <button onclick="clearEnhancedSearch()" class="btn btn-secondary" style="padding: 8px 16px; font-size: 12px;">
                  <i class="fas fa-times"></i> Clear
                </button>
              </div>
            </div>
          </div>
          
          <div id="enhancedSearchResultsBody" style="flex: 1; overflow-y: auto; padding: 20px; background: #f8fafc;">
            <div style="text-align: center; color: #6b7280; padding: 40px;">
              Enter search criteria and click Search to find sales orders
            </div>
          </div>
        </div>
      `;
      
      document.body.appendChild(overlay);
      
      // Add click outside to close
      overlay.addEventListener('click', function(e) {
        if (e.target === overlay) {
          closeSearchResults();
        }
      });
    }

    function performEnhancedSearch() {
      const soNumber = document.getElementById('enhancedSearchPONumber').value.trim();
      const customerCode = document.getElementById('enhancedSearchCustomerCode').value.trim();
      const status = document.getElementById('enhancedSearchStatus').value;
      
      const resultsBody = document.getElementById('enhancedSearchResultsBody');
      
      // Show loading
      resultsBody.innerHTML = '<div style="padding: 40px; text-align: center; color: #6b7280;"><i class="fas fa-spinner fa-spin"></i> Searching sales orders...</div>';
      
      // Build search URL
      let searchUrl = 'SEARCH_PO.XML?';
      const params = [];
      
      if (soNumber) params.push(`SO_NUMBER=${encodeURIComponent(soNumber)}`);
      if (customerCode) params.push(`VENDOR_CODE=${encodeURIComponent(customerCode)}`);
      if (status) params.push(`STATUS=${encodeURIComponent(status)}`);
      
      searchUrl += params.join('&');
      
      // Make search request
      fetch(searchUrl)
        .then(response => response.text())
        .then(xmlText => {
          try {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            
            const parseError = xmlDoc.querySelector('parsererror');
            if (parseError) {
              throw new Error('XML parsing error: ' + parseError.textContent);
            }
            
            displayEnhancedSearchResults(xmlDoc);
          } catch (error) {
            console.error('Search error:', error);
            resultsBody.innerHTML = `<div style="padding: 40px; text-align: center; color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> Error: ${error.message}</div>`;
          }
        })
        .catch(error => {
          console.error('Search request failed:', error);
          resultsBody.innerHTML = '<div style="padding: 40px; text-align: center; color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> Search request failed. Please try again.</div>';
        });
    }

    function displayEnhancedSearchResults(xmlDoc) {
      const resultsBody = document.getElementById('enhancedSearchResultsBody');
      const soResults = xmlDoc.querySelectorAll('so_result');
      
      if (soResults.length === 0) {
        resultsBody.innerHTML = '<div style="padding: 40px; text-align: center; color: #6b7280;">No sales orders found matching your search criteria.</div>';
        return;
      }
      
      let resultsHtml = '<div style="display: grid; gap: 16px;">';
      
      soResults.forEach(po => {
        const soNumber = getXmlValue(po, 'so_number');
        const customerCode = getXmlValue(po, 'customer_code');
        const customerName = getXmlValue(po, 'customer_name');
        const description = getXmlValue(po, 'description');
        const status = getXmlValue(po, 'status');
        const total = getXmlValue(po, 'total');
        const poDate = getXmlValue(po, 'po_date');
        
        const formattedTotal = total ? `$${parseFloat(total).toFixed(2)}` : '$0.00';
        const formattedDate = poDate ? formatDate(poDate) : '-';
        const statusClass = getStatusClass(status);
        
        resultsHtml += `
          <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid #f1f5f9; overflow: hidden;">
            <div style="padding: 16px 20px; background: linear-gradient(135deg, #1e293b 0%, #1e3a8a 100%); color: white; display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <h4 style="margin: 0; font-size: 16px; font-weight: 600;">SO #${soNumber}</h4>
                <span class="status-badge ${statusClass}" style="background: rgba(255,255,255,0.2); color: white;">${status}</span>
              </div>
              <div>
                <button onclick="loadSOForEditing('${soNumber}'); closeSearchResults();" class="btn" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: 500;">
                  <i class="fas fa-edit"></i> Load & Edit
                </button>
              </div>
            </div>
            
            <div style="padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <div>
                <div style="margin-bottom: 16px;">
                  <div style="color: #6b7280; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Sales Order Date</div>
                  <div style="font-weight: 600; color: #1f2937;">${formattedDate}</div>
                </div>
                
                <div style="margin-bottom: 16px; padding: 12px; background: #f0fdf4; border-radius: 6px; border: 1px solid #bbf7d0;">
                  <div style="color: #166534; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Client Information</div>
                  <div style="font-weight: 600; color: #1f2937; margin-bottom: 2px;">${customerName || customerCode}</div>
                  <div style="color: #6b7280; font-size: 12px;">Code: ${customerCode}</div>
                </div>
              </div>
              
              <div>
                <div style="margin-bottom: 16px;">
                  <div style="color: #6b7280; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Total Amount</div>
                  <div style="font-weight: 700; color: #059669; font-size: 20px;">${formattedTotal}</div>
                </div>
                
                <div style="margin-bottom: 16px; padding: 12px; background: #eff6ff; border-radius: 6px; border: 1px solid #bfdbfe;">
                  <div style="color: #1e40af; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px;">Description</div>
                  <div style="color: #374151; font-size: 13px; line-height: 1.4;">${description || 'No description available'}</div>
                </div>
              </div>
            </div>
          </div>
        `;
      });
      
      resultsHtml += '</div>';
      resultsBody.innerHTML = resultsHtml;
    }

    function closeSearchResults() {
      const overlay = document.getElementById('searchResultsOverlay');
      if (overlay) {
        overlay.remove();
      }
    }

    function clearEnhancedSearch() {
      document.getElementById('enhancedSearchPONumber').value = '';
      document.getElementById('enhancedSearchCustomerCode').value = '';
      document.getElementById('enhancedSearchStatus').value = '';
      
      const resultsBody = document.getElementById('enhancedSearchResultsBody');
      resultsBody.innerHTML = '<div style="text-align: center; color: #6b7280; padding: 40px;">Enter search criteria and click Search to find sales orders</div>';
    }

    function extractSOData(soElement) {
      function getXMLValue(element, path) {
        const parts = path.split('/');
        let current = element;
        for (const part of parts) {
          const child = current.getElementsByTagName(part)[0];
          if (!child) {
            return '';
          }
          current = child;
        }
        const result = current.textContent.trim();
        return result;
      }

      const soData = {
        so_number: getXMLValue(soElement, 'so_number'),
        po_date: getXMLValue(soElement, 'po_date'),
        email: getXMLValue(soElement, 'email'),
        customer_code: getXMLValue(soElement, 'customer_info/customer_code'),
        customer_number: getXMLValue(soElement, 'customer_info/customer_number'),
        customer_name: getXMLValue(soElement, 'customer_info/customer_name'),
        customer_address: getXMLValue(soElement, 'customer_info/customer_address1'),
        customer_city: getXMLValue(soElement, 'customer_info/customer_city'),
        customer_country: getXMLValue(soElement, 'customer_info/customer_country'),
        ship_to_code: getXMLValue(soElement, 'ship_to'),
        ship_to: getXMLValue(soElement, 'ship_to'),
        // Create shipto_info object structure for fillShipToInfo function
        shipto_info: {
          number: getXMLValue(soElement, 'ship_to'),
          name: getXMLValue(soElement, 'shipto_info/name'),
          address1: getXMLValue(soElement, 'shipto_info/address1'),
          address2: getXMLValue(soElement, 'shipto_info/address2'),
          city: getXMLValue(soElement, 'shipto_info/city'),
          state: getXMLValue(soElement, 'shipto_info/state'),
          zip: getXMLValue(soElement, 'shipto_info/zip')
        },
        // Ship Via information from SHIPVIAS database
        ship_via: getXMLValue(soElement, 'ship_via'),
        ship_via_code: getXMLValue(soElement, 'ship_via'),
        ship_via_name: getXMLValue(soElement, 'ship_via_name'),
        ship_via_description: getXMLValue(soElement, 'ship_via_description'),
        // Carrier Account (Position 59/76)
        carrier_account: getXMLValue(soElement, 'carrier_account'),
        // Terms (Position 12)
        terms: getXMLValue(soElement, 'terms'),
        so_status: getXMLValue(soElement, 'so_status'),
        line_item: getXMLValue(soElement, 'line_item')
      };

      Object.assign(soData, {
        // Parse hierarchical line items structure
        line_items_data: (() => {
          console.log('=== PARSING HIERARCHICAL LINE ITEMS ===');
          const lineItemsSection = soElement.querySelector('line_items');

          if (!lineItemsSection) {
            console.log('No line_items section found, returning empty array');
            return [];
          }

          const lineItemElements = Array.from(lineItemsSection.querySelectorAll('line_item'));
          // Old per-line needs/schedule entries (for fallback, but now use global)
          const needsEntries = Array.from(soElement.querySelectorAll('needs_info need_entry')); // FIXED: correct tag name
          const scheduleEntries = Array.from(soElement.querySelectorAll('schedule_info schedule_entry'));
          console.log('Found line item elements:', lineItemElements.length);

          // --- Parse global tracking data from new XML blocks ---
          const globalNeedEntries = Array.from(soElement.querySelectorAll('needs_info > need_entry')); // FIXED: correct structure
          const globalAckEntries = Array.from(soElement.querySelectorAll('all_ack_entries > entry'));
          const globalScheduleEntries = Array.from(soElement.querySelectorAll('all_schedule_entries > entry'));

          console.log('Found global needs:', globalNeedEntries.length);
          console.log('Found global acks:', globalAckEntries.length);
          console.log('Found global schedules:', globalScheduleEntries.length);

          const globalNeedsArray = globalNeedEntries.map(e => ({
            needDate: e.querySelector('need_date')?.textContent || '',
            needQty: e.querySelector('need_qty')?.textContent || ''
          }));

          const globalAcksArray = globalAckEntries.map(e => ({
            ackDate: e.querySelector('ack_date')?.textContent || '',
            ackQty: e.querySelector('ack_qty')?.textContent || ''
          }));

          const globalSchedulesArray = globalScheduleEntries.map(e => ({
            scheduleDate: e.querySelector('schedule_date')?.textContent || '',
            scheduleQty: e.querySelector('schedule_qty')?.textContent || ''
          }));

          // Attach to soData for later rendering
          soData.globalNeeds = globalNeedsArray;
          soData.globalAcks = globalAcksArray;
          soData.globalSchedules = globalSchedulesArray;

          // DEBUG: Show raw XML structure for tracking data
          console.log('üîç DEBUG RAW XML STRUCTURE FOR TRACKING DATA:');
          lineItemElements.forEach((item, index) => {
            console.log(`Line Item ${index + 1} RAW XML:`, item.outerHTML);
            console.log(`Line Item ${index + 1} need_date element:`, item.querySelector('need_date'));
            console.log(`Line Item ${index + 1} need_qty element:`, item.querySelector('need_qty'));
            console.log(`Line Item ${index + 1} ack_date element:`, item.querySelector('ack_date'));
            console.log(`Line Item ${index + 1} ack_qty element:`, item.querySelector('ack_qty'));
            console.log(`Line Item ${index + 1} need_date text:`, item.querySelector('need_date')?.textContent);
            console.log(`Line Item ${index + 1} need_qty text:`, item.querySelector('need_qty')?.textContent);
            console.log(`Line Item ${index + 1} ack_date text:`, item.querySelector('ack_date')?.textContent);
            console.log(`Line Item ${index + 1} ack_qty text:`, item.querySelector('ack_qty')?.textContent);
          });

          return lineItemElements.map((item, index) => {
            const lineNumber = index + 1;

            const partNumber = item.querySelector('part_number')?.textContent.trim() || '';
            const description = item.querySelector('description')?.textContent.trim() || '';
            const quantityText = item.querySelector('quantity')?.textContent.trim() || '';
            const quantityNumeric = parseFloat(quantityText);
            const unitPriceText = item.querySelector('unit_price')?.textContent.trim() || '';
            const unitPriceNumeric = parseFloat(unitPriceText) || 0;
            const uom = item.querySelector('uom')?.textContent.trim() || 'EA';

            // Parse needs from need_entries only (avoid legacy duplicates)
            const needEntryElements = Array.from(item.querySelectorAll('need_entries need_entry'));
            console.log(`üîç DEBUG NEEDS PARSING: Line ${lineNumber} found ${needEntryElements.length} need_entry elements`);
            
            const needsArray = needEntryElements.map((entry, entryIndex) => {
              const date = entry.querySelector('need_date')?.textContent.trim() || '';
              const qty = entry.querySelector('need_qty')?.textContent.trim() || '';
              console.log(`üîç DEBUG NEEDS PARSING: Line ${lineNumber} entry ${entryIndex}: date="${date}", qty="${qty}"`);
              return { date, qty };
            }).filter(entry => (entry.date && entry.date.trim()) || (entry.qty && entry.qty.trim()));
            
            console.log(`üîç DEBUG NEEDS PARSING: Line ${lineNumber} final needsArray:`, needsArray);
            
            // Parse acks from ack_entries only (avoid legacy duplicates)
            const acksArray = Array.from(item.querySelectorAll('ack_entries ack_entry')).map(entry => ({
              date: entry.querySelector('ack_date')?.textContent.trim() || '',
              qty: entry.querySelector('ack_qty')?.textContent.trim() || ''
            })).filter(entry => (entry.date && entry.date.trim()) || (entry.qty && entry.qty.trim()));
            
            // Parse schedules from schedule_entries only (avoid legacy duplicates)
            const schedulesArray = Array.from(item.querySelectorAll('schedule_entries schedule_entry')).map(entry => ({
              date: entry.querySelector('schedule_date')?.textContent.trim() || '',
              qty: entry.querySelector('schedule_qty')?.textContent.trim() || ''
            })).filter(entry => (entry.date && entry.date.trim()) || (entry.qty && entry.qty.trim()));

            const firstNeedEntry = needsArray[0] || {};
            const firstAckEntry = acksArray[0] || {};
            const firstScheduleEntry = schedulesArray[0] || {};

            // Extract line notes and convert CHAR(252) subvalue separators to spaces
            let lineNotes = item.querySelector('line_notes')?.textContent.trim() || '';
            // Convert CHAR(252) subvalue marks to spaces for display
            lineNotes = lineNotes.replace(/\xFC/g, ' ').trim();
            console.log(`üîç DEBUG LINE NOTES: Line ${lineNumber} lineNotes="${lineNotes}"`);
            
            // Extract production notes
            let prodNotes = item.querySelector('prod_notes')?.textContent.trim() || '';
            console.log(`üîç DEBUG PROD NOTES PARSED: Line ${lineNumber} prodNotes="${prodNotes}"`);
            
            console.log(`‚úÖ Line ${lineNumber} parsed arrays:`, { needsArray, acksArray, schedulesArray });

            return {
              lineNumber,
              partNumber,
              description,
              quantity: quantityNumeric,
              unitPrice: unitPriceNumeric,
              uom: uom,
              lineNotes: lineNotes,
              prodNotes: prodNotes,
              needs: needsArray,
              acks: acksArray,
              schedules: schedulesArray,
              needEntries: needsArray,
              ackEntries: acksArray,
              scheduleEntries: schedulesArray,
              needDate: firstNeedEntry.date || '',
              needQty: firstNeedEntry.qty || '',
              ackDate: firstAckEntry.date || '',
              ackQty: firstAckEntry.qty || '',
              scheduleDate: firstScheduleEntry.date || '',
              scheduleQty: firstScheduleEntry.qty || ''
            };
          });
          
        })(),
        po_price: getXMLValue(soElement, 'po_price'),
        po_price: getXMLValue(soElement, 'po_price'),
        noted_stamp: getXMLValue(soElement, 'noted_stamp'),
        
        // Customer info
        customer_info: {
          number: getXMLValue(soElement, 'customer_info/customer_number'),
          name: getXMLValue(soElement, 'customer_info/customer_name'),
          address1: getXMLValue(soElement, 'customer_info/customer_address1'),
          address2: getXMLValue(soElement, 'customer_info/customer_address2'),
          city: getXMLValue(soElement, 'customer_info/customer_city'),
          state: getXMLValue(soElement, 'customer_info/customer_state'),
          zip: getXMLValue(soElement, 'customer_info/customer_zip'),
          country: getXMLValue(soElement, 'customer_info/customer_country'),
          contact: getXMLValue(soElement, 'customer_info/customer_contact'),
          email: getXMLValue(soElement, 'customer_info/customer_email'),
          phone: getXMLValue(soElement, 'customer_info/customer_phone')
        },
        
        // Ship to info
        shipto_info: (() => {
  const shiptoSection = soElement.querySelector('shipto_info');
  console.log('üîç DEBUG SHIPTO XML SECTION:', shiptoSection);
  if (shiptoSection) {
    console.log('üîç DEBUG SHIPTO XML HTML:', shiptoSection.outerHTML);
  }

  return {
    number: getXMLValue(soElement, 'shipto_info/shipto_number'),
    name: getXMLValue(soElement, 'shipto_info/shipto_name') || getXMLValue(soElement, 'shipto_info/name'),
    address1: getXMLValue(soElement, 'shipto_info/shipto_address1') || getXMLValue(soElement, 'shipto_info/address1'),
    address2: getXMLValue(soElement, 'shipto_info/shipto_address2') || getXMLValue(soElement, 'shipto_info/address2'),
    city: getXMLValue(soElement, 'shipto_info/shipto_city') || getXMLValue(soElement, 'shipto_info/city'),
    state: getXMLValue(soElement, 'shipto_info/shipto_state') || getXMLValue(soElement, 'shipto_info/state'),
    zip: getXMLValue(soElement, 'shipto_info/shipto_zip') || getXMLValue(soElement, 'shipto_info/zip')
  };
        })(),
        
        
        // Descriptions
        descriptions: Array.from(soElement.querySelectorAll('po_descriptions description')).map(desc => desc.textContent.trim()),
        
        // Header notes - handle direct text content
        header_notes: (() => {
          const headerNotesEl = soElement.getElementsByTagName('header_notes')[0];
          if (headerNotesEl && headerNotesEl.textContent.trim()) {
            return [headerNotesEl.textContent.trim()];
          }
          return Array.from(soElement.querySelectorAll('header_notes note')).map(note => note.textContent.trim());
        })(),
        
        // Line notes with debugging
        line_notes: (() => {
          const lineNotesSection = soElement.querySelector('line_notes');
          console.log('=== LINE NOTES XML EXTRACTION DEBUG ===');
          console.log('Line notes section found:', lineNotesSection);
          console.log('Line notes section HTML:', lineNotesSection ? lineNotesSection.innerHTML : 'NULL');
          
          const notes = Array.from(soElement.querySelectorAll('line_notes note, line_note note')).map(note => note.textContent.trim());
          console.log('Extracted line notes:', notes);
          console.log('Line notes count:', notes.length);
          
          return notes;
        })(),
        
        // Debug checkpoint before acknowledgments
        debug_checkpoint: (() => {
          console.log('DEBUG: Reached acknowledgments extraction point');
          return 'checkpoint';
        })(),
        
        // Extract acknowledgment data from header level
        acknowledgments: (() => {
          const ackSection = soElement.querySelector('acknowledgments');
          if (!ackSection) return {};
          
          console.log(' Acknowledgments section found:', ackSection.outerHTML);
          
          const ackData = {
            ack_field49: getXMLValue(ackSection, 'ack_field49')
          };
          
          console.log('üîç Extracted acknowledgment data:', ackData);
          return ackData;
        })(),
        
        // Need dates and quantities from <needs_info> (field <38>)
        needs: (() => {
          console.log('=== SEARCHING FOR NEEDS DATA ===');
          const needsSection = soElement.querySelector('needs_info');
          console.log('Needs section found:', needsSection);
          
          if (!needsSection) {
            console.log('No needs_info section in XML - checking if any data exists in field 38');
            // Debug: check if we have any needs-related content anywhere
            const allText = soElement.textContent;
            if (allText.includes('needs') || allText.includes('NEEDS')) {
              console.log('Found "needs" text in XML content');
            }
            return null;
          }
          
          console.log('needs_info innerHTML:', needsSection.innerHTML);
          const needsEntries = Array.from(needsSection.querySelectorAll('need_entry')); // FIXED: correct tag name
          console.log('Found needs entries:', needsEntries.length);
          
          if (needsEntries.length === 0) {
            console.log('No need_entry elements found');
            return null;
          }
          
          const result = {
            need_line: needsEntries.map((entry, entryIndex) => {
              console.log(`Processing need_entry ${entryIndex}:`, entry.innerHTML);
              
              // Backend structure: <need_entry><need_date>21088</need_date><need_qty>12</need_qty></need_entry>
              const dateElement = entry.querySelector('need_date');
              const quantityElement = entry.querySelector('need_qty');
              
              const parsedEntry = {
                date: dateElement ? dateElement.textContent.trim() : '',
                quantity: quantityElement ? quantityElement.textContent.trim() : ''
              };
              
              console.log(`Parsed need entry ${entryIndex}:`, parsedEntry);
              return parsedEntry;
            })
          };
          console.log('Final needs structure:', result);
          return result.need_line.length > 0 ? result : null;
        })(),
        
        // Schedule dates and quantities (separate from needs)
        schedule: (() => {
          const scheduleSection = soElement.querySelector('schedule_info');
          console.log('Schedule section found:', scheduleSection);
          if (!scheduleSection) {
            console.log('No schedule_info section in XML');
            return null;
          }

          const scheduleEntries = Array.from(scheduleSection.querySelectorAll('schedule_entry'));
          console.log('Found schedule entries:', scheduleEntries.length);

          const result = {
            schedule_line: scheduleEntries.map(entry => {
              const scheduleItem = entry.querySelector('schedule_item');
              if (scheduleItem) {
                const dateElement = scheduleItem.querySelector('date');
                const quantityElement = scheduleItem.querySelector('quantity');
                console.log('Processing schedule item:', scheduleItem.innerHTML);
                return {
                  schedule_entry: [{
                    date: dateElement ? dateElement.textContent.trim() : '',
                    quantity: quantityElement ? quantityElement.textContent.trim() : ''
                  }]
                };
              }
              return { schedule_entry: [] };
            })
          };
          console.log('Final schedule structure:', result);
          return result.schedule_line.length > 0 ? result : null;
        })()
      });

      // DEBUG: Check the raw XML structure for needs_info
      const needsSection = soElement.querySelector('needs_info');
      console.log('üîç DEBUG XML: needs_info section HTML:', needsSection ? needsSection.outerHTML : 'NULL');
      
      // DEBUG: Also check for raw field 38 data
      const field38Element = soElement.querySelector('field38') || 
                            soElement.querySelector('[field="38"]') ||
                            Array.from(soElement.querySelectorAll('*')).find(el => 
                              el.textContent && el.textContent.includes('21096*2') || 
                              el.textContent.includes('21088*20')
                            );
      console.log('üîç DEBUG XML: field38 or similar element:', field38Element ? field38Element.outerHTML : 'NOT FOUND');
      
      // NO LONGER NEEDED: Don't create global needsArray - needs are handled per line item now
      const needsArray = [];
      
      // Legacy fallback for old needs_info structure (if it exists)
      if (needsArray.length === 0) {
        Array.from(soElement.querySelectorAll('needs_info needs_entry')).forEach(entry => {
          const dateNode = entry.querySelector('need_date');
          const qtyNode = entry.querySelector('need_qty');
          const result = {
            need_date: dateNode ? dateNode.textContent.trim() : '',
            need_qty: qtyNode ? qtyNode.textContent.trim() : ''
          };
          console.log('üîç DEBUG NEEDS: Parsed needs_entry (legacy):', result);
          if (result.need_date && result.need_qty) {
            needsArray.push(result);
          }
        });
      }
      
      console.log('üîç DEBUG NEEDS: Total needsArray length:', needsArray.length);
      console.log('üîç DEBUG NEEDS: Complete needsArray:', needsArray);

      const ackArray = Array.from(soElement.querySelectorAll('ack_info ack_entry')).map(entry => {
        const dateNode = entry.querySelector('ack_date');
        const qtyNode = entry.querySelector('ack_qty');
        return {
          date: dateNode ? dateNode.textContent.trim() : '',
          qty: qtyNode ? qtyNode.textContent.trim() : ''
        };
      });

      const scheduleArray = Array.from(soElement.querySelectorAll('schedule_info schedule_entry')).map(entry => {
        const dateNode = entry.querySelector('schedule_date');
        const qtyNode = entry.querySelector('schedule_qty');
        const rsNode = entry.querySelector('schedule_rs');
        return {
          date: dateNode ? dateNode.textContent.trim() : '',
          qty: qtyNode ? qtyNode.textContent.trim() : '',
          rs: rsNode ? rsNode.textContent.trim() === '1' : false
        };
      });

      return {
        ...soData,
        needs_data: needsArray,
        ack_data: ackArray,
        schedule_data: scheduleArray
      };
    }

    function loadSOForEditing(soNumber) {
      // Load SO data into the main form
      const soNumberInput = document.getElementById('soNumberInput');
      if (soNumberInput) {
        soNumberInput.value = soNumber;
        
        // Trigger search to populate form
        const xhr = new XMLHttpRequest();
        xhr.open('GET', `GET_SO.XML?SO_NUMBER=${encodeURIComponent(soNumber)}`, true);
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4 && xhr.status === 200) {
            try {
              const parser = new DOMParser();
              const xmlDoc = parser.parseFromString(xhr.responseText, 'text/xml');
              const soElements = xmlDoc.getElementsByTagName('so');
              
              if (soElements.length > 0) {
                const soElement = soElements[0];
                const soData = extractSOData(soElement);
                
                // Populate form and show display
                fillFormWithSOData(soData);
                
                // Load SO data to show info sections (customer, ship to, salesperson)
                loadSOData(soData);
                
                // Validate Step 2 to enable Continue button
                if (typeof validateStep2 === 'function') {
                  setTimeout(() => {
                    validateStep2();
                    console.log('‚úÖ Step 2 validated after SO load (draft path)');
                  }, 500);
                }
                
                // Don't automatically show display - let user decide
                // showPODisplay(soData);
              }
            } catch (error) {
              console.error('Error loading SO for editing:', error);
            }
          }
        };
        xhr.send();
      }
    }

    function populateShipViaDropdown() {
      console.log('üöö Populating Ship Via dropdown...');
      const shipViaSelect = document.getElementById('shipViaSelect');
      
      if (!shipViaSelect) {
        console.error('‚ùå shipViaSelect element not found!');
        return;
      }
      
      if (shipviasData.length === 0) {
        console.log('‚ö†Ô∏è shipviasData is empty, loading Ship Vias first...');
        // If ship vias not loaded yet, load them first
        loadShipVias();
        return;
      }
      
      console.log(`‚úÖ Populating dropdown with ${shipviasData.length} ship vias`);
      shipViaSelect.innerHTML = '<option value="">Select Ship Via...</option>';
      
      shipviasData.forEach((shipvia, index) => {
        const option = document.createElement('option');
        option.value = shipvia.code;
        option.textContent = shipvia.name;
        if (shipvia.description) {
          option.textContent += ` - ${shipvia.description}`;
        }
        shipViaSelect.appendChild(option);
        console.log(`  Added option ${index + 1}: ${shipvia.code} - ${shipvia.name}`);
      });
      
      console.log('‚úÖ Ship Via dropdown populated successfully');
    }


    // Keep Data Capture form in sync with SO display (at least SO Date for now)
    function syncPOFormFields(soData){
      try{
        var soDateInput = document.getElementById('soDateInput');
        if(!soDateInput) return;
        var raw = (soData && soData.po_date) ? String(soData.po_date).trim() : '';
        // Normalize using shared converter to YYYY-MM-DD for <input type="date">
        var normalized = convertDateFormat(raw);
        if(!normalized){
          // fallback: set today if empty/unknown, so the form is usable
          var dt = new Date();
          var yyyy = dt.getFullYear();
          var mm = String(dt.getMonth()+1).padStart(2,'0');
          var dd = String(dt.getDate()).padStart(2,'0');
          normalized = `${yyyy}-${mm}-${dd}`;
        }
        soDateInput.value = normalized;
      }catch(e){ console.warn('syncPOFormFields error:', e); }
    }

    function showPODisplay(soData) {
      // Hide form and show display
      document.getElementById('soForm').style.display = 'none';
      document.getElementById('soHeaderDisplay').style.display = 'block';
      
      // Populate display fields
      document.getElementById('displaySODate').textContent = formatDate(soData.po_date) || '-';
      
      
      // Customer info - Show customer_number in display field
      document.getElementById('displayCustomerCode').value = soData.customer_number || soData.customer_code || '-';
      document.getElementById('displayCustomerName').textContent = soData.customer_info?.name || soData.customer_name || '-';
      
      // Build complete address from CUSTOMER fields 1-3
      let customerAddress = '';
      // Field 2 (002): Address line
      if (soData.customer_info?.address1) {
        customerAddress += soData.customer_info.address1;
      }
      // Field 3 (003): City, State, Zip (all together)
      if (soData.customer_info?.address2) {
        customerAddress += (customerAddress ? '\n' : '') + soData.customer_info.address2;
      }
      document.getElementById('displayCustomerAddress').textContent = customerAddress || '-';
      
      
      // Ship To info (optional UI)
      const dspShipToCode = document.getElementById('displayShipToCode');
      const dspShipToName = document.getElementById('displayShipToName');
      const dspShipToAddress = document.getElementById('displayShipToAddress');
      if (dspShipToCode) dspShipToCode.value = soData.ship_to_address || '-';
      if (dspShipToName) dspShipToName.textContent = (soData.shipto_info && soData.shipto_info.name) || '-';
      
      let shiptoAddress = '';
      if (soData.shipto_info.address1) shiptoAddress += soData.shipto_info.address1;
      if (soData.shipto_info.city) shiptoAddress += (shiptoAddress ? ', ' : '') + soData.shipto_info.city;
      if (soData.shipto_info.state) shiptoAddress += (shiptoAddress ? ', ' : '') + soData.shipto_info.state;
      if (dspShipToAddress) dspShipToAddress.textContent = shiptoAddress || '-';
      
      // Ship Via dropdown
      populateShipViaDropdown();
      
      const statusSelect = document.getElementById('displayStatusSelect');
      statusSelect.innerHTML = '';
      const statusOption = document.createElement('option');
      statusOption.value = soData.so_status || 'New';
      statusOption.textContent = soData.so_status || 'New';
      statusOption.selected = true;
      statusSelect.appendChild(statusOption);
      
      // Fill detailed info sections
      fillCustomerInfo(soData.customer_info);
      fillShiptoInfo(soData.shipto_info);
      // Keep the hidden Data Capture form coherent (SO Date)
      syncPOFormFields(soData);
    }

    // ‚ùå REMOVED DUPLICATE FUNCTION - Using the complete version at line ~4463
    // This duplicate was causing ADD LINE ITEM button to malfunction
    // The complete function includes proper editingLineIndex = -1 setup

    function hideAddLineItemForm() {
      // Switch back to Data Capture tab (tab-0) and go to Step 4 (Line Items)
      switchTab(0);
      goToStep(4);
      
      // Clear form
      clearLineItemForm();
      editingLineIndex = -1;
    }

    function toggleDetails(){
      var pane=document.getElementById('tab-2');
      var btn=document.getElementById('toggleDetailsBtn');
      if(!pane) return;
      // Toggle overview class; when removed, full details (with tracking & bottom sections) appear
      if(pane.classList.contains('overview')){
        pane.classList.remove('overview');
        if(btn) btn.textContent='Hide Details';
      }else{
        pane.classList.add('overview');
        if(btn) btn.textContent='Show Details';
      }
    }

    function closeAddLineItemModal() {
      console.log('üîß closeAddLineItemModal: Starting...');
      try {
        hideAddLineItemForm();
        console.log('‚úÖ closeAddLineItemModal: hideAddLineItemForm() completed');
      } catch (error) {
        console.error('‚ùå closeAddLineItemModal: Error in hideAddLineItemForm():', error);
      }
      
      // Switch back to Data Capture tab where the table lives so the rows stay visible
      try {
        switchTab(0);
        console.log('‚úÖ closeAddLineItemModal: switchTab(0) completed');
        
        console.log('‚úÖ closeAddLineItemModal: tab-0 now showing line items table');
        
      } catch (error) {
        console.error('‚ùå closeAddLineItemModal: Error in switchTab(0):', error);
      }
      console.log('‚úÖ closeAddLineItemModal: Process completed');
    }

    async function showNewSOForm() {
      const shiptoSection = document.getElementById('shipToInfoSection');
      if (shiptoSection) shiptoSection.style.display = 'none';
      
      // Auto-generate new SO number
      await generateNextPONumber();
      
      // Start walkthrough
      startNewSO();
    }

    

    function getXMLValue(parent, tagName) {
      const element = parent.getElementsByTagName(tagName)[0];
      return element ? element.textContent : '';
    }
    
    function getNotesFromXML(soElement) {
      const notes = [];
      
      // Extract line item details (part numbers and descriptions)
      const partNumbers = getXMLValue(soElement, 'part_number');
      const descriptions = soElement.getElementsByTagName('so_descriptions')[0];
      
      if (partNumbers && descriptions) {
        const parts = partNumbers.split('ÔøΩ');
        const descElements = descriptions.getElementsByTagName('description');
        
        notes.push('=== LINE ITEMS ===');
        for (let i = 0; i < Math.max(parts.length, descElements.length); i++) {
          const partNum = parts[i] ? parts[i].trim() : '';
          const desc = descElements[i] ? descElements[i].textContent.trim() : '';
          
          if (partNum || desc) {
            notes.push(`Line ${i + 1}: ${partNum} - ${desc}`);
          }
        }
        notes.push(''); // Empty line separator
      }
      
      // Extract notes from header_notes multivalue field
      const headerNotes = soElement.getElementsByTagName('header_notes')[0];
      if (headerNotes) {
        const noteElements = headerNotes.getElementsByTagName('note');
        if (noteElements.length > 0) {
          notes.push('=== HEADER NOTES ===');
          for (let i = 0; i < noteElements.length; i++) {
            const noteText = noteElements[i].textContent.trim();
            if (noteText) {
              notes.push(noteText);
            }
          }
        } else {
          // Handle case where header_notes is a single text node
          const headerNotesText = headerNotes.textContent.trim();
          if (headerNotesText) {
            notes.push('=== HEADER NOTES ===');
            notes.push(headerNotesText);
          }
        }
      }
      
      return notes.join('\n');
    }
    
    function extractScheduleDate(soElement) {
      // Extract schedule date from schedule_info/schedule_entry/schedule_item
      // For multi-line POs, get the earliest schedule date
      const scheduleInfo = soElement.getElementsByTagName('schedule_info')[0];
      if (scheduleInfo) {
        const scheduleEntries = scheduleInfo.getElementsByTagName('schedule_entry');
        let earliestDate = null;
        let earliestDateNum = null;
        
        for (let i = 0; i < scheduleEntries.length; i++) {
          const scheduleItem = scheduleEntries[i].getElementsByTagName('schedule_item')[0];
          if (scheduleItem) {
            const itemText = scheduleItem.textContent.trim();
            // Split on * and take the first part (the date)
            const datePart = itemText.split('*')[0];
            const dateNum = parseInt(datePart);
            
            if (!isNaN(dateNum) && (earliestDateNum === null || dateNum < earliestDateNum)) {
              earliestDateNum = dateNum;
              earliestDate = convertDateFormat(datePart);
            }
          }
        }
        
        return earliestDate || '';
      }
      return '';
    }
    
    function formatPrice(priceStr) {
      // Convert price from cents to dollars, handling multivalue fields
      if (!priceStr || priceStr.trim() === '') return '';
      
      // Handle multivalue prices separated by special character (ÔøΩ)
      if (priceStr.includes('ÔøΩ')) {
        const prices = priceStr.split('ÔøΩ');
        let totalCents = 0;
        
        for (let i = 0; i < prices.length; i++) {
          const priceNum = parseInt(prices[i].trim());
          if (!isNaN(priceNum)) {
            totalCents += priceNum;
          }
        }
        
        return (totalCents / 100).toFixed(2);
      }
      
      // Handle single price
      const priceNum = parseInt(priceStr);
      if (!isNaN(priceNum)) {
        return (priceNum / 100).toFixed(2);
      }
      
      return priceStr; // Return as-is if not a number
    }
    
    function extractCustomerInfo(soElement) {
      // Extract customer information from customer_info section
      const customerInfo = soElement.getElementsByTagName('customer_info')[0];
      if (!customerInfo) {
        return {
          name: '',
          address1: '',
          address2: '',
          city: '',
          state: '',
          zip: '',
          country: '',
          contact: '',
          email: '',
          phone: ''
        };
      }
      
      return {
        name: getXMLValue(customerInfo, 'customer_name'),
        address1: getXMLValue(customerInfo, 'customer_address1'),
        address2: getXMLValue(customerInfo, 'customer_address2'),
        city: getXMLValue(customerInfo, 'customer_city'),
        state: getXMLValue(customerInfo, 'customer_state'),
        zip: getXMLValue(customerInfo, 'customer_zip'),
        country: getXMLValue(customerInfo, 'customer_country'),
        contact: getXMLValue(customerInfo, 'customer_contact'),
        email: getXMLValue(customerInfo, 'customer_email'),
        phone: getXMLValue(customerInfo, 'customer_phone')
      };
    }
    
    
    function extractShipToInfo(soElement) {
      // Extract ship to information from shipto_info section
      const shiptoInfo = soElement.getElementsByTagName('shipto_info')[0];
      if (!shiptoInfo) {
        return {
          name: '',
          address1: '',
          address2: '',
          city: '',
          state: '',
          zip: ''
        };
      }
      
      return {
        name: getXMLValue(shiptoInfo, 'shipto_name'),
        address1: getXMLValue(shiptoInfo, 'shipto_address1'),
        address2: getXMLValue(shiptoInfo, 'shipto_address2'),
        city: getXMLValue(shiptoInfo, 'shipto_city'),
        state: getXMLValue(shiptoInfo, 'shipto_state'),
        zip: getXMLValue(shiptoInfo, 'shipto_zip')
      };
    }
    
    // Clean Pick/BASIC special characters from text
    function cleanPickText(text) {
      if (!text) return text;
      
      // Replace Pick/BASIC separators with spaces
      // CHAR(254) = Attribute Mark (^) = ÔøΩ
      // CHAR(253) = Value Mark (])
      // CHAR(252) = Subvalue Mark (\)
      return text
        .replace(/\u00FE/g, ' ')  // Replace CHAR(254) with space
        .replace(/\u00FD/g, ' ')  // Replace CHAR(253) with space
        .replace(/\u00FC/g, ' ')  // Replace CHAR(252) with space
        .replace(/ÔøΩ/g, ' ')        // Replace diamond character with space
        .trim();
    }
    
    // Convert Julian date to MM/DD/YYYY for display
    function julianToDisplay(julianStr) {
      if (!julianStr || julianStr.trim() === '') return '-';
      
      // Check if it's a numeric Julian date
      if (/^\d+$/.test(julianStr)) {
        const numericDate = parseInt(julianStr, 10);
        
        // FILTER INVALID JULIAN DATES
        if (numericDate <= 1 || numericDate > 50000) {
          return '-';
        }
        
        // Convert Pick date to JavaScript date
        const baseDate = new Date(1967, 11, 31); // December 31, 1967
        const targetDate = new Date(baseDate.getTime() + (numericDate * 24 * 60 * 60 * 1000));
        
        const year = targetDate.getFullYear();
        const month = (targetDate.getMonth() + 1).toString().padStart(2, '0');
        const day = targetDate.getDate().toString().padStart(2, '0');
        
        return `${month}/${day}/${year}`;
      }
      
      return julianStr; // Return as-is if not Julian
    }
    
    function convertDateFormat(dateStr) {
      // Convert various date formats to YYYY-MM-DD for HTML date inputs
      if (!dateStr || dateStr.trim() === '') return '';
      
      // Handle MM/DD/YYYY format
      if (dateStr.includes('/')) {
        const parts = dateStr.split('/');
        if (parts.length === 3) {
          const month = parts[0].padStart(2, '0');
          const day = parts[1].padStart(2, '0');
          const year = parts[2].length === 2 ? ('20' + parts[2]) : parts[2];
          return year + '-' + month + '-' + day;
        }
      }

      // Handle MM-DD-YYYY format
      if (dateStr.includes('-') && /^\d{1,2}-\d{1,2}-\d{2,4}$/.test(dateStr)) {
        const parts = dateStr.split('-');
        if (parts.length === 3) {
          const month = parts[0].padStart(2, '0');
          const day = parts[1].padStart(2, '0');
          const year = parts[2].length === 2 ? ('20' + parts[2]) : parts[2];
          return year + '-' + month + '-' + day;
        }
      }

      // Handle YYYYMMDD (8 digits) format
      if (/^\d{8}$/.test(dateStr)) {
        return dateStr.slice(0,4) + '-' + dateStr.slice(4,6) + '-' + dateStr.slice(6,8);
      }
      
      // Handle Pick BASIC internal date format (days since 1967-12-31)
      // Only if the string is fully numeric (avoid cases like '2024-6-3')
      if (/^\d+$/.test(dateStr)) {
        const numericDate = parseInt(dateStr, 10);
        
        // FILTER INVALID JULIAN DATES: Skip 0, 1, and other invalid low numbers
        if (numericDate <= 1 || numericDate > 50000) {
          console.log(`‚ö†Ô∏è convertDateFormat: Skipping invalid Julian date: ${dateStr}`);
          return '';
        }
        
        // Convert Pick date to JavaScript date
        const baseDate = new Date(1967, 11, 31); // December 31, 1967
        const targetDate = new Date(baseDate.getTime() + (numericDate * 24 * 60 * 60 * 1000));
        
        const year = targetDate.getFullYear();
        const month = (targetDate.getMonth() + 1).toString().padStart(2, '0');
        const day = targetDate.getDate().toString().padStart(2, '0');
        
        return year + '-' + month + '-' + day;
      }
      
      // If already in YYYY-MM-DD format, return as is
      if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
        return dateStr;
      }
      
      // Return empty string for invalid formats
      return '';
    }
    
    function formatDate(dateStr) {
      if (!dateStr) return '';
      const d = new Date(dateStr);
      if (isNaN(d.getTime())) return dateStr;
      return d.toISOString().split('T')[0]; // yyyy-MM-dd para inputs tipo date
    }
    
    function fillFormWithSOData(soData) {
      console.log('üö® FILLFORM DEBUG: fillFormWithSOData() called!');
      console.log('üö® FILLFORM DEBUG: Stack trace:');
      console.trace();
      
      // Fill all form fields with the SO data
      const soNumberInput = document.getElementById('soNumberInput');
      const soNumber = soData.so_number || '';
      soNumberInput.value = soNumber;
      
      const customerCodeInput = document.getElementById('customerCodeInput');
      // Show customer_number in input field but keep customer_code for backend
      const customerNumber = soData.customer_number || soData.customer_code || '';
      customerCodeInput.value = customerNumber;
      // Store customer_code separately for backend operations
      customerCodeInput.setAttribute('data-customer-code', soData.customer_code || '');
      
      const soDateInput = document.getElementById('soDateInput');
      const poDate = convertDateFormat(soData.po_date) || '';
      soDateInput.value = poDate;

      // Set email field
      const emailInput = document.getElementById('emailInput');
      if (emailInput && soData.email) {
        // Convert multivalue format from database (char(253)) to comma-separated
        const emailValue = soData.email.replace(/\xFD/g, ', ').trim();
        emailInput.value = emailValue;
        console.log('Set email field:', emailValue);
      }
      
      // Handle empty required fields to prevent validation errors
      function handleRequiredField(element, value, fieldName) {
        if (!value) {
          console.log(`No ${fieldName} found, removing required attribute temporarily`);
          element.removeAttribute('required');
          element.style.border = '1px solid #fbbf24';
          element.style.backgroundColor = '#fefce8';
        } else {
          element.setAttribute('required', '');
          element.style.border = '';
          element.style.backgroundColor = '';
        }
      }
      
      handleRequiredField(soNumberInput, soNumber, 'SO number');
      handleRequiredField(customerCodeInput, customerNumber, 'customer number');
      handleRequiredField(soDateInput, poDate, 'SO date');
      const reqDateEl = document.getElementById('requiredDateInput'); if (reqDateEl) reqDateEl.value = convertDateFormat(soData.required_date) || '';
      const shipDateEl = document.getElementById('shipDateInput'); if (shipDateEl) shipDateEl.value = convertDateFormat(soData.ship_date) || '';
      const soStatusSelect = document.getElementById('soStatusInput');
      const soStatus = soData.so_status || '';
      soStatusSelect.value = soStatus;
      handleRequiredField(soStatusSelect, soStatus, 'SO status');
      const shipToAddrEl = document.getElementById('shipToAddressInput'); if (shipToAddrEl) shipToAddrEl.value = soData.ship_to_address || '';
      const paymentTermsEl = document.getElementById('paymentTermsInput'); if (paymentTermsEl) paymentTermsEl.value = soData.payment_terms || '';
      const shipToCodeInput = document.getElementById('shipToCodeInput');
      // Use shipto_info data if available, otherwise fallback to ship_to_code
      let shipToDisplayValue = '';
      
      console.log('=== POPULATING SHIP TO INPUT FIELD ===');
      console.log('soData.shipto_info:', soData.shipto_info);
      console.log('soData.ship_to_code:', soData.ship_to_code);
      
      // Try to use the same parsing logic as fillShipToInfo for consistency
      if (soData.shipto_info) {
        if (soData.shipto_info.number && soData.shipto_info.name) {
          shipToDisplayValue = `${soData.shipto_info.number} - ${soData.shipto_info.name}`;
          console.log('‚úÖ Using parsed shipto_info for field:', shipToDisplayValue);
        } else {
          // Parse concatenated shipto_number like in fillShipToInfo
          const shiptoNumber = soData.shipto_info.shipto_number || soData.shipto_info.number || '';
          if (shiptoNumber && shiptoNumber.includes(' - ')) {
            const parts = shiptoNumber.split(' - ');
            const number = parts[0].trim();
            const name = parts[1].trim();
            shipToDisplayValue = `${number} - ${name}`;
            console.log('‚úÖ Parsed concatenated shipto for field:', shipToDisplayValue);
          } else {
            shipToDisplayValue = shiptoNumber;
            console.log('‚úÖ Using simple shipto number for field:', shipToDisplayValue);
          }
        }
      } else {
        shipToDisplayValue = soData.ship_to_code || '';
        console.log('‚úÖ Using fallback ship_to_code for field:', shipToDisplayValue);
      }
      
      if (shipToCodeInput) {
        shipToCodeInput.value = shipToDisplayValue;
        console.log('‚úÖ Set shipToCodeInput.value to:', shipToDisplayValue);
        handleRequiredField(shipToCodeInput, shipToDisplayValue, 'ship to code');
      }
      // Optional (fields may be removed from UI)
      const currencyEl = document.getElementById('currencyInput'); if (currencyEl) currencyEl.value = soData.currency || 'USD';
      const subtotalEl = document.getElementById('subtotalInput'); if (subtotalEl) subtotalEl.value = soData.subtotal || '';
      const taxEl = document.getElementById('taxAmountInput'); if (taxEl) taxEl.value = soData.tax_amount || '';
      const shipCostEl = document.getElementById('shippingCostInput'); if (shipCostEl) shipCostEl.value = soData.shipping_cost || '';
      const totalEl = document.getElementById('totalAmountInput'); if (totalEl) totalEl.value = soData.total_amount || '';
      // Combine notes from field <40> and header_notes from field <25>
      console.log('Processing notes - soData.notes:', soData.notes);
      console.log('Processing notes - soData.header_notes:', soData.header_notes);
      let combinedNotes = '';
      if (soData.notes) {
        combinedNotes += soData.notes;
        console.log('Added notes from field <40>:', soData.notes);
      }
      if (soData.header_notes && Array.isArray(soData.header_notes) && soData.header_notes.length > 0) {
        if (combinedNotes) combinedNotes += '\n\n--- Header Notes ---\n';
        combinedNotes += soData.header_notes.join('\n');
        console.log('Added header_notes from field <25>:', soData.header_notes);
      }
      console.log('Final combined notes:', combinedNotes);
      document.getElementById('notesInput').value = combinedNotes;
      
      // Fill customer information section
      fillCustomerInfo(soData.customer_info);
      
      // CRITICAL: Fetch Bill To information from position 4 (billto_code_direct)
      const billToCodeDirect = soData.billto_code_direct || (soData.customer_info && soData.customer_info.bill_to_code) || '';
      if (billToCodeDirect) {
        console.log('üîç Found billto_code_direct in SO position 4:', billToCodeDirect);
        const billToInput = document.getElementById('shipToCodeInput');
        if (billToInput) {
          billToInput.value = billToCodeDirect;
          console.log('‚úÖ Auto-filled Bill To searchbar from SO load:', billToCodeDirect);
        }
        // Fetch Bill To with delay to ensure it loads after Ship To
        setTimeout(() => {
          console.log('üöÄ Calling fetchBillToInfo from fillFormWithSOData:', billToCodeDirect);
          fetchBillToInfo(billToCodeDirect);
        }, 800); // Slightly longer delay for SO load
      } else {
        console.log('‚ùå No billto_code_direct found in SO');
      }
      
      // Set Ship Via dropdown selection (Position 11 in database)
      console.log('=== POPULATING SHIP VIA DROPDOWN ===');
      console.log('soData.ship_via:', soData.ship_via);
      console.log('soData.ship_via_code:', soData.ship_via_code);
      console.log('soData.ship_via_name:', soData.ship_via_name);
      console.log('soData.ship_via_description:', soData.ship_via_description);
      
      const shipViaCode = soData.ship_via || soData.ship_via_code || '';
      const shipViaSelect = document.getElementById('shipViaSelect');
      
      if (shipViaCode && shipViaSelect) {
        // First ensure ship vias are loaded
        if (shipviasData.length === 0) {
          console.log('üîÑ Loading ship vias because shipviasData is empty');
          loadShipVias().then(() => {
            console.log('‚úÖ Ship vias loaded, now populating dropdown');
            populateShipViaDropdown();
            shipViaSelect.value = shipViaCode;
            console.log('‚úÖ Set Ship Via after loading shipvias:', shipViaCode);
          });
        } else {
          console.log('‚úÖ Ship vias already loaded, populating dropdown');
          populateShipViaDropdown();
          shipViaSelect.value = shipViaCode;
          console.log('‚úÖ Set Ship Via directly:', shipViaCode);
        }
      } else {
        console.log('‚ö†Ô∏è Missing shipViaCode or shipViaSelect element');
        console.log('shipViaCode:', shipViaCode);
        console.log('shipViaSelect:', shipViaSelect);
      }
      
      // Set Carrier Account field
      const carrierAccountInput = document.getElementById('carrierAccountInput');
      console.log('üîç Carrier Account DEBUG:');
      console.log('  - carrierAccountInput element:', carrierAccountInput);
      console.log('  - soData.carrier_account value:', soData.carrier_account);
      console.log('  - soData.carrier_account type:', typeof soData.carrier_account);
      if (carrierAccountInput) {
        carrierAccountInput.value = soData.carrier_account || '';
        console.log('‚úÖ Set Carrier Account field to:', carrierAccountInput.value);
      } else {
        console.error('‚ùå carrierAccountInput element not found!');
      }
      
      // Set Terms field
      const termsInput = document.getElementById('termsInput');
      if (termsInput && soData.terms) {
        termsInput.value = soData.terms;
        console.log('‚úÖ Set Terms field:', soData.terms);
      }
      
      // Store currentSOData globally first for fillShipToInfo to access
      window.currentSOData = soData;
      
      // Fill ship to information section
      console.log('=== CALLING fillShipToInfo ===');
      console.log('soData.shipto_info:', soData.shipto_info);
      fillShipToInfo(soData.shipto_info);
      
      
      // Fill line item part number
      if (soData.part_number) {
        const partField = document.getElementById('linePartNumber');
        if (partField) {
          partField.value = soData.part_number;
          console.log('Set part number in line item:', soData.part_number);
        } else {
          console.log('linePartNumber field not found');
        }
      } else {
        console.log('No part_number in soData');
      }
      
      // Fill line item price 
      if (soData.unit_price) {
        const priceField = document.getElementById('lineUnitPrice');
        if (priceField) {
          priceField.value = parseFloat(soData.unit_price).toFixed(2);
          console.log('Set price in line item:', soData.unit_price);
        } else {
          console.log('lineUnitPrice field not found');
        }
      } else {
        console.log('No unit_price in soData');
      }
      
      // DISABLED: Line notes are now handled individually per line item
      // Legacy global line notes display is no longer needed
      /*
      if (soData.line_notes && Array.isArray(soData.line_notes) && soData.line_notes.length > 0) {
        console.log('Processing line notes:', soData.line_notes);
        console.log('Part numbers for line notes:', soData.part_number);
        
        setTimeout(() => {
          displayLineNotesFromPO(soData.line_notes, soData.part_number);
        }, 200);
      } else {
        console.log('No line notes found in SO data');
      }
      */
      
      // Process acknowledgments from field <49> and display them
      console.log('=== ACKNOWLEDGMENT PROCESSING IN fillFormWithSOData ===');
      console.log('DEBUG: Checking acknowledgments in soData:', soData.acknowledgments);
      console.log('soData.acknowledgments type:', typeof soData.acknowledgments);
      console.log('soData.acknowledgments truthy:', !!soData.acknowledgments);
      
      if (soData.acknowledgments) {
        console.log('‚úÖ FOUND ACKNOWLEDGMENTS - Processing:', soData.acknowledgments);
        useGlobalAcknowledmentData(soData);
      } else {
        console.log('‚ùå No acknowledgments found in soData');
      }
      
      // DISABLED: Global needs processing - causes data contamination
      // Individual line item needs are handled by selectLineItemForTracking()
      if (soData.needs) {
        console.log('‚ö†Ô∏è SKIPPED GLOBAL NEEDS - Processing deferred to line item selection:', soData.needs);
        console.log('üîí Needs will only be populated when user selects specific line items');
      } else {
        console.log('‚ùå No needs found in soData');
      }
      
      // DISABLED: Global schedule processing - causes data contamination  
      // Individual line item schedules are handled by selectLineItemForTracking()
      if (soData.schedule) {
        console.log('‚ö†Ô∏è SKIPPED GLOBAL SCHEDULES - Processing deferred to line item selection:', soData.schedule);
        console.log('üîí Schedules will only be populated when user selects specific line items');
      } else {
        console.log('‚ùå No schedule found in soData');
      }
      
      // Store SO data globally for line item editing
      window.currentSOData = soData;
      
      // OPTIMIZED: Sequential timing for reliable info box population
      setTimeout(() => {
        console.log('üîÑ STEP 1: Updating customer info display...');
        if (typeof updateCustomerInfoDisplay === 'function') {
          updateCustomerInfoDisplay();
          console.log('‚úÖ Updated customer info display after loading SO data');
        }
        
        // Wait for DOM updates, then populate customer info
        setTimeout(() => {
          console.log('üîÑ STEP 2: Populating customer info...');
          if (soData.customer_info && typeof fillCustomerInfo === 'function') {
            console.log('üîÑ Calling fillCustomerInfo with:', soData.customer_info);
            fillCustomerInfo(soData.customer_info);
          }
          
          // Wait for customer info to complete, then ship-to info
          setTimeout(() => {
            console.log('üîÑ STEP 3: Populating ship-to info...');
            if (soData.shipto_info && typeof fillShipToInfo === 'function') {
              console.log('üîÑ Calling fillShipToInfo with:', soData.shipto_info);
              fillShipToInfo(soData.shipto_info);
            }
            
            // Final verification step
            setTimeout(() => {
              console.log('üîÑ STEP 4: Final verification and cleanup...');
              if (typeof ensureInfoBoxesVisible === 'function') {
                ensureInfoBoxesVisible(soData);
              }
            }, 200);
            
          }, 150);
        }, 100);
      }, 50);
      
      // Process hierarchical line items structurea
      console.log('=== HIERARCHICAL LINE ITEMS PROCESSING IN fillFormWithSOData ===');
      console.log('DEBUG: Checking line_items_data in soData:', soData.line_items_data);
      
      if (soData.line_items_data && Array.isArray(soData.line_items_data) && soData.line_items_data.length > 0) {
        console.log('‚úÖ Found hierarchical line items, updating lineItems array');
        
        // Always clear and repopulate to get fresh data from server
        console.log('üîÑ Clearing existing lineItems and repopulating from XML');
        lineItems = [];
        
        soData.line_items_data.forEach((item, index) => {
          const needEntries = Array.isArray(item.needEntries)
            ? item.needEntries.filter(entry => (entry.date && entry.date.trim()) || (entry.qty && entry.qty.trim()))
            : Array.isArray(item.needs)
              ? item.needs.filter(entry => (entry.date && entry.date.trim()) || (entry.qty && entry.qty.trim()))
              : [];

          const ackEntries = Array.isArray(item.ackEntries)
            ? item.ackEntries.filter(entry => (entry.date && entry.date.trim()) || (entry.qty && entry.qty.trim()))
            : Array.isArray(item.acks)
              ? item.acks.filter(entry => (entry.date && entry.date.trim()) || (entry.qty && entry.qty.trim()))
              : [];

          const scheduleEntries = Array.isArray(item.scheduleEntries)
            ? item.scheduleEntries.filter(entry => (entry.date && entry.date.trim()) || (entry.qty && entry.qty.trim()))
            : Array.isArray(item.schedules)
              ? item.schedules.filter(entry => (entry.date && entry.date.trim()) || (entry.qty && entry.qty.trim()))
              : [];

          const firstNeed = needEntries[0] || {};
          const firstAck = ackEntries[0] || {};
          const firstSchedule = scheduleEntries[0] || {};

          console.log(`üîç DEBUG UOM for line ${index + 1}: item.uom="${item.uom}"`);
          console.log(`üîç DEBUG PROD NOTES for line ${index + 1}: item.prodNotes="${item.prodNotes}"`);
          console.log(`üîç DEBUG NEED ENTRIES for line ${index + 1}:`, needEntries);
          console.log(`üîç DEBUG SCHEDULE ENTRIES for line ${index + 1}:`, scheduleEntries);
          
          // Convert needEntries/scheduleEntries arrays back to string format for editLineItem()
          const needDataString = needEntries.map(e => `${e.date}~${e.qty}`).join('\\');
          const schedDataString = scheduleEntries.map(e => `${e.date}~${e.qty}`).join('\\');
          const ackDataString = ackEntries.map(e => `${e.date}~${e.qty}`).join('\\');
          
          console.log(`üîç DEBUG NEED DATA STRING for line ${index + 1}: "${needDataString}"`);
          console.log(`üîç DEBUG SCHED DATA STRING for line ${index + 1}: "${schedDataString}"`);
          
          const lineItem = {
            lineNumber: item.lineNumber || (index + 1),
            partNumber: item.partNumber || '',
            description: item.description || `Line item for part ${item.partNumber}`,
            quantity: item.quantity || firstSchedule.qty || firstNeed.qty || 1,
            unitPrice: item.unitPrice || 0,
            uom: item.uom || 'EA',
            total: (item.unitPrice || 0),
            scheduleDate: item.scheduleDate || firstSchedule.date || '',
            scheduleQty: item.scheduleQty || firstSchedule.qty || '',
            needDate: item.needDate || firstNeed.date || '',
            needQty: item.needQty || firstNeed.qty || '',
            ackDate: item.ackDate || firstAck.date || '',
            ackQty: item.ackQty || firstAck.qty || '',
            lineNotes: item.lineNotes || '',
            prodNotes: item.prodNotes || '',
            needData: needDataString,
            schedData: schedDataString,
            ackData: ackDataString,
            unitPriceIsCents: item.unitPriceIsCents || false,
            totalIsCents: item.totalIsCents || false,
            needEntries,
            ackEntries,
            scheduleEntries
          };
          
          lineItems.push(lineItem);
          console.log(`Added line item ${lineItem.lineNumber}:`, lineItem);
        });
        
        console.log('Final lineItems array:', lineItems);
        
        // Render the line items in the UI
        console.log('=== DEBUG: About to render line items ===');
        console.log('Calling renderLineItems() with lineItems array:', lineItems);
        console.log('renderLineItems function defined?', typeof renderLineItems);
        console.log('lineItems variable defined?', typeof lineItems);
        
        try {
          renderLineItems();
          console.log('=== DEBUG: renderLineItems() completed successfully ===');
          
          // Note: populateTrackingFromLineItems() removed to prevent auto-population
          console.log('üîí Tracking fields will remain empty until user selects specific line item');
          
        } catch (error) {
          console.error('‚ùå ERROR in renderLineItems():', error);
          console.error('Stack trace:', error.stack);
        }
        
        // DISABLED: Line notes are now handled individually per line item
        // No need to populate global line notes field
        /*
        const combinedNotes = lineItems
          .filter(item => item.lineNotes)
          .map(item => `${item.partNumber}: ${item.lineNotes}`)
          .join('\n');
          
        const lineNotesField = document.getElementById('lineNotes');
        if (lineNotesField && combinedNotes) {
          lineNotesField.value = combinedNotes;
          console.log('‚úÖ Populated combined line notes field');
        }
        */
        
        console.log('‚úÖ Hierarchical line items processing completed');
      } else {
        console.log('‚ùå No hierarchical line items found, checking legacy structure...');
        
        // Fallback to legacy processing
        if (soData.schedule && soData.schedule.schedule_line) {
          populateScheduleFields(soData.schedule.schedule_line);
          console.log('‚úÖ Legacy schedule processing completed');
        }
      }
      
      // Note: Tracking information fields are now populated only when user clicks on specific line items
      // This prevents needQty=1 and scheduleQty=100 from appearing automatically during SO search
      console.log('üîí Tracking fields will remain empty until user selects specific line item');

      populateAllTrackingData(soData);
    }

    function populateAllTrackingData(soData) {
      populateAllTrackingDataDebug(soData);
    }

    function populateAllTrackingDataDebug(soData) {
      console.log('=== DEBUGGING TRACKING DATA POPULATION ===');
      console.log('Full soData object:', soData);
      console.log('soData.globalNeeds:', soData.globalNeeds);
      console.log('soData.globalAcks:', soData.globalAcks);
      console.log('soData.globalSchedules:', soData.globalSchedules);

      // PRESERVE USER INPUT: Save existing values before overwriting
      const preservedValues = {};
      for (let i = 1; i <= 5; i++) {
        const needDate = document.getElementById(`needDate${i}`);
        const needQty = document.getElementById(`needQty${i}`);
        const ackDate = document.getElementById(`ackDate${i}`);
        const ackQty = document.getElementById(`ackQty${i}`);
        const scheduleDate = document.getElementById(`lineScheduleDate${i}`);
        const scheduleQty = document.getElementById(`lineScheduleQty${i}`);

        // Save existing values if they contain user input
        preservedValues[i] = {
          needDate: needDate?.value || '',
          needQty: needQty?.value || '',
          ackDate: ackDate?.value || '',
          ackQty: ackQty?.value || '',
          scheduleDate: scheduleDate?.value || '',
          scheduleQty: scheduleQty?.value || ''
        };

        console.log(`Row ${i} preserved values:`, preservedValues[i]);

        // Only clear if field is empty (avoid overwriting user input)
        if (needDate && !needDate.value) needDate.value = '';
        if (needQty && !needQty.value) needQty.value = '';
        if (ackDate && !ackDate.value) ackDate.value = '';
        if (ackQty && !ackQty.value) ackQty.value = '';
        if (scheduleDate && !scheduleDate.value) scheduleDate.value = '';
        if (scheduleQty && !scheduleQty.value) scheduleQty.value = '';
      }

      console.log('=== PROCESSING NEED INFO ===');
      console.log('üö´ GLOBAL NEEDS PROCESSING COMPLETELY DISABLED');
      console.log('üîí Needs will ONLY be populated when user selects specific line items');
      console.log('‚ö†Ô∏è This prevents cross-line contamination during SO load');
      
      // DISABLED: Global needs processing causes cross-line contamination
      // All needs processing now happens in selectLineItemForTracking() with proper line_position filtering
      /*
      if (soData.globalNeeds && Array.isArray(soData.globalNeeds)) {
        console.log(`Found ${soData.globalNeeds.length} need entries`);
        soData.globalNeeds.forEach((needEntry, index) => {
          console.log(`Processing need entry ${index}:`, needEntry);

          if (index < 5) {
            const needDateField = document.getElementById(`needDate${index + 1}`);
            const needQtyField = document.getElementById(`needQty${index + 1}`);

            console.log(`Fields for row ${index + 1}:`, {
              dateField: needDateField ? 'EXISTS' : 'MISSING',
              qtyField: needQtyField ? 'EXISTS' : 'MISSING',
              needDate: needEntry.needDate,
              needQty: needEntry.needQty
            });

            // Only populate if field is empty (preserve user input)
            if (needDateField && needEntry.needDate && needEntry.needDate.trim() && !needDateField.value) {
              needDateField.value = needEntry.needDate;
            }

            if (needQtyField && needEntry.needQty && needEntry.needQty.trim() && !needQtyField.value) {
              needQtyField.value = needEntry.needQty;
            }
          }
        });
      } else {
        console.log('‚ùå No globalNeeds array found or not an array');
      }
      */

      console.log('=== PROCESSING ACKNOWLEDGMENTS ===');
      if (soData.globalAcks && Array.isArray(soData.globalAcks)) {
        console.log(`Found ${soData.globalAcks.length} ack entries`);
        soData.globalAcks.forEach((ackEntry, index) => {
          console.log(`Processing ack entry ${index}:`, ackEntry);

          if (index < 5) {
            const ackDateField = document.getElementById(`ackDate${index + 1}`);
            const ackQtyField = document.getElementById(`ackQty${index + 1}`);

            console.log(`Fields for row ${index + 1}:`, {
              dateField: ackDateField ? 'EXISTS' : 'MISSING',
              qtyField: ackQtyField ? 'EXISTS' : 'MISSING',
              ackDate: ackEntry.ackDate,
              ackQty: ackEntry.ackQty
            });

            // Only populate if field is empty (preserve user input)
            if (ackDateField && ackEntry.ackDate && ackEntry.ackDate.trim() && !ackDateField.value) {
              ackDateField.value = ackEntry.ackDate;
            }

            if (ackQtyField && ackEntry.ackQty && ackEntry.ackQty.trim() && !ackQtyField.value) {
              ackQtyField.value = ackEntry.ackQty;
            }
          }
        });
      } else {
        console.log('‚ùå No globalAcks array found or not an array');
      }

      console.log('=== PROCESSING SCHEDULES ===');
      if (soData.globalSchedules && Array.isArray(soData.globalSchedules)) {
        console.log(`Found ${soData.globalSchedules.length} schedule entries`);
        soData.globalSchedules.forEach((schedEntry, index) => {
          console.log(`Processing schedule entry ${index}:`, schedEntry);

          if (index < 5) {
            const scheduleDateField = document.getElementById(`lineScheduleDate${index + 1}`);
            const scheduleQtyField = document.getElementById(`lineScheduleQty${index + 1}`);

            console.log(`Fields for row ${index + 1}:`, {
              dateField: scheduleDateField ? 'EXISTS' : 'MISSING',
              qtyField: scheduleQtyField ? 'EXISTS' : 'MISSING',
              scheduleDate: schedEntry.scheduleDate,
              scheduleQty: schedEntry.scheduleQty
            });

            // Only populate if field is empty (preserve user input)
            if (scheduleDateField && schedEntry.scheduleDate && schedEntry.scheduleDate.trim() && !scheduleDateField.value) {
              scheduleDateField.value = schedEntry.scheduleDate;
            }

            if (scheduleQtyField && schedEntry.scheduleQty && schedEntry.scheduleQty.trim() && !scheduleQtyField.value) {
              scheduleQtyField.value = schedEntry.scheduleQty;
            }
          }
        });
      } else {
        console.log('‚ùå No globalSchedules array found or not an array');
      }

      console.log('=== FINAL FIELD VERIFICATION ===');
      for (let i = 1; i <= 5; i++) {
        const needDate = document.getElementById(`needDate${i}`);
        const needQty = document.getElementById(`needQty${i}`);
        const ackDate = document.getElementById(`ackDate${i}`);
        const ackQty = document.getElementById(`ackQty${i}`);
        const scheduleDate = document.getElementById(`lineScheduleDate${i}`);
        const scheduleQty = document.getElementById(`lineScheduleQty${i}`);

        console.log(`Row ${i} final values:`, {
          needDate: needDate ? needDate.value : 'FIELD_MISSING',
          needQty: needQty ? needQty.value : 'FIELD_MISSING',
          ackDate: ackDate ? ackDate.value : 'FIELD_MISSING',
          ackQty: ackQty ? ackQty.value : 'FIELD_MISSING',
          scheduleDate: scheduleDate ? scheduleDate.value : 'FIELD_MISSING',
          scheduleQty: scheduleQty ? scheduleQty.value : 'FIELD_MISSING'
        });
      }

      console.log('=== TRACKING DATA POPULATION COMPLETE ===');
    }

    function debugExtractGlobalTracking(soElement) {
      console.log('=== DEBUGGING GLOBAL TRACKING EXTRACTION ===');

      const needsSection = soElement.querySelector('all_needs_entries');
      console.log('all_needs_entries section:', needsSection);
      if (needsSection) {
        const needEntries = Array.from(needsSection.querySelectorAll('entry'));
        console.log(`Found ${needEntries.length} need entries:`);
        needEntries.forEach((entry, i) => {
          const needDate = entry.querySelector('need_date')?.textContent || '';
          const needQty = entry.querySelector('need_qty')?.textContent || '';
          console.log(`  Need ${i}: date="${needDate}", qty="${needQty}"`);
        });
      }

      const acksSection = soElement.querySelector('all_ack_entries');
      console.log('all_ack_entries section:', acksSection);
      if (acksSection) {
        const ackEntries = Array.from(acksSection.querySelectorAll('entry'));
        console.log(`Found ${ackEntries.length} ack entries:`);
        ackEntries.forEach((entry, i) => {
          const ackDate = entry.querySelector('ack_date')?.textContent || '';
          const ackQty = entry.querySelector('ack_qty')?.textContent || '';
          console.log(`  Ack ${i}: date="${ackDate}", qty="${ackQty}"`);
        });
      }

      const schedulesSection = soElement.querySelector('all_schedule_entries');
      console.log('all_schedule_entries section:', schedulesSection);
      if (schedulesSection) {
        const scheduleEntries = Array.from(schedulesSection.querySelectorAll('entry'));
        console.log(`Found ${scheduleEntries.length} schedule entries:`);
        scheduleEntries.forEach((entry, i) => {
          const scheduleDate = entry.querySelector('schedule_date')?.textContent || '';
          const scheduleQty = entry.querySelector('schedule_qty')?.textContent || '';
          console.log(`  Schedule ${i}: date="${scheduleDate}", qty="${scheduleQty}"`);
        });
      }
    }

    // DISABLED: Test function that was overriding user input with hardcoded values
    /*
    function testManualPopulation() {
      console.log('=== MANUAL TEST POPULATION ===');

      const testNeeds = [
        { needDate: '2025-09-20', needQty: '200' },
        { needDate: '2025-09-27', needQty: '50' },
        { needDate: '2025-09-27', needQty: '50' },
        { needDate: '2025-09-12', needQty: '40' }
      ];

      const testAcks = [
        { ackDate: '2025-09-18', ackQty: '33' },
        { ackDate: '2025-09-18', ackQty: '72' },
        { ackDate: '2025-09-18', ackQty: '72' },
        { ackDate: '2025-09-12', ackQty: '40' }
      ];

      const testSchedules = [
        { scheduleDate: '2025-09-11', scheduleQty: '30' },
        { scheduleDate: '2025-09-19', scheduleQty: '99' },
        { scheduleDate: '2025-09-19', scheduleQty: '99' },
        { scheduleDate: '2025-09-12', scheduleQty: '40' }
      ];

      testNeeds.forEach((entry, index) => {
        const needDate = document.getElementById(`needDate${index + 1}`);
        const needQty = document.getElementById(`needQty${index + 1}`);

        if (needDate) {
          needDate.value = entry.needDate;
          console.log(`Manual set needDate${index + 1} = ${entry.needDate}`);
        }
        if (needQty) {
          needQty.value = entry.needQty;
          console.log(`Manual set needQty${index + 1} = ${entry.needQty}`);
        }
      });

      testAcks.forEach((entry, index) => {
        const ackDate = document.getElementById(`ackDate${index + 1}`);
        const ackQty = document.getElementById(`ackQty${index + 1}`);

        if (ackDate) {
          ackDate.value = entry.ackDate;
          console.log(`Manual set ackDate${index + 1} = ${entry.ackDate}`);
        }
        if (ackQty) {
          ackQty.value = entry.ackQty;
          console.log(`Manual set ackQty${index + 1} = ${entry.ackQty}`);
        }
      });

      testSchedules.forEach((entry, index) => {
        const scheduleDate = document.getElementById(`lineScheduleDate${index + 1}`);
        const scheduleQty = document.getElementById(`lineScheduleQty${index + 1}`);

        if (scheduleDate) {
          scheduleDate.value = entry.scheduleDate;
          console.log(`Manual set lineScheduleDate${index + 1} = ${entry.scheduleDate}`);
        }
        if (scheduleQty) {
          scheduleQty.value = entry.scheduleQty;
          console.log(`Manual set lineScheduleQty${index + 1} = ${entry.scheduleQty}`);
        }
      });
    }
    */
    
    function fillCustomerInfo(customerInfo) {
      const customerSection = document.getElementById('customerInfoSection');
      if (!customerSection) return; // Section may not exist in UI
      
      if (customerInfo && (customerInfo.name || customerInfo.address1 || customerInfo.contact)) {
        // Show customer section if we have customer data
        customerSection.style.display = 'block';
        
        // Fill customer number - DEBUG
        console.log('DEBUG fillCustomerInfo: customerInfo object:', customerInfo);
        console.log('DEBUG fillCustomerInfo: customerInfo.number:', customerInfo.number);
        const customerNumberEl = document.getElementById('customerNumber');
        if (customerNumberEl) {
          const customerNumber = customerInfo.number || '-';
          console.log('DEBUG fillCustomerInfo: Setting customer number to:', customerNumber);
          customerNumberEl.textContent = customerNumber;
        }
        
        // Fill customer details with null checks
        const customerNameEl = document.getElementById('customerName');
        if (customerNameEl) customerNameEl.textContent = customerInfo.name || '-';
        
        // Combine address fields
        let address = '';
        if (customerInfo.address1) address += customerInfo.address1;
        if (customerInfo.address2) address += (address ? ', ' : '') + customerInfo.address2;
        const customerAddressEl = document.getElementById('customerAddress');
        if (customerAddressEl) customerAddressEl.textContent = address || '-';
        
        // Update city field directly
        const customerCityEl = document.getElementById('customerCity');
        
        // Fill Bill To info (comes from backend automatically)
        const billToCodeEl = document.getElementById('billToCode');
        const billToNameEl = document.getElementById('billToName');
        if (billToCodeEl) billToCodeEl.textContent = customerInfo.bill_to_code || '-';
        if (billToNameEl) billToNameEl.textContent = customerInfo.bill_to_name || '-';
        if (customerCityEl) customerCityEl.textContent = customerInfo.city || '-';
        
        const customerContactEl = document.getElementById('customerContact');
        if (customerContactEl) customerContactEl.textContent = customerInfo.contact || '-';
        const customerEmailEl = document.getElementById('customerEmail');
        if (customerEmailEl) customerEmailEl.textContent = customerInfo.email || '-';
        const customerPhoneEl = document.getElementById('customerPhone');
        if (customerPhoneEl) customerPhoneEl.textContent = customerInfo.phone || '-';
      } else {
        // Hide customer section if no data
        customerSection.style.display = 'none';
      }
    }
    

    function fillShipToInfo(shiptoInfo) {
      try {
        const shiptoSection = document.getElementById('shipToInfoSection');
        if (!shiptoSection) return; // Bill To panel removed
        
        console.log('üîç DEBUG fillShipToInfo - bill_to_code:', window.currentSOData?.customer_info?.bill_to_code);
        console.log('üîç DEBUG fillShipToInfo - bill_to_name:', window.currentSOData?.customer_info?.bill_to_name);
        
        // === Bill To Info - Show Bill To from customer_info ===
        const customerInfo = window.currentSOData?.customer_info || {};
        
        // Use Bill To data from customer_info
        let parsedShipto = {
          number: customerInfo.bill_to_code || '-',
          name: customerInfo.bill_to_name || '-',
          address: '',
          city: '',
          state: '',
          zip: ''
        };
        
        // Bill To info is simple - just code and name from backend
        console.log('‚úÖ Bill To data:', parsedShipto);

        // Show Bill To section if we have data
        if (parsedShipto.number && parsedShipto.number !== '-') {
          shiptoSection.style.display = 'block';
          
          // N√∫mero de Bill To
          const numberElement = document.getElementById('shiptoNumber') || document.getElementById('shipToNumber');
          if (numberElement) {
            numberElement.textContent = parsedShipto.number;
            console.log('‚úÖ Set billto number:', parsedShipto.number);
          }
          
          // Nombre de Bill To
          const nameElement = document.getElementById('shipToName') || document.getElementById('shiptoName');
          if (nameElement) {
            nameElement.textContent = parsedShipto.name || '-';
            console.log('‚úÖ Set billto name:', parsedShipto.name || '-');
          }
          
          // Direcci√≥n (hide as we don't have Bill To address)
          const addressElement = document.getElementById('shipToAddress') || document.getElementById('shiptoAddress1');
          if (addressElement) {
            addressElement.textContent = '-';
          }
          
          // Ciudad (hide as we don't have Bill To city)
          const cityElement = document.getElementById('shiptoCity') || document.getElementById('shipToCity');
          if (cityElement) {
            cityElement.textContent = '-';
          }
        } else {
          shiptoSection.style.display = 'none';
        }
        
        // Estado
        const stateElement = document.getElementById('shiptoState');
        if (stateElement) {
          stateElement.textContent = parsedShipto.state || '-';
          console.log('‚úÖ Set shipto state:', parsedShipto.state || '-');
        }
        
        // ZIP
        const zipElement = document.getElementById('shiptoZip');
        if (zipElement) {
          zipElement.textContent = parsedShipto.zip || '-';
          console.log('‚úÖ Set shipto zip:', parsedShipto.zip || '-');
        }
        
        // Siempre mostrar el bloque de Ship To
        shiptoSection.style.display = 'block';
        
        console.log('‚úÖ Ship To info populated (always visible):', {
          number: parsedShipto.number,
          name: parsedShipto.name || '-',
          address: parsedShipto.address || parsedShipto.city || '-',
          city: shipto.city || '-',
          state: shipto.state || '-',
          zip: shipto.zip || '-'
        });
        
      } catch (e) {
        console.error('‚ùå Error cargando datos de Ship To:', e);
        // A√∫n as√≠ mostrar el bloque con guiones
        const shiptoSection = document.getElementById('shipToInfoSection');
        if (shiptoSection) shiptoSection.style.display = 'block';
      }
    }

    // Store customers and shipvias data for quick access
    let customersData = [];
    let shipviasData = [];

    function loadCustomers() {
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', 'GET_VENDORS.XML', true);
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4 && xhr.status === 200) {
            try {
              const parser = new DOMParser();
              const xmlDoc = parser.parseFromString(xhr.responseText, 'text/xml');
              const customers = xmlDoc.getElementsByTagName('customer');
              
              customersData = [];
              const customerSelect = document.getElementById('customerSelect');
              
              // Clear existing options except the first one
              if (customerSelect) {
                while (customerSelect.children.length > 1) {
                  customerSelect.removeChild(customerSelect.lastChild);
                }
              }
              
              for (let i = 0; i < customers.length; i++) {
                const customer = customers[i];
                const customerData = {
                  number: customer.getElementsByTagName('customer_number')[0]?.textContent || '',
                  name: customer.getElementsByTagName('customer_name')[0]?.textContent || '',
                  address: customer.getElementsByTagName('customer_address')[0]?.textContent || '',
                  city: customer.getElementsByTagName('customer_city')[0]?.textContent || ''
                };
                customersData.push(customerData);
                
                // Add option to dropdown
                if (customerSelect && customerData.number) {
                  const option = document.createElement('option');
                  option.value = customerData.number;
                  option.textContent = `${customerData.number} - ${customerData.name}`;
                  customerSelect.appendChild(option);
                }
              }
              
              console.log('Loaded customers:', customersData.length);
              resolve(customersData);
            } catch (e) {
              console.error('Error parsing customers XML:', e);
              reject(e);
            }
          } else if (xhr.readyState === 4) {
            console.error('Failed to load customers. Status:', xhr.status);
            reject(new Error('Failed to load customers'));
          }
        };
        xhr.send();
      });
    }

    function loadShipVias() {
      console.log('üöö Loading Ship Vias from GET_SHIPVIAS.XML...');
      return new Promise((resolve, reject) => {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', 'GET_SHIPVIAS.XML', true);
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4 && xhr.status === 200) {
            try {
              console.log('‚úÖ GET_SHIPVIAS.XML response received');
              console.log('Raw XML (full):', xhr.responseText);
              console.log('Raw XML (first 500):', xhr.responseText.substring(0, 500));
              
              const parser = new DOMParser();
              const xmlDoc = parser.parseFromString(xhr.responseText, 'text/xml');
              const shipviaElements = xmlDoc.getElementsByTagName('shipvia');
              
              console.log('Found shipvia elements:', shipviaElements.length);
              
              shipviasData = [];
              
              for (let i = 0; i < shipviaElements.length; i++) {
                const shipvia = shipviaElements[i];
                const shipviaCode = getXMLValue(shipvia, 'shipvia_code');
                const shipviaName = getXMLValue(shipvia, 'shipvia_name');
                const shipviaDescription = getXMLValue(shipvia, 'shipvia_description');
                
                console.log(`Ship Via ${i+1}:`, { code: shipviaCode, name: shipviaName, desc: shipviaDescription });
                
                if (shipviaCode && shipviaName) {
                  shipviasData.push({
                    code: shipviaCode,
                    name: shipviaName,
                    description: shipviaDescription
                  });
                }
              }
              
              console.log('‚úÖ Loaded ship vias:', shipviasData.length, shipviasData);
              
              // Populate dropdown immediately
              populateShipViaDropdown();
              
              resolve(shipviasData);
            } catch (e) {
              console.error('‚ùå Error parsing ship vias XML:', e);
              reject(e);
            }
          } else if (xhr.readyState === 4) {
            console.error('‚ùå Failed to load ship vias. Status:', xhr.status);
            reject(new Error('Failed to load ship vias'));
          }
        };
        xhr.send();
      });
    }

    
    // Date conversion functions
    function convertJulianToDate(julianDay) {
      if (!julianDay || julianDay === '0' || julianDay === '1') return '';
      
      // Check if already in YYYY-MM-DD format
      if (julianDay.includes('-') && julianDay.length === 10) {
        return julianDay;
      }
      
      // Skip invalid or placeholder Julian dates
      const julianNum = parseInt(julianDay);
      if (isNaN(julianNum) || julianNum <= 1 || julianNum > 50000) {
        console.log(`‚ö†Ô∏è Skipping invalid Julian date: ${julianDay}`);
        return '';
      }
      
      // Convert Julian day to JavaScript Date using UTC to avoid timezone issues
      // Pick systems use January 1, 1968 as day 1
      const baseDate = new Date(Date.UTC(1968, 0, 1)); // 1968-01-01 = d√≠a 1
      const targetDate = new Date(baseDate.getTime() + (julianNum - 1) * 24 * 60 * 60 * 1000);
      
      const year = targetDate.getUTCFullYear();
      const month = String(targetDate.getUTCMonth() + 1).padStart(2, '0');
      const day = String(targetDate.getUTCDate()).padStart(2, '0');
      
      return `${year}-${month}-${day}`;
    }

    function convertDateToJulian(dateStr) {
      console.log(`üîÑ convertDateToJulian called with: "${dateStr}" (type: ${typeof dateStr})`);
      
      if (!dateStr) {
        console.log(`üîÑ convertDateToJulian: Empty input, returning empty string`);
        return '';
      }
      
      // If already in Julian format (numeric), return as is
      if (/^\d+$/.test(dateStr.toString())) {
        console.log(`üîÑ convertDateToJulian: Already Julian format: ${dateStr}`);
        return dateStr.toString();
      }

      // If in YYYY-MM-DD format, convert to Julian using UTC to avoid timezone issues
      if (dateStr.includes('-') && dateStr.length === 10) {
        const [year, month, day] = dateStr.split('-');
        const inputDate = new Date(Date.UTC(parseInt(year), parseInt(month) - 1, parseInt(day)));
        const baseDate = new Date(Date.UTC(1968, 0, 1)); // 1968-01-01 = d√≠a 1
        const diffTime = inputDate.getTime() - baseDate.getTime();
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 porque 1968-01-01 = d√≠a 1
        
        console.log(`üîÑ Date conversion: ${dateStr} ‚Üí Julian: ${diffDays} (UTC)`);
        return diffDays.toString();
      }

      console.warn(`‚ö†Ô∏è convertDateToJulian: Unknown format, returning as-is: "${dateStr}"`);
      return dateStr; // Return as is if unknown format
    }

    function normalizeAckDateValue(rawDate) {
      if (!rawDate && rawDate !== 0) return '';

      let cleaned = String(rawDate).trim();
      if (!cleaned) return '';

      if (cleaned.includes(' ')) {
        cleaned = cleaned.split(' ')[0];
      }
      if (cleaned.includes('*')) {
        cleaned = cleaned.split('*')[0];
      }

      if (/^\d{4}-\d{2}-\d{2}$/.test(cleaned)) {
        return cleaned;
      }

      if (/^\d{8}$/.test(cleaned)) {
        return `${cleaned.slice(0, 4)}-${cleaned.slice(4, 6)}-${cleaned.slice(6, 8)}`;
      }

      if (/^\d{4,5}$/.test(cleaned)) {
        const julianConverted = convertJulianToDate(cleaned);
        if (julianConverted) {
          return julianConverted;
        }
      }

      const parsedDate = new Date(cleaned);
      if (!isNaN(parsedDate.getTime())) {
        return parsedDate.toISOString().split('T')[0];
      }

      return '';
    }

    function extractAckDateAndQuantity(rawValue) {
      const result = { date: '', qty: '' };
      if (rawValue === undefined || rawValue === null) {
        return result;
      }

      const stringValue = String(rawValue).trim();
      if (!stringValue) {
        return result;
      }

      let working = stringValue;

      if (working.includes('*')) {
        const parts = working.split('*');
        result.date = normalizeAckDateValue(parts[0]);
        result.qty = (parts[1] || '').replace(/[^0-9.]/g, '');
        return result;
      }

      const isoMatch = working.match(/\d{4}-\d{2}-\d{2}/);
      if (isoMatch) {
        result.date = normalizeAckDateValue(isoMatch[0]);
        working = working.replace(isoMatch[0], ' ');
      } else {
        const yyyymmddMatch = working.match(/\b\d{8}\b/);
        if (yyyymmddMatch) {
          result.date = normalizeAckDateValue(yyyymmddMatch[0]);
          working = working.replace(yyyymmddMatch[0], ' ');
        } else {
          const julianMatch = working.match(/\b\d{4,5}\b/);
          if (julianMatch) {
            result.date = normalizeAckDateValue(julianMatch[0]);
            working = working.replace(julianMatch[0], ' ');
          }
        }
      }

      const numericPieces = working.match(/\d+(?:\.\d+)?/g);
      if (numericPieces && numericPieces.length > 0) {
        result.qty = numericPieces[numericPieces.length - 1];
      }

      if (!result.qty) {
        result.qty = working.replace(/[^0-9.]/g, '');
      }

      return result;
    }

    function fillCustomerInfo(soData) {
      if (soData.customer_info) {
        document.getElementById('customerName').textContent =
          soData.customer_info.name || '-';
        document.getElementById('customerAddress').textContent =
          soData.customer_info.address1 || '-';
        document.getElementById('customerCity').textContent =
          soData.customer_info.city || '-';
        document.getElementById('customerInfoSection').style.display = 'block';
      } else {
        document.getElementById('customerInfoSection').style.display = 'none';
      }
    }
    
    function loadSOData(soData) {
      // Load customer info
      fillCustomerInfo(soData);

  // === Ship To Info ===
  if (soData.shipto_info) {
    document.getElementById('shipToNumber').textContent =
      soData.shipto_info.number || '-';

    // ‚úÖ Nombre (prioriza shipto_name)
    document.getElementById('shipToName').textContent =
      soData.shipto_info.name || '-';

    // ‚úÖ Direcci√≥n (prioriza shipto_address1)
    document.getElementById('shipToAddress').textContent =
      cleanPickText(soData.shipto_info.address1) || '-';

    // ‚úÖ Ciudad
    document.getElementById('shipToCity').textContent =
      soData.shipto_info.city || '-';

    document.getElementById('shipToInfoSection').style.display = 'block';
  } else {
    document.getElementById('shipToInfoSection').style.display = 'none';
  }


  // The following data population logic should be part of loadSOData
  // Keep the function open until after all uses of soData below.
      
      // Convert and fill PO date
    // Convert and fill PO date
      if (typeof soData !== 'undefined' && soData?.po_date) {
        const poDateField = document.getElementById('soDateInput');
        if (poDateField) {
          const formattedDate = convertJulianToDate(soData.po_date);
          poDateField.value = formattedDate;
        }
      }
      
      // Fill SO Number from search input
      const searchInput = document.getElementById('soSearchInput');
      if (searchInput && searchInput.value) {
        const soNumberField = document.getElementById('soNumberInput');
        if (soNumberField) {
          soNumberField.value = searchInput.value;
          console.log('Set PO number:', searchInput.value);
        }
      }
      
      
      // Fill customer information - try different field names from XML
      const customerCode = soData.customer_code || soData.customer_number || '';
      if (customerCode) {
        const customerField = document.getElementById('displayCustomerCode');
        if (customerField) {
          customerField.value = customerCode;
          console.log('Set display customer code:', customerCode);
        }
        // Also fill the Data Capture form
        const customerSelect = document.getElementById('customerSelect');
        if (customerSelect) {
          // First ensure customers are loaded, then set value
          if (customersData.length === 0) {
            loadCustomers().then(() => {
              customerSelect.value = customerCode;
              onCustomerChange(); // Trigger customer info display
              console.log('Set customer select after loading:', customerCode);
            });
          } else {
            customerSelect.value = customerCode;
            onCustomerChange(); // Trigger customer info display
            console.log('Set customer select:', customerCode);
          }
        }
        const displayCustomerField = document.getElementById('displayCustomerCode');
        if (displayCustomerField) {
          displayCustomerField.value = customerCode;
          console.log('Set display customer code:', customerCode);
        }
      }
      
      if (soData.customer_name) {
        const customerNameField = document.getElementById('displayCustomerName');
        if (customerNameField) {
          customerNameField.textContent = soData.customer_name;
          console.log('Set customer name:', soData.customer_name);
        }
      }
      
      // Fill ship to information - prefer explicit shipto_info number
      const shipToCode = (soData?.shipto_info && (soData.shipto_info.number || soData.shipto_info.shipto_number))
        || soData?.ship_to_code
        || soData?.ship_to
        || '';
      if (shipToCode) {
        const shipToField = document.getElementById('displayShipToCode');
        if (shipToField) {
          shipToField.value = shipToCode;
          console.log('Set ship to code:', shipToCode);
        }
      }
      
      // Show Ship To green box if we have ship to data
      console.log('Checking ship to data for green box:', {
        ship_to: soData.ship_to,
        shipto_info: soData.shipto_info
      });
      
      // Ship To info is now handled by fillShipToInfo() function with intelligent parsing
      
      // Fill PO number
      if (soData.so_number) {
        const soNumberField = document.getElementById('displaySONumber');
        if (soNumberField) {
          soNumberField.textContent = soData.so_number;
          console.log('Set PO number:', soData.so_number);
        }
        // Also fill the Data Capture form
        const soNumberInput = document.getElementById('soNumberInput');
        if (soNumberInput) {
          soNumberInput.value = soData.so_number;
          console.log('Set PO number input:', soData.so_number);
        }
      }
      
      // Handle SO status (both when present and when empty)
      const soStatus = soData.so_status || '';
      const statusField = document.getElementById('displaySOStatus');
      const statusSelect = document.getElementById('soStatusInput');
      
      if (statusField) {
        statusField.textContent = soStatus;
        console.log('Set PO status:', soStatus);
      }
      
      if (statusSelect) {
        if (soStatus) {
          // Check if the status option exists, if not add it  
          const existingOption = Array.from(statusSelect.options).find(opt => opt.value === soStatus);
          if (!existingOption) {
            const newOption = document.createElement('option');
            newOption.value = soStatus;
            newOption.textContent = soStatus;
            statusSelect.appendChild(newOption);
          }
          statusSelect.value = soStatus;
          statusSelect.setAttribute('required', '');
          statusSelect.style.border = '';
          statusSelect.style.backgroundColor = '';
          console.log('Set PO status input:', soStatus);
        } else {
          // Handle empty status to prevent validation errors
          console.log('No PO status found in loadSOData, removing required attribute');
          statusSelect.removeAttribute('required');
          statusSelect.style.border = '1px solid #fbbf24';
          statusSelect.style.backgroundColor = '#fefce8';
          statusSelect.value = '';
        }
      }
      
      // Fill line item information
      if (soData.part_number) {
        const partField = document.getElementById('linePartNumber');
        if (partField) {
          partField.value = soData.part_number;
          console.log('Set part number:', soData.part_number);
        }
      }
      
      if (soData.unit_price) {
        const priceField = document.getElementById('lineUnitPrice');
        if (priceField) {
          priceField.value = parseFloat(soData.unit_price).toFixed(2);
          console.log('Set unit price:', soData.unit_price);
        }
      }
      
      // Process notes from field <40> and header_notes from field <25>
      console.log('Processing notes - soData.notes:', soData.notes);
      console.log('Processing notes - soData.header_notes:', soData.header_notes);
      let combinedNotes = '';
      if (soData.notes) {
        combinedNotes += soData.notes;
        console.log('Added notes from field <40>:', soData.notes);
      }
      if (soData.header_notes && Array.isArray(soData.header_notes) && soData.header_notes.length > 0) {
        if (combinedNotes) combinedNotes += '\n\n--- Header Notes ---\n';
        combinedNotes += soData.header_notes.join('\n');
        console.log('Added header_notes from field <25>:', soData.header_notes);
      }
      console.log('Final combined notes:', combinedNotes);
      const notesInput = document.getElementById('notesInput');
      if (notesInput) {
        notesInput.value = combinedNotes;
        console.log('Set notes textarea:', combinedNotes);
      }
      
    }

    let customerSearchTimeout;

    function handleCustomerKeyDown(event) {
      console.log('üîë handleCustomerKeyDown called - Key:', event.key);
      if (event.key === 'Enter') {
        console.log('‚úÖ ENTER key detected in handleCustomerKeyDown');
        event.preventDefault();
        searchCustomers();
      } else if (event.key === 'Escape') {
        hideCustomerSuggestions();
      } else if (event.key === 'ArrowDown' || event.key === 'ArrowUp') {
        // Allow navigation in suggestions if they're visible
        const suggestionsDiv = document.getElementById('customerSuggestions');
        if (suggestionsDiv.style.display !== 'none') {
          // Let default behavior handle navigation
        }
      }
    }

    function searchCustomers() {
      console.log('üîç searchCustomers() called');
      const input = document.getElementById('customerCodeInput');
      const query = input.value.trim();
      console.log('üîç Customer query:', query, '(length:', query.length, ')');
      
      if (query.length < 2) {
        console.log('‚ö†Ô∏è Query too short, hiding suggestions');
        hideCustomerSuggestions();
        return;
      }
      
      clearTimeout(customerSearchTimeout);
      customerSearchTimeout = setTimeout(() => {
        console.log('‚úÖ Calling searchCustomersByQuery with:', query);
        searchCustomersByQuery(query);
      }, 50);
    }

    function searchCustomersByQuery(query) {
      console.log('üì° searchCustomersByQuery() - Fetching customers for:', query);
      const xhr = new XMLHttpRequest();
      const url = `GET_CUSTOMERS.XML?SEARCH=${encodeURIComponent(query)}`;
      console.log('üì° GET_CUSTOMERS.XML URL:', url);
      xhr.open('GET', url, true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
          console.log('üì• GET_CUSTOMERS.XML response received');
          console.log('üìÑ Response preview:', xhr.responseText.substring(0, 300));
          try {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xhr.responseText, 'text/xml');
            const customers = xmlDoc.getElementsByTagName('customer');
            console.log('‚úÖ Found', customers.length, 'customers');
            
            const suggestions = [];
            for (let i = 0; i < customers.length; i++) {
              const customer = customers[i];
              
              // Extract all possible address fields
              const address1 = customer.getElementsByTagName('customer_address1')[0]?.textContent || '';
              const address2 = customer.getElementsByTagName('customer_address2')[0]?.textContent || '';
              const address = customer.getElementsByTagName('customer_address')[0]?.textContent || '';
              const city = customer.getElementsByTagName('customer_city')[0]?.textContent || '';
              const state = customer.getElementsByTagName('customer_state')[0]?.textContent || '';
              const zip = customer.getElementsByTagName('customer_zip')[0]?.textContent || '';
              
              // Combine street1 and street2, clean special characters
              const street1 = customer.getElementsByTagName('customer_street1')[0]?.textContent || '';
              const street2 = customer.getElementsByTagName('customer_street2')[0]?.textContent || '';
              
              let fullAddress = street1 || address || address1 || '';
              if (street2 && street2.trim() !== '') {
                fullAddress += ', ' + street2;
              } else if (address2 && !street2) {
                fullAddress += ' ' + address2;
              }
              fullAddress = fullAddress.replace(/[\u0000-\u001F\u007F-\u009F]/g, ' ').trim();
              
              const suggestion = {
                code: customer.getElementsByTagName('customer_code')[0]?.textContent || '',
                number: customer.getElementsByTagName('customer_number')[0]?.textContent || '',
                name: customer.getElementsByTagName('customer_name')[0]?.textContent || '',
                street1: customer.getElementsByTagName('customer_street1')[0]?.textContent || '',
                street2: customer.getElementsByTagName('customer_street2')[0]?.textContent || '',
                address: fullAddress,
                address1: address1 || address,
                address2: address2,
                city: city,
                state: state,
                zip: zip,
                bill_to_code: customer.getElementsByTagName('bill_to_code')[0]?.textContent || ''
              };
              suggestions.push(suggestion);
              console.log('  Customer', i+1, ':', suggestion.code, '-', suggestion.name, '| Street1:', suggestion.street1, '| Street2:', suggestion.street2, '| City:', suggestion.city);
            }
            
            console.log('‚úÖ Calling showSuggestions with', suggestions.length, 'items');
            showSuggestions(suggestions);
          } catch (e) {
            console.error('‚ùå Error parsing customer search results:', e);
          }
        } else if (xhr.readyState === 4) {
          console.error('‚ùå GET_CUSTOMERS.XML request failed - Status:', xhr.status);
        }
      };
      xhr.send();
      console.log('üì§ GET_CUSTOMERS.XML request sent');
    }

    // Fetch Bill To full information by customer number
    // WORKAROUND: Use the working autocomplete endpoint instead of direct search
    function fetchBillToInfo(billToCode) {
      if (!billToCode) {
        console.log('‚ùå No Bill To code provided');
        return;
      }
      
      console.log('üîç Fetching Bill To info for:', billToCode);
      
      // Use dedicated GET_BILLTO.XML endpoint
      const xhr = new XMLHttpRequest();
      const url = `GET_BILLTO.XML?CODE=${encodeURIComponent(billToCode)}`;
      console.log('üìû Calling dedicated Bill To endpoint:', url);
      xhr.open('GET', url, true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
          try {
            console.log('üì• Received response, parsing...');
            console.log('üìÑ RAW XML RESPONSE:', xhr.responseText);
            
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xhr.responseText, 'text/xml');
            const customer = xmlDoc.getElementsByTagName('customer')[0];
            
            if (customer) {
              const status = customer.getElementsByTagName('status')[0]?.textContent || '';
              console.log('üì¶ Status:', status);
              
              if (status === 'found') {
                // Extract all possible address fields
                const address1 = customer.getElementsByTagName('customer_address1')[0]?.textContent || '';
                const address2 = customer.getElementsByTagName('customer_address2')[0]?.textContent || '';
                const address = customer.getElementsByTagName('customer_address')[0]?.textContent || '';
                const city = customer.getElementsByTagName('customer_city')[0]?.textContent || '';
                const state = customer.getElementsByTagName('customer_state')[0]?.textContent || '';
                const zip = customer.getElementsByTagName('customer_zip')[0]?.textContent || '';
                
                // Extract street1 and street2
                const street1 = customer.getElementsByTagName('customer_street1')[0]?.textContent || '';
                const street2 = customer.getElementsByTagName('customer_street2')[0]?.textContent || '';
                
                // Combine street1 and street2, clean special characters
                let fullAddress = street1 || address || address1 || '';
                if (street2 && street2.trim() !== '') {
                  fullAddress += ', ' + street2;
                } else if (address2 && !street2) {
                  fullAddress += ' ' + address2;
                }
                fullAddress = fullAddress.replace(/[\u0000-\u001F\u007F-\u009F]/g, ' ').trim();
                
                const billToInfo = {
                  code: customer.getElementsByTagName('customer_code')[0]?.textContent || '',
                  number: customer.getElementsByTagName('customer_number')[0]?.textContent || '',
                  name: customer.getElementsByTagName('customer_name')[0]?.textContent || '',
                  street1: customer.getElementsByTagName('customer_street1')[0]?.textContent || '',
                  street2: customer.getElementsByTagName('customer_street2')[0]?.textContent || '',
                  address: fullAddress,
                  address1: address1 || address,
                  address2: address2,
                  city: city,
                  state: state,
                  zip: zip
                };
                
                console.log('‚úÖ Bill To info retrieved:', billToInfo);
                console.log('   Customer Name:', billToInfo.name, '| Street1:', billToInfo.street1, '| Street2:', billToInfo.street2, '| City:', city);
                updateBillToDisplay(billToInfo);
              } else {
                console.log(`‚ö†Ô∏è Customer ${billToCode} not found in database`);
                updateBillToDisplay({
                  code: billToCode,
                  number: billToCode,
                  name: `Bill To Code: ${billToCode} (Not Found)`,
                  address: '-',
                  city: '-'
                });
              }
            } else {
              console.log('‚ùå Invalid XML response');
            }
          } catch (e) {
            console.error('Error parsing Bill To info:', e);
          }
        }
      };
      xhr.send();
    }

    // Update the yellow Bill To section with full customer info
    function updateBillToDisplay(billToInfo) {
      const shiptoSection = document.getElementById('shipToInfoSection');
      if (!shiptoSection) return;
      
      shiptoSection.style.display = 'block';
      
      // Update all Bill To fields
      const numberElement = document.getElementById('shiptoNumber') || document.getElementById('shipToNumber');
      if (numberElement) {
        numberElement.textContent = billToInfo.number || billToInfo.code || '-';
        console.log('‚úÖ Set Bill To number:', billToInfo.number || billToInfo.code);
      }
      
      const nameElement = document.getElementById('shipToName') || document.getElementById('shiptoName');
      if (nameElement) {
        // Use customer name
        const displayName = billToInfo.name || '-';
        nameElement.textContent = displayName;
        console.log('‚úÖ Set Bill To name:', displayName);
      }
      
      const addressElement = document.getElementById('shipToAddress') || document.getElementById('shiptoAddress1');
      if (addressElement) {
        // Combine street1 and street2 if both exist
        let displayAddress = billToInfo.street1 || billToInfo.address || '-';
        if (billToInfo.street2 && billToInfo.street2.trim() !== '') {
          displayAddress = displayAddress + ', ' + billToInfo.street2;
        }
        addressElement.textContent = displayAddress;
        console.log('‚úÖ Set Bill To address:', displayAddress, '(street1:', billToInfo.street1, ', street2:', billToInfo.street2, ')');
      }
      
      const cityElement = document.getElementById('shiptoCity') || document.getElementById('shipToCity');
      if (cityElement) {
        cityElement.textContent = billToInfo.city || '-';
        console.log('‚úÖ Set Bill To city:', billToInfo.city);
      }
      
      console.log('‚úÖ Bill To display updated successfully');
    }

    function showSuggestions(suggestions) {
      const suggestionsDiv = document.getElementById('customerSuggestions');
      suggestionsDiv.innerHTML = '';
      
      if (suggestions.length === 0) {
        suggestionsDiv.style.display = 'none';
        return;
      }
      
      suggestions.forEach((customer, index) => {
        const item = document.createElement('div');
        item.style.cssText = `
          padding: 6px 10px; 
          cursor: pointer; 
          border-bottom: ${index === suggestions.length - 1 ? 'none' : '1px solid #f3f4f6'};
          transition: all 0.1s ease;
          font-size: 12px;
          line-height: 1.3;
        `;
        item.innerHTML = `
          <div style="display: flex; gap: 6px; align-items: center;">
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 600; color: #1f2937; font-size: 12px;">${customer.number} <span style="font-weight: 400; color: #9ca3af;">¬∑</span> ${customer.name}</div>
              <div style="font-size: 10px; color: #9ca3af; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${customer.address}</div>
            </div>
          </div>
        `;
        
        item.addEventListener('click', () => {
          selectCustomer(customer);
        });
        
        item.addEventListener('mouseenter', () => {
          item.style.backgroundColor = '#f9fafb';
        });
        
        item.addEventListener('mouseleave', () => {
          item.style.backgroundColor = 'white';
        });
        
        suggestionsDiv.appendChild(item);
      });
      
      suggestionsDiv.style.display = 'block';
    }

    function hideSuggestions() {
      const suggestionsDiv = document.getElementById('customerSuggestions');
      if (suggestionsDiv) {
        suggestionsDiv.style.display = 'none'; // Close immediately when selecting
      }
    }

    function selectCustomer(customer) {
      const input = document.getElementById('customerCodeInput');
      // Show customer_number but store customer_code for backend
      input.value = customer.number || customer.code;
      input.setAttribute('data-customer-code', customer.code);
      hideSuggestions();
      
      // AUTO-FILL Bill To from customer.bill_to_code (position 8)
      const billToInput = document.getElementById('shipToCodeInput');
      console.log('üîç DEBUG selectCustomer - customer:', customer);
      console.log('üîç DEBUG selectCustomer - bill_to_code:', customer.bill_to_code);
      
      if (billToInput && customer.bill_to_code) {
        billToInput.value = customer.bill_to_code;
        console.log('‚úÖ Auto-filled Bill To searchbar:', customer.bill_to_code);
        
        // Fetch Bill To full customer information with delay to ensure it overwrites Ship To data
        console.log('üöÄ Calling fetchBillToInfo with:', customer.bill_to_code);
        setTimeout(() => {
          fetchBillToInfo(customer.bill_to_code);
        }, 500); // Delay to let Ship To data load first, then overwrite with Bill To
      } else {
        console.log('‚ùå No bill_to_code found in customer object');
      }
      
      // Update customer info section
      const customerInfoSection = document.getElementById('customerInfoSection');
      if (customerInfoSection) {
        customerInfoSection.style.display = 'block';
        // Show customer_number if it's numeric/code-like, otherwise show customer_code
        const displayNumber = (customer.number && customer.number !== customer.name) ? customer.number : customer.code;
        
        const customerNumberEl = document.getElementById('customerNumber');
        const customerNameEl = document.getElementById('customerName');
        const customerAddressEl = document.getElementById('customerAddress');
        const customerCityEl = document.getElementById('customerCity');
        
        if (customerNumberEl) customerNumberEl.textContent = displayNumber || customer.code || '-';
        if (customerNameEl) customerNameEl.textContent = customer.name || '-';
        
        // Combine street1 and street2 for display
        let displayAddress = customer.street1 || customer.address1 || customer.address || '-';
        if (customer.street2 && customer.street2.trim() !== '') {
          displayAddress = displayAddress + ', ' + customer.street2;
        }
        if (customerAddressEl) customerAddressEl.textContent = displayAddress;
        
        if (customerCityEl) customerCityEl.textContent = customer.city || '-';
        
        console.log('‚úÖ Customer info updated:', {
          number: displayNumber || customer.code,
          name: customer.name,
          street1: customer.street1,
          street2: customer.street2,
          city: customer.city
        });
      }
    }

    // OPTIMIZED FUNCTION: Always display customer info uniformly
    function updateCustomerInfoDisplay() {
      const customerInput = document.getElementById('customerCodeInput');
      const customerCode = customerInput ? customerInput.value.trim() : '';
      const pd = window.currentSOData || {};
      const customerInfoSection = document.getElementById('customerInfoSection');
      
      if (!customerInfoSection) return;
      
      // CRITICAL: Always show customer info if we have ANY customer data OR if currentSOData exists
      const hasCustomerData = customerCode || 
                           (pd.customer_info && (pd.customer_info.name || pd.customer_info.address1 || pd.customer_info.city || pd.customer_info.number)) || 
                           pd.customer_code || 
                           (pd.so_number); // If we have a PO loaded, always show customer section
      
      console.log('üîç VENDOR DISPLAY CHECK:', {
        customerCode,
        customer_info: pd.customer_info,
        customer_code: pd.customer_code,
        so_number: pd.so_number,
        hasCustomerData
      });
      
      if (hasCustomerData) {
        customerInfoSection.style.display = 'block';
        
        // PRIORITY ORDER: Input field > customer_info.number > customer_code > fallback
        const displayCustomerNumber = customerCode || pd.customer_info?.number || pd.customer_code || 'No asignado';
        const displayCustomerName = pd.customer_info?.name || 'Informaci√≥n pendiente';
        const displayCustomerAddress = pd.customer_info?.address1 || 'Direcci√≥n pendiente';
        const displayCustomerCity = pd.customer_info?.city || 'Ciudad pendiente';
        
        console.log('üè¢ VENDOR INFO UPDATE:', {
          inputCode: customerCode,
          customerInfoNumber: pd.customer_info?.number,
          pdCustomerCode: pd.customer_code,
          finalDisplay: displayCustomerNumber
        });
        
        // Update all fields with guaranteed values
        document.getElementById('customerNumber').textContent = displayCustomerNumber;
        document.getElementById('customerName').textContent = displayCustomerName;
        document.getElementById('customerAddress').textContent = displayCustomerAddress;
        document.getElementById('customerCity').textContent = displayCustomerCity;
      } else {
        customerInfoSection.style.display = 'none';
      }
    }

    function onCustomerChange() {
      updateCustomerInfoDisplay();
      
      // Also update ship to info if available
      const pd = window.currentSOData || {};
      if (pd.shipto_info || pd.ship_to) {
        const shipToInfoSection = document.getElementById('shipToInfoSection');
        if (shipToInfoSection) {
          shipToInfoSection.style.display = 'block';
          console.log('Showed ship to info section');
          
          const shipToNumber = (pd.shipto_info && pd.shipto_info.number) || '';
          const shipToName = (pd.shipto_info && (pd.shipto_info.shipto_name || pd.shipto_info.name)) || '';
          const shipToAddress = (pd.shipto_info && (pd.shipto_info.shipto_address1 || pd.shipto_info.address1)) || '';
          const shipToCity = (pd.shipto_info && (pd.shipto_info.shipto_city || pd.shipto_info.city)) || '';
          
          document.getElementById('shipToNumber').textContent = shipToNumber || '-';
          document.getElementById('shipToName').textContent = shipToName || '-';
          document.getElementById('shipToAddress').textContent = shipToAddress || '-';
          document.getElementById('shipToCity').textContent = shipToCity || '-';
          
          console.log('Populated Ship To green box:', { shipToNumber, shipToName, shipToAddress, shipToCity });
        }
      }
    }
    
    // AUTO-REFRESH FUNCTION: Update info displays when page loads
    function refreshInfoDisplays() {
      console.log('üîÑ REFRESH: Updating info displays...');
      
      // Force update customer info display
      if (typeof updateCustomerInfoDisplay === 'function') {
        updateCustomerInfoDisplay();
      }
      
      // Try to fill customer info from current data
      if (window.currentSOData?.customer_info) {
        console.log('üîÑ REFRESH: Found customer_info, filling...');
        if (typeof fillCustomerInfo === 'function') {
          fillCustomerInfo(window.currentSOData.customer_info);
        }
      }
      
      // Try to fill ship to info from current data  
      if (window.currentSOData?.shipto_info) {
        console.log('üîÑ REFRESH: Found shipto_info, filling...');
        if (typeof fillShipToInfo === 'function') {
          fillShipToInfo(window.currentSOData.shipto_info);
        }
      }
      
      console.log('‚úÖ REFRESH: Info displays updated');
    }
    
    // FINAL VERIFICATION FUNCTION: Ensures both info boxes are visible and populated
    function ensureInfoBoxesVisible(soData) {
      console.log('üîç FINAL CHECK: Verifying info boxes visibility and data...');
      
      const customerSection = document.getElementById('customerInfoSection');
      const shipToSection = document.getElementById('shipToInfoSection');
      
      // Check customer section
      if (soData.customer_info || soData.customer_code) {
        if (customerSection) {
          customerSection.style.display = 'block';
          console.log('‚úÖ Customer section forced visible');
          
          // Double-check customer data population
          const customerNumber = document.getElementById('customerNumber');
          const customerName = document.getElementById('customerName');
          if (customerNumber && customerNumber.textContent === '-') {
            customerNumber.textContent = soData.customer_info?.number || soData.customer_code || 'No asignado';
          }
          if (customerName && customerName.textContent === '-') {
            customerName.textContent = soData.customer_info?.name || 'Informaci√≥n pendiente';
          }
        }
      }
      
      // Check ship-to section
      if (soData.shipto_info) {
        if (shipToSection) {
          shipToSection.style.display = 'block';
          console.log('‚úÖ Ship-to section forced visible');
          
          // Double-check ship-to data population
          const shipToNumber = document.getElementById('shipToNumber');
          const shipToName = document.getElementById('shipToName');
          if (shipToNumber && shipToNumber.textContent === '-') {
            shipToNumber.textContent = soData.shipto_info?.number || 'No asignado';
          }
          if (shipToName && shipToName.textContent === '-') {
            shipToName.textContent = soData.shipto_info?.name || 'Informaci√≥n pendiente';
          }
        }
      }
      
      console.log('üéØ FINAL CHECK COMPLETE: Both info boxes verified and populated');
    }
    
    function handleCustomerSearch() {
      const customerInput = document.getElementById('customerCodeInput');
      const customerCode = customerInput ? customerInput.value.trim() : '';
      
      if (!customerCode) {
        // Hide customer details if no customer code
        const customerInfoSection = document.getElementById('customerInfoSection');
        if (customerInfoSection) {
          customerInfoSection.style.display = 'none';
        }
        return;
      }
      
      // Search for specific customer by exact code
      const xhr = new XMLHttpRequest();
      xhr.open('GET', `GET_VENDORS.XML?VENDOR_NUMBER=${encodeURIComponent(customerCode)}`, true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
          try {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xhr.responseText, 'text/xml');
            const customer = xmlDoc.getElementsByTagName('customer')[0];
            
            if (customer) {
              const customerData = {
                number: customer.getElementsByTagName('customer_number')[0]?.textContent || '',
                name: customer.getElementsByTagName('customer_name')[0]?.textContent || '',
                address: customer.getElementsByTagName('customer_address')[0]?.textContent || '',
                city: customer.getElementsByTagName('customer_city')[0]?.textContent || ''
              };
              selectCustomer(customerData);
            }
          } catch (e) {
            console.error('Error loading customer:', e);
          }
        }
      };
      xhr.send();
    }

    // Ship To search functionality (dedicated endpoint) - Now triggered by ENTER key
    let shipToSearchTimeout;
    
    function handleShipToKeyDown(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        searchShipTo();
      } else if (event.key === 'Escape') {
        hideShipToSuggestions();
      } else if (event.key === 'ArrowDown' || event.key === 'ArrowUp') {
        // Allow navigation in suggestions if they're visible
        const suggestionsDiv = document.getElementById('shipToSuggestions');
        if (suggestionsDiv.style.display !== 'none') {
          // Let default behavior handle navigation
        }
      }
    }
    
    function searchShipTo() {
      clearTimeout(shipToSearchTimeout);
      
      shipToSearchTimeout = setTimeout(() => {
        const input = document.getElementById('shipToCodeInput');
        const query = input.value.trim();
        
        if (query.length < 2) {
          hideShipToSuggestions();
          return;
        }
        
        // Use dedicated ship-to endpoint
        const xhr = new XMLHttpRequest();
        xhr.open('GET', `GET_SHIPTO.XML?SEARCH=${encodeURIComponent(query)}`, true);
        xhr.onreadystatechange = function() {
          if (xhr.readyState === 4 && xhr.status === 200) {
            try {
              console.log('üîç DEBUG XML Response:', xhr.responseText);
              const parser = new DOMParser();
              const xmlDoc = parser.parseFromString(xhr.responseText, 'text/xml');
              
              // Check for XML parsing errors
              const parserError = xmlDoc.getElementsByTagName('parsererror')[0];
              if (parserError) {
                console.error('‚ùå XML Parser Error:', parserError.textContent);
                console.error('‚ùå Full parser error element:', parserError.outerHTML);
              }
              
              console.log('üîç DEBUG Full parsed XML document:', xmlDoc);
              console.log('üîç DEBUG XML document innerHTML:', xmlDoc.documentElement?.innerHTML);
              
              const shiptos = xmlDoc.getElementsByTagName('shipto');
              console.log('üîç DEBUG Parsed shiptos count:', shiptos.length);
              
              const suggestions = [];
              for (let i = 0; i < Math.min(shiptos.length, 10); i++) {
                const shipto = shiptos[i];
                
                // Get individual fields for debugging
                console.log('üîç DEBUG All child elements:', Array.from(shipto.children).map(el => el.tagName));
                
                const addr1El = shipto.getElementsByTagName('shipto_address1')[0];
                const addr2El = shipto.getElementsByTagName('shipto_address2')[0];
                const cityEl = shipto.getElementsByTagName('shipto_city')[0];
                const stateEl = shipto.getElementsByTagName('shipto_state')[0];
                const zipEl = shipto.getElementsByTagName('shipto_zip')[0];
                
                console.log('üîç DEBUG Elements found:', {
                  addr1El: !!addr1El, addr2El: !!addr2El, cityEl: !!cityEl, 
                  stateEl: !!stateEl, zipEl: !!zipEl
                });
                
                const addr1 = addr1El?.textContent || '';
                const addr2 = addr2El?.textContent || '';
                const city = cityEl?.textContent || '';
                const state = stateEl?.textContent || '';
                const zip = zipEl?.textContent || '';
                const number = shipto.getElementsByTagName('shipto_number')[0]?.textContent || '';
                const name = shipto.getElementsByTagName('shipto_name')[0]?.textContent || '';
                
                console.log(`üîç DEBUG Shipto ${number}:`, {addr1, addr2, city, state, zip, name});
                
                // Combine address1 and address2
                const fullAddress = [addr1, addr2].filter(a => a.trim()).join(', ');
                
                // Combine city, state, and zip
                const fullCity = [city, state, zip].filter(c => c.trim()).join(', ');
                
                console.log(`üîç DEBUG Combined ${number}:`, {fullAddress, fullCity});
                
                suggestions.push({
                  number: number,
                  name: name,
                  address: fullAddress,
                  city: fullCity,
                  // Store individual fields for easier parsing
                  address1: addr1,
                  address2: addr2,
                  cityName: city,
                  state: state,
                  zip: zip
                });
              }
              
              showShipToSuggestions(suggestions);
            } catch (e) {
              console.error('Error parsing ship to search results:', e);
            }
          }
        };
        xhr.send();
      }, 50);
    }

    function showShipToSuggestions(suggestions) {
      const suggestionsDiv = document.getElementById('shipToSuggestions');
      suggestionsDiv.innerHTML = '';
      
      if (suggestions.length === 0) {
        suggestionsDiv.style.display = 'none';
        return;
      }
      
      suggestions.forEach((customer, index) => {
        const item = document.createElement('div');
        item.style.cssText = `
          padding: 12px 16px; 
          cursor: pointer; 
          border-bottom: ${index === suggestions.length - 1 ? 'none' : '1px solid #f3f4f6'};
          transition: all 0.15s ease;
          font-size: 14px;
          line-height: 1.4;
        `;
        item.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: flex-start;">
            <div>
              <div style="font-weight: 600; color: #1f2937; margin-bottom: 2px;">${customer.number}</div>
              <div style="color: #374151; margin-bottom: 4px;">${customer.name}</div>
              <div style="font-size: 12px; color: #6b7280;">${customer.address} ${customer.city}</div>
            </div>
            <div style="width: 4px; height: 4px; background: #22c55e; border-radius: 50%; margin-top: 6px;"></div>
          </div>
        `;
        
        item.addEventListener('click', () => {
          selectShipTo(customer);
        });
        
        item.addEventListener('mouseenter', () => {
          item.style.backgroundColor = '#f0fdf4';
          item.style.transform = 'translateX(2px)';
        });
        
        item.addEventListener('mouseleave', () => {
          item.style.backgroundColor = 'white';
          item.style.transform = 'translateX(0px)';
        });
        
        suggestionsDiv.appendChild(item);
      });
      
      suggestionsDiv.style.display = 'block';
    }

    function hideShipToSuggestions() {
      const suggestionsDiv = document.getElementById('shipToSuggestions');
      if (suggestionsDiv) {
        setTimeout(() => {
          suggestionsDiv.style.display = 'none';
        }, 150);
      }
    }

    function hideCustomerSuggestions(immediate = false) {
      const suggestionsDiv = document.getElementById('customerSuggestions');
      if (suggestionsDiv) {
        if (immediate) {
          suggestionsDiv.style.display = 'none';
        } else {
          setTimeout(() => {
            suggestionsDiv.style.display = 'none';
          }, 150);
        }
      }
    }

    function selectShipTo(customer) {
      const input = document.getElementById('shipToCodeInput');
      input.value = `${customer.number} - ${customer.name}`;
      hideShipToSuggestions();
      
      console.log('üîç selectShipTo called with customer:', customer);
      
      // Use the individual fields stored in the suggestion object
      const shiptoInfo = {
        number: customer.number,
        name: customer.name,
        address1: customer.address1 || '',
        address2: customer.address2 || '',
        city: customer.cityName || '',
        state: customer.state || '',
        zip: customer.zip || ''
      };
      
      console.log('üîç Created shiptoInfo structure:', shiptoInfo);
      
      // Use the same fillShipToInfo function that works for PO loading
      fillShipToInfo(shiptoInfo);
    }

    function onShipToChange() {
      const shipToInput = document.getElementById('shipToCodeInput');
      const shipToCodeRaw = shipToInput.value.trim();
      const shipToCode = shipToCodeRaw.includes(' - ')
        ? shipToCodeRaw.split(' - ')[0].trim()
        : shipToCodeRaw;
      
      if (!shipToCode) {
        // Hide ship to details if no ship to code
        const shipToInfoSection = document.getElementById('shipToInfoSection');
        if (shipToInfoSection) {
          shipToInfoSection.style.display = 'none';
        }
        return;
      }
      
      // Pull specific ship-to by exact code
      const xhr = new XMLHttpRequest();
      xhr.open('GET', `GET_SHIPTO.XML?SHIPTO_CODE=${encodeURIComponent(shipToCode)}`, true);
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4 && xhr.status === 200) {
          try {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xhr.responseText, 'text/xml');
            const shipto = xmlDoc.getElementsByTagName('shipto')[0];
            
            if (shipto) {
              const shipToData = {
                number: shipto.getElementsByTagName('shipto_number')[0]?.textContent || '',
                name: shipto.getElementsByTagName('shipto_name')[0]?.textContent || '',
                address: shipto.getElementsByTagName('shipto_address1')[0]?.textContent || '',
                city: shipto.getElementsByTagName('shipto_city')[0]?.textContent || ''
              };
              selectShipTo(shipToData);
            }
          } catch (e) {
            console.error('Error loading ship-to:', e);
          }
        }
      };
      xhr.send();
    }

    function onSalespersonChange() {
      // No-op: Salesperson functionality removed
    }

    function onShipViaChange() {
      const shipViaSelect = document.getElementById('shipViaSelect');
      if (shipViaSelect && shipViaSelect.value) {
        console.log('üöö Ship Via selected:', shipViaSelect.value, '-', shipViaSelect.selectedOptions[0]?.text);
      }
    }

    async function showNewSOForm() {
      var form = document.getElementById('soForm');
      if (form) {
        form.style.display = 'grid';
        
        // Clear ALL form fields first
        clearAllFormFields();
        
        // Auto-generate new SO number
        await generateNextPONumber();
      }
      return false;
    }
    
    function clearAllFormFields() {
      // Clear ALL input fields that get populated during SO search
      const inputFields = [
        // Main form fields
        'soNumberInput', 'soDateInput', 'customerCodeInput', 'shipToCodeInput', 
        'soStatusInput', 'headerNotesInput', 'notesInput',
        // Additional form fields
        'requiredDateInput', 'shipDateInput', 'shipToAddressInput', 'paymentTermsInput',
        'currencyInput', 'subtotalInput', 'taxAmountInput', 'shippingCostInput', 'totalAmountInput',
        // Display fields
        'displayCustomerCode', 'displayShipToCode',
        // Data fields
        'scheduleData', 'needsData', 'ackData', 'lineNotesData'
      ];
      
      inputFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) field.value = '';
      });
      
      // Clear select dropdowns
      const selectFields = ['soStatusInput', 'displayStatusSelect'];
      selectFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.selectedIndex = 0;
          field.innerHTML = ''; // Clear options for dynamic selects
        }
      });
      
      // Clear display text elements
      const textElements = [
        'displayCustomerName', 'displayShipToName', 'displayShipToAddress'
      ];
      textElements.forEach(elementId => {
        const element = document.getElementById(elementId);
        if (element) element.textContent = '-';
      });
      
      // Hide and clear info sections completely
      const infoSections = ['customerInfo', 'shipToInfo'];
      infoSections.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        if (section) section.innerHTML = '';
      });
      
      // Hide main information sections  
      const mainInfoSections = ['customerInfoSection', 'shipToInfoSection'];
      mainInfoSections.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        if (section) {
          section.style.display = 'none';
          section.innerHTML = ''; // Clear content too
        }
      });
      
      // Clear specific customer info fields
      const customerFields = ['customerNumber', 'customerName', 'customerAddress', 'customerCity'];
      customerFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) field.textContent = '-';
      });
      
      // Clear specific ship-to info fields
      const shipToFields = ['shipToNumber', 'shipToName', 'shipToAddress', 'shipToCity'];
      shipToFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) field.textContent = '-';
      });
      
      // Clear line items completely
      lineItems = [];
      const lineItemsTable = document.getElementById('lineItemsTable');
      if (lineItemsTable) {
        const tbody = lineItemsTable.querySelector('tbody');
        if (tbody) tbody.innerHTML = '';
        
        // Also clear the table body if it has a different structure
        const liRows = lineItemsTable.querySelectorAll('.li-row');
        liRows.forEach(row => row.remove());
      }
      
      // Update line items count display
      const lineItemsCount = document.getElementById('lineItemsCount');
      if (lineItemsCount) lineItemsCount.textContent = '0 items';
      
      // Clear Tracking Information sections
      // Need Info section - PRESERVE USER EDITED FIELDS
      for (let i = 1; i <= 5; i++) {
        const needDate = document.getElementById(`needDate${i}`);
        const needQty = document.getElementById(`needQty${i}`);
        const needInfo = document.getElementById(`needInfo${i}`);
        
        // Only clear need date if NOT user-edited AND empty
        if (needDate && !needDate.hasAttribute('data-user-edited') && !needDate.value) {
          needDate.value = '';
        }
        
        // Only clear need qty if NOT user-edited AND empty  
        if (needQty && !needQty.hasAttribute('data-user-edited') && !needQty.value) {
          needQty.value = '';
        }
        
        if (needInfo) needInfo.checked = false;
      }
      
      // Acknowledgements section - PRESERVE USER EDITED FIELDS
      for (let i = 1; i <= 5; i++) {
        const ackDate = document.getElementById(`ackDate${i}`);
        const ackQty = document.getElementById(`ackQty${i}`);
        
        // Only clear if NOT user-edited
        if (ackDate && !ackDate.hasAttribute('data-user-edited')) {
          ackDate.value = '';
          console.log(`üßπ Cleared ackDate${i} (not user-edited)`);
        } else if (ackDate) {
          console.log(`üîí Preserved ackDate${i} = "${ackDate.value}" (user-edited)`);
        }
        
        if (ackQty && !ackQty.hasAttribute('data-user-edited')) {
          ackQty.value = '';
          console.log(`üßπ Cleared ackQty${i} (not user-edited)`);
        } else if (ackQty) {
          console.log(`üîí Preserved ackQty${i} = "${ackQty.value}" (user-edited)`);
        }
      }
      
      // Schedules section - PRESERVE USER EDITED FIELDS
      for (let i = 1; i <= 5; i++) {
        const scheduleDate = document.getElementById(`scheduleDate${i}`);
        const scheduleQty = document.getElementById(`scheduleQty${i}`);
        const lineScheduleDate = document.getElementById(`lineScheduleDate${i}`);
        const lineScheduleQty = document.getElementById(`lineScheduleQty${i}`);
        const schedule = document.getElementById(`schedule${i}`);
        
        // Only clear scheduleDate if NOT user-edited
        if (scheduleDate && !scheduleDate.hasAttribute('data-user-edited')) {
          scheduleDate.value = '';
          console.log(`üßπ clearAllFormFields: Cleared scheduleDate${i} (not user-edited)`);
        } else if (scheduleDate) {
          console.log(`üîí clearAllFormFields: Preserved scheduleDate${i} = "${scheduleDate.value}" (user-edited)`);
        }
        
        // Only clear scheduleQty if NOT user-edited
        if (scheduleQty && !scheduleQty.hasAttribute('data-user-edited')) {
          scheduleQty.value = '';
          console.log(`üßπ clearAllFormFields: Cleared scheduleQty${i} (not user-edited)`);
        } else if (scheduleQty) {
          console.log(`üîí clearAllFormFields: Preserved scheduleQty${i} = "${scheduleQty.value}" (user-edited)`);
        }
        
        // Only clear lineScheduleDate if NOT user-edited  
        if (lineScheduleDate && !lineScheduleDate.hasAttribute('data-user-edited')) {
          lineScheduleDate.value = '';
          console.log(`üßπ clearAllFormFields: Cleared lineScheduleDate${i} (not user-edited)`);
        } else if (lineScheduleDate) {
          console.log(`üîí clearAllFormFields: Preserved lineScheduleDate${i} = "${lineScheduleDate.value}" (user-edited)`);
        }
        
        // Only clear lineScheduleQty if NOT user-edited
        if (lineScheduleQty && !lineScheduleQty.hasAttribute('data-user-edited')) {
          lineScheduleQty.value = '';
          console.log(`üßπ clearAllFormFields: Cleared lineScheduleQty${i} (not user-edited)`);
        } else if (lineScheduleQty) {
          console.log(`üîí clearAllFormFields: Preserved lineScheduleQty${i} = "${lineScheduleQty.value}" (user-edited)`);
        }
        
        if (schedule) schedule.checked = false;
      }
      
      // Clear any search results or PO display sections
      const searchResults = document.getElementById('poSearchResults');
      if (searchResults) searchResults.innerHTML = '';
      
      const poDisplay = document.getElementById('poDisplay');
      if (poDisplay) poDisplay.style.display = 'none';
      
      console.log('‚ú® ALL form fields and display sections cleared for new PO');
    }
    // Line items management
    let lineItems = [];
    let editingLineIndex = -1;
    
    // DYNAMIC ROWS COUNTERS
    let needRowCount = 5;
    let ackRowCount = 5;
    let schedRowCount = 5;
    
    // Initialize tracking rows on page load
    function initializeTrackingRows() {
      // Initialize Need rows
      const needContainer = document.getElementById('needRowsContainer');
      if (needContainer) {
        for (let i = 1; i <= 5; i++) {
          addNeedRowInternal(i);
        }
      }
      
      // Initialize Ack rows
      const ackContainer = document.getElementById('ackRowsContainer');
      if (ackContainer) {
        for (let i = 1; i <= 5; i++) {
          addAckRowInternal(i);
        }
      }
      
      // Initialize Sched rows
      const schedContainer = document.getElementById('schedRowsContainer');
      if (schedContainer) {
        for (let i = 1; i <= 5; i++) {
          addSchedRowInternal(i);
        }
      }
    }
    
    // Add Need Row (internal - with specific index)
    function addNeedRowInternal(index) {
      const container = document.getElementById('needRowsContainer');
      if (!container) return;
      
      const rowDiv = document.createElement('div');
      rowDiv.id = `needRow${index}`;
      rowDiv.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr 32px; gap: 8px; margin-bottom: 8px; align-items: center;';
      rowDiv.innerHTML = `
        <input type="date" id="needDate${index}" style="border: 2px solid #10b981; border-radius: 6px; padding: 10px; font-size: 15px; background: white; width: 100%;">
        <input type="number" id="needQty${index}" step="0.01" placeholder="Qty" style="border: 2px solid #10b981; border-radius: 6px; padding: 10px; font-size: 15px; background: white; width: 100%;">
        <button type="button" onclick="removeNeedRow(${index})" title="Remove" style="padding: 8px; font-size: 14px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;"><i class="fas fa-times"></i></button>
      `;
      container.appendChild(rowDiv);
    }
    
    // Add Need Row (user action)
    function addNeedRow() {
      needRowCount++;
      addNeedRowInternal(needRowCount);
      console.log(`‚úÖ Added need row ${needRowCount}`);
    }
    
    // Remove Need Row
    function removeNeedRow(index) {
      const row = document.getElementById(`needRow${index}`);
      if (row) {
        row.remove();
        console.log(`üóëÔ∏è Removed need row ${index}`);
      }
    }
    
    // Add Ack Row (internal - with specific index)
    function addAckRowInternal(index) {
      const container = document.getElementById('ackRowsContainer');
      if (!container) return;
      
      const rowDiv = document.createElement('div');
      rowDiv.id = `ackRow${index}`;
      rowDiv.style.cssText = 'display: grid; grid-template-columns: 1fr 80px 32px; gap: 8px; margin-bottom: 8px; align-items: center;';
      rowDiv.innerHTML = `
        <input type="date" id="ackDate${index}" style="border: 2px solid #ef4444; border-radius: 6px; padding: 8px; font-size: 13px; background: white;">
        <input type="number" id="ackQty${index}" step="0.01" placeholder="Qty" style="border: 2px solid #ef4444; border-radius: 6px; padding: 8px; font-size: 13px; background: white;">
        <button type="button" onclick="removeAckRow(${index})" title="Remove" style="padding: 8px; font-size: 14px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;"><i class="fas fa-times"></i></button>
      `;
      container.appendChild(rowDiv);
    }
    
    // Add Ack Row (user action)
    function addAckRow() {
      ackRowCount++;
      addAckRowInternal(ackRowCount);
      console.log(`‚úÖ Added ack row ${ackRowCount}`);
    }
    
    // Remove Ack Row
    function removeAckRow(index) {
      const row = document.getElementById(`ackRow${index}`);
      if (row) {
        row.remove();
        console.log(`üóëÔ∏è Removed ack row ${index}`);
      }
    }
    
    // Add Sched Row (internal - with specific index)
    function addSchedRowInternal(index) {
      const container = document.getElementById('schedRowsContainer');
      if (!container) return;
      
      const rowDiv = document.createElement('div');
      rowDiv.id = `schedRow${index}`;
      rowDiv.style.cssText = 'display: grid; grid-template-columns: 1fr 1fr 40px 32px; gap: 8px; margin-bottom: 8px; align-items: center;';
      rowDiv.innerHTML = `
        <input type="date" id="lineScheduleDate${index}" style="border: 2px solid #8b5cf6; border-radius: 6px; padding: 10px; font-size: 15px; background: white; width: 100%;">
        <input type="number" id="lineScheduleQty${index}" step="0.01" placeholder="Qty" style="border: 2px solid #8b5cf6; border-radius: 6px; padding: 10px; font-size: 15px; background: white; width: 100%;">
        <input type="checkbox" id="lineRS${index}" style="margin: auto; transform: scale(1.3); cursor: pointer;">
        <button type="button" onclick="removeSchedRow(${index})" title="Remove" style="padding: 8px; font-size: 14px; background: #ef4444; color: white; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center;"><i class="fas fa-times"></i></button>
      `;
      container.appendChild(rowDiv);
    }
    
    // Add Sched Row (user action)
    function addSchedRow() {
      schedRowCount++;
      addSchedRowInternal(schedRowCount);
      console.log(`‚úÖ Added sched row ${schedRowCount}`);
    }
    
    // Remove Sched Row
    function removeSchedRow(index) {
      const row = document.getElementById(`schedRow${index}`);
      if (row) {
        row.remove();
        console.log(`üóëÔ∏è Removed sched row ${index}`);
      }
    }
    
    // CACHE SYSTEM: Preserve tracking data for each line item before switching
    let lineItemTrackingCache = {
      needs: {},      // lineIndex: [{date, qty}, ...]
      acknowledgments: {}, // lineIndex: [{date, qty}, ...]  
      schedules: {}   // lineIndex: [{date, qty}, ...]
    };
    
    // PERSISTENT CACHE: Save/load cache to localStorage for persistence across page reloads
    function saveCacheToStorage() {
      try {
        const cacheData = {
          cache: lineItemTrackingCache,
          timestamp: Date.now(),
          so_number: window.currentSOData?.so_number || 'unknown'
        };
        localStorage.setItem('po_tracking_cache', JSON.stringify(cacheData));
        console.log('üíæ PERSISTENT: Cache saved to localStorage');
      } catch (e) {
        console.warn('‚ö†Ô∏è PERSISTENT: Could not save cache to localStorage:', e);
      }
    }
    
    function loadCacheFromStorage() {
      try {
        const cached = localStorage.getItem('po_tracking_cache');
        console.log('üîç PERSISTENT DEBUG: Raw localStorage content:', cached);
        
        if (cached) {
          const cacheData = JSON.parse(cached);
          console.log('üîç PERSISTENT DEBUG: Parsed cache data:', cacheData);
          
          // Only load if it's recent (within 1 hour) and same PO
          const oneHour = 60 * 60 * 1000;
          const ageMs = Date.now() - cacheData.timestamp;
          const ageMins = Math.round(ageMs / (1000 * 60));
          const currentPO = window.currentSOData?.so_number || 'unknown';
          
          console.log('üîç PERSISTENT DEBUG: Cache validation:', {
            cacheAge: `${ageMins} minutes`,
            isRecent: ageMs < oneHour,
            cachePO: cacheData.so_number,
            currentPO: currentPO,
            poMatch: cacheData.so_number === currentPO
          });
          
          if (ageMs < oneHour && cacheData.so_number === currentPO) {
            lineItemTrackingCache = cacheData.cache || {};
            console.log('üîÑ PERSISTENT: Cache loaded from localStorage:', {
              loadedCache: lineItemTrackingCache,
              cacheSize: {
                acks: Object.keys(lineItemTrackingCache.acknowledgments || {}).length,
                needs: Object.keys(lineItemTrackingCache.needs || {}).length,
                schedules: Object.keys(lineItemTrackingCache.schedules || {}).length
              }
            });
            return true;
          } else {
            console.log('‚ö†Ô∏è PERSISTENT: Cache expired or PO mismatch, not loading');
          }
        } else {
          console.log('‚ö†Ô∏è PERSISTENT: No cache found in localStorage');
        }
      } catch (e) {
        console.warn('‚ö†Ô∏è PERSISTENT: Could not load cache from localStorage:', e);
      }
      return false;
    }
    
    // CACHE FUNCTIONS: Save and restore tracking data for line items
    function saveCurrentTrackingToCache() {
      if (editingLineIndex < 0) return;
      
      console.log(`üíæ CACHE: Saving current tracking data for line item ${editingLineIndex}`);
      
      // Save acknowledgments
      const ackEntries = [];
      for (let i = 1; i <= 5; i++) {
        const dateField = document.getElementById(`ackDate${i}`);
        const qtyField = document.getElementById(`ackQty${i}`);
        if (dateField && dateField.value.trim() && qtyField && qtyField.value.trim()) {
          ackEntries.push({
            date: dateField.value.trim(),
            qty: qtyField.value.trim()
          });
        }
      }
      lineItemTrackingCache.acknowledgments[editingLineIndex] = ackEntries;
      
      // Save needs - FIXED: Check both date and qty have values
      const needEntries = [];
      for (let i = 1; i <= 5; i++) {
        const dateField = document.getElementById(`needDate${i}`);
        const qtyField = document.getElementById(`needQty${i}`);
        
        console.log(`üîç CACHE SAVE DEBUG needDate${i}:`, {
          exists: !!dateField,
          value: dateField ? dateField.value : 'NULL',
          trimmed: dateField ? dateField.value.trim() : 'NULL',
          hasTrimmedValue: dateField ? !!dateField.value.trim() : false
        });
        
        console.log(`üîç CACHE SAVE DEBUG needQty${i}:`, {
          exists: !!qtyField,
          value: qtyField ? qtyField.value : 'NULL',
          trimmed: qtyField ? qtyField.value.trim() : 'NULL',
          hasTrimmedValue: qtyField ? !!qtyField.value.trim() : false
        });
        
        if (dateField && dateField.value.trim() && qtyField && qtyField.value.trim()) {
          const entry = {
            date: dateField.value.trim(),
            qty: qtyField.value.trim()
          };
          needEntries.push(entry);
          console.log(`‚úÖ CACHE SAVE: Added need entry ${i}:`, entry);
        } else {
          console.log(`‚ùå CACHE SAVE: Skipped need entry ${i} - missing date or qty`);
        }
      }
      lineItemTrackingCache.needs[editingLineIndex] = needEntries;
      
      // Save schedules
      const scheduleEntries = [];
      for (let i = 1; i <= 5; i++) {
        const dateField = document.getElementById(`lineScheduleDate${i}`);
        const qtyField = document.getElementById(`lineScheduleQty${i}`);
        if (dateField && dateField.value.trim() && qtyField && qtyField.value.trim()) {
          scheduleEntries.push({
            date: dateField.value.trim(),
            qty: qtyField.value.trim()
          });
        }
      }
      lineItemTrackingCache.schedules[editingLineIndex] = scheduleEntries;
      
      console.log(`üíæ CACHE: Saved ${ackEntries.length} acks, ${needEntries.length} needs, ${scheduleEntries.length} schedules for line ${editingLineIndex}`);
      
      // DEBUG: Show what was saved to cache
      console.log('üíæ CACHE SAVE DEBUG:', {
        lineIndex: editingLineIndex,
        savedData: {
          acks: ackEntries,
          needs: needEntries,
          schedules: scheduleEntries
        },
        totalCacheSize: {
          ackLines: Object.keys(lineItemTrackingCache.acknowledgments).length,
          needLines: Object.keys(lineItemTrackingCache.needs).length,
          scheduleLines: Object.keys(lineItemTrackingCache.schedules).length
        }
      });
      
      // PERSISTENT: Save to localStorage after updating cache
      saveCacheToStorage();
    }
    
    // AUTO-SAVE: Save cache whenever tracking fields change
    function setupAutoSaveCacheListeners() {
      console.log('üîß SETUP: Setting up auto-save cache listeners');
      
      // Setup listeners for acknowledgment fields
      for (let i = 1; i <= 5; i++) {
        const dateField = document.getElementById(`ackDate${i}`);
        const qtyField = document.getElementById(`ackQty${i}`);
        
        if (dateField && !dateField.hasAttribute('data-cache-listener')) {
          dateField.addEventListener('change', () => {
            console.log(`üîß AUTO-SAVE: ackDate${i} changed, saving to cache`);
            if (editingLineIndex >= 0) {
              saveCurrentTrackingToCache();
            }
          });
          dateField.setAttribute('data-cache-listener', 'true');
        }
        
        if (qtyField && !qtyField.hasAttribute('data-cache-listener')) {
          qtyField.addEventListener('change', () => {
            console.log(`üîß AUTO-SAVE: ackQty${i} changed, saving to cache`);
            if (editingLineIndex >= 0) {
              saveCurrentTrackingToCache();
            }
          });
          qtyField.setAttribute('data-cache-listener', 'true');
        }
      }
      
      // Setup listeners for needs fields
      for (let i = 1; i <= 5; i++) {
        const dateField = document.getElementById(`needDate${i}`);
        const qtyField = document.getElementById(`needQty${i}`);
        
        if (dateField && !dateField.hasAttribute('data-cache-listener')) {
          // CRITICAL FIX: Mark as user-edited on focus/input to prevent auto-clearing
          dateField.addEventListener('focus', () => {
            console.log(`üîß USER-EDIT: needDate${i} focused, marking as user-edited`);
            dateField.setAttribute('data-user-edited', 'true');
          });
          dateField.addEventListener('input', () => {
            console.log(`üîß USER-EDIT: needDate${i} input detected, marking as user-edited`);
            dateField.setAttribute('data-user-edited', 'true');
          });
          dateField.addEventListener('change', () => {
            console.log(`üîß AUTO-SAVE: needDate${i} changed, saving to cache`);
            if (editingLineIndex >= 0) {
              saveCurrentTrackingToCache();
            }
          });
          dateField.setAttribute('data-cache-listener', 'true');
        }
        
        if (qtyField && !qtyField.hasAttribute('data-cache-listener')) {
          // CRITICAL FIX: Mark as user-edited on focus/input to prevent auto-clearing
          qtyField.addEventListener('focus', () => {
            console.log(`üîß USER-EDIT: needQty${i} focused, marking as user-edited`);
            qtyField.setAttribute('data-user-edited', 'true');
          });
          qtyField.addEventListener('input', () => {
            console.log(`üîß USER-EDIT: needQty${i} input detected, marking as user-edited`);
            qtyField.setAttribute('data-user-edited', 'true');
          });
          qtyField.addEventListener('change', () => {
            console.log(`üîß AUTO-SAVE: needQty${i} changed, saving to cache`);
            if (editingLineIndex >= 0) {
              saveCurrentTrackingToCache();
            }
          });
          qtyField.setAttribute('data-cache-listener', 'true');
        }
      }
      
      // Setup listeners for schedule fields
      for (let i = 1; i <= 5; i++) {
        const dateField = document.getElementById(`lineScheduleDate${i}`);
        const qtyField = document.getElementById(`lineScheduleQty${i}`);
        
        if (dateField && !dateField.hasAttribute('data-cache-listener')) {
          dateField.addEventListener('change', () => {
            console.log(`üîß AUTO-SAVE: lineScheduleDate${i} changed, saving to cache`);
            if (editingLineIndex >= 0) {
              saveCurrentTrackingToCache();
            }
          });
          dateField.setAttribute('data-cache-listener', 'true');
        }
        
        if (qtyField && !qtyField.hasAttribute('data-cache-listener')) {
          qtyField.addEventListener('change', () => {
            console.log(`üîß AUTO-SAVE: lineScheduleQty${i} changed, saving to cache`);
            if (editingLineIndex >= 0) {
              saveCurrentTrackingToCache();
            }
          });
          qtyField.setAttribute('data-cache-listener', 'true');
        }
      }
      
      console.log('‚úÖ SETUP: Auto-save cache listeners configured');
    }
    
    function restoreTrackingFromCache(lineIndex) {
      console.log(`üîÑ CACHE: Restoring tracking data for line item ${lineIndex}`);
      
      // Restore acknowledgments
      const cachedAcks = lineItemTrackingCache.acknowledgments[lineIndex] || [];
      for (let i = 1; i <= 5; i++) {
        const dateField = document.getElementById(`ackDate${i}`);
        const qtyField = document.getElementById(`ackQty${i}`);
        if (dateField && qtyField) {
          const entry = cachedAcks[i - 1];
          if (entry) {
            dateField.value = entry.date;
            qtyField.value = entry.qty;
            // Mark as user-edited to preserve
            dateField.setAttribute('data-user-edited', 'true');
            qtyField.setAttribute('data-user-edited', 'true');
          } else {
            dateField.value = '';
            qtyField.value = '';
            dateField.removeAttribute('data-user-edited');
            qtyField.removeAttribute('data-user-edited');
          }
        }
      }
      
      // Restore needs
      const cachedNeeds = lineItemTrackingCache.needs[lineIndex] || [];
      for (let i = 1; i <= 5; i++) {
        const dateField = document.getElementById(`needDate${i}`);
        const qtyField = document.getElementById(`needQty${i}`);
        if (dateField && qtyField) {
          const entry = cachedNeeds[i - 1];
          if (entry) {
            dateField.value = entry.date;
            qtyField.value = entry.qty;
          } else {
            dateField.value = '';
            qtyField.value = '';
          }
        }
      }
      
      // Restore schedules
      const cachedSchedules = lineItemTrackingCache.schedules[lineIndex] || [];
      for (let i = 1; i <= 5; i++) {
        const dateField = document.getElementById(`lineScheduleDate${i}`);
        const qtyField = document.getElementById(`lineScheduleQty${i}`);
        if (dateField && qtyField) {
          const entry = cachedSchedules[i - 1];
          if (entry) {
            dateField.value = entry.date;
            qtyField.value = entry.qty;
          } else {
            dateField.value = '';
            qtyField.value = '';
          }
        }
      }
      
      console.log(`üîÑ CACHE: Restored ${cachedAcks.length} acks, ${cachedNeeds.length} needs, ${cachedSchedules.length} schedules for line ${lineIndex}`);
      
      // DEBUG: Show cache contents
      console.log(`üîç CACHE DEBUG: Current cache contents:`, {
        acknowledgments: lineItemTrackingCache.acknowledgments,
        needs: lineItemTrackingCache.needs,
        schedules: lineItemTrackingCache.schedules
      });
    }

    // CRITICAL FIX: Apply ALL cached data to lineItems before SAVE PO
    function applyCacheToLineItems() {
      console.log('üöÄ CRITICAL FIX: Applying ALL cache data to lineItems before SAVE');
      
      // Iterate through all cached data and apply to lineItems
      Object.keys(lineItemTrackingCache.needs || {}).forEach(lineIndex => {
        const cachedNeeds = lineItemTrackingCache.needs[lineIndex] || [];
        if (cachedNeeds.length > 0 && lineItems[lineIndex]) {
          console.log(`üîß CACHE FIX: Applying ${cachedNeeds.length} cached needs to lineItem ${lineIndex}`);
          
          // Update the lineItem's needEntries with cache data
          lineItems[lineIndex].needEntries = cachedNeeds.map(need => ({
            date: need.date,
            qty: need.qty
          }));
          
          console.log(`‚úÖ CACHE FIX: Updated lineItem ${lineIndex} needEntries:`, lineItems[lineIndex].needEntries);
        }
      });
      
      Object.keys(lineItemTrackingCache.acknowledgments || {}).forEach(lineIndex => {
        const cachedAcks = lineItemTrackingCache.acknowledgments[lineIndex] || [];
        if (cachedAcks.length > 0 && lineItems[lineIndex]) {
          console.log(`üîß CACHE FIX: Applying ${cachedAcks.length} cached acks to lineItem ${lineIndex}`);
          
          // Update the lineItem's ackEntries with cache data
          lineItems[lineIndex].ackEntries = cachedAcks.map(ack => ({
            date: ack.date,
            qty: ack.qty
          }));
          
          console.log(`‚úÖ CACHE FIX: Updated lineItem ${lineIndex} ackEntries:`, lineItems[lineIndex].ackEntries);
        }
      });
      
      Object.keys(lineItemTrackingCache.schedules || {}).forEach(lineIndex => {
        const cachedSchedules = lineItemTrackingCache.schedules[lineIndex] || [];
        if (cachedSchedules.length > 0 && lineItems[lineIndex]) {
          console.log(`üîß CACHE FIX: Applying ${cachedSchedules.length} cached schedules to lineItem ${lineIndex}`);
          
          // Update the lineItem's scheduleEntries with cache data
          lineItems[lineIndex].scheduleEntries = cachedSchedules.map(sched => ({
            date: sched.date,
            qty: sched.qty
          }));
          
          console.log(`‚úÖ CACHE FIX: Updated lineItem ${lineIndex} scheduleEntries:`, lineItems[lineIndex].scheduleEntries);
        }
      });
      
      console.log('üéØ CACHE FIX: All cached data applied to lineItems. Ready for SAVE PO.');
    }

    function showAddLineItemForm() {
      console.log('üî• showAddLineItemForm() called');
      editingLineIndex = -1;
      clearLineItemForm();
      console.log('About to switch to tab 2');
      // Switch to Line Items tab
      switchTab(2);
      console.log('Switched to tab 2');
      if (typeof window.switchLineTab === 'function') { 
        console.log('Calling switchLineTab(0)');
        window.switchLineTab(0); 
      }
      console.log('Setting line number to:', lineItems.length + 1);
      // Auto-set next line number
      document.getElementById('lineNumber').value = lineItems.length + 1;
      
      // Add part number lookup event listeners after tab switch
      console.log('Setting timeout for event listeners');
      setTimeout(() => {
        console.log('Timeout executed, looking for linePartNumber element');
        const partNumberInput = document.getElementById('linePartNumber');
        console.log('Found linePartNumber element:', partNumberInput);
        if (partNumberInput) {
          console.log('Adding event listeners to part number input');
          let lookupTimeout;
          
          // Remove any existing event listeners first
          if (partNumberInput._inputHandler) {
            partNumberInput.removeEventListener('input', partNumberInput._inputHandler);
          }
          if (partNumberInput._keydownHandler) {
            partNumberInput.removeEventListener('keydown', partNumberInput._keydownHandler);
          }
          
          // Add input handler with debounce
          partNumberInput._inputHandler = function() {
            console.log('Input event triggered');
            clearTimeout(lookupTimeout);
            lookupTimeout = setTimeout(() => {
              lookupPartInfo(this.value.trim());
            }, 500);
          };
          partNumberInput.addEventListener('input', partNumberInput._inputHandler);
          
          // Add Enter key handler
          partNumberInput._keydownHandler = function(e) {
            console.log('Key pressed:', e.key);
            if (e.key === 'Enter') {
              console.log('Enter key detected, starting part lookup...');
              e.preventDefault();
              clearTimeout(lookupTimeout);
              const partNum = this.value.trim();
              console.log('Part number to lookup:', partNum);
              lookupPartInfo(partNum);
            }
          };
          partNumberInput.addEventListener('keydown', partNumberInput._keydownHandler);
          console.log('Event listeners added successfully');
        } else {
          console.error('Part number input not found');
          console.log('Available elements with id containing "line":', document.querySelectorAll('[id*="line"]'));
        }
      }, 200); // Increased delay to ensure DOM is updated
    }

    function clearLineItemForm() {
      // Clear all form inputs manually since we're using a div, not a form
      // Add null checks to prevent errors when elements don't exist yet
      const linePartNumber = document.getElementById('linePartNumber');
      if (linePartNumber) {
        linePartNumber.value = '';
        linePartNumber.style.backgroundColor = '';
        linePartNumber.style.borderColor = '';
      }
      
      const lineQuantity = document.getElementById('lineQuantity');
      if (lineQuantity) lineQuantity.value = '';
      
      const lineDescription = document.getElementById('lineDescription');
      if (lineDescription) {
        lineDescription.value = '';
        lineDescription.readOnly = false;
        lineDescription.style.backgroundColor = '';
        lineDescription.style.color = '';
      }
      
      const lineDocRev = document.getElementById('lineDocRev');
      if (lineDocRev) lineDocRev.value = '';
      
      const lineCustomerPart = document.getElementById('lineCustomerPart');
      if (lineCustomerPart) lineCustomerPart.value = '';
      
      const lineUnitPrice = document.getElementById('lineUnitPrice');
      if (lineUnitPrice) lineUnitPrice.value = '';
      
      const lineUOM = document.getElementById('lineUOM');
      if (lineUOM) {
        lineUOM.value = '';
        lineUOM.readOnly = false;
        lineUOM.style.backgroundColor = '';
        lineUOM.style.color = '';
        console.log('üßπ clearLineItemForm: Cleared lineUOM (Unit of Measure)');
      }
      
      const lineNotes = document.getElementById('lineNotes');
      if (lineNotes) lineNotes.value = '';
      
      const lineProdNotes = document.getElementById('lineProdNotes');
      if (lineProdNotes) {
        lineProdNotes.value = '';
        console.log('üßπ clearLineItemForm: Cleared lineProdNotes (Production Notes)');
      }
      
      const lineProdControlNotes = document.getElementById('lineProdControlNotes');
      if (lineProdControlNotes) lineProdControlNotes.value = '';
      
      const lineFirstArticle = document.getElementById('lineFirstArticle');
      if (lineFirstArticle) lineFirstArticle.value = '';
      
      const lineGovtRating = document.getElementById('lineGovtRating');
      if (lineGovtRating) lineGovtRating.value = '';
      
      const lineTotal = document.getElementById('lineTotal');
      if (lineTotal) lineTotal.textContent = '0.00';
      
      // Clear all Need Info checkboxes and dates
      for (let i = 1; i <= 5; i++) {
        const checkbox = document.getElementById(`needInfo${i}`);
        const date = document.getElementById(`needInfoDate${i}`);
        if (checkbox) checkbox.checked = false;
        if (date) date.value = '';
      }
      
      // Clear all Need Fields (needDate and needQty) - CRITICAL FOR NEW LINE ITEMS
      console.log('üßπ clearLineItemForm: Clearing all needDate and needQty fields for new line item');
      for (let i = 1; i <= 5; i++) {
        const needDateField = document.getElementById(`needDate${i}`);
        const needQtyField = document.getElementById(`needQty${i}`);
        
        if (needDateField) {
          needDateField.value = '';
          needDateField.removeAttribute('data-user-edited'); // Reset user-edited state
          console.log(`üßπ clearLineItemForm: Cleared needDate${i}`);
        }
        
        if (needQtyField) {
          needQtyField.value = '';
          needQtyField.removeAttribute('data-user-edited'); // Reset user-edited state
          console.log(`üßπ clearLineItemForm: Cleared needQty${i}`);
        }
      }
      
      // Clear all Acknowledgment Fields (ackDate and ackQty) - CRITICAL FOR NEW LINE ITEMS
      console.log('üßπ clearLineItemForm: Clearing all ackDate and ackQty fields for new line item');
      for (let i = 1; i <= 5; i++) {
        const checkbox = document.getElementById(`ack${i}`);
        const ackDateField = document.getElementById(`ackDate${i}`);
        const ackQtyField = document.getElementById(`ackQty${i}`);
        
        if (checkbox) checkbox.checked = false;
        
        if (ackDateField) {
          ackDateField.value = '';
          ackDateField.removeAttribute('data-user-edited'); // Reset user-edited state
          console.log(`üßπ clearLineItemForm: Cleared ackDate${i}`);
        }
        
        if (ackQtyField) {
          ackQtyField.value = '';
          ackQtyField.removeAttribute('data-user-edited'); // Reset user-edited state
          console.log(`üßπ clearLineItemForm: Cleared ackQty${i}`);
        }
      }
      
      // Clear all Schedule Fields (scheduleDate and scheduleQty) - CRITICAL FOR NEW LINE ITEMS
      console.log('üßπ clearLineItemForm: Clearing all schedule fields for new line item');
      for (let i = 1; i <= 5; i++) {
        const checkbox = document.getElementById(`schedule${i}`);
        const scheduleDateField = document.getElementById(`lineScheduleDate${i}`);
        const scheduleQtyField = document.getElementById(`lineScheduleQty${i}`);
        
        if (checkbox) checkbox.checked = false;
        
        if (scheduleDateField) {
          scheduleDateField.value = '';
          scheduleDateField.removeAttribute('data-user-edited'); // Reset user-edited state
          console.log(`üßπ clearLineItemForm: Cleared lineScheduleDate${i}`);
        }
        
        if (scheduleQtyField) {
          scheduleQtyField.value = '';
          scheduleQtyField.removeAttribute('data-user-edited'); // Reset user-edited state
          console.log(`üßπ clearLineItemForm: Cleared lineScheduleQty${i}`);
        }
        
        // Also clear legacy schedule fields if they exist
        const legacyDate = document.getElementById(`scheduleDate${i}`);
        if (legacyDate) {
          legacyDate.value = '';
          console.log(`üßπ clearLineItemForm: Cleared legacy scheduleDate${i}`);
        }
      }
      
      // Clear receiving fields
      const receivingDate = document.getElementById('receivingDate');
      if (receivingDate) receivingDate.value = '';
      
      const receivingQty = document.getElementById('receivingQty');
      if (receivingQty) receivingQty.value = '';
      
      const receivingNumber = document.getElementById('receivingNumber');
      if (receivingNumber) receivingNumber.value = '';
      
      // Clear VWHSE transfer
      const vwhseTransfer = document.getElementById('vwhseTransfer');
      if (vwhseTransfer) vwhseTransfer.value = '';
      
      // Clear change reason
      const changeReason = document.getElementById('changeReason');
      if (changeReason) changeReason.value = '';
    }

    function calculateLineTotal() {
      const quantity = parseFloat(document.getElementById('lineQuantity').value) || 0;
      const unitPrice = parseFloat(document.getElementById('lineUnitPrice').value) || 0;
      const total = quantity * unitPrice;
      document.getElementById('lineTotal').textContent = total.toFixed(2);
    }

    // ========== PART NUMBER LOOKUP FROM PARTS DATABASE ==========
    function handlePartNumberKeyDown(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        lookupPartInfo();
      }
    }

    function lookupPartInfo() {
      const partNumberInput = document.getElementById('linePartNumber');
      const partNumber = partNumberInput?.value.trim().toUpperCase();
      
      if (!partNumber) {
        console.log('‚ö†Ô∏è No part number entered');
        return;
      }
      
      console.log('üîç Looking up part:', partNumber);
      
      // Show loading state
      partNumberInput.style.backgroundColor = '#fef3c7';
      partNumberInput.style.borderColor = '#f59e0b';
      
      const xhr = new XMLHttpRequest();
      const url = `GET_PART.XML?PART_NUMBER=${encodeURIComponent(partNumber)}&_cb=${Date.now()}`;
      console.log('üì° Fetching from:', url);
      
      xhr.open('GET', url, true);
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            try {
              console.log('üì• Raw XML response:', xhr.responseText);
              
              const parser = new DOMParser();
              const xmlDoc = parser.parseFromString(xhr.responseText, 'text/xml');
              
              // Check for parsing errors
              const parseError = xmlDoc.querySelector('parsererror');
              if (parseError) {
                console.error('‚ùå XML Parse Error:', parseError.textContent);
              }
              
              const part = xmlDoc.querySelector('part');
              
              // Try multiple methods to get status
              console.log('üîç DEBUG: Trying to find status...');
              
              // Method 1: getElementsByTagName
              const statusElements = xmlDoc.getElementsByTagName('status');
              console.log('  Method 1 (getElementsByTagName):', statusElements.length, 'elements');
              
              // Method 2: querySelectorAll
              const statusQuery = xmlDoc.querySelectorAll('status');
              console.log('  Method 2 (querySelectorAll):', statusQuery.length, 'elements');
              
              // Method 3: Direct regex search in text
              const statusMatch = xhr.responseText.match(/<status>([^<]+)<\/status>/g);
              console.log('  Method 3 (regex):', statusMatch ? statusMatch.length : 0, 'matches');
              if (statusMatch) {
                console.log('  Regex found:', statusMatch);
              }
              
              // Use regex method as fallback since DOM methods are failing
              let status = null;
              if (statusMatch && statusMatch.length > 0) {
                // Get the last match (which is the one at part_info level)
                const lastMatch = statusMatch[statusMatch.length - 1];
                status = lastMatch.replace(/<\/?status>/g, '').trim();
                console.log('  ‚úÖ Extracted status from regex:', status);
              }
              
              console.log('üîç Final Status from XML:', status);
              
              if (status === 'found' && part) {
                const description = part.querySelector('description')?.textContent || '';
                const uom = part.querySelector('uom')?.textContent || '';
                const poDescription = part.querySelector('po_description')?.textContent || '';
                const productTime = part.querySelector('product_time')?.textContent || '';
                const leadTime = part.querySelector('lead_time')?.textContent || '';
                const supplierNumber = part.querySelector('supplier_number')?.textContent || '';
                const safetyStock = part.querySelector('safety_stock')?.textContent || '';
                
                console.log('‚úÖ Part found:');
                console.log('  Description:', description || '(empty)');
                console.log('  PO Description:', poDescription || '(empty)');
                console.log('  UOM:', uom || '(empty)');
                console.log('  Product Time:', productTime || '(empty)');
                console.log('  Lead Time:', leadTime || '(empty)');
                console.log('  Supplier:', supplierNumber || '(empty)');
                console.log('  Safety Stock:', safetyStock || '(empty)');
                
                // Auto-fill description (prefer po_description, then description)
                const descField = document.getElementById('lineDescription');
                if (descField) {
                  const finalDesc = poDescription || description;
                  if (finalDesc) {
                    descField.value = finalDesc;
                    descField.readOnly = true;
                    descField.style.backgroundColor = '#f1f5f9';
                    descField.style.color = '#475569';
                  } else {
                    // Description empty - keep editable
                    descField.readOnly = false;
                    descField.style.backgroundColor = '#fef3c7'; // Yellow to indicate needs input
                    descField.placeholder = 'Description not in database - please enter';
                  }
                }
                
                // Auto-fill UOM
                const uomField = document.getElementById('lineUOM');
                if (uomField) {
                  if (uom) {
                    uomField.value = uom;
                    uomField.readOnly = true;
                    uomField.style.backgroundColor = '#f1f5f9';
                    uomField.style.color = '#475569';
                  } else {
                    // UOM empty - keep editable
                    uomField.readOnly = false;
                    uomField.style.backgroundColor = '#fef3c7'; // Yellow to indicate needs input
                    uomField.placeholder = 'UOM not in database - please enter';
                  }
                }
                
                // Success state
                partNumberInput.style.backgroundColor = '#d1fae5';
                partNumberInput.style.borderColor = '#10b981';
                
                // Build notification message
                let notifMsg = `‚úÖ Part ${partNumber} found in PARTS database`;
                const extraInfo = [];
                if (productTime) extraInfo.push(`Time: ${productTime}`);
                if (leadTime) extraInfo.push(`Lead: ${leadTime}`);
                if (supplierNumber) extraInfo.push(`Supplier: ${supplierNumber}`);
                if (extraInfo.length > 0) {
                  notifMsg += ` (${extraInfo.join(', ')})`;
                }
                
                showNotification(notifMsg, 'success');
                
                // Focus on next empty required field
                setTimeout(() => {
                  if (!description && !poDescription) {
                    descField?.focus();
                  } else if (!uom) {
                    uomField?.focus();
                  } else {
                    const qtyField = document.getElementById('lineQuantity');
                    if (qtyField) qtyField.focus();
                  }
                }, 100);
                
                // Auto-lookup price if quantity is already filled
                setTimeout(() => {
                  const qtyField = document.getElementById('lineQuantity');
                  const qty = parseFloat(qtyField?.value) || 0;
                  if (qty > 0) {
                    console.log('üîÑ Quantity already filled, triggering price lookup...');
                    lookupPriceFromDatabase();
                  }
                }, 200);
                
              } else {
                // Part not found
                console.log('‚ö†Ô∏è Part not found in database');
                partNumberInput.style.backgroundColor = '#fee2e2';
                partNumberInput.style.borderColor = '#ef4444';
                
                // Make fields editable since part doesn't exist in database
                const descField = document.getElementById('lineDescription');
                if (descField) {
                  descField.readOnly = false;
                  descField.style.backgroundColor = '';
                  descField.style.color = '';
                }
                
                const uomField = document.getElementById('lineUOM');
                if (uomField) {
                  uomField.readOnly = false;
                  uomField.style.backgroundColor = '';
                  uomField.style.color = '';
                }
                
                showNotification(`‚ö†Ô∏è Part ${partNumber} not found in PARTS database. Please enter details manually.`, 'warning');
              }
              
            } catch (error) {
              console.error('‚ùå Error parsing XML:', error);
              partNumberInput.style.backgroundColor = '#fee2e2';
              partNumberInput.style.borderColor = '#ef4444';
              showNotification('‚ùå Error loading part information', 'error');
            }
          } else {
            console.error('‚ùå HTTP Error:', xhr.status);
            partNumberInput.style.backgroundColor = '#fee2e2';
            partNumberInput.style.borderColor = '#ef4444';
            showNotification('‚ùå Error connecting to PARTS database', 'error');
          }
          
          // Reset border color after 2 seconds
          setTimeout(() => {
            partNumberInput.style.backgroundColor = '';
            partNumberInput.style.borderColor = '';
          }, 2000);
        }
      };
      
      xhr.send();
    }

    // ========== PRICE LOOKUP FROM PRICE DATABASE WITH RANGES ==========
    function lookupPriceFromDatabase() {
      const partNumberInput = document.getElementById('linePartNumber');
      const quantityInput = document.getElementById('lineQuantity');
      const unitPriceInput = document.getElementById('lineUnitPrice');
      
      // IMPORTANT: Use Bill To code from shipToCodeInput (not customerCodeInput which is Ship To)
      const billToInput = document.getElementById('shipToCodeInput');
      
      const partNumber = partNumberInput?.value.trim().toUpperCase();
      const quantity = parseFloat(quantityInput?.value) || 0;
      // Get Bill To code (this is the customer for pricing)
      const customerCode = billToInput?.value.trim();
      
      console.log('üîç DEBUG lookupPriceFromDatabase:');
      console.log('  Part Number:', partNumber);
      console.log('  Quantity:', quantity);
      console.log('  Bill To Code (from shipToCodeInput):', customerCode);
      
      // Validations
      if (!partNumber) {
        console.log('‚ö†Ô∏è No part number - skipping price lookup');
        return;
      }
      
      if (!customerCode) {
        console.log('‚ö†Ô∏è No Bill To code - skipping price lookup');
        console.log('   Hint: Bill To code should be in shipToCodeInput field');
        return;
      }
      
      if (quantity <= 0) {
        console.log('‚ö†Ô∏è Invalid quantity - skipping price lookup');
        return;
      }
      
      console.log('üí∞ Looking up price for:', {
        partNumber,
        customerCode,
        quantity
      });
      
      // Show loading state
      if (unitPriceInput) {
        unitPriceInput.style.backgroundColor = '#fef3c7';
        unitPriceInput.style.borderColor = '#f59e0b';
      }
      
      const xhr = new XMLHttpRequest();
      const url = `GET_PRICE.XML?PART_NUMBER=${encodeURIComponent(partNumber)}&CUSTOMER_NUMBER=${encodeURIComponent(customerCode)}&QTY=${quantity}&_cb=${Date.now()}`;
      console.log('üì° Fetching price from:', url);
      
      xhr.open('GET', url, true);
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            try {
              console.log('üì• Raw XML response from GET_PRICE:', xhr.responseText.substring(0, 500));
              
              const parser = new DOMParser();
              const xmlDoc = parser.parseFromString(xhr.responseText, 'text/xml');
              
              const status = xmlDoc.querySelector('status')?.textContent;
              const priceKey = xmlDoc.querySelector('price_key')?.textContent;
              
              console.log(`  Status: ${status}`);
              console.log(`  Price Key: ${priceKey}`);
              
              if (status === 'found') {
                // Price found and matched
                const foundPrice = parseFloat(xmlDoc.querySelector('unit_price')?.textContent) || 0;
                const matchedRange = xmlDoc.querySelector('matched_range')?.textContent;
                
                console.log(`‚úÖ Found price: $${foundPrice} (Range #${matchedRange})`);
                
                // Auto-fill unit price
                if (unitPriceInput) {
                  unitPriceInput.value = foundPrice.toFixed(4);
                  unitPriceInput.style.backgroundColor = '#d1fae5';
                  unitPriceInput.style.borderColor = '#10b981';
                }
                
                // Recalculate total
                calculateLineTotal();
                
                showNotification(`‚úÖ Price found: $${foundPrice.toFixed(4)} for qty ${quantity}`, 'success');
                
                setTimeout(() => {
                  if (unitPriceInput) {
                    unitPriceInput.style.backgroundColor = '';
                    unitPriceInput.style.borderColor = '';
                  }
                }, 2000);
                
              } else if (status === 'not_found') {
                // No price record exists for this PART*CUSTOMER combination
                const message = xmlDoc.querySelector('message')?.textContent || 'No price record found';
                console.log(`‚ö†Ô∏è ${message}`);
                
                if (unitPriceInput) {
                  unitPriceInput.style.backgroundColor = '#fee2e2';
                  unitPriceInput.style.borderColor = '#ef4444';
                }
                showNotification(`‚ö†Ô∏è ${message}`, 'warning');
                
                setTimeout(() => {
                  if (unitPriceInput) {
                    unitPriceInput.style.backgroundColor = '';
                    unitPriceInput.style.borderColor = '';
                  }
                }, 2000);
                
              } else if (status === 'no_match') {
                // Price record exists but quantity doesn't fall in any range
                const message = xmlDoc.querySelector('message')?.textContent || 'Quantity not in any price range';
                console.log(`‚ö†Ô∏è ${message}`);
                
                if (unitPriceInput) {
                  unitPriceInput.style.backgroundColor = '#fef3c7';
                  unitPriceInput.style.borderColor = '#f59e0b';
                }
                showNotification(`‚ö†Ô∏è ${message}`, 'warning');
                
                setTimeout(() => {
                  if (unitPriceInput) {
                    unitPriceInput.style.backgroundColor = '';
                    unitPriceInput.style.borderColor = '';
                  }
                }, 2000);
                
              } else if (status === 'no_ranges') {
                // Record exists but has no price ranges defined
                console.log('‚ö†Ô∏è No price ranges defined');
                
                if (unitPriceInput) {
                  unitPriceInput.style.backgroundColor = '#fee2e2';
                  unitPriceInput.style.borderColor = '#ef4444';
                }
                showNotification(`‚ö†Ô∏è No price ranges defined for ${priceKey}`, 'warning');
                
                setTimeout(() => {
                  if (unitPriceInput) {
                    unitPriceInput.style.backgroundColor = '';
                    unitPriceInput.style.borderColor = '';
                  }
                }, 2000);
                
              } else {
                // Error or unknown status
                const errorMsg = xmlDoc.querySelector('error')?.textContent || 'Unknown error';
                console.log(`‚ùå Error: ${errorMsg}`);
                
                if (unitPriceInput) {
                  unitPriceInput.style.backgroundColor = '#fee2e2';
                  unitPriceInput.style.borderColor = '#ef4444';
                }
                showNotification(`‚ùå ${errorMsg}`, 'error');
                
                setTimeout(() => {
                  if (unitPriceInput) {
                    unitPriceInput.style.backgroundColor = '';
                    unitPriceInput.style.borderColor = '';
                  }
                }, 2000);
              }
              
            } catch (error) {
              console.error('‚ùå Error parsing price XML:', error);
              if (unitPriceInput) {
                unitPriceInput.style.backgroundColor = '#fee2e2';
                unitPriceInput.style.borderColor = '#ef4444';
              }
              showNotification('‚ùå Error loading price information', 'error');
              
              setTimeout(() => {
                if (unitPriceInput) {
                  unitPriceInput.style.backgroundColor = '';
                  unitPriceInput.style.borderColor = '';
                }
              }, 2000);
            }
          } else {
            console.error('‚ùå HTTP Error:', xhr.status);
            if (unitPriceInput) {
              unitPriceInput.style.backgroundColor = '#fee2e2';
              unitPriceInput.style.borderColor = '#ef4444';
            }
            showNotification('‚ùå Error connecting to PRICE database', 'error');
            
            setTimeout(() => {
              if (unitPriceInput) {
                unitPriceInput.style.backgroundColor = '';
                unitPriceInput.style.borderColor = '';
              }
            }, 2000);
          }
        }
      };
      
      xhr.send();
    }

    function addLineItem() {
      const lineNumber = parseInt(document.getElementById('lineNumber').value);
      const partNumber = document.getElementById('linePartNumber').value.trim();
      const description = document.getElementById('lineDescription').value.trim();
      const quantity = parseFloat(document.getElementById('lineQuantity').value);
      const unitPrice = parseFloat(document.getElementById('lineUnitPrice').value);
      
      // Additional fields (only those that exist in the HTML)
      const uom = document.getElementById('lineUOM')?.value.trim() || '';
      const lineNotes = document.getElementById('lineNotes')?.value.trim() || '';
      console.log(`üìù CAPTURED UOM: "${uom}"`);
      console.log(`üìù CAPTURED LINE NOTES from textarea: "${lineNotes}"`);
      const prodNotes = document.getElementById('lineProdNotes')?.value.trim() || '';
      console.log(`üìù CAPTURED PRODUCTION NOTES from textarea: "${prodNotes}"`);
      const firstArticle = 'N'; // Field doesn't exist in HTML
      const docRev = ''; // Field doesn't exist in HTML
      const vendPT = ''; // Field doesn't exist in HTML
      const govtRating = ''; // Field doesn't exist in HTML
      const govtContract = ''; // Field doesn't exist in HTML

      // Validation
      if (!partNumber || !description || isNaN(quantity) || isNaN(unitPrice)) {
        alert('Please fill in all required fields (Part Number, Description, Quantity, Unit Price)');
        return;
      }

      // Check for duplicate line numbers only when adding new items
      if (editingLineIndex === -1) {
        const existingLine = lineItems.find(item => item.lineNumber === lineNumber);
        if (existingLine) {
          alert('Line number already exists. Please use a different line number.');
          return;
        }
      }

      // Collect Need Info data (convert dates to Julian format) - DYNAMIC (all rows)
      const needData = [];
      let needIdx = 1;
      while (true) {
        const dateEl = document.getElementById(`needDate${needIdx}`);
        const qtyEl = document.getElementById(`needQty${needIdx}`);
        if (!dateEl || !qtyEl) break; // No more fields
        
        if (dateEl.value && qtyEl.value) {
          const julianDate = convertDateToJulian(dateEl.value);
          needData.push(`${julianDate}~${qtyEl.value}`);
          console.log(`üìÖ Captured need ${needIdx}: ${dateEl.value} ‚Üí Julian: ${julianDate}, qty: ${qtyEl.value}`);
        }
        needIdx++;
      }
      console.log(`üìä Total needs captured: ${needData.length} from ${needIdx - 1} rows`);

      // Collect Acknowledgment data (convert dates to Julian format) - DYNAMIC (all rows)
      const ackData = [];
      let ackIdx = 1;
      while (true) {
        const dateEl = document.getElementById(`ackDate${ackIdx}`);
        const qtyEl = document.getElementById(`ackQty${ackIdx}`);
        if (!dateEl || !qtyEl) break; // No more fields
        
        if (dateEl.value && qtyEl.value) {
          const julianDate = convertDateToJulian(dateEl.value);
          ackData.push(`${julianDate}~${qtyEl.value}`);
          console.log(`üìÖ Captured ack ${ackIdx}: ${dateEl.value} ‚Üí Julian: ${julianDate}, qty: ${qtyEl.value}`);
        }
        ackIdx++;
      }
      console.log(`üìä Total acks captured: ${ackData.length} from ${ackIdx - 1} rows`);

      // Collect Schedule data (convert dates to Julian format) - DYNAMIC (all rows)
      const schedData = [];
      let schedIdx = 1;
      while (true) {
        const dateEl = document.getElementById(`lineScheduleDate${schedIdx}`);
        const qtyEl = document.getElementById(`lineScheduleQty${schedIdx}`);
        const rsEl = document.getElementById(`lineRS${schedIdx}`);
        if (!dateEl || !qtyEl) break; // No more fields
        
        if (dateEl.value && qtyEl.value) {
          const julianDate = convertDateToJulian(dateEl.value);
          const rsFlag = rsEl && rsEl.checked ? 'Y' : '';
          schedData.push(`${julianDate}~${qtyEl.value}~${rsFlag}`);
          console.log(`üìÖ Captured schedule ${schedIdx}: ${dateEl.value} ‚Üí Julian: ${julianDate}, qty: ${qtyEl.value}, RS: ${rsFlag}`);
        }
        schedIdx++;
      }
      console.log(`üìä Total schedules captured: ${schedData.length} from ${schedIdx - 1} rows`);

      // Collect VWHSE data (fields don't exist in HTML)
      const vwhseData = [];
      const vwhseIdEl = document.getElementById('vwhseId');
      const vwhseQtyEl = document.getElementById('vwhseQty');
      if (vwhseIdEl && vwhseQtyEl && vwhseIdEl.value && vwhseQtyEl.value) {
        vwhseData.push(`${vwhseIdEl.value}~${vwhseQtyEl.value}`);
      }

      // Convert string arrays to entry objects for backend compatibility
      const needEntries = needData.map(entry => {
        const [julianDate, qty] = entry.split('~');
        return { date: julianDate, qty: qty };
      });
      
      const scheduleEntries = schedData.map(entry => {
        const [julianDate, qty, rsFlag] = entry.split('~');
        return { date: julianDate, qty: qty, rs: rsFlag || '' };
      });
      
      const ackEntries = ackData.map(entry => {
        const [julianDate, qty] = entry.split('~');
        return { date: julianDate, qty: qty };
      });
      
      console.log(`üìã Converted to entry objects:`);
      console.log(`   needEntries (${needEntries.length}):`, needEntries);
      console.log(`   scheduleEntries (${scheduleEntries.length}):`, scheduleEntries);
      console.log(`   ackEntries (${ackEntries.length}):`, ackEntries);
      
      const lineItem = {
        lineNumber: lineNumber,
        partNumber: partNumber,
        description: description,
        quantity: quantity,
        baseQuantity: quantity,
        quantityDisplay: String(quantity),
        unitPrice: unitPrice,
        uom: uom,
        total: quantity * unitPrice,
        docRev: docRev,
        vendPT: vendPT,
        lineNotes: lineNotes,
        prodNotes: prodNotes,
        firstArticle: firstArticle,
        govtRating: govtRating,
        govtContract: govtContract,
        needData: needData.join('\\'),
        ackData: ackData.join('\\'),
        schedData: schedData.join('\\'),
        vwhseData: vwhseData.join('\\'),
        needEntries: needEntries,
        ackEntries: ackEntries,
        scheduleEntries: scheduleEntries,
        scheduleDate: '',
        scheduleQty: '',
        scheduleQtyNumeric: null,
        needDate: '',
        needQty: '',
        needQtyNumeric: null,
        ackDate: '',
        ackQty: '',
        ackQtyNumeric: null,
        unitPriceIsCents: false,
        totalIsCents: false
      };

      if (schedData.length > 0) {
        const firstSched = schedData[0].split('~');
        if (firstSched[0]) {
          lineItem.scheduleDate = firstSched[0];
        }
        if (firstSched[1]) {
          lineItem.scheduleQty = firstSched[1];
          const schedNum = parseFloat(firstSched[1]);
          lineItem.scheduleQtyNumeric = Number.isFinite(schedNum) ? schedNum : null;
        }
      }

      if (needData.length > 0) {
        const firstNeed = needData[0].split('~');
        if (firstNeed[0]) {
          lineItem.needDate = firstNeed[0];
        }
        if (firstNeed[1]) {
          lineItem.needQty = firstNeed[1];
          const needNum = parseFloat(firstNeed[1]);
          lineItem.needQtyNumeric = Number.isFinite(needNum) ? needNum : null;
        }
      }

      if (ackData.length > 0) {
        const firstAck = ackData[0].split('~');
        if (firstAck[0]) {
          lineItem.ackDate = firstAck[0];
        }
        if (firstAck[1]) {
          lineItem.ackQty = firstAck[1];
          const ackNum = parseFloat(firstAck[1]);
          lineItem.ackQtyNumeric = Number.isFinite(ackNum) ? ackNum : null;
        }
      }

      console.log('üîß addLineItem: About to save/update line item...');
      console.log(`üìù LINE ITEM lineNotes VALUE: "${lineItem.lineNotes}"`);
      
      // Set flag to prevent automatic selectLineItemForTracking during this process
      window.isAddingLineItem = true;
      window.isAddingLineItemTimestamp = Date.now();
      
      if (editingLineIndex >= 0) {
        // Update existing line item - preserve original properties
        console.log('üîß addLineItem: Updating existing line item at index', editingLineIndex);
        const existingItem = lineItems[editingLineIndex];
        
        // Merge new data with existing properties
        lineItems[editingLineIndex] = {
          ...existingItem,  // Keep original properties like unitPriceIsCents, totalIsCents
          ...lineItem,      // Update with new values
          // Recalculate total with proper cents handling
          total: existingItem.unitPriceIsCents ? 
                 (lineItem.unitPrice * 100 * lineItem.quantity) : 
                 (lineItem.unitPrice * lineItem.quantity)
        };
        
        console.log('‚úÖ addLineItem: Line item updated successfully');
        // alert('Line item updated successfully!'); // TEMPORARILY DISABLED - was causing UI to blank
      } else {
        // Add new line item
        console.log('üîß addLineItem: Adding new line item');
        lineItems.push(lineItem);
        console.log('‚úÖ addLineItem: Line item added successfully');
        // alert('Line item added successfully!'); // TEMPORARILY DISABLED - was causing UI to blank
      }
      
      console.log('üîß addLineItem: About to call renderLineItems()...');
      console.log('üîç addLineItem: lineItems array before render:', lineItems);
      console.log('üîç addLineItem: lineItems length before render:', lineItems ? lineItems.length : 'NULL');
      try {
        renderLineItems();
        console.log('‚úÖ addLineItem: renderLineItems() completed');
        console.log('üîç addLineItem: lineItems array after render:', lineItems);
        console.log('üîç addLineItem: lineItems length after render:', lineItems ? lineItems.length : 'NULL');
      } catch (error) {
        console.error('‚ùå addLineItem: Error in renderLineItems():', error);
      }
      
      console.log('üîß addLineItem: About to call closeAddLineItemModal()...');
      try {
        closeAddLineItemModal();
        console.log('‚úÖ addLineItem: closeAddLineItemModal() completed');
      } catch (error) {
        console.error('‚ùå addLineItem: Error in closeAddLineItemModal():', error);
      }
      
      console.log('üîß addLineItem: About to call updatePOTotals()...');
      try {
        updatePOTotals();
        console.log('‚úÖ addLineItem: updatePOTotals() completed');
      } catch (error) {
        console.error('‚ùå addLineItem: Error in updatePOTotals():', error);
      }
      
      // Reset editing state
      editingLineIndex = -1;
      console.log('‚úÖ addLineItem: Process completed successfully');
      
      // Auto-save line items to backend
      saveLineItems().then(() => {
        console.log('‚úÖ Line item saved to backend successfully');
      }).catch(error => {
        console.error('‚ùå Error saving line item to backend:', error);
        alert('Line item added to form but failed to save to backend. Please try again.');
      });
      
      // Clear the flag after a short delay to ensure all automatic calls are blocked
      setTimeout(() => {
        window.isAddingLineItem = false;
        window.isAddingLineItemTimestamp = null;
        console.log('üîì Cleared isAddingLineItem flag - manual selection now allowed');
        
        // DEBUG: Check if content is still there after everything completes
        setTimeout(() => {
          const lineItemsBody = document.getElementById('lineItemsBody');
          const lineItemsTable = document.getElementById('lineItemsTable');
          console.log('üîç FINAL CHECK - lineItemsBody innerHTML length:', lineItemsBody?.innerHTML?.length);
          console.log('üîç FINAL CHECK - lineItemsBody visible:', lineItemsBody?.offsetHeight > 0);
          console.log('üîç FINAL CHECK - lineItemsTable visible:', lineItemsTable?.offsetHeight > 0);
          
          if (lineItemsBody && lineItemsBody.innerHTML.length > 100 && lineItemsBody.offsetHeight === 0) {
            console.log('üö® PROBLEM DETECTED: Content exists but not visible - forcing display');
            
            // Debug ALL parent containers
            const tab2 = document.getElementById('tab-2');
            const formContainer = tab2?.querySelector('.form-container');
            
            console.log('üîç DEBUGGING PARENTS:');
            console.log('  - tab-2 visible:', tab2?.offsetHeight > 0);
            console.log('  - tab-2 display:', window.getComputedStyle(tab2)?.display);
            console.log('  - formContainer visible:', formContainer?.offsetHeight > 0);
            console.log('  - formContainer display:', window.getComputedStyle(formContainer)?.display);
            
            // Debug even higher containers
            const tabContent = document.querySelector('.tab-content');
            const mainContent = document.querySelector('.main-content');
            const container = document.querySelector('.container');
            
            console.log('üîç DEBUGGING HIGHER CONTAINERS:');
            console.log('  - tab-content visible:', tabContent?.offsetHeight > 0);
            console.log('  - tab-content display:', window.getComputedStyle(tabContent)?.display);
            console.log('  - main-content visible:', mainContent?.offsetHeight > 0);
            console.log('  - container visible:', container?.offsetHeight > 0);
            
            // Check z-index issues
            console.log('üîç Z-INDEX DEBUGGING:');
            console.log('  - lineItemsBody z-index:', window.getComputedStyle(lineItemsBody)?.zIndex);
            console.log('  - lineItemsTable z-index:', window.getComputedStyle(lineItemsTable)?.zIndex);
            console.log('  - tab-2 z-index:', window.getComputedStyle(tab2)?.zIndex);
            
            // Force EVERYTHING to be visible - from top to bottom
            if (container) {
              container.style.display = 'flex !important';
              container.style.visibility = 'visible !important';
            }
            if (mainContent) {
              mainContent.style.display = 'flex !important';
              mainContent.style.visibility = 'visible !important';
            }
            if (tabContent) {
              tabContent.style.display = 'block !important';
              tabContent.style.visibility = 'visible !important';
            }
            if (tab2) {
              tab2.style.display = 'block !important';
              tab2.style.visibility = 'visible !important';
              tab2.style.minHeight = '200px !important';
              tab2.style.position = 'static !important';
              tab2.style.zIndex = '1 !important';
            }
            if (formContainer) {
              formContainer.style.display = 'block !important';
              formContainer.style.visibility = 'visible !important';
              formContainer.style.minHeight = '200px !important';
            }
            
            lineItemsBody.style.display = 'block';
            lineItemsBody.style.minHeight = '100px';
            lineItemsBody.style.visibility = 'visible';
            lineItemsTable.style.display = 'block';
            lineItemsTable.style.minHeight = '100px';
            lineItemsTable.style.visibility = 'visible';
            console.log('‚úÖ Applied emergency visibility fix to ALL containers');
          }
        }, 200);
      }, 100);
    }


    function editLineItem(index) {
      console.log(`üîß Starting editLineItem(${index})`);
      const lineItem = lineItems[index];
      if (!lineItem) {
        console.error(`‚ùå Line item at index ${index} not found`);
        return;
      }
      
      editingLineIndex = index;
      console.log(`‚úÖ Set editingLineIndex = ${editingLineIndex}`);
      
      // Switch to Line Items tab for editing
      switchTab(2);
      
      // Add a small delay to ensure the tab switch completes
      setTimeout(() => {
        try {
          console.log(`üìã Selected line item data:`, lineItem);
          
          // Fill form with existing data - with null checks
          const lineNumberField = document.getElementById('lineNumber');
          if (lineNumberField) {
            lineNumberField.value = lineItem.lineNumber;
            console.log(`‚úÖ Set Line Number: ${lineItem.lineNumber}`);
          } else {
            console.warn(`‚ö†Ô∏è lineNumber field not found`);
          }
          
          const partNumberField = document.getElementById('linePartNumber');
          if (partNumberField) {
            partNumberField.value = lineItem.partNumber;
            console.log(`‚úÖ Set Part Number: ${lineItem.partNumber}`);
          } else {
            console.warn(`‚ö†Ô∏è linePartNumber field not found`);
          }
          
          const descriptionField = document.getElementById('lineDescription');
          if (descriptionField) {
            descriptionField.value = lineItem.description;
          } else {
            console.warn(`‚ö†Ô∏è lineDescription field not found`);
          }
          
          const quantityField = document.getElementById('lineQuantity');
          if (quantityField) {
            quantityField.value = lineItem.quantity;
          } else {
            console.warn(`‚ö†Ô∏è lineQuantity field not found`);
          }
          
          const unitPriceField = document.getElementById('lineUnitPrice');
          if (unitPriceField) {
            unitPriceField.value = lineItem.unitPrice;
          } else {
            console.warn(`‚ö†Ô∏è lineUnitPrice field not found`);
          }
          
          const uomField = document.getElementById('lineUOM');
          console.log(`üîç DEBUG UOM: lineItem.uom="${lineItem.uom}", uomField=`, uomField);
          if (uomField) {
            uomField.value = lineItem.uom || '';
            console.log(`‚úÖ Set UOM: ${lineItem.uom || '(empty)'}`);
          } else {
            console.warn(`‚ö†Ô∏è lineUOM field not found`);
          }
          
          const totalField = document.getElementById('lineTotal');
          if (totalField) {
            totalField.value = lineItem.total ? lineItem.total.toFixed(2) : '0.00';
          } else {
            console.warn(`‚ö†Ô∏è lineTotal field not found`);
          }
          
          const lineNotesField = document.getElementById('lineNotes');
          if (lineNotesField) {
            lineNotesField.value = lineItem.lineNotes || '';
            console.log(`‚úÖ Set Line Notes: ${lineItem.lineNotes || '(empty)'}`);
          } else {
            console.warn(`‚ö†Ô∏è lineNotes field not found`);
          }
          
          const prodNotesField = document.getElementById('lineProdNotes');
          if (prodNotesField) {
            prodNotesField.value = lineItem.prodNotes || '';
            console.log(`‚úÖ Set Production Notes: ${lineItem.prodNotes || '(empty)'}`);
          } else {
            console.warn(`‚ö†Ô∏è lineProdNotes field not found`);
          }
          
          // Clear all need fields first
          console.log(`üßπ Clearing need fields...`);
          for (let i = 1; i <= 5; i++) {
            const dateField = document.getElementById(`needDate${i}`);
            const qtyField = document.getElementById(`needQty${i}`);
            if (dateField) dateField.value = '';
            if (qtyField) qtyField.value = '';
          }
          
          // Populate need data if available (format: "julianDate~qty\\julianDate~qty")
          console.log(`üîç DEBUG editLineItem: lineItem.needData = "${lineItem.needData}"`);
          console.log(`üîç DEBUG editLineItem: lineItem.schedData = "${lineItem.schedData}"`);
          console.log(`üîç DEBUG editLineItem: lineItem.lineNotes = "${lineItem.lineNotes}"`);
          
          if (lineItem.needData && lineItem.needData.length > 0) {
            console.log(`üìÖ Populating need data for ${lineItem.partNumber}: ${lineItem.needData}`);
            const needEntries = lineItem.needData.split('\\').filter(e => e.trim());
            console.log(`üìÖ Split into ${needEntries.length} entries:`, needEntries);
            
            // Create additional rows if needed (beyond the initial 5)
            while (needRowCount < needEntries.length) {
              needRowCount++;
              addNeedRowInternal(needRowCount);
              console.log(`‚ûï Created additional need row ${needRowCount}`);
            }
            
            needEntries.forEach((entry, idx) => {
              const [julianDate, qty] = entry.split('~');
              const formattedDate = convertJulianToDate(julianDate);
              const dateField = document.getElementById(`needDate${idx + 1}`);
              const qtyField = document.getElementById(`needQty${idx + 1}`);
              console.log(`üìÖ Processing entry ${idx}: julian=${julianDate}, formatted=${formattedDate}, qty=${qty}`);
              if (dateField && formattedDate) {
                dateField.value = formattedDate;
                console.log(`‚úÖ Set needDate${idx + 1}: ${formattedDate} (from Julian: ${julianDate})`);
              }
              if (qtyField && qty) {
                qtyField.value = qty;
                console.log(`‚úÖ Set needQty${idx + 1}: ${qty}`);
              }
            });
          } else {
            console.log(`‚ö†Ô∏è No needData found or empty for ${lineItem.partNumber}`);
          }
          
          // Clear all schedule fields first
          console.log(`üßπ Clearing schedule fields...`);
          for (let i = 1; i <= 5; i++) {
            const dateField = document.getElementById(`lineScheduleDate${i}`);
            const qtyField = document.getElementById(`lineScheduleQty${i}`);
            if (dateField) dateField.value = '';
            if (qtyField) qtyField.value = '';
          }
          
          // Populate schedule data if available (format: "julianDate~qty~rs\\julianDate~qty~rs")
          if (lineItem.schedData && lineItem.schedData.length > 0) {
            console.log(`üìÖ Populating schedule data for ${lineItem.partNumber}: ${lineItem.schedData}`);
            const schedEntries = lineItem.schedData.split('\\').filter(e => e.trim());
            
            // Create additional rows if needed (beyond the initial 5)
            while (schedRowCount < schedEntries.length) {
              schedRowCount++;
              addSchedRowInternal(schedRowCount);
              console.log(`‚ûï Created additional schedule row ${schedRowCount}`);
            }
            
            schedEntries.forEach((entry, idx) => {
              const [julianDate, qty, rsFlag] = entry.split('~');
              const formattedDate = convertJulianToDate(julianDate);
              const dateField = document.getElementById(`lineScheduleDate${idx + 1}`);
              const qtyField = document.getElementById(`lineScheduleQty${idx + 1}`);
              if (dateField && formattedDate) {
                dateField.value = formattedDate;
                console.log(`‚úÖ Set lineScheduleDate${idx + 1}: ${formattedDate} (from Julian: ${julianDate})`);
              }
              if (qtyField && qty) {
                qtyField.value = qty;
                console.log(`‚úÖ Set lineScheduleQty${idx + 1}: ${qty}`);
              }
            });
          }
          
          // Switch to specific line items tab
          if (typeof window.switchLineTab === 'function') { 
            window.switchLineTab(0); 
          }
          
          // Calculate and display line total
          calculateLineTotal();
          
          console.log(`‚úÖ editLineItem(${index}) completed successfully`);
        } catch (error) {
          console.error(`‚ùå Error populating line item form:`, error);
        }
      }, 100); // Small delay to ensure DOM is ready
    }

    function updateLineItem(index, field, value) {
      if (index >= 0 && index < lineItems.length) {
        lineItems[index][field] = value;
        
        // Recalculate total if quantity or unit price changed
        if (field === 'quantity' || field === 'unitPrice') {
          const qty = parseFloat(lineItems[index].quantity) || 0;
          const price = parseFloat(lineItems[index].unitPrice) || 0;
          lineItems[index].total = qty * price;
        }
        
        console.log(`Updated line ${index + 1} ${field} to:`, value);
        updatePOTotals();
      }
    }

    function deleteLineItem(index) {
      if (confirm('¬øEst√° seguro de eliminar este line item?')) {
        lineItems.splice(index, 1);
        renderLineItems();
        updatePOTotals();
      }
    }

    // Function to collect tracking data from manual inputs (user edits)
    function collectTrackingDataFromInputs(isFullSave = false) {
      console.log('üìù üö® COLLECTING TRACKING DATA FROM MANUAL INPUTS - FUNCTION CALLED! üö®');
      console.log('üöÄ CODE UPDATED: Sept 22 2025 3:09pm - BROWSER CACHE ISSUE FIXED!');
      console.log('üîç FUNCTION DEBUG: collectTrackingDataFromInputs() executing...');
      
      // CRITICAL FIX: Initialize currentEditingLineIndex FIRST before using it
      let currentEditingLineIndex = window.editingLineIndex;
      
      // FALLBACK: Try to get from global variables if window.editingLineIndex is lost
      if (typeof currentEditingLineIndex === 'undefined' || currentEditingLineIndex === null || currentEditingLineIndex < 0) {
        currentEditingLineIndex = window.currentEditingLineIndex || window.selectedLineItemIndex || editingLineIndex || 0;
      }
      
      // FORCE VALID INDEX: If still invalid, use 0 (Line Item 1)
      if (typeof currentEditingLineIndex === 'undefined' || currentEditingLineIndex === null || currentEditingLineIndex < 0) {
        currentEditingLineIndex = 0;
        console.log('üîç COLLECT START: FORCED currentEditingLineIndex to 0 (fallback)');
      }
      
      console.log(`üîç CONTEXT DEBUG: isFullSave = ${isFullSave}, currentEditingLineIndex = ${currentEditingLineIndex}`);
      console.log('üîç COLLECT START: currentEditingLineIndex from window:', window.editingLineIndex);
      console.log('üîç COLLECT START: using currentEditingLineIndex:', currentEditingLineIndex);
      
      // CACHE INTEGRATION: Save current data before collecting
      if (editingLineIndex >= 0) {
        saveCurrentTrackingToCache();
      }
      
      // DEBUG: Show cache contents before collecting
      console.log('üîç COLLECT DEBUG: Cache contents before processing:', {
        acknowledgments: lineItemTrackingCache.acknowledgments,
        needs: lineItemTrackingCache.needs,
        schedules: lineItemTrackingCache.schedules,
        cacheSize: {
          acks: Object.keys(lineItemTrackingCache.acknowledgments).length,
          needs: Object.keys(lineItemTrackingCache.needs).length,
          schedules: Object.keys(lineItemTrackingCache.schedules).length
        }
      });
      
      const manualData = {
        needs: [],
        acknowledgments: [],
        schedules: []
      };
      
      // IMPORTANT: This tracking section is NOT per line item - it's aggregate tracking
      // But we need to organize it by line item for the backend to save properly
      
      // Collect Need Info entries (dynamic - supports any number of rows) with position preservation
      const allNeedEntries = [];
      let entryIndex = 1;
      while (true) {
        const needDateField = document.getElementById(`needDate${entryIndex}`);
        const needQtyField = document.getElementById(`needQty${entryIndex}`);
        
        // Break if field doesn't exist
        if (!needDateField || !needQtyField) break;
        
        // Auto-complete and validation: Both date and qty must be provided or both empty
        let hasDate = needDateField.value.trim();
        let hasQty = needQtyField.value.trim();
        
        // Auto-complete date if only quantity provided
        if (!hasDate && hasQty) {
          const today = new Date();
          const todayStr = today.getFullYear() + '-' + 
                         String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                         String(today.getDate()).padStart(2, '0');
          needDateField.value = todayStr;
          hasDate = todayStr;
        }
        
        if (hasDate && hasQty) {
          allNeedEntries.push({
            date: convertDateToJulian(needDateField.value),
            qty: needQtyField.value,
            originalPosition: entryIndex  // PRESERVE ORIGINAL POSITION
          });
        } else if (hasDate && !hasQty) {
          // Include partial entry to maintain position
          allNeedEntries.push({
            date: convertDateToJulian(needDateField.value),
            qty: '',
            originalPosition: entryIndex,
            partial: true
          });
        } else if (!hasDate && hasQty) {
          // Include partial entry to maintain position
          allNeedEntries.push({
            date: '',
            qty: needQtyField.value,
            originalPosition: entryIndex,
            partial: true
          });
        }
        
        entryIndex++;
      }
      console.log(`üìä DYNAMIC: Collected ${allNeedEntries.length} need entries from ${entryIndex - 1} rows`);
      
      // Clear problematic global acknowledgment fields to prevent validation conflicts
      // DISABLED - was incorrectly clearing valid acknowledgment data populated by fallback logic
      /* console.log('üßπ Clearing global acknowledgment fields to prevent validation conflicts...');
      for (let i = 1; i <= 5; i++) {
        const ackDateField = document.getElementById(`ackDate${i}`);
        const ackQtyField = document.getElementById(`ackQty${i}`);
        if (ackDateField && ackDateField.value && !document.getElementById(`ackQty${i}`)?.value) {
          console.log(`üßπ Clearing orphaned ackDate${i}: "${ackDateField.value}"`);
          ackDateField.value = '';
        }
        if (ackQtyField && ackQtyField.value && !document.getElementById(`ackDate${i}`)?.value) {
          console.log(`üßπ Clearing orphaned ackQty${i}: "${ackQtyField.value}"`);
          ackQtyField.value = '';
        }
      } */

      // Collect Acknowledgment entries (dynamic - supports any number of rows)
      // ‚úÖ ACKNOWLEDGMENTS WORK FOR BOTH GLOBAL AND LINE-SPECIFIC MODES
      const allAckEntries = [];
      console.log('üîç Collecting acknowledgments from manual input fields, editingLineIndex:', editingLineIndex);
      // ‚úÖ PROCESS ACKNOWLEDGMENTS IN BOTH GLOBAL AND LINE-SPECIFIC MODES  
      // Global mode: acknowledgments go to first line item
      // Line-specific mode: acknowledgments go to specific line item
      console.log('‚úÖ Processing acknowledgments for editingLineIndex:', editingLineIndex);
      let ackEntryIndex = 1;
      while (true) {
        const ackDateField = document.getElementById(`ackDate${ackEntryIndex}`);
        const ackQtyField = document.getElementById(`ackQty${ackEntryIndex}`);
        
        // Break if field doesn't exist
        if (!ackDateField || !ackQtyField) break;
        
        // Validation: Both date and qty must be provided or both empty
        if (ackDateField && ackQtyField) {
          let hasDate = ackDateField.value.trim();
          let hasQty = ackQtyField.value.trim();
          // Only auto-complete if COMPLETELY EMPTY and user hasn't manually edited this field
          const userEdited = ackDateField.hasAttribute('data-user-edited');
          const qtyUserEdited = ackQtyField.hasAttribute('data-user-edited');
          
          // Skip auto-complete if field has ANY value (date or qty) or is user-edited
          if (!hasDate && hasQty && !userEdited && !qtyUserEdited) {
            // First try to extract date from qty field
            const parsedAck = extractAckDateAndQuantity(hasQty);
            if (parsedAck.date) {
              const normalizedDate = normalizeAckDateValue(parsedAck.date);
              if (normalizedDate) {
                ackDateField.value = normalizedDate;
                hasDate = normalizedDate;

                let normalizedQty = parsedAck.qty || '';
                if (!normalizedQty) {
                  const digitsOnly = hasQty.replace(/[^0-9.]/g, '');
                  const dateDigits = normalizedDate.replace(/[^0-9]/g, '');
                  if (digitsOnly && digitsOnly !== dateDigits) {
                    normalizedQty = digitsOnly;
                  }
                }

                if (normalizedQty) {
                  ackQtyField.value = normalizedQty;
                  hasQty = normalizedQty;
                }
              }
            } else {
              // If no date found in qty field, use today's date as fallback
              const today = new Date();
              const todayStr = today.getFullYear() + '-' + 
                               String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                               String(today.getDate()).padStart(2, '0');
              ackDateField.value = todayStr;
              hasDate = todayStr;
            }
          }

          // Re-read values after potential auto-fill to ensure validation uses current field values
          hasDate = ackDateField.value.trim();
          hasQty = ackQtyField.value.trim();
          
          if (hasDate && hasQty) {
            const julianDate = convertDateToJulian(ackDateField.value);
            allAckEntries.push({
              date: julianDate,
              qty: ackQtyField.value,
              originalPosition: ackEntryIndex  // PRESERVE ORIGINAL POSITION
            });
          } else if (hasDate && !hasQty) {
            // Include partial entry to maintain position
            const julianDate = convertDateToJulian(ackDateField.value);
            allAckEntries.push({
              date: julianDate,
              qty: '',
              originalPosition: ackEntryIndex,
              partial: true
            });
          } else if (!hasDate && hasQty) {
            // Include partial entry to maintain position
            allAckEntries.push({
              date: '',
              qty: ackQtyField.value,
              originalPosition: ackEntryIndex,
              partial: true
            });
          }
        }
        
        ackEntryIndex++;
      }
      console.log(`üìä DYNAMIC: Collected ${allAckEntries.length} ack entries from ${ackEntryIndex - 1} rows`);
      
      // This function continues below to process and return the data
      // Don't return here - let the function continue to process the data properly
      
    // Collect Schedule entries (dynamic - supports any number of rows)
      console.log('üîç COLLECTING SCHEDULE ENTRIES FROM INPUT FIELDS...');
      const allScheduleEntries = [];
      let schedEntryIndex = 1;
      while (true) {
        const schedDateField = document.getElementById(`lineScheduleDate${schedEntryIndex}`);
        const schedQtyField = document.getElementById(`lineScheduleQty${schedEntryIndex}`);
        
        // Break if field doesn't exist
        if (!schedDateField || !schedQtyField) break;
        
        console.log(`üîç SCHEDULE COLLECT: Row ${schedEntryIndex} - dateField:`, schedDateField?.value, 'qtyField:', schedQtyField?.value);
        console.log(`üîç SCHEDULE COLLECT: Row ${schedEntryIndex} - dateField user-edited:`, schedDateField?.hasAttribute('data-user-edited'));
        
        // Auto-complete and validation: Both date and qty must be provided or both empty
        if (schedDateField && schedQtyField) {
          let hasDate = schedDateField.value.trim();
          let hasQty = schedQtyField.value.trim();
          
          // Auto-complete date if only quantity provided
          if (!hasDate && hasQty) {
            const today = new Date();
            const todayStr = today.getFullYear() + '-' + 
                           String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                           String(today.getDate()).padStart(2, '0');
            schedDateField.value = todayStr;
            hasDate = todayStr;
            console.log(`üîç SCHEDULE COLLECT: Auto-completed date for row ${schedEntryIndex}: ${todayStr}`);
          }
          
          if (hasDate && hasQty) {
            // EXTENSIVE DEBUG BEFORE CONVERSION
            console.log(`üîç PRE-CONVERSION DEBUG - Row ${schedEntryIndex}:`);
            console.log(`  - Field ID: ${schedDateField.id}`);
            console.log(`  - Raw field value: "${schedDateField.value}"`);
            console.log(`  - hasDate: "${hasDate}"`);
            console.log(`  - Field value type: ${typeof schedDateField.value}`);
            console.log(`  - Field value length: ${schedDateField.value.length}`);
            
            const julianDate = convertDateToJulian(schedDateField.value);
            
            console.log(`üîç POST-CONVERSION DEBUG - Row ${schedEntryIndex}:`);
            console.log(`  - Returned Julian: "${julianDate}"`);
            console.log(`  - Julian type: ${typeof julianDate}`);
            console.log(`  - Julian as number: ${parseInt(julianDate)}`);
            
            // CRITICAL DEBUG: Check for invalid Julian dates
            if (!julianDate || julianDate === '1' || julianDate === '0' || parseInt(julianDate) < 365 || isNaN(parseInt(julianDate))) {
              console.error(`üö®üö®üö® INVALID JULIAN DATE DETECTED üö®üö®üö®`);
              console.error(`Row ${schedEntryIndex}, Input: "${schedDateField.value}", Julian: "${julianDate}"`);
              console.error(`üö® COMPLETE FIELD STATE:`, {
                dateFieldId: schedDateField.id,
                dateValue: schedDateField.value,
                dateValueQuoted: JSON.stringify(schedDateField.value),
                qtyFieldId: schedQtyField.id,
                qtyValue: schedQtyField.value,
                hasDate: hasDate,
                hasQty: hasQty,
                fieldType: typeof schedDateField.value,
                fieldLength: schedDateField.value.length,
                julianResult: julianDate,
                julianType: typeof julianDate,
                julianAsInt: parseInt(julianDate)
              });
              // SKIP INVALID DATES - DON'T ADD TO ENTRIES
              console.log(`‚ö†Ô∏è SCHEDULE COLLECT: Row ${schedEntryIndex} - SKIPPED due to invalid Julian date`);
              // Don't add this entry to allScheduleEntries
            } else if (!schedQtyField.value || schedQtyField.value.trim() === '') {
              console.log(`‚ö†Ô∏è SCHEDULE COLLECT: Row ${schedEntryIndex} - SKIPPED due to empty quantity`);
              // Don't add entries with empty quantity to prevent backend errors
            } else {
              const entry = {
                date: julianDate,
                qty: schedQtyField.value.trim(),
                originalPosition: schedEntryIndex  // PRESERVE ORIGINAL POSITION
              };
              allScheduleEntries.push(entry);
              console.log(`‚úÖ SCHEDULE COLLECT: Added entry for row ${schedEntryIndex}:`, entry);
              console.log(`‚úÖ SCHEDULE COLLECT: Julian conversion: ${schedDateField.value} ‚Üí ${julianDate}`);
              console.log(`‚úÖ SCHEDULE COLLECT: Raw qty field value: "${schedQtyField.value}" ‚Üí cleaned: "${schedQtyField.value.trim()}"`);
            }
          } else if (hasDate && !hasQty) {
            // Include partial entry to maintain position
            const julianDate = convertDateToJulian(schedDateField.value);
            if (julianDate && julianDate !== '1' && julianDate !== '0' && parseInt(julianDate) >= 365) {
              allScheduleEntries.push({
                date: julianDate,
                qty: '',
                originalPosition: schedEntryIndex,
                partial: true
              });
              console.log(`‚úÖ SCHEDULE COLLECT: Added partial entry (date only) for row ${schedEntryIndex}`);
            } else {
              console.log(`‚ö†Ô∏è SCHEDULE COLLECT: Row ${schedEntryIndex} - invalid date, skipping`);
            }
          } else if (!hasDate && hasQty) {
            // Include partial entry to maintain position
            allScheduleEntries.push({
              date: '',
              qty: schedQtyField.value.trim(),
              originalPosition: schedEntryIndex,
              partial: true
            });
            console.log(`‚úÖ SCHEDULE COLLECT: Added partial entry (qty only) for row ${schedEntryIndex}`);
          }
        }
        
        schedEntryIndex++;
      }
      console.log(`üìä DYNAMIC: Collected ${allScheduleEntries.length} schedule entries from ${schedEntryIndex - 1} rows`);
      
      // CRITICAL: Map tracking entries to specific line items correctly
      // Based on backend multivalue structure: field[lineItem1_data]field[lineItem2_data]etc
      const numLineItems = lineItems.length;
      
      // Initialize all line items with empty arrays first
      for (let i = 0; i < Math.max(numLineItems, 10); i++) {
        manualData.needs[i] = []; 
        manualData.acknowledgments[i] = [];
        manualData.schedules[i] = [];
      }
      
      // MAPPING STRATEGY: 
      // The tracking section shows aggregate data, but we need to map it back to specific line items
      // Since the user is editing specific quantities that correspond to line items,
      // we'll map entries sequentially to line items (entry 1 -> line item 1, entry 2 -> line item 2, etc.)
      
      // Distribute tracking entries across line items
      
      // CACHE INTEGRATION: Collect needs from cache
      if (isFullSave) {
        // FULL SAVE MODE: Only use cache for the CURRENTLY EDITED line to avoid overwriting other lines
        if (currentEditingLineIndex >= 0 && lineItemTrackingCache.needs[currentEditingLineIndex]) {
          const cachedEntries = lineItemTrackingCache.needs[currentEditingLineIndex] || [];
          console.log(`üíæ CACHE NEED: FULL SAVE - Using cache ONLY for current line ${currentEditingLineIndex}:`, cachedEntries);
          cachedEntries.forEach(entry => {
            if (entry.date && entry.date.trim()) {
              const julianDate = convertDateToJulian(entry.date);
              if (julianDate) {
                manualData.needs[currentEditingLineIndex].push({
                  date: julianDate,
                  qty: entry.qty || '',
                  originalPosition: currentEditingLineIndex + 1
                });
                console.log(`üíæ CACHE NEED: Added cached entry for CURRENT line ${currentEditingLineIndex}: ${entry.date} ‚Üí ${julianDate}, qty: ${entry.qty}`);
              }
            }
          });
        } else {
          console.log(`üíæ CACHE NEED: FULL SAVE - No cache for current line ${currentEditingLineIndex}`);
        }
      } else if (currentEditingLineIndex >= 0 && lineItemTrackingCache.needs[currentEditingLineIndex]) {
        // SINGLE EDIT MODE: Process only current line item
        const cachedEntries = lineItemTrackingCache.needs[currentEditingLineIndex] || [];
        console.log(`üíæ CACHE NEED: Processing cached entries for CURRENT line ${currentEditingLineIndex} only:`, cachedEntries);
        cachedEntries.forEach(entry => {
          if (entry.date && entry.date.trim()) {
            const julianDate = convertDateToJulian(entry.date);
            if (julianDate) {
              manualData.needs[currentEditingLineIndex].push({
                date: julianDate,
                qty: entry.qty || '',
                originalPosition: currentEditingLineIndex + 1
              });
              console.log(`üíæ CACHE NEED: Added cached entry for line ${currentEditingLineIndex}: ${entry.date} ‚Üí ${julianDate}, qty: ${entry.qty}`);
            }
          }
        });
      } else {
        console.log(`üíæ CACHE NEED: No cache for current line ${currentEditingLineIndex} or not editing specific line item`);
      }
      
      // FALLBACK: If no cache data, use manual input fields
      if (Object.keys(lineItemTrackingCache.needs).length === 0) {
        // Map Need entries to line items based on original position
        allNeedEntries.forEach((entry, index) => {
          console.log(`üîç COLLECT DEBUG: Processing need entry ${index}:`, entry);
          console.log(`üîç COLLECT DEBUG: editingLineIndex = ${editingLineIndex}, numLineItems = ${numLineItems}`);
          
          // CRITICAL FIX: If user is editing tracking info, all entries should go to the currently selected line item
          // FIXED LOGIC: Use preserved editing line index
          let lineItemIndex;
          
          if (typeof currentEditingLineIndex !== 'undefined' && currentEditingLineIndex !== null && currentEditingLineIndex >= 0) {
            // User was editing a specific line item - all entries go there
            lineItemIndex = currentEditingLineIndex;
            console.log(`üîç COLLECT DEBUG: Using preserved editing line index = ${lineItemIndex} (FIXED)`);
          } else {
            // FALLBACK: All entries go to first line item 
            lineItemIndex = 0;
            console.log(`üîç COLLECT DEBUG: Using default lineItemIndex = 0 (no line item context)`);
          }
          
          console.log(`üîç COLLECT DEBUG: Adding entry to line item ${lineItemIndex}`);
          manualData.needs[lineItemIndex].push(entry);
        });
      }
      
      // CACHE INTEGRATION: Collect acknowledgments from cache
      if (isFullSave) {
        // FULL SAVE MODE: Only use cache for the CURRENTLY EDITED line to avoid overwriting other lines
        if (currentEditingLineIndex >= 0 && lineItemTrackingCache.acknowledgments[currentEditingLineIndex]) {
          const cachedEntries = lineItemTrackingCache.acknowledgments[currentEditingLineIndex] || [];
          console.log(`üíæ CACHE ACK: FULL SAVE - Using cache ONLY for current line ${currentEditingLineIndex}:`, cachedEntries);
          cachedEntries.forEach(entry => {
            if (entry.date && entry.date.trim()) {
              const julianDate = convertDateToJulian(entry.date);
              if (julianDate) {
                manualData.acknowledgments[currentEditingLineIndex].push({
                  date: julianDate,
                  qty: entry.qty || '',
                  originalPosition: currentEditingLineIndex + 1
                });
                console.log(`üíæ CACHE ACK: Added cached entry for CURRENT line ${currentEditingLineIndex}: ${entry.date} ‚Üí ${julianDate}, qty: ${entry.qty}`);
              } else {
                console.log(`‚ùå CACHE ACK: Failed to convert date ${entry.date} to Julian for line ${currentEditingLineIndex}`);
              }
            } else {
              console.log(`‚ö†Ô∏è CACHE ACK: Skipping empty/invalid entry for CURRENT line ${currentEditingLineIndex}:`, entry);
            }
          });
        } else {
          console.log(`üíæ CACHE ACK: FULL SAVE - No cache for current line ${currentEditingLineIndex}`);
        }
      } else if (currentEditingLineIndex >= 0 && lineItemTrackingCache.acknowledgments[currentEditingLineIndex]) {
        // SINGLE EDIT MODE: Process only current line item
        const cachedEntries = lineItemTrackingCache.acknowledgments[currentEditingLineIndex] || [];
        console.log(`üíæ CACHE ACK: Processing cached entries for CURRENT line ${currentEditingLineIndex} only:`, cachedEntries);
        cachedEntries.forEach(entry => {
          if (entry.date && entry.date.trim()) {
            const julianDate = convertDateToJulian(entry.date);
            if (julianDate) {
              manualData.acknowledgments[currentEditingLineIndex].push({
                date: julianDate,
                qty: entry.qty || '',
                originalPosition: currentEditingLineIndex + 1
              });
              console.log(`üíæ CACHE ACK: Added cached entry for line ${currentEditingLineIndex}: ${entry.date} ‚Üí ${julianDate}, qty: ${entry.qty}`);
            } else {
              console.log(`‚ùå CACHE ACK: Failed to convert date ${entry.date} to Julian for line ${currentEditingLineIndex}`);
            }
          } else {
            console.log(`‚ö†Ô∏è CACHE ACK: Skipping empty/invalid entry for line ${currentEditingLineIndex}:`, entry);
          }
        });
      } else {
        console.log(`üíæ CACHE ACK: No cache for current line ${currentEditingLineIndex} or not editing specific line item`);
      }
      
      // FALLBACK: If no cache data, use manual input fields
      if (Object.keys(lineItemTrackingCache.acknowledgments).length === 0) {
        allAckEntries.forEach((entry, index) => {
          console.log(`üîç ACK DEBUG: Processing ack entry ${index}:`, entry);
          
          // CRITICAL FIX: Use currentEditingLineIndex directly instead of part number matching
          let lineItemIndex = 0; // Default fallback
          
          if (typeof currentEditingLineIndex !== 'undefined' && currentEditingLineIndex >= 0) {
            lineItemIndex = currentEditingLineIndex;
            console.log(`üîç ACK DEBUG: Using currentEditingLineIndex = ${lineItemIndex}`);
          } else {
            console.log(`üîç ACK DEBUG: currentEditingLineIndex not available, using default index 0`);
          }
          
          console.log(`üîç ACK DEBUG: Adding entry to line item ${lineItemIndex}`);
          manualData.acknowledgments[lineItemIndex].push(entry);
        });
      }
      
      // CACHE INTEGRATION: Collect schedules from cache
      if (isFullSave) {
        // FULL SAVE MODE: Only use cache for the CURRENTLY EDITED line to avoid overwriting other lines
        if (currentEditingLineIndex >= 0 && lineItemTrackingCache.schedules[currentEditingLineIndex]) {
          const cachedEntries = lineItemTrackingCache.schedules[currentEditingLineIndex] || [];
          console.log(`üíæ CACHE SCHEDULE: FULL SAVE - Using cache ONLY for current line ${currentEditingLineIndex}:`, cachedEntries);
          cachedEntries.forEach(entry => {
            if (entry.date && entry.date.trim()) {
              const julianDate = convertDateToJulian(entry.date);
              if (julianDate) {
                manualData.schedules[currentEditingLineIndex].push({
                  date: julianDate,
                  qty: entry.qty || '',
                  originalPosition: currentEditingLineIndex + 1
                });
                console.log(`üíæ CACHE SCHEDULE: Added cached entry for CURRENT line ${currentEditingLineIndex}: ${entry.date} ‚Üí ${julianDate}, qty: ${entry.qty}`);
              }
            }
          });
        } else {
          console.log(`üíæ CACHE SCHEDULE: FULL SAVE - No cache for current line ${currentEditingLineIndex}`);
        }
      } else if (currentEditingLineIndex >= 0 && lineItemTrackingCache.schedules[currentEditingLineIndex]) {
        // SINGLE EDIT MODE: Process only current line item
        const cachedEntries = lineItemTrackingCache.schedules[currentEditingLineIndex] || [];
        console.log(`üíæ CACHE SCHEDULE: Processing cached entries for CURRENT line ${currentEditingLineIndex} only:`, cachedEntries);
        cachedEntries.forEach(entry => {
          if (entry.date && entry.date.trim()) {
            const julianDate = convertDateToJulian(entry.date);
            if (julianDate) {
              manualData.schedules[currentEditingLineIndex].push({
                date: julianDate,
                qty: entry.qty || '',
                originalPosition: currentEditingLineIndex + 1
              });
              console.log(`üíæ CACHE SCHEDULE: Added cached entry for line ${currentEditingLineIndex}: ${entry.date} ‚Üí ${julianDate}, qty: ${entry.qty}`);
            }
          }
        });
      } else {
        console.log(`üíæ CACHE SCHEDULE: No cache for current line ${currentEditingLineIndex} or not editing specific line item`);
      }
      
      // FALLBACK: If no cache data, use manual input fields
      if (Object.keys(lineItemTrackingCache.schedules).length === 0) {
        // Map Schedule entries to line items
        allScheduleEntries.forEach((entry, index) => {
          console.log(`üîç SCHEDULE DEBUG: Processing schedule entry ${index}:`, entry);
          
          // **CRITICAL FIX FOR ROW 5 LINE ITEM 3 ISSUE**
          // Check if this is row 5 and we have 3+ line items
          if (entry.originalPosition === 5 && lineItems.length >= 3) {
            console.log(`üö® ROW 5 LINE ITEM 3 DEBUG: Processing critical row 5 with ${lineItems.length} line items`);
            console.log(`üö® ROW 5 DEBUG: entry.originalPosition = ${entry.originalPosition}`);
            console.log(`üö® ROW 5 DEBUG: window.editingLineIndex = ${window.editingLineIndex}`);
            console.log(`üö® ROW 5 DEBUG: currentEditingLineIndex = ${currentEditingLineIndex}`);
          }
          
          // FIXED LOGIC: Use preserved editing line index
          let lineItemIndex;
          console.log(`üîç SCHEDULE DEBUG: window.editingLineIndex = ${window.editingLineIndex} (type: ${typeof window.editingLineIndex})`);
          if (typeof window.editingLineIndex !== 'undefined' && window.editingLineIndex !== null && window.editingLineIndex >= 0) {
            // User was editing a specific line item - all entries go there
            lineItemIndex = window.editingLineIndex;
            console.log(`üîç SCHEDULE DEBUG: Using preserved editing line index = ${lineItemIndex} (FIXED)`);
          } else {
            console.log(`üîç SCHEDULE DEBUG: ENTERING FALLBACK LOGIC - window.editingLineIndex was undefined`);
            
            // **NEW ROUND-ROBIN LOGIC FOR ROW 5 LINE ITEM 3 ISSUE**
            // If we have multiple line items, use round-robin assignment
            if (lineItems.length > 1 && entry.originalPosition) {
              // Map entry position to line item: entry 1‚Üíline 1, entry 2‚Üíline 2, entry 3‚Üíline 3, etc.
              // For row 5 with 3 line items: 5-1=4, 4%3=1, so row 5 goes to line item 2 (index 1)
              // But user expects row 5 to go to line item 3 (index 2)
              // So we need: (originalPosition-1) % numLineItems
              const calculatedIndex = (entry.originalPosition - 1) % lineItems.length;
              lineItemIndex = calculatedIndex;
              console.log(`üîç ROUND-ROBIN SCHEDULE: Row ${entry.originalPosition} ‚Üí Line Item ${calculatedIndex + 1} (index ${calculatedIndex})`);
              
              // Special debug for row 5
              if (entry.originalPosition === 5) {
                console.log(`üö® ROW 5 ASSIGNMENT: originalPosition=${entry.originalPosition}, numLineItems=${lineItems.length}`);
                console.log(`üö® ROW 5 CALCULATION: (${entry.originalPosition}-1) % ${lineItems.length} = ${calculatedIndex}`);
                console.log(`üö® ROW 5 RESULT: Assigning to line item ${calculatedIndex + 1} (index ${calculatedIndex})`);
              }
            } else {
              // SIMPLE FALLBACK: Check what part number is currently loaded in the form
              const currentPartNumber = document.getElementById('partNumber')?.value;
              console.log(`üîç SCHEDULE DEBUG: Current part number in form: "${currentPartNumber}"`);
              
              lineItemIndex = 0; // Default fallback
              
              // Find the line item index that matches the current part number
              if (currentPartNumber && lineItems && lineItems.length > 0) {
                const foundIndex = lineItems.findIndex(item => item.partNumber === currentPartNumber);
                if (foundIndex !== -1) {
                  lineItemIndex = foundIndex;
                  console.log(`üîç SCHEDULE DEBUG: Found matching line item at index ${lineItemIndex} for part "${currentPartNumber}"`);
                } else {
                  console.log(`üîç SCHEDULE DEBUG: Part number "${currentPartNumber}" not found in lineItems, using default index 0`);
                }
              } else {
                console.log(`üîç SCHEDULE DEBUG: No part number or lineItems available, using default index 0`);
              }
            }
          }
          
          // **FINAL ROW 5 DEBUG**
          if (entry.originalPosition === 5) {
            console.log(`üö® ROW 5 FINAL: Adding entry to line item index ${lineItemIndex} (line item ${lineItemIndex + 1})`);
            console.log(`üö® ROW 5 ENTRY:`, entry);
            console.log(`üö® ROW 5 TARGET ARRAY LENGTH BEFORE:`, manualData.schedules[lineItemIndex]?.length || 0);
          }
          
          console.log(`üîç SCHEDULE DEBUG: Adding entry to line item ${lineItemIndex}`);
          manualData.schedules[lineItemIndex].push(entry);
          
          // **POST-ADD ROW 5 DEBUG**
          if (entry.originalPosition === 5) {
            console.log(`üö® ROW 5 TARGET ARRAY LENGTH AFTER:`, manualData.schedules[lineItemIndex]?.length || 0);
          }
        });
      }
      
      // Manual tracking data collected
      console.log('üîç COLLECT FINAL: Returning manualData:', {
        needsTotal: manualData.needs.reduce((sum, arr) => sum + arr.length, 0),
        acksTotal: manualData.acknowledgments.reduce((sum, arr) => sum + arr.length, 0),
        schedulesTotal: manualData.schedules.reduce((sum, arr) => sum + arr.length, 0),
        detailedData: {
          needs: manualData.needs,
          acknowledgments: manualData.acknowledgments,
          schedules: manualData.schedules
        }
      });
      
      return manualData;
    }

    function clearIncompleteGlobalAcknowledgments() {
      // DISABLED FUNCTION - was incorrectly clearing valid acknowledgment data
      console.log('‚ö†Ô∏è clearIncompleteGlobalAcknowledgments() called but DISABLED - acknowledgments preserved');
      return; // Exit immediately without doing anything
    }

    function saveSO() {
      // Starting SO save process
      console.log('üíæ === SAVE SO (FINAL SUBMIT) ===');
      
      // Check if this is a draft being converted to final SO
      const isDraft = window.currentDraftId && window.currentDraftId.trim() !== '';
      console.log('üîç Is Draft?', isDraft, 'Draft ID:', window.currentDraftId);
      
      // Check if SO Number already exists (editing existing SO)
      const soNumber = document.getElementById('soNumberInput').value;
      console.log('üîç Current SO Number:', soNumber);
      
      // ALWAYS generate new SO number if:
      // 1. Coming from a draft (isDraft = true)
      // 2. SO number is empty
      // 3. SO number starts with TEMP-
      if (isDraft || !soNumber || soNumber.startsWith('TEMP-')) {
        // New SO - Get SO Number from LIID first
        console.log('üî¢ New SO - Getting SO Number from LIID...');
        getNextSONumberForSubmit();
      } else {
        // Already has a valid SO Number, proceed with update
        console.log('üìã Updating existing SO Number:', soNumber);
        proceedWithSOSave();
      }
    }
    
    function proceedWithSOSave() {
      console.log('üíæ Proceeding with SO save...');
      
      // CRITICAL: Auto-save current line item if user is editing one
      if (editingLineIndex >= 0 && editingLineIndex < lineItems.length) {
        console.log(`üîÑ AUTO-SAVE: User is editing line item ${editingLineIndex}, auto-saving before SO save...`);
        
        // Update the line item in the array with current form values
        const lineItem = lineItems[editingLineIndex];
        lineItem.partNumber = document.getElementById('linePartNumber')?.value.trim() || lineItem.partNumber;
        lineItem.description = document.getElementById('lineDescription')?.value.trim() || lineItem.description;
        lineItem.quantity = parseFloat(document.getElementById('lineQuantity')?.value) || lineItem.quantity;
        lineItem.unitPrice = parseFloat(document.getElementById('lineUnitPrice')?.value) || lineItem.unitPrice;
        lineItem.uom = document.getElementById('lineUOM')?.value.trim() || lineItem.uom;
        lineItem.lineNotes = document.getElementById('lineNotes')?.value.trim() || lineItem.lineNotes;
        lineItem.prodNotes = document.getElementById('lineProdNotes')?.value.trim() || lineItem.prodNotes;
        
        // Collect needs, acks, schedules dynamically (ALL rows)
        const needData = [];
        let needIdx = 1;
        while (true) {
          const dateEl = document.getElementById(`needDate${needIdx}`);
          const qtyEl = document.getElementById(`needQty${needIdx}`);
          if (!dateEl || !qtyEl) break;
          if (dateEl.value && qtyEl.value) {
            needData.push(`${convertDateToJulian(dateEl.value)}~${qtyEl.value}`);
          }
          needIdx++;
        }
        lineItem.needData = needData.join('\\');
        lineItem.needEntries = needData.map(entry => {
          const [date, qty] = entry.split('~');
          return { date, qty };
        });
        
        const schedData = [];
        let schedIdx = 1;
        while (true) {
          const dateEl = document.getElementById(`lineScheduleDate${schedIdx}`);
          const qtyEl = document.getElementById(`lineScheduleQty${schedIdx}`);
          const rsEl = document.getElementById(`lineRS${schedIdx}`);
          if (!dateEl || !qtyEl) break;
          if (dateEl.value && qtyEl.value) {
            const rsFlag = rsEl && rsEl.checked ? 'Y' : '';
            schedData.push(`${convertDateToJulian(dateEl.value)}~${qtyEl.value}~${rsFlag}`);
          }
          schedIdx++;
        }
        lineItem.schedData = schedData.join('\\');
        lineItem.scheduleEntries = schedData.map(entry => {
          const [date, qty, rs] = entry.split('~');
          return { date, qty, rs: rs || '' };
        });
        
        const ackData = [];
        let ackIdx = 1;
        while (true) {
          const dateEl = document.getElementById(`ackDate${ackIdx}`);
          const qtyEl = document.getElementById(`ackQty${ackIdx}`);
          if (!dateEl || !qtyEl) break;
          if (dateEl.value && qtyEl.value) {
            ackData.push(`${convertDateToJulian(dateEl.value)}~${qtyEl.value}`);
          }
          ackIdx++;
        }
        lineItem.ackData = ackData.join('\\');
        lineItem.ackEntries = ackData.map(entry => {
          const [date, qty] = entry.split('~');
          return { date, qty };
        });
        
        console.log(`‚úÖ AUTO-SAVE: Line item ${editingLineIndex} updated in array:`, lineItem);
        console.log(`   needData (${needData.length} entries): ${lineItem.needData}`);
        console.log(`   needEntries (${lineItem.needEntries.length} objects):`, lineItem.needEntries);
        console.log(`   schedData (${schedData.length} entries): ${lineItem.schedData}`);
        console.log(`   scheduleEntries (${lineItem.scheduleEntries.length} objects):`, lineItem.scheduleEntries);
        console.log(`   ackData (${ackData.length} entries): ${lineItem.ackData}`);
        console.log(`   ackEntries (${lineItem.ackEntries.length} objects):`, lineItem.ackEntries);
      }
      
      // Validate required fields
      const soNumber = document.getElementById('soNumberInput').value;
      console.log('üìã SO Number for save:', soNumber);

      // Collect basic PO data
      // NEW STRUCTURE: Position 2 = Ship To, Position 4 = Bill To
      // customerCodeInput contains Ship To (002216)
      // shipToCodeInput contains Bill To (002215)
      
      // Get Ship To code from customerCodeInput
      const customerCodeInput = document.getElementById('customerCodeInput');
      const customerCode = customerCodeInput?.getAttribute('data-customer-code') || customerCodeInput?.value || '';
      
      // Extract just the Ship-To code (before the " - " separator)
      let shipToCodeOnly = customerCode;
      if (customerCode.includes(' - ')) {
        shipToCodeOnly = customerCode.split(' - ')[0].trim();
      }
      
      // Get Bill To code from shipToCodeInput (read-only field)
      const billToInput = document.getElementById('shipToCodeInput');
      let billToCode = billToInput?.value || '';
      if (billToCode.includes(' - ')) {
        billToCode = billToCode.split(' - ')[0].trim();
      }
      
      // Validate SO Date
      const soDateInput = document.getElementById('soDateInput');
      const soDateValue = soDateInput?.value || '';
      
      if (soDateValue) {
        // Parse date and check year
        const dateParts = soDateValue.split('-');
        if (dateParts.length === 3) {
          const year = parseInt(dateParts[0], 10);
          if (year < 2020 || year > 2030) {
            alert('‚ö†Ô∏è Invalid date year: ' + year + '\n\nPlease enter a date between 2020 and 2030.');
            soDateInput.focus();
            return;
          }
        }
      }
      
      // VALIDATE TRACKING INFORMATION - Both fields must be filled or both empty
      console.log('üîç Validating tracking information fields...');
      
      // Validate Needs (5 rows)
      for (let i = 1; i <= 5; i++) {
        const dateField = document.getElementById(`needDate${i}`);
        const qtyField = document.getElementById(`needQty${i}`);
        
        if (dateField && qtyField) {
          const hasDate = dateField.value.trim() !== '';
          const hasQty = qtyField.value.trim() !== '';
          
          if (hasDate && !hasQty) {
            alert('‚ö†Ô∏è Tracking Information Error\n\nNeed row ' + i + ': You entered a DATE but missing QUANTITY.\n\nPlease fill both fields or leave both empty.');
            qtyField.focus();
            return;
          }
          if (!hasDate && hasQty) {
            alert('‚ö†Ô∏è Tracking Information Error\n\nNeed row ' + i + ': You entered a QUANTITY but missing DATE.\n\nPlease fill both fields or leave both empty.');
            dateField.focus();
            return;
          }
        }
      }
      
      // Validate Acknowledgments (5 rows)
      for (let i = 1; i <= 5; i++) {
        const dateField = document.getElementById(`ackDate${i}`);
        const qtyField = document.getElementById(`ackQty${i}`);
        
        if (dateField && qtyField) {
          const hasDate = dateField.value.trim() !== '';
          const hasQty = qtyField.value.trim() !== '';
          
          if (hasDate && !hasQty) {
            alert('‚ö†Ô∏è Tracking Information Error\n\nAcknowledgment row ' + i + ': You entered a DATE but missing QUANTITY.\n\nPlease fill both fields or leave both empty.');
            qtyField.focus();
            return;
          }
          if (!hasDate && hasQty) {
            alert('‚ö†Ô∏è Tracking Information Error\n\nAcknowledgment row ' + i + ': You entered a QUANTITY but missing DATE.\n\nPlease fill both fields or leave both empty.');
            dateField.focus();
            return;
          }
        }
      }
      
      // Validate Schedules (dynamic rows)
      let schedIndex = 1;
      while (true) {
        const dateField = document.getElementById(`lineScheduleDate${schedIndex}`);
        const qtyField = document.getElementById(`lineScheduleQty${schedIndex}`);
        
        if (!dateField || !qtyField) break; // No more schedule rows
        
        const hasDate = dateField.value.trim() !== '';
        const hasQty = qtyField.value.trim() !== '';
        
        if (hasDate && !hasQty) {
          alert('‚ö†Ô∏è Tracking Information Error\n\nSchedule row ' + schedIndex + ': You entered a DATE but missing QUANTITY.\n\nPlease fill both fields or leave both empty.');
          qtyField.focus();
          return;
        }
        if (!hasDate && hasQty) {
          alert('‚ö†Ô∏è Tracking Information Error\n\nSchedule row ' + schedIndex + ': You entered a QUANTITY but missing DATE.\n\nPlease fill both fields or leave both empty.');
          dateField.focus();
          return;
        }
        
        schedIndex++;
      }
      
      console.log('‚úÖ Tracking information validation passed');
      
      const soData = {
        so_number: soNumber,
        po_date: soDateValue,
        customer_code: customerCode, // For display purposes
        shipto_code: shipToCodeOnly, // Ship To code ‚Üí Position 2
        billto_code: billToCode, // Bill To code ‚Üí Position 4
        ship_via: document.getElementById('shipViaSelect')?.value || '', // Position 11 - Ship Via code
        carrier_account: document.getElementById('carrierAccountInput')?.value || '', // Position 59/76 - Carrier Account
        terms: document.getElementById('termsInput')?.value || '', // Position 18 - Payment terms
        so_status: document.getElementById('soStatusInput')?.value || '',
        email: (document.getElementById('emailInput')?.value || '').split(',').map(e => e.trim()).filter(e => e).join(String.fromCharCode(253)),
        temp_id: window.currentDraftId || '' // Pass draft ID so backend can delete it after save
      };
      
      console.log('üîç SAVE DEBUG: so_number =', soNumber, ', temp_id =', window.currentDraftId);
      
      // Basic PO data collected

      // Collect header notes from notesInput textarea
      const notesInput = document.getElementById('notesInput');
      const headerNotesText = notesInput?.value.trim() || '';
      soData.header_notes = headerNotesText;
      console.log(`üìù HEADER NOTES (Shipping Notes): "${headerNotesText}"`);

      // Collect line items data with proper field separation
      const lineItemsData = [];
      const lineItemPositions = [];
      const partNumbers = [];
      const descriptions = [];
      const quantities = [];  
      const prices = [];
      const uoms = [];
      const prodNotesData = [];
      
      lineItems.forEach((item, index) => {
        // MR4 CONVERSION: Send price as-is (backend will apply MR4 conversion)
        // No need to convert to cents here - backend ICONV MR4 handles the scaling
        const unitPrice = item.unitPrice;
        
        // Build complete line item data for processing
        lineItemsData.push(`${item.partNumber}*${item.quantity}*${unitPrice}`);
        
        // CRITICAL: Build separate arrays for each field
        lineItemPositions.push((index + 1).toString()); // Field 31: positions (1, 2, 3)
        partNumbers.push(item.partNumber);              // Field 32: part numbers
        descriptions.push(item.description || '');      // Field 33: descriptions
        quantities.push(item.quantity.toString());      // Field 35: quantities
        prices.push(unitPrice.toString());              // Field 36: prices (MR4 conversion in backend)
        uoms.push(item.uom || 'EA');                    // Field 37: unit of measure
        prodNotesData.push(item.prodNotes || '');       // Field 73: production notes
      });
      
      // Send structured data to backend
      soData.line_items = lineItemsData.join('|');
      soData.line_positions = lineItemPositions.join('|');  // For Field 31
      soData.part_numbers = partNumbers.join('|');          // For Field 32
      soData.descriptions = descriptions.join('|');         // For Field 33
      soData.line_quantities = quantities.join('|');       // For Field 35
      soData.line_prices = prices.join('|');               // For Field 36
      soData.line_uoms = uoms.join('|');                   // For Field 37
      soData.prod_notes = prodNotesData.join('|');         // For Field 73

      // CRITICAL FIX: Apply all cached data to lineItems BEFORE collecting tracking data
      applyCacheToLineItems();
      
      // COLLECT TRACKING DATA FROM MANUAL INPUTS (USER EDITS)  
      // This captures what the user has manually edited in the tracking table
      // Use FULL SAVE mode to process ALL line items with cached data
      const manualTrackingData = collectTrackingDataFromInputs(true);
      
      // Check if validation failed
      if (manualTrackingData === null) {
        // Validation failed - stopping save process
        return; // Stop the save process
      }
      
      // Collect tracking data organized by line item (multivalue structure)
      const scheduleDataByLineItem = [];
      const needsDataByLineItem = [];
      const ackDataByLineItem = [];
      // In saveSO flow we are performing a full-save of all line items
      const isFullSaveMode = true;
      
      // Process each line item to build multivalue structure
      lineItems.forEach((item, lineIndex) => {
        // SCHEDULE DATA for this line item
        let lineScheduleEntries = [];
        
        console.log(`\nüîç PROCESSING LINE ITEM ${lineIndex}:`);
        console.log(`   - editingLineIndex: ${window.editingLineIndex}`);
        console.log(`   - item.scheduleEntries:`, item.scheduleEntries);
        console.log(`   - manualTrackingData.schedules[${lineIndex}]:`, manualTrackingData.schedules[lineIndex]);
        
        // üöÄ CRITICAL FIX: In FULL SAVE mode, use lineItem data FIRST (includes cache)
        if (isFullSaveMode && item.scheduleEntries && item.scheduleEntries.length > 0) {
          console.log(`üöÄ FULL SAVE SCHEDULES: Using lineItem.scheduleEntries for line ${lineIndex} (includes cache):`, item.scheduleEntries);
          item.scheduleEntries.forEach((se, index) => {
            const dateVal = (se.date || se.schedule_date || '').toString();
            const qtyVal = (se.qty || se.schedule_qty || '').toString();
            if (dateVal && qtyVal) {
              // Dates may already be Julian; convert only if looks like YYYY-MM-DD
              const julianDate = (dateVal.includes('-') && dateVal.length === 10)
                ? convertDateToJulian(dateVal)
                : dateVal;
              lineScheduleEntries.push(`${julianDate}*${qtyVal}`);
              console.log(`‚úÖ FULL SAVE SCHEDULES: Added entry ${index + 1} for line ${lineIndex}: ${julianDate}*${qtyVal}`);
            }
          });
          console.log(`üéØ FULL SAVE SCHEDULES: Processed ${lineScheduleEntries.length} entries for line ${lineIndex}`);
        }
        // Check for manual edits first (user edits take priority) - only when NOT in full save mode
        else if (manualTrackingData.schedules[lineIndex] && manualTrackingData.schedules[lineIndex].length > 0) {
          // Using ONLY manual schedule data - do NOT combine with existing to prevent duplication
          console.log(`üîç SCHEDULE MANUAL DATA for line ${lineIndex}:`, manualTrackingData.schedules[lineIndex]);
          manualTrackingData.schedules[lineIndex].forEach((entry, entryIdx) => {
            console.log(`üîç SCHEDULE ENTRY ${entryIdx}:`, {entry: entry, hasDate: !!entry.date, hasQty: !!entry.qty, date: entry.date, qty: entry.qty});
            if (entry.date && entry.qty) {
              const scheduleStr = `${entry.date}*${entry.qty}`;
              lineScheduleEntries.push(scheduleStr);
              console.log(`‚úÖ ADDED SCHEDULE: "${scheduleStr}" to line ${lineIndex}`);
            } else {
              console.log(`‚ùå SKIPPED SCHEDULE ENTRY: Missing date or qty - date:"${entry.date}" qty:"${entry.qty}"`);
            }
          });
          
          // DON'T add existing data when we have manual data - it would create duplicates
          console.log(`üîí SCHEDULE: Using ONLY manual data for line ${lineIndex} - preventing duplication`);
        } else if (window.editingLineIndex >= 0 && lineIndex !== window.editingLineIndex) {
          // CRITICAL FIX: PRESERVE existing data for other line items even when editing one specific line
          if (item.scheduleEntries && Array.isArray(item.scheduleEntries)) {
            item.scheduleEntries.forEach(schedEntry => {
              if (schedEntry.date && schedEntry.qty) {
                const julianDate = convertDateToJulian(schedEntry.date);
                lineScheduleEntries.push(`${julianDate}*${schedEntry.qty}`);
              }
            });
            console.log(`üîí SCHEDULE: PRESERVING existing data for line ${lineIndex} - user editing different line ${window.editingLineIndex}`);
          } else {
            console.log(`üö´ SCHEDULE: No existing schedule entries found for line ${lineIndex}`);
          }
        } else {
          // Fallback to existing data (convert dates to Julian)
          // Only process if this is the target line item or if no editing line is specified, only process first line
          const shouldProcessExistingData = (editingLineIndex >= 0 && lineIndex === editingLineIndex) || 
                                          (editingLineIndex < 0 && lineIndex === 0);
          
          if (shouldProcessExistingData && item.scheduleDate && item.scheduleQty) {
            const julianDate = convertDateToJulian(item.scheduleDate);
            lineScheduleEntries.push(`${julianDate}*${item.scheduleQty}`);
            // Fallback schedule data
          } else if (item.scheduleDate && item.scheduleQty) {
            // Skipping existing schedule data (not target line)
          }
          
          // New schedule data (from addLineItem) - CONVERT TO JULIAN
          if (item.schedData) {
            const schedEntries = item.schedData.split('\\');
            schedEntries.forEach(entry => {
              if (entry.includes('~')) {
                const [date, qty] = entry.split('~');
                if (date && qty) {
                  const julianDate = convertDateToJulian(date);
                  lineScheduleEntries.push(`${julianDate}*${qty}`);
                  console.log(`üîß SCHEDULE MIX: Converted existing date ${date} ‚Üí ${julianDate} for line ${lineIndex}`);
                }
              }
            });
          }
        }
        
        // NEEDS DATA for this line item
        let lineNeedEntries = [];
        
        // üöÄ CRITICAL FIX: In FULL SAVE mode, use lineItem data FIRST (includes cache)
        if (isFullSaveMode && item.needEntries && item.needEntries.length > 0) {
          console.log(`üöÄ FULL SAVE NEEDS: Using lineItem.needEntries for line ${lineIndex} (includes cache):`, item.needEntries);
          item.needEntries.forEach((ne, index) => {
            const dateVal = (ne.date || ne.need_date || '').toString();
            const qtyVal = (ne.qty || ne.need_qty || '').toString();
            if (dateVal && qtyVal) {
              // Dates may already be Julian; convert only if looks like YYYY-MM-DD
              const julianDate = (dateVal.includes('-') && dateVal.length === 10)
                ? convertDateToJulian(dateVal)
                : dateVal;
              lineNeedEntries.push(`${julianDate}*${qtyVal}`);
              console.log(`‚úÖ FULL SAVE NEEDS: Added entry ${index + 1} for line ${lineIndex}: ${julianDate}*${qtyVal}`);
            } else if (dateVal && !qtyVal) {
              // üö´ VALIDATION: Never save date without qty in needEntries
              console.error(`üö´ BLOCKED: needEntries date "${dateVal}" without qty for line ${lineIndex} - NOT SAVED`);
            }
          });
          console.log(`üéØ FULL SAVE NEEDS: Processed ${lineNeedEntries.length} entries for line ${lineIndex}`);
        }
        // Check for manual edits first (user edits take priority) - only when NOT in full save mode
        else if (manualTrackingData.needs[lineIndex] && manualTrackingData.needs[lineIndex].length > 0) {
          // Using manual needs data
          manualTrackingData.needs[lineIndex].forEach(entry => {
            if (entry.date && entry.qty) {
              // üî• CRITICAL FIX: Convert date to Julian format before saving
              const julianDate = convertDateToJulian(entry.date);
              console.log(`üîß NEEDS CONVERSION: ${entry.date} ‚Üí ${julianDate} for line ${lineIndex}`);
              lineNeedEntries.push(`${julianDate}*${entry.qty}`);
            } else if (entry.date && !entry.qty) {
              // üö´ VALIDATION: Never save date without qty
              console.error(`üö´ BLOCKED: Date "${entry.date}" without qty for line ${lineIndex} - NOT SAVED`);
            }
          });
          // DISABLED: Don't mix existing data with manual data to avoid duplication
          // Manual data takes complete priority - no automatic mixing
          console.log(`üîí NEEDS: Using ONLY manual data for line ${lineIndex} - no mixing with existing data`);
        } else {
          // Process existing data (convert dates to Julian)
          // In FULL SAVE mode, preserve existing data for ALL line items that don't have manual/cache edits
          const shouldProcessExistingData = isFullSaveMode ||
            ((editingLineIndex >= 0 && lineIndex === editingLineIndex) || (editingLineIndex < 0 && lineIndex === 0));
          
          if (shouldProcessExistingData) {
            // PRIORITY 1: Multiple need data in string form (legacy)
            if (item.needData) {
              // Processing item.needData (multiple entries)
              const needEntries = item.needData.split('\\');
              needEntries.forEach(entry => {
                if (entry.includes('~')) {
                  const [date, qty] = entry.split('~');
                  if (date && qty) {
                    const julianDate = convertDateToJulian(date);
                    // Converting existing need date
                    lineNeedEntries.push(`${julianDate}*${qty}`);
                  } else if (date && !qty) {
                    // üö´ VALIDATION: Never save date without qty in needData processing
                    console.error(`üö´ BLOCKED: needData date "${date}" without qty for line ${lineIndex} - NOT SAVED`);
                  }
                }
              });
            }
            // PRIORITY 2: Structured need entries parsed from XML (preferred)
            else if (item.needEntries && item.needEntries.length > 0) {
              item.needEntries.forEach(ne => {
                const dateVal = (ne.date || ne.need_date || '').toString();
                const qtyVal = (ne.qty || ne.need_qty || '').toString();
                if (dateVal && qtyVal) {
                  // Dates may already be Julian; convert only if looks like YYYY-MM-DD
                  const julianDate = (dateVal.includes('-') && dateVal.length === 10)
                    ? convertDateToJulian(dateVal)
                    : dateVal;
                  lineNeedEntries.push(`${julianDate}*${qtyVal}`);
                } else if (dateVal && !qtyVal) {
                  // üö´ VALIDATION: Never save date without qty in needEntries
                  console.error(`üö´ BLOCKED: needEntries date "${dateVal}" without qty for line ${lineIndex} - NOT SAVED`);
                }
              });
            }
            // PRIORITY 3: Single need data (fallback) - ONLY if no multi entries
            else if (item.needDate && item.needQty) {
              const julianDate = convertDateToJulian(item.needDate);
              lineNeedEntries.push(`${julianDate}*${item.needQty}`);
            }
          } else {
            if (item.needData) {
              // Skipping existing need data (not target line)
            } else if (item.needDate && item.needQty) {
              // Skipping existing need data (not target line)
            }
          }
        }
        
        // ACKNOWLEDGMENT DATA for this line item
        let lineAckEntries = [];
        
        console.log(`üîç ACK DEBUG LINE ${lineIndex}: editingLineIndex=${window.editingLineIndex}, item.ackData="${item.ackData}", item.ackDate="${item.ackDate}"`);
        
        // üöÄ CRITICAL FIX: In FULL SAVE mode, use lineItem data FIRST (includes cache)
        if (isFullSaveMode && item.ackEntries && item.ackEntries.length > 0) {
          console.log(`üöÄ FULL SAVE ACKS: Using lineItem.ackEntries for line ${lineIndex} (includes cache):`, item.ackEntries);
          item.ackEntries.forEach((ae, index) => {
            const dateVal = (ae.date || ae.ack_date || '').toString();
            const qtyVal = (ae.qty || ae.ack_qty || '').toString();
            if (dateVal && qtyVal) {
              // Dates may already be Julian; convert only if looks like YYYY-MM-DD
              const julianDate = (dateVal.includes('-') && dateVal.length === 10)
                ? convertDateToJulian(dateVal)
                : dateVal;
              lineAckEntries.push(`${julianDate}*${qtyVal}`);
              console.log(`‚úÖ FULL SAVE ACKS: Added entry ${index + 1} for line ${lineIndex}: ${julianDate}*${qtyVal}`);
            }
          });
          console.log(`üéØ FULL SAVE ACKS: Processed ${lineAckEntries.length} entries for line ${lineIndex}`);
        }
        // Check for manual edits first (user edits take priority) - only when NOT in full save mode
        else if (manualTrackingData.acknowledgments[lineIndex] && manualTrackingData.acknowledgments[lineIndex].length > 0) {
          // Using ONLY manual acknowledgment data
          manualTrackingData.acknowledgments[lineIndex].forEach(entry => {
            if (entry.date && entry.qty) {
              lineAckEntries.push(`${entry.date}*${entry.qty}`);
            }
          });
          // DISABLED: Don't mix existing data with manual data to avoid duplication
          // Manual data takes complete priority - no automatic mixing
          console.log(`üîí ACK: Using ONLY manual data for line ${lineIndex} - no mixing with existing data`);
        } else {
          // CRITICAL FIX: PRESERVE existing data when no manual data or when editing different line
          const isEditingDifferentLine = (window.editingLineIndex >= 0 && lineIndex !== window.editingLineIndex);
          const isGlobalEdit = (window.editingLineIndex === undefined || window.editingLineIndex < 0);
          
          if (isEditingDifferentLine || isGlobalEdit) {
            // PRESERVE existing acknowledgment data
            if (item.ackData) {
              // Processing item.ackData (multiple entries) for preservation
              const ackEntries = item.ackData.split('\\');
              ackEntries.forEach(entry => {
                if (entry.includes('~')) {
                  const [date, qty] = entry.split('~');
                  if (date && qty) {
                    const julianDate = convertDateToJulian(date);
                    lineAckEntries.push(`${julianDate}*${qty}`);
                  }
                }
              });
              console.log(`üîí ACK: PRESERVING existing data for line ${lineIndex} - editingLineIndex=${window.editingLineIndex}`);
            } else if (item.ackDate && item.ackQty) {
              const julianDate = convertDateToJulian(item.ackDate);
              lineAckEntries.push(`${julianDate}*${item.ackQty}`);
              console.log(`üîí ACK: PRESERVING existing single ack for line ${lineIndex} - editingLineIndex=${window.editingLineIndex}`);
            } else {
              console.log(`üö´ ACK: No existing ack entries found for line ${lineIndex}`);
            }
          } else {
          // Process existing data (convert dates to Julian) for current/target line
          const shouldProcessExistingData = (editingLineIndex >= 0 && lineIndex === editingLineIndex) || 
                                          (editingLineIndex < 0 && lineIndex === 0);
          
          if (shouldProcessExistingData) {
            // PRIORITY 1: Multiple ack data (from addLineItem) - has ALL acknowledgments
            if (item.ackData) {
              // Processing item.ackData (multiple entries)
              const ackEntries = item.ackData.split('\\');
              ackEntries.forEach(entry => {
                if (entry.includes('~')) {
                  const [date, qty] = entry.split('~');
                  if (date && qty) {
                    const julianDate = convertDateToJulian(date);
                    // Converting existing ack date
                    lineAckEntries.push(`${julianDate}*${qty}`);
                  }
                }
              });
            }
            // PRIORITY 2: Single ack data (fallback) - ONLY if no item.ackData
            else if (item.ackDate && item.ackQty) {
              const julianDate = convertDateToJulian(item.ackDate);
              lineAckEntries.push(`${julianDate}*${item.ackQty}`);
              // Fallback ack data
            }
          } else {
            if (item.ackData) {
              console.log(`üîß Skipping existing ack data for line ${lineIndex + 1} (not target line):`, item.ackData);
            } else if (item.ackDate && item.ackQty) {
              console.log(`üîß Skipping existing ack data for line ${lineIndex + 1}: ${item.ackDate}*${item.ackQty} (not target line)`);
            }
          }
          }
        }
        
        // Join entries for this line item with ^ separator
        // Only add if there are actual entries to avoid empty multivalue slots
        if (lineScheduleEntries.length > 0) {
          // CRITICAL FIX: Ensure ALL dates are in Julian format before joining
          const finalScheduleEntries = lineScheduleEntries.map(entry => {
            if (entry.includes('*')) {
              const [date, qty] = entry.split('*');
              // Check if date is in YYYY-MM-DD format and convert to Julian
              if (date && date.includes('-') && date.length === 10) {
                const julianDate = convertDateToJulian(date);
                console.log(`üîß FINAL CONVERSION: Schedule ${date} ‚Üí ${julianDate} for line ${lineIndex}`);
                return `${julianDate}*${qty}`;
              }
              return entry; // Already in Julian format
            }
            return entry;
          });
          scheduleDataByLineItem.push(finalScheduleEntries.join('\\'));
          console.log(`‚úÖ LINE ${lineIndex} FINAL SCHEDULE DATA:`, finalScheduleEntries.join('\\'));
        } else {
          scheduleDataByLineItem.push(''); // Placeholder for this line item
          console.log(`‚ùå LINE ${lineIndex} NO SCHEDULE DATA - using empty placeholder`);
        }
        
        if (lineNeedEntries.length > 0) {
          const joinedNeedEntries = lineNeedEntries.join('\\');
          console.log(`üîß DEBUGGING LINE ${lineIndex} NEED CONSTRUCTION:`);
          console.log(`   üìù Individual entries:`, lineNeedEntries);
          console.log(`   üîó Joined with \\:`, joinedNeedEntries);
          console.log(`   ‚ùå Checking for bad separators: contains ']'?`, joinedNeedEntries.includes(']'));
          
          needsDataByLineItem.push(joinedNeedEntries);
        } else {
          needsDataByLineItem.push(''); // Placeholder for this line item
        }
        
        if (lineAckEntries.length > 0) {
          const finalAckEntries = lineAckEntries.join('^');
          ackDataByLineItem.push(finalAckEntries);
          console.log(`‚úÖ LINE ${lineIndex} FINAL ACK DATA:`, finalAckEntries);
        } else {
          ackDataByLineItem.push(''); // Placeholder for this line item
          console.log(`‚ùå LINE ${lineIndex} NO ACK DATA - using empty placeholder`);
        }
      });
      
      // Join all line items with | separator using new format with line indexes
      // New format: "lineIdx:entry1^entry2^entry3|lineIdx:entry1^entry2"
      const scheduleDataWithIndexes = [];
      const needsDataWithIndexes = [];
      const ackDataWithIndexes = [];
      
      scheduleDataByLineItem.forEach((lineData, index) => {
        // ALWAYS include ALL line items to maintain structure - use empty string if no data
        const dataToSend = (lineData && lineData.trim() !== '') ? lineData : '';
        scheduleDataWithIndexes.push(`${index + 1}:${dataToSend}`);
        console.log(`üîç SCHEDULE LINE ${index + 1}: "${dataToSend}" (original: "${lineData}")`);
      });
      
      needsDataByLineItem.forEach((lineData, index) => {
        // ALWAYS include ALL line items to maintain structure - use empty string if no data
        const dataToSend = (lineData && lineData.trim() !== '') ? lineData : '';
        needsDataWithIndexes.push(`${index + 1}:${dataToSend}`);
        console.log(`üîç NEEDS LINE ${index + 1}: "${dataToSend}" (original: "${lineData}")`);
      });
      
      ackDataByLineItem.forEach((lineData, index) => {
        console.log(`üîç CRITICAL DEBUG - ACK LINE ${index + 1}:`, {
          lineData: lineData,
          isEmpty: !lineData || lineData.trim() === '',
          willInclude: lineData && lineData.trim() !== ''
        });
        if (lineData && lineData.trim() !== '') {
          ackDataWithIndexes.push(`${index + 1}:${lineData}`);
          console.log(`‚úÖ INCLUDED ACK LINE ${index + 1}: ${index + 1}:${lineData}`);
        } else {
          console.log(`‚ùå SKIPPED ACK LINE ${index + 1}: Empty or whitespace`);
        }
      });
      
      // üî• BACKEND PARSING: Use | separator for frontend, backend will convert to CHAR(253)/CHAR(252)
      soData.schedule_data = scheduleDataWithIndexes.join('|');
      soData.needs_data = needsDataWithIndexes.join('|');
      soData.ack_data = ackDataWithIndexes.join('|');
      
      console.log('üîß FRONTEND FORMAT: Using "|" separator - backend will convert to proper CHAR codes');
      console.log('üö® CRITICAL DEBUGGING - EXACT DATA BEING SENT TO BACKEND:');
      console.log('   üîç EXACT needs_data being sent:', JSON.stringify(soData.needs_data));
      console.log('   üîç RAW needsDataWithIndexes before join:', needsDataWithIndexes);
      console.log('   üîç Check for contamination: needs_data.includes("]"):', (soData.needs_data || '').includes(']'));
      console.log('   üîç Check for unconverted dates: needs_data.includes("2025-"):', (soData.needs_data || '').includes('2025-'));
      
      // Debug: Log what's being sent
      console.log('üîç DEBUG TRACKING DATA BEING SENT:');
      console.log('   scheduleDataByLineItem:', scheduleDataByLineItem);
      console.log('   needsDataByLineItem:', needsDataByLineItem);
      console.log('   ackDataByLineItem:', ackDataByLineItem);
      console.log('   Final schedule_data:', soData.schedule_data);
      console.log('   Final needs_data:', soData.needs_data);
      console.log('   Final ack_data:', soData.ack_data);
      console.log('üö® CRITICAL BACKEND PAYLOAD:');
      console.log('   schedule_data LENGTH:', (soData.schedule_data || '').length);
      console.log('   needs_data LENGTH:', (soData.needs_data || '').length);
      console.log('   ack_data LENGTH:', (soData.ack_data || '').length);
      console.log('   schedule_data EXACT:', JSON.stringify(soData.schedule_data));
      console.log('   needs_data EXACT:', JSON.stringify(soData.needs_data));
      console.log('   ack_data EXACT:', JSON.stringify(soData.ack_data));


      // Collect line notes data for FIELD 40 (LINE ITEM NOTES)
      // Build multivalue field maintaining line item alignment
      const lineNotesData = [];
      lineItems.forEach((item, index) => {
        let noteValue = (item.lineNotes && item.lineNotes.trim()) ? item.lineNotes.trim() : '';
        // CRITICAL: Clean any accumulated separators before sending
        // Remove CHAR(252) and CHAR(253) that may have accumulated from previous reads
        noteValue = noteValue.replace(/[\xFC\xFD]/g, ' ').replace(/\s+/g, ' ').trim();
        console.log(`üìù COLLECTING Line ${index + 1} lineNotes: "${noteValue}"`);
        lineNotesData.push(noteValue);
      });
      console.log(`üìù TOTAL lineNotesData array:`, lineNotesData);
      
      // Field 40: Line Item Notes - using | separator (backend will convert to CHAR 253)
      // Each line item gets its own multivalue position
      soData.field_40 = lineNotesData.join('|');
      console.log('üìù LINE ITEM NOTES - Field 40:', {
        lineNotesData: lineNotesData,
        field_40: soData.field_40,
        field_40_length: soData.field_40.length,
        separator_used: '| (pipe) - backend converts to CHAR(253)'
      });

      // PERSISTENT CACHE: Save before sending to backend
      if (editingLineIndex >= 0) {
        saveCurrentTrackingToCache();
      }
      
      console.log('üì§ Sending PO data to backend:', soData);
      
      // üîç DEBUG: Check ack_data specifically
      console.log('üîç CRITICAL DEBUG - ACK_DATA:', {
        ack_data: soData.ack_data,
        ack_data_length: soData.ack_data ? soData.ack_data.length : 'undefined',
        ack_data_type: typeof soData.ack_data,
        ackDataByLineItem: ackDataByLineItem,
        ackDataWithIndexes: ackDataWithIndexes
      });

      // Show loading overlay  
      showSaveLoading();

      // In SO module, Ship To is saved as part of the main SO record
      // No separate Ship To save needed (unlike PO module)
      console.log('‚ÑπÔ∏è Ship To will be saved as part of SO record');
      
      // Save SO data directly
      saveSOData(soData);
    }

    function saveShipToData() {
      return new Promise((resolve, reject) => {
        console.log('üö¢ Saving Ship To data...');
        
        // Get SO Number from the form - required for UPDATE_SHIPTO.XML
        const soNumber = document.getElementById('soNumberInput')?.value?.trim() || '';
        if (!soNumber) {
          console.log('‚ö†Ô∏è No SO Number yet (will be auto-generated by LIID system)');
          // Allow saving without SO Number - it will be generated by backend
        }
        
        // Collect Ship To data from display elements (these are divs, not inputs)
        const shipToData = {
          SO_NUMBER: soNumber, // Add SO_NUMBER as required parameter
          SHIPTO_CODE: document.getElementById('shipToNumber')?.textContent?.trim() || '',
          SHIPTO_NAME: document.getElementById('shipToName')?.textContent?.trim() || '',
          SHIPTO_ADDRESS1: document.getElementById('shipToAddress')?.textContent?.trim() || '',
          SHIPTO_ADDRESS2: '', // Could add a second address field if needed
          SHIPTO_CITY: document.getElementById('shipToCity')?.textContent?.trim() || '',
          SHIPTO_STATE: '', // Extract from shipToCity if it contains state info
          SHIPTO_ZIP: '' // Extract from shipToCity if it contains zip info
        };

        // Parse city field which might contain "City, State Zip" format
        const cityText = shipToData.SHIPTO_CITY;
        if (cityText && cityText.includes(',')) {
          const parts = cityText.split(',');
          if (parts.length >= 2) {
            shipToData.SHIPTO_CITY = parts[0].trim();
            const stateZip = parts[1].trim();
            // Try to separate state and zip
            const stateZipParts = stateZip.split(' ');
            if (stateZipParts.length >= 2) {
              shipToData.SHIPTO_STATE = stateZipParts[0].trim();
              shipToData.SHIPTO_ZIP = stateZipParts.slice(1).join(' ').trim();
            } else {
              shipToData.SHIPTO_STATE = stateZip;
            }
          }
        }

        console.log('üîç Ship To data to save:', shipToData);

        // Only save if we have a shipto code
        if (!shipToData.SHIPTO_CODE) {
          console.log('‚ö†Ô∏è No Ship To code, skipping Ship To save');
          resolve();
          return;
        }

        const shipToParams = new URLSearchParams();
        Object.keys(shipToData).forEach(key => {
          shipToParams.append(key, shipToData[key] || '');
        });

        console.log('üöÄ Sending POST request to UPDATE_SHIPTO.XML...');
        fetch('UPDATE_SHIPTO.XML', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded'
          },
          body: shipToParams
        })
        .then(response => response.text())
        .then(xmlText => {
          console.log('üì• Ship To save response:', xmlText);
          
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
          const status = xmlDoc.querySelector('status');
          
          if (status && status.textContent === 'SUCCESS') {
            console.log('‚úÖ Ship To data saved successfully');
            resolve();
          } else {
            const message = xmlDoc.querySelector('message');
            const errorMsg = message ? message.textContent : 'Unknown error saving Ship To';
            console.error('‚ùå Ship To save error:', errorMsg);
            reject(new Error(errorMsg));
          }
        })
        .catch(error => {
          console.error('‚ùå Ship To save network error:', error);
          reject(error);
        });
      });
    }

    function saveLineItems() {
      console.log('üíæ Saving line items to backend...');
      
      if (!lineItems || lineItems.length === 0) {
        console.log('‚ö†Ô∏è No line items to save');
        return Promise.resolve();
      }
      
      // Prepare line items data for backend
      const lineItemsData = lineItems.map(item => 
        `${item.partNumber}*${item.quantity}*${item.unitPrice}`
      ).join('|');
      
      const linePositions = lineItems.map(item => item.lineNumber).join('|');
      const partNumbers = lineItems.map(item => item.partNumber).join('|');
      const descriptions = lineItems.map(item => item.description).join('|');
      const quantities = lineItems.map(item => item.quantity).join('|');
      const prices = lineItems.map(item => {
        const price = parseFloat(item.unitPrice) || 0;
        return price.toFixed(2); // Price already converted by backend
      }).join('|');
      
      const soData = {
        so_number: currentPONumber,
        line_items: lineItemsData,
        line_positions: linePositions,
        part_numbers: partNumbers,
        descriptions: descriptions,
        line_quantities: quantities,
        line_prices: prices
      };
      
      console.log('üíæ Sending line items data:', soData);
      
      return saveSOData(soData);
    }

    function saveSOData(soData) {
      // Send data to backend using URLSearchParams (like other working scripts)
      const params = new URLSearchParams();
      
      // üîç CRITICAL DEBUG: Check if temp_id is in soData
      console.log('üö® CRITICAL: temp_id in soData?', soData.temp_id);
      console.log('üö® CRITICAL: Full soData keys:', Object.keys(soData));
      
      Object.keys(soData).forEach(key => {
        // Adding to URLSearchParams
        params.append(key, soData[key] || '');
        if (key === 'temp_id') {
          console.log('‚úÖ temp_id being added to params:', soData[key]);
        }
      });
      
      // üîç VERIFY: Check if temp_id made it to params
      console.log('üö® VERIFY: temp_id in params?', params.get('temp_id'));

      // Sending POST request to UPDATE_SO.XML
        fetch('UPDATE_SO.XML', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: params
      })
      .then(response => {
        // Processing response
        return response.text();
      })
      .then(xmlText => {
        // Processing XML response
        console.log('üî•üî•üî• COMPLETE UPDATE_SO.XML RESPONSE üî•üî•üî•');
        console.log(xmlText);
        console.log('üî•üî•üî• END OF RESPONSE üî•üî•üî•');
        
        // Check if response is empty
        if (!xmlText || xmlText.trim() === '') {
          alert('Error: Empty response from server');
          console.error('‚ùå Empty response from UPDATE_PO.XML');
          return;
        }
        
        // Parse XML response
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
        
        // Check for XML parsing errors
        const parseError = xmlDoc.querySelector('parsererror');
        if (parseError) {
          console.error('‚ùå XML parsing error:', parseError.textContent);
          alert('Error: Invalid XML response from server');
          return;
        }
        
        const status = xmlDoc.querySelector('status');
        const error = xmlDoc.querySelector('error');
        
        if (status && status.textContent.toUpperCase() === 'SUCCESS') {
          // Hide loading overlay FIRST
          hideSaveLoading();
          
          // Get the generated SO number from response
          const generatedSONumber = xmlDoc.querySelector('so_number')?.textContent || 
                                    xmlDoc.querySelector('SO_NUMBER')?.textContent ||
                                    document.getElementById('soNumberInput')?.value || 'N/A';
          
          const customerCode = document.getElementById('customerCodeInput')?.value || '';
          const customerName = document.getElementById('customerName')?.textContent || '';
          
          // Check if this was from a draft (temp_id present)
          const wasDraft = soData.temp_id && soData.temp_id.trim() !== '';
          
          if (wasDraft) {
            // Show detailed success notification for draft-to-final conversion
            const successMessage = `
‚úÖ Sales Order Created Successfully!

SO Number: ${generatedSONumber}
Customer: ${customerName || customerCode}

‚úì The order has been saved to SO2 database
‚úì Draft "${soData.temp_id}" has been removed from temporary storage
‚úì You can now search for SO ${generatedSONumber} in Search & View

This SO is now final and no longer a draft.
            `.trim();
            
            alert(successMessage);
            
            // Reload the drafts list to show it's gone
            setTimeout(() => {
              showSavedDrafts();
            }, 500);
            
            // Ask if user wants to create new SO
            setTimeout(() => {
              const createNew = confirm('üéâ SO saved successfully!\n\nüìã Would you like to create a NEW SO?\n\n‚Ä¢ Click OK to start fresh (form will be cleared)\n‚Ä¢ Click Cancel to stay on this SO');
              
              if (createNew) {
                console.log('üÜï User chose to create new SO - resetting form...');
                setTimeout(() => {
                  resetFormForNewSO();
                }, 300);
              }
            }, 1000);
          } else {
            alert(`‚úÖ SO ${generatedSONumber} saved successfully!`);
            
            // Ask if user wants to create new SO
            setTimeout(() => {
              const createNew = confirm('üéâ SO saved successfully!\n\nüìã Would you like to create a NEW SO?\n\n‚Ä¢ Click OK to start fresh (form will be cleared)\n‚Ä¢ Click Cancel to stay on this SO');
              
              if (createNew) {
                console.log('üÜï User chose to create new SO - resetting form...');
                setTimeout(() => {
                  resetFormForNewSO();
                }, 300);
              }
            }, 1000);
          }
          
          // PERSISTENT CACHE: Clear cache after successful save
          localStorage.removeItem('po_tracking_cache');
          lineItemTrackingCache = { needs: {}, acknowledgments: {}, schedules: {} };
          console.log('üóëÔ∏è PERSISTENT: Cache cleared after successful save');
          
          // Clear draft ID since it's been saved to SO2
          if (window.currentDraftId) {
            console.log('üóëÔ∏è Clearing draft ID:', window.currentDraftId);
            window.currentDraftId = '';
          }
          
          // Update SO number input if it was generated
          if (generatedSONumber && generatedSONumber !== 'N/A') {
            const soNumberInput = document.getElementById('soNumberInput');
            if (soNumberInput) {
              soNumberInput.value = generatedSONumber;
            }
          }
          
          console.log('‚úÖ Save successful, keeping current form data (no reload needed)');
        } else if (error) {
          // Hide loading overlay on error
          hideSaveLoading();
          alert('Error: ' + error.textContent);
          console.error('Save error:', error.textContent);
        } else {
          // Hide loading overlay on unknown response
          hideSaveLoading();
          alert('Unknown response from server - check console for details');
          console.error('Unknown response structure:', xmlText);
        }
      })
      .catch(error => {
        // Hide loading overlay on error
        hideSaveLoading();
        console.error('Network error:', error);
        alert('Network error: ' + error.message + ' - Check console for details');
      });
    }

    function showSaveLoading() {
      // Create or show loading overlay
      let overlay = document.getElementById('saveLoadingOverlay');
      if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'saveLoadingOverlay';
        overlay.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
          color: white;
          font-size: 18px;
          font-weight: 600;
        `;
        overlay.innerHTML = `
          <div style="text-align: center;">
            <div style="width: 40px; height: 40px; border: 3px solid #fff; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div>
            <div>Saving Sales Order...</div>
          </div>
        `;
        document.body.appendChild(overlay);
        
        // Add spin animation
        const style = document.createElement('style');
        style.textContent = `@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`;
        document.head.appendChild(style);
      }
      overlay.style.display = 'flex';
    }

    function hideSaveLoading() {
      const overlay = document.getElementById('saveLoadingOverlay');
      if (overlay) {
        overlay.style.display = 'none';
      }
    }

    function selectLineItemForTracking(lineIndex) {
      console.log(`=== SELECTING LINE ITEM ${lineIndex} FOR TRACKING ===`);
      
      // CRITICAL FIX: Call editLineItem() to properly populate needData and schedData
      console.log(`üîß Calling editLineItem(${lineIndex}) to populate tracking data...`);
      editLineItem(lineIndex);
      return; // editLineItem handles everything
      
      // CACHE INTEGRATION: Save current data before switching
      if (editingLineIndex >= 0 && editingLineIndex !== lineIndex) {
        saveCurrentTrackingToCache();
      }
      
      console.log(`üîç Debug lineItems array:`, lineItems);
      console.log(`üîç lineItems type:`, typeof lineItems);
      console.log(`üîç lineItems length:`, lineItems ? lineItems.length : 'N/A');
      console.log(`üîç Requested index: ${lineIndex}`);

      // Make sure the edit form is actually visible when the Line Items tab is active
      const lineItemForm = document.getElementById('lineItemForm');
      if (lineItemForm && lineItemForm.style.display === 'none') {
        console.log('üîß selectLineItemForTracking: making line item form visible');
        lineItemForm.style.display = 'block';
      }

      // IMMEDIATE CLEAR: User clicking manually means addLineItem process is done
      if (window.isAddingLineItem) {
        console.log('‚ö†Ô∏è IMMEDIATE CLEAR: User manual click detected, clearing flag');
        window.isAddingLineItem = false;
        window.isAddingLineItemTimestamp = null;
      }
      
      if (!lineItems) {
        console.error(`‚ùå lineItems array is null or undefined!`);
        alert('ERROR: Line items data is missing. Please refresh the page.');
        return;
      }
      
      if (!lineItems[lineIndex]) {
        console.error(`‚ùå Line item ${lineIndex} not found in array:`, lineItems);
        alert(`ERROR: Line item ${lineIndex} not found. Array has ${lineItems.length} items.`);
        return;
      }
      
      // Set editing mode - this line item is now being edited
      editingLineIndex = lineIndex;
      console.log(`‚úÖ Set editingLineIndex = ${editingLineIndex}`);
      
      const item = lineItems[lineIndex];
      console.log(`üìã Selected line item data:`, item);
      
      // Populate all line item fields with data from the selected line item
      const linePartNumber = document.getElementById('linePartNumber');
      const lineQty = document.getElementById('lineQuantity');
      const linePrice = document.getElementById('lineUnitPrice');
      const lineTotal = document.getElementById('lineTotal');
      const lineDescription = document.getElementById('lineDescription');
      const lineNotes = document.getElementById('lineNotes');
      const lineNumber = document.getElementById('lineNumber');
      
      if (linePartNumber) {
        linePartNumber.value = item.partNumber || '';
        console.log(`‚úÖ Set Part Number: ${item.partNumber}`);
      }
      
      if (lineQty) {
        const qtyForEdit = (item.baseQuantity !== undefined && item.baseQuantity !== null && item.baseQuantity !== 0)
          ? item.baseQuantity
          : (item.quantityDisplay || item.quantity || '');
        lineQty.value = qtyForEdit;
        console.log(`‚úÖ Set Quantity: ${qtyForEdit}`);
      }
      
      if (linePrice) {
        let priceValue;
        
        // Price is already converted to dollars by backend
        const price = parseFloat(item.unitPrice) || 0;
        // Use more decimals to show small prices like 0.002
        priceValue = price.toFixed(4);
        console.log(`‚úÖ Set Price: ${priceValue} (backend converted)`); 
        
        linePrice.value = priceValue;
      }
      
      if (lineTotal) {
        const qtyForTotal = lineQty ? parseFloat(lineQty.value) || 0 : (item.quantity || 0);
        let totalValue;
        
        // Price is already converted to dollars by backend
        const price = parseFloat(item.unitPrice) || 0;
        totalValue = price * qtyForTotal;
        console.log(`‚úÖ Set Total: ${totalValue.toFixed(2)} (${price} dollars * ${qtyForTotal} qty)`);
        
        lineTotal.textContent = totalValue.toFixed(2);
      }
      
      if (lineDescription) {
        lineDescription.value = item.description || '';
        console.log(`‚úÖ Set Description: ${item.description}`);
      }
      
      if (lineNotes) {
        lineNotes.value = item.lineNotes || '';
        console.log(`‚úÖ Set Line Notes: ${item.lineNotes}`);
      }
      
      if (lineNumber) {
        lineNumber.value = item.lineNumber || lineIndex + 1;
        console.log(`‚úÖ Set Line Number: ${item.lineNumber || lineIndex + 1}`);
      }
      
      // Update the display line number if it exists
      const displayLineNumber = document.getElementById('displayLineNumber');
      if (displayLineNumber) {
        displayLineNumber.textContent = item.lineNumber || lineIndex + 1;
      }
      
      // Clear all tracking fields first - PRESERVE USER EDITED FIELDS
      for (let i = 1; i <= 5; i++) {
        const needDate = document.getElementById(`needDate${i}`);
        const needQty = document.getElementById(`needQty${i}`);
        const ackDate = document.getElementById(`ackDate${i}`);
        const ackQty = document.getElementById(`ackQty${i}`);
        const scheduleDate = document.getElementById(`lineScheduleDate${i}`);
        const scheduleQty = document.getElementById(`lineScheduleQty${i}`);
        
        // DON'T clear need fields - they are populated by populateNeedFieldsFixed()
        // These will be properly populated later in the function
        console.log(`üîí selectLineItem: Preserving needDate${i} and needQty${i} (will be populated later)`);
        // if (needDate) needDate.value = '';  // ‚ùå REMOVED - was causing clearing after population
        // if (needQty) needQty.value = '';    // ‚ùå REMOVED - was causing clearing after population
        
        // ALWAYS clear ack fields when switching line items (no preservation)
        if (ackDate) {
          ackDate.value = '';
          // Remove user-edited attribute to start fresh for new line item
          ackDate.removeAttribute('data-user-edited');
          console.log(`üßπ selectLineItem: Cleared ackDate${i} (switching line items)`);
        }
        
        if (ackQty) {
          ackQty.value = '';
          // Remove user-edited attribute to start fresh for new line item
          ackQty.removeAttribute('data-user-edited');
          console.log(`üßπ selectLineItem: Cleared ackQty${i} (switching line items)`);
        }
        
        if (scheduleDate) scheduleDate.value = '';
        if (scheduleQty) scheduleQty.value = '';
      }
      
      // Populate tracking information with actual backend data
      console.log('üîç Available data:', {
        lineItem: item,
        headerAcknowledgments: window.currentSOData?.acknowledgments,
        needsInfo: window.currentSOData?.needs_data
      });
      
      // Get backend data sources
      const headerAck = window.currentSOData?.acknowledgments || {};
      
      // Get needs for THIS specific line item only (not all line items)
      console.log('üîç DEBUG: Complete line item object:', item);
      console.log('üîç DEBUG: Available item properties:', Object.keys(item));
      console.log('üîç DEBUG: item.needsArray:', item.needsArray);
      console.log('üîç DEBUG: item.needs:', item.needs);
      console.log('üîç DEBUG: item.needEntries:', item.needEntries);
      
      // CRITICAL FIX: Use ONLY line-item-specific needs data, NOT global needs
      let lineItemNeedsInfo = [];
      
      // DEBUG: Show what data is available for this line item
      console.log(`üîç DEBUG selectLineItemForTracking(${lineIndex}) - Available data:`, {
        needsArray: item.needsArray,
        needEntries: item.needEntries,
        needsArrayLength: item.needsArray?.length,
        needEntriesLength: item.needEntries?.length
      });

      // PRIORITY 1: Use needsArray if available (line-item specific)
      if (item.needsArray && Array.isArray(item.needsArray)) {
        lineItemNeedsInfo = item.needsArray;
        console.log('üéØ Using needsArray for line item', lineIndex, ':', lineItemNeedsInfo);
      }
      // PRIORITY 2: Use needEntries if available (line-item specific)  
      else if (item.needEntries && Array.isArray(item.needEntries)) {
        lineItemNeedsInfo = item.needEntries;
        console.log('üéØ Using needEntries for line item', lineIndex, ':', lineItemNeedsInfo);
      }
      // PRIORITY 3: Extract from global needs_info using line index
      else if (window.currentSOData?.needs_info && Array.isArray(window.currentSOData.needs_info)) {
        // Filter needs_info by line position (1-based indexing)
        const targetLinePosition = lineIndex + 1;
        lineItemNeedsInfo = window.currentSOData.needs_info.filter(entry => 
          parseInt(entry.line_position) === targetLinePosition
        );
        console.log(`üéØ Filtered global needs_info for line position ${targetLinePosition}:`, lineItemNeedsInfo);
      }
      // NEVER use global item.needs - that causes cross-line contamination
      
      // Convert format from {date, qty} to {need_date, need_qty} if needed
      if (lineItemNeedsInfo.length > 0 && lineItemNeedsInfo[0].date !== undefined) {
        console.log('üîß Converting needs format from {date, qty} to {need_date, need_qty}');
        lineItemNeedsInfo = lineItemNeedsInfo.map(entry => ({
          need_date: entry.date,
          need_qty: entry.qty
        }));
      }
      
      console.log('üîç Populating needs for specific line item', lineIndex, 'only');
      console.log('üîç Line item needs data (converted):', lineItemNeedsInfo);
      
      if (lineItemNeedsInfo && lineItemNeedsInfo.length > 0) {
        console.log('üìã Found line item needs, using populateNeedFieldsFixed()');
        
        // üî• CRITICAL FIX: Force clear ALL need fields before populating new line item data
        console.log('üßπ FORCE CLEARING all need fields to prevent cross-line contamination');
        for (let i = 1; i <= 5; i++) {
          const dateField = document.getElementById(`needDate${i}`);
          const qtyField = document.getElementById(`needQty${i}`);
          if (dateField) {
            dateField.value = '';
            console.log(`üßπ FORCE CLEARED needDate${i}`);
          }
          if (qtyField) {
            qtyField.value = '';
            console.log(`üßπ FORCE CLEARED needQty${i}`);
          }
        }
        
        console.log('üîç CALLING populateNeedFieldsFixed() with data:', lineItemNeedsInfo);
        populateNeedFieldsFixed(lineItemNeedsInfo);
        console.log('‚úÖ populateNeedFieldsFixed() completed');
      } else {
        console.log('‚ö†Ô∏è No needs found for this line item, clearing need fields');
        // Clear all need fields if no data available
        for (let i = 1; i <= 5; i++) {
          const dateField = document.getElementById(`needDate${i}`);
          const qtyField = document.getElementById(`needQty${i}`);
          if (dateField) dateField.value = '';
          if (qtyField) qtyField.value = '';
        }
      }
      
      // Populate Acknowledgements for CURRENT line item only using line-specific data
      console.log('üîç Populating acknowledgments for line item', lineIndex, 'using item.ackEntries');
      console.log('üîç item.ackEntries:', item.ackEntries);
      
      // ALWAYS ensure acknowledgment fields are visible and properly populated
      console.log('üìã ALWAYS ensuring acknowledgment fields are visible for line item', lineIndex);
      
      // CRITICAL FIX: Use ONLY line-item-specific acknowledgment data, NOT global acks
      let lineItemAckInfo = [];
      
      // PRIORITY 1: Use ackEntries if available (line-item specific)
      if (item.ackEntries && Array.isArray(item.ackEntries)) {
        lineItemAckInfo = item.ackEntries;
        console.log('üéØ Using ackEntries for line item', lineIndex, ':', lineItemAckInfo);
      }
      // PRIORITY 2: Extract from global acknowledgments using line index
      else if (window.currentSOData?.acknowledgments && Array.isArray(window.currentSOData.acknowledgments)) {
        // Filter acknowledgments by line position (1-based indexing)
        const targetLinePosition = lineIndex + 1;
        lineItemAckInfo = window.currentSOData.acknowledgments.filter(entry => 
          parseInt(entry.line_position) === targetLinePosition
        );
        console.log(`üéØ Filtered global acknowledgments for line position ${targetLinePosition}:`, lineItemAckInfo);
      }
      // NEVER use global acknowledgment data - that causes cross-line contamination
      
      if (lineItemAckInfo.length > 0) {
        console.log('üìã Found', lineItemAckInfo.length, 'acknowledgment entries for line item', lineIndex);
        
        // Convert to format expected by populateAcknowledgmentFieldsFixed
        const ackString = lineItemAckInfo.map(entry => {
          const date = entry.ack_date || entry.date || '';
          const qty = entry.ack_qty || entry.qty || '';
          return `${date}*${qty}`;
        }).join('\\');
        
        console.log('üîç Calling populateAcknowledgmentFieldsFixed with:', ackString);
        populateAcknowledgmentFieldsFixed({ ack_field49: ackString });
        console.log('‚úÖ Acknowledgment fields populated and all 5 rows should be visible');
      } else {
        console.log('üìã No ackEntries found, but ensuring all 5 ack rows are visible');
        // Call with empty data to ensure all 5 rows are visible
        populateAcknowledgmentFieldsFixed({ ack_field49: '' });
        console.log('‚úÖ All 5 acknowledgment rows should be visible (empty)');
      }
      
      // Populate ALL Schedules from line item schedule entries array
      console.log('üîç Schedule entries for line item:', item.scheduleEntries || []);
      
      // CRITICAL FIX: Use ONLY line-item-specific schedule data, NOT global schedules
      let lineItemScheduleInfo = [];
      
      // PRIORITY 1: Use scheduleEntries if available (line-item specific)
      if (item.scheduleEntries && Array.isArray(item.scheduleEntries)) {
        lineItemScheduleInfo = item.scheduleEntries;
        console.log('üéØ Using scheduleEntries for line item', lineIndex, ':', lineItemScheduleInfo);
      }
      // PRIORITY 2: Extract from global schedule_info using line index
      else if (window.currentSOData?.schedule_info && Array.isArray(window.currentSOData.schedule_info)) {
        // Filter schedule_info by line position (1-based indexing)
        const targetLinePosition = lineIndex + 1;
        lineItemScheduleInfo = window.currentSOData.schedule_info.filter(entry => 
          parseInt(entry.line_position) === targetLinePosition
        );
        console.log(`üéØ Filtered global schedule_info for line position ${targetLinePosition}:`, lineItemScheduleInfo);
      }
      // NEVER use global schedule data - that causes cross-line contamination
      
      if (lineItemScheduleInfo && Array.isArray(lineItemScheduleInfo)) {
        // Populate up to 5 schedule fields from the schedule entries array
        for (let i = 0; i < Math.min(5, lineItemScheduleInfo.length); i++) {
          const scheduleEntry = lineItemScheduleInfo[i];
          const scheduleDate = document.getElementById(`lineScheduleDate${i + 1}`);
          const scheduleQty = document.getElementById(`lineScheduleQty${i + 1}`);
          
          const entryDate = scheduleEntry.date || scheduleEntry.schedule_date || '';
          const entryQty = scheduleEntry.qty || scheduleEntry.schedule_qty || '';
          
          if (scheduleDate && entryDate) {
            const convertedDate = convertJulianToDate(entryDate);
            if (convertedDate) {
              scheduleDate.value = convertedDate;
              console.log(`‚úÖ Set scheduleDate${i + 1}: ${convertedDate} (from ${entryDate})`);
            } else {
              console.log(`‚ö†Ô∏è Skipped invalid schedule date: ${entryDate}`);
              // Don't set the field - leave it empty for invalid dates
            }
          }
          
          if (scheduleQty && entryQty !== undefined && entryQty !== null && entryQty !== '') {
            scheduleQty.value = entryQty;
            console.log(`‚úÖ Set scheduleQty${i + 1}: ${entryQty}`);
          }
        }
      } else {
        // Fallback: use single schedule values if scheduleEntries array is not available
        const scheduleDate1 = document.getElementById('lineScheduleDate1');
        const scheduleQty1 = document.getElementById('lineScheduleQty1');
        
        if (scheduleDate1 && item.scheduleDate) {
          const convertedDate = convertJulianToDate(item.scheduleDate);
          if (convertedDate) {
            scheduleDate1.value = convertedDate;
            console.log(`‚úÖ Set scheduleDate1: ${convertedDate} (fallback)`);
          } else {
            console.log(`‚ö†Ô∏è Skipped invalid schedule date (fallback): ${item.scheduleDate}`);
            // Don't set the field - leave it empty for invalid dates
          }
        }
        
        if (scheduleQty1) {
          scheduleQty1.value = (item.scheduleQty !== undefined && item.scheduleQty !== null) ? item.scheduleQty : '';
          console.log(`‚úÖ Set scheduleQty1: ${scheduleQty1.value} (fallback)`);
        }
      }

      const normalizeDateValue = (rawValue) => {
        if (!rawValue || typeof rawValue !== 'string') return '';
        const trimmed = rawValue.trim();
        if (!trimmed) return '';
        const cleaned = trimmed.includes(' ') ? trimmed.split(' ')[0] : trimmed;
        
        console.log(`üîç NORMALIZE DEBUG: Input="${rawValue}", cleaned="${cleaned}"`);
        
        const normalized = convertDateFormat(cleaned);
        if (normalized) {
          console.log(`üîç NORMALIZE DEBUG: convertDateFormat returned: "${normalized}"`);
          return normalized;
        }
        
        const julianConverted = convertJulianToDate(cleaned);
        console.log(`üîç NORMALIZE DEBUG: convertJulianToDate("${cleaned}") returned: "${julianConverted}"`);
        
        // FIXED LOGIC: If convertJulianToDate returns empty string, skip entirely
        if (julianConverted === '') {
          console.log(`‚ö†Ô∏è normalizeDateValue: Skipping invalid Julian date: ${cleaned}`);
          return '';
        }
        
        // If we got a valid Julian conversion, return it
        if (julianConverted && julianConverted !== cleaned) {
          const formatted = convertDateFormat(julianConverted) || julianConverted;
          console.log(`üîç NORMALIZE DEBUG: Returning Julian conversion: "${formatted}"`);
          return formatted;
        }
        
        // Default: return cleaned value (for non-Julian dates)
        console.log(`üîç NORMALIZE DEBUG: Returning cleaned value: "${cleaned}"`);
        return cleaned;
      };

      const normalizeQtyValue = (rawValue) => {
        if (rawValue === undefined || rawValue === null) return '';
        let cleaned = String(rawValue).trim();
        if (!cleaned) return '';
        if (cleaned.includes('*')) {
          const parts = cleaned.split('*');
          cleaned = parts[parts.length - 1] || parts[0];
        }
        cleaned = cleaned.replace(/[^0-9.+-]/g, '');
        return cleaned;
      };

      const parseDateQtyString = (raw) => {
        if (!raw || typeof raw !== 'string') return [];
        // NO CONVERSION - use raw data as received from backend
        let normalized = raw.replace(/[\]\[]/g, ''); // Only remove brackets
        // Use CHAR(252) directly for splitting - no conversion to ^
        const segments = normalized.split(String.fromCharCode(252));
        return segments
          .map(seg => seg.trim())
          .filter(Boolean)
          .map(seg => {
            const [date, qty] = seg.split('*');
            const rawDate = date ? date.trim() : '';
            const rawQty = qty ? qty.trim() : '';
            
            // Validate date using convertJulianToDate - skip invalid dates
            let validatedDate = rawDate;
            if (rawDate && /^\d+$/.test(rawDate)) {
              // It's a Julian date, validate it
              const convertedDate = convertJulianToDate(rawDate);
              if (convertedDate === '') {
                // Invalid Julian date, skip this entry
                console.log(`‚ö†Ô∏è parseDateQtyString: Skipping invalid Julian date: ${rawDate}`);
                return null;
              }
              validatedDate = rawDate; // Keep original for now, conversion happens later
            }
            
            return {
              date: validatedDate,
              qty: rawQty
            };
          })
          .filter(entry => entry !== null && ((entry.date && entry.date.trim()) || (entry.qty && entry.qty.trim())));
      };

      const populateNeedEntries = () => {
        // DISABLED: This function is now disabled to prevent conflicts with populateNeedFieldsFixed()
        // All needs processing is handled centrally by populateNeedFieldsFixed()
        console.log('‚ö†Ô∏è populateNeedEntries() is disabled - using populateNeedFieldsFixed() instead');
        return;
        
        // LEGACY CODE BELOW - DISABLED TO PREVENT DUPLICATION
        let entries = Array.isArray(item.needEntries) && item.needEntries.length > 0
          ? item.needEntries
          : Array.isArray(item.needs) && item.needs.length > 0
            ? item.needs
            : [];

        if (entries.length === 0 && typeof item.needData === 'string' && item.needData.trim()) {
          entries = parseDateQtyString(item.needData);
        }

        entries.slice(0, 3).forEach((entry, idx) => {
          const dateField = document.getElementById(`needDate${idx + 1}`);
          const qtyField = document.getElementById(`needQty${idx + 1}`);
          const normalizedDate = normalizeDateValue(entry.date || '');
          const normalizedQty = entry.qty !== undefined && entry.qty !== null ? String(entry.qty).trim() : '';

          // Only populate if field is empty (preserve user input) - SAME AS SCHEDULES
          if (dateField && normalizedDate && !dateField.value) {
            dateField.value = normalizedDate;
            console.log(`üìã Applied needDate${idx + 1} = ${normalizedDate} (field was empty)`);
          } else if (dateField?.value) {
            console.log(`üîí Preserved needDate${idx + 1} = "${dateField.value}" (user input)`);
          }

          if (qtyField && normalizedQty && !qtyField.value) {
            qtyField.value = normalizedQty;
            console.log(`üìã Applied needQty${idx + 1} = ${normalizedQty} (field was empty)`);
          } else if (qtyField?.value) {
            console.log(`üîí Preserved needQty${idx + 1} = "${qtyField.value}" (user input)`);
          }
        });
      };

      const populateAckEntries = () => {
        // DISABLED: This function is now disabled to prevent conflicts with populateAcknowledgmentFieldsFixed()
        // All acknowledgment processing is handled centrally by populateAcknowledgmentFieldsFixed()
        console.log('‚ö†Ô∏è populateAckEntries() is disabled - using populateAcknowledgmentFieldsFixed() instead');
        return;

        // REMOVED: Don't use header ack_field49 here as it mixes data from all line items
        // Header acknowledgments are processed separately in global acknowledgment functions
        // if (entries.length === 0 && headerAck.ack_field49) {
        //   entries = parseDateQtyString(headerAck.ack_field49);
        // }

        entries.slice(0, 3).forEach((entry, idx) => {
          const dateField = document.getElementById(`ackDate${idx + 1}`);
          const qtyField = document.getElementById(`ackQty${idx + 1}`);
          const normalizedDate = normalizeDateValue(entry.date || '');
          const normalizedQty = normalizeQtyValue(entry.qty);

          // Only populate if field is empty (preserve user input) - SAME AS SCHEDULES
          if (dateField && normalizedDate && !dateField.value) {
            dateField.value = normalizedDate;
            console.log(`üìã Applied ackDate${idx + 1} = ${normalizedDate} (field was empty)`);
          } else if (dateField?.value) {
            console.log(`üîí Preserved ackDate${idx + 1} = "${dateField.value}" (user input)`);
          }

          if (qtyField && normalizedQty && !qtyField.value) {
            qtyField.value = normalizedQty;
            console.log(`üìã Applied ackQty${idx + 1} = ${normalizedQty} (field was empty)`);
          } else if (qtyField?.value) {
            console.log(`üîí Preserved ackQty${idx + 1} = "${qtyField.value}" (user input)`);
          }
        });
      };

      const populateScheduleEntries = () => {
        let entries = Array.isArray(item.scheduleEntries) && item.scheduleEntries.length > 0
          ? item.scheduleEntries
          : Array.isArray(item.schedules) && item.schedules.length > 0
            ? item.schedules
            : [];

        if (entries.length === 0 && typeof item.schedData === 'string' && item.schedData.trim()) {
          entries = parseDateQtyString(item.schedData);
        }

        entries.slice(0, 3).forEach((entry, idx) => {
          const dateField = document.getElementById(`lineScheduleDate${idx + 1}`);
          const qtyField = document.getElementById(`lineScheduleQty${idx + 1}`);
          
          console.log(`üîç POPULATE SCHEDULE DEBUG: Processing entry ${idx}:`, entry);
          console.log(`üîç POPULATE SCHEDULE DEBUG: Raw date = "${entry.date}"`);
          
          const normalizedDate = normalizeDateValue(entry.date || '');
          console.log(`üîç POPULATE SCHEDULE DEBUG: Normalized date = "${normalizedDate}"`);
          
          const normalizedQty = entry.qty !== undefined && entry.qty !== null ? String(entry.qty).trim() : '';

          if (dateField && normalizedDate) {
            dateField.value = normalizedDate;
            console.log(`üìã Applied scheduleDate${idx + 1} = ${normalizedDate}`);
          } else {
            console.log(`‚ö†Ô∏è POPULATE SCHEDULE DEBUG: Skipped entry ${idx} - normalizedDate is empty`);
          }

          if (qtyField && normalizedQty) {
            qtyField.value = normalizedQty;
            console.log(`üìã Applied scheduleQty${idx + 1} = ${normalizedQty}`);
          }
        });
      };

      // Call the fixed functions that handle line-specific data correctly
      console.log('üìã Calling fixed populate functions for line item', lineIndex);
      
      // REMOVED PROBLEMATIC SECOND CALL - was causing data contamination
      // The first call to populateNeedFieldsFixed() already handles proper line item filtering
      console.log('‚úÖ Skipping second populate call to prevent data contamination from other line items');
      
      // Populate acknowledgments using the fixed function with line-specific data  
      if (item.ackEntries && item.ackEntries.length > 0) {
        console.log('üîç DEBUG ACK CONVERSION: item.ackEntries =', item.ackEntries);
        
        // Convert item.ackEntries to the format expected by populateAcknowledgmentFieldsFixed
        const ackString = item.ackEntries.map(entry => {
          const date = entry.ack_date || entry.date || '';
          const qty = entry.ack_qty || entry.qty || '';
          console.log('üîç DEBUG ACK ENTRY:', {original: entry, date: date, qty: qty});
          return `${date}*${qty}`;
        }).join('\\');
        
        const ackData = { ack_field49: ackString };
        console.log('üîç DEBUG ACK DATA TO POPULATE:', ackData);
        
        populateAcknowledgmentFieldsFixed(ackData);
        console.log('üìã Populated acknowledgments using populateAcknowledgmentFieldsFixed() with item.ackEntries');
      } else {
        console.log('üî• CRITICAL: No ackEntries, but FORCING ack rows to be visible');
        // Call populateAcknowledgmentFieldsFixed with empty data to force 5 rows visible
        populateAcknowledgmentFieldsFixed({ ack_field49: '' });
        console.log('‚úÖ Empty populateAcknowledgmentFieldsFixed() call completed - FORCING 5 ack rows visible');
      }
      
      populateScheduleEntries();
      
      // ALWAYS ensure schedule fields are visible by calling populateScheduleFields
      console.log('üî• CRITICAL: Ensuring schedule fields are visible for line item', lineIndex);
      if (item.scheduleEntries && item.scheduleEntries.length > 0) {
        console.log('üìã Found schedule entries, calling populateScheduleFields');
        // Convert to format expected by populateScheduleFields
        const scheduleData = { schedule_line: item.scheduleEntries };
        populateScheduleFields(scheduleData, lineIndex);
        console.log('‚úÖ populateScheduleFields() completed with data');
      } else {
        console.log('üìã No schedule entries, calling populateScheduleFields with empty data');
        // Call with empty data to ensure all 5 rows are visible
        populateScheduleFields({ schedule_line: [] }, lineIndex);
        console.log('‚úÖ populateScheduleFields() completed (empty) - FORCING 5 schedule rows visible');
      }

      const lineItemIndex = lineIndex;
      const lineItemData = {
        needDate: document.getElementById('needDate1')?.value || '',
        needQty: document.getElementById('needQty1')?.value || '',
        ackDate: document.getElementById('ackDate1')?.value || '',
        ackQty: document.getElementById('ackQty1')?.value || '',
        scheduleDate: document.getElementById('lineScheduleDate1')?.value || '',
        scheduleQty: document.getElementById('lineScheduleQty1')?.value || ''
      };

      console.log('üìã Populating tracking information for line item', lineItemIndex);

      // REMOVED: setTimeout was overriding user input - populate functions now handle preservation
      console.log('‚úÖ Tracking fields populated with user input preservation');
      
      // üîß SMART RESET: Only reset tracking fields if we were adding a line item
      setTimeout(() => {
        // Solo limpia si estabas agregando un line item nuevo
        if (window.isAddingLineItem) {
          console.log('üîß SMART RESET: Resetting tracking fields after line item modal close');
          
          for (let i = 1; i <= 5; i++) {
            // --- ACK FIELDS ---
            const ackDateField = document.getElementById(`ackDate${i}`);
            const ackQtyField = document.getElementById(`ackQty${i}`);

            if (ackDateField) {
              // Preserve if has value OR if user-edited
              if (ackDateField.value || ackDateField.hasAttribute('data-user-edited')) {
                console.log(`‚è≠ Preserving ackDate${i}: "${ackDateField.value}" (has value or user-edited)`);
              } else {
                ackDateField.value = '';
                console.log(`üßπ Cleared ackDate${i} (empty and not user-edited)`);
              }
            }

            if (ackQtyField) {
              // Preserve if has value OR if user-edited
              if (ackQtyField.value || ackQtyField.hasAttribute('data-user-edited')) {
                console.log(`‚è≠ Preserving ackQty${i}: "${ackQtyField.value}" (has value or user-edited)`);
              } else {
                ackQtyField.value = '';
                console.log(`üßπ Cleared ackQty${i} (empty and not user-edited)`);
              }
            }

            // --- NEED FIELDS ---
            const needDateField = document.getElementById(`needDate${i}`);
            const needQtyField = document.getElementById(`needQty${i}`);
            if (needDateField && !needDateField.value) needDateField.value = '';
            if (needQtyField && !needQtyField.value) needQtyField.value = '';

            // --- SCHEDULE FIELDS ---
            const schedDateField = document.getElementById(`lineScheduleDate${i}`);
            const schedQtyField = document.getElementById(`lineScheduleQty${i}`);
            if (schedDateField && !schedDateField.value) schedDateField.value = '';
            if (schedQtyField && !schedQtyField.value) schedQtyField.value = '';
          }
          console.log('üîß SMART RESET: Field clearing complete for new line item');
        } else {
          console.log('‚è≠ Skipping field reset - navigating between existing line items');
        }
        
        // CACHE INTEGRATION: Only restore cached data if there is cached data to restore
        console.log('üîÑ TIMING: Checking if cache restore is needed for line item', lineIndex);
        
        // Check if we have any cached data for this line item
        const hasAckCache = lineItemTrackingCache.acknowledgments && lineItemTrackingCache.acknowledgments[lineIndex] && lineItemTrackingCache.acknowledgments[lineIndex].length > 0;
        const hasNeedsCache = lineItemTrackingCache.needs && lineItemTrackingCache.needs[lineIndex] && lineItemTrackingCache.needs[lineIndex].length > 0;
        const hasSchedulesCache = lineItemTrackingCache.schedules && lineItemTrackingCache.schedules[lineIndex] && lineItemTrackingCache.schedules[lineIndex].length > 0;
        
        if (hasAckCache || hasNeedsCache || hasSchedulesCache) {
          console.log('üîÑ CACHE: Found cached data, restoring for line item', lineIndex);
          restoreTrackingFromCache(lineIndex);
          console.log('‚úÖ TIMING: Cache restoration complete');
        } else {
          console.log('‚è≠ CACHE: No cached data found, keeping database values for line item', lineIndex);
        }
      }, 100);

      // Switch to Line Items tab (index 2) - this ensures we're on the right tab
      switchTab(2);
      console.log(`‚úÖ Switched to Line Items tab for line item ${lineIndex}`);
      
      // Switch to line item editing sub-tab to show the form
      if (typeof window.switchLineTab === 'function') { 
        window.switchLineTab(0); 
        console.log(`‚úÖ Switched to line item editing sub-tab`);
      }
      
      console.log(`‚úÖ Line item ${lineIndex} selected for editing`)
      
      // SETUP AUTO-SAVE: Configure listeners for real-time cache saving
      setupAutoSaveCacheListeners();
      
      console.log(`=== LINE ITEM ${lineIndex} TRACKING INFO POPULATED ===`);
    }

    function populateTrackingFromLineItems() {
      console.log('=== POPULATING TRACKING FROM LINE ITEMS ===');
      console.log('üìä Available line items:', lineItems.length);
      console.log('üìã Line items data:', lineItems);
      
      // Get acknowledgments from global currentSOData if available
      const ackData = window.currentSOData?.acknowledgments || {};
      console.log('üîç Header-level acknowledgment data:', ackData);
      
      // Clear all tracking fields first - PRESERVE USER EDITED FIELDS
      for (let i = 1; i <= 5; i++) {
        const needDateField = document.getElementById(`needDate${i}`);
        const needQtyField = document.getElementById(`needQty${i}`);
        const ackDateField = document.getElementById(`ackDate${i}`);
        const ackQtyField = document.getElementById(`ackQty${i}`);
        
        console.log(`üîç Checking tracking fields for index ${i}:`);
        console.log(`  - needDate${i}:`, needDateField ? 'EXISTS' : 'MISSING');
        console.log(`  - needQty${i}:`, needQtyField ? 'EXISTS' : 'MISSING');  
        console.log(`  - ackDate${i}:`, ackDateField ? 'EXISTS' : 'MISSING');
        console.log(`  - ackQty${i}:`, ackQtyField ? 'EXISTS' : 'MISSING');
        
        if (needDateField) needDateField.value = '';
        if (needQtyField) needQtyField.value = '';
        
        // Only clear ack fields if NOT user-edited AND empty
        if (ackDateField && !ackDateField.hasAttribute('data-user-edited') && !ackDateField.value) {
          ackDateField.value = '';
          console.log(`üßπ populateTrackingFromLineItems: Cleared ackDate${i} (not user-edited)`);
        } else if (ackDateField) {
          console.log(`üîí populateTrackingFromLineItems: Preserved ackDate${i} = "${ackDateField.value}" (user-edited or has value)`);
        }
        
        if (ackQtyField && !ackQtyField.hasAttribute('data-user-edited') && !ackQtyField.value) {
          ackQtyField.value = '';
          console.log(`üßπ populateTrackingFromLineItems: Cleared ackQty${i} (not user-edited)`);
        } else if (ackQtyField) {
          console.log(`üîí populateTrackingFromLineItems: Preserved ackQty${i} = "${ackQtyField.value}" (user-edited or has value)`);
        }
      }
      
      // Populate need info from line items (up to 5 items)
      lineItems.forEach((item, index) => {
        const fieldIndex = index + 1;
        if (fieldIndex > 5) return; // Only support 5 tracking entries
        
        console.log(`üîÑ Processing line item ${fieldIndex} need data:`, {
          needDate: item.needDate,
          needQty: item.needQty
        });
        
        // Need Date
        if (item.needDate) {
          const needDateField = document.getElementById(`needDate${fieldIndex}`);
          if (needDateField) {
            const formattedDate = convertJulianToDate(item.needDate);
            needDateField.value = formattedDate;
            console.log(`‚úÖ Set needDate${fieldIndex} = "${formattedDate}"`);
          }
        }
        
        // Need Quantity
        if (item.needQty) {
          const needQtyField = document.getElementById(`needQty${fieldIndex}`);
          if (needQtyField) {
            needQtyField.value = item.needQty;
            console.log(`‚úÖ Set needQty${fieldIndex} = "${item.needQty}"`);
          }
        }
      });
      
      // REMOVED: Individual ack_date/ack_qty processing to prevent duplicates
      // All acknowledgment data is now processed through ack_field49 only via populateAcknowledgmentFieldsFixed()
      
      console.log('=== TRACKING POPULATION COMPLETE ===');
    }

    function renderLineItems() {
      console.log(`=== RENDER LINE ITEMS CALLED ===`);
      console.log(`üîç lineItems array at render:`, lineItems);
      console.log(`üîç lineItems length at render:`, lineItems ? lineItems.length : 'N/A');
      
      const tbody = document.getElementById('lineItemsBody');
      if (!tbody) {
        console.error('‚ùå Line items tbody not found');
        return;
      }
      
      const countDiv = document.getElementById('lineItemsCount');
      
      if (!lineItems || lineItems.length === 0) {
        console.log('‚ö†Ô∏è No line items to render');
        tbody.innerHTML = '<div style="padding: 40px; text-align: center; color: #9ca3af;">No line items added</div>';
        if (countDiv) countDiv.textContent = '0 items';
        return;
      }

      if (countDiv) {
        countDiv.textContent = lineItems.length + ' item' + (lineItems.length !== 1 ? 's' : '');
      }
      
      // CLEAR tbody
      tbody.innerHTML = '';
      
      lineItems.forEach((item, index) => {
        // Get schedule date and quantity from item data
        const scheduleDate = item.scheduleDate || '';
        const scheduleQty = (item.scheduleQty !== undefined && item.scheduleQty !== null && item.scheduleQty !== '')
          ? item.scheduleQty
          : '-';
        
        const formattedScheduleDate = scheduleDate ? julianToDisplay(scheduleDate) : '-';
        const formattedNeedDate = julianToDisplay(item.needDate);
        
        // Format acknowledgment date
        const headerAck = window.currentSOData?.acknowledgments || {};
        let formattedAckDate = '-';
        if (item.ackDate) {
          formattedAckDate = julianToDisplay(item.ackDate);
        } else if (index === 0 && headerAck.ack_field49) {
          const firstDateMatch = headerAck.ack_field49.match(/(\d+)\*/);
          if (firstDateMatch) {
            formattedAckDate = julianToDisplay(firstDateMatch[1]);
          }
        }
        
        // Format quantities for display 
        let displayNeedQty = (item.needQty !== undefined && item.needQty !== null && item.needQty !== '') ? item.needQty : '-';
        if ((item.needQtyNumeric === 1 || item.needQty === '1') && item.quantity && item.quantity > 1) {
          displayNeedQty = item.quantity;
        }
        
        let displayAckQty = '-';
        if (item.ackQty !== undefined && item.ackQty !== null && item.ackQty !== '') {
          displayAckQty = item.ackQty;
        } else if (index === 0 && headerAck.ack_qty) {
          displayAckQty = headerAck.ack_qty.includes('*') ? headerAck.ack_qty.split('*')[1] || headerAck.ack_qty.split('*')[0] : headerAck.ack_qty;
        }
        
        const safeDescription = (item.description || 'No description').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        
        // GRID ROW WITH BORDERS AND HOVER
        const row = document.createElement('div');
        row.className = 'grid-row';
        row.style.cssText = 'display: grid; grid-template-columns: 60px 100px 120px 100px 1fr 120px 120px 100px; gap: 0; border-bottom: 1px solid #e5e7eb; align-items: center; background: white; transition: all 0.2s ease; cursor: pointer;';
        
        if (index % 2 === 0) {
          row.style.background = '#f9fafb';
        }
        
        // Add hover effect
        row.addEventListener('mouseenter', function() {
          this.style.background = 'linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%)';
          this.style.transform = 'translateX(2px)';
          this.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
        });
        
        row.addEventListener('mouseleave', function() {
          this.style.background = index % 2 === 0 ? '#f9fafb' : 'white';
          this.style.transform = 'translateX(0)';
          this.style.boxShadow = 'none';
        });
        
        // Get first need date if available
        let firstNeedDate = '-';
        if (item.needData && item.needData.trim()) {
          const needEntries = item.needData.split('\\').filter(n => n.trim());
          if (needEntries.length > 0) {
            const [julianDate] = needEntries[0].split('~');
            firstNeedDate = convertJulianToDate(julianDate) || julianDate;
          }
        }
        
        // Combine Part Number and Description
        const partAndDesc = `${item.partNumber}<br><span style="color: #6b7280; font-size: 10px;">${safeDescription}</span>`;
        
        row.innerHTML = `
          <div style="text-align: center; padding: 8px; border-right: 1px solid #e5e7eb;">
            <span style="color: #1f2937; font-size: 11px; font-weight: 500;">${item.lineNumber}</span>
          </div>
          <div style="text-align: center; font-size: 11px; padding: 8px; border-right: 1px solid #e5e7eb; color: #1f2937; font-weight: 600;">${item.quantity}</div>
          <div style="text-align: center; font-size: 10px; padding: 8px; border-right: 1px solid #e5e7eb; color: #1f2937;">${firstNeedDate}</div>
          <div style="text-align: center; font-size: 11px; padding: 8px; border-right: 1px solid #e5e7eb; color: #9ca3af;">-</div>
          <div style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 11px; padding: 8px; border-right: 1px solid #e5e7eb; color: #1f2937;">${partAndDesc}</div>
          <div style="text-align: right; font-size: 11px; padding: 8px; border-right: 1px solid #e5e7eb; color: #1f2937;">$${(parseFloat(item.unitPrice) || 0).toFixed(2)}</div>
          <div style="text-align: right; font-size: 11px; padding: 8px; border-right: 1px solid #e5e7eb; color: #1f2937; font-weight: 600;">$${(parseFloat(item.total) || 0).toFixed(2)}</div>
          <div style="text-align: center; padding: 8px;">
            <button onclick="selectLineItemForTracking(${index}); event.stopPropagation();" 
                    style="padding: 4px 8px; background: #2a5298; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px; margin-right: 4px;"
                    title="Edit this line item">
              <i class="fas fa-edit"></i>
            </button>
            <button onclick="deleteLineItem(${index}); event.stopPropagation();" 
                    style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 11px;"
                    title="Delete this line item">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        `;
        
        tbody.appendChild(row);
      });
      
      console.log('‚úÖ Line items rendered');
    }

    function displayLineNotesFromPO(lineNotes, partNumbers) {
      // Parse part numbers - handle both arrays and concatenated strings
      let partNumberArray = [];
      if (Array.isArray(partNumbers)) {
        // If array, flatten and split any concatenated strings
        partNumberArray = partNumbers.flatMap(part => {
          if (typeof part === 'string' && part.includes('ÔøΩ')) {
            // Split concatenated part numbers by various database separators
            return part.split(/[ÔøΩƒ±ƒ±\u00ff\u00fe\u00fc]/).filter(p => p.trim());
          }
          return part;
        }).filter(p => p && p.trim());
      } else if (typeof partNumbers === 'string') {
        // Fallback: split by various separators if still coming as string
        partNumberArray = partNumbers.split(/[ÔøΩƒ±ƒ±\u00ff\u00fe\u00fc]/).filter(p => p.trim());
      }
      
      console.log('=== DISPLAYING LINE NOTES FROM PO ===');
      console.log('Line notes received:', lineNotes);
      console.log('Part numbers received:', partNumbers);
      console.log('Parsed part number array:', partNumberArray);
      console.log('Current lineItems array:', lineItems);
      console.log('Current lineItems length:', lineItems.length);
      
      // Integrate line notes into existing lineItems array
      if (lineNotes && lineNotes.length > 0 && partNumberArray.length > 0) {
        console.log('Processing', lineNotes.length, 'line notes...');
        
        lineNotes.forEach((note, index) => {
          const partNumber = partNumberArray[index];
          // Clean separators and control characters
          // CHAR(252) = \xFC (subvalue), CHAR(253) = \xFD (multivalue)
          const cleanNote = note.replace(/@[CT]@/g, ' ').replace(/[\xFC\xFD]/g, ' ').trim();
          
          console.log(`Processing note ${index + 1}:`, {partNumber, cleanNote});
          
          if (partNumber && cleanNote) {
            // Find matching line item by part number
            const matchingItem = lineItems.find(item => item.partNumber === partNumber);
            if (matchingItem) {
              // Add database note to existing line item
              const existingNotes = matchingItem.lineNotes || '';
              matchingItem.lineNotes = existingNotes ? `${existingNotes}\n[DB]: ${cleanNote}` : `[DB]: ${cleanNote}`;
              console.log(`‚úÖ Added database note to existing line item ${partNumber}:`, cleanNote);
            } else {
              // Create new line item from database data
              const newLineItem = {
                lineNumber: lineItems.length + 1,
                partNumber: partNumber,
                description: `Line item for part ${partNumber}`,
                quantity: 1,
                unitPrice: 0,
                total: 0,
                lineNotes: `[DB]: ${cleanNote}`,
                prodNotes: ''
              };
              lineItems.push(newLineItem);
              console.log(`‚úÖ Created new line item from database:`, newLineItem);
            }
          } else {
            console.log(`‚ùå Skipped note ${index + 1} - missing part number or note content`);
          }
        });
        
        console.log('Final lineItems array after processing:', lineItems);
        console.log('Final lineItems length:', lineItems.length);
        
        // Re-render line items to show integrated notes
        console.log('Calling renderLineItems()...');
        renderLineItems();
        console.log('renderLineItems() completed');
        
        // Force another render after a small delay to ensure DOM is ready
        setTimeout(() => {
          console.log('Force re-rendering line items after delay...');
          renderLineItems();
          console.log('Force re-render completed');
        }, 500);
      } else {
        console.log('‚ùå Cannot process line notes - missing data:', {
          hasLineNotes: !!(lineNotes && lineNotes.length > 0),
          hasPartNumbers: !!(partNumberArray.length > 0),
          lineNotesLength: lineNotes ? lineNotes.length : 0,
          partNumbersLength: partNumberArray.length
        });
      }
      
      // Populate line notes directly in the form field
      const lineNotesField = document.getElementById('lineNotes');
      console.log('Looking for lineNotes field:', lineNotesField);
      
      if (lineNotes && lineNotes.length > 0) {
        // Combine all line notes with part numbers
        const combinedNotes = lineNotes.map((note, index) => {
          const partNumber = partNumberArray[index] || `Line ${index + 1}`;
          // CHAR(252) = \xFC (subvalue), CHAR(253) = \xFD (multivalue)
          const cleanNote = note.replace(/@[CT]@/g, ' ').replace(/[\xFC\xFD]/g, ' ').trim();
          return `${partNumber}: ${cleanNote}`;
        }).join('\n');
        
        console.log('Combined notes to populate:', combinedNotes);
        
        if (lineNotesField) {
          lineNotesField.value = combinedNotes;
          console.log('Successfully populated lineNotes field');
        } else {
          // If field not found immediately, try again after a short delay
          console.log('lineNotes field not found, trying again in 100ms');
          setTimeout(() => {
            const delayedField = document.getElementById('lineNotes');
            if (delayedField) {
              delayedField.value = combinedNotes;
              console.log('Successfully populated lineNotes field (delayed)');
            } else {
              console.log('lineNotes field still not found after delay');
            }
          }, 100);
        }
      }
      
      // Also create a display section for reference
      const existingNotesSection = document.getElementById('existingLineNotesSection') || 
        (() => {
          const section = document.createElement('div');
          section.id = 'existingLineNotesSection';
          section.style.cssText = 'margin: 16px 0; padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px;';
          section.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 8px; color: #374151;">üìù Line Notes from Database (Auto-populated in form)</div>
            <div id="existingNotesContent"></div>
          `;
          
          // Insert after line items header in tab 2
          const tab2 = document.getElementById('tab-2');
          if (tab2) {
            const firstChild = tab2.firstElementChild;
            tab2.insertBefore(section, firstChild?.nextSibling || firstChild);
          }
          return section;
        })();
      
      const contentDiv = document.getElementById('existingNotesContent');
      let html = '';
      
      lineNotes.forEach((note, index) => {
        const partNumber = partNumberArray[index] || `Line ${index + 1}`;
        const cleanNote = note.replace(/@[CT]@/g, ' ').trim();
        
        html += `
          <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #3b82f6;">
            <div style="font-size: 10px; font-weight: 500; color: #6b7280; margin-bottom: 2px;">${partNumber}</div>
            <div style="font-size: 11px; color: #374151;">${cleanNote}</div>
          </div>
        `;
      });
      
      contentDiv.innerHTML = html;
    }

    function displayAcknowledgmentsFromPO(acknowledgments) {
      console.log('Displaying acknowledgments from PO:', acknowledgments);
      
      // Create a section to display existing acknowledgments from PO
      const existingAckSection = document.getElementById('existingAckSection') || 
        (() => {
          const section = document.createElement('div');
          section.id = 'existingAckSection';
          section.style.cssText = 'margin: 16px 0; padding: 12px; background: #fef3f2; border: 1px solid #fecaca; border-radius: 6px;';
          section.innerHTML = `
            <div style="font-weight: 600; margin-bottom: 8px; color: #dc2626;">‚úÖ Existing Acknowledgments from Database</div>
            <div id="existingAckContent"></div>
          `;
          
          // Insert after existing notes section in tab 2
          const tab2 = document.getElementById('tab-2');
          const notesSection = document.getElementById('existingLineNotesSection');
          if (tab2) {
            if (notesSection) {
              tab2.insertBefore(section, notesSection.nextSibling);
            } else {
              const firstChild = tab2.firstElementChild;
              tab2.insertBefore(section, firstChild?.nextSibling || firstChild);
            }
          }
          return section;
        })();
      
      const contentDiv = document.getElementById('existingAckContent');
      let html = '';
      
      // Process acknowledgments structure - should be array of ack_line objects
      if (acknowledgments.ack_line) {
        const ackLines = Array.isArray(acknowledgments.ack_line) ? acknowledgments.ack_line : [acknowledgments.ack_line];
        
        ackLines.forEach((ackLine, lineIndex) => {
          if (ackLine.ack_entry) {
            const ackEntries = Array.isArray(ackLine.ack_entry) ? ackLine.ack_entry : [ackLine.ack_entry];
            
            ackEntries.forEach((entry, entryIndex) => {
              html += `
                <div style="margin-bottom: 8px; padding: 8px; background: white; border-radius: 4px; border-left: 3px solid #dc2626;">
                  <div style="font-size: 10px; font-weight: 500; color: #6b7280; margin-bottom: 2px;">Line ${lineIndex + 1} - ACK ${entryIndex + 1}</div>
                  <div style="font-size: 11px; color: #374151;">
                    <strong>Date:</strong> ${entry.date || 'N/A'} | <strong>Quantity:</strong> ${entry.quantity || 'N/A'}
                  </div>
                </div>
              `;
            });
          }
        });
      }
      
      if (html === '') {
        html = '<div style="font-size: 11px; color: #6b7280; font-style: italic;">No acknowledgments found in database.</div>';
      }
      
      contentDiv.innerHTML = html;
    }

    function populateAcknowledgmentFieldsFixed(acknowledgments, targetLineIndex = null) {
      console.log('=== POPULATE ACKNOWLEDGMENT FIELDS FIXED ===');
      console.log('Raw acknowledgments data:', acknowledgments);
      console.log('Target line index:', targetLineIndex);

      // PRESERVE user-edited fields - only clear empty fields
      console.log('üîí PRESERVING USER-EDITED ACK FIELDS');
      for (let i = 1; i <= 5; i++) {
        const dateField = document.getElementById(`ackDate${i}`);
        const qtyField = document.getElementById(`ackQty${i}`);
        
        if (dateField && !dateField.hasAttribute('data-user-edited') && !dateField.value) {
          dateField.value = '';
          console.log(`üßπ Cleared empty ackDate${i}`);
        } else if (dateField) {
          console.log(`üîí PRESERVED ackDate${i} = "${dateField.value}" (has data or user-edited)`);
        }
        
        if (qtyField && !qtyField.hasAttribute('data-user-edited') && !qtyField.value) {
          qtyField.value = '';
          console.log(`üßπ Cleared empty ackQty${i}`);
        } else if (qtyField) {
          console.log(`üîí PRESERVED ackQty${i} = "${qtyField.value}" (has data or user-edited)`);
        }
      }

      if (acknowledgments.ack_field49) {
        console.log('Processing ack_field49:', acknowledgments.ack_field49);
        const ackField49 = acknowledgments.ack_field49;
        
        // Parse using subvalue separator (CHAR 252 = backslash)
        const entries = [];
        
        // Handle both corruption chars and actual backslashes from XML transmission
        let cleanedField49 = ackField49;
        if (cleanedField49.includes('ÔøΩ')) {
          cleanedField49 = cleanedField49.replace(/ÔøΩ/g, ']');
          console.log('Replaced corruption chars (XVM) with multivalue separators:', cleanedField49);
        }
        
        // Fix double separators that might occur from corruption replacement
        cleanedField49 = cleanedField49.replace(/\]\]/g, ']');
        console.log('Fixed double multivalue separators:', cleanedField49);
        
        // First split by multivalue separator (]) to get data for each line item
        const lineItemData = cleanedField49.split(']');
        console.log('Split ack_field49 by line items:', lineItemData);
        
        // Select data for target line item (0-based index)
        let targetData = '';
        if (lineItemData.length === 1) {
          // No multivalue separation found - all data is in one block
          // Split by subvalues and take only the portion for target line
          const allSegments = lineItemData[0].split('\\');
          console.log('‚ö†Ô∏è No multivalue separation detected. All segments:', allSegments);
          
          if (targetLineIndex !== null) {
            // No multivalue separation means ALL subvalues belong to LINE ITEM 0 ONLY
            // CHAR(252) \ = subvalue separator = multiple entries for SAME line item
            // CHAR(253) ] = multivalue separator = different line items
            
            if (targetLineIndex === 0) {
              // Line item 0 gets ALL segments (all acknowledgments belong to this line item)
              targetData = allSegments.join('\\');
              console.log(`üîß Line item ${targetLineIndex}: Using ALL segments (no multivalue separation):`, targetData);
            } else {
              // Other line items get nothing (no data for them when no multivalue separation)
              targetData = '';
              console.log(`üîß Line item ${targetLineIndex}: No data (no multivalue separation exists):`, targetData);
            }
          } else {
            // GLOBAL MODE: Show ALL acknowledgments from all line items
            targetData = allSegments.join('\\');
            console.log(`üåç GLOBAL MODE: Using ALL segments:`, targetData);
          }
        } else if (targetLineIndex !== null && lineItemData[targetLineIndex]) {
          targetData = lineItemData[targetLineIndex];
          console.log(`Using data for line item ${targetLineIndex}:`, targetData);
        } else if (targetLineIndex === null && lineItemData.length > 0) {
          // GLOBAL MODE: Combine all line item data to show ALL acknowledgments
          targetData = lineItemData.join('\\');
          console.log('üåç GLOBAL MODE: Combining ALL line item data:', targetData);
        }
        
        if (targetData) {
          // Split on backslash (subvalue separator \) to get individual segments
          let segments = targetData.split('\\');
          console.log('Split target line segments:', segments);
          
          // Remove duplicates in global mode (targetLineIndex === null)
          if (targetLineIndex === null) {
            const uniqueSegments = [];
            const seen = new Set();
            segments.forEach(segment => {
              if (segment && segment.trim() && !seen.has(segment)) {
                uniqueSegments.push(segment);
                seen.add(segment);
              }
            });
            segments = uniqueSegments;
            console.log('üåç GLOBAL MODE: Removed duplicates, unique segments:', segments);
          }
          
          segments.forEach((segment, index) => {
            if (segment.includes('*')) {
              const [dateStr, qtyStr] = segment.split('*');
              if (dateStr && qtyStr) {
                // Convert Julian to readable date if needed
                let displayDate;
                if (/^\d{5}$/.test(dateStr)) {
                  // Julian date - convert to YYYY-MM-DD
                  displayDate = convertJulianToDate(dateStr);
                } else {
                  displayDate = dateStr;
                }
                
                entries.push({
                  date: displayDate,
                  qty: qtyStr.trim()
                });
                console.log(`Parsed segment ${index}: "${dateStr}" (${displayDate}) ‚Üí qty "${qtyStr}"`);
              }
            }
          });
        }

        if (entries.length > 0) {
          console.log('Successfully parsed entries:', entries);
          entries.forEach((entry, index) => {
            if (index < 5) {
              const dateField = document.getElementById(`ackDate${index + 1}`);
              const qtyField = document.getElementById(`ackQty${index + 1}`);

              if (dateField && entry.date) {
                // Only populate if NOT user-edited AND field is empty
                if (!dateField.hasAttribute('data-user-edited') && !dateField.value) {
                  dateField.value = entry.date;
                  console.log(`‚úÖ Set ackDate${index + 1} = "${entry.date}" (empty and not user-edited)`);
                } else if (dateField.hasAttribute('data-user-edited')) {
                  console.log(`üîí Preserved ackDate${index + 1} = "${dateField.value}" (user-edited, skipping backend data)`);
                } else if (dateField.value) {
                  console.log(`üîí Preserved ackDate${index + 1} = "${dateField.value}" (has value, skipping backend data)`);
                }
                
                // Add event listener to track user edits
                if (!dateField.hasAttribute('data-listener-added')) {
                  dateField.addEventListener('change', function() {
                    this.setAttribute('data-user-edited', 'true');
                  });
                  dateField.setAttribute('data-listener-added', 'true');
                }
              }

              if (qtyField && entry.qty) {
                // Only populate if NOT user-edited AND field is empty
                if (!qtyField.hasAttribute('data-user-edited') && !qtyField.value) {
                  qtyField.value = entry.qty;
                  console.log(`‚úÖ Set ackQty${index + 1} = "${entry.qty}" (empty and not user-edited)`);
                } else if (qtyField.hasAttribute('data-user-edited')) {
                  console.log(`üîí Preserved ackQty${index + 1} = "${qtyField.value}" (user-edited, skipping backend data)`);
                } else if (qtyField.value) {
                  console.log(`üîí Preserved ackQty${index + 1} = "${qtyField.value}" (has value, skipping backend data)`);
                }
                
                // Add event listener to track user edits for qty field
                if (!qtyField.hasAttribute('data-listener-added')) {
                  qtyField.addEventListener('change', function() {
                    this.setAttribute('data-user-edited', 'true');
                  });
                  qtyField.setAttribute('data-listener-added', 'true');
                }
              }
            }
          });
        } else {
          console.log('‚ùå No valid date*qty patterns could be parsed from ack_field49');
        }

        // Clear remaining empty acknowledgment fields (like needFields does)
        console.log('üßπ CLEARING REMAINING ACK FIELDS: Ensuring all 5 ack rows are visible');
        for (let i = 1; i <= 5; i++) {
          const ackDateField = document.getElementById(`ackDate${i}`);
          const ackQtyField = document.getElementById(`ackQty${i}`);
          
          // Only clear if field is empty AND not user-edited
          if (ackDateField && !ackDateField.value && !ackDateField.hasAttribute('data-user-edited')) {
            ackDateField.value = '';
            console.log(`üßπ Cleared empty ackDate${i} for visibility`);
          }
          if (ackQtyField && !ackQtyField.value && !ackQtyField.hasAttribute('data-user-edited')) {
            ackQtyField.value = '';
            console.log(`üßπ Cleared empty ackQty${i} for visibility`);
          }
        }

        return;
      }

      // REMOVED: Individual ack_date/ack_qty processing - backend no longer returns these fields
      // All acknowledgment processing is now handled via ack_field49 only

      console.log('=== ACKNOWLEDGMENT FIELDS POPULATION COMPLETE ===');
    }

    function populateNeedFieldsFixed(needsInfo) {
      console.log('=== POPULATE NEED FIELDS FIXED ===');
      console.log('Raw needs_info data:', needsInfo);
      console.log('üîç DEBUG POPULATE: needs_info type:', typeof needsInfo);
      console.log('üîç DEBUG POPULATE: needsInfo detailed:', JSON.stringify(needsInfo, null, 2));
      console.log('üîç DEBUG POPULATE: needs_info is array:', Array.isArray(needsInfo));
      console.log('üîç DEBUG POPULATE: needs_info length:', needsInfo?.length);

      // PRESERVE user-edited fields - only clear empty fields
      console.log('üîí PRESERVING USER-EDITED NEED FIELDS');
      for (let i = 1; i <= 5; i++) {
        const dateField = document.getElementById(`needDate${i}`);
        const qtyField = document.getElementById(`needQty${i}`);
        
        if (dateField && !dateField.hasAttribute('data-user-edited') && !dateField.value) {
          dateField.value = '';
          console.log(`üßπ Cleared empty needDate${i}`);
        } else if (dateField) {
          console.log(`üîí PRESERVED needDate${i} = "${dateField.value}" (has data or user-edited)`);
        }
        
        if (qtyField && !qtyField.hasAttribute('data-user-edited') && !qtyField.value) {
          qtyField.value = '';
          console.log(`üßπ Cleared empty needQty${i}`);
        } else if (qtyField) {
          console.log(`üîí PRESERVED needQty${i} = "${qtyField.value}" (has data or user-edited)`);
        }
      }

      if (needsInfo && Array.isArray(needsInfo) && needsInfo.length > 0) {
        console.log('Processing needs_info entries:', needsInfo);
        
        needsInfo.forEach((needEntry, index) => {
          console.log(`üîç DEBUG ITERATE: Processing entry ${index}:`, needEntry);
          console.log(`üîç DEBUG ITERATE DETAILS: entry ${index} - need_date="${needEntry.need_date || needEntry.date}", need_qty="${needEntry.need_qty || needEntry.qty}"`);
          if (index < 5) { // Only populate first 5 fields
            const dateField = document.getElementById(`needDate${index + 1}`);
            const qtyField = document.getElementById(`needQty${index + 1}`);
            console.log(`üîç DEBUG FIELDS: needDate${index + 1} exists:`, !!dateField, 'needQty${index + 1} exists:', !!qtyField);
            console.log(`üîç DEBUG FIELD VALUES BEFORE: needDate${index + 1}="${dateField?.value}", needQty${index + 1}="${qtyField?.value}"`);
            
            if (dateField && needEntry.need_date && !dateField.value) {
              // ONLY populate if field is EMPTY - NEVER overwrite existing data
              let displayDate;
              if (/^\d{5}$/.test(needEntry.need_date)) {
                // Julian date - convert to YYYY-MM-DD
                displayDate = convertJulianToDate(needEntry.need_date);
              } else {
                displayDate = needEntry.need_date;
              }
              
              dateField.value = displayDate;
              console.log(`‚úÖ Set needDate${index + 1} = "${displayDate}" (field was empty)`);
            } else if (dateField && needEntry.need_date && dateField.value) {
              console.log(`üîí PRESERVED needDate${index + 1} = "${dateField.value}" (already has data, not overwriting)`);
            }
            
            if (qtyField && needEntry.need_qty && !qtyField.value) {
              // ONLY populate if field is EMPTY - NEVER overwrite existing data
              qtyField.value = needEntry.need_qty;
              console.log(`‚úÖ Set needQty${index + 1} = "${needEntry.need_qty}" (field was empty)`);
            } else if (qtyField && needEntry.need_qty && qtyField.value) {
              console.log(`üîí PRESERVED needQty${index + 1} = "${qtyField.value}" (already has data, not overwriting)`);
            }
          }
        });
      } else {
        console.log('‚ùå No valid needs_info entries found');
      }
      
      console.log('=== NEED FIELDS POPULATION COMPLETE ===');
    }

    function useGlobalAcknowledmentData(soData) {
      console.log('=== USING GLOBAL ACKNOWLEDGMENT DATA ===');

      // Check if any acknowledgment fields have been user-edited or have values
      let hasUserEditedFields = false;
      let hasPopulatedFields = false;
      
      for (let i = 1; i <= 5; i++) {
        const dateField = document.getElementById(`ackDate${i}`);
        const qtyField = document.getElementById(`ackQty${i}`);
        
        if (dateField && dateField.hasAttribute('data-user-edited')) {
          hasUserEditedFields = true;
        }
        if (qtyField && qtyField.hasAttribute('data-user-edited')) {
          hasUserEditedFields = true;
        }
        if (dateField && dateField.value) {
          hasPopulatedFields = true;
        }
        if (qtyField && qtyField.value) {
          hasPopulatedFields = true;
        }
      }
      
      if (hasUserEditedFields || hasPopulatedFields) {
        console.log('üîí SKIPPING useGlobalAcknowledmentData - fields already populated or user-edited');
        console.log(`  hasUserEditedFields: ${hasUserEditedFields}, hasPopulatedFields: ${hasPopulatedFields}`);
        return;
      }

      // PRESERVE USER EDITED FIELDS - Only clear if NOT user-edited
      for (let i = 1; i <= 5; i++) {
        const dateField = document.getElementById(`ackDate${i}`);
        const qtyField = document.getElementById(`ackQty${i}`);
        
        // Only clear if field is completely empty AND not user-edited
        if (dateField && !dateField.hasAttribute('data-user-edited') && !dateField.value) {
          console.log(`üîç USEGLOB DEBUG ackDate${i}: value="${dateField.value}", hasUserEdited=${dateField.hasAttribute('data-user-edited')}, attributes=${Array.from(dateField.attributes).map(a => a.name).join(',')}`);
          dateField.value = '';
          console.log(`üßπ useGlobalAcknowledmentData: Cleared ackDate${i} (empty and not user-edited)`);
        } else if (dateField) {
          console.log(`üîç USEGLOB DEBUG ackDate${i}: value="${dateField.value}", hasUserEdited=${dateField.hasAttribute('data-user-edited')}, attributes=${Array.from(dateField.attributes).map(a => a.name).join(',')}`);
          if (dateField.hasAttribute('data-user-edited')) {
            console.log(`üîí useGlobalAcknowledmentData: Preserved ackDate${i} = "${dateField.value}" (user-edited)`);
          } else {
            console.log(`üîí useGlobalAcknowledmentData: Preserved ackDate${i} = "${dateField.value}" (has value)`);
          }
        }
        
        // Only clear if field is completely empty AND not user-edited
        if (qtyField && !qtyField.hasAttribute('data-user-edited') && !qtyField.value) {
          qtyField.value = '';
          console.log(`üßπ useGlobalAcknowledmentData: Cleared ackQty${i} (empty and not user-edited)`);
        } else if (qtyField) {
          if (qtyField.hasAttribute('data-user-edited')) {
            console.log(`üîí useGlobalAcknowledmentData: Preserved ackQty${i} = "${qtyField.value}" (user-edited)`);
          } else {
            console.log(`üîí useGlobalAcknowledmentData: Preserved ackQty${i} = "${qtyField.value}" (has value)`);
          }
        }
      }

      if (soData.globalAcks && Array.isArray(soData.globalAcks)) {
        console.log('Processing globalAcks array:', soData.globalAcks);

        soData.globalAcks.forEach((ackEntry, index) => {
          if (index < 5 && ackEntry.ackDate && ackEntry.ackQty) {
            const ackDateField = document.getElementById(`ackDate${index + 1}`);
            const ackQtyField = document.getElementById(`ackQty${index + 1}`);

            // Only populate if field is empty (preserve user input) - SAME AS SCHEDULES
            if (ackDateField && ackEntry.ackDate && !ackDateField.value) {
              ackDateField.value = ackEntry.ackDate;
              console.log(`Set ackDate${index + 1} = "${ackEntry.ackDate}" (field was empty)`);
              
              // Add event listener to track user edits
              if (!ackDateField.hasAttribute('data-listener-added')) {
                ackDateField.addEventListener('change', function() {
                  this.setAttribute('data-user-edited', 'true');
                  console.log(`üîß User edited ${this.id}, marked as user-edited`);
                });
                ackDateField.setAttribute('data-listener-added', 'true');
              }
            } else if (ackDateField?.value) {
              console.log(`üîí Preserved ackDate${index + 1} = "${ackDateField.value}" (user input)`);
            }

            if (ackQtyField && ackEntry.ackQty && !ackQtyField.value) {
              ackQtyField.value = ackEntry.ackQty;
              console.log(`Set ackQty${index + 1} = "${ackEntry.ackQty}" (field was empty)`);
            } else if (ackQtyField?.value) {
              console.log(`üîí Preserved ackQty${index + 1} = "${ackQtyField.value}" (user input)`);
            }
          }
        });
      } else {
        console.log('No globalAcks array available, falling back to acknowledgments parsing');

        if (soData.acknowledgments && soData.acknowledgments.ack_field49) {
          populateAcknowledgmentFieldsFixed(soData.acknowledgments);
        }
      }
    }

    function populateNeedFields(needs, lineItemIndex = null) {
      console.log('=== POPULATE NEED FIELDS CALLED ===');
      console.log('üîç Raw needs data from server:', needs);
      console.log('üîç Filtering for line item index:', lineItemIndex);
      console.log('üîç Type of needs:', typeof needs);
      console.log('üîç Is needs null/undefined?', needs === null || needs === undefined);
      
      // Clear all need fields first
      for (let i = 1; i <= 5; i++) {
        const dateField = document.getElementById(`needDate${i}`);
        const qtyField = document.getElementById(`needQty${i}`);
        if (dateField) dateField.value = '';
        if (qtyField) qtyField.value = '';
      }
      
      // If no needs data from server, don't show anything
      if (!needs || needs === null || needs === undefined) {
        console.log('üö´ No needs data from server - clearing all fields and returning');
        return;
      }
      
      // Collect unique valid entries
      const uniqueEntries = new Map();
      
      // Process needs structure
      if (needs.need_line) {
        console.log('üîç Processing need_line data:', needs.need_line);
        const needLines = Array.isArray(needs.need_line) ? needs.need_line : [needs.need_line];
        console.log(`üîç Found ${needLines.length} need lines to process`);
        
        // If filtering by line item, only process that specific line
        const linesToProcess = lineItemIndex !== null ? 
          [needLines[lineItemIndex]].filter(Boolean) : needLines;
        console.log(`üîç Processing ${linesToProcess.length} lines (filtered: ${lineItemIndex !== null})`);
        
        for (const needLine of linesToProcess) {
          console.log('üîç Processing needLine:', needLine);
          
          // Handle both structures: {need_entry: [...]} or {date: 'xxx', quantity: 'yyy'} directly
          let needEntries = [];
          
          if (needLine.need_entry) {
            needEntries = Array.isArray(needLine.need_entry) ? needLine.need_entry : [needLine.need_entry];
            console.log(`üîç Found ${needEntries.length} need entries in this line:`, needEntries);
          } else if (needLine.date && needLine.quantity) {
            // Direct structure: the needLine itself IS the entry
            needEntries = [needLine];
            console.log('üîç Using needLine directly as entry:', needLine);
          } else {
            console.log('üîç No need_entry in needLine:', needLine);
            continue;
          }
            
          for (const entry of needEntries) {
            console.log('üîç Raw entry from server:', entry);
            console.log('üîç Entry date:', entry.date, 'Entry quantity:', entry.quantity);
              
              // Only process entries that actually have data from server
              if (entry.date && entry.quantity && 
                  entry.date.trim() !== '' && entry.quantity.trim() !== '' &&
                  entry.date !== 'undefined' && entry.quantity !== 'undefined') {
                
                const dateValue = convertDateFormat(entry.date) || entry.date;
                const qtyValue = parseFloat(entry.quantity);
                
                console.log('üîç Converted values - Date:', dateValue, 'Qty:', qtyValue);
                
                // Skip invalid dates or quantities
                if (!dateValue || isNaN(qtyValue) || qtyValue <= 0) {
                  console.log('üö´ Skipping invalid entry:', entry);
                  continue;
                }
                
                // Use date as key to avoid duplicates, but sum quantities for same date
                const dateKey = dateValue;
                if (uniqueEntries.has(dateKey)) {
                  // If same date exists, add quantities
                  const existing = uniqueEntries.get(dateKey);
                  existing.quantity = existing.quantity + qtyValue;
                  console.log(`‚úÖ Updated existing date ${dateKey} with additional qty:`, existing);
                } else {
                  uniqueEntries.set(dateKey, {
                    date: dateValue,
                    quantity: qtyValue
                  });
                  console.log(`‚úÖ Added new unique entry from server:`, { date: dateValue, quantity: qtyValue });
                }
              } else {
                console.log('üö´ Skipping entry with empty/invalid server data:', entry);
              }
            }
        }
      } else {
        console.log('üö´ No need_line in needs data:', needs);
      }
      
      // Populate fields with unique entries only
      let fieldIndex = 1;
      for (const [dateKey, entryData] of uniqueEntries) {
        if (fieldIndex <= 5) {
          const dateField = document.getElementById(`needDate${fieldIndex}`);
          const qtyField = document.getElementById(`needQty${fieldIndex}`);
          
          console.log(`üîç POPULATE DEBUG ${fieldIndex}:`, {
            dateKey: dateKey,
            entryData: entryData,
            dateFieldExists: !!dateField,
            qtyFieldExists: !!qtyField
          });
          
          if (dateField && !dateField.value) {
            // ONLY populate if field is EMPTY - NEVER overwrite existing data
            dateField.value = entryData.date;
            console.log(`‚úÖ Set needDate${fieldIndex} to:`, entryData.date, '(field was empty)');
          } else if (dateField && dateField.value) {
            console.log(`üîí PRESERVED needDate${fieldIndex} = "${dateField.value}" (already has data, not overwriting)`);
          }
          
          if (qtyField && !qtyField.value) {
            // ONLY populate if field is EMPTY - NEVER overwrite existing data
            qtyField.value = entryData.quantity;
            console.log(`‚úÖ Set needQty${fieldIndex} to:`, entryData.quantity, '(field was empty)');
          } else if (qtyField && qtyField.value) {
            console.log(`üîí PRESERVED needQty${fieldIndex} = "${qtyField.value}" (already has data, not overwriting)`);
          }
          
          fieldIndex++;
        }
      }
      
      console.log(`Populated ${fieldIndex - 1} unique need entries out of ${uniqueEntries.size} total unique dates`);
    }

    function populateScheduleFields(schedule, lineItemIndex = null) {
      console.log('=== POPULATE SCHEDULE FIELDS CALLED ===');
      console.log('Populating schedule fields with:', schedule);
      console.log('Filtering for line item index:', lineItemIndex);
      
      // Check if the DOM elements exist
      const testField = document.getElementById('lineScheduleDate1');
      console.log('lineScheduleDate1 field exists:', !!testField);
      if (testField) {
        console.log('lineScheduleDate1 field current value:', testField.value);
      }
      
      // PRESERVE user-edited fields - only clear empty fields  
      console.log('üîí PRESERVING USER-EDITED SCHEDULE FIELDS');
      for (let i = 1; i <= 5; i++) {
        const dateField = document.getElementById(`lineScheduleDate${i}`);
        const qtyField = document.getElementById(`lineScheduleQty${i}`);
        
        if (dateField && !dateField.hasAttribute('data-user-edited') && !dateField.value) {
          dateField.value = '';
          console.log(`üßπ Cleared empty lineScheduleDate${i}`);
        } else if (dateField) {
          console.log(`üîí PRESERVED lineScheduleDate${i} = "${dateField.value}" (has data or user-edited)`);
        }
        
        if (qtyField && !qtyField.hasAttribute('data-user-edited') && !qtyField.value) {
          qtyField.value = '';
          console.log(`üßπ Cleared empty lineScheduleQty${i}`);
        } else if (qtyField) {
          console.log(`üîí PRESERVED lineScheduleQty${i} = "${qtyField.value}" (has data or user-edited)`);
        }
      }
      
      let fieldIndex = 1;
      
      // Process schedule structure
      if (schedule.schedule_line) {
        const scheduleLines = Array.isArray(schedule.schedule_line) ? schedule.schedule_line : [schedule.schedule_line];
        
        // Filter by line item index if specified
        const linesToProcess = lineItemIndex !== null ? 
          [scheduleLines[lineItemIndex]].filter(Boolean) : 
          scheduleLines;
        
        console.log(`Original scheduleLines:`, scheduleLines);
        console.log(`Filtering for lineItemIndex: ${lineItemIndex}`);
        console.log(`LinesToProcess:`, linesToProcess);
        
        console.log(`Processing ${linesToProcess.length} schedule lines (filtered: ${lineItemIndex !== null})`);
        
        for (const scheduleLine of linesToProcess) {
          if (scheduleLine.schedule_entry && fieldIndex <= 5) {
            const scheduleEntries = Array.isArray(scheduleLine.schedule_entry) ? scheduleLine.schedule_entry : [scheduleLine.schedule_entry];
            
            for (const entry of scheduleEntries) {
              if (fieldIndex <= 5) {
                console.log(`Processing schedule entry:`, entry);
                const dateField = document.getElementById(`lineScheduleDate${fieldIndex}`);
                const qtyField = document.getElementById(`lineScheduleQty${fieldIndex}`);
                
                if (dateField && entry.date && !dateField.value) {
                  // ONLY populate if field is EMPTY - NEVER overwrite existing data
                  // Convert date format from MM-DD-YYYY to YYYY-MM-DD for input[type="date"]
                  const dateParts = entry.date.split('-');
                  if (dateParts.length === 3) {
                    const formattedDate = `${dateParts[2]}-${dateParts[0].padStart(2, '0')}-${dateParts[1].padStart(2, '0')}`;
                    dateField.value = formattedDate;
                    console.log('Set date field value to:', formattedDate, '(field was empty)');
                  }
                } else if (dateField && entry.date && dateField.value) {
                  console.log(`üîí PRESERVED lineScheduleDate${fieldIndex} = "${dateField.value}" (already has data, not overwriting)`);
                }
                
                if (qtyField && entry.quantity && !qtyField.value) {
                  // ONLY populate if field is EMPTY - NEVER overwrite existing data
                  qtyField.value = entry.quantity;
                  console.log('Set qty field value to:', entry.quantity, '(field was empty)');
                } else if (qtyField && entry.quantity && qtyField.value) {
                  console.log(`üîí PRESERVED lineScheduleQty${fieldIndex} = "${qtyField.value}" (already has data, not overwriting)`);
                }
                
                fieldIndex++;
              }
            }
          }
        }
      }
      
      console.log(`Populated ${fieldIndex - 1} schedule entries`);
    }

    function toggleLineNotes(index) {
      const notesDiv = document.getElementById(`notes-${index}`);
      if (notesDiv) {
        const isVisible = notesDiv.style.display !== 'none';
        notesDiv.style.display = isVisible ? 'none' : 'block';
        
        // Update the eye icon
        const button = event.target.closest('button');
        const icon = button.querySelector('i');
        if (icon) {
          icon.className = isVisible ? 'fas fa-eye' : 'fas fa-eye-slash';
        }
      }
    }

    function updatePOTotals() {
      const subtotalEl = document.getElementById('subtotalInput');
      const taxEl = document.getElementById('taxAmountInput');
      const shipEl = document.getElementById('shippingCostInput');
      const totalEl = document.getElementById('totalAmountInput');
      if (!subtotalEl || !totalEl) return; // Totals UI not present
      const subtotal = lineItems.reduce((sum, item) => {
        // Convert total to dollars if it's in cents
        const totalInDollars = item.totalIsCents ? (item.total / 100) : item.total;
        return sum + totalInDollars;
      }, 0);
      subtotalEl.value = subtotal.toFixed(2);
      const taxAmount = taxEl ? (parseFloat(taxEl.value) || 0) : 0;
      const shippingCost = shipEl ? (parseFloat(shipEl.value) || 0) : 0;
      const total = subtotal + taxAmount + shippingCost;
      totalEl.value = total.toFixed(2);
    }

    // Add event listeners
    window.addEventListener('DOMContentLoaded', function() {
      loadCustomers();
      loadShipVias();
      
      // Initialize tracking rows
      initializeTrackingRows();
      
      // Add event listeners for line item calculation
      const quantityInput = document.getElementById('lineQuantity');
      const unitPriceInput = document.getElementById('lineUnitPrice');
      
      if (quantityInput) quantityInput.addEventListener('input', calculateLineTotal);
      if (unitPriceInput) unitPriceInput.addEventListener('input', calculateLineTotal);
      
      // Add event listeners for PO total calculation
      const taxInput = document.getElementById('taxAmountInput');
      const shippingInput = document.getElementById('shippingCostInput');
      
      if (taxInput) taxInput.addEventListener('input', updatePOTotals);
      if (shippingInput) shippingInput.addEventListener('input', updatePOTotals);
      
    });
  </script>

  <style>
    .sidebar {
            position: fixed !important;
            top: 0 !important;
            left: -300px !important;
            width: 300px !important;
            height: 100vh !important;
            background: rgba(255, 255, 255, .08) !important;
            backdrop-filter: blur(1px) !important;
            -webkit-backdrop-filter: blur(1px) !important;
            color: white !important;
            transition: left 0.2s ease !important;
            z-index: 2000 !important;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3) !important;
            overflow: hidden !important;
            border-radius: 0 !important;
    }
    .sidebar.active { left: 0 !important; }
    .sidebar-overlay {
            position: fixed !important; 
            top: 0 !important; 
            left: 0 !important; 
            width: 100vw !important; 
            height: 100vh !important;
            background: rgba(0, 0, 0, 0.5) !important; 
            opacity: 0 !important; 
            visibility: hidden !important;
            transition: all 0.3s ease !important; 
            z-index: 999 !important; 
            pointer-events: none !important;
    }
    .sidebar-overlay.active { 
            opacity: 1 !important; 
            visibility: visible !important; 
            pointer-events: auto !important; 
    }
    #sb-toggle:checked ~ .sidebar-overlay { 
            opacity: 1 !important; 
            visibility: visible !important; 
            pointer-events: auto !important; 
    }
    .sidebar-content { padding: 24px !important; }
    .sidebar-header {
            padding: 20px !important; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
            background: rgba(255, 255, 255, 0.05) !important;
            margin: 0 !important;
            border-radius: 0 !important;
    }
    .sidebar-header h3 { 
            font-size: 1.2em !important; 
            color: white !important; 
            margin: 0 !important; 
    }
    .sidebar-menu { 
            list-style: none !important; 
            padding: 0 !important; 
            margin: 0 !important; 
    }
    .sidebar-menu li { margin-bottom: 8px !important; }
    .sidebar-menu a, .sidebar-menu label {
            display: block !important;
            padding: 12px 16px !important;
            color: #f3f4f6 !important;
            text-decoration: none !important;
            border-radius: 8px !important;
            transition: all 0.2s ease !important;
            font-weight: 500 !important;
    }
    .sidebar-menu a:hover, .sidebar-menu label:hover { 
            background-color: rgba(30, 64, 175, 0.1) !important; 
            color: white !important; 
    }
    .sidebar-menu a.active, .sidebar-menu label.active { 
            background-color: rgba(30, 64, 175, 0.2) !important; 
            color: #93c5fd !important; 
    }
    .sidebar-menu a i, .sidebar-menu label i { 
            margin-right: 12px !important; 
            width: 20px !important; 
            text-align: center !important; 
    }
    .sidebar-menu label { cursor: pointer !important; }
    #sb-toggle { position: absolute; left: -9999px; }
    #sb-toggle:checked ~ .sidebar { left: 0 !important; }
    #sb-toggle:checked ~ .sidebar-overlay { 
            opacity: 1 !important; 
            visibility: visible !important; 
            pointer-events: auto !important; 
    }
    .hamburger-menu { font-size: 1.1em !important; padding: 6px !important; line-height: 1 !important; display: inline-flex !important; align-items: center !important; justify-content: center !important; }
    .hamburger-menu svg { width: 1em; height: 1em; fill: currentColor; display: inline-block; vertical-align: -0.125em; }
    .tab-navigation { background: #fff !important; border-bottom: 1px solid #e2e8f0 !important; width: 100% !important; }
    .tab-buttons { display: flex !important; flex-wrap: wrap !important; width: 100% !important; }
    .tab-button { background: none !important; border: none !important; padding: 10px 18px !important; color: #64748b !important; font-weight: 500 !important; cursor: pointer !important; transition: all .3s ease !important; border-bottom: 3px solid transparent !important; display: flex !important; align-items: center !important; gap: 8px !important; font-size: .9em !important; line-height: 1.1 !important; }
    .tab-button:hover { color: #1e40af !important; background: rgba(30, 64, 175, .05) !important; }
    .tab-button.active { color: #1e40af !important; background: rgba(30, 64, 175, .1) !important; border-bottom-color: #1e40af !important; font-weight: 600 !important; }
    .tab-content { flex: 1 !important; overflow: hidden !important; width: 100% !important; }
    .tab-pane { display: none !important; height: 100% !important; overflow: hidden !important; padding: 8px 12px !important; background: #f8fafc !important; width: 100% !important; }
    .tab-pane.active { display: block !important; }
    /* Scoped styles for Line Items tab */
    #tab-2 .line-tab-pane { display: none !important; }
    #tab-2 .line-tab-pane.active { display: grid !important; grid-template-columns: repeat(4, 1fr); gap: 12px; }
    #tab-2 .line-tab-button { background: #f9fafb !important; color: #1f2937 !important; border: 1px solid #e5e7eb !important; border-bottom: none !important; border-top-left-radius: 6px !important; border-top-right-radius: 6px !important; cursor: pointer !important; }
    #tab-2 .line-tab-button.active { background: #eef2ff !important; color: #1e293b !important; border-color: #c7d2fe !important; }
    .form-group.required>label::after{content:" *";color:#ef4444;margin-left:4px}
    .info-alert{display:flex;gap:6px;align-items:flex-start;background:#eff6ff;border-left:3px solid #3b82f6;padding:4px 8px;border-radius:4px;color:#1e3a8a;margin-bottom:6px;font-size:11px}
    .info-alert i{color:#3b82f6;margin-top:1px}
    .tab-pane .form-container{max-width:none;width:100%;margin:0;padding:8px 16px;display:flex;flex-direction:column;align-items:stretch;height:calc(100vh - 140px);overflow-y:auto}
    .form-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;max-width:none;width:100%;grid-auto-flow:row dense}
    .form-group{width:100%;min-width:0;margin-bottom:6px}
    .form-group.span-2{grid-column:span 2}
    .form-group.span-3{grid-column:span 3}
    .form-group.span-full{grid-column:1/-1}
    .form-group label{font-size:12px;margin-bottom:3px;font-weight:500;line-height:1.3}
    .form-group input,.form-group select,.form-group textarea{padding:5px 8px;font-size:12px;border:1px solid #d1d5db;line-height:1.3}
    .form-group input[readonly]{background-color:#f9fafb;color:#6b7280;border-color:#e5e7eb;font-style:italic}
    .form-group textarea{min-height:40px;resize:vertical}
    .search-section{margin-bottom:6px;padding:6px;background:#f8fafc;border-radius:4px;border:1px solid #e2e8f0}
    .search-section label{font-size:12px;margin-bottom:3px}
    .search-section input{padding:4px 6px;font-size:11px}
    .btn{border:none;cursor:pointer;transition:all 0.2s ease;text-align:center;text-decoration:none;display:inline-block;font-family:inherit;line-height:1.4;box-sizing:border-box}
    .btn-primary{background:#3b82f6;color:white;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
    .btn-primary:hover{background:#2563eb;box-shadow:0 2px 6px rgba(0,0,0,0.15)}
    .btn-secondary{background:#6b7280;color:white;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
    .btn-secondary:hover{background:#4b5563;box-shadow:0 2px 6px rgba(0,0,0,0.15)}
    .status-badge{padding:2px 6px;border-radius:4px;font-size:10px;font-weight:600;text-transform:uppercase}
    .status-open{background:#dbeafe;color:#1e40af}
    .status-pending{background:#fef3c7;color:#d97706}
    .status-approved{background:#d1fae5;color:#059669}
    .status-sent{background:#e0e7ff;color:#4338ca}
    .status-received{background:#dcfce7;color:#16a34a}
    .status-closed{background:#f3f4f6;color:#374151}
    .status-cancelled{background:#fee2e2;color:#dc2626}
    .status-default{background:#f1f5f9;color:#64748b}
  </style>

  <script>
    // ‚ö°‚ö°‚ö° ULTIMATE CACHE DESTROYER - 2025-09-22 23:31:44 ‚ö°‚ö°‚ö°
    const ULTIMATE_TIMESTAMP = '2025-09-22-23-31-44-ULTIMATE';
    const EXTREME_CACHE_BUSTER = Date.now() + Math.random() * 999999;
    
    // Reduced logging for performance
    console.log('‚ö° SO_EDIT.HTM Version: ' + ULTIMATE_TIMESTAMP);
    
    // SELECTIVE CACHE CLEAR - Preserve user session data from cookies
    try {
      // Helper to get cookie value
      function getCookieValue(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
        return null;
      }
      
      // Try to get from sessionStorage first, then fallback to cookies
      let userInitials = sessionStorage.getItem('userInitials');
      let userName = sessionStorage.getItem('userName');
      
      // If not in sessionStorage, try cookies
      if (!userInitials) {
        userInitials = getCookieValue('userInitials');
        console.log('üìù Restoring from cookie - userInitials:', userInitials);
      }
      if (!userName) {
        const cookieUserName = getCookieValue('userName');
        if (cookieUserName) {
          userName = decodeURIComponent(cookieUserName);
          console.log('üìù Restoring from cookie - userName:', userName);
        }
      }
      
      // Clear storage
      localStorage.clear();
      sessionStorage.clear();
      
      // Restore user session data to sessionStorage
      if (userInitials) {
        sessionStorage.setItem('userInitials', userInitials);
        console.log('‚úÖ Preserved userInitials:', userInitials);
      }
      if (userName) {
        sessionStorage.setItem('userName', userName);
        console.log('‚úÖ Preserved userName:', userName);
      }
      
      console.log('üí• CACHE CLEARED (user session preserved from cookies)');
    } catch(e) {
      console.error('Cache clear error:', e);
    }
    
    // üîß ENSURE ALL ACK FIELDS HAVE USER-EDIT LISTENERS
    window.setupAckFieldListeners = function() {
      // Setting up ack field user-edit listeners
      for (let i = 1; i <= 5; i++) {
        const ackDateField = document.getElementById(`ackDate${i}`);
        const ackQtyField = document.getElementById(`ackQty${i}`);
        
        if (ackDateField && !ackDateField.hasAttribute('data-listener-added')) {
          ackDateField.addEventListener('change', function() {
            this.setAttribute('data-user-edited', 'true');
            // User edited field
          });
          ackDateField.setAttribute('data-listener-added', 'true');
        }
        
        if (ackQtyField && !ackQtyField.hasAttribute('data-listener-added')) {
          ackQtyField.addEventListener('change', function() {
            this.setAttribute('data-user-edited', 'true');
            // User edited field
          });
          ackQtyField.setAttribute('data-listener-added', 'true');
        }
      }
    }
    
    // üîß ENSURE ALL NEED FIELDS HAVE USER-EDIT LISTENERS
    window.setupNeedFieldListeners = function() {
      // Setting up need field user-edit listeners
      for (let i = 1; i <= 5; i++) {
        const needDateField = document.getElementById(`needDate${i}`);
        const needQtyField = document.getElementById(`needQty${i}`);
        
        if (needDateField && !needDateField.hasAttribute('data-listener-added')) {
          needDateField.addEventListener('change', function() {
            this.setAttribute('data-user-edited', 'true');
            // User edited field
          });
          needDateField.setAttribute('data-listener-added', 'true');
        }
        
        if (needQtyField && !needQtyField.hasAttribute('data-listener-added')) {
          needQtyField.addEventListener('change', function() {
            this.setAttribute('data-user-edited', 'true');
            // User edited field
          });
          needQtyField.setAttribute('data-listener-added', 'true');
        }
      }
    }
    
    // Setup acknowledgment and need field listeners
    setTimeout(() => {
      window.setupAckFieldListeners();
      window.setupNeedFieldListeners();
    }, 1000);
    
    // IMMEDIATE override - NO DELAYS
    window.clearIncompleteGlobalAcknowledgments = function() {
      // Function disabled for performance
      return false;
    };
    
    // Force page identity change
    document.title = 'TAIMEX PO - CACHE DESTROYED - ' + EXTREME_CACHE_BUSTER;
    
    // Auto-refresh detection for development
    window.addEventListener('beforeunload', function() {
      sessionStorage.setItem('PO_EDIT_AUTO_REFRESH', EXTREME_CACHE_BUSTER);
    });
    
    if (sessionStorage.getItem('PO_EDIT_AUTO_REFRESH')) {
      console.log('üîÑ Auto-refresh detectado - cach√© invalidado autom√°ticamente');
      sessionStorage.removeItem('PO_EDIT_AUTO_REFRESH');
    }
    
    // üõ°Ô∏è DYNAMIC URL CACHE BUSTING for external resources
    function bustCache(url) {
      const separator = url.includes('?') ? '&' : '?';
      return `${url}${separator}_cb=${EXTREME_CACHE_BUSTER}&_v=${ULTIMATE_TIMESTAMP}`;
    }
    
    // Override fetch to add cache busting automatically
    const originalFetch = window.fetch;
    window.fetch = function(url, options) {
      // üö® COMPLETELY DISABLE CACHE BUSTING FOR ALL UPDATE REQUESTS
      if (typeof url === 'string' && url.includes('UPDATE')) {
        console.log(`üîß DEBUGGING: Skipping ALL cache bust for UPDATE requests: ${url}`);
        return originalFetch.call(this, url, options);
      }
      
      if (typeof url === 'string' && (url.includes('.XML') || url.includes('PO_EDIT'))) {
        url = bustCache(url);
        console.log(`üî• Cache-busted URL: ${url}`);
      }
      return originalFetch.call(this, url, options);
    };
    
    // üì± Service Worker killer for development
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.getRegistrations().then(function(registrations) {
        for(let registration of registrations) {
          console.log('üóëÔ∏è Desregistrando Service Worker para evitar cach√©');
          registration.unregister();
        }
      });
    }
    
    // Prefill SO Date on load if empty
    document.addEventListener('DOMContentLoaded', function(){
      try{
        var poDate = document.getElementById('soDateInput');
        if (poDate && !poDate.value) {
          var dt = new Date();
          var yyyy = dt.getFullYear();
          var mm = String(dt.getMonth()+1).padStart(2,'0');
          var dd = String(dt.getDate()).padStart(2,'0');
          poDate.value = `${yyyy}-${mm}-${dd}`;
        }
      }catch(e){ console.warn('prefill po date error', e); }
    });

    // Add keyboard shortcuts for search
    document.addEventListener('DOMContentLoaded', function() {
      const searchInputs = ['searchSONumber', 'searchCustomerCode', 'searchStatus'];
      
      searchInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        if (input) {
          input.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
              e.preventDefault();
              searchPurchaseOrders();
            } else if (e.key === 'Escape') {
              e.preventDefault();
              clearSearchForm();
            }
          });
        }
      });
    });

    // Search Sales Orders functionality
    function searchPurchaseOrders() {
      const soNumber = document.getElementById('searchSONumber').value.trim();
      const customerCode = document.getElementById('searchCustomerCode').value.trim();
      const status = document.getElementById('searchStatus').value;
      
      // Show loading state
      const resultsBody = document.getElementById('searchResultsBody');
      const resultsCount = document.getElementById('searchResultsCount');
      
      resultsCount.textContent = 'Searching...';
      resultsBody.innerHTML = '<div style="padding: 40px; text-align: center; color: #6b7280;"><i class="fas fa-spinner fa-spin"></i> Searching sales orders...</div>';
      
      // Build search URL with parameters
      let searchUrl = 'SEARCH_PO.XML?';
      const params = [];
      
      if (soNumber) params.push(`SO_NUMBER=${encodeURIComponent(soNumber)}`);
      if (customerCode) params.push(`VENDOR_CODE=${encodeURIComponent(customerCode)}`);
      if (status) params.push(`STATUS=${encodeURIComponent(status)}`);
      
      searchUrl += params.join('&');
      
      // Make the search request
      fetch(searchUrl)
        .then(response => response.text())
        .then(xmlText => {
          try {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            
            // Check for parsing errors
            const parseError = xmlDoc.querySelector('parsererror');
            if (parseError) {
              throw new Error('XML parsing error: ' + parseError.textContent);
            }
            
            displaySearchResults(xmlDoc);
          } catch (error) {
            console.error('Search error:', error);
            showSearchError('Error parsing search results: ' + error.message);
          }
        })
        .catch(error => {
          console.error('Search request failed:', error);
          showSearchError('Search request failed. Please try again.');
        });
    }

    function displaySearchResults(xmlDoc) {
      const resultsBody = document.getElementById('searchResultsBody');
      const resultsCount = document.getElementById('searchResultsCount');
      
      const soResults = xmlDoc.querySelectorAll('so_result');
      const resultCount = xmlDoc.querySelector('result_count');
      
      const count = resultCount ? resultCount.textContent : soResults.length;
      resultsCount.textContent = `Found ${count} result(s)`;
      
      if (soResults.length === 0) {
        resultsBody.innerHTML = '<div style="padding: 40px; text-align: center; color: #6b7280;">No sales orders found matching your search criteria.</div>';
        return;
      }
      
      // Build results as cards
      let resultsHtml = '<div style="display: grid; gap: 16px; padding: 16px;">';
      
      soResults.forEach(po => {
        const soNumber = getXmlValue(po, 'so_number');
        const customerCode = getXmlValue(po, 'customer_code');
        const customerName = getXmlValue(po, 'customer_name');
        const description = getXmlValue(po, 'description');
        const status = getXmlValue(po, 'status');
        const total = getXmlValue(po, 'total');
        const poDate = getXmlValue(po, 'po_date');
        
        // Format total as currency
        const formattedTotal = total ? `$${parseFloat(total).toFixed(2)}` : '$0.00';
        
        // Format date
        const formattedDate = poDate ? formatDate(poDate) : '-';
        
        // Format status with color coding
        const statusClass = getStatusClass(status);
        
        resultsHtml += `
          <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border: 1px solid #f1f5f9; overflow: hidden;">
            <!-- Header -->
            <div style="padding: 16px 20px; background: linear-gradient(135deg, #1e293b 0%, #1e3a8a 100%); color: white; display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <h4 style="margin: 0; font-size: 16px; font-weight: 600;">SO #${soNumber}</h4>
                <span class="status-badge ${statusClass}" style="background: rgba(255,255,255,0.2); color: white;">${status}</span>
              </div>
              <div style="display: flex; gap: 8px;">
                <button onclick="viewPurchaseOrder('${soNumber}')" class="btn" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: 500;">
                  <i class="fas fa-eye"></i> View
                </button>
                <button onclick="editPurchaseOrder('${soNumber}')" class="btn" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 12px; font-weight: 500;">
                  <i class="fas fa-edit"></i> Edit
                </button>
              </div>
            </div>
            
            <!-- Content -->
            <div style="padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <!-- Left Column -->
              <div>
                <div style="margin-bottom: 16px;">
                  <div style="color: #6b7280; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Sales Order Date</div>
                  <div style="font-weight: 600; color: #1f2937;">${formattedDate}</div>
                </div>
                
                <div style="margin-bottom: 16px;">
                  <div style="color: #6b7280; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Client Information</div>
                  <div style="font-weight: 600; color: #1f2937; margin-bottom: 2px;">${customerName || customerCode}</div>
                  <div style="color: #6b7280; font-size: 12px;">Code: ${customerCode}</div>
                </div>
              </div>
              
              <!-- Right Column -->
              <div>
                <div style="margin-bottom: 16px;">
                  <div style="color: #6b7280; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Total Amount</div>
                  <div style="font-weight: 700; color: #059669; font-size: 18px;">${formattedTotal}</div>
                </div>
                
                <div style="margin-bottom: 16px;">
                  <div style="color: #6b7280; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Description</div>
                  <div style="color: #374151; font-size: 13px; line-height: 1.4;">${description || 'No description available'}</div>
                </div>
              </div>
            </div>
          </div>
        `;
      });
      
      resultsHtml += '</div>';
      resultsBody.innerHTML = resultsHtml;
    }

    function getXmlValue(parentElement, tagName) {
      const element = parentElement.querySelector(tagName);
      return element ? element.textContent.trim() : '';
    }

    function getStatusClass(status) {
      switch(status.toLowerCase()) {
        case 'open': return 'status-open';
        case 'pending': return 'status-pending';
        case 'approved': return 'status-approved';
        case 'sent': return 'status-sent';
        case 'received': return 'status-received';
        case 'closed': return 'status-closed';
        case 'cancelled': return 'status-cancelled';
        default: return 'status-default';
      }
    }

    function showSearchError(message) {
      const resultsBody = document.getElementById('searchResultsBody');
      const resultsCount = document.getElementById('searchResultsCount');
      
      resultsCount.textContent = 'Search failed';
      resultsBody.innerHTML = `<div style="padding: 40px; text-align: center; color: #ef4444;"><i class="fas fa-exclamation-triangle"></i> ${message}</div>`;
    }

    function formatDateForDisplay(dateString) {
      if (!dateString) return '-';
      try {
        // Handle different date formats
        let date;
        if (dateString.includes('/')) {
          // Format: MM/DD/YYYY or DD/MM/YYYY
          const parts = dateString.split('/');
          date = new Date(parts[2], parts[0] - 1, parts[1]);
        } else if (dateString.includes('-')) {
          // Format: YYYY-MM-DD
          date = new Date(dateString);
        } else {
          // Try to parse as is
          date = new Date(dateString);
        }
        
        if (isNaN(date.getTime())) return dateString;
        
        return date.toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'short',
          day: 'numeric'
        });
      } catch (e) {
        return dateString;
      }
    }

    function viewPurchaseOrder(soNumber) {
      // Load the PO data without switching tabs
      const soNumberInput = document.getElementById('soNumberInput');
      if (soNumberInput) {
        soNumberInput.value = soNumber;
        // Trigger any existing load functionality
        if (typeof loadPurchaseOrder === 'function') {
          loadPurchaseOrder(soNumber);
        } else if (typeof loadSOForEditing === 'function') {
          // Fallback to unified loader that uses fillFormWithSOData and showPODisplay
          loadSOForEditing(soNumber);
        }
      }
    }

    function editPurchaseOrder(soNumber) {
      // Same as view - switch to Data Capture tab and load the PO
      viewPurchaseOrder(soNumber);
    }

    // Clear search form
    function clearSearchForm() {
      document.getElementById('searchSONumber').value = '';
      document.getElementById('searchCustomerCode').value = '';
      document.getElementById('searchStatus').value = '';
      
      const resultsBody = document.getElementById('searchResultsBody');
      const resultsCount = document.getElementById('searchResultsCount');
      
      resultsCount.textContent = 'Ready to search';
      resultsBody.innerHTML = 'Enter search criteria and click Search to find sales orders';
    }

    // LIID Auto-Generate ID Functions
    async function generateNextPONumber() {
      const button = event.target;
      const originalText = button.innerHTML;
      
      try {
        // Show loading state
        button.innerHTML = '‚è≥ Generando...';
        button.disabled = true;
        
        // Get next ID from LIID database
        const response = await fetch('GET_LIID.XML?TYPE=PO');
        const xmlText = await response.text();
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        // Parse XML response
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
        
        // Check for XML parsing errors
        const parserError = xmlDoc.querySelector('parsererror');
        if (parserError) {
          throw new Error('Error parsing XML response');
        }
        
        // Extract status and next ID
        const status = xmlDoc.querySelector('status')?.textContent;
        const nextId = xmlDoc.querySelector('next_id')?.textContent;
        
        if (status === 'success' && nextId) {
          // Format the PO number (you can customize this format)
          const formattedPONumber = `PO${nextId.padStart(6, '0')}`;
          
          // Set the PO number in the input field
          document.getElementById('soNumberInput').value = formattedPONumber;
          
          // Update the LIID counter with the used ID
          await updateLIIDCounter('PO', nextId);
          
          // Show success message
          showNotification(`‚úÖ ID generado autom√°ticamente: ${formattedPONumber}`, 'success');
        } else {
          const errorMsg = xmlDoc.querySelector('message')?.textContent || 'Error desconocido';
          throw new Error(errorMsg);
        }
        
      } catch (error) {
        console.error('Error generating PO number:', error);
        showNotification(`‚ùå Error al generar ID: ${error.message}`, 'error');
      } finally {
        // Restore button state
        button.innerHTML = originalText;
        button.disabled = false;
      }
    }

    async function updateLIIDCounter(type, usedId) {
      try {
        const response = await fetch(`UPDATE_LIID.XML?TYPE=${encodeURIComponent(type)}&ID=${encodeURIComponent(usedId)}`);
        const xmlText = await response.text();
        
        if (!response.ok) {
          console.warn(`Warning: Could not update LIID counter. Status: ${response.status}`);
          return;
        }
        
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
        const status = xmlDoc.querySelector('status')?.textContent;
        
        if (status !== 'success') {
          const errorMsg = xmlDoc.querySelector('message')?.textContent || 'Unknown error updating counter';
          console.warn(`Warning: LIID counter update failed: ${errorMsg}`);
        }
      } catch (error) {
        console.warn('Warning: Error updating LIID counter:', error);
        // Don't throw error - this is not critical for the main functionality
      }
    }

    function showNotification(message, type = 'info') {
      // Create notification element
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        font-size: 14px;
        font-weight: 500;
        max-width: 300px;
        word-wrap: break-word;
        opacity: 0;
        transform: translateX(100%);
        transition: all 0.3s ease;
      `;
      
      notification.textContent = message;
      document.body.appendChild(notification);
      
      // Trigger animation
      setTimeout(() => {
        notification.style.opacity = '1';
        notification.style.transform = 'translateX(0)';
      }, 10);
      
      // Auto-remove after delay
      setTimeout(() => {
        notification.style.opacity = '0';
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
          if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
          }
        }, 300);
      }, type === 'error' ? 5000 : 3000);
    }

    // Additional LIID functions for other ID types (can be extended)
    async function generateCustomerID() {
      return await generateGenericID('CUSTOMER', 'CUST');
    }
    
    async function generateCustomerID() {
      return await generateGenericID('VENDOR', 'VEND');
    }
    
    async function generateGenericID(type, prefix) {
      try {
        const response = await fetch(`GET_LIID.XML?TYPE=${encodeURIComponent(type)}`);
        const xmlText = await response.text();
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
        
        const status = xmlDoc.querySelector('status')?.textContent;
        const nextId = xmlDoc.querySelector('next_id')?.textContent;
        
        if (status === 'success' && nextId) {
          const formattedId = `${prefix}${nextId.padStart(6, '0')}`;
          await updateLIIDCounter(type, nextId);
          return formattedId;
        } else {
          const errorMsg = xmlDoc.querySelector('message')?.textContent || 'Error desconocido';
          throw new Error(errorMsg);
        }
      } catch (error) {
        console.error(`Error generating ${type} ID:`, error);
        showNotification(`‚ùå Error al generar ${type} ID: ${error.message}`, 'error');
        return null;
      }
    }

    // Show PO Preview Modal
    function showSOPreview(soData) {
      console.log('=== SHOWING PO PREVIEW ===');
      
      // Create modal overlay
      const modalOverlay = document.createElement('div');
      modalOverlay.id = 'poPreviewModal';
      modalOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        box-sizing: border-box;
      `;
      
      // Create modal content
      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background: white;
        border-radius: 12px;
        max-width: 900px;
        max-height: 90vh;
        width: 100%;
        overflow-y: auto;
        overflow-x: hidden;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        display: flex;
        flex-direction: column;
      `;
      
      const currencyFormatter = new Intl.NumberFormat('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });

      const formatCurrency = (value) => {
        const numeric = Number(value);
        if (!Number.isFinite(numeric)) {
          return '0.00';
        }
        return numeric.toFixed(2);
      };

      const normalizeCurrencyValue = (rawValue, flag) => {
        let numeric = Number(rawValue);
        if (!Number.isFinite(numeric)) {
          return 0;
        }
        const isCents = flag === true || flag === 'true' || flag === 1;
        if (isCents) {
          numeric = numeric / 100;
        } else if (Math.abs(numeric) >= 1000 && Math.abs(numeric) % 100 === 0) {
          numeric = numeric / 100;
        }
        return numeric; 
      };

      const lineItemsForPreview = (soData.lineItems || []).map((item) => {
        const quantityValue = (() => {
          const directQty = parseFloat(item.quantity);
          if (Number.isFinite(directQty) && directQty !== 0) {
            return directQty;
          }
          const scheduleQty = parseFloat(item.scheduleQty);
          if (Number.isFinite(scheduleQty) && scheduleQty !== 0) {
            return scheduleQty;
          }
          return 0;
        })();

        const rawUnitPrice = parseFloat(item.unitPrice) || 0;
        const unitPriceDisplay = normalizeCurrencyValue(rawUnitPrice, item.unitPriceIsCents);

        // Calculate line total: quantity * unit price
        let totalRaw = rawUnitPrice * quantityValue;
        const totalDisplay = normalizeCurrencyValue(totalRaw, item.unitPriceIsCents);

        return {
          ...item,
          displayQuantity: quantityValue,
          displayUnitPrice: unitPriceDisplay,
          displayTotal: totalDisplay
        };
      });

      const previewTotalAmount = lineItemsForPreview.reduce((sum, item) => {
        const value = Number(item.displayTotal);
        return sum + (Number.isFinite(value) ? value : 0);
      }, 0);

      const headerTotalAmount = (() => {
        const rawHeaderTotal = parseFloat(soData.header.totalAmount);
        if (Number.isFinite(rawHeaderTotal) && rawHeaderTotal !== 0) {
          return rawHeaderTotal;
        }
        return previewTotalAmount;
      })();

      // Build enhanced preview HTML with better organization
      const previewHTML = `
        <div style="padding: 24px; border-bottom: 1px solid #e5e7eb; flex-shrink: 0;">
          <h2 style="margin: 0; color: #1f2937; font-size: 24px; font-weight: 600;">
            <i class="fas fa-eye" style="margin-right: 8px; color: #10b981;"></i>
            Sales Order Preview
          </h2>
          <p style="margin: 8px 0 0 0; color: #6b7280; font-size: 14px;">
            Review all information before saving to database
          </p>
        </div>
        
        <div style="padding: 24px; overflow-y: auto; flex: 1;">
          <!-- Header Information -->
          <div style="margin-bottom: 32px;">
            <h3 style="margin: 0 0 16px 0; color: #374151; font-size: 18px; font-weight: 600; border-bottom: 2px solid #10b981; padding-bottom: 8px;">
              Header Information
            </h3>
            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px;">
              <div>
                <strong style="color: #374151;">SO Number:</strong>
                <div style="margin-top: 4px; padding: 8px; background: #f3f4f6; border-radius: 6px; font-family: monospace;">
                  ${soData.header.soNumber}
                </div>
              </div>
              <div>
                <strong style="color: #374151;">SO Date:</strong>
                <div style="margin-top: 4px; padding: 8px; background: #f3f4f6; border-radius: 6px;">
                  ${soData.header.poDate || 'Not set'}
                </div>
              </div>
              <div>
                <strong style="color: #374151;">Email:</strong>
                <div style="margin-top: 4px; padding: 8px; background: #f3f4f6; border-radius: 6px;">
                  ${soData.header.email || 'Not set'}
                </div>
              </div>
              <div>
                <strong style="color: #374151;">Status:</strong>
                <div style="margin-top: 4px; padding: 8px; background: #f3f4f6; border-radius: 6px;">
                  ${(() => {
                    const statusMap = {'N': 'New', 'B': 'Backordered', 'C': 'Closed', 'X': 'X Cancelled', 'H': 'Hold'};
                    return statusMap[soData.header.soStatus] || soData.header.soStatus || 'Not set';
                  })()}
                </div>
              </div>
              <div>
                <strong style="color: #374151;">Customer:</strong>
                <div style="margin-top: 4px; padding: 8px; background: #f3f4f6; border-radius: 6px;">
                  ${soData.header.customerCode} - ${soData.header.customerName || 'Unknown'}
                </div>
              </div>
              <div>
                <strong style="color: #374151;">Ship To:</strong>
                <div style="margin-top: 4px; padding: 8px; background: #f3f4f6; border-radius: 6px;">
                  ${soData.header.shipToCode} - ${soData.header.shipToName || 'Unknown'}
                </div>
              </div>
              <div>
                <strong style="color: #374151;">Total Amount:</strong>
                <div style="margin-top: 4px; padding: 8px; background: #f3f4f6; border-radius: 6px; font-weight: 600; color: #059669;">
                  $${formatCurrency(headerTotalAmount)}
                </div>
              </div>
            </div>
            ${soData.header.lineNotes ? `
              <div style="margin-top: 16px;">
                <strong style="color: #374151;">Line Notes:</strong>
                <div style="margin-top: 4px; padding: 8px; background: #f3f4f6; border-radius: 6px; white-space: pre-wrap;">
                  ${soData.header.lineNotes}
                </div>
              </div>
            ` : ''}
          </div>
          
          <!-- Line Items - Compact Grid Style -->
          <div style="margin-bottom: 32px;">
            <h3 style="margin: 0 0 16px 0; color: #374151; font-size: 18px; font-weight: 600; border-bottom: 2px solid #10b981; padding-bottom: 8px;">
              <i class="fas fa-list" style="color: #10b981; margin-right: 8px;"></i>
              Line Items (${lineItemsForPreview.length})
            </h3>
            ${lineItemsForPreview.length > 0 ? `
              <div style="overflow-x: auto; border-radius: 8px; border: 1px solid #e5e7eb; background: white;">
                <div style="display: grid; grid-template-columns: 50px 180px 1fr 80px 60px 100px 100px; gap: 0; font-size: 12px; min-width: 800px;">
                  <!-- Header Row -->
                  <div style="padding: 10px 12px; background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; font-weight: 600; border-right: 1px solid rgba(255,255,255,0.2);">#</div>
                  <div style="padding: 10px 12px; background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; font-weight: 600; border-right: 1px solid rgba(255,255,255,0.2);">PART NUMBER</div>
                  <div style="padding: 10px 12px; background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; font-weight: 600; border-right: 1px solid rgba(255,255,255,0.2);">DESCRIPTION</div>
                  <div style="padding: 10px 12px; background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; font-weight: 600; text-align: right; border-right: 1px solid rgba(255,255,255,0.2);">QTY</div>
                  <div style="padding: 10px 12px; background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; font-weight: 600; border-right: 1px solid rgba(255,255,255,0.2);">UM</div>
                  <div style="padding: 10px 12px; background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; font-weight: 600; text-align: right; border-right: 1px solid rgba(255,255,255,0.2);">UNIT PRICE</div>
                  <div style="padding: 10px 12px; background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); color: white; font-weight: 600; text-align: right;">TOTAL</div>
                  
                  <!-- Data Rows -->
                  ${lineItemsForPreview.map((item, index) => `
                    <div style="padding: 10px 12px; background: ${index % 2 === 0 ? '#f9fafb' : 'white'}; border-top: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb; font-weight: 600; color: #3b82f6;">${item.lineNumber || (index + 1)}</div>
                    <div style="padding: 10px 12px; background: ${index % 2 === 0 ? '#f9fafb' : 'white'}; border-top: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb; font-family: 'Courier New', monospace; font-weight: 600; color: #1e293b;">${item.partNumber || ''}</div>
                    <div style="padding: 10px 12px; background: ${index % 2 === 0 ? '#f9fafb' : 'white'}; border-top: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb; color: #374151;">${item.description || ''}</div>
                    <div style="padding: 10px 12px; background: ${index % 2 === 0 ? '#f9fafb' : 'white'}; border-top: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb; text-align: right; font-weight: 600; color: #059669;">${item.displayQuantity || item.quantity || '0'}</div>
                    <div style="padding: 10px 12px; background: ${index % 2 === 0 ? '#f9fafb' : 'white'}; border-top: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb; color: #6b7280;">${item.uom || ''}</div>
                    <div style="padding: 10px 12px; background: ${index % 2 === 0 ? '#f9fafb' : 'white'}; border-top: 1px solid #e5e7eb; border-right: 1px solid #e5e7eb; text-align: right; color: #374151;">$${formatCurrency(item.displayUnitPrice)}</div>
                    <div style="padding: 10px 12px; background: ${index % 2 === 0 ? '#f9fafb' : 'white'}; border-top: 1px solid #e5e7eb; text-align: right; font-weight: 700; color: #059669;">$${formatCurrency(item.displayTotal || (item.displayQuantity * item.displayUnitPrice))}</div>
                  `).join('')}
                </div>
                
                <!-- Notes Section Below Grid (if any) -->
                ${lineItemsForPreview.some(item => item.lineNotes || item.prodNotes) ? `
                  <div style="border-top: 2px solid #e5e7eb; padding: 16px; background: #fafafa;">
                    <h4 style="margin: 0 0 12px 0; font-size: 13px; font-weight: 600; color: #374151;">
                      <i class="fas fa-sticky-note" style="color: #f59e0b; margin-right: 6px;"></i>
                      Additional Notes
                    </h4>
                    ${lineItemsForPreview.map((item, index) => {
                      const hasNotes = item.lineNotes || item.prodNotes;
                      if (!hasNotes) return '';
                      return `
                        <div style="margin-bottom: 12px; padding: 10px; background: white; border-left: 3px solid #3b82f6; border-radius: 4px;">
                          <div style="font-weight: 600; color: #3b82f6; margin-bottom: 6px;">
                            Line ${item.lineNumber || (index + 1)} - ${item.partNumber}
                          </div>
                          ${item.lineNotes ? `
                            <div style="margin-bottom: 4px;">
                              <span style="font-weight: 600; color: #6b7280; font-size: 11px;">LINE NOTES:</span>
                              <span style="color: #374151; font-size: 12px; margin-left: 8px;">${item.lineNotes}</span>
                            </div>
                          ` : ''}
                          ${item.prodNotes ? `
                            <div>
                              <span style="font-weight: 600; color: #f59e0b; font-size: 11px;">PRODUCTION:</span>
                              <span style="color: #374151; font-size: 12px; margin-left: 8px;">${item.prodNotes}</span>
                            </div>
                          ` : ''}
                        </div>
                      `;
                    }).join('')}
                  </div>
                ` : ''}
              </div>
            ` : `
              <div style="padding: 24px; text-align: center; color: #6b7280; background: #f9fafb; border-radius: 8px;">
                <i class="fas fa-inbox" style="font-size: 48px; color: #d1d5db; margin-bottom: 12px;"></i>
                <div>No line items added</div>
              </div>
            `}
          </div>
          
          <!-- Enhanced Tracking Information Tables -->
          ${(soData.tracking.needInfo.length > 0 || soData.tracking.acknowledgments.length > 0 || soData.tracking.schedules.length > 0) ? `
            <div style="margin-bottom: 32px;">
              <h3 style="margin: 0 0 16px 0; color: #374151; font-size: 18px; font-weight: 600; border-bottom: 2px solid #10b981; padding-bottom: 8px;">
                Tracking Information
              </h3>
              
              ${soData.tracking.needInfo.length > 0 ? `
                <div style="margin-bottom: 24px;">
                  <h4 style="margin: 0 0 12px 0; color: #dc2626; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-exclamation-triangle" style="color: #dc2626;"></i>
                    Need Information (${soData.tracking.needInfo.length} entries)
                  </h4>
                  <div style="overflow-x: auto; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px; background: white;">
                      <thead>
                        <tr style="background: #fef3c7;">
                          <th style="padding: 12px 16px; text-align: left; border-bottom: 2px solid #f59e0b; font-weight: 600; color: #92400e;">Line</th>
                          <th style="padding: 12px 16px; text-align: left; border-bottom: 2px solid #f59e0b; font-weight: 600; color: #92400e;">Part Number</th>
                          <th style="padding: 12px 16px; text-align: left; border-bottom: 2px solid #f59e0b; font-weight: 600; color: #92400e;">Need Date</th>
                          <th style="padding: 12px 16px; text-align: right; border-bottom: 2px solid #f59e0b; font-weight: 600; color: #92400e;">Quantity</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${soData.tracking.needInfo.map((need, index) => `
                          <tr style="${index % 2 === 0 ? 'background: #fffbeb;' : 'background: white;'} border-bottom: 1px solid #f3f4f6;">
                            <td style="padding: 12px 16px; font-weight: 600; color: #dc2626;">${need.line}</td>
                            <td style="padding: 12px 16px; font-family: monospace; font-weight: 500;">${need.partNumber || '-'}</td>
                            <td style="padding: 12px 16px; color: #374151;">${need.date || '-'}</td>
                            <td style="padding: 12px 16px; text-align: right; font-weight: 600; color: #dc2626;">${need.quantity || '-'}</td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
              ` : ''}
              
              ${soData.tracking.acknowledgments.length > 0 ? `
                <div style="margin-bottom: 24px;">
                  <h4 style="margin: 0 0 12px 0; color: #2563eb; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-check-circle" style="color: #2563eb;"></i>
                    Acknowledgments (${soData.tracking.acknowledgments.length} entries)
                  </h4>
                  <div style="overflow-x: auto; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px; background: white;">
                      <thead>
                        <tr style="background: #dbeafe;">
                          <th style="padding: 12px 16px; text-align: left; border-bottom: 2px solid #3b82f6; font-weight: 600; color: #1e40af;">Line</th>
                          <th style="padding: 12px 16px; text-align: left; border-bottom: 2px solid #3b82f6; font-weight: 600; color: #1e40af;">Part Number</th>
                          <th style="padding: 12px 16px; text-align: left; border-bottom: 2px solid #3b82f6; font-weight: 600; color: #1e40af;">Ack Date</th>
                          <th style="padding: 12px 16px; text-align: right; border-bottom: 2px solid #3b82f6; font-weight: 600; color: #1e40af;">Quantity</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${soData.tracking.acknowledgments.map((ack, index) => `
                          <tr style="${index % 2 === 0 ? 'background: #eff6ff;' : 'background: white;'} border-bottom: 1px solid #f3f4f6;">
                            <td style="padding: 12px 16px; font-weight: 600; color: #2563eb;">${ack.line}</td>
                            <td style="padding: 12px 16px; font-family: monospace; font-weight: 500;">${ack.partNumber || '-'}</td>
                            <td style="padding: 12px 16px; color: #374151;">${ack.date || '-'}</td>
                            <td style="padding: 12px 16px; text-align: right; font-weight: 600; color: #2563eb;">${ack.quantity || '-'}</td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
              ` : ''}
              
              ${soData.tracking.schedules.length > 0 ? `
                <div>
                  <h4 style="margin: 0 0 12px 0; color: #059669; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-calendar-alt" style="color: #059669;"></i>
                    Schedules (${soData.tracking.schedules.length} entries)
                  </h4>
                  <div style="overflow-x: auto; border-radius: 8px; border: 1px solid #e5e7eb;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 13px; background: white;">
                      <thead>
                        <tr style="background: #ecfdf5;">
                          <th style="padding: 12px 16px; text-align: left; border-bottom: 2px solid #10b981; font-weight: 600; color: #065f46;">Line</th>
                          <th style="padding: 12px 16px; text-align: left; border-bottom: 2px solid #10b981; font-weight: 600; color: #065f46;">Part Number</th>
                          <th style="padding: 12px 16px; text-align: left; border-bottom: 2px solid #10b981; font-weight: 600; color: #065f46;">Schedule Date</th>
                          <th style="padding: 12px 16px; text-align: right; border-bottom: 2px solid #10b981; font-weight: 600; color: #065f46;">Quantity</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${soData.tracking.schedules.map((sched, index) => `
                          <tr style="${index % 2 === 0 ? 'background: #f0fdf4;' : 'background: white;'} border-bottom: 1px solid #f3f4f6;">
                            <td style="padding: 12px 16px; font-weight: 600; color: #059669;">${sched.line}</td>
                            <td style="padding: 12px 16px; font-family: monospace; font-weight: 500;">${sched.partNumber || '-'}</td>
                            <td style="padding: 12px 16px; color: #374151;">${sched.date || '-'}</td>
                            <td style="padding: 12px 16px; text-align: right; font-weight: 600; color: #059669;">${sched.quantity || '-'}</td>
                          </tr>
                        `).join('')}
                      </tbody>
                    </table>
                  </div>
                </div>
              ` : ''}
            </div>
          ` : ''}
        </div>
        
        <!-- Enhanced Action Buttons -->
        <div style="padding: 24px; border-top: 1px solid #e5e7eb; background: #f9fafb; display: flex; gap: 12px; justify-content: space-between; align-items: center; flex-shrink: 0;">
          <div>
            <button type="button" onclick="exportToPDF()" style="padding: 12px 24px; border: 1px solid #3b82f6; background: white; color: #3b82f6; border-radius: 8px; font-weight: 500; cursor: pointer; font-size: 14px; transition: all 0.2s; margin-right: 8px;" onmouseover="this.style.background='#3b82f6'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#3b82f6'">
              <i class="fas fa-print" style="margin-right: 8px;"></i>Open for PDF
            </button>
            <button type="button" onclick="runSystemDiagnostic()" style="padding: 8px 16px; border: 1px solid #f59e0b; background: white; color: #f59e0b; border-radius: 6px; font-weight: 500; cursor: pointer; font-size: 12px;" onmouseover="this.style.background='#f59e0b'; this.style.color='white'" onmouseout="this.style.background='white'; this.style.color='#f59e0b'">
              <i class="fas fa-bug" style="margin-right: 6px;"></i>Debug
            </button>
          </div>
          <div style="display: flex; gap: 12px;">
            <button type="button" onclick="closePOPreview()" style="padding: 12px 24px; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 8px; font-weight: 500; cursor: pointer; font-size: 14px;">
              <i class="fas fa-arrow-left" style="margin-right: 8px;"></i>Back to Edit
            </button>
            <button type="button" onclick="confirmAndSavePO()" style="padding: 12px 24px; border: none; background: #10b981; color: white; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 14px;">
              <i class="fas fa-check-circle" style="margin-right: 8px;"></i>Confirm & Save PO
            </button>
          </div>
        </div>
      `;
      
      modalContent.innerHTML = previewHTML;
      modalOverlay.appendChild(modalContent);
      document.body.appendChild(modalOverlay);
      
      // Prevent body scroll
      document.body.style.overflow = 'hidden';
    }

    // Close preview modal
    function closePOPreview() {
      const modal = document.getElementById('poPreviewModal');
      if (modal) {
        modal.remove();
        document.body.style.overflow = '';
      }
    }

    // Confirm and save PO from preview
    function confirmAndSavePO() {
      console.log('=== CONFIRMING AND SAVING PO ===');
      
      // Close modal first
      closePOPreview();
      
      // Show loading indicator
      const loadingOverlay = document.createElement('div');
      loadingOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 10000;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
        font-weight: 600;
      `;
      loadingOverlay.innerHTML = `
        <div style="text-align: center;">
          <i class="fas fa-spinner fa-spin" style="font-size: 48px; margin-bottom: 16px;"></i>
          <div>Saving Sales Order...</div>
        </div>
      `;
      document.body.appendChild(loadingOverlay);
      
      // Call the actual save function
      setTimeout(() => {
        try {
          saveSO();
          // Remove loading after a short delay to let saveSO complete
          setTimeout(() => {
            loadingOverlay.remove();
          }, 2000);
        } catch (error) {
          loadingOverlay.remove();
          alert('‚ùå Error saving Sales Order: ' + error.message);
        }
      }, 500);
    }

    // Robust PDF Export - Fixed for Blank PDF Issue
    async function exportToPDF() {
      console.log('üñ®Ô∏è Starting robust PDF export...');
      
      // Show loading
      const loadingOverlay = document.createElement('div');
      loadingOverlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 10001;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
        font-weight: 600;
      `;
      loadingOverlay.innerHTML = `
        <div style="text-align: center;">
          <i class="fas fa-file-pdf fa-spin" style="font-size: 48px; margin-bottom: 16px; color: #ef4444;"></i>
          <div>Generating PDF Document...</div>
          <div style="font-size: 14px; margin-top: 8px; opacity: 0.8;">Processing content...</div>
        </div>
      `;
      document.body.appendChild(loadingOverlay);

      try {
        // Debug: Check if modal exists
        const previewModal = document.getElementById('poPreviewModal');
        console.log('üîç PDF Debug: Modal found:', !!previewModal);
        
        if (!previewModal) {
          throw new Error('Preview modal not found. Please open the preview first.');
        }

        // More robust content selection
        let modalContent = previewModal.querySelector('div[style*="background: white"]');
        if (!modalContent) {
          modalContent = previewModal.children[0];
        }
        
        console.log('üîç PDF Debug: Modal content found:', !!modalContent);
        console.log('üîç PDF Debug: Modal content HTML length:', modalContent?.innerHTML?.length || 0);

        // Create a simpler, more direct PDF content
        const pdfElement = document.createElement('div');
        pdfElement.id = 'pdf-export-content';
        pdfElement.style.cssText = `
          position: fixed;
          top: -10000px;
          left: 0;
          width: 800px;
          background: white;
          font-family: Arial, sans-serif;
          font-size: 14px;
          line-height: 1.5;
          color: #000;
          padding: 40px;
          box-sizing: border-box;
        `;

        // Get comprehensive PO data with OPTIMIZED customer/shipto extraction
        const soNumber = document.getElementById('soNumberInput')?.value || window.currentSOData?.so_number || 'DRAFT';
        const poDate = document.getElementById('soDateInput')?.value || window.currentSOData?.po_date || 'Not set';
        
        // OPTIMIZED VENDOR EXTRACTION - Multiple sources with code parsing
        let customerInfo = 'Unknown Customer';
        let customerCode = '';
        
        // Source 1: Form select element
        const customerSelect = document.getElementById('customerSelect');
        if (customerSelect?.selectedOptions[0]) {
          const selectedOption = customerSelect.selectedOptions[0];
          customerCode = selectedOption.value || '';
          customerInfo = selectedOption.text || '';
          
          // Parse format: "CODE - NAME" or "NAME (CODE)"
          const codeNameMatch = customerInfo.match(/^(\d+)\s*-\s*(.+)/);
          const nameCodeMatch = customerInfo.match(/^(.+)\s*\((\d+)\)$/);
          
          if (codeNameMatch) {
            customerCode = customerCode || codeNameMatch[1];
            customerInfo = `${codeNameMatch[1]} - ${codeNameMatch[2]}`;
          } else if (nameCodeMatch) {
            customerCode = customerCode || nameCodeMatch[2];
            customerInfo = `${nameCodeMatch[2]} - ${nameCodeMatch[1]}`;
          }
        }
        
        // Source 2: currentSOData fallback
        if (!customerCode || customerInfo === 'Unknown Customer') {
          if (window.currentSOData?.customer_code) {
            customerCode = window.currentSOData.customer_code;
            const customerName = window.currentSOData.customer_name || window.currentSOData?.customer || '';
            customerInfo = customerName ? `${customerCode} - ${customerName}` : customerCode;
          }
        }
        
        // OPTIMIZED SHIP TO EXTRACTION - Multiple sources with code parsing
        let shipToInfo = 'Not set';
        let shipToCode = '';
        
        // Source 1: Form select element
        const shipToSelect = document.getElementById('shipToSelect');
        if (shipToSelect?.selectedOptions[0]) {
          const selectedOption = shipToSelect.selectedOptions[0];
          shipToCode = selectedOption.value || '';
          shipToInfo = selectedOption.text || '';
          
          // Parse format: "CODE - DESCRIPTION" or "DESCRIPTION (CODE)"
          const codeDescMatch = shipToInfo.match(/^([A-Z0-9]+)\s*-\s*(.+)/);
          const descCodeMatch = shipToInfo.match(/^(.+)\s*\(([A-Z0-9]+)\)$/);
          
          if (codeDescMatch) {
            shipToCode = shipToCode || codeDescMatch[1];
            shipToInfo = `${codeDescMatch[1]} - ${codeDescMatch[2]}`;
          } else if (descCodeMatch) {
            shipToCode = shipToCode || descCodeMatch[2];
            shipToInfo = `${descCodeMatch[2]} - ${descCodeMatch[1]}`;
          }
        }
        
        // Source 2: currentSOData fallback (multiple field names)
        if (!shipToCode || shipToInfo === 'Not set') {
          const soData = window.currentSOData;
          if (soData) {
            shipToCode = soData.ship_to_code || soData.shipto_code || soData.ship_to || '';
            const shipToName = soData.ship_to_name || soData.shipto_name || soData.ship_to_desc || '';
            shipToInfo = shipToName ? `${shipToCode} - ${shipToName}` : shipToCode || 'Not set';
          }
        }
        
        const email = document.getElementById('emailInput')?.value || window.currentSOData?.email || 'Not set';
        const shipVia = document.getElementById('shipViaSelect')?.selectedOptions[0]?.text || window.currentSOData?.ship_via || 'Not set';
        const salesperson = document.getElementById('salespersonSelect')?.selectedOptions[0]?.text || window.currentSOData?.salesperson || 'Not set';
        const terms = document.getElementById('termsInput')?.value || window.currentSOData?.terms || 'Not set';
        const notes = document.getElementById('soNotesTextarea')?.value || window.currentSOData?.notes || '';
        
        // DEBUG: Log optimized customer and ship to extraction
        console.log('üè™ OPTIMIZED VENDOR EXTRACTION:', { 
          code: customerCode, 
          info: customerInfo, 
          source: customerSelect?.selectedOptions[0] ? 'form' : 'currentSOData' 
        });
        console.log('üöö OPTIMIZED SHIP TO EXTRACTION:', { 
          code: shipToCode, 
          info: shipToInfo, 
          source: shipToSelect?.selectedOptions[0] ? 'form' : 'currentSOData' 
        });
        
        // Get line items from BOTH sources
        const lineItemsData = window.lineItems || window.currentSOData?.line_items || [];
        
        console.log('üìä Captured PO Data:', { 
          soNumber, 
          customerInfo, 
          shipToInfo,
          lineItems: lineItemsData.length,
          source: 'Multiple sources - form fields + currentSOData'
        });

        // DEBUG: Log what data sources we have
        console.log('üîç DEBUG - Data Sources Available:');
        console.log('  - window.lineItems:', window.lineItems?.length || 'undefined');
        console.log('  - window.currentSOData:', !!window.currentSOData);
        console.log('  - window.currentSOData?.line_items:', window.currentSOData?.line_items?.length || 'undefined');
        console.log('  - Final lineItemsData:', lineItemsData.length);
        
        // DEBUG: Log ALL window properties that might contain SO data
        console.log('üîç EXTENDED DEBUG - All window PO-related properties:');
        for (let prop in window) {
          if (prop.toLowerCase().includes('po') || prop.toLowerCase().includes('line') || prop.toLowerCase().includes('item')) {
            console.log(`  - window.${prop}:`, typeof window[prop], window[prop]?.length || 'N/A');
          }
        }
        
        if (lineItemsData.length > 0) {
          console.log('  - First line item sample:', lineItemsData[0]);
        } else {
          console.log('  - ‚ùå NO LINE ITEMS FOUND IN ANY SOURCE');
        }
        
        // Build PDF content from scratch (this ensures it's not blank)
        pdfElement.innerHTML = `
          <div style="text-align: center; margin-bottom: 40px; border-bottom: 3px solid #10b981; padding-bottom: 20px;">
            <h1 style="margin: 0 0 10px 0; font-size: 32px; font-weight: bold; color: #1f2937;">
              PURCHASE ORDER
            </h1>
            <p style="margin: 0; font-size: 16px; color: #6b7280;">
              Generated on ${new Date().toLocaleDateString('en-US', { 
                weekday: 'long',
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              })}
            </p>
            <p style="margin: 8px 0 0 0; font-size: 14px; color: #9ca3af;">
              Document ID: ${soNumber}-${new Date().getTime()}
            </p>
          </div>

          <div style="margin-bottom: 30px;">
            <h2 style="margin: 0 0 20px 0; font-size: 20px; font-weight: bold; color: #374151; border-bottom: 2px solid #10b981; padding-bottom: 8px;">
              Sales Order Information
            </h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
              <div>
                <strong>SO Number:</strong><br>
                <div style="background: #f3f4f6; padding: 8px; margin-top: 4px; border-radius: 4px; font-weight: bold;">
                  ${soNumber}
                </div>
              </div>
              <div>
                <strong>SO Date:</strong><br>
                <div style="background: #f3f4f6; padding: 8px; margin-top: 4px; border-radius: 4px;">
                  ${poDate}
                </div>
              </div>
              <div>
                <strong>Customer:</strong><br>
                <div style="background: #f3f4f6; padding: 8px; margin-top: 4px; border-radius: 4px;">
                  ${customerInfo}
                </div>
              </div>
              <div>
                <strong>Salesperson:</strong><br>
                <div style="background: #f3f4f6; padding: 8px; margin-top: 4px; border-radius: 4px;">
                  ${salesperson}
                </div>
              </div>
              <div>
                <strong>Ship To:</strong><br>
                <div style="background: #f3f4f6; padding: 8px; margin-top: 4px; border-radius: 4px;">
                  ${shipToInfo}
                </div>
              </div>
              <div>
                <strong>Ship Via:</strong><br>
                <div style="background: #f3f4f6; padding: 8px; margin-top: 4px; border-radius: 4px;">
                  ${shipVia}
                </div>
              </div>
              <div>
                <strong>Email:</strong><br>
                <div style="background: #f3f4f6; padding: 8px; margin-top: 4px; border-radius: 4px;">
                  ${email}
                </div>
              </div>
              <div>
                <strong>Terms:</strong><br>
                <div style="background: #f3f4f6; padding: 8px; margin-top: 4px; border-radius: 4px;">
                  ${terms}
                </div>
              </div>
            </div>
            ${notes ? `
              <div style="margin-top: 20px;">
                <strong>Notes:</strong><br>
                <div style="background: #f3f4f6; padding: 12px; margin-top: 4px; border-radius: 4px; white-space: pre-wrap;">
                  ${notes}
                </div>
              </div>
            ` : ''}
          </div>

          <div style="margin-bottom: 30px;">
            <h2 style="margin: 0 0 20px 0; font-size: 20px; font-weight: bold; color: #374151; border-bottom: 2px solid #10b981; padding-bottom: 8px;">
              Line Items
            </h2>
            <div id="line-items-section">
              <p style="padding: 20px; text-align: center; color: #6b7280; background: #f9fafb; border-radius: 8px;">
                Loading line items data...
              </p>
            </div>
          </div>

          <!-- Tracking Information Section -->
          <div style="margin-bottom: 30px;">
            <h2 style="margin: 0 0 20px 0; font-size: 20px; font-weight: bold; color: #374151; border-bottom: 2px solid #10b981; padding-bottom: 8px;">
              Tracking Information
            </h2>
            <div id="tracking-section">
              <p style="padding: 20px; text-align: center; color: #6b7280; background: #f9fafb; border-radius: 8px;">
                Loading tracking data...
              </p>
            </div>
          </div>

          <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #e5e7eb; text-align: center; color: #9ca3af; font-size: 12px;">
            <p>This document was generated electronically and is valid without signature.</p>
            <p style="margin-top: 4px;">TAIMEX Sales Order System - ${new Date().getFullYear()}</p>
          </div>
        `;

        // Add to DOM
        document.body.appendChild(pdfElement);
        
        // Populate line items with comprehensive information
        if (lineItemsData && lineItemsData.length > 0) {
          console.log('üìã Building line items table with', lineItemsData.length, 'items');
          
          let lineItemsHTML = `
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
              <thead>
                <tr style="background: #f9fafb;">
                  <th style="border: 1px solid #333; padding: 8px; text-align: center; font-size: 11px;">Line</th>
                  <th style="border: 1px solid #333; padding: 8px; text-align: left; font-size: 11px;">Part Number</th>
                  <th style="border: 1px solid #333; padding: 8px; text-align: left; font-size: 11px;">Description</th>
                  <th style="border: 1px solid #333; padding: 8px; text-align: center; font-size: 11px;">UOM</th>
                  <th style="border: 1px solid #333; padding: 8px; text-align: right; font-size: 11px;">Qty</th>
                  <th style="border: 1px solid #333; padding: 8px; text-align: right; font-size: 11px;">Unit Price</th>
                  <th style="border: 1px solid #333; padding: 8px; text-align: right; font-size: 11px;">Extended</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          let total = 0;
          
          lineItemsData.forEach((item, index) => {
            const qty = parseFloat(item.quantity) || 0;
            const price = parseFloat(item.unitPrice) || 0;
            const extended = qty * price;
            total += extended;
            
            lineItemsHTML += `
              <tr style="${index % 2 === 0 ? 'background: #fafafa;' : 'background: white;'}">
                <td style="border: 1px solid #333; padding: 8px; text-align: center; font-size: 12px;">${item.lineNumber || (index + 1)}</td>
                <td style="border: 1px solid #333; padding: 8px; font-family: monospace; font-size: 11px;">${item.partNumber || ''}</td>
                <td style="border: 1px solid #333; padding: 8px; font-size: 11px;">${item.description || item.partDescription || ''}</td>
                <td style="border: 1px solid #333; padding: 8px; text-align: center; font-size: 11px;">${item.uom || item.unitOfMeasure || 'EA'}</td>
                <td style="border: 1px solid #333; padding: 8px; text-align: right; font-size: 12px;">${qty.toFixed(0)}</td>
                <td style="border: 1px solid #333; padding: 8px; text-align: right; font-size: 12px;">$${price.toFixed(4)}</td>
                <td style="border: 1px solid #333; padding: 8px; text-align: right; font-weight: bold; font-size: 12px;">$${extended.toFixed(2)}</td>
              </tr>
            `;
          });
          
          // Add total row
          lineItemsHTML += `
              <tr style="background: #e8f5e8; font-weight: bold;">
                <td colspan="6" style="border: 1px solid #333; padding: 12px; text-align: right; font-size: 13px;">TOTAL:</td>
                <td style="border: 1px solid #333; padding: 12px; text-align: right; font-size: 14px; font-weight: bold;">$${total.toFixed(2)}</td>
              </tr>
            </tbody></table>
          `;
          
          const lineItemsSection = pdfElement.querySelector('#line-items-section');
          if (lineItemsSection) {
            lineItemsSection.innerHTML = lineItemsHTML;
          }
          
          console.log('‚úÖ Line items table built successfully');
        } else {
          console.warn('‚ö†Ô∏è No line items found in JavaScript variables - trying DOM extraction');
          
          // Try to extract line items from preview modal DOM (data comes from PICK database)
          const previewModal = document.getElementById('poPreviewModal');
          
          // Try multiple selectors to find the line items table
          let lineItemsTable = previewModal?.querySelector('#line-items-content table');
          if (!lineItemsTable) {
            lineItemsTable = previewModal?.querySelector('.tab-content table');
          }
          if (!lineItemsTable) {
            // Get the first table that has more than 1 row (has actual data)
            const allTables = previewModal?.querySelectorAll('table') || [];
            for (let table of allTables) {
              const rows = table.querySelectorAll('tr');
              if (rows.length > 1) {  // Has header + at least 1 data row
                lineItemsTable = table;
                break;
              }
            }
          }
          
          console.log('üîç Looking for line items table in preview modal...');
          console.log('  - Preview modal found:', !!previewModal);
          
          if (previewModal) {
            // Log all tables found in the modal
            const allTables = previewModal.querySelectorAll('table');
            console.log('  - Total tables found in modal:', allTables.length);
            
            allTables.forEach((table, index) => {
              const rows = table.querySelectorAll('tr');
              const firstRowCells = table.querySelector('tr')?.querySelectorAll('th, td');
              console.log(`    Table ${index + 1}: ${rows.length} rows, ${firstRowCells?.length || 0} columns`);
              if (firstRowCells?.length > 0) {
                const headerText = Array.from(firstRowCells).map(cell => cell.textContent?.trim()).join(' | ');
                console.log(`      Headers/First row: ${headerText}`);
              }
            });
          }
          
          console.log('  - Line items table found:', !!lineItemsTable);
          if (lineItemsTable) {
            console.log('  - Table rows count:', lineItemsTable.querySelectorAll('tr').length);
          }
          
          if (lineItemsTable) {
            console.log('‚úÖ Found line items table in preview modal - extracting data');
            
            let extractedHTML = `
              <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                <thead>
                  <tr style="background: #f9fafb;">
                    <th style="border: 1px solid #333; padding: 8px; text-align: center; font-size: 11px;">Line</th>
                    <th style="border: 1px solid #333; padding: 8px; text-align: left; font-size: 11px;">Part Number</th>
                    <th style="border: 1px solid #333; padding: 8px; text-align: left; font-size: 11px;">Description</th>
                    <th style="border: 1px solid #333; padding: 8px; text-align: center; font-size: 11px;">UOM</th>
                    <th style="border: 1px solid #333; padding: 8px; text-align: right; font-size: 11px;">Qty</th>
                    <th style="border: 1px solid #333; padding: 8px; text-align: right; font-size: 11px;">Unit Price</th>
                    <th style="border: 1px solid #333; padding: 8px; text-align: right; font-size: 11px;">Extended</th>
                  </tr>
                </thead>
                <tbody>
            `;
            
            // Extract rows from existing table  
            // Headers: Line | Part Number | Description | Qty | UM | Unit Price | Total
            const rows = lineItemsTable.querySelectorAll('tbody tr');
            let total = 0;
            
            console.log(`üìã Extracting ${rows.length} line item rows from PICK table`);
            
            rows.forEach((row, index) => {
              const cells = row.querySelectorAll('td');
              console.log(`  Row ${index + 1}: ${cells.length} cells -`, Array.from(cells).map(c => c.textContent?.trim()).join(' | '));
              
              if (cells.length >= 6) {  // At least 6 columns minimum
                // Map columns based on actual PICK table structure:
                // 0=Line, 1=Part Number, 2=Description, 3=Qty, 4=UM, 5=Unit Price, 6=Total
                const line = cells[0]?.textContent?.trim() || '';
                const partNumber = cells[1]?.textContent?.trim() || '';
                const description = cells[2]?.textContent?.trim() || '';
                const qty = cells[3]?.textContent?.trim() || '';
                const um = cells[4]?.textContent?.trim() || '';
                const unitPrice = cells[5]?.textContent?.trim() || '';
                const totalText = cells[6]?.textContent?.trim() || '0';
                
                const lineTotal = parseFloat(totalText.replace(/[$,]/g, '')) || 0;
                total += lineTotal;
                
                extractedHTML += `
                  <tr style="${index % 2 === 0 ? 'background: #fafafa;' : 'background: white;'}">
                    <td style="border: 1px solid #333; padding: 8px; text-align: center; font-size: 12px;">${line}</td>
                    <td style="border: 1px solid #333; padding: 8px; font-family: monospace; font-size: 11px;">${partNumber}</td>
                    <td style="border: 1px solid #333; padding: 8px; font-size: 11px;">${description}</td>
                    <td style="border: 1px solid #333; padding: 8px; text-align: center; font-size: 11px;">${um}</td>
                    <td style="border: 1px solid #333; padding: 8px; text-align: right; font-size: 12px;">${qty}</td>
                    <td style="border: 1px solid #333; padding: 8px; text-align: right; font-size: 12px;">${unitPrice}</td>
                    <td style="border: 1px solid #333; padding: 8px; text-align: right; font-size: 12px; font-weight: bold;">${totalText}</td>
                  </tr>
                `;
              }
            });
            
            console.log(`üí∞ Calculated total: $${total.toFixed(2)}`);
            
            extractedHTML += `
                </tbody>
                <tfoot>
                  <tr style="background: #f3f4f6; font-weight: bold;">
                    <td colspan="6" style="border: 1px solid #333; padding: 8px; text-align: right; font-size: 12px;">Total:</td>
                    <td style="border: 1px solid #333; padding: 8px; text-align: right; font-size: 12px;">$${total.toFixed(2)}</td>
                  </tr>
                </tfoot>
              </table>
            `;
            
            const lineItemsSection = pdfElement.querySelector('#line-items-section');
            if (lineItemsSection) {
              lineItemsSection.innerHTML = extractedHTML;
            }
            console.log('‚úÖ Line items extracted from preview modal DOM');
            
          } else {
            console.error('‚ùå No line items found in preview modal DOM either');
            const lineItemsSection = pdfElement.querySelector('#line-items-section');
            if (lineItemsSection) {
              lineItemsSection.innerHTML = `
                <div style="padding: 20px; text-align: center; color: #ef4444; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px;">
                  <strong>‚ö†Ô∏è No Line Items Found</strong><br>
                  <span style="font-size: 14px;">Please add line items to the Sales Order before exporting.</span>
                </div>
              `;
            }
          }
        }

        // Populate tracking information from multiple data sources
        const trackingSection = pdfElement.querySelector('#tracking-section');
        const trackingData = window.poTrackingData || window.currentSOData;
        
        if (trackingSection && trackingData) {
          console.log('üìä Building tracking section with data:', trackingData);
          let trackingHTML = '';
          
          // Needs - try both tracking data sources
          const needsData = trackingData.needs || trackingData.needs_info || [];
          if (needsData && needsData.length > 0) {
            trackingHTML += `
              <div style="margin-bottom: 20px;">
                <h3 style="color: #374151; margin: 0 0 10px 0;">Needs</h3>
                <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="background: #f3f4f6;">
                      <th style="border: 1px solid #333; padding: 6px; font-size: 11px;">Line</th>
                      <th style="border: 1px solid #333; padding: 6px; font-size: 11px;">Part</th>
                      <th style="border: 1px solid #333; padding: 6px; font-size: 11px;">Date</th>
                      <th style="border: 1px solid #333; padding: 6px; font-size: 11px;">Quantity</th>
                    </tr>
                  </thead>
                  <tbody>
            `;
            needsData.forEach(need => {
              trackingHTML += `
                <tr>
                  <td style="border: 1px solid #333; padding: 6px; font-size: 11px;">${need.lineNumber || ''}</td>
                  <td style="border: 1px solid #333; padding: 6px; font-size: 11px;">${need.partNumber || ''}</td>
                  <td style="border: 1px solid #333; padding: 6px; font-size: 11px;">${need.needDate || ''}</td>
                  <td style="border: 1px solid #333; padding: 6px; font-size: 11px; text-align: right;">${need.quantity || ''}</td>
                </tr>
              `;
            });
            trackingHTML += '</tbody></table></div>';
          }

          // Acknowledgments - try both tracking data sources
          const acksData = trackingData.acknowledgments || trackingData.acknowledgments_info || [];
          if (acksData && acksData.length > 0) {
            trackingHTML += `
              <div style="margin-bottom: 20px;">
                <h3 style="color: #374151; margin: 0 0 10px 0;">Acknowledgments</h3>
                <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="background: #f3f4f6;">
                      <th style="border: 1px solid #333; padding: 6px; font-size: 11px;">Line</th>
                      <th style="border: 1px solid #333; padding: 6px; font-size: 11px;">Part</th>
                      <th style="border: 1px solid #333; padding: 6px; font-size: 11px;">ACK Date</th>
                      <th style="border: 1px solid #333; padding: 6px; font-size: 11px;">Quantity</th>
                      <th style="border: 1px solid #333; padding: 6px; font-size: 11px;">Ship Date</th>
                    </tr>
                  </thead>
                  <tbody>
            `;
            acksData.forEach(ack => {
              trackingHTML += `
                <tr>
                  <td style="border: 1px solid #333; padding: 6px; font-size: 11px;">${ack.lineNumber || ''}</td>
                  <td style="border: 1px solid #333; padding: 6px; font-size: 11px;">${ack.partNumber || ''}</td>
                  <td style="border: 1px solid #333; padding: 6px; font-size: 11px;">${ack.ackDate || ''}</td>
                  <td style="border: 1px solid #333; padding: 6px; font-size: 11px; text-align: right;">${ack.quantity || ''}</td>
                  <td style="border: 1px solid #333; padding: 6px; font-size: 11px;">${ack.shipDate || ''}</td>
                </tr>
              `;
            });
            trackingHTML += '</tbody></table></div>';
          }

          // Schedules - try both tracking data sources
          const schedulesData = trackingData.schedules || trackingData.schedule_info || [];
          if (schedulesData && schedulesData.length > 0) {
            trackingHTML += `
              <div style="margin-bottom: 20px;">
                <h3 style="color: #374151; margin: 0 0 10px 0;">Schedules</h3>
                <table style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="background: #f3f4f6;">
                      <th style="border: 1px solid #333; padding: 6px; font-size: 11px;">Line</th>
                      <th style="border: 1px solid #333; padding: 6px; font-size: 11px;">Part</th>
                      <th style="border: 1px solid #333; padding: 6px; font-size: 11px;">Schedule Date</th>
                      <th style="border: 1px solid #333; padding: 6px; font-size: 11px;">Quantity</th>
                    </tr>
                  </thead>
                  <tbody>
            `;
            schedulesData.forEach(schedule => {
              trackingHTML += `
                <tr>
                  <td style="border: 1px solid #333; padding: 6px; font-size: 11px;">${schedule.lineNumber || ''}</td>
                  <td style="border: 1px solid #333; padding: 6px; font-size: 11px;">${schedule.partNumber || ''}</td>
                  <td style="border: 1px solid #333; padding: 6px; font-size: 11px;">${schedule.scheduleDate || ''}</td>
                  <td style="border: 1px solid #333; padding: 6px; font-size: 11px; text-align: right;">${schedule.quantity || ''}</td>
                </tr>
              `;
            });
            trackingHTML += '</tbody></table></div>';
          }

          if (trackingHTML) {
            trackingSection.innerHTML = trackingHTML;
            console.log('‚úÖ Tracking information populated');
          } else {
            trackingSection.innerHTML = `
              <div style="padding: 15px; text-align: center; color: #6b7280; background: #f9fafb; border-radius: 8px;">
                No tracking information available for this Sales Order.
              </div>
            `;
          }
        } else {
          console.log('‚ÑπÔ∏è No tracking data available - trying to extract from preview modal');
          
          // Try to extract tracking data from the preview modal DOM
          const previewModal = document.getElementById('poPreviewModal');
          if (previewModal) {
            const trackingTabContent = previewModal.querySelector('#tracking-content');
            if (trackingTabContent && trackingTabContent.innerHTML.trim()) {
              
              // Clean up and style the tracking content for PDF
              let trackingContent = trackingTabContent.innerHTML;
              
              // Replace existing table styles with PDF-friendly ones
              trackingContent = trackingContent.replace(/class="[^"]*"/g, '');
              trackingContent = trackingContent.replace(/<table[^>]*>/g, '<table style="width: 100%; border-collapse: collapse; margin: 10px 0;">');
              trackingContent = trackingContent.replace(/<th[^>]*>/g, '<th style="border: 1px solid #333; padding: 6px; background: #f3f4f6; font-size: 11px; text-align: left;">');
              trackingContent = trackingContent.replace(/<td[^>]*>/g, '<td style="border: 1px solid #333; padding: 6px; font-size: 11px;">');
              trackingContent = trackingContent.replace(/<h3[^>]*>/g, '<h3 style="color: #374151; margin: 20px 0 10px 0; font-size: 14px;">');
              
              trackingSection.innerHTML = `
                <div style="font-size: 12px;">
                  ${trackingContent}
                </div>
              `;
              console.log('‚úÖ Extracted and styled tracking data from preview modal');
            } else {
              trackingSection.innerHTML = `
                <div style="padding: 15px; text-align: center; color: #6b7280; background: #f9fafb; border-radius: 8px;">
                  No tracking information available for this Sales Order.
                </div>
              `;
            }
          }
        }

        console.log('üîç PDF Debug: PDF element created, HTML length:', pdfElement.innerHTML.length);
        
        // Wait for rendering
        await new Promise(resolve => setTimeout(resolve, 1000));

        // Open HTML in new window for manual PDF conversion
        console.log('üñ®Ô∏è Opening HTML for manual PDF conversion...');
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
          <!DOCTYPE html>
          <html>
          <head>
            <title>Sales Order - ${soNumber}</title>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
              * {
                box-sizing: border-box;
              }
              
              html {
                height: auto;
                overflow: visible;
              }
              
              body { 
                font-family: Arial, sans-serif; 
                margin: 0; 
                padding: 20px; 
                background: white; 
                color: black;
                line-height: 1.4;
                min-height: auto;
                overflow: visible;
              }
              
              @page {
                size: letter;
                margin: 0.5in;
              }
              
              @media print {
                html, body {
                  height: auto;
                  overflow: visible;
                  page-break-after: auto;
                }
                
                body { 
                  margin: 0; 
                  padding: 15px;
                  overflow: visible;
                }
                
                .no-print { 
                  display: none !important; 
                }
                
                /* Prevent content from being cut off */
                * {
                  overflow: visible !important;
                }
                
                /* Allow page breaks inside long content */
                table, div, section {
                  page-break-inside: auto;
                }
                
                tr {
                  page-break-inside: avoid;
                  page-break-after: auto;
                }
                
                thead {
                  display: table-header-group;
                }
                
                tfoot {
                  display: table-footer-group;
                }
              }
              
              @media screen {
                body {
                  max-width: 8.5in;
                  margin: 0 auto;
                }
              }
              
              table { 
                width: 100%; 
                border-collapse: collapse; 
                margin: 15px 0;
                page-break-inside: auto;
              }
              
              th, td { 
                border: 1px solid #333; 
                padding: 8px; 
                text-align: left; 
                font-size: 12px;
                page-break-inside: avoid;
              }
              
              th { 
                background-color: #f0f0f0; 
                font-weight: bold;
              }
              
              h1 { 
                color: #333; 
                font-size: 28px; 
                margin-bottom: 10px;
                page-break-after: avoid;
              }
              
              h2 { 
                color: #333; 
                font-size: 18px; 
                margin: 20px 0 10px 0;
                border-bottom: 2px solid #10b981;
                padding-bottom: 5px;
                page-break-after: avoid;
              }
              
              h3, h4 { 
                color: #333; 
                margin: 15px 0 8px 0;
                page-break-after: avoid;
              }
              
              .header-grid {
                display: grid;
                grid-template-columns: 1fr 1fr;
                gap: 20px;
                margin-bottom: 20px;
              }
              
              .field-box {
                background: #f8f8f8;
                padding: 8px;
                border-radius: 4px;
                border: 1px solid #ddd;
                page-break-inside: avoid;
              }
              
              @media print {
                .header-grid {
                  display: block;
                }
                
                .field-box {
                  margin-bottom: 10px;
                  page-break-inside: avoid;
                }
              }
            </style>
          </head>
          <body>
            ${pdfElement.innerHTML}
            <div class="no-print" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #10b981; text-align: center;">
              <button onclick="window.print();" style="padding: 15px 30px; font-size: 16px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; margin-right: 10px;">
                üñ®Ô∏è Print / Save as PDF
              </button>
              <button onclick="window.close();" style="padding: 15px 30px; font-size: 16px; background: #6b7280; color: white; border: none; border-radius: 8px; cursor: pointer;">
                ‚úñÔ∏è Close
              </button>
              <div style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 8px; color: #1565c0;">
                <strong>üìã Instructions:</strong><br>
                1. Click "Print / Save as PDF" button above<br>
                2. In print dialog, select "Save as PDF" as destination<br>
                3. Choose location and save your Sales Order
              </div>
            </div>
          </body>
          </html>
        `);
        
        printWindow.document.close();
        
        // Focus the new window
        setTimeout(() => {
          printWindow.focus();
        }, 500);
        
        console.log('‚úÖ PDF generated successfully');
        
        // Cleanup
        if (document.body.contains(pdfElement)) {
          document.body.removeChild(pdfElement);
        }
        loadingOverlay.remove();
        
        // Success notification
        showNotification('HTML opened in new window. Use Print ‚Üí Save as PDF to convert.', 'success');
        
      } catch (error) {
        console.error('‚ùå PDF export error:', error);
        
        // Cleanup loading
        if (loadingOverlay.parentNode) {
          loadingOverlay.remove();
        }
        
        // Error notification
        showNotification(`PDF export failed: ${error.message}`, 'error');
      }
    }

    // Helper function for notifications
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'error' ? '#ef4444' : type === 'success' ? '#10b981' : '#3b82f6'};
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        z-index: 10002;
        font-weight: 600;
        box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        max-width: 350px;
        animation: slideIn 0.3s ease-out;
      `;
      
      const icon = type === 'error' ? 'fa-exclamation-triangle' : 
                   type === 'success' ? 'fa-check-circle' : 'fa-info-circle';
      
      notification.innerHTML = `
        <i class="fas ${icon}" style="margin-right: 8px;"></i>
        ${message}
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        if (document.body.contains(notification)) {
          notification.style.animation = 'slideOut 0.3s ease-in';
          setTimeout(() => {
            if (document.body.contains(notification)) {
              notification.remove();
            }
          }, 300);
        }
      }, type === 'error' ? 5000 : 3000);
    }

    // Add CSS animations for notifications
    if (!document.getElementById('notification-styles')) {
      const style = document.createElement('style');
      style.id = 'notification-styles';
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
        @keyframes slideOut {
          from { transform: translateX(0); opacity: 1; }
          to { transform: translateX(100%); opacity: 0; }
        }
        @keyframes pulse {
          0%, 100% { opacity: 1; transform: scale(1); }
          50% { opacity: 0.5; transform: scale(1.2); }
        }
      `;
      document.head.appendChild(style);
    }

    // System Diagnostic Function
    function runSystemDiagnostic() {
      console.log('üîç Running System Diagnostic...');
      
      const diagnosticResults = {
        timestamp: new Date().toISOString(),
        userAgent: navigator.userAgent,
        url: window.location.href,
        libraries: {
          html2pdf: typeof html2pdf !== 'undefined',
          html2canvas: typeof html2canvas !== 'undefined', 
          jsPDF: typeof jsPDF !== 'undefined'
        },
        dom: {
          previewModal: !!document.getElementById('poPreviewModal'),
          soNumberInput: !!document.getElementById('soNumberInput'),
          lineItems: window.lineItems ? window.lineItems.length : 0
        },
        network: {
          online: navigator.onLine,
          connection: navigator.connection ? {
            effectiveType: navigator.connection.effectiveType,
            downlink: navigator.connection.downlink
          } : 'Not available'
        },
        errors: []
      };

      // Test network connectivity
      fetch('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css', { method: 'HEAD' })
        .then(() => {
          diagnosticResults.network.cdnAccessible = true;
        })
        .catch(() => {
          diagnosticResults.network.cdnAccessible = false;
          diagnosticResults.errors.push('CDN not accessible - network issue or firewall blocking');
        });

      // Display results
      setTimeout(() => {
        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0,0,0,0.7);
          z-index: 10000;
          display: flex;
          align-items: center;
          justify-content: center;
          padding: 20px;
        `;

        modal.innerHTML = `
          <div style="background: white; border-radius: 12px; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto; padding: 24px;">
            <h2 style="margin: 0 0 16px 0; color: #1f2937; display: flex; align-items: center; gap: 8px;">
              <i class="fas fa-bug" style="color: #f59e0b;"></i>
              System Diagnostic Report
            </h2>
            
            <div style="background: #f3f4f6; padding: 16px; border-radius: 8px; margin-bottom: 16px; font-family: monospace; font-size: 12px; white-space: pre-wrap;">${JSON.stringify(diagnosticResults, null, 2)}</div>
            
            <div style="margin-bottom: 16px;">
              <h3 style="margin: 0 0 8px 0; color: #374151;">Quick Fixes:</h3>
              <ul style="margin: 0; padding-left: 20px; color: #6b7280;">
                <li>Try refreshing the page (Ctrl+F5 / Cmd+Shift+R)</li>
                <li>Check internet connection</li>
                <li>Disable ad blockers temporarily</li>
                <li>Try a different browser</li>
                <li>If PDF fails, use the print fallback option</li>
              </ul>
            </div>
            
            <div style="display: flex; gap: 12px; justify-content: flex-end;">
              <button onclick="this.parentElement.parentElement.parentElement.remove();" style="padding: 8px 16px; border: 1px solid #d1d5db; background: white; color: #374151; border-radius: 6px; cursor: pointer;">
                Close
              </button>
              <button onclick="console.log('System Diagnostic:', ${JSON.stringify(diagnosticResults)}); this.parentElement.parentElement.parentElement.remove();" style="padding: 8px 16px; border: none; background: #3b82f6; color: white; border-radius: 6px; cursor: pointer;">
                Copy to Console
              </button>
            </div>
          </div>
        `;

        document.body.appendChild(modal);
      }, 1000);
    }

    // SCHEDULE FIELD USER-EDIT TRACKING & DEBUG
    setTimeout(() => {
      for (let i = 1; i <= 5; i++) {
        const scheduleDate = document.getElementById(`lineScheduleDate${i}`);
        const scheduleQty = document.getElementById(`lineScheduleQty${i}`);
        
        if (scheduleDate) {
          // Mark as user-edited when user types in the field
          scheduleDate.addEventListener('input', function(e) {
            e.target.setAttribute('data-user-edited', 'true');
            console.log(`üîç FIELD DEBUG: lineScheduleDate${i} input event - new value: "${e.target.value}" - MARKED AS USER-EDITED`);
          });
          
          scheduleDate.addEventListener('change', function(e) {
            e.target.setAttribute('data-user-edited', 'true');
            console.log(`üîç FIELD DEBUG: lineScheduleDate${i} change event - new value: "${e.target.value}" - MARKED AS USER-EDITED`);
          });
          
          scheduleDate.addEventListener('blur', function(e) {
            console.log(`üîç FIELD DEBUG: lineScheduleDate${i} blur event - new value: "${e.target.value}"`);
          });
          
          // Monitor when field value gets overwritten programmatically
          let originalValue = scheduleDate.value;
          const checkValue = () => {
            if (scheduleDate.value !== originalValue) {
              console.log(`üö® FIELD DEBUG: lineScheduleDate${i} value CHANGED programmatically: "${originalValue}" ‚Üí "${scheduleDate.value}"`);
              console.trace('Stack trace of programmatic change:');
              originalValue = scheduleDate.value;
            }
          };
          
          // Check every 100ms for programmatic changes
          setInterval(checkValue, 100);
        }
        
        if (scheduleQty) {
          // Mark qty field as user-edited when user types in it
          scheduleQty.addEventListener('input', function(e) {
            e.target.setAttribute('data-user-edited', 'true');
            console.log(`üîç FIELD DEBUG: lineScheduleQty${i} input event - new value: "${e.target.value}" - MARKED AS USER-EDITED`);
          });
          
          scheduleQty.addEventListener('change', function(e) {
            e.target.setAttribute('data-user-edited', 'true');
            console.log(`üîç FIELD DEBUG: lineScheduleQty${i} change event - new value: "${e.target.value}" - MARKED AS USER-EDITED`);
          });
        }
      }
      console.log('‚úÖ Schedule field user-edit tracking & debug monitoring activated');
    }, 1000);

    // Global click listener to hide suggestions when clicking outside
    document.addEventListener('click', function(event) {
      // Hide Ship To suggestions
      const shipToInput = document.getElementById('shipToCodeInput');
      const shipToSuggestions = document.getElementById('shipToSuggestions');
      
      if (shipToInput && shipToSuggestions && 
          !shipToInput.contains(event.target) && 
          !shipToSuggestions.contains(event.target)) {
        hideShipToSuggestions();
      }

      // Hide Customer suggestions
      const customerInput = document.getElementById('customerCodeInput');
      const customerSuggestions = document.getElementById('customerSuggestions');
      
      if (customerInput && customerSuggestions && 
          !customerInput.contains(event.target) && 
          !customerSuggestions.contains(event.target)) {
        hideCustomerSuggestions(true); // Close immediately when clicking outside
      }
    });

    // PRINT VIEW FUNCTIONS
    function showPrintView() {
      const printView = document.getElementById('printView');
      const mainContent = document.querySelector('.container');
      
      if (printView && mainContent) {
        mainContent.style.display = 'none';
        printView.style.display = 'block';
        populatePrintView();
        
        // Force body to show everything without scroll
        document.body.style.overflow = 'hidden';
        document.body.style.height = '100vh';
        
        // DYNAMIC SCALING - Always use 100% of vertical space
        setTimeout(() => {
          const viewportHeight = window.innerHeight;
          const contentHeight = printView.scrollHeight;
          
          // Calculate scale to ALWAYS fill entire screen (no wasted space)
          let scale = (viewportHeight - 10) / contentHeight;
          
          // FULLY DYNAMIC: If few items ‚Üí bigger font, many items ‚Üí smaller font
          // Minimum 50% (many items), Maximum 100% (few items, fills entire screen)
          scale = Math.min(Math.max(scale, 0.50), 1.0);
          
          const compensatedWidth = (100 / scale) + '%';
          
          printView.style.transform = `scale(${scale})`;
          printView.style.transformOrigin = 'top left';
          printView.style.width = compensatedWidth;
          printView.style.height = 'auto';
          printView.style.minHeight = 'auto';
          printView.style.overflow = 'visible';
          printView.style.marginBottom = '0';
          
          // Calculate how much of screen is used
          const usedSpace = Math.round((contentHeight * scale / viewportHeight) * 100);
          console.log(`üìè Viewport: ${viewportHeight}px, Content: ${contentHeight}px, Scale: ${scale.toFixed(2)} (${Math.round(scale*100)}%), Screen Usage: ${usedSpace}%`);
        }, 100);
      }
    }

    function hidePrintView() {
      const printView = document.getElementById('printView');
      const mainContent = document.querySelector('.container');
      
      if (printView && mainContent) {
        printView.style.display = 'none';
        mainContent.style.display = 'block';
        
        // Restore original scale
        printView.style.transform = 'scale(1)';
        printView.style.width = '100%';
        
        // Restore body styles
        document.body.style.overflow = '';
        document.body.style.height = '';
        document.body.style.minHeight = '';
      }
    }

    function populatePrintView() {
      const soNumber = document.getElementById('soNumberInput')?.value || 'NEW PO';
      const poDate = document.getElementById('soDateInput')?.value || new Date().toLocaleDateString();
      const customerCode = document.getElementById('customerCodeInput')?.value || '';
      const shipToCode = document.getElementById('shipToCodeInput')?.value || '';
      
      // Get Ship Via info
      const shipViaSelect = document.getElementById('shipViaSelect');
      const shipViaText = shipViaSelect?.selectedOptions[0]?.text || shipViaSelect?.value || 'TBD';
      
      // Get Email info
      const emailInput = document.getElementById('emailInput');
      const emailText = emailInput?.value || 'Not provided';
      
      // Get Terms info
      const termsInput = document.getElementById('termsInput');
      const termsText = termsInput?.value || 'TBD';
      
      // Get Notes info (header notes)
      const notesInput = document.getElementById('notesInput');
      const notesText = notesInput?.value || '';
      
      // Get Salesperson info
      const salespersonInput = document.getElementById('salespersonInput');
      const salespersonText = salespersonInput?.value || 'TBD';
      
      // Update print view fields
      document.getElementById('printPONumber').textContent = soNumber;
      document.getElementById('printPODate').textContent = poDate;
      document.getElementById('printCustomerInfo').textContent = customerCode;
      document.getElementById('printShipToInfo').textContent = shipToCode;
      document.getElementById('printSalesperson').textContent = salespersonText;
      document.getElementById('printShipVia').textContent = shipViaText;
      document.getElementById('printTerms').textContent = termsText;
      document.getElementById('printNotes').textContent = notesText;
      
      // Update customer info with email if available
      const printCustomerInfoEl = document.getElementById('printCustomerInfo');
      if (printCustomerInfoEl && emailText !== 'Not provided') {
        // Get customer name if available
        const customerName = document.getElementById('customerName')?.textContent || customerCode;
        printCustomerInfoEl.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 8px;">${customerName}</div>
          <div style="font-size: 11px; color: #666;">
            <strong>Email:</strong> ${emailText}
          </div>
        `;
      }
      
      // Populate line items in print view
      populatePrintLineItems();
    }

    function populatePrintLineItems() {
      console.log('üñ®Ô∏è populatePrintLineItems called');
      console.log('üñ®Ô∏è lineItems array:', lineItems);
      console.log('üñ®Ô∏è lineItems length:', lineItems ? lineItems.length : 'NULL');
      
      const printTableBody = document.getElementById('printLineItemsBody');
      if (!printTableBody) {
        console.error('‚ùå printLineItemsBody element not found!');
        return;
      }
      
      let html = '';
      let total = 0;
      
      // If no line items exist, create some example ones for display
      let itemsToDisplay = lineItems;
      if (!lineItems || lineItems.length === 0) {
        console.warn('‚ö†Ô∏è No line items found, using example data');
        itemsToDisplay = [
          {
            quantity: 3,
            needDate: '21090',
            partNumber: '101-0206-030400',
            description: '100',
            unitPrice: 10.00
          },
          {
            quantity: 2,
            needDate: '21096', 
            partNumber: '715P27311-NA3',
            description: '200',
            unitPrice: 200.00
          },
          {
            quantity: 1,
            needDate: '21095',
            partNumber: '890X15422-B12',
            description: 'Special Component 300',
            unitPrice: 135.50
          }
        ];
      }
      
      itemsToDisplay.forEach((item, index) => {
        const itemTotal = (item.quantity || 0) * (item.unitPrice || 0);
        total += itemTotal;
        
        // Convert Julian date to display format
        const displayNeedDate = item.needDate ? julianToDisplay(item.needDate) : '';
        const displayScheduleDate = item.scheduleDate ? julianToDisplay(item.scheduleDate) : '';
        
        html += `
          <tr>
            <td style="text-align: center; padding: 14px 8px; border: 1px solid #ccc; font-size: 13px;">${index + 1}</td>
            <td style="text-align: center; padding: 14px 8px; border: 1px solid #ccc; font-size: 13px;">${item.quantity || ''}</td>
            <td style="text-align: center; padding: 14px 8px; border: 1px solid #ccc; font-size: 13px;">${displayNeedDate}</td>
            <td style="text-align: center; padding: 14px 8px; border: 1px solid #ccc; font-size: 13px;">${item.quantity || ''}</td>
            <td style="padding: 14px 8px; border: 1px solid #ccc; font-size: 13px; line-height: 1.4;">
              <strong>${item.partNumber || ''}</strong><br>
              <span style="color: #666; font-size: 12px;">${item.description || ''}</span>
            </td>
            <td style="text-align: right; padding: 14px 8px; border: 1px solid #ccc; font-size: 13px; white-space: nowrap;">$${(item.unitPrice || 0).toFixed(2)}</td>
            <td style="text-align: right; padding: 14px 8px; border: 1px solid #ccc; font-size: 13px; white-space: nowrap; font-weight: bold;">$${itemTotal.toFixed(2)}</td>
          </tr>
        `;
      });
      
      console.log('üñ®Ô∏è Generated HTML length:', html.length);
      console.log('üñ®Ô∏è Total items processed:', itemsToDisplay.length);
      console.log('üñ®Ô∏è Total amount:', total);
      
      printTableBody.innerHTML = html;
      document.getElementById('printTotal').textContent = `$${total.toFixed(2)}`;
      
      console.log('‚úÖ Print line items populated successfully');
    }

    function printPurchaseOrder() {
      window.print();
    }

    function downloadHTMLPreview() {
      const printView = document.getElementById('printView');
      if (!printView) return;
      
      // Get the current PO number for filename
      const soNumber = document.getElementById('soNumberInput')?.value || 'NEW_PO';
      const cleanPONumber = soNumber.replace(/[^a-zA-Z0-9]/g, '_');
      
      // Create complete HTML document
      const htmlContent = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sales Order - ${soNumber}</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: Arial, sans-serif;
      background: white;
      padding: 10px;
      color: #333;
    }
    
    .print-container {
      max-width: 8.5in;
      width: 100%;
      margin: 0 auto;
      background: white;
    }
    
    h1 {
      color: #3b82f6;
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 15px;
    }
    
    .company-section {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 15px;
      margin-bottom: 15px;
      min-height: 100px;
    }
    
    .company-left {
      background: linear-gradient(135deg,#1e293b 0%,#1e3a8a 100%);
      color: white;
      padding: 15px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .company-right {
      text-align: right;
      padding: 15px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    
    .customer-ship-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0;
      margin-bottom: 15px;
      border: 2px solid #3b82f6;
    }
    
    .section-header {
      background: linear-gradient(135deg,#1e293b 0%,#1e3a8a 100%);
      color: white;
      padding: 8px;
      text-align: center;
      font-weight: bold;
    }
    
    .section-content {
      padding: 15px;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
    }
    
    th, td {
      padding: 8px 6px;
      border: 1px solid #ccc;
      text-align: left;
      vertical-align: top;
      font-size: 11px;
      line-height: 1.3;
    }
    
    th {
      background: linear-gradient(135deg,#1e293b 0%,#1e3a8a 100%);
      color: white;
      font-weight: bold;
      font-size: 10px;
      text-align: center;
    }
    
    .compliance-section {
      background: linear-gradient(135deg,#1e293b 0%,#1e3a8a 100%);
      color: white;
      padding: 8px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .notes-section {
      margin-bottom: 30px;
    }
    
    .signature-section {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 40px;
      margin-bottom: 60px;
    }
    
    .signature-item {
      text-align: center;
    }
    
    .signature-line {
      border-top: 2px solid #000;
      margin: 40px 0 10px 0;
    }
    
    .order-details {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 1px;
      margin-bottom: 15px;
      border: 1px solid #ccc;
    }
    
    .order-detail-item {
      padding: 8px;
      background: #f8f9fa;
    }
    
    @media print {
      body { margin: 0; padding: 0; }
      .print-container { max-width: none; }
    }
  </style>
</head>
<body>
  <div class="print-container">
    ${printView.innerHTML.replace(/style="[^"]*print:\s*none[^"]*"/g, 'style="display: none"')}
  </div>
</body>
</html>`;

      // Create blob and download
      const blob = new Blob([htmlContent], { type: 'text/html' });
      const url = URL.createObjectURL(blob);
      
      // Create download link
      const a = document.createElement('a');
      a.href = url;
      a.download = `PO_${cleanPONumber}_Preview.html`;
      a.style.display = 'none';
      
      // Trigger download
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      
      // Clean up
      URL.revokeObjectURL(url);
      
      // Show success message
      const existingMsg = document.querySelector('.download-success-msg');
      if (existingMsg) existingMsg.remove();
      
      const successMsg = document.createElement('div');
      successMsg.className = 'download-success-msg';
      successMsg.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        z-index: 9999;
        animation: slideIn 0.3s ease-out;
      `;
      successMsg.innerHTML = `
        <i class="fas fa-check-circle" style="margin-right: 8px;"></i>
        HTML Preview Downloaded: PO_${cleanPONumber}_Preview.html
      `;
      
      // Add animation
      const style = document.createElement('style');
      style.textContent = `
        @keyframes slideIn {
          from { transform: translateX(100%); opacity: 0; }
          to { transform: translateX(0); opacity: 1; }
        }
      `;
      document.head.appendChild(style);
      
      document.body.appendChild(successMsg);
      
      // Remove success message after 3 seconds
      setTimeout(() => {
        if (successMsg && successMsg.parentNode) {
          successMsg.style.animation = 'slideIn 0.3s ease-out reverse';
          setTimeout(() => {
            if (successMsg.parentNode) successMsg.parentNode.removeChild(successMsg);
            if (style.parentNode) style.parentNode.removeChild(style);
          }, 300);
        }
      }, 3000);
    }
  </script>

  <!-- PROFESSIONAL PRINT VIEW (Hidden by default) -->
  <div id="printView" style="display: none; padding: 15px 20px; max-width: 8.5in; width: 100%; margin: 0 auto; font-family: Arial, sans-serif; background: white; box-sizing: border-box; overflow: visible; min-height: auto; height: auto; font-size: 20px;">
    <!-- Print Controls -->
    <div style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; print: none;">
      <button onclick="hidePrintView()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
        <i class="fas fa-arrow-left"></i> Back to Edit
      </button>
      <div style="display: flex; gap: 10px;">
        <button onclick="downloadHTMLPreview()" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: bold;">
          <i class="fas fa-download"></i> Download HTML
        </button>
        <button onclick="printPurchaseOrder()" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
          <i class="fas fa-print"></i> Print
        </button>
      </div>
    </div>

    <!-- HEADER SECTION -->
    <div style="text-align: center; margin-bottom: 15px;">
      <h1 style="color: #3b82f6; font-size: 20px; font-weight: bold; margin: 0;">Original Sales Order</h1>
    </div>

    <!-- COMPANY INFO SECTION -->
    <div style="display: grid; grid-template-columns: 300px 1fr; gap: 15px; margin-bottom: 15px; min-height: 100px;">
      <!-- Left: Company Info with Logo -->
      <div style="background: linear-gradient(135deg,#1e293b 0%,#1e3a8a 100%); color: white; padding: 15px; display: flex; align-items: center; gap: 12px;">
        <!-- TAIMEX Logo (Original size) -->
        <img src="http://54.189.226.145/uploads/assets/images/taimex_logo.png" alt="TAIMEX INDUSTRIAL" style="height: 40px; width: auto; object-fit: contain; filter: brightness(1.05);" onerror="this.style.display='none'; this.parentNode.style.cssText='width: 60px; height: 60px; background: linear-gradient(135deg,#1e293b 0%,#1e3a8a 100%); color: white; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; flex-shrink: 0; min-width: 60px; max-width: 60px; padding: 4px; font-family: Arial, sans-serif;'; this.parentNode.innerHTML='<div style=\&quot;font-size: 7px; font-weight: bold; text-align: center; line-height: 0.9;\&quot;>TAIMEX</div><div style=\&quot;font-size: 5px; font-weight: bold; text-align: center; line-height: 0.9;\&quot;>INDUSTRIAL</div><div style=\&quot;width: 70%; height: 1px; background: white; margin: 1px 0;\&quot;></div><div style=\&quot;font-size: 4px; text-align: center; line-height: 0.9;\&quot;>S.A. DE C.V.</div>';" />
        <div>
          <div style="font-size: 13px; line-height: 1.3;">
            123 Business Ave<br>
            Tijuana, BC 22000<br>
            M√©xico
          </div>
        </div>
      </div>
      
      <!-- Right: Contact Info -->
      <div style="text-align: right; padding: 15px; display: flex; flex-direction: column; justify-content: center;">
        <div style="font-size: 12px; line-height: 1.5;">
          <strong>Phone:</strong> (664) 123-4567<br>
          <strong>Fax:</strong> (664) 123-4568<br>
          <strong>Email:</strong> orders@taimex.com
        </div>
      </div>
    </div>

    <!-- VENDOR AND SHIP TO SECTION -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0; margin-bottom: 15px; border: 2px solid #3b82f6;">
      <!-- Customer Section -->
      <div>
        <div style="background: linear-gradient(135deg,#1e293b 0%,#1e3a8a 100%); color: white; padding: 8px; text-align: center; font-weight: bold;">
          Customer
        </div>
        <div style="padding: 15px; min-height: 100px;">
          <div id="printCustomerInfo" style="font-weight: bold; margin-bottom: 10px;">VENDOR INFO</div>
          <div style="font-size: 12px; color: #666;">
            Customer Performance:<br>
            <span style="color: #dc2626;">Delivery: 95% Quality: 100%</span>
          </div>
          <div style="margin-top: 15px; font-weight: bold;">
            PLEASE SHIP THE PARTS LISTED BELOW:
          </div>
        </div>
      </div>
      
      <!-- Ship To Section -->
      <div style="border-left: 1px solid #3b82f6;">
        <div style="background: linear-gradient(135deg,#1e293b 0%,#1e3a8a 100%); color: white; padding: 8px; text-align: center; font-weight: bold;">
          Ship To:
        </div>
        <div style="padding: 15px;">
          <div id="printShipToInfo" style="font-weight: bold; margin-bottom: 10px;">SHIP TO INFO</div>
          
          <!-- Session ID Section -->
          <div style="border: 1px solid #ccc; padding: 10px; margin-top: 15px; text-align: center;">
            <div style="font-weight: bold; margin-bottom: 5px;">SESSION ID</div>
            <div style="color: #3b82f6; font-size: 18px; font-weight: bold;" id="printPONumber">NEW PO</div>
            <div style="font-size: 11px; margin-top: 5px; font-style: italic;">
              A FIRM PO NUMBER WILL BE ASSIGNED AT SUBMIT TIME
            </div>
            <div style="font-size: 10px; margin-top: 10px; border-top: 1px solid #ccc; padding-top: 5px;">
              <strong>Notice:</strong> This number must be shown on all<br>
              invoices, containers, and packing lists.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ORDER DETAILS ROW -->
    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1px; margin-bottom: 15px; border: 1px solid #ccc;">
      <div style="padding: 8px; background: #f8f9fa;">
        <strong>Date:</strong> <span id="printPODate">TODAY</span>
      </div>
      <div style="padding: 8px; background: #f8f9fa;">
        <strong>Ship Via:</strong> <span id="printShipVia">TBD</span>
      </div>
      <div style="padding: 8px; background: #f8f9fa;">
        <strong>Salesperson:</strong> <span id="printSalesperson">TBD</span>
      </div>
    </div>

    <!-- TERMS ROW -->
    <div style="display: grid; grid-template-columns: 1fr; gap: 1px; margin-bottom: 20px; border: 1px solid #ccc;">
      <div style="padding: 8px; background: #f8f9fa;">
        <strong>Terms:</strong> <span id="printTerms">TBD</span>
      </div>
    </div>

    <!-- COMPLIANCE SECTION -->
    <div style="background: linear-gradient(135deg,#1e293b 0%,#1e3a8a 100%); color: white; padding: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
      <span style="font-size: 18px;">‚òëÔ∏è</span>
      <span><strong>Yes</strong> ‚òê <strong>No</strong></span>
      <span>: Certificate of Compliance required with each shipment.</span>
    </div>

    <!-- LINE ITEMS TABLE -->
    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
      <thead>
        <tr style="background: linear-gradient(135deg,#1e293b 0%,#1e3a8a 100%); color: white;">
          <th style="padding: 8px; border: 1px solid #ccc; text-align: center;">Item</th>
          <th style="padding: 8px; border: 1px solid #ccc; text-align: center;">Total Qty</th>
          <th style="padding: 8px; border: 1px solid #ccc; text-align: center;">Date Reqd</th>
          <th style="padding: 8px; border: 1px solid #ccc; text-align: center;">Release Qty</th>
          <th style="padding: 8px; border: 1px solid #ccc;">Part Number and Description</th>
          <th style="padding: 8px; border: 1px solid #ccc; text-align: center;">Unit Price</th>
          <th style="padding: 8px; border: 1px solid #ccc; text-align: center;">Total</th>
        </tr>
      </thead>
      <tbody id="printLineItemsBody">
        <!-- Line items will be populated by JavaScript -->
      </tbody>
      <tfoot>
        <tr>
          <td colspan="6" style="padding: 8px; border: 1px solid #ccc; text-align: right; font-weight: bold;">Total</td>
          <td style="padding: 8px; border: 1px solid #ccc; text-align: right; font-weight: bold;" id="printTotal">$0.00</td>
        </tr>
      </tfoot>
    </table>

    <!-- NOTES SECTION -->
    <div style="margin-bottom: 30px; page-break-inside: avoid;">
      <div style="background: linear-gradient(135deg,#1e293b 0%,#1e3a8a 100%); color: white; padding: 8px; font-weight: bold;">Notes:</div>
      <div id="printNotes" style="border: 1px solid #ccc; border-top: none; padding: 15px; white-space: pre-wrap; max-height: none !important; overflow: visible !important;">
        <!-- Notes content will go here -->
      </div>
    </div>

    <!-- SIGNATURE SECTION -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; margin-bottom: 10px; page-break-inside: avoid;">
      <!-- Manager Signature -->
      <div style="text-align: center;">
        <div style="border-top: 2px solid #000; margin: 20px 0 10px 0;"></div>
        <div style="font-weight: bold; font-size: 18px;">Sharon Bartnik</div>
        <div style="font-style: italic; color: #666;">Purchasing Manager</div>
      </div>
      
      <!-- Customer Acknowledgment -->
      <div style="text-align: center;">
        <div style="border-top: 2px solid #000; margin: 20px 0 10px 0;"></div>
        <div style="font-size: 12px; color: #666;">
          Customer Signature & Date
        </div>
      </div>
    </div>
  </div>

  <!-- AUTO-REFRESH SCRIPT -->
  <script>
    // Execute refresh only when PO data is loaded (removed auto-refresh on page load)
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üöÄ DOM loaded - info boxes will show only when PO data is available...');
      // Removed automatic refresh to prevent boxes showing before search
    });
  </script>

</body>
</html>
// FORCE CACHE REFRESH Mon Sep 22 21:04:21 PDT 2025
