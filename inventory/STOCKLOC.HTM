<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TAIMEX</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>*{margin:0;padding:0;box-sizing:border-box}html,body{height:100vh;overflow:hidden;width:100%}body{font-family:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif;background:linear-gradient(135deg,#f1f5f9 0%,#e2e8f0 100%);color:#334155;width:100%}.container{width:100%;height:100vh;background:#fff;display:flex;flex-direction:column;overflow:hidden}.header{background:linear-gradient(135deg,#1e293b 0%,#1e3a8a 100%);color:#fff;padding:12px 24px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 8px rgba(30,41,59,.25);position:relative;z-index:100;width:100%}.header-left{display:flex;align-items:center;gap:20px;position:relative;z-index:1}.logo-section img{height:40px;width:auto;object-fit:contain;filter:brightness(1.05)}.title-section{text-align:right;position:relative;z-index:1}.title-row{display:flex;align-items:center;justify-content:flex-end;gap:15px}.welcome-user{white-space:nowrap}.welcome-user span{color:#cbd5e1;font-size:.8em;font-weight:400}.welcome-user strong{color:#3b82f6;margin-left:4px;font-weight:600}.title-section h2{font-size:.95em;margin:0;font-weight:500;color:#cbd5e1;letter-spacing:.3px}.title-section p{font-size:.75em;margin:2px 0 0 0;color:#a2a8ba;font-weight:400}.hamburger-menu{background:none;border:none;color:#fff;font-size:1.2em;cursor:pointer;padding:8px;border-radius:6px;transition:background-color .2s ease}.hamburger-menu:hover{background-color:rgba(255,255,255,.12)}.main-content{flex:1;display:flex;flex-direction:column;overflow:hidden;width:100%}.sidebar{position:fixed;top:0;left:-300px;width:300px;height:100vh;background:rgba(255,255,255,.08);backdrop-filter:blur(1px);-webkit-backdrop-filter:blur(1px);color:#fff;transition:left .2s ease;z-index:2000;box-shadow:2px 0 12px rgba(0,0,0,.35)}.sidebar.active{left:0}.sidebar-overlay{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.55);opacity:0;visibility:hidden;transition:all .25s ease;z-index:1500;pointer-events:none}.sidebar-overlay.active{opacity:1;visibility:visible;pointer-events:auto}.sidebar-content{padding:24px}.sidebar-header{padding:20px;border-bottom:1px solid rgba(255,255,255,.08);background:rgba(255,255,255,.05)}.sidebar-header h3{font-size:1.2em;color:#fff;margin:0}.sidebar-menu{list-style:none;padding:0;margin:0}.sidebar-menu li{margin-bottom:8px}.sidebar-menu a{display:block;padding:12px 16px;color:#f3f4f6;text-decoration:none;border-radius:8px;transition:all .2s ease;font-weight:500}.sidebar-menu a:hover{background-color:rgba(30,64,175,.1);color:#fff}.sidebar-menu a.active{background-color:rgba(30,64,175,.2);color:#93c5fd}.sidebar-menu a i{margin-right:12px;width:20px;text-align:center}.tab-navigation{background:#fff;border-bottom:1px solid #e2e8f0;width:100%}.tab-buttons{display:flex;flex-wrap:wrap;width:100%}.tab-button{background:none;border:none;padding:12px 20px;color:#64748b;font-weight:500;cursor:pointer;transition:all .3s ease;border-bottom:3px solid transparent;display:flex;align-items:center;gap:8px}.tab-button:hover{color:#1e40af;background:rgba(30,64,175,.05)}.tab-button.active{color:#1e40af;background:rgba(30,64,175,.1);border-bottom-color:#1e40af;font-weight:600}.tab-content{flex:1;overflow:hidden;width:100%}.tab-pane{display:none;height:100%;overflow-y:auto;padding:16px 20px;background:#f8fafc;width:100%}.tab-pane.active{display:block}.form-container{background:rgba(255,255,255,.9);border-radius:16px;padding:20px;margin-bottom:16px;box-shadow:0 8px 32px rgba(0,0,0,.1);width:100%;max-width:none}.form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:16px;margin-bottom:16px;width:100%;max-width:none}.form-group{display:flex;flex-direction:column}.form-group label{font-weight:600;color:#374151;margin-bottom:8px}.form-group input,.form-group select,.form-group textarea{padding:10px 12px;border:2px solid #e5e7eb;border-radius:8px;transition:.2s;width:100%}.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#3b82f6}.btn{padding:12px 24px;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:.2s;display:inline-flex;align-items:center;gap:8px}.btn-primary{background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);color:white}.btn-secondary{background:#6b7280;color:white}.form-actions{display:flex;gap:12px;margin-top:20px}.search-container{margin-bottom:12px;width:100%}.search-container input{width:100%;padding:10px 12px;border:2px solid #e5e7eb;border-radius:8px}.excel-grid-wrapper{background:rgba(255,255,255,.95);border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.1);overflow:hidden;flex:1;display:flex;flex-direction:column;min-height:0;width:100%}.grid-toolbar{background:#f8f9fa;padding:12px 20px;border-bottom:1px solid #dee2e6;display:flex;align-items:center;justify-content:space-between;width:100%}.results-count{background:rgba(59,130,246,0.1);padding:4px 12px;border-radius:20px;font-size:.85em;color:#64748b}.excel-grid-container{flex:1;overflow-y:auto;overflow-x:auto;border:1px solid #dee2e6;border-radius:0 0 12px 12px;background:#fff;position:relative;min-height:250px;height:calc(100vh - 240px);width:100%}.excel-grid-container::-webkit-scrollbar{width:12px}.excel-grid-container::-webkit-scrollbar-track{background:#f1f3f4;border-radius:6px}.excel-grid-container::-webkit-scrollbar-thumb{background:linear-gradient(135deg,#2a5298 0%,#1e3c72 100%);border-radius:6px;border:2px solid #f1f3f4}.excel-grid-container::-webkit-scrollbar-thumb:hover{background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%)}table.excel-grid-premium{width:100%;border-collapse:collapse;font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;font-size:11px;background:#fff;min-width:100%;border:1px solid #dee2e6}.excel-header{background:linear-gradient(135deg,#2a5298 0%,#1e3c72 100%);color:white;padding:8px 12px;font-weight:600;text-align:left;border-right:1px solid #1e3c72;position:sticky;top:0;z-index:10;cursor:pointer;user-select:none;transition:all .2s ease;font-size:11px}.excel-header:hover{background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%)}.excel-header.sorted{background:linear-gradient(135deg,#2a5298 0%,#1e3c72 100%)}.header-content{display:flex;align-items:center;justify-content:space-between;gap:8px}.sort-icon{opacity:.7;font-size:12px;transition:opacity .2s ease}.excel-header:hover .sort-icon{opacity:1}.resize-handle{position:absolute;right:0;top:0;bottom:0;width:4px;cursor:col-resize;background:rgba(255,255,255,.2);opacity:0;transition:opacity .2s ease}.excel-header:hover .resize-handle{opacity:1}.excel-row{transition:all .2s ease;cursor:pointer}.excel-row:nth-child(even){background:#fafafa}.excel-row:hover{background:#eef2ff}.excel-row.selected{background:#dbeafe}.filter-row th{background:#f1f5f9;position:sticky;top:36px;z-index:5}.filter-cell{padding:6px 8px;border-bottom:1px solid #e5e7eb}.filter-input{width:100%;padding:6px 8px;border:1px solid #cbd5e1;border-radius:6px;font-size:12px}.toolbar-right{display:flex;gap:8px}.grid-btn{background:#e2e8f0;color:#1e293b;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-size:12px;display:inline-flex;align-items:center;gap:6px}.grid-btn:hover{filter:brightness(.95)}.excel-cell{padding:8px 10px;border-bottom:1px solid #e5e7eb}.excel-cell.readonly{opacity:.85}.cell-content{display:flex;align-items:center;gap:6px}.action-buttons{display:flex;align-items:center;justify-content:center;gap:8px}.btn-sm{border:none;padding:6px 8px;border-radius:6px;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}.btn-edit{background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);color:#fff}.btn-delete{background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);color:#fff}.actions-header{min-width:120px} .notification-container{position:fixed;top:20px;right:20px;z-index:10000;pointer-events:none} .notification{background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:#fff;padding:16px 24px;border-radius:12px;box-shadow:0 10px 25px rgba(16,185,129,.3);display:flex;align-items:center;gap:12px;font-weight:500;font-size:14px;min-width:300px;transform:translateX(400px);opacity:0;transition:all .4s cubic-bezier(0.175,0.885,0.32,1.275);border-left:4px solid #34d399;backdrop-filter:blur(10px)} .notification.show{transform:translateX(0);opacity:1} .notification.hide{transform:translateX(400px);opacity:0} .notification-icon{background:rgba(255,255,255,.2);border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;font-size:16px;animation:pulse 2s infinite} .notification-content{flex:1} .notification-title{font-weight:600;margin-bottom:2px} .notification-message{font-size:13px;opacity:.9} @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.05)}100%{transform:scale(1)}} .notification.bounce{animation:slideInBounce .6s cubic-bezier(0.175,0.885,0.32,1.275)} @keyframes slideInBounce{0%{transform:translateX(400px) scale(.8);opacity:0}60%{transform:translateX(-10px) scale(1.02);opacity:1}100%{transform:translateX(0) scale(1);opacity:1}} .notification.error{background:linear-gradient(135deg,#ef4444 0%,#dc2626 100%);box-shadow:0 10px 25px rgba(239,68,68,.3);border-left:4px solid #f87171} .notification.warning{background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);box-shadow:0 10px 25px rgba(245,158,11,.3);border-left:4px solid #fbbf24} .notification.info{background:linear-gradient(135deg,#3b82f6 0%,#2563eb 100%);box-shadow:0 10px 25px rgba(59,130,246,.3);border-left:4px solid #60a5fa} .notification.loading{background:linear-gradient(135deg,#10b981 0%,#059669 100%);box-shadow:0 10px 25px rgba(16,185,129,.3);border-left:4px solid #34d399} .notification.loading .notification-icon i{animation:spin 1s linear infinite} @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}</style>
</head>
<body>
  <script>
    (function(){
      function showErr(msg){
        try {
          var el = document.getElementById('__preview_error_overlay');
          if(!el){
            el = document.createElement('div');
            el.id='__preview_error_overlay';
            el.style.cssText='position:fixed;top:0;left:0;right:0;z-index:999999;background:#b91c1c;color:#fff;padding:10px 14px;font:12px/1.4 ui-monospace,Menlo,Consolas,monospace;white-space:pre-wrap;word-break:break-word;box-shadow:0 2px 8px rgba(0,0,0,.35)';
            document.body.appendChild(el);
          }
          el.textContent = '[Preview Error] ' + msg;
        } catch(_){}
      }
      window.addEventListener('error', function(e){
        try{ showErr(e.message + (e.lineno?(" @"+e.lineno+":"+(e.colno||0)):"") ); }catch(_){}
      });
      window.addEventListener('unhandledrejection', function(e){
        try{ showErr('Promise rejection: ' + (e.reason && (e.reason.stack||e.reason.message||String(e.reason)))); }catch(_){}
      });
    })();
  </script>
  <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h3>Menu</h3>
    </div>
    <div class="sidebar-content">
      <ul class="sidebar-menu">
                <li><a href="#" class="active">Customer Search</a></li>
                <li><a href="#">Sales Orders</a></li>
                <li><a href="#">Reports</a></li>
                <li><a href="#">Customer Management</a></li>
                <li><a href="#">Settings</a></li>
                <li><a href="#">Help</a></li>
      </ul>
    </div>
  </div>
  
  <div class="container">
    <div class="header">
      <div class="header-left">
        <button class="hamburger-menu" onclick="toggleSidebar()">
          <i class="fas fa-bars"></i>
        </button>
        <div class="logo-section">
          <img src="http://54.189.226.145/uploads/assets/images/taimex_logo.png" alt="TAIMEX" onerror="this.onerror=null;this.src='http://54.189.226.145/uploads/assets/images/taimex_logo.png';">
        </div>
      </div>
      <div class="title-section">
        <div class="title-row">
          <div class="welcome-user">
            <span>Welcome</span>
            <strong>Admin User</strong>
          </div>
          <div>
            <h2>TAIMEX</h2>
            <p>Stock Transactions - User Management System</p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="main-content">
      <div class="tab-navigation">
        <div class="tab-buttons">
        <button type="button" class="tab-button active" data-tab-index="0">
          <i class="fas fa-user-plus"></i>Data Capture
        </button>
        <button type="button" class="tab-button " data-tab-index="1">
          <i class="fas fa-users-cog"></i>Search & View
        </button>
        </div>
      </div>
      <div class="tab-content">
<div class="tab-pane active" id="tab-0"><div class="form-container"><h3 style="margin-bottom:24px; color:#1e293b;">Data Capture</h3><style>.form-group.required>label::after{content:" *";color:#ef4444;margin-left:4px}.info-alert{display:flex;gap:10px;align-items:flex-start;background:#eff6ff;border-left:4px solid #3b82f6;padding:12px 16px;border-radius:8px;color:#1e3a8a;margin-bottom:16px}.info-alert i{color:#3b82f6;margin-top:2px}.tab-pane .form-container{max-width:none;width:100%;margin:0;padding:20px 40px;display:flex;flex-direction:column;align-items:center}.form-grid{display:flex;flex-direction:column;gap:16px;max-width:500px;width:100%}.form-group{width:100%}</style><div class="info-alert"><i class="fas fa-info-circle"></i><div><strong>Important:</strong> Fields marked with <span style="color:#ef4444">*</span> are required. If applicable, both parts of the part number are required for exact searches.</div></div><form class="form-grid" onsubmit="return false;" onkeydown="handleFormKeyDown(event)">            <div class="form-group required">
                <label>Code</label>
                <input type="text" placeholder="code" name="code" required aria-required="true" id="codeInput"></input>
              </div>
            <div class="form-group required">
                <label>Description</label>
                <input type="text" placeholder="Description" name="whse" required aria-required="true" id="whseInput"></input>
              </div></form><div class="form-actions"><button type="button" class="btn btn-primary" onclick="return handleSave()"><i class="fas fa-save"></i> Save</button><button type="button" class="btn btn-secondary" onclick="return handleClear()"><i class="fas fa-undo"></i> Clear</button></div>

<!-- Authorization Helper Container removed: using simplified version below -->

</div></div><div class="tab-pane " id="tab-1"><div class="form-container"><h3 style="margin-bottom:24px; color:#1e293b;">Search & View</h3><div class="info-alert"><i class="fas fa-info-circle"></i><div><strong>Tip:</strong> You can search by text and filter by column. Click headers to sort. If applicable, both parts of the part number are required for exact searches.</div></div><div class="search-container"><input type="text" id="searchInput" placeholder="Search..." oninput="return handleSearch(this.value)"></div><div class="excel-grid-wrapper">  <div class="grid-toolbar">    <div class="toolbar-left"><span class="results-count"><i class="fas fa-database"></i> <span id="recordsCount">0 records shown</span></span></div>    <div class="toolbar-right">      <button type="button" class="grid-btn" onclick="return loadAllRecordsFromPicLan()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;"><i class="fas fa-cloud-download-alt"></i> Load from PicLan</button>      <button type="button" class="grid-btn" onclick="return exportToCSV()"><i class="fas fa-download"></i> Export CSV</button>      <button type="button" class="grid-btn" onclick="return clearFilters()"><i class="fas fa-times"></i> Clear Filters</button>      <button type="button" class="grid-btn" onclick="return manualCleanupLocalStorage()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;"><i class="fas fa-broom"></i> Clear Cache</button>    </div>  </div>  <div class="excel-grid-container">    <table class="excel-grid-premium">      <thead>        <tr>              <th class="excel-header" onclick="return sortTable(0)">
                  <div class="header-content">
                    <i class="fas fa-tag"></i> Code 
                    <i class="fas fa-sort sort-icon"></i>
                  </div>
                  <span class="resize-handle"></span>
                </th>
              <th class="excel-header" onclick="return sortTable(1)">
                  <div class="header-content">
                    <i class="fas fa-file-alt"></i> Description 
                    <i class="fas fa-sort sort-icon"></i>
                  </div>
                  <span class="resize-handle"></span>
                </th>
                <th class="excel-header actions-header">
                  <div class="header-content">
                    <i class="fas fa-cogs"></i> Actions
                  </div>
                </th></tr>        <tr class="filter-row">              <th class="filter-cell">
                  <input type="text" class="filter-input" placeholder="Filter Code..." id="filter_code" onkeyup="return filterRecords()">
                </th>
              <th class="filter-cell">
                  <input type="text" class="filter-input" placeholder="Filter Description..." id="filter_whse" onkeyup="return filterRecords()">
                </th><th class="filter-cell"></th></tr>      </thead>      <tbody id="recordsTableBody"></tbody>    </table>  </div></div></div></div>
      </div>
    </div>
  </div>
  
  <div class="notification-container" id="notificationContainer"></div>
  
  <script>
    var __schemaFields = [{"label":"Code","name":"code","type":"text","placeholder":"code"},{"label":"Description","name":"whse","type":"text","placeholder":"Description"}];
    var __displayFields = [{"label":"Code","name":"code","type":"text","placeholder":"code"},{"label":"Description","name":"whse","type":"text","placeholder":"Description"}];
    
// Notification system
 function initializeNotifications() {
  var c = document.getElementById("notificationContainer");
  if (!c) {
    c = document.createElement("div");
    c.className = "notification-container";
    c.id = "notificationContainer";
    document.body.appendChild(c);
  }
}

var loadingNotification = null;

function showSuccessNotification(title, message) {
  initializeNotifications();
  var container = document.getElementById("notificationContainer");
  var notification = document.createElement("div");
  notification.className = "notification";
  notification.innerHTML = '<div class="notification-icon"><i class="fas fa-check"></i></div><div class="notification-content"><div class="notification-title">' + (title || "Success") + '</div>' + (message ? '<div class="notification-message">' + message + '</div>' : '') + '</div>';
  container.appendChild(notification);
  setTimeout(function() { notification.classList.add("show", "bounce"); }, 100);
  setTimeout(function() {
    notification.classList.remove("show");
    notification.classList.add("hide");
    setTimeout(function() {
      if (notification.parentNode) {
        notification.parentNode.removeChild(notification);
      }
    }, 400);
  }, 4000);
}

// Error notification variant used across the app
function showErrorNotification(title, message) {
  try {
    initializeNotifications();
    var container = document.getElementById("notificationContainer");
    var notification = document.createElement("div");
    notification.className = "notification error";
    notification.innerHTML = '<div class="notification-icon"><i class="fas fa-exclamation-triangle"></i></div><div class="notification-content"><div class="notification-title">' + (title || "Error") + '</div>' + (message ? '<div class="notification-message">' + message + '</div>' : '') + '</div>';
    container.appendChild(notification);
    setTimeout(function() { notification.classList.add("show", "bounce"); }, 100);
    setTimeout(function() {
      notification.classList.remove("show");
      notification.classList.add("hide");
      setTimeout(function() {
        if (notification.parentNode) {
          notification.parentNode.removeChild(notification);
        }
      }, 400);
    }, 4000);
  } catch (e) { console.error('showErrorNotification error:', e); }
}

// --- OP_EDIT Users cache and resolver + remote XML fetch ---
var __OP_USERS_KEY = 'opUsers';

function _loadOpUsers() {
  try {
    var t = localStorage.getItem(__OP_USERS_KEY);
    var arr = t ? JSON.parse(t) : [];
    return Array.isArray(arr) ? arr : [];
  } catch (e) { console.error('_loadOpUsers error:', e); return []; }
}

function _saveOpUsers(list) {
  try { localStorage.setItem(__OP_USERS_KEY, JSON.stringify(list || [])); }
  catch (e) { console.error('_saveOpUsers error:', e); }
}

function _resolveUserName(initials) {
  try {
    var key = String(initials || '').trim().toUpperCase();
    if (!key) return '';
    var rec = (__ramOpUsers && __ramOpUsers[key]) || null;
    return rec && rec.name ? String(rec.name).trim() : '';
  } catch (e) { console.error('_resolveUserName error:', e); return ''; }
}
window._resolveUserName = _resolveUserName;

// Simple fetch cache to avoid thrashing the server
var __opFetchCache = { inflight: {}, last: {} };
window.__opFetchCache = __opFetchCache;

// In-memory users cache (server-sourced, no localStorage)
var __ramOpUsers = {};
window.__ramOpUsers = __ramOpUsers;

function __parseOpUsersXML(xmlText) {
  try {
    var parser = new DOMParser();
    var doc = parser.parseFromString(xmlText || '', 'application/xml');
    if (doc.getElementsByTagName('parsererror').length) {
      console.warn('__parseOpUsersXML: non-XML or invalid XML received');
      return [];
    }
    var users = [];
    var nodes = doc.getElementsByTagName('User');
    if (!nodes || !nodes.length) {
      try { nodes = doc.querySelectorAll('User, OP, Operator, Row, RECORD, Record, row, user'); } catch (_) {}
    }
    if (!nodes || !nodes.length) {
      // Try single-record payload
      if (doc && doc.documentElement) nodes = [doc.documentElement];
    }
    for (var i = 0; i < nodes.length; i++) {
      var n = nodes[i];
      var g = function(tag){ var el = n.getElementsByTagName(tag)[0]; return el ? (el.textContent || '').trim() : ''; };
      var ini = g('Initials') || g('INITIALS') || g('Ini') || g('INI');
      if (!ini) continue;
      var name = g('Name') || g('NAME');
      if (!name) {
        var fn = g('FirstName') || g('FIRSTNAME') || g('First_Name');
        var ln = g('LastName') || g('LASTNAME') || g('Last_Name');
        name = (fn + ' ' + ln).trim();
      }
      // Tratar 'Desconocido' o vacío como no-encontrado (no inventar nombre)
      if (/^desconocido$/i.test(name || '')) name = '';
      var activeTxt = g('Active') || g('ACTIVE');
      var active = /^(1|true|yes|y)$/i.test(activeTxt || '');
      users.push({ initials: String(ini).toUpperCase(), name: (name || '').trim(), active: active });
    }
    return users;
  } catch (e) { console.warn('__parseOpUsersXML error:', e); return []; }
 }

function __mergeOpUsers(fetched) {
  try {
    if (!Array.isArray(fetched) || !fetched.length) return _loadOpUsers();
    var cur = _loadOpUsers();
    for (var i = 0; i < fetched.length; i++) {
      var fu = fetched[i] || {};
      var ini = String(fu.initials || '').trim().toLowerCase();
      if (!ini) continue;
      var idx = -1;
      for (var j = 0; j < cur.length; j++) {
        var cu = cur[j] || {};
        if (String(cu.initials || '').trim().toLowerCase() === ini) { idx = j; break; }
      }
      if (idx >= 0) {
        // Update name/active if provided
        if (fu.name) cur[idx].name = fu.name;
        if (typeof fu.active === 'boolean') cur[idx].active = fu.active;
      } else {
        cur.push({ initials: fu.initials, name: fu.name || fu.initials, active: !!fu.active });
      }
    }
    _saveOpUsers(cur);
    return cur;
  } catch (e) { console.error('__mergeOpUsers error:', e); return _loadOpUsers(); }
}

// Server-only merge into in-memory cache
function __mergeOpUsersToRam(fetched) {
  try {
    if (!Array.isArray(fetched) || !fetched.length) return __ramOpUsers;
    for (var i = 0; i < fetched.length; i++) {
      var fu = fetched[i] || {};
      var key = String(fu.initials || '').trim().toUpperCase();
      if (!key) continue;
      // No forzar nombre a las iniciales: si no hay nombre, dejar vacío
      var name = (fu.name && String(fu.name).trim()) || '';
      var active = typeof fu.active === 'boolean' ? fu.active : true;
      __ramOpUsers[key] = { initials: key, name: name, active: active };
    }
    return __ramOpUsers;
  } catch (e) { console.error('__mergeOpUsersToRam error:', e); return __ramOpUsers; }
}

 function fetchOpUser(initials) {
  var ini = String(initials || '').trim();
  if (!ini) return Promise.resolve([]);
  var key = String(ini).toUpperCase();
  if (key.length !== 2) return Promise.resolve([]);
  // De-duplicate inflight requests
  if (__opFetchCache.inflight[key]) return __opFetchCache.inflight[key];

  var defaultBaseUrls = [
    'http://54.189.226.145/get_opdata.xml'
  ];
  var baseUrls = (window.GET_OP_BASE_URLS && Array.isArray(window.GET_OP_BASE_URLS) && window.GET_OP_BASE_URLS.length)
    ? window.GET_OP_BASE_URLS
    : defaultBaseUrls;
  var paramNames = ['INITIALS'];

  // Sin fallback local: siempre depender del servidor

  function attempt(baseIdx, paramIdx) {
    // Exhausted all base URLs - no local fallback
    if (baseIdx >= baseUrls.length) {
      return Promise.resolve([]); // soft-fail with empty list
    }
    var baseUrl = baseUrls[baseIdx];
    // Exhausted all param names for this base URL -> move to next base URL
    if (paramIdx >= paramNames.length) {
      return attempt(baseIdx + 1, 0);
    }
    var pname = paramNames[paramIdx];
    var url = baseUrl + '?' + pname + '=' + encodeURIComponent(key) + '&_=' + Date.now();
    try { console.debug('get_opdata.xml request:', url); } catch(_){ }
    return fetch(url, {
      method: 'GET',
      cache: 'no-store',
      headers: {
        'Accept': 'application/xml,text/xml;q=0.9,*/*;q=0.8',
        'Pragma': 'no-cache',
        'Cache-Control': 'no-store'
      }
    })
    .then(function(res){
      if (!res.ok) throw new Error('HTTP ' + res.status + ' (' + pname + ')');
      return res.text();
    })
    .then(function(txt){
      try { console.debug('get_opdata.xml raw [' + pname + ']:', (txt || '').slice(0, 200)); } catch(_){ }
      var list = __parseOpUsersXML(txt);
      __mergeOpUsersToRam(list);
      // Si la respuesta está vacía, probar siguiente parámetro
      if (!Array.isArray(list) || list.length === 0) {
        return attempt(baseIdx, paramIdx + 1);
      }
      // Tenemos algún resultado; devolverlo aunque no coincida exactamente
      return list;
    })
    .catch(function(err){
      console.warn('fetchOpUser attempt error:', (err && err.message) ? err.message : err);
      // Intentar siguiente parámetro; si se agotan, pasamos al siguiente base URL
      if (paramIdx + 1 < paramNames.length) {
        return attempt(baseIdx, paramIdx + 1);
      }
      return attempt(baseIdx + 1, 0);
    });
  }

  var p = attempt(0, 0)
    .finally(function(){ try { delete __opFetchCache.inflight[key]; } catch (_) {} });

  __opFetchCache.inflight[key] = p;
  return p;
  }
window.fetchOpUser = fetchOpUser;

  // Fetch all users using attempts similar to Price Edit (ALL selectors)
  function fetchAllOpUsers(){
    var attempts = (window.GET_OP_ALL_URLS && Array.isArray(window.GET_OP_ALL_URLS) && window.GET_OP_ALL_URLS.length)
      ? window.GET_OP_ALL_URLS
      : [
          'http://54.189.226.145/get_opdata.xml?ID=ALL',
          'http://54.189.226.145/get_opdata.xml?SELECT=ALL',
          'http://54.189.226.145/get_opdata.xml?INITIALS=ALL',
          'http://54.189.226.145/get_opdata.xml?INITIALS=*'
        ];
    function attempt(i){
      if (i >= attempts.length) return Promise.resolve([]);
      var url = attempts[i] + '&_=' + Date.now();
      try { console.debug('get_opdata.xml ALL request:', url); } catch(_){ }
      return fetch(url, {
        method: 'GET',
        cache: 'no-store',
        headers: {
          'Accept': 'application/xml,text/xml;q=0.9,*/*;q=0.8',
          'Pragma': 'no-cache',
          'Cache-Control': 'no-store'
        }
      })
      .then(function(res){ if (!res.ok) throw new Error('HTTP ' + res.status); return res.text(); })
      .then(function(txt){
        try { console.debug('get_opdata.xml ALL raw:', (txt||'').slice(0,200)); } catch(_){ }
        var list = __parseOpUsersXML(txt);
        if (Array.isArray(list) && list.length) {
          __mergeOpUsersToRam(list);
          return list;
        }
        return attempt(i+1);
      })
      .catch(function(err){ console.warn('fetchAllOpUsers attempt error:', err && err.message ? err.message : err); return attempt(i+1); });
    }
    return attempt(0);
  }
  window.fetchAllOpUsers = fetchAllOpUsers;

// Data management functions
function _storageKey() {
  return ("taimex_records_" + (document.title || "sistema").toLowerCase().replace(/[^a-zA-Z0-9]/g, "_")).slice(0, 120);
}

function _loadRecs() {
  try {
    var t = localStorage.getItem(_storageKey());
    return t ? JSON.parse(t) : [];
  } catch (e) {
    console.error(e);
    return [];
  }
}

function _saveRecs(list) {
  try {
    localStorage.setItem(_storageKey(), JSON.stringify(list));
  } catch (e) {
    console.error(e);
  }
}

function _collect() {
  var data = {};
  var c = document.querySelector("#tab-0 .form-grid");
  (__schemaFields || []).forEach(function(f) {
    var el = c && c.querySelector("[name='" + f.name + "']");
    data[f.name] = el ? el.value : "";
  });
  return data;
}

// Tab switching functionality
function switchTab(index) {
  console.log("switchTab called with index:", index);
  try {
    var buttons = document.querySelectorAll(".tab-button");
    var panes = document.querySelectorAll(".tab-pane");
    console.log("Found buttons:", buttons.length, "panes:", panes.length);
    for (var i = 0; i < buttons.length; i++) {
      buttons[i].classList.toggle("active", i === index);
    }
    for (var i = 0; i < panes.length; i++) {
      panes[i].classList.toggle("active", i === index);
    }
    try {
      // Ensure grid styles are available before any render
      ensureGridStyles();
      renderGrid("");
      updateSortUI();
      renderAuthGrid();
    } catch (e) {
      console.error("Error in switchTab rendering:", e);
    }
  } catch (e) {
    console.error("Error in switchTab:", e);
  }
  return false;
}
window.switchTab = switchTab;

// --- Added: keyboard handlers and modal helpers to avoid ReferenceErrors ---
function handleFormKeyDown(ev) {
  try {
    ev = ev || window.event;
    var key = ev.key || ev.code || '';
    if (key === 'Enter') {
      if (ev.preventDefault) ev.preventDefault();
      // Abrir el Authorization Helper + Modal con datos actuales del formulario
      try { openAuthForCurrentForm(); } catch (_) {}
      return false;
    }
    if (key === 'Escape') {
      if (ev.preventDefault) ev.preventDefault();
      try { handleClear(); } catch (_) {}
      return false;
    }
  } catch (e) { console.error('handleFormKeyDown error:', e); }
  return true;
}
window.handleFormKeyDown = handleFormKeyDown;

function openAuthForCurrentForm() {
  try {
    // 1) Leer valores del formulario
    var codeEl = document.getElementById('codeInput');
    var whseEl = document.getElementById('whseInput');
    var code = codeEl ? (codeEl.value || '').trim() : '';
    var whse = whseEl ? (whseEl.value || '').trim() : '';

    if (!code || !whse) {
      showErrorNotification('Required Fields', 'Please complete CODE and Description before continuing.');
      return false;
    }

    // Ensure helper exists and is placed right after form actions (like SALESMAN)
    ensureAuthContainer();

    // Show the helper
    var helperContainer = document.getElementById('authorizationHelperContainer');
    if (helperContainer) helperContainer.style.display = 'block';

    // Populate helper inputs (Code/WHSE) and focus Code
    var codeHelper = document.getElementById('authCodeInput');
    var whseHelper = document.getElementById('authWhseInput');
    if (codeHelper) codeHelper.value = code;
    if (whseHelper) whseHelper.value = whse;
    if (codeHelper) codeHelper.focus();

  } catch (e) {
    console.error('openAuthForCurrentForm error:', e);
  }
  return false;
}
window.openAuthForCurrentForm = openAuthForCurrentForm;

// (Removed legacy modal handlers: resolveUserName, handleAuthKeyDown, closeAuthModal, saveAuthorization)

// New Authorization Helper Functions (Price Ranges Style)

function closeAuthHelper() {
  try {
    var helperContainer = document.getElementById('authorizationHelperContainer');
    if (helperContainer) helperContainer.style.display = 'none';
  } catch (e) { console.error('closeAuthHelper error:', e); }
  return false;
}
window.closeAuthHelper = closeAuthHelper;

// Inject helper styles and container right after form actions (mirrors SALESMAN placement)
function ensureAuthStyles() {
  try {
    if (document.getElementById('authHelperStyles')) return;
    var css = ''+
      '.creation-section{margin:16px 0;padding:16px;background:linear-gradient(135deg,#eff6ff 0%,#dbeafe 100%);border:2px solid #3b82f6;border-radius:8px;width:100%;align-self:stretch}'+
      '.creation-header{margin:24px 0 16px 0;color:#1e293b;display:flex;align-items:center;gap:8px}'+
      '.creation-grid{display:grid;grid-template-columns:1fr 1fr auto;gap:16px;align-items:end}'+
      '.creation-grid .form-group{margin-bottom:0}'+
      '.creation-grid label{display:block;font-weight:600;color:#374151;margin-bottom:6px}'+
      '.creation-grid input{padding:8px 12px;border:2px solid #e5e7eb;border-radius:6px;transition:all .2s ease;background:rgba(255,255,255,.95)}'+
      '.creation-grid input:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.12)}'+
      '.creation-actions{margin-top:12px;text-align:right}'+
      '.creation-section .btn-primary{background:linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);border-color:#2563eb;color:#fff}'+
      '.creation-section .btn-primary:hover{background:linear-gradient(135deg,#2563eb 0%,#1e40af 100%);border-color:#1e40af}'+
      '.btn-sm{padding:8px 12px;font-size:.875rem;height:auto;border:none;border-radius:6px;cursor:pointer}'+
      '.auth-resolved-name{margin-top:8px;padding:8px 12px;border-radius:6px;font-size:13px;font-weight:500;background:#f8fafc;color:#1e293b;border:1px solid #e5e7eb}'+
      '.auth-resolved-name.success{background:#dbeafe;color:#1e40af;border:1px solid #bfdbfe}'+
      '@media (max-width:768px){.creation-grid{grid-template-columns:1fr;gap:12px}}';
    var style = document.createElement('style');
    style.id = 'authHelperStyles';
    style.type = 'text/css';
    style.appendChild(document.createTextNode(css));
    document.head.appendChild(style);
  } catch (e) { console.error('ensureAuthStyles error:', e); }
}

function ensureGridStyles() {
  try {
    var css = ''+
      '.excel-grid-container{flex:1;overflow-y:auto;overflow-x:hidden;border:1px solid #dee2e6;border-radius:0 0 12px 12px;background:white;position:relative;min-height:250px}'+
      '.excel-grid-premium{width:100%;border-collapse:collapse;font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;font-size:11px;background:white;min-width:1000px;border:1px solid #dee2e6}'+
      '.excel-header{background:linear-gradient(135deg,#2a5298 0%,#1e3c72 100%);color:white;padding:8px 12px;font-weight:600;text-align:left;border-right:1px solid #1e3c72;position:sticky;top:0;z-index:10;cursor:pointer;user-select:none;transition:all .2s ease;font-size:11px}'+
      '.excel-header:hover{background:linear-gradient(135deg,#1e3c72 0%,#2a5298 100%)}'+
      '.excel-header:last-child{border-right:none}'+
      '.excel-cell{padding:6px 10px;border-right:1px solid #dee2e6;border-bottom:1px solid #dee2e6;vertical-align:middle;position:relative;font-size:11px}'+
      '.excel-row{transition:all .2s ease;cursor:pointer}'+
      '.excel-row:nth-child(even){background:#f8f9fa}'+
      '.excel-row:hover{background:linear-gradient(135deg,#e3f2fd 0%,#f3e5f5 100%);transform:translateX(2px);box-shadow:0 2px 8px rgba(0,0,0,.1)}'+
      '.filter-row .filter-cell{background:#f8f9fa}'+
      '.filter-row .filter-input{background:white;border:1px solid #dee2e6;border-radius:6px;padding:6px 10px}';
    var style = document.getElementById('stocklocGridStyles');
    if (style) {
      while (style.firstChild) style.removeChild(style.firstChild);
      style.appendChild(document.createTextNode(css));
      return;
    }
    style = document.createElement('style');
    style.id = 'stocklocGridStyles';
    style.type = 'text/css';
    style.appendChild(document.createTextNode(css));
    document.head.appendChild(style);
  } catch (e) { console.error('ensureGridStyles error:', e); }
}

function ensureAuthContainer() {
  try {
    ensureAuthStyles();
    var c = document.getElementById('authorizationHelperContainer');
    if (!c) {
      c = document.createElement('div');
      c.id = 'authorizationHelperContainer';
    }
    c.className = 'creation-section';
    c.style.display = 'none';
    c.innerHTML = ''+
      '<h4 class="creation-header"><i class="fas fa-user-check"></i> Confirm Capture</h4>'+
      '<div class="creation-grid">'+
      '  <div class="form-group"><label for="authCodeInput">Code <span style="color:#ef4444;">*</span></label><input type="text" id="authCodeInput" maxlength="120" placeholder="Code" onkeydown="handleAuthInputKeyDown(event)" autocomplete="off"></div>'+
      '  <div class="form-group"><label for="authWhseInput">Description <span style="color:#ef4444;">*</span></label><input type="text" id="authWhseInput" maxlength="120" placeholder="Description" onkeydown="handleAuthInputKeyDown(event)" autocomplete="off"></div>'+
      '  <div class="form-group" style="align-self:end"><button type="button" class="btn btn-primary btn-sm" onclick="confirmAuthorization()"><i class="fas fa-check"></i> Save</button></div>'+
      '</div>'+
      '<div class="creation-actions"><button type="button" class="btn btn-secondary btn-sm" onclick="closeAuthHelper()"><i class="fas fa-times"></i> Cancel</button></div>'+
      '';
    var actions = document.querySelector('#tab-0 .form-container .form-actions');
    if (actions && actions.parentNode) {
      if (c.parentNode !== actions.parentNode || c.previousSibling !== actions) {
        actions.parentNode.insertBefore(c, actions.nextSibling);
      }
    } else {
      var fc = document.querySelector('#tab-0 .form-container');
      if (fc && c.parentNode !== fc) fc.appendChild(c);
    }
  } catch (e) { console.error('ensureAuthContainer error:', e); }
}

function resolveAuthUserName(initials) {
  try {
    var resolvedDiv = document.getElementById('authResolvedName');
    var nameInput = document.getElementById('authDisplayName');
    var initialsInput = document.getElementById('authInitialsInput');

    // Normalizar a MAYÚSCULAS mientras escribe
    if (initialsInput && typeof initials === 'string') {
      initialsInput.value = initials.toUpperCase();
      initials = initialsInput.value;
    }
    if (!initials || initials.trim() === '') {
      if (resolvedDiv) resolvedDiv.style.display = 'none';
      if (nameInput) nameInput.value = '';
      return '';
    }

    var val = String(initials).trim().toUpperCase();
    // Requerir exactamente 2 iniciales antes de consultar servidor
    if (val.length < 2) {
      if (resolvedDiv) resolvedDiv.style.display = 'none';
      if (nameInput) nameInput.value = '';
      return '';
    }
    if (val.length > 2) {
      if (resolvedDiv) {
        resolvedDiv.textContent = 'Enter exactly 2 initials';
        resolvedDiv.className = 'auth-resolved-name';
        resolvedDiv.style.display = 'block';
      }
      if (nameInput) nameInput.value = '';
      return '';
    }

    var userName = _resolveUserName(val);
    if (resolvedDiv) {
      if (userName) {
        resolvedDiv.textContent = '✓ ' + userName;
        resolvedDiv.className = 'auth-resolved-name success';
        resolvedDiv.style.display = 'block';
        if (nameInput) nameInput.value = userName;
      } else {
        // Try server if not found locally
        resolvedDiv.textContent = 'Searching on server...';
        resolvedDiv.className = 'auth-resolved-name';
        resolvedDiv.style.display = 'block';

        var key = val;
        fetchOpUser(val).then(function(){
          __opFetchCache.last[key] = Date.now();
          var nm = _resolveUserName(val);
          try {
            if (resolvedDiv) {
              if (nm) { resolvedDiv.textContent = '✓ ' + nm; resolvedDiv.className = 'auth-resolved-name success'; }
              else { resolvedDiv.textContent = 'User not found'; resolvedDiv.className = 'auth-resolved-name'; }
              resolvedDiv.style.display = 'block';
            }
            if (nm && nameInput) nameInput.value = nm;
          } catch(_){}
        }).catch(function(){
          try {
            if (resolvedDiv) { resolvedDiv.textContent = 'Could not contact server'; resolvedDiv.className = 'auth-resolved-name'; resolvedDiv.style.display = 'block'; }
          } catch(_){}
        });
      }
    }
    if (nameInput) {
      nameInput.value = userName || '';
    }
    return userName || '';
  } catch (e) { 
    console.error('resolveAuthUserName error:', e); 
    return '';
  }
}
window.resolveAuthUserName = resolveAuthUserName;

function handleAuthInputKeyDown(ev) {
  try {
    ev = ev || window.event;
    var key = ev.key || ev.code || '';
    if (key === 'Enter') {
      if (ev.preventDefault) ev.preventDefault();
      try { confirmAuthorization(); } catch (_) {}
      return false;
    }
    if (key === 'Escape') {
      if (ev.preventDefault) ev.preventDefault();
      try { closeAuthHelper(); } catch (_) {}
      return false;
    }
  } catch (e) { console.error('handleAuthInputKeyDown error:', e); }
  return true;
}
window.handleAuthInputKeyDown = handleAuthInputKeyDown;

function confirmAuthorization() {
  try {
    // Prefer values from helper inputs; fallback to main form
    var codeHelper = document.getElementById('authCodeInput');
    var whseHelper = document.getElementById('authWhseInput');
    var codeInputEl = document.getElementById('codeInput');
    var whseInputEl = document.getElementById('whseInput');

    var code = codeHelper && codeHelper.value ? String(codeHelper.value).trim() : (codeInputEl ? String(codeInputEl.value || '').trim() : '');
    var whse = whseHelper && whseHelper.value ? String(whseHelper.value).trim() : (whseInputEl ? String(whseInputEl.value || '').trim() : '');

    if (!code || !whse) {
      try { showErrorNotification('Required Fields', 'CODE and Description are required to continue'); } catch(_){ }
      if (!code && codeHelper) codeHelper.focus();
      else if (!whse && whseHelper) whseHelper.focus();
      return false;
    }

    // Persist record (allowing duplicate after explicit confirmation)
    var mainRecords = _loadRecs();
    mainRecords.push({ code: code, whse: whse });
    _saveRecs(mainRecords);

    try { renderGrid(''); } catch(_) {}
    try { showSuccessNotification('Saved', 'Record saved'); } catch(_){ }

    // Sync helper values back to main form, then clear and close
    if (codeInputEl) codeInputEl.value = '';
    if (whseInputEl) whseInputEl.value = '';
    closeAuthHelper();
    setTimeout(function(){ if (codeInputEl) codeInputEl.focus(); }, 300);

  } catch (e) { console.error('confirmAuthorization error:', e); }
  return false;
}
window.confirmAuthorization = confirmAuthorization;
// --- End added block ---
// Form handlers
function handleClear() {
  document.querySelectorAll(".form-container input, .form-container textarea, .form-grid input, .form-grid textarea").forEach(function(el) {
    if (el.type !== "hidden" && el.type !== "button" && el.type !== "submit") {
      el.value = "";
    }
  });
  document.querySelectorAll(".form-container select, .form-grid select").forEach(function(el) {
    el.selectedIndex = 0;
  });
  return false;
}

function handleSave() {
  try {
    var recs = _loadRecs();
    var rec = _collect();

    // Require both Code and WHSE
    var codeVal = String(rec.code || '').trim();
    var whseVal = String(rec.whse || '').trim();
    if (!codeVal || !whseVal) {
      try { showErrorNotification('Required Fields', 'CODE and Description are required to create the record'); } catch(_){ }
      try {
        var codeEl = document.getElementById('codeInput');
        var whseEl = document.getElementById('whseInput');
        if (!codeVal && codeEl) codeEl.focus();
        else if (!whseVal && whseEl) whseEl.focus();
      } catch(_){ }
      return false;
    }

    // Check for duplicate Code + WHSE and require authorization instead
    var isDup = false;
    try {
      var rc = String(rec.code || '').trim().toLowerCase();
      var rd = String(rec.whse || '').trim().toLowerCase();
      for (var i = 0; i < recs.length; i++) {
        var r = recs[i] || {};
        var rcode = String(r.code || '').trim().toLowerCase();
        var rwhse = String(r.whse || '').trim().toLowerCase();
        if (rcode === rc && rwhse === rd) { isDup = true; break; }
      }
    } catch(_){ }

    if (isDup) {
      try { showErrorNotification('Duplicate', 'A record with the same CODE and Description already exists. Authorization is required.'); } catch(_){ }
      try { openAuthForCurrentForm(); } catch(_){ }
      return false;
    }

    recs.push(rec);
    _saveRecs(recs);
    showSuccessNotification("Saved", "Data saved");
  } catch (e) {
    console.error(e);
  }
  try {
    renderGrid("");
  } catch (e) {}
  return false;
}

// Grid and sorting functionality
var __sortIndex = -1, __sortDir = "asc";
var __lastRenderedRows = [];

function renderGrid(filter) {
  try {
    // Make sure the grid CSS is present
    ensureGridStyles();
    var tbody = document.getElementById('recordsTableBody');
    if (!tbody) return false;

    var recs = _loadRecs() || [];

    // Read filters
    var q = typeof filter === 'string' ? filter.trim().toLowerCase() : '';
    var fc = '';
    var fw = '';
    try { fc = (document.getElementById('filter_code') || {}).value || ''; } catch(_){ }
    try { fw = (document.getElementById('filter_whse') || {}).value || ''; } catch(_){ }
    fc = fc.trim().toLowerCase();
    fw = fw.trim().toLowerCase();

    // Apply filters
    var rows = [];
    for (var i = 0; i < recs.length; i++) {
      var r = recs[i] || {};
      var code = String(r.code == null ? '' : r.code);
      var whse = String(r.whse == null ? '' : r.whse);
      var authBy = String(r.authorizedBy == null ? '' : r.authorizedBy);
      var authUser = String(r.authorizedUser == null ? '' : r.authorizedUser);

      if (q) {
        var t = (code + ' ' + whse + ' ' + authBy + ' ' + authUser).toLowerCase();
        if (t.indexOf(q) === -1) continue;
      }
      if (fc && code.toLowerCase().indexOf(fc) === -1) continue;
      if (fw && whse.toLowerCase().indexOf(fw) === -1) continue;

      rows.push({ index: i, code: code, whse: whse, authUser: authUser, authBy: authBy });
    }

    // Render
    if (!rows.length) {
      tbody.innerHTML = "<tr class='excel-row'><td class='excel-cell' colspan='100%'>No records</td></tr>";
    } else {
      var html = '';
      for (var k = 0; k < rows.length; k++) {
        var row = rows[k];
        html += "<tr class='excel-row'>" +
                "<td class='excel-cell'><div class='cell-content'><i class='fas fa-tag' style='opacity:.6'></i> " + escapeHtml(row.code) + "</div></td>" +
                "<td class='excel-cell'><div class='cell-content'><i class='fas fa-warehouse' style='opacity:.6'></i> " + escapeHtml(row.whse) + (row.authUser ? "<div style='margin-top:4px; font-size:12px; color:#4b5563;'><i class='fas fa-user-check' style='opacity:.7'></i> " + escapeHtml(row.authUser) + "</div>" : "") + "</div></td>" +
                "<td class='excel-cell'><div class='action-buttons'>" +
                  "<button class='btn-sm btn-edit' onclick='return editRecord(" + row.index + ")'><i class='fas fa-edit'></i></button>" +
                  "<button class='btn-sm btn-delete' onclick='return deleteRecord(" + row.index + ")'><i class='fas fa-trash'></i></button>" +
                "</div></td>" +
              "</tr>";
      }
      tbody.innerHTML = html;
    }

    // Update results count
    try {
      var rc = document.getElementById('recordsCount');
      if (rc) rc.textContent = rows.length + ' records shown';
    } catch(_){}

  } catch (e) {
    console.error('renderGrid error:', e);
  }
  return false;
}

function updateSortUI() {
// Simplified sort UI update
return true;
}

// Grid toolbar stubs and utilities
function handleSearch(q) {
try {
console.log('handleSearch:', q);
renderGrid(q || '');
} catch (e) { console.error('handleSearch error:', e); }
return false;
}
function clearFilters() {
try {
var inputs = document.querySelectorAll('.filter-input');
for (var i = 0; i < inputs.length; i++) inputs[i].value = '';
renderGrid('');
try { renderAuthGrid(); } catch (_) {}
} catch (e) { console.error('clearFilters error:', e); }
return false;
}
function filterRecords() {
  try {
    return renderGrid((document.getElementById('searchInput') || {}).value || '');
  } catch (e) { console.error('filterRecords error:', e); }
  return false;
}

function editRecord(index) {
  try {
    var recs = _loadRecs();
    var r = recs[index];
    if (!r) return false;
    // Fill form in Data Capture
    var codeEl = document.getElementById('codeInput');
    var whseEl = document.getElementById('whseInput');
    if (codeEl) codeEl.value = r.code || '';
    if (whseEl) whseEl.value = r.whse || '';
    // Switch to Data Capture tab (index 0)
    try { switchTab(0); } catch(_){}
    showSuccessNotification('Record Loaded', 'Editing record ' + (r.code || ''));
  } catch (e) { console.error('editRecord error:', e); }
  return false;
}

function deleteRecord(index) {
  try {
    var recs = _loadRecs();
    if (index < 0 || index >= recs.length) return false;
    recs.splice(index, 1);
    _saveRecs(recs);
    renderGrid('');
    showSuccessNotification('Deleted', 'Record removed');
  } catch (e) { console.error('deleteRecord error:', e); }
  return false;
}

function escapeHtml(s) {
  try {
    s = String(s == null ? '' : s);
    return s.replace(/[&<>"']/g, function(ch){
      switch(ch){
        case '&': return '&amp;';
        case '<': return '&lt;';
        case '>': return '&gt;';
        case '"': return '&quot;';
        case "'": return '&#39;';
        default: return ch;
      }
    });
  } catch(_) { return String(s || ''); }
}
function exportToCSV() {
try {
var recs = _loadRecs();
if (!recs || !recs.length) {
showSuccessNotification('Export', 'No data to export');
return false;
}
var cols = Object.keys(recs[0] || {});
var lines = [cols.join(',')];
for (var i = 0; i < recs.length; i++) {
var row = [];
for (var j = 0; j < cols.length; j++) {
var v = recs[i][cols[j]];
v = v == null ? '' : String(v);
v = v.replace(/\"/g, '""');
if (/[",\n]/.test(v)) v = '"' + v + '"';
row.push(v);
}
lines.push(row.join(','));
}
var csv = lines.join('\n');
var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
var url = URL.createObjectURL(blob);
var a = document.createElement('a');
a.href = url;
a.download = 'export.csv';
document.body.appendChild(a);
a.click();
setTimeout(function(){ URL.revokeObjectURL(url); if (a.parentNode) a.parentNode.removeChild(a); }, 0);
showSuccessNotification('Export', 'CSV downloaded');
} catch (e) { console.error('exportToCSV error:', e); }
return false;
}
function loadAllRecordsFromPicLan() {
try {
  var baseUrls = (window.GET_STOCKS_URLS && Array.isArray(window.GET_STOCKS_URLS) && window.GET_STOCKS_URLS.length)
    ? window.GET_STOCKS_URLS
    : ['http://54.189.226.145/get_stocks.xml'];
  function attempt(i){
    if (i >= baseUrls.length) { try { showErrorNotification('Load', 'Could not load from server'); } catch(_){} return false; }
    var url = baseUrls[i] + '?_=' + Date.now();
    return fetch(url, {
      method: 'GET',
      cache: 'no-store',
      headers: { 'Accept': 'application/xml,text/xml;q=0.9,*/*;q=0.8' }
    })
    .then(function(res){ if (!res.ok) throw new Error('HTTP ' + res.status); return res.text(); })
    .then(function(txt){
      var parser = new DOMParser();
      var doc = parser.parseFromString(txt || '', 'application/xml');
      var nodes = doc.getElementsByTagName('Stock');
      if (!nodes || !nodes.length) { try { nodes = doc.querySelectorAll('Stock, STOCK, row, Row, RECORD, Record'); } catch(_){} }
      var list = [];
      for (var j = 0; j < nodes.length; j++) {
        var n = nodes[j];
        var g = function(tag){ var el = n.getElementsByTagName(tag)[0]; return el ? (el.textContent || '').trim() : ''; };
        var code = g('Code') || g('CODE');
        var whse = g('WHSE') || g('Whse') || g('WHSE_CODE') || g('Description') || g('DESCRIPTION');
        if (!code || !whse) continue;
        list.push({
          code: code,
          whse: whse,
          authorizedBy: g('AuthorizedBy') || g('AUTHORIZEDBY') || g('INITIALS') || '',
          authorizedUser: g('AuthorizedUser') || g('AUTHORIZEDUSER') || g('NAME') || '',
          authorizedDate: g('AuthorizedDate') || g('AUTHORIZEDDATE') || g('DATE') || '',
          authorizedTime: g('AuthorizedTime') || g('AUTHORIZEDTIME') || g('TIME') || '',
          status: (g('Status') || g('STATUS') || 'IN').toUpperCase()
        });
      }
      var recs = _loadRecs();
      for (var k = 0; k < list.length; k++) {
        var it = list[k];
        var idx = -1;
        try {
          var lcCode = String(it.code || '').trim().toLowerCase();
          var lcWhse = String(it.whse || '').trim().toLowerCase();
          for (var m = 0; m < recs.length; m++) {
            var rr = recs[m] || {};
            var rcode = String(rr.code || '').trim().toLowerCase();
            var rwhse = String(rr.whse || '').trim().toLowerCase();
            if (rcode === lcCode && rwhse === lcWhse) { idx = m; break; }
          }
        } catch(_){ }
        if (idx >= 0) {
          var ex = recs[idx] || {};
          ex.authorizedBy = it.authorizedBy || ex.authorizedBy || '';
          ex.authorizedUser = it.authorizedUser || ex.authorizedUser || '';
          ex.authorizedDate = it.authorizedDate || ex.authorizedDate || '';
          ex.authorizedTime = it.authorizedTime || ex.authorizedTime || '';
          ex.status = it.status || ex.status || 'IN';
          recs[idx] = ex;
        } else {
          recs.push(it);
        }
      }
      _saveRecs(recs);
      try { renderGrid(''); } catch(_){}
      try { showSuccessNotification('Load', 'Cargados ' + list.length + ' registros'); } catch(_){}
      return true;
    })
    .catch(function(err){
      console.warn('loadAllRecordsFromPicLan error:', err && err.message ? err.message : err);
      return attempt(i + 1);
    });
  }
  return attempt(0);
} catch (e) { console.error('loadAllRecordsFromPicLan error:', e); }
return false;
}

function pushStockUpdate(opts) {
  try {
    opts = opts || {};
    var code = String(opts.code || '').trim();
    var whse = String(opts.whse || '').trim();
    if (!code || !whse) return Promise.resolve(false);
    var initials = String(opts.initials || '').trim().toUpperCase();
    var name = String(opts.name || '').trim();
    var status = String(opts.status || 'IN').trim().toUpperCase();
    var date = String(opts.date || new Date().toISOString().split('T')[0]);
    var time = String(opts.time || new Date().toLocaleTimeString());
    var baseUrls = (window.UPDATE_STOCKS_URLS && Array.isArray(window.UPDATE_STOCKS_URLS) && window.UPDATE_STOCKS_URLS.length)
      ? window.UPDATE_STOCKS_URLS
      : ['http://54.189.226.145/update_stocks.xml'];
    var qs = 'CODE=' + encodeURIComponent(code)
      + '&DESCRIPTION=' + encodeURIComponent(whse)
      + '&INITIALS=' + encodeURIComponent(initials)
      + '&NAME=' + encodeURIComponent(name)
      + '&STATUS=' + encodeURIComponent(status)
      + '&DATE=' + encodeURIComponent(date)
      + '&TIME=' + encodeURIComponent(time)
      + '&_=' + Date.now();
    function attempt(i){
      if (i >= baseUrls.length) return Promise.resolve(false);
      var url = baseUrls[i] + '?' + qs;
      return fetch(url, {
        method: 'GET',
        cache: 'no-store',
        headers: { 'Accept': 'application/xml,text/xml;q=0.9,*/*;q=0.8' }
      })
      .then(function(res){ if (!res.ok) throw new Error('HTTP ' + res.status); return res.text(); })
      .then(function(txt){ try { console.debug('update_stocks.xml response:', (txt || '').slice(0, 200)); } catch(_){ } return true; })
      .catch(function(_){ return attempt(i + 1); });
    }
    return attempt(0);
  } catch (e) { console.warn('pushStockUpdate error:', e); return Promise.resolve(false); }
}
window.pushStockUpdate = pushStockUpdate;

function manualCleanupLocalStorage() {
  try {
  var keys = [_storageKey(), 'authRules', 'taimex_auth_rules'];
  for (var i = 0; i < keys.length; i++) {
    try { localStorage.removeItem(keys[i]); } catch (_) {}
  }
  showSuccessNotification('Cache Cleared', 'Local storage cleared');
  try { renderGrid(''); } catch (_) {}
  try { renderAuthGrid(); } catch (_) {}
  } catch (e) { console.error('manualCleanupLocalStorage error:', e); }
  return false;
}

// Authorization Rules Module (localStorage-based, wildcard support). Canonical key: 'authRules'
var __AUTH_STORAGE_KEY = 'authRules';

function _loadAuth() {
try {
var t = localStorage.getItem(__AUTH_STORAGE_KEY);
if (!t) { t = localStorage.getItem('taimex_auth_rules'); }
var arr = t ? JSON.parse(t) : [];
return Array.isArray(arr) ? arr : [];
} catch (e) {
console.error('loadAuth error:', e);
return [];
}
}

function _saveAuth(list) {
try {
localStorage.setItem(__AUTH_STORAGE_KEY, JSON.stringify(list || []));
} catch (e) {
}
} // <--- Added the missing closing brace here

function patternToRegExp(pattern) {
  var p = String(pattern == null ? '' : pattern);
  if (p === '*') return /^.*$/i;
  // ... (rest of the code remains the same)
// Escape regex metacharacters using string replacement to avoid character class issues
var esc = function (s) {
s = String(s == null ? '' : s);
var out = '';
for (var i = 0; i < s.length; i++) {
var ch = s.charAt(i);
switch (ch) {
case '\\': out += '\\\\'; break; // backslash
case '.': out += '\\.'; break;
case '*': out += '\\*'; break;
case '+': out += '\\+'; break;
case '?': out += '\\?'; break;
case '^': out += '\\^'; break;
case '$': out += '\\$'; break;
case '{': out += '\\{'; break;
case '}': out += '\\}'; break;
case '(': out += '\\('; break;
case ')': out += '\\)'; break;
case '|': out += '\\|'; break;
case '[': out += '\\['; break;
case ']': out += '\\]'; break;
default: out += ch;
}
}
return out;
};
var re = '^' + p.split('*').map(esc).join('.*') + '$';
try { return new RegExp(re, 'i'); } catch (_) { return new RegExp('^' + esc(p) + '$', 'i'); }
}

function _match(pattern, value) {
var v = String(value == null ? '' : value);
var p = String(pattern == null ? '' : pattern);
if (!p) return false;
return patternToRegExp(p).test(v);
}

function checkAuth(initials, txn, src, action) {
try {
var list = _loadAuth();
var ini = String(initials || '').trim().toLowerCase();
var act = String(action || 'EDIT').toUpperCase();
for (var i = 0; i < list.length; i++) {
var r = list[i] || {};
if (!r.active) continue;
var okIni = (String(r.initials || '').trim().toLowerCase() === ini) || (r.initials === '*');
var okTxn = _match(r.txn || '', txn || '');
var okSrc = _match(r.src || '', src || '');
// For now we only support EDIT; treat any other action as EDIT
var okPerm = (String(r.permission || 'EDIT').toUpperCase() === 'EDIT');
if (okIni && okTxn && okSrc && okPerm) return true;
}
return false;
} catch (e) {
console.error('checkAuth error:', e);
return false;
}
}
window.checkAuth = checkAuth;

function renderAuthGrid() {
console.log('=== renderAuthGrid called ===');
try {
var tbody = document.getElementById('authTableBody');
console.log('authTableBody element found:', !!tbody);

if (!tbody) {
console.error('authTableBody element not found!');
// Try to find any table body in the current tab
var allTbodies = document.querySelectorAll('tbody');
console.log('All tbody elements found:', allTbodies.length);
for (var j = 0; j < allTbodies.length; j++) {
console.log('tbody[' + j + '] id:', allTbodies[j].id);
}
return false;
}

var list = _loadAuth();
console.log('Auth list to render:', list);

var fi = document.getElementById('auth_filter_initials');
var ft = document.getElementById('auth_filter_txn');
var fs = document.getElementById('auth_filter_src');
var fiVal = (fi && fi.value || '').toLowerCase();
var ftVal = (ft && ft.value || '').toLowerCase();
var fsVal = (fs && fs.value || '').toLowerCase();

console.log('Filter values:', { fiVal, ftVal, fsVal });

var html = '';
var renderedCount = 0;

for (var i = 0; i < list.length; i++) {
var r = list[i] || {};
if (fiVal && String(r.initials || '').toLowerCase().indexOf(fiVal) === -1) continue;
if (ftVal && String(r.txn || '').toLowerCase().indexOf(ftVal) === -1) continue;
if (fsVal && String(r.src || '').toLowerCase().indexOf(fsVal) === -1) continue;

renderedCount++;
html += '\n          <tr class="excel-row">'
+ '\n            <td class="excel-cell"><input type="text" value="' + (r.initials || '') + '" oninput="return updateAuthField(' + i + ',&#39;initials&#39;, this.value)" placeholder="EC"></td>'
+ '\n            <td class="excel-cell readonly"><div class="cell-content"><i class="fas fa-user"></i> ' + (r.name || '') + '</div></td>'
+ '\n            <td class="excel-cell"><input type="text" value="' + (r.txn || '') + '" oninput="return updateAuthField(' + i + ',&#39;txn&#39;, this.value)" placeholder="SA"></td>'
+ '\n            <td class="excel-cell"><input type="text" value="' + (r.src || '') + '" oninput="return updateAuthField(' + i + ',&#39;src&#39;, this.value)" placeholder="PRICE_EDIT3.HTM or /prices/*"></td>'
+ '\n            <td class="excel-cell readonly"><div class="cell-content"><i class="fas fa-key"></i> EDIT</div></td>'
+ '\n            <td class="excel-cell"><input type="checkbox" ' + (r.active ? 'checked' : '') + ' onchange="return updateAuthField(' + i + ',&#39;active&#39;, this.checked)"></td>'
+ '\n            <td class="excel-cell action-buttons"><button type="button" class="btn-sm btn-delete" onclick="return deleteAuthRule(' + i + ')"><i class="fas fa-trash"></i></button></td>'
+ '\n          </tr>';
}

console.log('Rendered rows count:', renderedCount);

if (html) {
tbody.innerHTML = html;
console.log('Grid updated with', renderedCount, 'rows');
} else {
tbody.innerHTML = "<tr><td class='excel-cell' colspan='7' style='text-align:center;color:#64748b;padding:12px;'>No authorization rules</td></tr>";
console.log('Grid updated with empty message');
}
} catch (e) {
console.error('renderAuthGrid error:', e);
}
return false;
}

function filterAuthRules() { return renderAuthGrid(); }

// Sorting for Authorization grid when rendered via generic grid headers
function sortAuthTable(index) {
try {
var cols = ['initials','name','txn','src','permission','active'];
if (typeof index !== 'number' || index < 0 || index >= cols.length) return false;
var list = _loadAuth();
if (!Array.isArray(list)) list = [];
if (typeof window.__authSortIndex === 'undefined') window.__authSortIndex = -1;
if (typeof window.__authSortDir === 'undefined') window.__authSortDir = 'asc';
if (window.__authSortIndex === index) {
window.__authSortDir = (window.__authSortDir === 'asc' ? 'desc' : 'asc');
} else {
window.__authSortIndex = index;
window.__authSortDir = 'asc';
}
var dir = window.__authSortDir;
list.sort(function(a, b) {
var key = cols[index];
var av = a && a[key], bv = b && b[key];
if (key === 'active') { av = !!av ? 1 : 0; bv = !!bv ? 1 : 0; }
av = (av == null) ? '' : av;
bv = (bv == null) ? '' : bv;
if (typeof av === 'string') av = av.toLowerCase();
if (typeof bv === 'string') bv = bv.toLowerCase();
if (av < bv) return dir === 'asc' ? -1 : 1;
if (av > bv) return dir === 'asc' ? 1 : -1;
return 0;
});
_saveAuth(list);
renderAuthGrid();
} catch (e) { console.error('sortAuthTable error:', e); }
return false;
}

// Generic grid stubs to avoid runtime errors in preview mode
function sortTable(index) {
try { console.log('sortTable (preview stub) called with index:', index); renderGrid(''); }
catch (e) { console.error('sortTable error:', e); }
return false;
}
function filterRecords() {
try { renderGrid(''); }
catch (e) { console.error('filterRecords error:', e); }
return false;
}

function addAuthRule() {
var list = _loadAuth();
list.push({ initials: '', name: '', txn: '', src: '', permission: 'EDIT', active: true, createdAt: new Date().toISOString() });
_saveAuth(list);
renderAuthGrid();
return false;
}

function deleteAuthRule(i) {
var list = _loadAuth();
if (i >= 0 && i < list.length) {
list.splice(i, 1);
_saveAuth(list);
renderAuthGrid();
}
return false;
}

function updateAuthField(i, field, value) {
var list = _loadAuth();
if (i < 0 || i >= list.length) return false;
if (field === 'active') list[i].active = !!value; else list[i][field] = value;
if (field === 'initials') list[i].name = _resolveUserName(value);
_saveAuth(list);
renderAuthGrid();
return false;
}

function addTxnAuthFromHelper() {
console.log('=== addTxnAuthFromHelper called ===');
try {
var initialsEl = document.getElementById('txn_auth_initials');
var nameEl = document.getElementById('txn_auth_name');
var txnEl = document.getElementById('txn_auth_txn');

console.log('Elements found:', {
initialsEl: !!initialsEl,
nameEl: !!nameEl,
txnEl: !!txnEl
});

if (!initialsEl || !txnEl) {
console.error('Required form elements not found!');
alert('Error: Form elements not found. Make sure you are on the correct tab.');
return false;
}

var ini = (initialsEl && initialsEl.value || '').trim();
var txn = (txnEl && txnEl.value || '').trim();

console.log('Form values:', { ini, txn });

if (!ini || !txn) {
console.log('Missing required data');
alert('Please fill in both Initials and Transaction fields');
try { if (typeof showErrorNotification === 'function') showErrorNotification('Missing data', 'Initials and Transaction are required'); } catch(_){ }
return false;
}

var nm = _resolveUserName(ini) || (nameEl && nameEl.value) || '';
console.log('Resolved name:', nm);

var list = _loadAuth();
console.log('Current auth list:', list);

var newEntry = { initials: ini, name: nm, txn: txn, src: '*', permission: 'EDIT', active: true, createdAt: new Date().toISOString() };
console.log('Adding new entry:', newEntry);

list.push(newEntry);
_saveAuth(list);

console.log('Saved auth list:', _loadAuth());

try {
renderAuthGrid();
console.log('Auth grid rendered');
} catch(err){
console.error('Error rendering auth grid:', err);
}

if (txnEl) txnEl.value = '';

alert('User added successfully: ' + ini + ' - ' + nm);
try { if (typeof showSuccessNotification === 'function') showSuccessNotification('Added', 'Authorization added for ' + ini); } catch(_){ }
} catch (e) {
console.error('addTxnAuthFromHelper error:', e);
alert('Error adding user: ' + e.message);
}
return false;
}

function txna_onInitialsChange(v) {
try {
var nm = _resolveUserName(v);
var nameEl = document.getElementById('txn_auth_name');
if (nameEl) nameEl.value = nm || '';
} catch (e) { console.error('txna_onInitialsChange error:', e); }
return false;
}

function toggleSidebar() {
try {
var sb = document.getElementById("sidebar");
var ov = document.querySelector(".sidebar-overlay");
if (!sb || !ov) return;
var act = sb.classList.toggle("active");
ov.classList.toggle("active", act);
} catch (e) {
console.error("toggleSidebar error", e);
}
}

// Event listeners
document.addEventListener("click", function(ev) {
  try {
    var btn = ev.target.closest && ev.target.closest(".tab-button");
    if (btn) {
      console.log("Tab button clicked:", btn);
      var list = document.querySelectorAll(".tab-button");
      var idx = Array.prototype.indexOf.call(list, btn);
      console.log("Tab index:", idx, "switchTab function exists:", typeof window.switchTab === "function");
      if (typeof window.switchTab === "function") {
        window.switchTab(idx);
      } else {
        console.error("switchTab function not found on window object");
      }
      ev.preventDefault();
      return false;
    }
    
    // Sidebar menu links: set active state and close sidebar
    var menuLink = ev.target.closest && ev.target.closest(".sidebar-menu a");
    if (menuLink) {
      var links = document.querySelectorAll(".sidebar-menu a");
      for (var k = 0; k < links.length; k++) {
        links[k].classList.remove("active");
      }
      menuLink.classList.add("active");
      try { toggleSidebar(); } catch (e2) { /* noop */ }
      ev.preventDefault();
      return false;
    }
    
    // Hamburger menu toggle
    var hamburger = ev.target.closest && ev.target.closest(".hamburger-menu");
    if (hamburger) {
      try { toggleSidebar(); } catch (e3) { /* noop */ }
      ev.preventDefault();
      return false;
    }
  } catch (e) {
    console.error("Event listener error:", e);
  }
});

  </script>
  

</body>
 </html>