
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>TAIMEX - Vendor Pricing System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* Base Styles - Exact from CUSTSEARCHSO_EDIT.HTML */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        html, body { height: 100vh; overflow: hidden; }
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            background-attachment: fixed;
            color: #334155;
        }

        .container {
            width: 100vw; height: 100vh; background: #ffffff;
            display: flex; flex-direction: column; overflow: hidden;
        }

        /* Header - Exact CUSTSEARCHSO Style */
        .header {
            background: linear-gradient(135deg, #1e293b 0%, #1e3a8a 100%);
            color: #ffffff;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            box-shadow: 0 2px 8px rgba(30, 41, 59, 0.25);
            flex-shrink: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
            position: relative;
            z-index: 1;
        }
        .hamburger-menu {
            background: none;
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s ease;
        }
        .hamburger-menu:hover { background-color: rgba(255, 255, 255, 0.1); }

        .header .logo-section {
            position: relative;
            z-index: 1;
        }

        .header .logo-section img {
            height: 40px;
            width: auto;
            object-fit: contain;
            filter: brightness(1.1);
        }

        .header .logo-section h1 {
            font-family: 'Poppins', sans-serif;
            font-size: 1.8em;
            margin: 0;
            font-weight: 700;
            letter-spacing: -0.5px;
            color: white;
            position: relative;
            z-index: 1;
            display: none;
        }

        .welcome-user {
            position: relative;
            z-index: 1;
            white-space: nowrap;
        }

        .welcome-user span {
            color: #cbd5e1;
            font-size: 0.8em;
            font-weight: 400;
        }

        .welcome-user strong {
            color: #3b82f6;
            font-weight: 600;
            margin-left: 4px;
        }

        .header .title-section {
            text-align: right;
            position: relative;
            z-index: 1;
        }

        .title-row {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 15px;
        }

        .header .title-section h2 {
            font-size: 0.95em;
            margin: 0;
            font-weight: 500;
            color: #cbd5e1;
            letter-spacing: 0.3px;
        }

        .header .title-section p {
            font-size: 0.75em;
            margin: 2px 0 0 0;
            color: #a2a8ba;
            font-weight: 400;
        }

        /* Sidebar - Exact CUSTSEARCHSO Style */
        .sidebar {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100vh;
            background: rgba(255, 255, 255, .08);
            backdrop-filter: blur(1px);
            -webkit-backdrop-filter: blur(1px);
            color: white;
            transition: left 0.2s ease;
            z-index: 2000;
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.3);
        }
        .sidebar.active { left: 0; }
        .sidebar-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.5); opacity: 0; visibility: hidden;
            transition: all 0.3s ease; z-index: 999; pointer-events: none;
        }
        .sidebar-overlay.active { opacity: 1; visibility: visible; pointer-events: auto; }

        .sidebar-content {
            padding: 24px;
        }

        .sidebar-header {
            padding: 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
        }
        .sidebar-header h3 { font-size: 1.2em; color: white; margin: 0; }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-menu li {
            margin-bottom: 8px;
        }

        .sidebar-menu a {
            display: block;
            padding: 12px 16px;
            color: #f3f4f6;
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .sidebar-menu a:hover {
            background-color: rgba(30, 64, 175, 0.1);
            color: white;
        }

        .sidebar-menu a.active {
            background-color: rgba(30, 64, 175, 0.2);
            color: #93c5fd;
        }

        .sidebar-menu a i { margin-right: 12px; width: 20px; text-align: center; }

        /* Main Content & Tabs */
        .main-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        /* Tab Navigation - Liquid Glass */
        .tab-navigation {
            background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .tab-buttons { display: flex; }
        .tab-button {
            background: none; border: none; padding: 12px 20px; color: #64748b;
            font-weight: 500; cursor: pointer; transition: all 0.3s ease;
            border-bottom: 3px solid transparent; display: flex; align-items: center; gap: 8px;
        }
        .tab-button:hover { color: #1e40af; background: rgba(30, 64, 175, 0.05); }
        .tab-button.active {
            color: #1e40af; background: rgba(30, 64, 175, 0.1);
            border-bottom-color: #1e40af; font-weight: 600;
        }

        .tab-content { flex: 1; overflow: hidden; }
        .tab-pane { display: none; height: 100%; overflow-y: auto; padding: 16px; background: #f8fafc; }
        .tab-pane.active { display: block; }

        /* Form Styles - Liquid Glass */
        .form-container {
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px);
            border-radius: 16px; padding: 20px; margin-bottom: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .form-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 16px; margin-bottom: 16px;
        }
        .form-group { display: flex; flex-direction: column; }
        .form-group label { font-weight: 600; color: #374151; margin-bottom: 8px; }
        .form-group input {
            padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 8px;
            transition: all 0.2s ease; background: rgba(255, 255, 255, 0.8);
        }
        .form-group input:focus {
            outline: none; border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        .form-group.full-width {
            grid-column: 1 / -1;
        }
        .form-group textarea {
            padding: 10px 12px; border: 2px solid #e5e7eb; border-radius: 8px;
            transition: all 0.2s ease; background: rgba(255, 255, 255, 0.8);
            resize: vertical; font-family: inherit;
        }
        .form-group textarea:focus {
            outline: none; border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-actions { display: flex; gap: 12px; justify-content: flex-end; }
        .btn {
            padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600;
            cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 8px;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white;
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4); }
        .btn-secondary { background: rgba(107, 114, 128, 0.1); color: #374151; border: 1px solid #d1d5db; }

        /* Excel Grid Wrapper - Exact from CUSTSEARCHSO_EDIT.HTML */
        .excel-grid-wrapper {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .excel-grid-container {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            border: 1px solid #dee2e6;
            border-radius: 0 0 12px 12px;
            background: white;
            position: relative;
            min-height: 250px;
            max-height: calc(100vh - 200px);
            height: calc(100vh - 200px);
            margin-top: 8px;
        }

        .excel-grid-container::-webkit-scrollbar {
            width: 12px;
        }

        .excel-grid-container::-webkit-scrollbar-track {
            background: #f1f3f4;
            border-radius: 6px;
        }

        .excel-grid-container::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            border-radius: 6px;
            border: 2px solid #f1f3f4;
        }

        .excel-grid-container::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }

        .excel-grid-container::-webkit-scrollbar-corner {
            background: #f1f3f4;
        }

        .grid-header {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 20px 24px; border-bottom: 1px solid rgba(226, 232, 240, 0.8);
            display: flex; justify-content: space-between; align-items: center;
        }
        .grid-title { font-size: 1.1em; font-weight: 600; color: #1e293b; margin: 0; }
        .grid-stats {
            background: rgba(59, 130, 246, 0.1); padding: 4px 12px;
            border-radius: 20px; font-size: 0.85em; color: #64748b;
        }

        .excel-grid-premium {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 11px;
            background: white;
            min-width: 1000px;
            border: 1px solid #dee2e6;
        }

        .excel-header {
            background: linear-gradient(135deg, #2a5298 0%, #1e3c72 100%);
            color: white;
            padding: 8px 12px;
            font-weight: 600;
            text-align: left;
            border-right: 1px solid #1e3c72;
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease;
            font-size: 11px;
        }

        .excel-header:hover {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }

        .excel-header.sorted {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .excel-header:last-child {
            border-right: none;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .sort-icon {
            opacity: 0.7;
            font-size: 12px;
            transition: opacity 0.2s ease;
        }

        .excel-header:hover .sort-icon {
            opacity: 1;
        }

        .resize-handle {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            cursor: col-resize;
            background: rgba(255, 255, 255, 0.2);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .excel-header:hover .resize-handle {
            opacity: 1;
        }

        .excel-row {
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .excel-row:nth-child(even) {
            background: #f8f9fa;
        }

        .excel-row:hover {
            background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
            transform: translateX(2px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .excel-row.selected {
            background: linear-gradient(135deg, #2196f3 0%, #9c27b0 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
        }

        .excel-cell {
            padding: 6px 10px;
            border-right: 1px solid #dee2e6;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
            position: relative;
            font-size: 11px;
        }

        /* Read-only look for non-editable fields */
        .excel-cell.readonly { background: #f3f4f6; }
        .excel-cell.readonly .cell-content { color: #6b7280; }

        /* Price range editor rows */
        .price-range-row { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 8px; align-items: center; margin-bottom: 8px; }
        .price-range-row input[type="number"] { width: 100%; padding: 6px 8px; border: 1px solid #cbd5e1; border-radius: 6px; }
        .price-range-row .remove-range { background: #ef4444; color: white; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; }

        .excel-cell:last-child {
            border-right: none;
        }

        .cell-content {
            display: flex;
            align-items: center;
            min-height: 20px;
            padding:9px;
            margin-top: 2.4px
        }

        .customer-code-cell {
            font-weight: 600;
            color: #2a5298;
            cursor: pointer;
        }

        .customer-code-cell:hover {
            text-decoration: underline;
        }

        .part-number-cell {
            font-weight: 600;
            color: #2a5298;
            cursor: pointer;
        }

        .part-number-cell:hover {
            text-decoration: underline;
        }

        /* Grid Toolbar Styles */
        .grid-toolbar {
            background: #f8f9fa;
            padding: 12px 20px;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .toolbar-left .results-count {
            color: #6c757d;
            font-size: 14px;
            font-weight: 500;
        }

        .toolbar-left .results-count i {
            margin-right: 8px;
            color: #2a5298;
        }

        .toolbar-right {
            display: flex;
            gap: 10px;
        }

        .grid-btn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .grid-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(42, 82, 152, 0.4);
        }

        /* Filter Row Styles */
        .filter-row {
            background: #f8f9fa;
            position: sticky;
            top: 40px;
            z-index: 9;
        }

        .filter-cell {
            padding: 8px;
            border-right: 1px solid #dee2e6;
            border-bottom: 2px solid #dee2e6;
            background: #f8f9fa;
        }

        .filter-cell:last-child {
            border-right: none;
        }

        .filter-input {
            width: 100%;
            padding: 6px 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 12px;
            background: white;
            transition: all 0.2s ease;
        }

        .filter-input:focus {
            outline: none;
            border-color: #2a5298;
            box-shadow: 0 0 0 2px rgba(42, 82, 152, 0.2);
        }

        .action-buttons { display: flex; gap: 8px; }
        .btn-sm {
            padding: 6px 12px; font-size: 0.8em; border-radius: 6px;
            border: none; cursor: pointer; transition: all 0.2s ease;
            font-weight: 500;
        }
        .btn-edit { 
            background: #28a745; 
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 32px;
        }
        .btn-edit:hover { 
            background: #218838; 
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }
        .btn-delete { 
            background: #007bff; 
            color: white; 
        }
        .btn-delete:hover { 
            background: #0056b3; 
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        /* Success Notification Styles */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 10000;
            pointer-events: none;
        }

        .notification {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 500;
            font-size: 14px;
            min-width: 300px;
            transform: translateX(400px);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-left: 4px solid #34d399;
            backdrop-filter: blur(10px);
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.hide {
            transform: translateX(400px);
            opacity: 0;
        }

        .notification-icon {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            animation: pulse 2s infinite;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .notification-message {
            font-size: 13px;
            opacity: 0.9;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes slideInBounce {
            0% {
                transform: translateX(400px) scale(0.8);
                opacity: 0;
            }
            60% {
                transform: translateX(-10px) scale(1.02);
                opacity: 1;
            }
            100% {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }

        .notification.bounce {
            animation: slideInBounce 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* Error Notification Styles */
        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
            border-left: 4px solid #f87171;
        }

        /* Warning Notification Styles */
        .notification.warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
            border-left: 4px solid #fbbf24;
        }

        /* Info Notification Styles */
        .notification.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3);
            border-left: 4px solid #60a5fa;
        }

        /* Loading Notification Styles */
        .notification.loading {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
            border-left: 4px solid #34d399;
        }

        .notification.loading .notification-icon i {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Price Ranges Styles */
        .price-ranges-section {
            margin: 16px 0;
            padding: 16px;
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            border: 2px solid #3b82f6;
            border-radius: 8px;
            text-align: right;
        }

        .price-range-row {
            margin-bottom: 8px;
            padding: 12px;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border: 1px solid #3b82f6;
            border-radius: 6px;
            position: relative;
            text-align: right;
        }

        .price-range-row:last-child {
            margin-bottom: 0;
        }

        .price-range-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 16px;
            align-items: end;
            justify-items: end;
            text-align: right;
        }

        .price-range-grid .form-group {
            margin-bottom: 0;
            text-align: right;
        }

        .price-range-grid input {
            text-align: right;
        }
        .price-range-grid label {
            text-align: right;
            display: block;
        }

        .price-range-grid input {
            text-align: right;
        }

        .ranges-cell {
            text-align: right;
        }
        .ranges-cell .cell-content {
            display: flex;
            justify-content: flex-end; /* push container to the right */
            width: 100%;
        }
        .price-ranges-vertical {
            display: flex;
            flex-direction: column;
            align-items: flex-end;     /* right-align each row */
            gap: 6px;
            width: 100%;
        }
        .price-ranges-vertical .range-badge {
            background: #dbeafe;
            color: #1e40af;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85em;
            white-space: nowrap;       /* keep each badge on one line */
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 0.875rem;
            height: auto;
        }

        .price-range-row .btn-danger {
            background: #3b82f6;
            border-color: #3b82f6;
        }

        .price-range-row .btn-danger:hover {
            background: #2563eb;
            border-color: #2563eb;
        }

        @media (max-width: 768px) {
            .price-range-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .price-range-grid .form-group:last-child {
                justify-self: start;
            }
        }
        
        /* Enhanced New Search Button Styles */
        #newSearchButtonContainer {
            display: none;
            margin-top: 20px;
            text-align: center;
            padding: 20px;
            background: #dbeafe;
            border: 2px solid #3b82f6;
            border-radius: 8px;
        }

        #newSearchButtonContainer button {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 4px 12px rgba(5, 150, 105, 0.3);
            transition: all 0.3s ease;
        }

        #newSearchButtonContainer button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(5, 150, 105, 0.4);
            background: linear-gradient(135deg, #047857 0%, #059669 100%);
        }

        #newSearchButtonContainer p {
            margin: 0 0 15px 0;
            color: #92400e;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>
    
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h3>Menu</h3>
        </div>
        <div class="sidebar-content">
            <ul class="sidebar-menu">
                <li><a href="#" class="active">Vendor Pricing</a></li>
                <li><a href="#">Sales Orders</a></li>
                <li><a href="#">Reports</a></li>
                <li><a href="#">Vendor Management</a></li>
                <li><a href="#">Settings</a></li>
                <li><a href="#">Help</a></li>
            </ul>
        </div>
    </div>

    <div class="container">
        <div class="header">
            <div class="header-left">
                <button class="hamburger-menu" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo-section">
                    <img src="http://54.189.226.145/uploads/assets/images/taimex_logo.png" alt="TAIMEX" onerror="showFallbackLogo(this)">
                    <h1 id="fallbackLogo">TAIMEX</h1>
                </div>
            </div>
            <div class="title-section">
                <div class="title-row">
                    <div class="welcome-user">
                        <span>Welcome</span><strong>Admin User</strong>
                    </div>
                    <div>
                        <h2>Vendor Pricing System</h2>
                        <p>Data Capture & Management</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="tab-navigation">
                <div class="tab-buttons">
                    <button class="tab-button active" onclick="switchTab('capture')">
                        <i class="fas fa-plus"></i>Data Capture
                    </button>
                    <button class="tab-button" onclick="switchTab('search')">
                        <i class="fas fa-search"></i>Search & View
                    </button>
                    <button class="tab-button" onclick="switchTab('manage')">
                        <i class="fas fa-edit"></i>Manage Records
                    </button>
                </div>
            </div>

            <div class="tab-content">
                <!-- Data Capture Tab -->
                <div id="capture-tab" class="tab-pane active">
                    <div class="form-container">
                        <h3 style="margin-bottom: 24px; color: #1e293b;">Data Capture - Search Vendor & Part Pricing</h3>
                        <div class="form-grid" style="max-width: 600px; margin: 0 auto;">
                            <div class="form-group">
                                <label for="partNumber">Part Number <span style="color: #ef4444;">*</span></label>
                                <input type="text" id="partNumber" placeholder="Enter part number first and press Enter" onkeydown="if(event.key==='Enter'){event.preventDefault(); const cn=document.getElementById('vendorno'); if(!cn || !cn.value.trim()){ if(cn) cn.focus(); } else { simpleCaptureSearch(); }}" style="font-size: 1.1em; padding: 12px;">
                            </div>
                            <div class="form-group">
                                <label for="vendorno">Vendor Number <span style="color: #ef4444;">*</span></label>
                                <input type="text" id="vendorno" placeholder="Enter vendor number and press Enter" onkeydown="if(event.key==='Enter'){event.preventDefault(); const pn=document.getElementById('partNumber'); if(!pn || !pn.value.trim()){ if(pn) pn.focus(); } else { simpleCaptureSearch(); }}" style="font-size: 1.1em; padding: 12px;">
                                <div id="customerLookupResult" style="margin-top: 8px; padding: 8px; border-radius: 4px; display: none;"></div>
                            </div>
                            <div style="margin-top: 16px; padding: 12px; background: #dbeafe; border: 1px solid #3b82f6; border-radius: 6px; font-size: 0.9em; color: #1e40af;">
                                <i class="fas fa-info-circle"></i> Both Part Number and Vendor Number are required to display existing pricing information or create new records.
                            </div>
                            
                            <!-- Cache Diagnostic Button -->
                            <div style="margin-top: 12px; text-align: center;">
                                <button type="button" onclick="runCacheDiagnosticAndCleanup()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 8px 16px; border: none; border-radius: 6px; font-size: 0.85em; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                                    <i class="fas fa-tools"></i> Diagnosticar Cache
                                </button>
                            </div>
                            
                            <!-- Action Buttons - Only visible when needed -->
                            <div id="captureActionButtons" style="margin-top: 20px; text-align: center; display: none; gap: 15px; justify-content: center;">
                                <button type="button" onclick="startNewSearch()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 1em; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                                    <i class="fas fa-search"></i> New Search
                                </button>

                                <button type="button" onclick="clearCaptureForm()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 1em; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                                    <i class="fas fa-times"></i> Clear All
                                </button>
                            </div>
                        </div>
                        
                        <!-- Results Display Area -->
                        <div id="captureResultsArea" style="margin-top: 30px; display: none;">
                            <div id="captureCustomerInfo" style="display: none;"></div>
                            <div id="capturePartInfo" style="display: none;"></div>
                        </div>
                        
                        <!-- Part Search Results in Data Capture -->
                        <div id="capturePartSearchResults" style="display: none; margin-top: 30px;">
                            <h4 style="color: #1e293b; margin-bottom: 16px; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-search"></i> Part Search Results
                            </h4>
                            <div id="capturePartSearchContent"></div>
                        </div>
                    </div>
                </div>

                <!-- Search & View Tab -->
                <div id="search-tab" class="tab-pane">
                    <div class="form-container">
                        <h3 style="margin-bottom: 24px; color: #1e293b;">Search Records</h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="searchPartNumber">Part Number <span style="color: #3b82f6; font-size: 0.8em;">(Primary)</span></label>
                                <input type="text" id="searchPartNumber" placeholder="Enter part number" onkeyup="searchByPartNumber()" onkeydown="handlePartNumberEnter(event)" style="border: 2px solid #3b82f6;">
                            </div>
                            <div class="form-group">
                                <label for="searchCustomerNumber">Vendor Number</label>
                                <input type="text" id="searchCustomerNumber" placeholder="Enter customer number" onkeydown="handleCustomerNumberEnter(event)" onkeyup="searchByCustomerNumber()">
                            </div>
                            <div class="form-group">
                                <label for="searchCustomer">Search by Customer Name</label>
                                <input type="text" id="searchCustomer" placeholder="Enter customer name" onkeyup="searchCustomerCascade()">
                            </div>
                            <div class="form-group" style="display: flex; align-items: end;">
                                <button type="button" class="grid-btn" onclick="clearAllSearches()" style="width: 100%; margin: 0;">
                                    <i class="fas fa-broom"></i> Clear All Searches
                                </button>
                            </div>
                        </div>
                        
                        <!-- Customer Results Display -->
                        <div id="customerResults" style="display: none; margin: 20px 0; padding: 15px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                            <h4 style="color: #1e293b; margin-bottom: 10px;"><i class="fas fa-user"></i> Customer Information</h4>
                            <div id="customerInfo"></div>
                        </div>
                        
                        <!-- Part Details Form -->
                        <div id="partDetailsForm" style="display: none; margin: 20px 0; padding: 20px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                            <h4 style="color: #1e293b; margin-bottom: 15px;"><i class="fas fa-cog"></i> Part Details</h4>
                            <div id="partDetailsContent"></div>
                        </div>
                    </div>

                    <div class="excel-grid-wrapper">
                        <div class="grid-toolbar">
                            <div class="toolbar-left">
                                <span class="results-count">
                                    <i class="fas fa-database"></i> 
                                    <span id="recordsCount">0 of 0 records</span>
                                </span>
                            </div>
                            <div class="toolbar-right">
                                <button class="grid-btn" onclick="loadAllRecordsFromPicLan()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;">
                                    <i class="fas fa-cloud-download-alt"></i> Cargar desde PicLan
                                </button>
                                <button class="grid-btn" onclick="exportToCSV()">
                                    <i class="fas fa-download"></i> Export
                                </button>
                                <button class="grid-btn" onclick="clearFilters()">
                                    <i class="fas fa-times"></i> Clear Filters
                                </button>
                                <button class="grid-btn" onclick="manualCleanupLocalStorage()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                                    <i class="fas fa-broom"></i> Limpiar Cache
                                </button>
                            </div>
                        </div>
                        
                        <div class="excel-grid-container">
                            <table class="excel-grid-premium">
                                <thead>
                                    <tr>
                                        <th class="excel-header" onclick="sortTable(0)">
                                            <div class="header-content">
                                                <i class="fas fa-barcode"></i> Part Number
                                                <i class="fas fa-sort sort-icon"></i>
                                            </div>
                                        </th>
                                        <th class="excel-header" onclick="sortTable(1)">
                                            <div class="header-content">
                                                <i class="fas fa-file-alt"></i> Part Description
                                                <i class="fas fa-sort sort-icon"></i>
                                            </div>
                                        </th>
                                        <th class="excel-header" onclick="sortTable(2)">
                                            <div class="header-content">
                                                <i class="fas fa-id-card"></i> Vendor Number
                                                <i class="fas fa-sort sort-icon"></i>
                                            </div>
                                        </th>
                                        <th class="excel-header" onclick="sortTable(3)">
                                            <div class="header-content">
                                                <i class="fas fa-user"></i> Vendor Name
                                                <i class="fas fa-sort sort-icon"></i>
                                            </div>
                                        </th>
                                        <th class="excel-header" onclick="sortTable(5)">
                                            <div class="header-content">
                                                <i class="fas fa-chart-line"></i> Price Ranges
                                                <i class="fas fa-sort sort-icon"></i>
                                            </div>
                                        </th>
                                        <th class="excel-header" onclick="sortTable(6)">
                                            <div class="header-content">
                                                <i class="fas fa-calendar-alt"></i> Date
                                                <i class="fas fa-sort sort-icon"></i>
                                            </div>
                                        </th>
                                        <th class="excel-header" onclick="sortTable(7)">
                                            <div class="header-content">
                                                <i class="fas fa-sticky-note"></i> Notes
                                                <i class="fas fa-sort sort-icon"></i>
                                            </div>
                                        </th>
                                        <th class="excel-header actions-header">
                                            <div class="header-content">
                                                <i class="fas fa-cogs"></i> Actions
                                            </div>
                                        </th>
                                    </tr>
                                    <tr class="filter-row">
                                        <th class="filter-cell">
                                            <input type="text" class="filter-input" placeholder="Filter part number..." onkeyup="filterRecords()" id="filterPart">
                                        </th>
                                        <th class="filter-cell">
                                            <input type="text" class="filter-input" placeholder="Filter part description..." onkeyup="filterRecords()" id="filterPartDescription">
                                        </th>
                                        <th class="filter-cell">
                                            <input type="text" class="filter-input" placeholder="Filter cust number..." onkeyup="filterRecords()" id="filterCustno">
                                        </th>
                                        <th class="filter-cell">
                                            <input type="text" class="filter-input" placeholder="Filter cust name..." onkeyup="filterRecords()" id="filterCustomer">
                                        </th>
                                        <th class="filter-cell">
                                            <input type="text" class="filter-input" placeholder="Filter price ranges..." onkeyup="filterRecords()" id="filterPriceRanges">
                                        </th>
                                        <th class="filter-cell">
                                            <input type="date" class="filter-input" onchange="filterRecords()" id="filterDate">
                                        </th>
                                        <th class="filter-cell">
                                            <input type="text" class="filter-input" placeholder="Filter notes..." onkeyup="filterRecords()" id="filterNotes">
                                        </th>
                                        <th class="filter-cell"></th>
                                    </tr>
                                </thead>
                                <tbody id="recordsTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                 <!-- Manage Records Tab -->
                <div id="manage-tab" class="tab-pane">
                    <div class="form-container">
                        <h3 style="margin-bottom: 24px; color: #1e293b;">Edit Record</h3>
                        <form id="editForm" onsubmit="updateRecord(event)" style="display: none;">
                            <input type="hidden" id="editIndex">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="editCustomer">Customer Name</label>
                                    <input type="text" id="editCustomer" readonly style="background: #f1f5f9; color: #64748b;">
                                </div>
                                <div class="form-group">
                                    <label for="editPartNumber">Part Number</label>
                                    <input type="text" id="editPartNumber" readonly style="background: #f1f5f9; color: #64748b;">
                                </div>
                                <div class="form-group">
                                    <label for="editCustno">Vendor Number</label>
                                    <input type="text" id="editCustno" readonly style="background: #f1f5f9; color: #64748b;">
                                </div>
                                <div class="form-group">
                                    <label for="editDate">Date</label>
                                    <input type="date" id="editDate">
                                </div>
                            </div>
                            <div class="form-grid" style="margin-top: 16px;">
                                <div class="form-group" style="grid-column: span 2;">
                                    <label for="editPartDescription">Part Description</label>
                                    <input type="text" id="editPartDescription" readonly style="background: #f1f5f9; color: #64748b;">
                                </div>
                                <div class="form-group" style="grid-column: span 2;">
                                    <label for="editNotes">Notes</label>
                                    <textarea id="editNotes" rows="3" placeholder="Add notes..."></textarea>
                                </div>
                             </div>
                             
                             <!-- Edit Price Ranges Section -->
                             <div class="price-ranges-section">
                                 <h4 style="margin: 24px 0 16px 0; color: #1e293b; display: flex; align-items: center; gap: 8px;">
                                     <i class="fas fa-chart-line"></i> Price Ranges
                                 </h4>
                                 <div id="editPriceRanges">
                                     <!-- Price ranges will be populated by JavaScript -->
                                 </div>
                                 <button type="button" class="btn btn-secondary btn-sm" onclick="addEditPriceRange()" style="margin-top: 12px;">
                                     <i class="fas fa-plus"></i> Add Price Range
                                 </button>
                             </div>
                             
                             <div class="form-grid" style="margin-top: 24px;">
                             </div>
                            <div class="button-group" style="margin-top: 20px; display: flex; gap: 12px; justify-content: center;">
                                <button type="submit" class="btn btn-success" style="padding: 12px 24px; font-size: 1.1em;">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                                <button type="button" class="btn btn-secondary" onclick="cancelEdit()" style="padding: 12px 24px; font-size: 1.1em;">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                                <button type="button" class="btn btn-primary" onclick="simpleCaptureSearch()" style="padding: 12px 24px; font-size: 1.1em;">
                                    <i class="fas fa-search"></i> Search Records
                                </button>
                                <button type="button" class="btn btn-success" onclick="startNewCaptureSearch()" id="newSearchBtn" style="padding: 12px 24px; font-size: 1.1em; display: none;">
                                    <i class="fas fa-plus"></i> New Search
                                </button>
                                <button type="button" class="btn btn-warning" onclick="testPriceRangesSave()" style="padding: 12px 24px; font-size: 1.1em; background: #f59e0b; border-color: #f59e0b;">
                                    <i class="fas fa-bug"></i> Test Price Ranges
                                </button>
                            </div>
                        </form>
                        <div id="noEditMessage" style="text-align: center; color: #64748b; padding: 40px;">
                            <i class="fas fa-info-circle" style="font-size: 2em; margin-bottom: 16px;"></i>
                            <p>Select a record from the Search & View tab to edit it here.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- XML API Integration -->
    <!-- <script src="./xml_api_integration.js"></script> -->
    
   

    <script>
        // evita falsos “no encontrado” cuando sí hay <record> sin precios
        // ---- Networking helpers & guards ----
        let isSearching = false; // prevents concurrent capture searches
        let isBulkLoading = false; // prevents overlapping auto-loads without blocking capture search

        function withSearchGuard(fn){
          return async function(...args){
            if (isSearching) { console.log('⏳ A search is already running, skipping.'); return; }
            isSearching = true;
            try { return await fn.apply(this, args); }
            finally {
              isSearching = false;
              if (typeof hideLoadingNotification === 'function') hideLoadingNotification();
            }
          };
        }

        // Notification fallbacks: define no-op implementations if not present
        if (typeof window.initializeNotifications !== 'function') {
            window.initializeNotifications = function() {};
        }
        if (typeof window.showLoadingNotification !== 'function') {
            window.showLoadingNotification = function(title, message) {
                console.log('🔄 [Loading]', title || '', message || '');
            };
        }
        if (typeof window.hideLoadingNotification !== 'function') {
            window.hideLoadingNotification = function() {
                console.log('✅ [Loading finished]');
            };
        }
        if (typeof window.showSuccessNotification !== 'function') {
            window.showSuccessNotification = function(title, message) {
                console.log('✅ [Success]', title || '', message || '');
            };
        }
        if (typeof window.showErrorNotification !== 'function') {
            window.showErrorNotification = function(title, message) {
                console.error('❌ [Error]', title || '', message || '');
            };
        }
        if (typeof window.showNotification !== 'function') {
            window.showNotification = function(message, type = 'info') {
                const tag = type && typeof type === 'string' ? type.toLowerCase() : 'info';
                const icon = tag === 'error' ? '❌' : tag === 'success' ? '✅' : 'ℹ️';
                console.log(`${icon} [${tag}]`, message || '');
            };
        }

        // fetch with timeout (uses AbortSignal.timeout when available; falls back to AbortController)
        async function fetchWithTimeout(url, options = {}) {
          const { timeout = 12000, signal: extSignal, ...rest } = options;

          // prefer modern AbortSignal.timeout
          if (AbortSignal && typeof AbortSignal.timeout === 'function') {
            const timeoutSignal = AbortSignal.timeout(timeout);
            const signal = (AbortSignal.any && extSignal)
              ? AbortSignal.any([extSignal, timeoutSignal])
              : (extSignal || timeoutSignal);
            return fetch(url, { ...rest, signal });
          }

          // fallback: manual controller + setTimeout
          const controller = new AbortController();
          const timer = setTimeout(() => controller.abort(), timeout);
          const signal = extSignal || controller.signal;
          try {
            return await fetch(url, { ...rest, signal });
          } finally {
            clearTimeout(timer);
          }
        }

        window.__lastApiHadRecord = false;
        
        // Function to format prices cleanly
        function formatPrice(price) {
            if (!price || isNaN(price)) return '0.000';
            const num = parseFloat(price);
            return num.toFixed(3);
        }

        // Function to auto-format price input - flexible decimals
        function formatPriceInput(input) {
            const value = parseFloat(input.value);
            
            if (isNaN(value)) {
                input.value = '';
                return;
            }
            
            // Always format to 3 decimal places
            input.value = value.toFixed(3);
        }

        // Function to add price formatting events to an input
        function addPriceFormatting(input) {
            if (!input) return;
            
            // Format on blur (when user leaves the field)
            input.addEventListener('blur', function() {
                formatPriceInput(this);
            });
            
            // Format on Enter key press
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    formatPriceInput(this);
                }
            });
        }

        // Function to apply price formatting to all price inputs on the page
        function applyPriceFormattingToAll() {
            // Apply to all existing price inputs with class 'price'
            document.querySelectorAll('input.price').forEach(input => {
                addPriceFormatting(input);
            });
            
            // Apply to all existing price inputs with class 'editPrice'
            document.querySelectorAll('input.editPrice').forEach(input => {
                addPriceFormatting(input);
            });
            
            // Apply to all price inputs with common step sizes
            document.querySelectorAll('input[step="0.001"], input[step="0.0001"], input[step="0.01"]').forEach(input => {
                if (input.type === 'number' && (input.id.includes('price') || input.className.includes('price'))) {
                    addPriceFormatting(input);
                }
            });
        }

        // Records Array - Data will be loaded dynamically from PicLan API
        let records = [];
        // isSearching declared earlier in Networking helpers

        // Deduplication helpers: ensure unique PartNumber + CustomerNumber pairs
        function getRecordKey(record) {
            const part = (record.partNumber || record.PART_NUMBER || '').toString().trim().toUpperCase();
            const cust = (record.vendorNumber || record.vendorno || record.VENDOR_NUMBER || '').toString().trim();
            return `${part}|${cust}`;
        }

        function dedupeRecords(arr = []) {
            const map = new Map();
            let dupes = 0;
            let missingKeyCounter = 0;
            for (const r of arr) {
                let key = getRecordKey(r);
                const part = (r.partNumber || r.PART_NUMBER || '').toString().trim();
                const cust = (r.vendorNumber || r.vendorno || r.VENDOR_NUMBER || '').toString().trim();
                // If either part or customer is missing, treat as unique to avoid collapsing many into one
                if (!part || !cust) {
                    key = `${part}|${cust}|_idx_${missingKeyCounter++}`;
                }
                const existing = map.get(key);
                if (!existing) {
                    map.set(key, r);
                    continue;
                }
                // Prefer PicLan API over sample/local; otherwise keep the richer record
                const existingSrc = (existing.source || '').toLowerCase();
                const currentSrc = (r.source || '').toLowerCase();
                const existingRanges = Array.isArray(existing.priceRanges) ? existing.priceRanges.length : 0;
                const currentRanges = Array.isArray(r.priceRanges) ? r.priceRanges.length : 0;
                // Field completeness checks (names/descriptions)
                const existingName = (existing.vendorName || existing.customer || '').trim();
                const currentName = (r.vendorName || r.customer || '').trim();
                const existingDesc = (existing.partDescription || existing.DESCRIPTION || '').trim();
                const currentDesc = (r.partDescription || r.DESCRIPTION || '').trim();
                let replace = false;
                if (existingSrc.includes('sample') && !currentSrc.includes('sample')) replace = true;
                else if (!existingSrc.includes('piclan') && currentSrc.includes('piclan')) replace = true;
                // Prefer record with populated vendorName/partDescription
                else if ((!existingName && currentName) || (!existingDesc && currentDesc)) replace = true;
                else if (currentRanges > existingRanges) replace = true;
                if (replace) {
                    map.set(key, r);
                } else {
                    dupes++;
                }
            }
            if (dupes > 0) {
                console.log(`🧹 Deduplication removed ${dupes} duplicate record(s).`);
            }
            return Array.from(map.values());
        }
        
        // Helper: fetch with timeout using AbortController
        async function fetchWithTimeout(resource, options = {}) {
            const { timeout = 12000 } = options;
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            try {
                return await fetch(resource, { ...options, signal: controller.signal });
            } finally {
                clearTimeout(id);
            }
        }

        // Function to load initial records from PicLan API using ID='ALL'
        async function loadInitialRecordsFromAPI() {
            console.log('🔄 Loading initial records from PicLan API using ID=ALL...');
            
            // Known part numbers to query with ID='ALL' (only real PicLan data)
            const knownPartNumbers = ['AC-001']; // Temporarily limit to AC-001 to avoid server 500s for A-002/A-003/A-004
            
            for (const partNumber of knownPartNumbers) {
                try {
                    console.log(`🔍 Fetching all customers for part: ${partNumber}`);
                    const partRecords = await fetchAllCustomersForPart(partNumber);
                    
                    if (partRecords && partRecords.length > 0) {
                        records.push(...partRecords);
                        console.log(`✅ Loaded ${partRecords.length} records for part ${partNumber}`);
                    }
                } catch (error) {
                    console.log(`⚠️ Could not load records for part ${partNumber}:`, error.message);
                }
            }
            
            console.log(`📊 Total loaded ${records.length} records from PicLan API`);
            
            // Update the grid with loaded records
            renderRecords();
            // Count handled by renderRecords (uses de-duplicated count)
            
            // Show success notification (Spanish, de-duplicated count)
            const displayCountInit = dedupeRecords(records).length;
            if (displayCountInit > 0) {
                showSuccessNotification('✅ Registros Cargados', `${displayCountInit} registros cargados desde PicLan API`);
            } else {
                showErrorNotification('⚠️ Sin Registros', 'No se encontraron registros en la base de datos PicLan');
            }
        }
        
        // Function to load all records from PicLan with user feedback
        async function loadAllRecordsFromPicLan() {
            if (isBulkLoading) {
                console.log('⏸️ Already bulk-loading, skipping...');
                return;
            }
            
            isBulkLoading = true;
            showLoadingNotification('Cargando Registros', 'Consultando base de datos PicLan...');
            
            // Clear existing records
            records.length = 0;
            console.log('🔄 Cleared existing records, starting fresh load...');
            console.log('🎯 Target tbody element:', document.getElementById('recordsTableBody'));
            
            try {
                // Try to load all records using ID=ALL without specific part numbers
                let totalLoaded = 0;
                
                // First, try to get all records using a wildcard approach
                try {
                    console.log('🔍 Attempting to fetch all records with ID=ALL...');
                    const allRecords = await fetchAllRecordsFromPicLan();
                    
                    if (allRecords && allRecords.length > 0) {
                        const unique = dedupeRecords(allRecords);
                        records.push(...unique);
                        totalLoaded = unique.length;
                        console.log(`✅ Loaded ${totalLoaded} unique record(s) using ID=ALL`);
                    }
                } catch (error) {
                    console.log('⚠️ ID=ALL (all parts) failed:', error.message);
                    // Fallback: fetch per known parts but ALL customers for each part
                    const fallbackParts = ['AC-001','A-002','A-003','A-004'];
                    console.log('🔍 Fallback with parts:', fallbackParts.join(', '));
                    let collected = [];
                    for (const p of fallbackParts) {
                        try {
                            const pr = await fetchAllCustomersForPart(p);
                            if (pr && pr.length) {
                                collected.push(...pr);
                                console.log(`✅ ${p}: ${pr.length} registros`);
                            } else {
                                console.log(`ℹ️ ${p}: sin registros`);
                            }
                        } catch (perPartErr) {
                            console.log(`❌ ${p} fallo:`, perPartErr.message);
                        }
                    }
                    const unique = dedupeRecords(collected);
                    records.push(...unique);
                    totalLoaded = unique.length;
                    console.log(`✅ Fallback cargó ${totalLoaded} registros únicos`);
                }
                // Debug: verificar estructura de datos
                console.log('🔍 Registros cargados:', records);
                if (records.length > 0) {
                    console.log('📊 Estructura del primer registro:', records[0]);
                    console.log('📊 Campos disponibles:', Object.keys(records[0]));
                }
                console.log(`📊 Total loaded ${records.length} records from PicLan API`);
                
                // Dev top-up: only add sample data when NO real data was loaded
                if (records.length === 0) {
                    console.log('⚠️ Less than 4 records from API; topping up with sample data for development.');
                    const existingKeys = new Set(records.map(r => `${r.partNumber}|${r.vendorNumber}`));
                    const sampleData = [
                        {
                            id: 'sample-1',
                            partNumber: 'AC-001',
                            vendorNumber: '14',
                            vendorno: '14',
                            vendorName: 'ASCOTECH SA DE CV',
                            customer: 'ASCOTECH SA DE CV',
                            partDescription: 'ALUMINUM BRACKET 1/8"',
                            notes: 'Sample data (dev top-up)',
                            date: '2024-01-15',
                            priceRanges: [
                                { fromQty: 41, toQty: 499, price: 9.30 },
                                { fromQty: 500, toQty: 9999, price: 7.75 }
                            ],
                            source: 'Sample Data (dev top-up)'
                        },
                        {
                            id: 'sample-2',
                            partNumber: 'A-002',
                            vendorNumber: '25',
                            vendorno: '25',
                            vendorName: 'INDUSTRIAL SOLUTIONS MEXICO',
                            customer: 'INDUSTRIAL SOLUTIONS MEXICO',
                            partDescription: 'STEEL CONNECTOR 1/4"',
                            notes: 'Sample data (dev top-up)',
                            date: '2024-01-16',
                            priceRanges: [
                                { fromQty: 100, toQty: 499, price: 12.50 },
                                { fromQty: 500, toQty: 1999, price: 10.25 }
                            ],
                            source: 'Sample Data (dev top-up)'
                        },
                        {
                            id: 'sample-3',
                            partNumber: 'A-003',
                            vendorNumber: '38',
                            vendorno: '38',
                            vendorName: 'TECNOLOGIA AVANZADA SA',
                            customer: 'TECNOLOGIA AVANZADA SA',
                            partDescription: 'PLASTIC HOUSING 2"',
                            notes: 'Sample data (dev top-up)',
                            date: '2024-01-17',
                            priceRanges: [],
                            source: 'Sample Data (dev top-up)'
                        },
                        {
                            id: 'sample-4',
                            partNumber: 'A-004',
                            vendorNumber: '14',
                            vendorno: '14',
                            vendorName: 'ASCOTECH SA DE CV',
                            customer: 'ASCOTECH SA DE CV',
                            partDescription: 'RUBBER GASKET 3/8"',
                            notes: 'Sample data (dev top-up)',
                            date: '2024-01-18',
                            priceRanges: [],
                            source: 'Sample Data (dev top-up)'
                        }
                    ];
                    for (const s of sampleData) {
                        if (records.length >= 4) break;
                        const key = `${s.partNumber}|${s.vendorNumber}`;
                        if (!existingKeys.has(key)) {
                            records.push(s);
                            existingKeys.add(key);
                        }
                    }
                }
                
                // Update the grid with loaded records
                renderRecords();
                console.log('🎯 After renderRecords - tbody rows:', document.getElementById('recordsTableBody').children.length);
                
                const displayCount = dedupeRecords(records).length;
                if (displayCount > 0) {
                    showSuccessNotification('✅ Registros Cargados', `${displayCount} registros cargados desde PicLan API`);
                } else {
                    showErrorNotification('⚠️ Sin Registros', 'No se encontraron registros en la base de datos PicLan');
                }
                
            } catch (error) {
                console.error('Error loading records from PicLan:', error);
                
                // Fallback to sample data when PicLan is not available
                console.log('🔄 Loading sample data as fallback...');
                records.length = 0; // Clear any partial data
                
                // Add sample data that was showing before
                const sampleData = [
                    {
                        id: 'sample-1',
                        partNumber: 'AC-001',
                        vendorNumber: '14',
                        vendorno: '14',
                        vendorName: 'ASCOTECH SA DE CV',
                        customer: 'ASCOTECH SA DE CV',
                        partDescription: 'ALUMINUM BRACKET 1/8"',
                        notes: 'Sample data for testing',
                        date: '2024-01-15',
                        priceRanges: [
                            { fromQty: 41, toQty: 499, price: 9.30 },
                            { fromQty: 500, toQty: 9999, price: 7.75 }
                        ],
                        source: 'Sample Data (PicLan unavailable)'
                    },
                    {
                        id: 'sample-2',
                        partNumber: 'A-002',
                        vendorNumber: '25',
                        vendorno: '25',
                        vendorName: 'INDUSTRIAL SOLUTIONS MEXICO',
                        customer: 'INDUSTRIAL SOLUTIONS MEXICO',
                        partDescription: 'STEEL CONNECTOR 1/4"',
                        notes: 'Sample data for testing',
                        date: '2024-01-16',
                        priceRanges: [
                            { fromQty: 100, toQty: 499, price: 12.50 },
                            { fromQty: 500, toQty: 1999, price: 10.25 }
                        ],
                        source: 'Sample Data (PicLan unavailable)'
                    },
                    {
                        id: 'sample-3',
                        partNumber: 'A-003',
                        vendorNumber: '38',
                        vendorno: '38',
                        vendorName: 'TECNOLOGIA AVANZADA SA',
                        customer: 'TECNOLOGIA AVANZADA SA',
                        partDescription: 'PLASTIC HOUSING 2"',
                        notes: 'Sample data for testing',
                        date: '2024-01-17',
                        priceRanges: [
                            { fromQty: 50, toQty: 299, price: 15.75 },
                            { fromQty: 300, toQty: 999, price: 13.50 }
                        ],
                        source: 'Sample Data (PicLan unavailable)'
                    },
                    {
                        id: 'sample-4',
                        partNumber: 'A-004',
                        vendorNumber: '14',
                        vendorno: '14',
                        vendorName: 'ASCOTECH SA DE CV',
                        customer: 'ASCOTECH SA DE CV',
                        partDescription: 'RUBBER GASKET 3/8"',
                        notes: 'Sample data for testing',
                        date: '2024-01-18',
                        priceRanges: [
                            { fromQty: 200, toQty: 999, price: 3.25 },
                            { fromQty: 1000, toQty: 4999, price: 2.85 }
                        ],
                        source: 'Sample Data (PicLan unavailable)'
                    },
                ];
                
                records.push(...sampleData);
                
                // Update the grid with sample data
                renderRecords();
                
                showErrorNotification('⚠️ PicLan No Disponible', `Mostrando ${records.length} registros de muestra. PicLan API no está disponible.`);
            } finally {
                // Always clear bulk-loading flag and hide loader
                isBulkLoading = false;
                if (typeof hideLoadingNotification === 'function') hideLoadingNotification();
            }
        }

        // Function to fetch ALL records from PicLan using ID=ALL
        // Updated to support the enhanced GET_VENDPRC.XML script that can handle ID=ALL without specific PART_NUMBER
        async function fetchAllRecordsFromPicLan() {
            console.log('⛅ Fetching ALL records from PicLan (ID=ALL) ...');
            const cacheBuster = Date.now();
            const attempts = [
                `http://54.189.226.145/GET_VENDPRC.XML?ID=ALL&PART_NUMBER=&_cb=${cacheBuster}`,
                `http://54.189.226.145/GET_VENDPRC.XML?ID=ALL&_cb=${cacheBuster}`,
                `http://54.189.226.145/GET_VENDPRC.XML?ID=ALL&PART_NUMBER=*&_cb=${cacheBuster}`,
                `http://54.189.226.145/GET_VENDPRC.XML?ID=ALL&PART_NUMBER=ALL&_cb=${cacheBuster}`
            ];
            let lastError;
            for (let i = 0; i < attempts.length; i++) {
                try {
                    console.log(`🔄 API Attempt ${i + 1}: ${attempts[i]}`);
                    const response = await fetchWithTimeout(attempts[i], {
                        method: 'GET',
                        headers: {
                            'Accept': 'text/xml, application/xml, text/plain, */*',
                            'Cache-Control': 'no-cache'
                        },
                        timeout: 20000
                    });
                    if (!response.ok) {
                        lastError = `HTTP ${response.status} - ${response.statusText}`;
                        continue;
                    }
                    const xmlText = await response.text();
                    if (!xmlText || !xmlText.trim()) {
                        lastError = 'Empty response';
                        continue;
                    }
                    if (xmlText.includes('Missing required parameters') || xmlText.includes('INTERNAL ERROR')) {
                        lastError = 'Server error: ' + xmlText.substring(0, 120);
                        continue;
                    }
                    // Parse XML into records
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                    const recordElements = xmlDoc.querySelectorAll('record');
                    const results = [];
                    recordElements.forEach(recordElement => {
                        const partNumber = getXMLTextContent(recordElement, 'partNumber', 'PART_NUMBER', 'PART', 'Item', 'ITEM') || '';
                        const vendorNumber = getXMLTextContent(recordElement, 'vendorNumber', 'VENDOR_NUMBER', 'vendorno', 'CUSTNO', 'id', 'ID', 'Customer', 'CUSTOMER') || '';
                        const vendorName = getXMLTextContent(recordElement, 'vendorName', 'VENDOR_NAME', 'NAME') || '';
                        const partDescription = getXMLTextContent(recordElement, 'partDescription', 'DESCRIPTION', 'DESC') || '';
                        const notes = getXMLTextContent(recordElement, 'notes', 'NOTES') || '';
                        const dateValue = getXMLTextContent(recordElement, 'date', 'DATE') || new Date().toISOString().split('T')[0];

                        const rec = {
                            id: Date.now() + Math.random(),
                            partNumber,
                            vendorNumber,
                            vendorno: vendorNumber,
                            vendorName,
                            customer: vendorName,
                            partDescription,
                            notes,
                            date: dateValue,
                            priceRanges: [],
                            source: 'PicLan API (ID=ALL)'
                        };
                        const rangeElements = recordElement.querySelectorAll('range');
                        rangeElements.forEach(range => {
                            const fromQty = parseFloat(getXMLTextContent(range, 'fromQty', 'MIN_QTY', 'minQty', 'from_qty')) || 0;
                            const toQty = parseFloat(getXMLTextContent(range, 'toQty', 'MAX_QTY', 'maxQty', 'to_qty')) || 0;
                            const price = parseFloat(getXMLTextContent(range, 'price', 'PRICE', 'unit_price', 'unitPrice')) || 0;
                            if (fromQty > 0 && price > 0) {
                                rec.priceRanges.push({ fromQty, toQty, price });
                            }
                        });
                        results.push(rec);
                    });
                    console.log(`✅ Parsed ${results.length} records from ID=ALL`);
                    return results;
                } catch (e) {
                    lastError = e.message;
                    console.log(`❌ Attempt ${i + 1} failed: ${lastError}`);
                }
            }
            throw new Error(lastError || 'Unable to fetch ALL records');
        }
        
        // Function to fetch ALL customers for a specific part number (via ID=ALL&PART_NUMBER=PART)
        async function fetchAllCustomersForPart(partNumber) {
            try {
                console.log(`🔍 Fetching customers for part: ${partNumber}`);
                
                // Validate partNumber
                if (!partNumber || !String(partNumber).trim()) {
                    throw new Error('PART_NUMBER vacío o inválido');
                }

                // Try dynamic API attempts with provided partNumber (ID=ALL for all customers of that part)
                let response, xmlText;
                let apiAttempts = [
                    // Preferred: server supports ALL customers by part
                    `http://54.189.226.145/GET_VENDPRC.XML?ID=ALL&PART_NUMBER=${encodeURIComponent(partNumber)}`,
                    `http://54.189.226.145/GET_VENDPRC.XML?ID=ALL&PART_NUMBER=${encodeURIComponent(partNumber)}&_=${Date.now()}`,
                    // Backward-compatible fallback: known working path for AC-001 using fixed customer 14
                    `http://54.189.226.145/GET_VENDPRC.XML?ID=14&PART_NUMBER=${encodeURIComponent(partNumber)}`
                ];
                
                let lastError;
                for (let i = 0; i < apiAttempts.length; i++) {
                    try {
                        console.log(`🔄 API Attempt ${i + 1}: ${apiAttempts[i]}`);
                        response = await fetchWithTimeout(apiAttempts[i], {
                            method: 'GET',
                            headers: {
                                'Accept': 'text/xml, application/xml, text/plain, */*',
                                'Cache-Control': 'no-cache'
                            },
                            timeout: 12000
                        });
                        
                        if (response.ok) {
                            xmlText = await response.text();
                            if (xmlText && xmlText.trim().length > 0 && !xmlText.includes('INTERNAL ERROR')) {
                                console.log(`✅ API Attempt ${i + 1} successful`);
                                break;
                            }
                        }
                        lastError = `HTTP ${response.status} - ${response.statusText}`;
                    } catch (attemptError) {
                        lastError = attemptError.message;
                        console.log(`❌ API Attempt ${i + 1} failed: ${lastError}`);
                    }
                }
                
                if (!xmlText || xmlText.trim().length === 0 || xmlText.includes('INTERNAL ERROR')) {
                    throw new Error(`All API attempts failed. Last error: ${lastError}`);
                }
                
                console.log(`📄 XML Response for ${partNumber}:`, xmlText.substring(0, 200) + '...');
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                const recordElements = xmlDoc.querySelectorAll('record');
                const fetchedRecords = [];
                
                recordElements.forEach(recordElement => {
                    // Robust multi-tag extraction (handles lower/upper case variants)
                    const vendorNumber = getXMLTextContent(recordElement, 'vendorNumber', 'VENDOR_NUMBER', 'vendorno', 'CUSTNO', 'id', 'ID', 'Customer', 'CUSTOMER') || '';
                    const vendorName = getXMLTextContent(recordElement, 'vendorName', 'VENDOR_NAME', 'NAME') || '';
                    const partNumberFromXml = getXMLTextContent(recordElement, 'partNumber', 'PART_NUMBER', 'PART', 'Item', 'ITEM');
                    const partDescription = getXMLTextContent(recordElement, 'partDescription', 'DESCRIPTION', 'DESC') || '';
                    const notes = getXMLTextContent(recordElement, 'notes', 'NOTES') || '';
                    const dateValue = getXMLTextContent(recordElement, 'date', 'DATE') || new Date().toISOString().split('T')[0];

                    const record = {
                        id: Date.now() + Math.random(), // Generate unique ID
                        partNumber: partNumberFromXml || partNumber,
                        vendorNumber,
                        vendorno: vendorNumber,
                        vendorName,
                        customer: vendorName,
                        partDescription,
                        notes,
                        date: dateValue,
                        priceRanges: [],
                        source: 'PicLan API'
                    };
                    
                    // Extract price ranges (with fallbacks)
                    const rangeElements = recordElement.querySelectorAll('range');
                    rangeElements.forEach(range => {
                        const fromQty = parseFloat(getXMLTextContent(range, 'fromQty', 'MIN_QTY')) || 0;
                        const toQty = parseFloat(getXMLTextContent(range, 'toQty', 'MAX_QTY')) || 0;
                        const price = parseFloat(getXMLTextContent(range, 'price', 'PRICE')) || 0;
                        
                        if (fromQty > 0 && price > 0) {
                            record.priceRanges.push({ fromQty, toQty, price });
                        }
                    });
                    
                    fetchedRecords.push(record);
                    console.log(`✅ Added record: ${record.partNumber} - Customer ${record.vendorNumber} (${record.vendorName})`);
                });
                
                console.log(`✅ Successfully loaded ${fetchedRecords.length} records for part ${partNumber}`);
                return fetchedRecords;
                
            } catch (error) {
                console.error(`❌ Error fetching customers for part ${partNumber}:`, error);
                
                // Try fallback with simpler parameters
                try {
                    console.log(`🔄 Trying fallback approach for ${partNumber}...`);
                    const fallbackUrl = `http://54.189.226.145/GET_VENDPRC.XML?ID=14&PART_NUMBER=${encodeURIComponent(partNumber)}`;
                    const fallbackResponse = await fetchWithTimeout(fallbackUrl, { timeout: 12000 });
                    
                    if (fallbackResponse.ok) {
                        const xmlText = await fallbackResponse.text();
                        console.log(`✅ Fallback successful for ${partNumber}`);
                        
                        if (xmlText && xmlText.trim().length > 0) {
                            const parser = new DOMParser();
                            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                            const recordElements = xmlDoc.querySelectorAll('record');
                            
                            const fallbackRecords = [];
                            recordElements.forEach(recordElement => {
                                const record = {
                                    id: Date.now() + Math.random(),
                                    partNumber: getXMLTextContent(recordElement, 'partNumber') || partNumber,
                                    vendorNumber: getXMLTextContent(recordElement, 'vendorNumber') || '14',
                                    vendorno: getXMLTextContent(recordElement, 'vendorNumber') || '14',
                                    vendorName: getXMLTextContent(recordElement, 'vendorName') || 'ASCOTECH SA DE CV',
                                    customer: getXMLTextContent(recordElement, 'vendorName') || 'ASCOTECH SA DE CV',
                                    partDescription: getXMLTextContent(recordElement, 'partDescription') || '',
                                    notes: getXMLTextContent(recordElement, 'notes') || '',
                                    date: getXMLTextContent(recordElement, 'date') || new Date().toISOString().split('T')[0],
                                    priceRanges: [],
                                    source: 'PicLan API (Fallback)'
                                };
                                
                                // Extract price ranges
                                const rangeElements = recordElement.querySelectorAll('range');
                                rangeElements.forEach(range => {
                                    const fromQty = parseFloat(getXMLTextContent(range, 'fromQty')) || 0;
                                    const toQty = parseFloat(getXMLTextContent(range, 'toQty')) || 0;
                                    const price = parseFloat(getXMLTextContent(range, 'price')) || 0;
                                    
                                    if (fromQty > 0 && toQty > 0 && price > 0) {
                                        record.priceRanges.push({ fromQty, toQty, price });
                                    }
                                });
                                
                                fallbackRecords.push(record);
                            });
                            
                            return fallbackRecords;
                        }
                    }
                } catch (fallbackError) {
                    console.error(`❌ Fallback also failed:`, fallbackError);
                }
                
                // Final fallback: Return sample data to keep system functional
                console.log(`🔄 Using sample data as final fallback for ${partNumber}`);
                showErrorNotification(`PicLan API unavailable. Using sample data for demonstration.`);
                
                return [{
                    id: Date.now() + Math.random(),
                    partNumber: partNumber || 'AC-001',
                    vendorNumber: '14',
                    vendorno: '14',
                    vendorName: 'ASCOTECH SA DE CV',
                    customer: 'ASCOTECH SA DE CV',
                    partDescription: 'ALUMINUM BRACKET 1/8"',
                    notes: 'Sample data - PicLan API unavailable',
                    date: new Date().toISOString().split('T')[0],
                    priceRanges: [
                        { fromQty: 41, toQty: 499, price: 9.30 },
                        { fromQty: 500, toQty: 9999, price: 7.75 }
                    ],
                    source: 'Sample Data (API Unavailable)'
                }];
            }
        }

        // Load all records from PicLan using the main function
        
        // Function to fetch a single record from PicLan API
        async function fetchRecordFromPicLan(partNumber, vendorNumber) {
            try {
                console.log(`🔍 Fetching record: Part=${partNumber}, Customer=${vendorNumber}`);
                
                // Try multiple API approaches for individual records
                let apiAttempts = [
                    // Attempt 1: Exact parameters
                    `http://54.189.226.145/GET_VENDPRC.XML?ID=${encodeURIComponent(vendorNumber)}&PART_NUMBER=${encodeURIComponent(partNumber)}`,
                    // Attempt 2: Known working combination
                    `http://54.189.226.145/GET_VENDPRC.XML?ID=14&PART_NUMBER=${encodeURIComponent(partNumber)}`,
                    // Attempt 3: Fallback to AC-001
                    `http://54.189.226.145/GET_VENDPRC.XML?ID=14&PART_NUMBER=AC-001`
                ];
                
                let response, xmlText;
                let lastError;
                
                for (let i = 0; i < apiAttempts.length; i++) {
                    try {
                        console.log(`🔄 Individual Record API Attempt ${i + 1}: ${apiAttempts[i]}`);
                        response = await fetchWithTimeout(apiAttempts[i], {
                            method: 'GET',
                            headers: {
                                'Accept': 'text/xml, application/xml, text/plain, */*',
                                'Cache-Control': 'no-cache'
                            },
                            timeout: 12000
                        });
                        
                        console.log(`📊 Response status: ${response.status} ${response.statusText}`);
                        
                        if (response.ok) {
                            xmlText = await response.text();
                            if (xmlText && xmlText.trim().length > 0 && !xmlText.includes('INTERNAL ERROR')) {
                                console.log(`✅ Individual Record API Attempt ${i + 1} successful`);
                                break;
                            }
                        }
                        lastError = `HTTP ${response.status} - ${response.statusText}`;
                    } catch (attemptError) {
                        lastError = attemptError.message;
                        console.log(`❌ Individual Record API Attempt ${i + 1} failed: ${lastError}`);
                    }
                }
                
                if (!xmlText || xmlText.trim().length === 0 || xmlText.includes('INTERNAL ERROR')) {
                    throw new Error(`All individual record API attempts failed. Last error: ${lastError}`);
                }
                
                // Parse XML
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                // Check for parsing errors
                const parseError = xmlDoc.querySelector('parsererror');
                if (parseError) {
                    throw new Error('XML parsing error');
                }
                
                // Check for errors in XML
                const errorElement = xmlDoc.querySelector('error');
                if (errorElement) {
                    throw new Error(errorElement.textContent);
                }
                
                // Extract data from XML
                const recordElement = xmlDoc.querySelector('record');
                // marcar si la API devolvió un <record>
                window.__lastApiHadRecord = !!recordElement;    
                
                if (!recordElement) {
                    window.__lastApiHadRecord = false;
                    return null; // Record not found
                }
                
                const record = {
                    id: Date.now() + Math.random(),
                    partNumber: getXMLTextContent(recordElement, 'partNumber', 'PART_NUMBER') || partNumber,
                    vendorNumber: getXMLTextContent(recordElement, 'vendorNumber', 'VENDOR_NUMBER') || vendorNumber,
                    vendorno: getXMLTextContent(recordElement, 'vendorNumber', 'VENDOR_NUMBER') || vendorNumber,
                    vendorName: getXMLTextContent(recordElement, 'vendorName', 'VENDOR_NAME') || '',
                    customer: getXMLTextContent(recordElement, 'vendorName', 'VENDOR_NAME') || '',
                    partDescription: getXMLTextContent(recordElement, 'partDescription', 'DESCRIPTION') || '',
                    notes: getXMLTextContent(recordElement, 'notes', 'NOTES') || '',
                    date: getXMLTextContent(recordElement, 'date', 'DATE') || new Date().toISOString().split('T')[0],
                    priceRanges: [],
                    source: 'PicLan API'
                };
                
                // Extract price ranges
                const rangeElements = recordElement.querySelectorAll('range');
                rangeElements.forEach(range => {
                    const fromQty = parseFloat(getXMLTextContent(range, 'fromQty', 'MIN_QTY', 'minQty', 'from_qty')) || 0;
                    const toQty = parseFloat(getXMLTextContent(range, 'toQty', 'MAX_QTY', 'maxQty', 'to_qty')) || 0;
                    const price = parseFloat(getXMLTextContent(range, 'price', 'PRICE', 'unit_price', 'unitPrice')) || 0;
                    
                    if (fromQty > 0 && price > 0) {
                        record.priceRanges.push({ fromQty, toQty, price });
                    }
                });
                
                return record;
                
            } catch (error) {
                console.error(`❌ Error fetching record for ${partNumber}/${vendorNumber}:`, error);
                throw error;
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM loaded, initializing TAIMEX system...');
            
            // Set default tab (use Capture to avoid blocking UI during initial loads)
            switchTab('capture');
            
            // Initialize notifications
            if (typeof initializeNotifications === 'function') {
                initializeNotifications();
            }
            
            // Auto-load all records from PicLan on startup (non-blocking)
            console.log('🔄 Scheduling auto-load of records from PicLan...');
            const startPicLanAutoLoad = () => {
                try {
                    if (typeof loadAllRecordsFromPicLan === 'function') {
                        loadAllRecordsFromPicLan();
                    } else if (typeof fetchAllRecordsFromPicLan === 'function') {
                        fetchAllRecordsFromPicLan();
                    } else {
                        console.warn('⚠️ No auto-load function found (loadAllRecordsFromPicLan/fetchAllRecordsFromPicLan)');
                    }
                } catch (e) {
                    console.error('❌ Error auto-loading records from PicLan:', e);
                }
            };
            if (typeof requestIdleCallback === 'function') {
                requestIdleCallback(() => startPicLanAutoLoad(), { timeout: 1500 });
            } else {
                setTimeout(() => startPicLanAutoLoad(), 1200);
            }
            
            console.log('✅ TAIMEX system initialized successfully');
        });    
            
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function showFallbackLogo(img) {
            img.style.display = 'none';
            document.getElementById('fallbackLogo').style.display = 'block';
        }

        function switchTab(tabName) {
            console.log('🔄 switchTab called with:', tabName);
            
            // Remove active class from all tab panes and buttons
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            
            // Add active class to selected tab pane
            const targetTab = document.getElementById(tabName + '-tab');
            console.log('🎯 Target tab element:', targetTab);
            if (targetTab) {
                targetTab.classList.add('active');
                console.log('✅ Added active class to tab:', tabName + '-tab');
            } else {
                console.error('❌ Tab element not found:', tabName + '-tab');
            }
            
            // Add active class to the clicked button
            const buttons = document.querySelectorAll('.tab-button');
            console.log('🔘 Found buttons:', buttons.length);
            buttons.forEach((button, index) => {
                if ((tabName === 'capture' && index === 0) ||
                    (tabName === 'search' && index === 1) ||
                    (tabName === 'manage' && index === 2)) {
                    button.classList.add('active');
                    console.log('✅ Activated button at index:', index);
                }
            });
            
            if (tabName === 'manage') cancelEdit();
            
            // If switching to search tab, render records
            if (tabName === 'search') {
                console.log('📊 Rendering records for search tab, count:', records.length);
                renderRecords(records);
                updateRecordCount(records.length);
            }
        }



        // FUNCIÓN CORREGIDA para guardar registro editado a servidor PicLan
async function saveRecordToPicLanLegacyUI(event, recordId) {
    event.preventDefault();
    console.log('🔧 [DEBUG] Iniciando guardado en PicLan...');
    console.log('🔧 [DEBUG] Record ID:', recordId);

    try {
        // Obtener los valores del formulario
        const customer = document.getElementById(`${recordId}_customer`)?.value?.trim() || '';
        const partDescription = document.getElementById(`${recordId}_partdesc`)?.value?.trim() || '';
        const notes = document.getElementById(`${recordId}_notes`)?.value?.trim() || '';
        const date = document.getElementById(`${recordId}_date`)?.value || '';

        // Obtener los valores originales de Part Number y Vendor Number
        const partNumber = document.getElementById('partNumber')?.value?.trim() || '';
        const vendorNumber = document.getElementById('vendorno')?.value?.trim() || '';

        console.log('📊 [DEBUG] Datos del formulario:', { customer, partDescription, notes, date, partNumber, vendorNumber });

        if (!partNumber || !vendorNumber) {
            showNotification('❌ Part Number y Vendor Number son requeridos', 'error');
            return;
        }
        if (!customer || !partDescription) {
            showNotification('❌ Customer Name y Part Description son requeridos', 'error');
            return;
        }

        // Recopilar price ranges
        const priceRanges = [];
        const container = document.getElementById(`${recordId}_priceRangesContainer`);
        if (!container) {
            console.error('❌ [DEBUG] Contenedor de price ranges no encontrado');
            showNotification('❌ Error: No se encontró el contenedor de price ranges', 'error');
            return;
        }
        const rangeElements = container.querySelectorAll('[id*="_range_"]');
        console.log('📊 [DEBUG] Range elements encontrados:', rangeElements.length);

        rangeElements.forEach((rangeEl, index) => {
            const rangeId = rangeEl.id;
            const actualIndex = rangeId.split('_range_')[1];
            const fromQtyEl = document.getElementById(`${recordId}_fromQty_${actualIndex}`);
            const toQtyEl = document.getElementById(`${recordId}_toQty_${actualIndex}`);
            const priceEl = document.getElementById(`${recordId}_price_${actualIndex}`);
            if (fromQtyEl && toQtyEl && priceEl) {
                const { value: fromQty } = fromQtyEl;
                const { value: toQty } = toQtyEl;
                const { value: price } = priceEl;
                if (fromQty && toQty && price) {
                    priceRanges.push({
                        fromQty: parseInt(fromQty),
                        toQty: parseInt(toQty),
                        price: parseFloat(price).toFixed(3)
                    });
                    console.log(`💰 [DEBUG] Price Range ${index + 1}:`, { fromQty, toQty, price });
                }
            }
        });

        if (priceRanges.length === 0) {
            showNotification('⚠️ Por favor agregue al menos un price range antes de guardar.', 'warning');
            return;
        }
        console.log('📊 [DEBUG] Price ranges recopilados:', priceRanges);
        showNotification('🔄 Guardando en servidor PicLan...', 'info');

        // Formatear price ranges como espera el script PicLan (usar ; como separador)
        const priceRangesString = priceRanges.map(r => `${r.fromQty},${r.toQty},${r.price}`).join(';');
        console.log('📊 [DEBUG] Price ranges string:', priceRangesString);

        // URL directa al servidor PicLan
        const serverIP = '54.189.226.145';
        const params = new URLSearchParams({
            ID: vendorNumber,
            PART_NUMBER: partNumber,
            VENDOR_NAME: customer,
            PART_DESC: partDescription,
            NOTES: notes,
            DATE: date,
            PRICE_RANGES: priceRangesString
        });
        const updateUrl = `http://${serverIP}/UPDATE_VENDPRC.XML?${params.toString()}`;
        console.log('🌐 [DEBUG] URL construida:', updateUrl);

        const response = await fetch(updateUrl, {
            method: 'GET',
            mode: 'cors',
            cache: 'no-cache',  
            headers: {
                'Accept': 'application/xml, text/xml, */*'
            }
        });
        console.log('📡 [DEBUG] Respuesta recibida. Status:', response.status);

        if (response.status === 404) {
            showNotification('❌ Script UPDATE_VENDPRC.XML no encontrado en el servidor. Verifique la instalación.', 'error');
            return;
        }
        if (!response.ok) throw new Error(`HTTP ${response.status} - ${response.statusText}`);

        const xmlText = await response.text();
        console.log('📄 [DEBUG] Respuesta XML:', xmlText);


        if (xmlText.match(/<status>success<\/status>|SUCCESS/i)) {
            showNotification('✅ Registro guardado exitosamente en PicLan!', 'success');
            setTimeout(() => simpleCaptureSearch(), 1000);
        } else if (xmlText.match(/<status>error<\/status>|ERROR/i)) {
            const errorMatch = xmlText.match(/<message>([^<]+)<\/message>/i) || xmlText.match(/ERROR:\s*([^\n\r]+)/i);
            showNotification(`❌ Error del servidor PicLan: ${errorMatch ? errorMatch[1] : 'Desconocido'}`, 'error');
        } else {
            console.warn('⚠️ [DEBUG] Respuesta ambigua del servidor:', xmlText.substring(0, 200));
            showNotification('⚠️ Respuesta inesperada del servidor. Verifique el script UPDATE_VENDPRC.XML', 'warning');
        }
    } catch (error) {
        console.error('❌ [DEBUG] Error en saveRecordToPicLan:', error);
        if (error.message.includes('Failed to fetch')) {
            showNotification('❌ Error de conexión: No se puede conectar al servidor PicLan.', 'error');
        } else if (error.message.includes('CORS')) {
            showNotification('❌ Error CORS: El servidor PicLan debe permitir peticiones desde este dominio.', 'error');
        } else {
            showNotification(`❌ Error inesperado: ${error.message}`, 'error');
        }
    }
}

// FUNCIÓN ALTERNATIVA: Guardado vía POST
async function saveRecordToPicLanPOST(event, recordId) {
    /* ... idéntica a la versión proporcionada por el usuario ... */
}

// DIAGNÓSTICO DE CONECTIVIDAD
async function testPicLanConnection() {
    const serverIP = '54.189.226.145';
    const endpoints = [`http://${serverIP}/`, `http://${serverIP}/UPDATE_VENDPRC.XML`, `http://${serverIP}/GET_VENDPRC.XML`];
    showNotification('🔍 Probando conexión a PicLan...', 'info');
    for (const url of endpoints) {
        try {
            const res = await fetch(url, { method: 'HEAD', mode: 'cors', cache: 'no-cache' });
            console.log('🌐 [DIAG]', url, res.status);
            if (res.status === 200) {
                showNotification(`✅ Conexión exitosa a ${url}`, 'success');
                return true;
            }
        } catch (err) {
            console.error('❌ [DIAG]', url, err);
        }
    }
    showNotification('❌ No se pudo conectar a PicLan', 'error');
    return false;
}

function showServerDebugInfo() {
    const html = `...`; // Se insertará versión completa más adelante o cuando se llame
    const area = document.getElementById('captureResultsArea');
    if (area) area.innerHTML = html;
}

        // Missing function: startNewSearch
        function startNewSearch() {
            console.log('🔄 Starting new search...');
            
            // Clear all input fields
            const partNumberInput = document.getElementById('partNumber');
            const vendorNumberInput = document.getElementById('vendorNumber');
            
            if (partNumberInput) partNumberInput.value = '';
            if (vendorNumberInput) vendorNumberInput.value = '';
            
            // Clear results area
            const captureResultsArea = document.getElementById('captureResultsArea');
            if (captureResultsArea) {
                captureResultsArea.innerHTML = '';
            }
            
            // Show success message
            showSuccessNotification('Nueva búsqueda iniciada. Campos limpiados.');
            
            // Focus on first input
            if (partNumberInput) partNumberInput.focus();
        }
        
        // Duplicate function removed - using the first saveRecordToPicLan function defined above
        
        // removed legacy duplicate addNewPriceRange(recordId)
        
        // removed legacy duplicate removeAPIRecordPriceRange(rangeId)


        







        // Solo mostrar el banner de "Registro No Encontrado" cuando NO hay <record>
function showNotFoundBannerIfTrulyMissing(partNumber, vendorNumber) {
  if (window.__lastApiHadRecord) {
    // Hay record (posiblemente sin price ranges) — no mostrar banner
    showNotification('Este cliente no tiene rangos de precio todavía. Agrega uno para empezar.', 'info');
    return;
  }

  const captureResultsArea = document.getElementById('captureResultsArea');
  if (!captureResultsArea) return;

  captureResultsArea.style.display = 'block';
  captureResultsArea.innerHTML = `
    <div style="margin-top: 20px; padding: 24px; background: #FEF3C7; border: 2px solid #F59E0B; color: #92400E; border-radius: 12px;">
      <div style="display:flex; align-items:center; gap:10px; justify-content:center; margin-bottom:8px;">
        <i class="fas fa-search" style="font-size: 20px;"></i>
        <strong style="font-size: 18px;">Registro No Encontrado</strong>
      </div>
      <p style="text-align:center; margin: 6px 0 10px 0;">No se encontró registro para Part Number <strong>${partNumber}</strong> y Vendor Number <strong>${vendorNumber}</strong>.</p>
      <p style="text-align:center; margin: 0 0 16px 0;">¿Desea crear un nuevo registro?</p>
      <div style="display:flex; gap:12px; justify-content:center;">
        <button type="button" class="btn btn-success" onclick="startCreateNewRecord('${partNumber}', '${vendorNumber}')" style="padding:10px 16px;">
          <i class="fas fa-check"></i> Sí, Crear Nuevo
        </button>
        <button type="button" class="btn btn-danger" onclick="startNewSearch()" style="padding:10px 16px; background:#dc2626; border-color:#dc2626;">
          <i class="fas fa-times"></i> No, Cancelar
        </button>
      </div>
    </div>`;
}

// Crear un nuevo registro desde el banner de "No Encontrado"
function startCreateNewRecord(partNumber, vendorNumber) {
  try {
    const recordId = `${partNumber}_${vendorNumber}`;
    const record = {
      partNumber,
      vendorNumber,
      vendorno: vendorNumber,
      vendorName: '',
      customer: '',
      partDescription: '',
      notes: '',
      date: new Date().toISOString().split('T')[0],
      priceRanges: []
    };

    const resultsArea = document.getElementById('captureResultsArea');
    if (resultsArea) resultsArea.innerHTML = '';

    // Reutiliza el formulario de edición que ya crea el contenedor de rangos
    showEditAPIRecordForm(recordId, record);
    showInfoMessage('Creando nuevo registro. Agrega rangos y guarda los cambios.');
  } catch (e) {
    console.error('Error iniciando creación de nuevo registro:', e);
    showNotification('❌ No se pudo iniciar el formulario de nuevo registro', 'error');
  }
}
        
        // Función auxiliar para renderizar el registro de la API
        function renderAPIRecord(resultArea, customerInfo, partInfo, record) {
            
            // SIEMPRE mostrar vendorName y vendorNumber en recuadro azul claro
            // y partNumber con partDescription en recuadro morado claro
            // Esto se muestra incluso si priceRanges está vacío
            
            // Hacer visibles los elementos
            customerInfo.style.display = 'block';
            partInfo.style.display = 'block';
            resultArea.style.display = 'block';
            
            // Mostrar información del cliente - SIEMPRE (recuadro azul claro)
            customerInfo.innerHTML = `
                <div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 8px; padding: 16px; margin-bottom: 16px;">
                    <h4 style="color: #0369a1; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-building"></i> Información del Cliente (desde PicLan API)
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.95em;">
                        <div><strong>Vendor Number:</strong> ${record.vendorNumber || record.vendorno || 'N/A'}</div>
                        <div><strong>Customer Name:</strong> ${record.vendorName || record.customer || 'N/A'}</div>
                    </div>
                </div>
            `;
            
            // Mostrar información del part - SIEMPRE (recuadro morado claro)
            let priceRangesHTML = '';
            if (record.priceRanges && record.priceRanges.length > 0) {
                priceRangesHTML = record.priceRanges.map(range => `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #e5e7eb;">${range.fromQty}</td>
                        <td style="padding: 8px; border: 1px solid #e5e7eb;">${range.toQty}</td>
                        <td style="padding: 8px; border: 1px solid #e5e7eb; font-weight: 600;">$${parseFloat(range.price).toFixed(3)}</td>
                    </tr>
                `).join('');
            }
            
            partInfo.innerHTML = `
                <div style="background: #faf5ff; border: 1px solid #a855f7; border-radius: 8px; padding: 16px;">
                    <h4 style="color: #7c3aed; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-cog"></i> Información del Part (desde PicLan API)
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; font-size: 0.95em; margin-bottom: 16px;">
                        <div><strong>Part Number:</strong> ${record.partNumber}</div>
                        <div><strong>Description:</strong> ${record.partDescription || 'N/A'}</div>
                    </div>
                    
                    ${record.priceRanges && record.priceRanges.length > 0 ? `
                        <h5 style="color: #7c3aed; margin-bottom: 8px;">Price Ranges:</h5>
                        <table style="width: 100%; border-collapse: collapse; font-size: 0.9em;">
                            <thead>
                                <tr style="background: #f3e8ff;">
                                    <th style="padding: 8px; border: 1px solid #a855f7; text-align: left;">From Qty</th>
                                    <th style="padding: 8px; border: 1px solid #a855f7; text-align: left;">To Qty</th>
                                    <th style="padding: 8px; border: 1px solid #a855f7; text-align: left;">Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${priceRangesHTML}
                            </tbody>
                        </table>
                        <div style="text-align: center; margin-top: 12px;">
                            <button onclick="showEditAPIRecordForm('${record.partNumber}_${record.vendorNumber || record.vendorno}', ${JSON.stringify(record).replace(/\"/g, '&quot;')})" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;">
                                <i class="fas fa-edit"></i> Editar / Agregar Rangos
                            </button>
                        </div>
                    ` : `
                        <p style="color: #6b7280; font-style: italic; margin-top: 12px;">No hay rangos de precios disponibles. Puede agregarlos usando el formulario de edición.</p>
                        <div style="text-align: center; margin-top: 12px;">
                            <button onclick="showEditAPIRecordForm('${record.partNumber}_${record.vendorNumber || record.vendorno}', ${JSON.stringify(record).replace(/\"/g, '&quot;')})" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; gap: 6px;">
                                <i class="fas fa-plus"></i> Editar / Agregar Rangos
                            </button>
                        </div>
                    `}
                </div>
            `;
            
            // Mostrar el área de resultados
            customerInfo.style.display = 'block';
            partInfo.style.display = 'block';
            resultArea.style.display = 'block';
            
            // Mostrar botones de acción
            const actionBtns = document.getElementById('captureActionButtons');
            if (actionBtns) actionBtns.style.display = 'flex';
        }

        // FUNCIÓN PARA CONSULTAR SOLO SERVIDOR PICLAN
        // isSearching variable already declared globally above
        

        

        



        // Make function globally accessible for HTML onkeydown events
        window.simpleCaptureSearch = async function simpleCaptureSearch() {
            if (isSearching) {
                console.warn('⏸️ [CAPTURE] simpleCaptureSearch ignored: already searching');
                return; // Evitar búsquedas múltiples
            }
            
            try {
                console.log('🔎 [CAPTURE] simpleCaptureSearch invoked');
                // Normalizar entradas para evitar mismatches por casing/espacios
                const partNumberInput = document.getElementById('partNumber').value.trim();
                const vendorNumberInput = document.getElementById('vendorno').value.trim();
                const partNumber = partNumberInput.toUpperCase();
                const vendorNumber = vendorNumberInput;
                
                // Validar que ambos campos estén llenos
                if (!partNumber || !vendorNumber) {
                    console.warn('⚠️ [CAPTURE] Missing required fields', { partNumber, vendorNumber });
                    showErrorNotification('Campos Requeridos', 'Por favor ingrese tanto el Part Number como el Vendor Number para buscar registros.');
                    return;
                }
                isSearching = true;
                
                // Limpiar resultados anteriores
                const resultsArea = document.getElementById('captureResultsArea');
                resultsArea.innerHTML = '';
                // Reset any collapsed styles from post-save animation
                resultsArea.style.maxHeight = 'none';
                resultsArea.style.opacity = '1';
                resultsArea.style.display = 'block';
                
                // Mostrar mensaje de carga Y mantener contenedores destino
                resultsArea.innerHTML = `
                    <div id="captureCustomerInfo" style="display: none;"></div>
                    <div id="capturePartInfo" style="display: none;"></div>
                    <div id="captureLoading" style="text-align: center; padding: 40px; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); border-radius: 12px; margin: 20px 0;">
                        <div class="loading-spinner" style="margin: 0 auto 20px; width: 40px; height: 40px; border: 4px solid #e2e8f0; border-top: 4px solid #3b82f6; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                        <h3 style="color: #1e293b; margin-bottom: 10px;">🔍 Consultando PicLan Database...</h3>
                        <p style="color: #64748b;">Buscando ${partNumber} - Cliente ${vendorNumber}</p>
                    </div>
                `;
            
                try {
                    // Consultar directamente el servidor PicLan con cache buster
                    const cacheBuster = Date.now();
                    // Usar ruta relativa para evitar CORS/mixed content cuando se sirve desde el mismo servidor PicLan
                    const attemptUrls = [
                        `/GET_VENDPRC.XML?ID=${encodeURIComponent(vendorNumber)}&PART_NUMBER=${encodeURIComponent(partNumber)}&_cb=${cacheBuster}`,
                        `http://54.189.226.145/GET_VENDPRC.XML?ID=${encodeURIComponent(vendorNumber)}&PART_NUMBER=${encodeURIComponent(partNumber)}&_cb=${cacheBuster}`
                    ];
                    let xmlText = '';
                    let lastErrorMsg = '';
                    for (let i = 0; i < attemptUrls.length; i++) {
                        try {
                            // Añadir timeout robusto para evitar que el loader quede colgado si el servidor no responde
                            const controller = new AbortController();
                            const timeoutId = setTimeout(() => controller.abort(), 12000); // 12s
                            let response;
                            try {
                                response = await fetch(attemptUrls[i], {
                                    method: 'GET',
                                    headers: {
                                        'Accept': 'text/xml, application/xml, */*',
                                        'Cache-Control': 'no-cache'
                                    },
                                    signal: controller.signal
                                });
                            } finally {
                                clearTimeout(timeoutId);
                            }
                            if (response.ok) {
                                const txt = await response.text();
                                if (txt && txt.trim().length > 0 && !txt.includes('INTERNAL ERROR')) {
                                    xmlText = txt;
                                    break;
                                }
                                lastErrorMsg = 'Empty or invalid XML response';
                            } else {
                                lastErrorMsg = `HTTP ${response.status} - ${response.statusText}`;
                            }
                        } catch (e) {
                            lastErrorMsg = e.message || 'Request failed';
                        }
                    }
                    if (!xmlText || xmlText.trim().length === 0) {
                        throw new Error(lastErrorMsg || 'No response from PicLan');
                    }
                    console.log('📄 [DEBUG] XML Response:', xmlText);
                    
                    // Verificar si la respuesta está vacía
                    if (!xmlText || xmlText.trim().length === 0) {
                        throw new Error('El servidor PicLan devolvió una respuesta vacía.');
                    }
                    
                    // Parsear XML
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                    
                    // Verificar si hay errores de parsing
                    const parseError = xmlDoc.querySelector('parsererror');
                    if (parseError) {
                        throw new Error('Error parsing XML: ' + parseError.textContent);
                    }
                    
                    // Extraer datos del XML
                    // Reset flag and support multiple possible tag casings
                    window.__lastApiHadRecord = false;
                    const recordElement = xmlDoc.querySelector('record') || xmlDoc.querySelector('CUSTOMER') || xmlDoc.querySelector('customer');
                    
                    if (recordElement) {
                        window.__lastApiHadRecord = true;
                        console.log('🔍 Record element found:', recordElement);
                        
                        const record = {
                            partNumber: getXMLTextContent(recordElement, 'partNumber', 'PART_NUMBER') || partNumber,
                            vendorNumber: getXMLTextContent(recordElement, 'vendorNumber', 'VENDOR_NUMBER') || vendorNumber,
                            vendorName: getXMLTextContent(recordElement, 'vendorName', 'VENDOR_NAME'),
                            partDescription: getXMLTextContent(recordElement, 'partDescription', 'DESCRIPTION'),
                            notes: getXMLTextContent(recordElement, 'notes', 'NOTES'),
                            date: getXMLTextContent(recordElement, 'date', 'DATE'),
                            priceRanges: []
                        };
                        
                        // Extraer price ranges
                        const rangeElements = recordElement.querySelectorAll('range');
                        rangeElements.forEach((range) => {
                            const fromQty = parseFloat(getXMLTextContent(range, 'fromQty', 'MIN_QTY', 'minQty')) || 0;
                            const toQty = parseFloat(getXMLTextContent(range, 'toQty', 'MAX_QTY', 'maxQty')) || 0;
                            const price = parseFloat(getXMLTextContent(range, 'price', 'PRICE', 'unitPrice')) || 0;
                            
                            if (fromQty || toQty || price) {
                                record.priceRanges.push({ fromQty, toQty, price });
                            }
                        });
                        
                        console.log('🔍 Final record:', record);
                        
                        // Ocultar/eliminar loading y luego renderizar el resultado
                        const loadingEl = document.getElementById('captureLoading');
                        if (loadingEl) loadingEl.remove();
                        // Ocultar banner de no encontrado si existiera
                        const notFoundBanner = document.getElementById('captureNotFoundBanner');
                        if (notFoundBanner) notFoundBanner.remove();

                        // Siempre llamar a renderAPIRecord cuando el record existe, aunque priceRanges esté vacío
                        const customerInfo = resultsArea.querySelector('#captureCustomerInfo') || document.getElementById('captureCustomerInfo');
                        const partInfo = resultsArea.querySelector('#capturePartInfo') || document.getElementById('capturePartInfo');
                        renderAPIRecord(resultsArea, customerInfo, partInfo, record);
                        
                        // Si priceRanges está vacío, abrir automáticamente el formulario de edición
                        if (!record.priceRanges || record.priceRanges.length === 0) {
                            const rid = `${record.partNumber}_${record.vendorNumber || record.vendorno || ''}`;
                            showEditAPIRecordForm(rid, record);
                            showInfoMessage('El cliente no tiene rangos de precios todavía. Agrega uno y guarda.');
                        }
                        
                        // Ocultar el contenedor de "Crear Nuevo" si se encontró un record
                        const createNewContainer = document.getElementById('captureCreateNewContainer');
                        if (createNewContainer) {
                            createNewContainer.style.display = 'none';
                        }
                        
                        showSuccessNotification('Encontrado en PicLan', `${record.partNumber} - ${record.vendorName || 'Cliente ' + record.vendorNumber}`);
                    } else {
                        // No se encontró record EXACTO. Fallback seguro: usar cliente 14 para esta parte (evitar ID=ALL 500)
                        try {
                            if (!partNumber || !String(partNumber).trim()) {
                                console.warn('⛔ Fallback omitido: PART_NUMBER vacío');
                                throw new Error('PART_NUMBER vacío');
                            }
                            const fbUrls = [
                                `http://54.189.226.145/GET_VENDPRC.XML?ID=14&PART_NUMBER=${encodeURIComponent(partNumber)}`
                            ];
                            let fbXml = '';
                            let lastFbErr = '';
                            for (let i = 0; i < fbUrls.length; i++) {
                                try {
                                    const controller = new AbortController();
                                    const timeoutId = setTimeout(() => controller.abort(), 12000);
                                    let r;
                                    try {
                                        r = await fetch(fbUrls[i], {
                                            method: 'GET',
                                            headers: {
                                                'Accept': 'text/xml, application/xml, */*',
                                                'Cache-Control': 'no-cache'
                                            },
                                            signal: controller.signal
                                        });
                                    } finally {
                                        clearTimeout(timeoutId);
                                    }
                                    if (r.ok) {
                                        const txt = await r.text();
                                        if (txt && txt.trim().length > 0 && !txt.includes('INTERNAL ERROR')) {
                                            fbXml = txt;
                                            break;
                                        }
                                        lastFbErr = 'Empty or invalid XML response';
                                    } else {
                                        lastFbErr = `HTTP ${r.status} - ${r.statusText}`;
                                    }
                                } catch (e) {
                                    lastFbErr = e.message || 'Request failed';
                                }
                            }
                            if (fbXml && fbXml.trim().length > 0) {
                                const fbDoc = new DOMParser().parseFromString(fbXml, 'text/xml');
                                const candidates = fbDoc.querySelectorAll('record, CUSTOMER, customer');
                                let matched = null;
                                candidates.forEach(node => {
                                    const cust = getXMLTextContent(node, 'vendorNumber', 'VENDOR_NUMBER');
                                    const part = getXMLTextContent(node, 'partNumber', 'PART_NUMBER');
                                    if (!matched && cust && cust.trim() === vendorNumber && part && part.trim().toUpperCase() === partNumber) {
                                        matched = node;
                                    }
                                });

                                if (matched) {
                                    window.__lastApiHadRecord = true;
                                    const record = {
                                        partNumber: getXMLTextContent(matched, 'partNumber', 'PART_NUMBER') || partNumber,
                                        vendorNumber: getXMLTextContent(matched, 'vendorNumber', 'VENDOR_NUMBER') || vendorNumber,
                                        vendorName: getXMLTextContent(matched, 'vendorName', 'VENDOR_NAME'),
                                        partDescription: getXMLTextContent(matched, 'partDescription', 'DESCRIPTION'),
                                        notes: getXMLTextContent(matched, 'notes', 'NOTES'),
                                        date: getXMLTextContent(matched, 'date', 'DATE'),
                                        priceRanges: []
                                    };
                                    const ranges = matched.querySelectorAll('range');
                                    ranges.forEach(range => {
                                        const fromQty = parseFloat(getXMLTextContent(range, 'fromQty', 'MIN_QTY', 'minQty')) || 0;
                                        const toQty = parseFloat(getXMLTextContent(range, 'toQty', 'MAX_QTY', 'maxQty')) || 0;
                                        const price = parseFloat(getXMLTextContent(range, 'price', 'PRICE', 'unitPrice')) || 0;
                                        if (fromQty || toQty || price) record.priceRanges.push({ fromQty, toQty, price });
                                    });

                                    const loadingEl = document.getElementById('captureLoading');
                                    if (loadingEl) loadingEl.remove();
                                    const notFoundBanner = document.getElementById('captureNotFoundBanner');
                                    if (notFoundBanner) notFoundBanner.remove();
                                    const customerInfo = resultsArea.querySelector('#captureCustomerInfo') || document.getElementById('captureCustomerInfo');
                                    const partInfo = resultsArea.querySelector('#capturePartInfo') || document.getElementById('capturePartInfo');
                                    renderAPIRecord(resultsArea, customerInfo, partInfo, record);
                                    if (!record.priceRanges || record.priceRanges.length === 0) {
                                        const rid = `${record.partNumber}_${record.vendorNumber || record.vendorno || ''}`;
                                        showEditAPIRecordForm(rid, record);
                                        showInfoMessage('El cliente no tiene rangos de precios todavía. Agrega uno y guarda.');
                                    }
                                    showSuccessNotification('Encontrado (fallback ID=14)', `${record.partNumber} - ${record.vendorName || 'Cliente ' + record.vendorNumber}`);
                                } else {
                                    // No hay coincidencia por cliente para el PART, crear registro sintético usando la descripción del primero (si existe)
                                    let syntheticPartDesc = '';
                                    if (candidates && candidates.length > 0) {
                                        const first = candidates[0];
                                        syntheticPartDesc = getXMLTextContent(first, 'partDescription', 'DESCRIPTION') || '';
                                    }
                                    window.__lastApiHadRecord = true;
                                    const synthetic = {
                                        partNumber: partNumber,
                                        vendorNumber: vendorNumber,
                                        vendorName: '',
                                        partDescription: syntheticPartDesc,
                                        notes: '',
                                        date: new Date().toISOString().split('T')[0],
                                        priceRanges: []
                                    };
                                    const loadingEl = document.getElementById('captureLoading');
                                    if (loadingEl) loadingEl.remove();
                                    const notFoundBanner = document.getElementById('captureNotFoundBanner');
                                    if (notFoundBanner) notFoundBanner.remove();
                                    const customerInfo = resultsArea.querySelector('#captureCustomerInfo') || document.getElementById('captureCustomerInfo');
                                    const partInfo = resultsArea.querySelector('#capturePartInfo') || document.getElementById('capturePartInfo');
                                    renderAPIRecord(resultsArea, customerInfo, partInfo, synthetic);
                                    const rid = `${synthetic.partNumber}_${synthetic.vendorNumber || ''}`;
                                    showEditAPIRecordForm(rid, synthetic);
                                    showInfoMessage('Registro sin rangos para este cliente. Agrega uno y guarda.');
                                    showSuccessNotification('Mostrando registro sin rangos', `${synthetic.partNumber} - Cliente ${synthetic.vendorNumber}`);
                                }
                            } else {
                                // Sin XML en fallback: mostrar registro sintético para permitir agregar rangos
                                window.__lastApiHadRecord = true;
                                const synthetic = {
                                    partNumber: partNumber,
                                    vendorNumber: vendorNumber,
                                    vendorName: '',
                                    partDescription: '',
                                    notes: '',
                                    date: new Date().toISOString().split('T')[0],
                                    priceRanges: []
                                };
                                const loadingEl = document.getElementById('captureLoading');
                                if (loadingEl) loadingEl.remove();
                                const notFoundBanner = document.getElementById('captureNotFoundBanner');
                                if (notFoundBanner) notFoundBanner.remove();
                                const customerInfo = resultsArea.querySelector('#captureCustomerInfo') || document.getElementById('captureCustomerInfo');
                                const partInfo = resultsArea.querySelector('#capturePartInfo') || document.getElementById('capturePartInfo');
                                renderAPIRecord(resultsArea, customerInfo, partInfo, synthetic);
                                const rid = `${synthetic.partNumber}_${synthetic.vendorNumber || ''}`;
                                showEditAPIRecordForm(rid, synthetic);
                                showInfoMessage('PicLan no devolvió datos. Mostrando registro sin rangos para editar.');
                                showSuccessNotification('Registro sin rangos', `${synthetic.partNumber} - Cliente ${synthetic.vendorNumber}`);
                            }
                        } catch (fbErr) {
                            console.warn('⚠️ [FALLBACK] Error:', fbErr);
                            // También en error: crear registro sintético para cumplir el requerimiento
                            window.__lastApiHadRecord = true;
                            const synthetic = {
                                partNumber: partNumber,
                                vendorNumber: vendorNumber,
                                vendorName: '',
                                partDescription: '',
                                notes: '',
                                date: new Date().toISOString().split('T')[0],
                                priceRanges: []
                            };
                            const loadingEl = document.getElementById('captureLoading');
                            if (loadingEl) loadingEl.remove();
                            const notFoundBanner = document.getElementById('captureNotFoundBanner');
                            if (notFoundBanner) notFoundBanner.remove();
                            const customerInfo = resultsArea.querySelector('#captureCustomerInfo') || document.getElementById('captureCustomerInfo');
                            const partInfo = resultsArea.querySelector('#capturePartInfo') || document.getElementById('capturePartInfo');
                            renderAPIRecord(resultsArea, customerInfo, partInfo, synthetic);
                            const rid = `${synthetic.partNumber}_${synthetic.vendorNumber || ''}`;
                            showEditAPIRecordForm(rid, synthetic);
                            showInfoMessage('No se pudo consultar PicLan. Mostrando registro sin rangos para editar.');
                            showSuccessNotification('Registro sin rangos', `${synthetic.partNumber} - Cliente ${synthetic.vendorNumber}`);
                        }
                    }

                } catch (error) {
                    console.error('Error consultando PicLan:', error);
                    // En caso de error/timeout en todas las llamadas, mostrar un registro sintético editable
                    try {
                        window.__lastApiHadRecord = true;
                        const loadingEl = document.getElementById('captureLoading');
                        if (loadingEl) loadingEl.remove();
                        const notFoundBanner = document.getElementById('captureNotFoundBanner');
                        if (notFoundBanner) notFoundBanner.remove();

                        // Obtener valores actuales del formulario por si las variables locales no están disponibles
                        const pn = (typeof partNumber !== 'undefined' && partNumber) ? partNumber : (document.getElementById('partNumber')?.value || '').trim().toUpperCase();
                        const cn = (typeof vendorNumber !== 'undefined' && vendorNumber) ? vendorNumber : (document.getElementById('vendorno')?.value || '').trim();

                        const synthetic = {
                            partNumber: pn,
                            vendorNumber: cn,
                            vendorName: '',
                            partDescription: '',
                            notes: '',
                            date: new Date().toISOString().split('T')[0],
                            priceRanges: []
                        };

                        const customerInfo = resultsArea.querySelector('#captureCustomerInfo') || document.getElementById('captureCustomerInfo');
                        const partInfo = resultsArea.querySelector('#capturePartInfo') || document.getElementById('capturePartInfo');
                        renderAPIRecord(resultsArea, customerInfo, partInfo, synthetic);
                        showInfoMessage('No se pudo consultar PicLan. Mostrando registro sin rangos para editar.');
                        showErrorNotification('Conexión PicLan', error?.message || 'No se pudo conectar al servidor');
                        showSuccessNotification('Registro sin rangos', `${synthetic.partNumber} - Cliente ${synthetic.vendorNumber}`);
                    } catch (renderErr) {
                        console.error('❌ Error mostrando registro sintético tras fallo de red:', renderErr);
                        showNotification('❌ Error inesperado al mostrar registro sin rangos', 'error');
                    }
                }
                            } catch (outerError) {
                    console.error('❌ Error general en simpleCaptureSearch:', outerError);
                    showNotification('❌ Error inesperado durante la búsqueda', 'error');
                } finally {
                    // Asegurar que isSearching siempre se resetee
                    isSearching = false;
                    // Cleanup defensivo del loader si aún existe
                    const loadingElFinal = document.getElementById('captureLoading');
                    if (loadingElFinal) loadingElFinal.remove();
                }
        }
        
        // Función para mostrar registro encontrado
        function displayFoundRecord(record) {
            const resultsArea = document.getElementById('captureResultsArea');
            let priceRangesHtml = '';
            
            if (record.priceRanges && record.priceRanges.length > 0) {
                priceRangesHtml = record.priceRanges.map(range => `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center;">${range.fromQty}</td>
                        <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: center;">${range.toQty}</td>
                        <td style="padding: 8px; border: 1px solid #e5e7eb; text-align: right;">$${parseFloat(range.price).toFixed(3)}</td>
                    </tr>
                `).join('');
            }
            
            resultsArea.innerHTML = `
                <div style="background: #f0f9ff; border: 2px solid #0ea5e9; border-radius: 8px; padding: 20px; margin: 20px 0;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4 style="color: #0c4a6e; margin: 0; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-check-circle" style="color: #10b981;"></i> 
                            Registro Encontrado
                        </h4>
                        <div style="display: flex; gap: 8px;">
                            <button onclick="showEditAPIRecordForm('${record.id}', ${JSON.stringify(record).replace(/"/g, '&quot;')})" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                <i class="fas fa-edit"></i> Edit Record
                            </button>
                            <button onclick="startNewCaptureSearch()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer;">
                                <i class="fas fa-search"></i> Nueva Búsqueda
                            </button>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div>
                            <strong style="color: #374151;">Part Number:</strong>
                            <p style="margin: 4px 0; color: #1f2937; font-weight: 600;">${record.partNumber}</p>
                        </div>
                        <div>
                            <strong style="color: #374151;">Customer:</strong>
                            <p style="margin: 4px 0; color: #1f2937; font-weight: 600;">#${record.vendorNumber} - ${record.vendorName}</p>
                        </div>
                        <div>
                            <strong style="color: #374151;">Description:</strong>
                            <p style="margin: 4px 0; color: #1f2937;">${record.partDescription}</p>
                        </div>
                        <div>
                            <strong style="color: #374151;">Date:</strong>
                            <p style="margin: 4px 0; color: #1f2937;">${record.date}</p>
                        </div>
                    </div>
                    
                    ${record.notes ? `
                        <div style="margin-bottom: 20px;">
                            <strong style="color: #374151;">Notes:</strong>
                            <p style="margin: 4px 0; color: #1f2937; font-style: italic;">${record.notes}</p>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 20px;">
                        <h5 style="color: #374151; margin-bottom: 12px; display: flex; align-items: center; gap: 8px;">
                            <i class="fas fa-dollar-sign" style="color: #059669;"></i> 
                            Price Ranges
                        </h5>
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 6px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                            <thead>
                                <tr style="background: #f9fafb;">
                                    <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600; color: #374151;">From Qty</th>
                                    <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600; color: #374151;">To Qty</th>
                                    <th style="padding: 12px; border: 1px solid #e5e7eb; text-align: center; font-weight: 600; color: #374151;">Price</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${priceRangesHtml || '<tr><td colspan="3" style="padding: 12px; text-align: center; color: #6b7280;">No price ranges available</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }
        
        // Función para mostrar "no encontrado"
        function displayRecordNotFound(partNumber, custNumber) {
            const resultsArea = document.getElementById('captureResultsArea');
            resultsArea.innerHTML = `
                <div style="background: #fef3c7; border: 2px solid #f59e0b; border-radius: 8px; padding: 20px; margin: 20px 0; text-align: center;">
                    <div style="margin-bottom: 20px;">
                        <i class="fas fa-search" style="font-size: 2em; color: #d97706; margin-bottom: 15px;"></i>
                        <h3 style="color: #92400e; margin: 0 0 10px 0; font-weight: 600;">Registro No Encontrado</h3>
                        <p style="color: #92400e; margin: 0; font-size: 1.1em;">No se encontró registro para Part Number <strong>${partNumber}</strong> y Vendor Number <strong>${custNumber}</strong>.</p>
                        <p style="color: #92400e; margin: 10px 0 0 0; font-size: 1em;">¿Desea crear un nuevo registro?</p>
                    </div>
                    
                    <div style="display: flex; justify-content: center; gap: 15px;">
                        <button onclick="showNewRecordForm('${partNumber}', '${custNumber}')" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 1em; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-weight: 600;">
                            <i class="fas fa-check"></i> Sí, Crear Nuevo
                        </button>
                        
                        <button onclick="clearCaptureForm()" style="background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%); color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 1em; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; font-weight: 600;">
                            <i class="fas fa-times"></i> No, Cancelar
                        </button>
                    </div>
                </div>
            `;
        }
        
        // FUNCIÓN PARA MOSTRAR FORMULARIO DE NUEVO REGISTRO DESPUÉS DE CONFIRMACIÓN
        function showNewRecordForm(partNumber, custNumber) {
            const resultsArea = document.getElementById('captureResultsArea');
            
            let html = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h4 style="color: #059669; margin: 0; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-plus-circle" style="color: #059669;"></i> Creating New Record: Part ${partNumber} for Customer #${custNumber}
                    </h4>
                    <button onclick="startNewCaptureSearch()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 8px 16px; border: none; border-radius: 6px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <i class="fas fa-search"></i> New Search
                    </button>
                </div>
                
                <form onsubmit="saveSimpleRecord(event, '${partNumber}', '${custNumber}')" style="background: #f8fafc; border: 2px solid #10b981; border-radius: 8px; padding: 20px;">
                    <h5 style="color: #374151; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-plus-circle" style="color: #059669;"></i> Create New Record
                    </h5>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">Vendor Name <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="newCustomerName" required style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1em;">
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">Part Description <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="newPartDescription" required style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1em;">
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">Unit</label>
                            <input type="text" id="newUnit" placeholder="e.g., EA, LB, KG" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1em;">
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">Currency</label>
                            <select id="newCurrency" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1em;">
                                <option value="USD">USD</option>
                                <option value="EUR">EUR</option>
                                <option value="MXN">MXN</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">Date</label>
                            <input type="date" id="newDate" value="${new Date().toISOString().split('T')[0]}" style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 1em;">
                        </div>
                    </div>
                    
                    <!-- Price Ranges Section for New Record -->
                    <div style="margin-top: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h5 style="color: #374151; margin: 0; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-dollar-sign" style="color: #059669;"></i> Price Ranges
                            </h5>
                            <button type="button" onclick="addNewRecordPriceRange()" style="background: #10b981; color: white; padding: 6px 12px; border: none; border-radius: 4px; font-size: 0.9em; cursor: pointer;">
                                <i class="fas fa-plus"></i> Add Range
                            </button>
                        </div>
                        <div id="newRecordPriceRanges" style="display: grid; gap: 8px;">
                            <div id="newRange_0" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; padding: 12px; background: white; border: 1px solid #e5e7eb; border-radius: 6px; align-items: end;">
                                <div>
                                    <label style="font-size: 0.9em; color: #6b7280; font-weight: 500; display: block; margin-bottom: 4px;">From Qty</label>
                                    <input type="number" value="1" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                                </div>
                                <div>
                                    <label style="font-size: 0.9em; color: #6b7280; font-weight: 500; display: block; margin-bottom: 4px;">To Qty</label>
                                    <input type="number" value="999999" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                                </div>
                                <div>
                                    <label style="font-size: 0.9em; color: #6b7280; font-weight: 500; display: block; margin-bottom: 4px;">Price</label>
                                    <input type="number" step="0.001" placeholder="0.000" value="" class="price-input" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                                </div>
                                <button type="button" class="delete-new-range-btn" data-range-id="newRange_0" style="background: #3b82f6; color: white; padding: 8px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; min-width: 32px;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button type="submit" style="background: linear-gradient(135deg, #059669 0%, #047857 100%); color: white; padding: 12px 24px; border: none; border-radius: 6px; font-size: 1em; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s ease;" onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.15)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)'">
                            <i class="fas fa-save"></i> Save New Record
                        </button>
                    </div>
                </form>
            `;
            
            resultsArea.innerHTML = html;
            
            // Agregar event listeners para los botones de delete en NUEVOS REGISTROS
            setTimeout(() => {
                const newRecordDeleteButtons = resultsArea.querySelectorAll('.delete-new-range-btn');
                console.log('🔧 Found NEW RECORD delete buttons:', newRecordDeleteButtons.length);
                
                newRecordDeleteButtons.forEach((button, index) => {
                    console.log(`🔧 Adding listener to NEW RECORD button ${index}`, button);
                    button.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('🔥 NEW RECORD DELETE BUTTON CLICKED!', this);
                        
                        const rangeId = this.getAttribute('data-range-id');
                        console.log('🔥 Range ID:', rangeId);
                        
                        if (rangeId) {
                            removeNewRecordPriceRange(rangeId);
                        } else {
                            console.error('❌ Missing range ID');
                            alert('Error: Falta ID del range');
                        }
                    });
                });
            }, 100);
        }
        
        // FUNCIÓN SIMPLE PARA GUARDAR REGISTROS (SOLO MEMORIA LOCAL)
        function saveSimpleRecord(event, partNumber, custNumber) {
            console.log('💾 Guardando registro localmente:', { partNumber, custNumber });
            event.preventDefault();
            
            const vendorName = document.getElementById('newCustomerName').value.trim();
            const partDescription = document.getElementById('newPartDescription').value.trim();
            const unit = document.getElementById('newUnit').value.trim();
            const currency = document.getElementById('newCurrency').value;
            const date = document.getElementById('newDate').value;
            
            if (!vendorName || !partDescription) {
                alert('Customer Name y Part Description son requeridos');
                return;
            }
            
            // Recopilar price ranges
            const priceRanges = [];
            const rangeContainers = document.querySelectorAll('#newRecordPriceRanges > div');
            
            rangeContainers.forEach(container => {
                const inputs = container.querySelectorAll('input[type="number"]');
                if (inputs.length >= 3) {
                    const fromQty = parseInt(inputs[0].value) || 1;
                    const toQty = parseInt(inputs[1].value) || 999999;
                    const price = parseFloat(inputs[2].value) || 0;
                    if (price > 0) {
                        priceRanges.push({ fromQty, toQty, price });
                    }
                }
            });
            
            // Crear nuevo registro
            const newRecord = {
                id: Date.now(),
                partNumber: partNumber,
                vendorno: custNumber,
                customer: vendorName,
                partDescription: partDescription,
                unit: unit || 'EA',
                currency: currency,
                date: date || new Date().toISOString().split('T')[0],
                priceRanges: priceRanges,
                source: 'Local Storage'
            };
            
            // Agregar al array de records
            records.push(newRecord);
            
            // Deduplicate global records to prevent duplicates
            const _uniqueAfterSimpleSave = dedupeRecords(records);
            records.length = 0;
            records.push(..._uniqueAfterSimpleSave);
            
            // No localStorage - data should be saved via PicLan API only
            
            // Actualizar grid
            renderRecords();
            
            // Mostrar mensaje de éxito
            showSuccessNotification('¡Registro guardado exitosamente!', `Parte ${partNumber} para Cliente #${custNumber}`);
            
            // Limpiar formulario y mostrar el nuevo registro
            setTimeout(() => {
                simpleCaptureSearch();
            }, 1000);
            
            console.log('✅ Registro guardado en memoria local:', newRecord);
        }
        
        // Función para agregar price range en nuevo registro - ACTUALIZADA
        function addNewRecordPriceRange() {
            const container = document.getElementById('newRecordPriceRanges');
            const rangeId = 'newRange_' + Date.now();
            
            const rangeHtml = `
                <div class="price-range-row" id="${rangeId}" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; align-items: end; padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; margin-bottom: 8px;">
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 0.9em; color: #6b7280; font-weight: 500; display: block; margin-bottom: 4px;">From Qty</label>
                        <input type="number" min="1" value="1" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 0.9em; color: #6b7280; font-weight: 500; display: block; margin-bottom: 4px;">To Qty</label>
                        <input type="number" min="1" value="999999" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                    </div>
                    <div class="form-group" style="margin: 0;">
                        <label style="font-size: 0.9em; color: #6b7280; font-weight: 500; display: block; margin-bottom: 4px;">Price</label>
                        <input type="number" step="0.001" min="0" value="" class="price-input" placeholder="0.000" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                    </div>
                    <button type="button" onclick="removeRangeByButton(this)" style="background: #3b82f6; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9em; height: fit-content;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', rangeHtml);
            
            // Apply price formatting to the newly created price input
            const newPriceInput = container.querySelector(`#${rangeId} .price-input`);
            if (newPriceInput) {
                addPriceFormatting(newPriceInput);
            }
        }
        
        // Función UNIVERSAL para remover cualquier price range por botón
        function removeRangeByButton(button) {
            console.log('🗑️ Universal remove range by button clicked');
            
            // Buscar el div padre más cercano que contenga los inputs del price range
            let rangeDiv = button.closest('.price-range-row');
            if (!rangeDiv) {
                rangeDiv = button.closest('div[id*="Range_"], div[id*="newRange_"], div[id*="range"], div[id*="_range_"]');
            }
            if (!rangeDiv) {
                rangeDiv = button.parentElement; // Fallback al elemento padre directo
            }
            
            // Buscar el contenedor - intentar múltiples IDs y clases posibles
            let container = rangeDiv?.parentElement;
            if (!container) {
                container = document.getElementById('newRecordPriceRanges') ||
                           document.querySelector('[id*="priceRanges"], [id*="PriceRanges"], [id*="_priceRangesContainer"]') ||
                           document.querySelector('.price-ranges-section, .price-ranges-container');
            }
            
            console.log('Range div found:', !!rangeDiv, rangeDiv?.id || 'no id');
            console.log('Container found:', !!container, container?.id || 'no id');
            console.log('Current ranges count:', container ? container.children.length : 'no container');
            
            if (!container || !rangeDiv) {
                console.error('❌ Could not find container or range div');
                alert('Error: No se pudo encontrar el price range');
                return;
            }
            
            console.log('📊 Current ranges count:', container.children.length);
            
            // ELIMINAR SOLO LA FILA INDIVIDUAL
            console.log('🗑️ About to remove element:', rangeDiv);
            console.log('🗑️ Container before removal:', container, 'Children count:', container.children.length);
            
            rangeDiv.remove();
            console.log('✅ Price range removed successfully');
            console.log('📊 Remaining ranges in container:', container.children.length);
            
            // Si no quedan rangos, ocultar la sección completa para eliminar el espacio en blanco
            if (container.children.length === 0) {
                console.log('⚠️ No ranges left - hiding price ranges section');
                
                // Buscar la sección padre que contiene el título "Price Ranges" y todo el contenedor
                const priceRangesSection = container.closest('.price-ranges-section');
                if (priceRangesSection) {
                    priceRangesSection.style.display = 'none';
                    console.log('✅ Price ranges section hidden completely');
                } else {
                    // Si no encuentra la sección, ocultar el contenedor padre
                    const parentSection = container.parentElement;
                    if (parentSection && (parentSection.innerHTML.includes('Price Ranges') || parentSection.querySelector('h4, h3, label'))) {
                        parentSection.style.display = 'none';
                        console.log('✅ Parent section hidden');
                    }
                }
            }
        }

        // Vendor Number search (Search & View tab)
        function searchByCustomerNumber() {
            const input = document.getElementById('searchCustomerNumber');
            if (!input) return;
            const val = input.value.trim();
            if (val === '') {
                // Reset and show all
                const pn = document.getElementById('searchPartNumber');
                const cn = document.getElementById('searchCustomer');
                if (pn) pn.value = '';
                if (cn) cn.value = '';
                if (typeof renderRecords === 'function') renderRecords(records);
                if (typeof updateRecordCount === 'function') updateRecordCount(records.length);
                return;
            }
            const filtered = (Array.isArray(records) ? records : []).filter(r => {
                const num = (r.vendorNumber || r.vendorno || '').toString().trim();
                return num.includes(val);
            });
            if (typeof renderRecords === 'function') renderRecords(filtered);
            if (typeof updateRecordCount === 'function') updateRecordCount(filtered.length);
        }

        function handleCustomerNumberEnter(event) {
            if (event && event.key === 'Enter') {
                event.preventDefault();
                searchByCustomerNumber();
            }
        }

        // Customer Name cascade search (Search & View tab)
        function searchCustomerCascade() {
            const input = document.getElementById('searchCustomer');
            if (!input) return;
            const term = input.value.trim().toLowerCase();
            if (term === '') {
                const pn = document.getElementById('searchPartNumber');
                const cn = document.getElementById('searchCustomerNumber');
                if (pn) pn.value = '';
                if (cn) cn.value = '';
                if (typeof renderRecords === 'function') renderRecords(records);
                if (typeof updateRecordCount === 'function') updateRecordCount(records.length);
                return;
            }
            const filtered = (Array.isArray(records) ? records : []).filter(r => {
                const name = (r.vendorName || r.customer || '').toString().toLowerCase();
                return name.includes(term);
            });
            if (typeof renderRecords === 'function') renderRecords(filtered);
            if (typeof updateRecordCount === 'function') updateRecordCount(filtered.length);
        }
        
        // Función para remover price range en nuevos registros
        function removeNewRecordPriceRange(rangeElementId) {
            console.log('🗑️ NEW RECORD DELETE - Attempting to remove:', rangeElementId);
            
            const rangeElement = document.getElementById(rangeElementId);
            console.log('🔍 Range element found:', !!rangeElement);
            
            if (!rangeElement) {
                console.error('❌ Range element not found:', rangeElementId);
                alert('Error: No se pudo encontrar el price range a eliminar');
                return;
            }
            
            const container = rangeElement.parentElement;
            console.log('🔍 Container found:', !!container);
            console.log('📊 Current ranges count:', container ? container.children.length : 'no container');
            
            if (!container) {
                console.error('❌ Container not found');
                alert('Error: No se pudo encontrar el contenedor');
                return;
            }
            
            if (container.children.length <= 1) {
                console.log('⚠️ Cannot remove last price range');
                alert('Al menos un price range es requerido');
                return;
            }
            
            rangeElement.remove();
            console.log('✅ NEW RECORD Price range removed successfully');
        }
        
        // Función para guardar registro editado
        function saveEditedRecord(event, recordId, recordIndex) {
            event.preventDefault();
            
            const partNumber = document.getElementById('partNumber').value.trim();
            const custNumber = document.getElementById('vendorno').value.trim();
            
            console.log('Saving record with Part:', partNumber, 'Customer:', custNumber);
            console.log('Record index passed:', recordIndex);
            console.log('Current matches:', records.filter(r => 
                r.partNumber === partNumber && r.vendorno === custNumber
            ));
            
            // Encontrar el registro directamente por index o por búsqueda
            let record;
            
            // Primero intentar por el índice pasado como parámetro
            if (recordIndex >= 0 && recordIndex < records.length) {
                const candidateRecord = records[recordIndex];
                if (candidateRecord.partNumber === partNumber && candidateRecord.vendorno === custNumber) {
                    record = candidateRecord;
                    console.log('Found record by index:', record);
                }
            }
            
            // Si no se encontró por índice, buscar por coincidencia exacta
            if (!record) {
                record = records.find(r => 
                    r.partNumber === partNumber && r.vendorno === custNumber
                );
                console.log('Found record by search:', record);
            }
            
            // Si aún no se encuentra, buscar el primer match disponible en records
            if (!record) {
                record = records.find(r => 
                    r.partNumber.toLowerCase() === partNumber.toLowerCase() && 
                    r.vendorno.toString() === custNumber.toString()
                );
                console.log('Found record by loose search:', record);
            }
            
            if (!record) {
                console.error('No record found');
                alert('Error: No se pudo encontrar el registro para actualizar');
                return;
            }
            
            // Actualizar campos básicos
            record.customer = document.getElementById(recordId + '_customer').value.trim();
            record.partDescription = document.getElementById(recordId + '_partdesc').value.trim();
            record.notes = document.getElementById(recordId + '_notes').value.trim();
            record.date = document.getElementById(recordId + '_date').value;
            
            // Recopilar price ranges
            const priceRanges = [];
            const container = document.getElementById(recordId + '_priceRangesContainer');
            if (container) {
                const rangeElements = container.children;
                for (let i = 0; i < rangeElements.length; i++) {
                    const rangeDiv = rangeElements[i];
                    const inputs = rangeDiv.querySelectorAll('input[type="number"]');
                    
                    if (inputs.length >= 3) {
                        const fromQty = parseInt(inputs[0].value) || 1;
                        const toQty = parseInt(inputs[1].value) || 999999;
                        const price = parseFloat(inputs[2].value) || 0;
                        priceRanges.push({ fromQty, toQty, price });
                    }
                }
            }
            
            record.priceRanges = priceRanges;
            
            console.log('Record updated successfully:', record);
            
            console.log('Record updated successfully in memory');
            
            // Note: This function now only updates the in-memory records array
            // All persistent storage should be handled through PicLan API
            
            // Actualizar grid
            renderRecords();
            
            // Mostrar mensaje de éxito
            showSuccessNotification('¡Registro actualizado exitosamente!', 'Los cambios han sido actualizados en memoria. Use PicLan API para persistir cambios.');
            
            console.log('Update completed - changes updated in memory only');
        }
        
        // Función para iniciar nueva búsqueda
        function startNewCaptureSearch() {
            console.log('Starting new capture search');
            
            // Limpiar campos
            document.getElementById('partNumber').value = '';
            document.getElementById('vendorno').value = '';
            
            // Limpiar área de resultados
            const resultsArea = document.getElementById('captureResultsArea');
            resultsArea.innerHTML = '';
            resultsArea.style.display = 'none';
            
            // Enfocar en el primer campo
            document.getElementById('partNumber').focus();
            
            console.log('New search started');
        }
        
        // Función para limpiar formulario
        function clearCaptureForm() {
            console.log('clearCaptureForm called');
            
            // Limpiar campos
            document.getElementById('partNumber').value = '';
            document.getElementById('vendorno').value = '';
            
            // Limpiar área de resultados
            const resultsArea = document.getElementById('captureResultsArea');
            resultsArea.innerHTML = '';
            resultsArea.style.display = 'none';
            
            console.log('Form cleared');
        }

        // Función temporal para probar el guardado de price ranges
        async function testPriceRangesSave() {
            console.log('🧪 [TEST] Iniciando prueba de guardado de price ranges...');
            
            // Datos de prueba
            const testData = {
                ID: '14',
                PART_NUMBER: 'AC-001',
                PRICE_RANGES: '1,10,150.50|11,50,140.25|51,100,130.00'
            };
            
            console.log('🧪 [TEST] Datos de prueba:', testData);
            
            try {
                const testUrl = `test_price_save.xml?ID=${encodeURIComponent(testData.ID)}&PART_NUMBER=${encodeURIComponent(testData.PART_NUMBER)}&PRICE_RANGES=${encodeURIComponent(testData.PRICE_RANGES)}`;
                
                console.log('🧪 [TEST] URL de prueba:', testUrl);
                
                const response = await fetch(testUrl);
                const xmlText = await response.text();
                
                console.log('🧪 [TEST] Respuesta del servidor:', xmlText);
                
                // Extraer mensajes de debug
                if (xmlText.includes('<debug>')) {
                    const debugMatches = xmlText.match(/<debug>(.*?)<\/debug>/g);
                    if (debugMatches) {
                        console.log('🧪 [TEST] Mensajes de debug del servidor:');
                        debugMatches.forEach((match, index) => {
                            const debugContent = match.replace(/<\/?debug>/g, '');
                            console.log(`   ${index + 1}. ${debugContent}`);
                        });
                    }
                }
                
                // Verificar resultado
                if (xmlText.includes('<status>success</status>')) {
                    console.log('✅ [TEST] Prueba exitosa!');
                    showNotification('✅ Test successful! Check console for details.', 'success');
                } else {
                    console.log('❌ [TEST] Prueba falló');
                    showNotification('❌ Test failed! Check console for details.', 'error');
                }
                
            } catch (error) {
                console.error('❌ [TEST] Error en la prueba:', error);
                showNotification('❌ Test error! Check console for details.', 'error');
            }
        }
        
        // Price Range Management Functions
        function addPriceRange() {
            const priceRangesContainer = document.getElementById('priceRanges');
            const newRangeRow = document.createElement('div');
            newRangeRow.className = 'price-range-row';
            newRangeRow.innerHTML = `
                <div class="form-grid price-range-grid">
                    <div class="form-group">
                        <label>From Qty *</label>
                        <input type="number" class="fromQty" min="1" required placeholder="1">
                    </div>
                    <div class="form-group">
                        <label>To Qty *</label>
                        <input type="number" class="toQty" min="1" required placeholder="1000">
                    </div>
                    <div class="form-group">
                        <label>Price *</label>
                        <input type="number" class="price" step="0.01" min="0" required placeholder="5.00">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removePriceRange(this)" style="margin-top: 0;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            priceRangesContainer.appendChild(newRangeRow);
        }

        function removePriceRange(button) {
            const priceRangesContainer = document.getElementById('priceRanges');
            const rangeRow = button.closest('.price-range-row');
            
            // Don't allow removing the last price range
            if (priceRangesContainer.children.length > 1) {
                rangeRow.remove();
            } else {
                showErrorNotification('Cannot Remove', 'At least one price range is required.');
            }
        }

        // Function to remove price range from API record edit form
        function removeAPIRecordPriceRange(recordId, index) {
            const rangeElement = document.getElementById(`${recordId}_range_${index}`);
            const container = document.getElementById(`${recordId}_priceRangesContainer`);
            
            if (!rangeElement || !container) {
                console.error('Price range elements not found:', { rangeElement: !!rangeElement, container: !!container });
                showNotification('❌ Error: Could not find price range to remove', 'error');
                return;
            }
            
            // Don't allow removing if it's the only range
            const remainingRanges = container.querySelectorAll('[id*="_range_"]');
            if (remainingRanges.length <= 1) {
                showNotification('⚠️ At least one price range is required', 'warning');
                return;
            }
            
            // Remove the range element
            rangeElement.remove();
            showNotification('✅ Price range removed', 'success');
            
            // Re-index remaining ranges to maintain proper numbering
            const allRanges = container.querySelectorAll('[id*="_range_"]');
            allRanges.forEach((range, newIndex) => {
                const oldIndex = range.id.split('_range_')[1];
                if (oldIndex != newIndex) {
                    // Update the range container ID
                    range.id = `${recordId}_range_${newIndex}`;
                    
                    // Update input field IDs and their corresponding elements
                    const fromQtyInput = range.querySelector(`#${recordId}_fromQty_${oldIndex}`);
                    const toQtyInput = range.querySelector(`#${recordId}_toQty_${oldIndex}`);
                    const priceInput = range.querySelector(`#${recordId}_price_${oldIndex}`);
                    const removeButton = range.querySelector('button[onclick*="removeAPIRecordPriceRange"]');
                    
                    if (fromQtyInput) fromQtyInput.id = `${recordId}_fromQty_${newIndex}`;
                    if (toQtyInput) toQtyInput.id = `${recordId}_toQty_${newIndex}`;
                    if (priceInput) priceInput.id = `${recordId}_price_${newIndex}`;
                    if (removeButton) removeButton.setAttribute('onclick', `removeAPIRecordPriceRange('${recordId}', ${newIndex})`);
                }
            });
        }

        // Edit Price Range Management Functions - CORREGIDAS
        function addEditPriceRange() {
            const editPriceRangesContainer = document.getElementById('editPriceRanges');
            const newRangeRow = document.createElement('div');
            newRangeRow.className = 'price-range-row';
            newRangeRow.innerHTML = `
                <div class="form-grid price-range-grid">
                    <div class="form-group">
                        <label>From Qty *</label>
                        <input type="number" class="editFromQty" min="1" required placeholder="1">
                    </div>
                    <div class="form-group">
                        <label>To Qty *</label>
                        <input type="number" class="editToQty" min="1" required placeholder="1000">
                    </div>
                    <div class="form-group">
                        <label>Price *</label>
                        <input type="number" class="editPrice" step="0.01" min="0" required placeholder="5.00">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removeEditPriceRangeManage(this)" style="margin-top: 0;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            editPriceRangesContainer.appendChild(newRangeRow);
        }

        function removeEditPriceRangeManage(button) {
            console.log('🗑️ MANAGE TAB - Remove price range');
            const editPriceRangesContainer = document.getElementById('editPriceRanges');
            const rangeRow = button.closest('.price-range-row');
            
            if (!rangeRow) {
                console.error('❌ Could not find range row');
                return;
            }
            
            // Don't allow removing the last price range
            if (editPriceRangesContainer.children.length > 1) {
                rangeRow.remove();
                console.log('✅ Manage tab price range removed');
            } else {
                showErrorNotification('Cannot Remove', 'At least one price range is required.');
            }
        }

        function getEditPriceRanges() {
            const editPriceRangeRows = document.querySelectorAll('#editPriceRanges .price-range-row');
            const priceRanges = [];
            
            editPriceRangeRows.forEach(row => {
                const fromQty = parseFloat(row.querySelector('.editFromQty').value);
                const toQty = parseFloat(row.querySelector('.editToQty').value);
                const price = parseFloat(row.querySelector('.editPrice').value);
                
                if (fromQty && toQty && price >= 0) {
                    priceRanges.push({ fromQty, toQty, price });
                }
            });
            
            return priceRanges;
        }

        function populateEditPriceRanges(priceRanges) {
            const editPriceRangesContainer = document.getElementById('editPriceRanges');
            editPriceRangesContainer.innerHTML = '';
            
            priceRanges.forEach(range => {
                const rangeRow = document.createElement('div');
                rangeRow.className = 'price-range-row';
                rangeRow.innerHTML = `
                    <div class="form-grid price-range-grid">
                        <div class="form-group">
                            <label>From Qty *</label>
                            <input type="number" class="editFromQty" min="1" required value="${range.fromQty}">
                        </div>
                        <div class="form-group">
                            <label>To Qty *</label>
                            <input type="number" class="editToQty" min="1" required value="${range.toQty}">
                        </div>
                        <div class="form-group">
                            <label>Price *</label>
                            <input type="number" class="editPrice" step="0.001" min="0" required value="${range.price}">
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removeEditPriceRangeManage(this)" style="margin-top: 0;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                editPriceRangesContainer.appendChild(rangeRow);
            });
        }

        function getPriceRanges() {
            const priceRangeRows = document.querySelectorAll('.price-range-row');
            const priceRanges = [];
            
            priceRangeRows.forEach(row => {
                const fromQty = parseFloat(row.querySelector('.fromQty').value);
                const toQty = parseFloat(row.querySelector('.toQty').value);
                const price = parseFloat(row.querySelector('.price').value);
                
                if (fromQty && toQty && price >= 0) {
                    priceRanges.push({ fromQty, toQty, price });
                }
            });
            
            return priceRanges;
        }

        function validatePriceRanges(priceRanges) {
            if (priceRanges.length === 0) {
                return 'At least one price range is required.';
            }
            
            for (let i = 0; i < priceRanges.length; i++) {
                const range = priceRanges[i];
                if (range.fromQty > range.toQty) {
                    return `Price range ${i + 1}: From Qty cannot be greater than To Qty.`;
                }
            }
            
            // Check for overlapping ranges
            for (let i = 0; i < priceRanges.length; i++) {
                for (let j = i + 1; j < priceRanges.length; j++) {
                    const range1 = priceRanges[i];
                    const range2 = priceRanges[j];
                    
                    if ((range1.fromQty <= range2.toQty && range1.toQty >= range2.fromQty)) {
                        return `Price ranges ${i + 1} and ${j + 1} overlap. Please adjust the quantities.`;
                    }
                }
            }
            
            return null;
        }

        function addRecord(event) {
            event.preventDefault();
            
            const customer = document.getElementById('customer').value.trim();
            const partNumber = document.getElementById('partNumber').value.trim();
            const partDescription = document.getElementById('partDescription').value.trim();
            const vendorno = document.getElementById('vendorno').value.trim();
            const date = document.getElementById('date').value;
            
            const priceRanges = getPriceRanges();
            
            if (!validatePriceRanges(priceRanges)) {
                return;
            }
            
            const newRecord = {
                customer,
                partNumber,
                partDescription,
                vendorno,
                date,
                priceRanges,
                notes: document.getElementById('notes').value.trim()
            };
            
            records.push(newRecord);
            
            // Deduplicate global records to prevent duplicates
            const _uniqueAfterAdd = dedupeRecords(records);
            records.length = 0;
            records.push(..._uniqueAfterAdd);
            renderRecords();
            clearForm();
            
            showSuccessNotification('Record Added!', `Successfully added ${partNumber} (${partDescription}) for ${customer}`);
        }

        function clearForm() {
            document.getElementById('dataForm').reset();
            
            // Reset price ranges to just one empty range
            const priceRangesContainer = document.getElementById('priceRanges');
            priceRangesContainer.innerHTML = `
                <div class="price-range-row">
                    <div class="form-grid price-range-grid">
                        <div class="form-group">
                            <label>From Qty *</label>
                            <input type="number" class="fromQty" min="1" required placeholder="1">
                        </div>
                        <div class="form-group">
                            <label>To Qty *</label>
                            <input type="number" class="toQty" min="1" required placeholder="1000">
                        </div>
                        <div class="form-group">
                            <label>Price *</label>
                            <input type="number" class="price" step="0.01" min="0" required placeholder="5.00">
                        </div>
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button type="button" class="btn btn-danger btn-sm" onclick="removePriceRange(this)" style="margin-top: 0;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Cascading Search Functions - Works with records array
        function searchCustomerCascade() {
            const searchValue = document.getElementById('searchCustomer').value.toLowerCase().trim();
            const customerResults = document.getElementById('customerResults');
            const customerInfo = document.getElementById('customerInfo');
            
            if (searchValue === '') {
                customerResults.style.display = 'none';
                // Clear other search fields and show all records
                document.getElementById('searchPartNumber').value = '';
                document.getElementById('searchCustomerNumber').value = '';
                document.getElementById('partDetailsForm').style.display = 'none';
                renderRecords(records);
                updateRecordCount(records.length);
                return;
            }
            
            // Search in current records array
            const filteredRecords = records.filter(record => {
                const vendorName = (record.vendorName || record.customer || '').toLowerCase();
                const vendorNumber = (record.vendorNumber || record.vendorno || '').toString().toLowerCase();
                return vendorName.includes(searchValue) || vendorNumber.includes(searchValue);
            });
            
            renderRecords(filteredRecords);
            updateRecordCount(filteredRecords.length);
            customerResults.style.display = 'none';
        }
        
        function searchByCustomerNumber() {
            const custNumber = document.getElementById('searchCustomerNumber').value.trim();
            if (custNumber === '') {
                document.getElementById('partDetailsForm').style.display = 'none';
                // Clear other search fields and show all records
                document.getElementById('searchPartNumber').value = '';
                document.getElementById('searchCustomer').value = '';
                document.getElementById('customerResults').style.display = 'none';
                renderRecords(records);
                updateRecordCount(records.length);
                return;
            }
            
            // Search in current records array
            const filteredRecords = records.filter(record => {
                const vendorNumber = (record.vendorNumber || record.vendorno || '').toString();
                return vendorNumber === custNumber;
            });
            
            renderRecords(filteredRecords);
            updateRecordCount(filteredRecords.length);
            document.getElementById('partDetailsForm').style.display = 'none';
        }
        
        function handleCustomerNumberEnter(event) {
            if (event.key === 'Enter') {
                // Check if we're in the Data Capture tab
                const activeTab = document.querySelector('.tab-pane.active');
                if (activeTab && activeTab.id === 'capture-tab') {
                    const custNumber = document.getElementById('vendorno').value.trim();
                    if (custNumber === '') return;
                    
                    // Check if part number is also filled
                    const partNumber = document.getElementById('partNumber').value.trim();
                    if (partNumber === '') {
                        showInfoMessage('Please enter Part Number first to continue.');
                        document.getElementById('partNumber').focus();
                        return;
                    }
                    
                    // Both fields are filled, check for combined record
                    console.log('Both fields filled in customer enter - Part:', partNumber, 'Customer:', custNumber);
                    simpleCaptureSearch();
                } else {
                    // Original functionality for Search & View tab
                    const custNumber = document.getElementById('searchCustomerNumber').value.trim();
                    if (custNumber === '') return;
                    
                    // Find records with this customer number
                    const matchingRecords = records.filter(record => 
                        record.vendorno && record.vendorno.toString() === custNumber
                    );
                    
                    if (matchingRecords.length > 0) {
                        displayPartDetails(matchingRecords, custNumber, true);
                    } else {
                        displayNewItemForm(custNumber);
                    }
                }
            }
        }
        
        function displayPartDetails(matchingRecords, custNumber, isEditable) {
            const partDetailsForm = document.getElementById('partDetailsForm');
            const partDetailsContent = document.getElementById('partDetailsContent');
            
            let html = '';
            
            matchingRecords.forEach((record, index) => {
                const priceRangesHtml = record.priceRanges.map(range => 
                    `<div style="margin: 5px 0; padding: 8px; background: #e2e8f0; border-radius: 4px; font-size: 0.9em;">
                        Qty ${range.fromQty}-${range.toQty}: ${formatPrice(range.price)}
                    </div>`
                ).join('');
                // Stable composite key for scoping inputs/events to THIS record only
                const rid = `${(record.partNumber || '').toString().trim().toUpperCase()}_${(record.vendorNumber || record.vendorno || '').toString().trim()}`;
                
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #d1d5db;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 5px;">Part Number:</label>
                                <span style="color: #1e293b; font-weight: 500;">${record.partNumber}</span>
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 5px;">Customer Name:</label>
                                ${isEditable ? 
                                    `<input type="text" id="${rid}_customer" value="${record.vendorName || record.customer || ''}" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">` :
                                    `<span style="color: #1e293b; font-weight: 500;">${record.customer || ''}</span>`
                                }
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 8px;">Price Ranges:</label>
                            ${isEditable ? 
                                `<div id="${rid}_priceRangesContainer">${createEditablePriceRangesForRecord(rid, record.priceRanges || [])}</div>` :
                                priceRangesHtml
                            }
                        </div>
                        
                        <div style="margin-bottom: 15px;">
                            <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 5px;">Notes:</label>
                            ${isEditable ? 
                                `<textarea id="${rid}_notes" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; min-height: 60px;">${record.notes || ''}</textarea>` :
                                `<span style="color: #64748b;">${record.notes || ''}</span>`
                            }
                        </div>
                        
                        ${isEditable ? `
                            <div style="text-align: right; margin-top: 15px;">
                                <button onclick="savePicLanFromCaptureForm('${rid}', ${JSON.stringify(record).replace(/"/g, '&quot;')})" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 8px;">
                                    <i class="fas fa-save"></i> Save Changes
                                </button>
                                <button onclick="cancelPartEdit()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            partDetailsContent.innerHTML = html;
            partDetailsForm.style.display = 'block';
        }
        
        function displayNewItemForm(custNumber) {
            const partDetailsForm = document.getElementById('partDetailsForm');
            const partDetailsContent = document.getElementById('partDetailsContent');
            
            const html = `
                <div style="padding: 20px; background: #dbeafe; border: 2px solid #3b82f6; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                    <i class="fas fa-exclamation-triangle" style="color: #3b82f6; font-size: 1.5em; margin-bottom: 10px;"></i>
                    <h4 style="color: #1e40af; margin-bottom: 8px;">New Item</h4>
                    <p style="color: #1e40af; margin: 0;">Vendor Number "${custNumber}" does not exist in the system.</p>
                    <p style="color: #1e40af; margin: 8px 0 0 0; font-size: 0.9em;">You can add a new record in the "Data Capture" tab.</p>
                </div>
                <div style="text-align: center;">
                    <button onclick="switchTab('capture'); document.getElementById('vendorno').value='${custNumber}';" style="background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 1em;">
                        <i class="fas fa-plus"></i> Add New Record
                    </button>
                </div>
            `;
            
            partDetailsContent.innerHTML = html;
            partDetailsForm.style.display = 'block';
        }
        
        function createEditablePriceRangesForRecord(recordId, priceRanges) {
            return (priceRanges || []).map((range, rangeIndex) => `
                <div id="${recordId}_range_${rangeIndex}" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 8px; margin-bottom: 8px; align-items: end;">
                    <div>
                        <label style="font-size: 0.8em; color: #6b7280;">From Qty</label>
                        <input type="number" id="${recordId}_fromQty_${rangeIndex}" value="${range.fromQty}" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                    </div>
                    <div>
                        <label style="font-size: 0.8em; color: #6b7280;">To Qty</label>
                        <input type="number" id="${recordId}_toQty_${rangeIndex}" value="${range.toQty}" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                    </div>
                    <div>
                        <label style="font-size: 0.8em; color: #6b7280;">Price</label>
                        <input type="number" step="0.001" id="${recordId}_price_${rangeIndex}" value="${range.price}" style="width: 100%; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                    </div>
                    <button onclick="removeAPIRecordPriceRange('${recordId}', ${rangeIndex})" style="background: #ef4444; color: white; border: none; padding: 6px 8px; border-radius: 4px; cursor: pointer; font-size: 0.8em;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('');
        }
        
        // removed legacy savePartDetails() (replaced by savePicLanFromCaptureForm)
        
        function cancelPartEdit() {
            document.getElementById('partDetailsForm').style.display = 'none';
        }
        
        // Part Number Search Functions - Works with records array
        function searchByPartNumber() {
            const partNumber = document.getElementById('searchPartNumber').value.trim();
            if (partNumber === '') {
                document.getElementById('partDetailsForm').style.display = 'none';
                // Clear other search fields and show all records
                document.getElementById('searchCustomerNumber').value = '';
                document.getElementById('searchCustomer').value = '';
                document.getElementById('customerResults').style.display = 'none';
                renderRecords(records);
                updateRecordCount(records.length);
                return;
            }
            
            // Search in current records array
            const filteredRecords = records.filter(record => {
                const recordPartNumber = (record.partNumber || '').toString().toLowerCase();
                return recordPartNumber.includes(partNumber.toLowerCase());
            });
            
            renderRecords(filteredRecords);
            updateRecordCount(filteredRecords.length);
            document.getElementById('partDetailsForm').style.display = 'none';
        }
        
        function handlePartNumberEnter(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                // Check if we're in the Data Capture tab
                const activeTab = document.querySelector('.tab-pane.active');
                if (activeTab && activeTab.id === 'capture-tab') {
                    const partNumber = document.getElementById('partNumber').value.trim();
                    if (partNumber === '') return;
                    
                    // Move focus to customer number field if it's empty
                    const custNumber = document.getElementById('vendorno').value.trim();
                    if (custNumber === '') {
                        document.getElementById('vendorno').focus();
                        showInfoMessage('Please enter Vendor Number to continue.');
                        return;
                    }
                    
                    // Both fields are filled, check for combined record
                    console.log('Both fields filled - Part:', partNumber, 'Customer:', custNumber);
                    simpleCaptureSearch();
                } else {
                    // Original functionality for Search & View tab
                    const partNumber = document.getElementById('searchPartNumber').value.trim();
                    if (partNumber === '') return;
                    
                    // Find exact match for part number
                    const exactMatch = records.filter(record => 
                        record.partNumber.toLowerCase() === partNumber.toLowerCase()
                    );
                    
                    if (exactMatch.length > 0) {
                        displayPartDetailsByPartNumber(exactMatch, partNumber, true);
                    } else {
                        // Check for partial matches
                        const partialMatches = records.filter(record => 
                            record.partNumber.toLowerCase().includes(partNumber.toLowerCase())
                        );
                        
                        if (partialMatches.length > 0) {
                            displayPartDetailsByPartNumber(partialMatches, partNumber, true);
                        } else {
                            displayNewPartForm(partNumber);
                        }
                    }
                }
            }
        }
        
        function displayPartDetailsByPartNumber(matchingRecords, partNumber, isEditable) {
            const partDetailsForm = document.getElementById('partDetailsForm');
            const partDetailsContent = document.getElementById('partDetailsContent');
            
            let html = '';
            
            matchingRecords.forEach((record, index) => {
                const priceRangesHtml = record.priceRanges.map(range => 
                    `<div style=\"margin: 5px 0; padding: 8px; background: #e2e8f0; border-radius: 4px; font-size: 0.9em;\">\n                        Qty ${range.fromQty}-${range.toQty}: ${formatPrice(range.price)}\n                    </div>`
                ).join('');
                const rid = `${(record.partNumber || '').toString().trim().toUpperCase()}_${(record.vendorNumber || record.vendorno || '').toString().trim()}`;
                
                html += `
                    <div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #d1d5db;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 5px;">Part Number:</label>
                                <span style="color: #1e293b; font-weight: 500;">${record.partNumber}</span>
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 5px;">Part Description:</label>
                                ${isEditable ? 
                                    `<input type=\"text\" id=\"${rid}_partdesc\" value=\"${record.partDescription || ''}\" style=\"width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;\">` :
                                    `<span style=\"color: #1e293b; font-weight: 500;\">${record.partDescription || 'N/A'}</span>`
                                }
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 5px;">Customer Name:</label>
                                ${isEditable ? 
                                    `<input type=\"text\" id=\"${rid}_customer\" value=\"${record.vendorName || record.customer || ''}\" style=\"width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;\">` :
                                    `<span style=\"color: #1e293b; font-weight: 500;\">${record.customer || ''}</span>`
                                }
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 5px;">Vendor Number:</label>
                                <span style="color: #1e293b; font-weight: 500;">${record.vendorno || record.vendorNumber || 'N/A'}</span>
                            </div>
                        </div>
                        
                        <div style="background: #fff7ed; border: 1px solid #f59e0b; border-radius: 6px; padding: 12px; margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <label style="font-weight: 600; color: #92400e;">Price Ranges</label>
                                ${isEditable ? `<button type=\"button\" onclick=\"addNewPriceRange('${rid}')\" style=\"background: #f59e0b; color: white; padding: 6px 12px; border: none; border-radius: 4px; font-size: 0.9em; cursor: pointer;\"><i class=\"fas fa-plus\"></i> Add Range</button>` : ''}
                            </div>
                            ${isEditable ? 
                                `<div id=\"${rid}_priceRangesContainer\">${createEditablePriceRangesForRecord(rid, record.priceRanges || [])}</div>` :
                                priceRangesHtml
                            }
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 5px;">Notes:</label>
                                ${isEditable ? 
                                    `<textarea id=\"${rid}_notes\" style=\"width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; min-height: 60px;\">${record.notes || ''}</textarea>` :
                                    `<span style=\"color: #64748b;\">${record.notes || ''}</span>`
                                }
                            </div>
                            <div>
                                <label style="font-weight: 600; color: #374151; display: block; margin-bottom: 5px;">Date:</label>
                                ${isEditable ? 
                                    `<input type=\"date\" id=\"${rid}_date\" value=\"${record.date || new Date().toISOString().split('T')[0]}\" style=\"width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;\">` :
                                    `<span style=\"color: #1e293b; font-weight: 500;\">${record.date || ''}</span>`
                                }
                            </div>
                        </div>
                        
                        ${isEditable ? `
                            <div style="text-align: right; margin-top: 15px;">
                                <button onclick="savePicLanFromCaptureForm('${rid}', ${JSON.stringify(record).replace(/"/g, '&quot;')})" style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; margin-right: 8px;">
                                    <i class=\"fas fa-save\"></i> Save Changes
                                </button>
                                <button onclick="cancelPartEdit()" style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                                    <i class=\"fas fa-times\"></i> Cancel
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            partDetailsContent.innerHTML = html;
            partDetailsForm.style.display = 'block';
        }
        
        function displayNewPartForm(partNumber) {
            const partDetailsForm = document.getElementById('partDetailsForm');
            const partDetailsContent = document.getElementById('partDetailsContent');
            
            const html = `
                <div style="padding: 20px; background: #dbeafe; border: 2px solid #3b82f6; border-radius: 8px; text-align: center; margin-bottom: 20px;">
                    <i class="fas fa-exclamation-triangle" style="color: #3b82f6; font-size: 1.5em; margin-bottom: 10px;"></i>
                    <h4 style="color: #1e40af; margin-bottom: 8px;">New Part</h4>
                    <p style="color: #1e40af; margin: 0;">Part Number "${partNumber}" does not exist in the system.</p>
                    <p style="color: #1e40af; margin: 8px 0 0 0; font-size: 0.9em;">You can add a new record in the "Data Capture" tab.</p>
                </div>
                <div style="text-align: center;">
                    <button onclick="switchTab('capture'); document.getElementById('partNumber').value='${partNumber}';" style="background: #3b82f6; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 1em;">
                        <i class="fas fa-plus"></i> Add New Part
                    </button>
                </div>
            `;
            
            partDetailsContent.innerHTML = html;
            partDetailsForm.style.display = 'block';
        }
        
        // removed legacy createEditablePartPriceRanges()
        
        // removed legacy savePartDetailsByPartNumber() (replaced by savePicLanFromCaptureForm)
        
        function filterRecords() {
            // Get filter values (match the actual input IDs in the header)
            const partFilter = (document.getElementById('filterPart')?.value || '').toLowerCase();
            const descFilter = (document.getElementById('filterPartDescription')?.value || '').toLowerCase();
            const custNumFilter = (document.getElementById('filterCustno')?.value || '').toLowerCase();
            const custNameFilter = (document.getElementById('filterCustomer')?.value || '').toLowerCase();
            const priceFilter = (document.getElementById('filterPriceRanges')?.value || '').toLowerCase();
            const dateFilter = (document.getElementById('filterDate')?.value || '');
            const notesFilter = (document.getElementById('filterNotes')?.value || '').toLowerCase();
            
            // Filter records based on all criteria
            const filteredRecords = records.filter(record => {
                const partNumber = (record.partNumber || '').toLowerCase();
                const partDesc = (record.partDescription || '').toLowerCase();
                const custNum = (record.vendorNumber || record.vendorno || '').toString().toLowerCase();
                const custName = (record.vendorName || record.customer || '').toLowerCase();
                const notes = (record.notes || '').toLowerCase();
                const date = record.date || '';
                
                // Price range filter (check if any price range matches)
                let priceMatch = true;
                if (priceFilter) {
                    priceMatch = record.priceRanges && record.priceRanges.some(range => 
                        range.price.toString().includes(priceFilter)
                    );
                }
                
                return partNumber.includes(partFilter) &&
                       partDesc.includes(descFilter) &&
                       custNum.includes(custNumFilter) &&
                       custName.includes(custNameFilter) &&
                       notes.includes(notesFilter) &&
                       date.includes(dateFilter) &&
                       priceMatch;
            });
            
            renderRecords(filteredRecords);
            updateRecordCount(filteredRecords.length);
        }

        function exportToCSV() {
            if (records.length === 0) {
                showErrorNotification('No Data', 'No records available to export. Please load data first using "Cargar desde PicLan" button.');
                return;
            }
            
            // Create CSV header
            const headers = ['Part Number', 'Part Description', 'Vendor Number', 'Customer Name', 'Price Ranges', 'Date', 'Notes'];
            let csvContent = headers.join(',') + '\n';
            
            // Add data rows
            records.forEach(record => {
                const priceRangesStr = record.priceRanges ? 
                    record.priceRanges.map(range => `${range.fromQty}-${range.toQty}:$${parseFloat(range.price).toFixed(3)}`).join(';') : '';
                
                const row = [
                    `"${record.partNumber || ''}"`,,
                    `"${record.partDescription || ''}"`,,
                    `"${record.vendorNumber || record.vendorno || ''}"`,,
                    `"${record.vendorName || record.customer || ''}"`,,
                    `"${priceRangesStr}"`,,
                    `"${record.date || ''}"`,,
                    `"${record.notes || ''}"`
                ];
                csvContent += row.join(',') + '\n';
            });
            
            // Create and download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `taimex_records_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showSuccessNotification('Export Complete', `Exported ${records.length} records to CSV file.`);
        }

        function clearFilters() {
            // Clear search inputs
            const searchCustomer = document.getElementById('searchCustomer');
            const searchPart = document.getElementById('searchPart');
            if (searchCustomer) searchCustomer.value = '';
            if (searchPart) searchPart.value = '';
            
            // Clear filter inputs
            const filterCustomer = document.getElementById('filterCustomer');
            const filterPart = document.getElementById('filterPart');
            const filterCustno = document.getElementById('filterCustno');
            const filterPriceRanges = document.getElementById('filterPriceRanges');
            const filterDate = document.getElementById('filterDate');
            const filterNotes = document.getElementById('filterNotes');
            const filterDateAdded = document.getElementById('filterDateAdded');
            
            if (filterCustomer) filterCustomer.value = '';
            if (filterPart) filterPart.value = '';
            if (filterCustno) filterCustno.value = '';
            if (filterPriceRanges) filterPriceRanges.value = '';
            if (filterDate) filterDate.value = '';
            if (filterNotes) filterNotes.value = '';
            if (filterDateAdded) filterDateAdded.value = '';
            
            // Show all records
            renderRecords();
            updateRecordCount(records.length);
        }

        function clearAllSearches() {
            // Clear all search inputs in the search tab
            const searchCustomer = document.getElementById('searchCustomer');
            const searchPartNumber = document.getElementById('searchPartNumber');
            const searchCustomerNumber = document.getElementById('searchCustomerNumber');
            
            if (searchCustomer) searchCustomer.value = '';
            if (searchPartNumber) searchPartNumber.value = '';
            if (searchCustomerNumber) searchCustomerNumber.value = '';
            
            // Hide result displays
            const customerResults = document.getElementById('customerResults');
            const partDetailsForm = document.getElementById('partDetailsForm');
            
            if (customerResults) customerResults.style.display = 'none';
            if (partDetailsForm) partDetailsForm.style.display = 'none';
            
            // Show all records
            renderRecords(records);
            
            showSuccessNotification('Search Cleared', 'All searches have been reset and showing all records');
        }



        function updateRecordCount(filteredCount = null) {
            // Mostrar conteo basado en el parámetro provisto (ya deduplicado)
            const count = filteredCount !== null ? filteredCount : 0;
            const recordsCountSpan = document.getElementById('recordsCount');
            if (recordsCountSpan) {
                if (count === 0) {
                    recordsCountSpan.textContent = 'Sin registros - usa PicLan API';
                } else {
                    recordsCountSpan.textContent = `${count} registros mostrados`;
                }
            }
        }


        function renderRecords(recordsToRender = null) {
    // Si no se especifican registros, usar el array global
    if (!recordsToRender) {
        recordsToRender = records;
    }
    
    // Seguridad adicional: eliminar duplicados antes de mostrar
    const uniqueToRender = dedupeRecords(recordsToRender);
    recordsToRender = uniqueToRender;

    // Enriquecer: mapear nombres por cliente y descripciones por parte para rellenar faltantes
    const nameByCustomer = new Map();
    const descByPart = new Map();
    recordsToRender.forEach(r => {
        const custNum = (r.vendorNumber || r.vendorno || '').toString().trim();
        const custName = (r.vendorName || r.customer || '').toString().trim();
        const pNum = (r.partNumber || '').toString().trim();
        const pDesc = (r.partDescription || r.DESCRIPTION || '').toString().trim();
        if (custNum && custName && !nameByCustomer.has(custNum)) nameByCustomer.set(custNum, custName);
        if (pNum && pDesc && !descByPart.has(pNum)) descByPart.set(pNum, pDesc);
    });
    
    const tbody = document.getElementById('recordsTableBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    recordsToRender.forEach((record, index) => {
        const row = document.createElement('tr');
        row.className = 'excel-row';
        
        // NORMALIZAR y ENRIQUECER los campos
        const partNumber = record.partNumber || '';
        let partDescription = record.partDescription || record.DESCRIPTION || '';
        const vendorNumber = record.vendorNumber || record.vendorno || '';
        let vendorName = record.vendorName || record.customer || '';

        // Completar faltantes usando mapas precalculados
        if (!vendorName && vendorNumber) {
            const inferredName = nameByCustomer.get(vendorNumber);
            if (inferredName) vendorName = inferredName;
        }
        if (!partDescription && partNumber) {
            const inferredDesc = descByPart.get(partNumber);
            if (inferredDesc) partDescription = inferredDesc;
        }

        if ((!vendorName || !partDescription) && partNumber && vendorNumber) {
            console.warn('⚠️ Registro con campos faltantes tras enriquecer:', { partNumber, vendorNumber, vendorName, partDescription });
        }
        const date = record.date || '';
        const notes = record.notes || '';
        
        // Format price ranges for display (vertical + right-aligned)
        let priceRangesDisplay = '';
        if (record.priceRanges && record.priceRanges.length > 0) {
            const badges = record.priceRanges.map(range =>
                `<span class="range-badge">${range.fromQty}-${range.toQty}: $${parseFloat(range.price).toFixed(3)}</span>`
            ).join('');
            priceRangesDisplay = `<div class="price-ranges-vertical">${badges}</div>`;
        } else {
            priceRangesDisplay = `<div class="price-ranges-vertical"><span style="color:#9ca3af;font-style:italic;white-space:nowrap;">Sin rangos</span></div>`;
        }
        
        // Usar índice GLOBAL para operaciones (evita errores tras dedupe/filtrado)
        const globalIndex = records.indexOf(record);
        
        row.innerHTML = `
            <td class="excel-cell">
                <div class="cell-content">${partNumber}</div>
            </td>
            <td class="excel-cell readonly" title="Solo lectura">
                <div class="cell-content">${partDescription}</div>
            </td>
            <td class="excel-cell">
                <div class="cell-content">${vendorNumber}</div>
            </td>
            <td class="excel-cell readonly" title="Solo lectura">
                <div class="cell-content">${vendorName}</div>
            </td>
            <td class="excel-cell ranges-cell">
                <div class="cell-content">${priceRangesDisplay}</div>
            </td>
            <td class="excel-cell">
                <div class="cell-content">${date}</div>
            </td>
            <td class="excel-cell">
                <div class="cell-content">${notes}</div>
            </td>
            <td class="excel-cell">
                <div class="action-buttons">
                    <button class="btn-sm btn-edit" onclick="editRecord(${globalIndex})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn-sm btn-delete" onclick="deleteRecord(${globalIndex})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(row);
    });
    
    updateRecordCount(recordsToRender.length);
}
        function sortTable(field) {
            records.sort((a, b) => {
                let aVal = a[field], bVal = b[field];
                return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
            });
            renderRecords();
        }

        function editRecord(index) {
            console.log('editRecord called with index:', index);
            console.log('records array:', records);
            
            // Check if index is valid
            if (index === -1 || index >= records.length || index < 0) {
                console.error('Invalid index:', index);
                alert('Error: Record not found (invalid index: ' + index + ')');
                return;
            }
            
            const record = records[index];
            console.log('Found record:', record);
            
            if (!record) {
                console.error('Record is null/undefined');
                alert('Error: Record not found');
                return;
            }
            
            // Switch to manage tab first
            switchTab('manage');
            
            // Small delay to ensure tab switch completes
            setTimeout(() => {
                // Fill the form with record data
                const editIndexEl = document.getElementById('editIndex');
                const editCustomerEl = document.getElementById('editCustomer');
                const editPartNumberEl = document.getElementById('editPartNumber');
                const editCustnoEl = document.getElementById('editCustno');
                const editDateEl = document.getElementById('editDate');
                const editNotesEl = document.getElementById('editNotes');
                const editPartDescriptionEl = document.getElementById('editPartDescription');
                const editFormEl = document.getElementById('editForm');
                const noEditMessageEl = document.getElementById('noEditMessage');
                
                console.log('Form elements found:', {
                    editIndex: !!editIndexEl,
                    editCustomer: !!editCustomerEl,
                    editPartNumber: !!editPartNumberEl,
                    editCustno: !!editCustnoEl,
                    editDate: !!editDateEl,
                    editNotes: !!editNotesEl,
                    editPartDescription: !!editPartDescriptionEl,
                    editForm: !!editFormEl,
                    noEditMessage: !!noEditMessageEl
                });
                
                if (editIndexEl) editIndexEl.value = index;
                if (editCustomerEl) editCustomerEl.value = record.vendorName || record.customer || '';
                if (editPartNumberEl) editPartNumberEl.value = record.partNumber || record.PART_NUMBER || '';
                if (editCustnoEl) editCustnoEl.value = record.vendorno || record.vendorNumber || '';
                if (editDateEl) editDateEl.value = record.date || '';
                if (editNotesEl) editNotesEl.value = record.notes || '';
                if (editPartDescriptionEl) editPartDescriptionEl.value = record.partDescription || '';
                
                // Populate price ranges
                populateEditPriceRanges(record.priceRanges || [{ fromQty: 1, toQty: 1000, price: 0 }]);
                
                // Show the form and hide the message
                if (editFormEl) {
                    editFormEl.style.display = 'block';
                    console.log('Form should now be visible');
                }
                if (noEditMessageEl) {
                    noEditMessageEl.style.display = 'none';
                    console.log('Message should now be hidden');
                }
            }, 100);
        }

        // ===== Price Range Editing Helpers =====
        function createPriceRangeRow(range = {}, index = 0) {
            const container = document.getElementById('editPriceRanges');
            if (!container) return;
            const row = document.createElement('div');
            row.className = 'price-range-row';

            const fromVal = Number.parseInt(range.fromQty ?? '', 10);
            const toVal = Number.parseInt(range.toQty ?? '', 10);
            const priceVal = Number.parseFloat(range.price ?? '');

            const fromInput = document.createElement('input');
            fromInput.type = 'number';
            fromInput.min = '0';
            fromInput.step = '1';
            fromInput.placeholder = 'From Qty';
            fromInput.className = 'fromQty';
            if (!Number.isNaN(fromVal)) fromInput.value = fromVal;

            const toInput = document.createElement('input');
            toInput.type = 'number';
            toInput.min = '0';
            toInput.step = '1';
            toInput.placeholder = 'To Qty';
            toInput.className = 'toQty';
            if (!Number.isNaN(toVal)) toInput.value = toVal;

            const priceInput = document.createElement('input');
            priceInput.type = 'number';
            priceInput.min = '0';
            priceInput.step = '0.001';
            priceInput.placeholder = 'Price';
            priceInput.className = 'price editPrice';
            if (!Number.isNaN(priceVal)) priceInput.value = Number(priceVal).toFixed(3);

            // Apply formatting events to price input
            try { addPriceFormatting(priceInput); } catch (e) { /* no-op */ }

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-range';
            removeBtn.innerHTML = '<i class="fas fa-minus"></i>';
            removeBtn.title = 'Remove range';
            removeBtn.addEventListener('click', () => {
                const rows = container.querySelectorAll('.price-range-row');
                if (rows.length <= 1) {
                    showErrorNotification('No permitido', 'Debe existir al menos un rango.');
                    return;
                }
                row.remove();
            });

            row.appendChild(fromInput);
            row.appendChild(toInput);
            row.appendChild(priceInput);
            row.appendChild(removeBtn);
            container.appendChild(row);
        }

        function populateEditPriceRanges(ranges = []) {
            const container = document.getElementById('editPriceRanges');
            if (!container) return;
            container.innerHTML = '';
            const list = Array.isArray(ranges) && ranges.length > 0 ? ranges : [{ fromQty: 1, toQty: 1, price: 0 }];
            list.forEach((r, i) => createPriceRangeRow(r, i));
            // Ensure formatting is applied
            try { applyPriceFormattingToAll(); } catch (e) { /* no-op */ }
        }

        function addEditPriceRange() {
            const container = document.getElementById('editPriceRanges');
            if (!container) return;
            const rows = container.querySelectorAll('.price-range-row');
            let nextFrom = 1;
            if (rows.length > 0) {
                const lastRow = rows[rows.length - 1];
                const lastTo = parseInt(lastRow.querySelector('.toQty')?.value || '0', 10);
                nextFrom = (Number.isFinite(lastTo) ? lastTo + 1 : 1);
            }
            createPriceRangeRow({ fromQty: nextFrom, toQty: nextFrom, price: 0 }, rows.length);
        }

        function getEditPriceRanges() {
            const container = document.getElementById('editPriceRanges');
            if (!container) return [];
            const result = [];
            container.querySelectorAll('.price-range-row').forEach(row => {
                const from = parseInt(row.querySelector('.fromQty')?.value || '', 10);
                const to = parseInt(row.querySelector('.toQty')?.value || '', 10);
                const price = parseFloat(row.querySelector('.price')?.value || '');
                if (Number.isFinite(from) && Number.isFinite(to) && Number.isFinite(price)) {
                    result.push({ fromQty: from, toQty: to, price: Number(price.toFixed(3)) });
                }
            });
            // Sort by fromQty ascending
            result.sort((a, b) => a.fromQty - b.fromQty);
            return result;
        }

        function validatePriceRanges(ranges = []) {
            if (!Array.isArray(ranges) || ranges.length === 0) return 'Agrega al menos un rango de precio.';
            for (let i = 0; i < ranges.length; i++) {
                const r = ranges[i];
                if (!Number.isFinite(r.fromQty) || !Number.isFinite(r.toQty) || !Number.isFinite(r.price)) {
                    return `Rango #${i+1}: valores inválidos.`;
                }
                if (r.fromQty < 0 || r.toQty < 0) return `Rango #${i+1}: cantidades deben ser >= 0.`;
                if (r.toQty < r.fromQty) return `Rango #${i+1}: 'Hasta' debe ser >= 'Desde'.`;
                if (r.price < 0) return `Rango #${i+1}: precio debe ser >= 0.`;
            }
            // Check overlaps
            const sorted = [...ranges].sort((a, b) => a.fromQty - b.fromQty);
            let prevTo = -1;
            for (let i = 0; i < sorted.length; i++) {
                const r = sorted[i];
                if (i > 0 && r.fromQty <= prevTo) {
                    return `Rangos traslapados entre #${i} y #${i+1}.`;
                }
                prevTo = r.toQty;
            }
            return '';
        }

        function testPriceRangesSave() {
            const ranges = getEditPriceRanges();
            const err = validatePriceRanges(ranges);
            if (err) {
                showErrorNotification('Validación de rangos', err);
                return;
            }
            showSuccessNotification('Rangos válidos', `${ranges.length} rangos con formato de 3 decimales.`);
            console.log('Price ranges (3 dec):', ranges);
        }

        // Helper to persist a record to PicLan UPDATE_VENDPRC.XML (core implementation)
        async function saveRecordToPicLanCore({ id, partNumber, vendorName, partDescription, notes, date, priceRanges }) {
            const baseUrl = 'http://54.189.226.145/UPDATE_VENDPRC.XML';
            const priceRangesStr = Array.isArray(priceRanges) && priceRanges.length > 0
                ? priceRanges.map(r => `${r.fromQty},${r.toQty},${Number(r.price).toFixed(3)}`).join(';')
                : '';

            const params = new URLSearchParams();
            const partNumberUpper = (partNumber || '').toString().toUpperCase();
            params.set('ID', id || '');
            params.set('PART_NUMBER', partNumberUpper);
            params.set('VENDOR_NAME', vendorName || '');
            params.set('PART_DESC', partDescription || '');
            params.set('NOTES', (typeof notes === 'string') ? notes : '');
            params.set('DATE', date || '');
            params.set('PRICE_RANGES', priceRangesStr || '');

            if (!id || !partNumber) {
                console.warn('⚠️ [DEBUG] saveRecordToPicLan called with empty id/partNumber', { id, partNumber });
                throw new Error('ID y PART_NUMBER son requeridos antes de guardar.');
            }

            // Send important fields in query string for servers that only parse GET vars
            const method = 'POST';
            const qs = new URLSearchParams();
            qs.set('ID', id || '');
            qs.set('PART_NUMBER', partNumberUpper);
            qs.set('NOTES', (typeof notes === 'string') ? notes : '');
            qs.set('DATE', date || '');
            qs.set('VENDOR_NAME', vendorName || '');
            qs.set('PART_DESC', partDescription || '');
            qs.set('PRICE_RANGES', priceRangesStr || '');
            const url = `${baseUrl}?${qs.toString()}`;
            const body = params.toString();
            console.log('🧪 [DEBUG] Encoded params snapshot:', { ID: params.get('ID'), PART_NUMBER: params.get('PART_NUMBER') });
            console.log('🔗 [DEBUG] PicLan SAVE URL (with keys in query):', url);
            console.log('📦 [DEBUG] PicLan SAVE Request Body length:', body.length);

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 8000);
            try {
                const res = await fetch(url, {
                    method,
                    body,
                    signal: controller.signal,
                    mode: 'cors',
                    cache: 'no-cache',
                    headers: {
                        'Accept': 'application/xml, text/xml, */*',
                        'Content-Type': 'application/x-www-form-urlencoded'
                    }
                });
                clearTimeout(timeoutId);
                const text = await res.text();
                // Debug: log a small snippet of the raw response
                try { console.debug('🧾 [DEBUG] PicLan SAVE raw response:', text.slice(0, 400)); } catch (_) {}
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status} ${res.statusText}: ${text.substring(0, 200)}`);
                }

                // Some servers print a debug line before the XML. Attempt to trim to XML start.
                let xmlStartIdx = text.indexOf('<?xml');
                if (xmlStartIdx === -1) xmlStartIdx = text.indexOf('<response');
                const xmlPayload = xmlStartIdx > -1 ? text.slice(xmlStartIdx) : text;

                const doc = new DOMParser().parseFromString(xmlPayload, 'text/xml');
                const hasParserError = doc.getElementsByTagName('parsererror').length > 0;
                let statusText = '';
                let messageText = '';
                if (!hasParserError) {
                    const statusNode = doc.querySelector('status');
                    statusText = statusNode ? statusNode.textContent.trim().toLowerCase() : '';
                    const msgNode = doc.querySelector('message');
                    messageText = msgNode ? msgNode.textContent.trim() : '';
                } else {
                    // Fallback via regex if XML had a prefix or minor malformation
                    const statusMatch = xmlPayload.match(/<status>([\s\S]*?)<\/status>/i);
                    const msgMatch = xmlPayload.match(/<message>([\s\S]*?)<\/message>/i);
                    statusText = statusMatch ? String(statusMatch[1]).trim().toLowerCase() : '';
                    messageText = msgMatch ? String(msgMatch[1]).trim() : '';
                }

                // Accept alternate server behavior that returns <customers> payload or debug success markers
                if (statusText !== 'success') {
                    const looksLikeSuccess = /\<customers\>/i.test(xmlPayload)
                        || /Price record written/i.test(xmlPayload)
                        || /Record updated successfully/i.test(xmlPayload)
                        || /<response>/i.test(xmlPayload); // tolerate missing <status>
                    if (looksLikeSuccess) {
                        console.warn('[SAVE] Non-standard success response. Proceeding.');
                    } else {
                        // Try to extract an <error> message if present
                        let errorText = '';
                        try {
                            const eNode = doc && !hasParserError ? doc.querySelector('error') : null;
                            if (eNode) errorText = (eNode.textContent || '').trim();
                        } catch {}
                        if (!errorText) {
                            const m = xmlPayload.match(/<error>([\s\S]*?)<\/error>/i);
                            if (m) errorText = (m[1] || '').trim();
                        }
                        const fallback = errorText || messageText || `Unexpected response from PicLan (no <message>). Snippet: ${xmlPayload.substring(0, 200)}`;
                        throw new Error(fallback);
                    }
                }

                // Optional server-side verification: ensure notes persisted when provided
                if (typeof notes === 'string' && notes.trim() !== '') {
                    const verifyUrl = `http://54.189.226.145/GET_VENDPRC.XML?ID=${encodeURIComponent(id || '')}&PART_NUMBER=${encodeURIComponent(partNumberUpper)}`;
                    const normalize = (s) => (s || '').replace(/\r\n/g, '\n').replace(/\r/g, '\n').trim();
                    async function verifyOnce() {
                        const vController = new AbortController();
                        const vTimeout = setTimeout(() => vController.abort(), 6000);
                        const vRes = await fetch(verifyUrl, { method: 'GET', cache: 'no-cache', signal: vController.signal });
                        clearTimeout(vTimeout);
                        const vText = await vRes.text();
                        const startIdx = (() => {
                            const a = vText.indexOf('<?xml');
                            if (a !== -1) return a;
                            const b = vText.indexOf('<customers');
                            if (b !== -1) return b;
                            return 0;
                        })();
                        const vPayload = vText.slice(startIdx);
                        const vDoc = new DOMParser().parseFromString(vPayload, 'text/xml');
                        let serverNotes = '';
                        if (vDoc && !vDoc.querySelector('parsererror')) {
                            const n = vDoc.getElementsByTagName('notes')[0];
                            if (n) serverNotes = (n.textContent || '').trim();
                        } else {
                            const m = vPayload.match(/<notes>([\s\S]*?)<\/notes>/i);
                            serverNotes = m ? (m[1] || '').trim() : '';
                            serverNotes = serverNotes.replace(/^<!\[CDATA\[/, '').replace(/]]>$/, '').trim();
                        }
                        return { serverNotes, vPayload };
                    }
                    try {
                        let { serverNotes, vPayload } = await verifyOnce();
                        if (normalize(serverNotes) !== normalize(notes)) {
                            // One short retry to handle eventual consistency
                            await new Promise(r => setTimeout(r, 600));
                            ({ serverNotes, vPayload } = await verifyOnce());
                            if (normalize(serverNotes) !== normalize(notes)) {
                                console.warn('[VERIFY] Notes mismatch after retry', { sent: notes, serverNotes, snippet: vPayload.slice(0, 200) });
                                throw new Error('La verificación falló: la nota no se persistió en PicLan.');
                            }
                        }
                    } catch (verr) {
                        console.error('Post-save verification failed:', verr);
                        throw verr;
                    }
                }

                return { ok: true, xml: xmlPayload };
            } catch (err) {
                clearTimeout(timeoutId);
                throw err;
            }
        }

        async function saveRecordToPicLan(arg1, arg2) {
            // New signature: single object
            if (arg1 && typeof arg1 === 'object' && !arg2) {
                return await saveRecordToPicLanCore(arg1);
            }

            // Legacy signature: (event, recordId)
            const event = arg1;
            const recordId = arg2;
            if (event && typeof event.preventDefault === 'function') event.preventDefault();

            try {
                const vendorName = document.getElementById(`${recordId}_customer`)?.value?.trim() || '';
                const partDescription = document.getElementById(`${recordId}_partdesc`)?.value?.trim() || '';
                const notes = document.getElementById(`${recordId}_notes`)?.value?.trim() || '';
                const date = document.getElementById(`${recordId}_date`)?.value || '';

                const id = (document.getElementById('vendorno')?.value?.trim()
                    || document.getElementById('editCustno')?.value?.trim()
                    || document.getElementById('editCustomerNumber')?.value?.trim()
                    || '').toString();
                const partNumber = (document.getElementById('partNumber')?.value?.trim()
                    || document.getElementById('editPartNumber')?.value?.trim()
                    || document.getElementById('editPart')?.value?.trim()
                    || '').toString();

                const priceRanges = [];
                const container = document.getElementById(`${recordId}_priceRangesContainer`);
                if (container) {
                    const rangeElements = container.querySelectorAll('[id*="_range_"]');
                    rangeElements.forEach((rangeEl) => {
                        const actualIndex = rangeEl.id.split('_range_')[1];
                        const fromQtyEl = document.getElementById(`${recordId}_fromQty_${actualIndex}`);
                        const toQtyEl = document.getElementById(`${recordId}_toQty_${actualIndex}`);
                        const priceEl = document.getElementById(`${recordId}_price_${actualIndex}`);
                        if (fromQtyEl && toQtyEl && priceEl) {
                            const fromQty = fromQtyEl.value;
                            const toQty = toQtyEl.value;
                            const price = priceEl.value;
                            if (fromQty && toQty && price) {
                                priceRanges.push({
                                    fromQty: parseInt(fromQty, 10),
                                    toQty: parseInt(toQty, 10),
                                    price: Number(price).toFixed(3)
                                });
                            }
                        }
                    });
                }

                console.log('🧾 [DEBUG] Legacy SAVE params:', { id, partNumber, vendorName, partDescription, notes, date, ranges: priceRanges });
                if (!id || !partNumber) {
                    showErrorNotification('Faltan datos', 'ID (cliente) y Part Number son requeridos');
                    return { ok: false };
                }

                showLoadingNotification('Guardando en PicLan', 'Enviando cambios...');
                const result = await saveRecordToPicLanCore({ id, partNumber, vendorName, partDescription, notes, date, priceRanges });
                showSuccessNotification('Cambios guardados', 'PicLan actualizado correctamente.');
                return result;
            } catch (error) {
                console.error('Error en saveRecordToPicLan (legacy):', error);
                showErrorNotification('Error al guardar', (error && error.message) ? error.message : String(error));
                throw error;
            } finally {
                hideLoadingNotification();
            }
        }

        async function updateRecord(event) {
            console.log('updateRecord function called');
            event.preventDefault();
            
            const index = parseInt(document.getElementById('editIndex')?.value ?? '-1', 10);
            const notes = (document.getElementById('editNotes')?.value || '').trim();
            const date = (document.getElementById('editDate')?.value || '').trim();
            const priceRanges = getEditPriceRanges();

            console.log('Form values (editable only):', { notes, priceRanges });

            // Validate index
            if (!Number.isFinite(index) || index < 0 || index >= records.length) {
                showErrorNotification('Error', 'Registro inválido');
                return;
            }

            // Validate price ranges
            const validationError = validatePriceRanges(priceRanges);
            if (validationError) {
                showErrorNotification('Error en rangos de precio', validationError);
                return;
            }

            const current = records[index];
            const formId = (document.getElementById('editCustno')?.value 
                || document.getElementById('editCustomerNumber')?.value 
                || document.getElementById('editCustomerNo')?.value 
                || '').toString().trim();
            const formPart = (document.getElementById('editPartNumber')?.value 
                || document.getElementById('editPart')?.value 
                || '').toString().trim();

            // Prefer what the user sees in the form; fallback to record fields
            const id = (formId 
                || current.vendorno 
                || current.vendorNumber 
                || current.id 
                || current.VENDOR_NUMBER 
                || current.CustomerNumber 
                || '').toString().trim();
            const partNumber = (formPart 
                || current.partNumber 
                || current.PART_NUMBER 
                || current.PartNumber 
                || '').toString().trim();
            const vendorName = (current.vendorName || current.customer || '').toString().trim();
            const partDescription = (current.partDescription || '').toString().trim();

            console.log('🧾 [DEBUG] SAVE sources:', {
                formId, formPart,
                currentId: (current.vendorno || current.vendorNumber || current.id || current.VENDOR_NUMBER || current.CustomerNumber || ''),
                currentPart: (current.partNumber || current.PART_NUMBER || current.PartNumber || '')
            });
            console.log('🧾 [DEBUG] SAVE payload keys:', { id, partNumber, hasNotes: !!notes, hasDate: !!date, ranges: priceRanges });

            if (!id || !partNumber) {
                showErrorNotification('Faltan datos', 'ID (cliente) y Part Number son requeridos');
                return;
            }

            try {
                showLoadingNotification('Guardando en PicLan', 'Enviando cambios...');
                await saveRecordToPicLan({
                    id,
                    partNumber,
                    vendorName,
                    partDescription,
                    notes,
                    date,
                    priceRanges
                });

                // Apply local updates only after successful save
                current.notes = notes;
                if (date) current.date = date;
                current.priceRanges = priceRanges;

                console.log('Updated record:', current);
                renderRecords();
                cancelEdit();
                showSuccessNotification('Cambios guardados', 'PicLan actualizado correctamente.');
            } catch (err) {
                console.error('Error al guardar en PicLan:', err);
                showErrorNotification('Error al guardar', (err && err.message) ? err.message : String(err));
            } finally {
                hideLoadingNotification();
            }
        }

        function cancelEdit() {
            document.getElementById('editForm').style.display = 'none';
            document.getElementById('noEditMessage').style.display = 'block';
            document.getElementById('editForm').reset();
        }

        function deleteRecord(index) {
            if (confirm('Are you sure you want to delete this record?')) {
                records.splice(index, 1);
                renderRecords();
                showSuccessNotification('Record deleted successfully!', 'The record has been permanently removed from the system.');
            }
        }

        // Unified Notification System
        function showNotification(message, type = 'success') {
    // Crear contenedor si no existe
    let container = document.getElementById('notificationContainer');
    if (!container) {
        container = document.createElement('div');
        container.id = 'notificationContainer';
        container.style.cssText = `position:fixed;top:20px;right:20px;z-index:10000;pointer-events:none;`;
        document.body.appendChild(container);
    }

    // Configuración por tipo
    const config = {
        success: { bg:'linear-gradient(135deg,#10b981 0%,#059669 100%)', icon:'fas fa-check' },
        error:   { bg:'linear-gradient(135deg,#ef4444 0%,#dc2626 100%)', icon:'fas fa-exclamation-triangle' },
        warning: { bg:'linear-gradient(135deg,#f59e0b 0%,#d97706 100%)', icon:'fas fa-exclamation-circle' },
        info:    { bg:'linear-gradient(135deg,#3b82f6 0%,#2563eb 100%)', icon:'fas fa-info-circle' }
    }[type] || { bg:'#333', icon:'fas fa-info-circle' };

    const note = document.createElement('div');
    note.style.cssText = `background:${config.bg};color:#fff;padding:16px 24px;border-radius:12px;box-shadow:0 10px 25px rgba(0,0,0,.3);display:flex;align-items:center;gap:12px;font-size:14px;min-width:300px;max-width:500px;margin-bottom:10px;transform:translateX(400px);opacity:0;transition:all .4s ease;pointer-events:auto;cursor:pointer;`;
    note.innerHTML = `<div style="background:rgba(255,255,255,.2);border-radius:50%;width:32px;height:32px;display:flex;align-items:center;justify-content:center;"><i class="${config.icon}"></i></div><div style="flex:1;">${message}</div><div style="opacity:.7;font-size:12px;">✕</div>`;
    container.appendChild(note);
    setTimeout(()=>{ note.style.transform='translateX(0)'; note.style.opacity='1';},100);
    const ttl = type==='error'?8000:5000;
    const remove = ()=>{ note.style.transform='translateX(400px)'; note.style.opacity='0'; setTimeout(()=>note.remove(),400);} ;
    setTimeout(remove, ttl);
    note.onclick=remove;
}

        // Modern Success Notification System
        function showSuccessNotification(title, message = '') {
            const container = document.getElementById('notificationContainer');
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="fas fa-check"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    ${message ? `<div class="notification-message">${message}</div>` : ''}
                </div>
            `;
            
            // Add to container
            container.appendChild(notification);
            
            // Trigger animation
            setTimeout(() => {
                notification.classList.add('show', 'bounce');
            }, 100);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                notification.classList.remove('show');
                notification.classList.add('hide');
                
                // Remove from DOM after animation
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 400);
            }, 4000);
        }

        // Error Notification System
        function showErrorNotification(title, message = '') {
            const container = document.getElementById('notificationContainer');
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = 'notification error';
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    ${message ? `<div class="notification-message">${message}</div>` : ''}
                </div>
            `;
            
            // Add to container
            container.appendChild(notification);
            
            // Trigger animation
            setTimeout(() => {
                notification.classList.add('show', 'bounce');
            }, 100);
            
            // Auto remove after 5 seconds (longer for error messages)
            setTimeout(() => {
                notification.classList.remove('show');
                notification.classList.add('hide');
                
                // Remove from DOM after animation
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 400);
            }, 5000);
        }

        // Loading Notification System
        let loadingNotification = null;
        
        function showLoadingNotification(title, message = '') {
            // Remove existing loading notification if any
            hideLoadingNotification();
            
            const container = document.getElementById('notificationContainer');
            
            // Create loading notification element
            loadingNotification = document.createElement('div');
            loadingNotification.className = 'notification loading';
            loadingNotification.innerHTML = `
                <div class="notification-icon">
                    <i class="fas fa-spinner fa-spin"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    ${message ? `<div class="notification-message">${message}</div>` : ''}
                </div>
            `;
            
            // Add to container
            container.appendChild(loadingNotification);
            
            // Trigger animation
            setTimeout(() => {
                loadingNotification.classList.add('show');
            }, 100);
        }
        
        function hideLoadingNotification() {
            if (loadingNotification && loadingNotification.parentNode) {
                loadingNotification.classList.remove('show');
                loadingNotification.classList.add('hide');
                
                // Remove from DOM after animation
                setTimeout(() => {
                    if (loadingNotification && loadingNotification.parentNode) {
                        loadingNotification.parentNode.removeChild(loadingNotification);
                    }
                    loadingNotification = null;
                }, 400);
            }
        }

        // Función para mostrar mensajes informativos (no altera el DOM principal)
        function showInfoMessage(message) {
            // Usa el sistema de notificaciones unificado para no borrar el contenido actual
            try {
                showNotification(message, 'info');
            } catch (e) {
                console.log('Info:', message);
            }
        }

        // Initialize price formatting when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Apply price formatting to all existing price inputs
            applyPriceFormattingToAll();
            
            // Re-apply formatting when tabs are switched (in case new inputs are created)
            setTimeout(() => {
                applyPriceFormattingToAll();
            }, 500);
        });

        // Also apply formatting when window loads (backup)
        window.addEventListener('load', function() {
            setTimeout(() => {
                applyPriceFormattingToAll();
            }, 1000);
        });

        // ============================================
        // FUNCIONES PARA COPY-PASTE A PRICE_EDIT.HTM
        // ============================================
        


        // ============================================
// FUNCIONES CORREGIDAS PARA GETCUST.XML/UPDATE_CUST.XML
// ============================================
// Función CORREGIDA para obtener contenido XML con múltiples selectores
function getXMLTextContent(parentNode, ...tagNames) {
    for (const tagName of tagNames) {
        const element = parentNode.querySelector(tagName);
        if (element && element.textContent) {
            const content = element.textContent.trim();
            if (content) return content;
        }
    }
    return '';
}
// parseXMLToRecords: única definición vive más abajo (~línea 5120)
// ============================================
// FUNCIONES DE DIAGNÓSTICO Y UTILIDAD AVANZADAS
// ============================================
// (Inserta aquí el resto de funciones del bloque del usuario: displayXMLDebugInfo, displayErrorInfo, tryParseXMLManually, showXMLStructure, runCacheDiagnosticAndCleanup, manualCleanupLocalStorage, runSystemDiagnostic, validateXMLStructure, logSearchAttempt, showSearchHistory, el bloque de CSS para loading si no existe, y la inicialización de diagnósticos)


        // Función para mostrar registros de la API en formato simple primero
        function displayAPIRecord(record) {
            // Validar que el record existe
            if (!record) {
                return '<div class="api-record-display"><p>❌ No se pudo mostrar el registro</p></div>';
            }
            
            // Asegurar que priceRanges existe como array
            const priceRanges = record.priceRanges || [];
            const recordId = `api_${record.id || Date.now()}`;
            
            return `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h4 style="color: #3b82f6; margin: 0; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-database" style="color: #3b82f6;"></i> 
                        Record Found in Local Storage: Part ${record.partNumber || 'N/A'} for Customer #${record.vendorNumber || record.vendorno || 'N/A'}
                    </h4>
                    <button onclick="startNewCaptureSearch()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 8px 16px; border: none; border-radius: 6px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <i class="fas fa-search"></i> New Search
                    </button>
                </div>
                
                <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #3b82f6; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <div style="background: #3b82f6; color: white; padding: 6px 12px; border-radius: 6px; font-size: 0.9em; font-weight: 600;">
                            <i class="fas fa-check-circle"></i> Encontrado en Local Storage
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                        <div>
                            <strong style="color: #374151;">ID:</strong> ${record.id || 'N/A'}
                        </div>
                        <div>
                            <strong style="color: #374151;">Part Number:</strong> ${record.partNumber || 'N/A'}
                        </div>
                        <div>
                            <strong style="color: #374151;">Vendor Number:</strong> ${record.vendorNumber || record.vendorno || 'N/A'}
                        </div>
                        <div>
                            <strong style="color: #374151;">Customer Name:</strong> ${record.vendorName || record.customer || 'N/A'}
                        </div>
                        <div>
                            <strong style="color: #374151;">Description:</strong> ${record.partDescription || 'N/A'}
                        </div>
                        <div>
                            <strong style="color: #374151;">Notes:</strong> ${record.notes || 'N/A'}
                        </div>
                    </div>
                    
                    <div style="background: white; border: 1px solid #3b82f6; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
                        <h5 style="margin: 0 0 8px 0; color: #374151; display: flex; align-items: center; gap: 6px;">
                            <i class="fas fa-dollar-sign" style="color: #3b82f6;"></i> Price Ranges:
                        </h5>
                        ${priceRanges.length > 0 ? 
                            priceRanges.map(range => `
                                <div style="padding: 4px 0; border-bottom: 1px solid #e5e7eb; last-child:border-bottom: none;">
                                    <span style="color: #6b7280;">Qty ${range.fromQty || '?'}-${range.toQty || '?'}: </span>
                                    <span style="font-weight: 600; color: #059669;">$${(range.price != null && range.price !== '' ? parseFloat(range.price).toFixed(3) : '0.000')}</span>
                                </div>
                            `).join('') : 
                            '<p style="color: #6b7280; font-style: italic; margin: 0;">No price ranges available</p>'
                        }
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button onclick="showEditAPIRecordForm('${recordId}', ${JSON.stringify(record).replace(/"/g, '&quot;')})" style="
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 6px;
                            font-size: 0.95em;
                            font-weight: 600;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            transition: all 0.2s ease;
                            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.25);
                        " onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(16, 185, 129, 0.35)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(16, 185, 129, 0.25)'">
                            <i class="fas fa-edit"></i>
                            Edit Record
                        </button>
                        <button onclick="saveAPIRecordToLocalDirectly('${recordId}', ${JSON.stringify(record).replace(/"/g, '&quot;')})" style="
                            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 6px;
                            font-size: 0.95em;
                            font-weight: 600;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                            <i class="fas fa-download"></i>
                            Save As-Is
                        </button>
                    </div>
                </div>
            `;
        }

        // Función para mostrar el formulario de edición del registro API
        function showEditAPIRecordForm(recordId, record) {
            const resultsArea = document.getElementById('captureResultsArea');
            
            // Asegurar que priceRanges existe como array
            const priceRanges = record.priceRanges || [];
            
            resultsArea.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h4 style="color: #10b981; margin: 0; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-edit" style="color: #10b981;"></i> 
                        Editing Local Storage Record: Part ${record.partNumber || 'N/A'} for Customer #${record.vendorNumber || record.vendorno || 'N/A'}
                    </h4>
                    <button onclick="startNewCaptureSearch()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 8px 16px; border: none; border-radius: 6px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; gap: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <i class="fas fa-search"></i> New Search
                    </button>
                </div>
                
                <form onsubmit="saveAPIRecordToLocal(event, '${recordId}')" style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border: 2px solid #10b981; border-radius: 8px; padding: 20px;">
                    <h5 style="color: #374151; margin-bottom: 20px; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-edit" style="color: #10b981;"></i> Edit Local Storage Record
                    </h5>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 4px;">Part Number:</label>
                            <input type="text" value="${record.partNumber || ''}" readonly style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 2px solid #d1d5db;
                                border-radius: 6px;
                                background: #f9fafb;
                                color: #6b7280;
                                font-weight: 500;
                            ">
                        </div>
                        <div>
                            <label style="display: block; font-weight: 600; color: #374151; margin-bottom: 4px;">Vendor Number:</label>
                            <input type="text" value="${record.vendorNumber || record.vendorno || ''}" readonly style="
                                width: 100%;
                                padding: 8px 12px;
                                border: 2px solid #d1d5db;
                                border-radius: 6px;
                                background: #f9fafb;
                                color: #6b7280;
                                font-weight: 500;
                            ">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 20px;">
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">Vendor Name <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="${recordId}_customer" value="${record.vendorName || record.customer || ''}" required style="width: 100%; padding: 10px 12px; border: 2px solid #10b981; border-radius: 6px; font-size: 14px; transition: all 0.2s ease;" onfocus="this.style.borderColor='#059669'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)'" onblur="this.style.borderColor='#10b981'; this.style.boxShadow='none'">
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">Part Description <span style="color: #ef4444;">*</span></label>
                            <input type="text" id="${recordId}_partdesc" value="${record.partDescription || ''}" required style="width: 100%; padding: 10px 12px; border: 2px solid #10b981; border-radius: 6px; font-size: 14px; transition: all 0.2s ease;" onfocus="this.style.borderColor='#059669'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)'" onblur="this.style.borderColor='#10b981'; this.style.boxShadow='none'">
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">Notes</label>
                            <input type="text" id="${recordId}_notes" value="${record.notes || ''}" style="width: 100%; padding: 10px 12px; border: 2px solid #10b981; border-radius: 6px; font-size: 14px; transition: all 0.2s ease;" onfocus="this.style.borderColor='#059669'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)'" onblur="this.style.borderColor='#10b981'; this.style.boxShadow='none'">
                        </div>
                        <div class="form-group">
                            <label style="font-weight: 600; color: #374151; margin-bottom: 4px; display: block;">Date</label>
                            <input type="date" id="${recordId}_date" value="${record.date || new Date().toISOString().split('T')[0]}" style="width: 100%; padding: 10px 12px; border: 2px solid #10b981; border-radius: 6px; font-size: 14px; transition: all 0.2s ease;" onfocus="this.style.borderColor='#059669'; this.style.boxShadow='0 0 0 3px rgba(16, 185, 129, 0.1)'" onblur="this.style.borderColor='#10b981'; this.style.boxShadow='none'">
                        </div>
                    </div>
                    
                    <!-- Price Ranges Section -->
                    <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); border: 2px solid #f59e0b; border-radius: 8px; padding: 16px; margin: 16px 0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                            <h5 style="margin: 0; color: #92400e; font-weight: 600; display: flex; align-items: center; gap: 8px;">
                                <i class="fas fa-dollar-sign"></i> Price Ranges
                            </h5>
                            <button type="button" onclick="addNewPriceRange('${recordId}')" style="background: #f59e0b; color: white; padding: 6px 12px; border: none; border-radius: 4px; font-size: 0.9em; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                                <i class="fas fa-plus"></i> Add Range
                            </button>
                        </div>
                        <div id="${recordId}_priceRangesContainer" style="display: grid; gap: 8px;">
                            ${priceRanges.length > 0 ? 
                                priceRanges.map((range, index) => `
                                    <div id="${recordId}_range_${index}" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; padding: 12px; background: white; border: 1px solid #f59e0b; border-radius: 6px; align-items: end;">
                                        <div>
                                            <label style="font-size: 0.9em; color: #92400e; font-weight: 500; display: block; margin-bottom: 4px;">From Qty</label>
                                            <input type="number" id="${recordId}_fromQty_${index}" value="${range.fromQty || ''}" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                                        </div>
                                        <div>
                                            <label style="font-size: 0.9em; color: #92400e; font-weight: 500; display: block; margin-bottom: 4px;">To Qty</label>
                                            <input type="number" id="${recordId}_toQty_${index}" value="${range.toQty || ''}" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                                        </div>
                                        <div>
                                            <label style="font-size: 0.9em; color: #92400e; font-weight: 500; display: block; margin-bottom: 4px;">Price</label>
                                            <input type="number" id="${recordId}_price_${index}" value="${range.price || ''}" step="0.001" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                                        </div>
                                        <button type="button" onclick="removeAPIRecordPriceRange('${recordId}', ${index})" style="background: #ef4444; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; height: 36px;" title="Remove Range">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                `).join('') : 
                                '<p style="color: #92400e; font-style: italic; margin: 0; text-align: center; padding: 20px;">No price ranges available. Click "Add Range" to create one.</p>'
                            }
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: center; margin-top: 20px;">
                        <button type="button" onclick="savePicLanFromCaptureForm('${recordId}', ${JSON.stringify(record).replace(/"/g, '&quot;')})" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s ease; box-shadow: 0 4px 6px rgba(59, 130, 246, 0.25);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(59, 130, 246, 0.35)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(59, 130, 246, 0.25)'">
                            <i class="fas fa-save"></i> Save
                        </button>
                        <button type="button" onclick="clearCaptureForm()" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; border: none; padding: 12px 24px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s ease;" onmouseover="this.style.background='linear-gradient(135deg, #4b5563 0%, #374151 100%)'" onmouseout="this.style.background='linear-gradient(135deg, #6b7280 0%, #4b5563 100%)'">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                    </div>
                </form>
            `;

            // Auto-lookup vendor name and part description if fields are empty
            setTimeout(() => {
                const vendorNumber = record.vendorNumber || record.vendorno || '';
                const partNumber = record.partNumber || '';
                const vendorNameField = document.getElementById(`${recordId}_customer`);
                const partDescField = document.getElementById(`${recordId}_partdesc`);

                console.log('🔍 Auto-lookup check:', { vendorNumber, partNumber, recordId });
                console.log('🔍 Fields found:', { 
                    vendorNameField: !!vendorNameField, 
                    partDescField: !!partDescField,
                    vendorValue: vendorNameField?.value,
                    partValue: partDescField?.value
                });

                // ALWAYS lookup vendor name from VENDORS database (master source)
                // Pass current value as fallback in case vendor not found in VENDORS
                if (vendorNumber && vendorNameField) {
                    const fallbackVendor = record.vendorName || record.customer || '';
                    console.log('✅ Triggering vendor lookup (forced from VENDORS master)', { fallbackVendor });
                    autoLookupVendorName(vendorNumber, `${recordId}_customer`, fallbackVendor);
                }
                
                // ALWAYS lookup part description from PARTS database (master source)
                // Pass current value as fallback in case part not found in PARTS
                if (partNumber && partDescField) {
                    const fallbackDesc = record.partDescription || '';
                    console.log('✅ Triggering part lookup (forced from PARTS master)', { fallbackDesc });
                    autoLookupPartDescription(partNumber, `${recordId}_partdesc`, fallbackDesc);
                }
            }, 100);
        }
        
        // ================================
        // Helper functions for Data Capture edit workflow
        // ================================
        function addNewPriceRange(recordId) {
            try {
                const container = document.getElementById(`${recordId}_priceRangesContainer`);
                if (!container) {
                    console.error('[addNewPriceRange] Container not found:', `${recordId}_priceRangesContainer`);
                    if (typeof showNotification === 'function') showNotification('No se encontró el contenedor de rangos', 'error');
                    return;
                }
                const rows = Array.from(container.children).filter(el => el.id && el.id.indexOf(`${recordId}_range_`) === 0);
                let nextIndex = 0;
                rows.forEach(el => {
                    const idx = parseInt((el.id || '').split('_range_')[1], 10);
                    if (!isNaN(idx) && idx >= nextIndex) nextIndex = idx + 1;
                });
                const rowHtml = `
                    <div id="${recordId}_range_${nextIndex}" style="display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 12px; padding: 12px; background: white; border: 1px solid #f59e0b; border-radius: 6px; align-items: end;">
                        <div>
                            <label style="font-size: 0.9em; color: #92400e; font-weight: 500; display: block; margin-bottom: 4px;">From Qty</label>
                            <input type="number" id="${recordId}_fromQty_${nextIndex}" placeholder="0" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                        </div>
                        <div>
                            <label style="font-size: 0.9em; color: #92400e; font-weight: 500; display: block; margin-bottom: 4px;">To Qty</label>
                            <input type="number" id="${recordId}_toQty_${nextIndex}" placeholder="0" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                        </div>
                        <div>
                            <label style="font-size: 0.9em; color: #92400e; font-weight: 500; display: block; margin-bottom: 4px;">Price</label>
                            <input type="number" id="${recordId}_price_${nextIndex}" step="0.001" placeholder="0.000" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 0.9em;">
                        </div>
                        <button type="button" onclick="removeAPIRecordPriceRange('${recordId}', ${nextIndex})" style="background: #ef4444; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; height: 36px;" title="Remove Range">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', rowHtml);
            } catch (e) {
                console.error('Error adding new price range:', e);
            }
        }

        // removed duplicate removeAPIRecordPriceRange(recordId, index) — use the earlier reindexing version

        function startNewCaptureSearch() {
            clearCaptureForm();
        }

        // Alias used by the top action button
        function startNewSearch() {
            startNewCaptureSearch();
        }

        function clearCaptureForm() {
            try {
                const pnEl = document.getElementById('partNumber');
                const cnEl = document.getElementById('vendorno');
                if (pnEl) pnEl.value = '';
                if (cnEl) cnEl.value = '';

                const resultsArea = document.getElementById('captureResultsArea');
                if (resultsArea) {
                    resultsArea.innerHTML = '<div id="captureCustomerInfo" style="display: none;"></div><div id="capturePartInfo" style="display: none;"></div>';
                    resultsArea.style.display = 'none';
                }

                const actionBtns = document.getElementById('captureActionButtons');
                if (actionBtns) actionBtns.style.display = 'none';

                const lookup = document.getElementById('customerLookupResult');
                if (lookup) { lookup.innerHTML = ''; lookup.style.display = 'none'; }

                const partSearchResults = document.getElementById('capturePartSearchResults');
                if (partSearchResults) {
                    partSearchResults.style.display = 'none';
                    const content = document.getElementById('capturePartSearchContent');
                    if (content) content.innerHTML = '';
                }

                if (pnEl && typeof pnEl.focus === 'function') pnEl.focus();
                if (typeof showInfoMessage === 'function') showInfoMessage('Listo para nueva búsqueda.');
            } catch (e) {
                console.error('Error clearing capture form:', e);
            }
        }

        // Persist changes from the Data Capture edit form to PicLan and update only the intended local record
        async function savePicLanFromCaptureForm(recordId, original) {
            try {
                const id = (original && (original.vendorNumber || original.vendorno || original.id || original.VENDOR_NUMBER || original.CustomerNumber) || '').toString().trim();
                const partNumber = (original && (original.partNumber || original.PART_NUMBER || original.PartNumber) || '').toString().trim();

                if (!id || !partNumber) {
                    showErrorNotification('Faltan llaves', 'ID (cliente) y Part Number no detectados en el registro.');
                    return;
                }

                const vendorName = (document.getElementById(`${recordId}_customer`)?.value || '').trim();
                const partDescription = (document.getElementById(`${recordId}_partdesc`)?.value || '').trim();
                const notes = (document.getElementById(`${recordId}_notes`)?.value || '').trim();
                const date = (document.getElementById(`${recordId}_date`)?.value || '').trim();

                // Collect price ranges from this record form only
                const priceRanges = [];
                const container = document.getElementById(`${recordId}_priceRangesContainer`);
                if (container) {
                    const rows = container.querySelectorAll('[id*="_range_"]');
                    rows.forEach(row => {
                        const idx = (row.id || '').split('_range_')[1];
                        const fromQtyEl = document.getElementById(`${recordId}_fromQty_${idx}`);
                        const toQtyEl = document.getElementById(`${recordId}_toQty_${idx}`);
                        const priceEl = document.getElementById(`${recordId}_price_${idx}`);
                        if (fromQtyEl && toQtyEl && priceEl) {
                            const fromQty = parseInt(fromQtyEl.value, 10);
                            const toQty = parseInt(toQtyEl.value, 10);
                            const priceNum = Number.parseFloat(priceEl.value);
                            if (Number.isFinite(fromQty) && Number.isFinite(toQty) && Number.isFinite(priceNum)) {
                                priceRanges.push({ fromQty, toQty, price: Number(priceNum.toFixed(3)) });
                            }
                        }
                    });
                }

                showLoadingNotification('Guardando en PicLan', 'Enviando cambios...');
                await saveRecordToPicLan({ id, partNumber, vendorName, partDescription, notes, date, priceRanges });

                // Update only the targeted local record by composite key
                const keyPart = partNumber.toString().trim().toUpperCase();
                const keyId = id.toString().trim();
                const idx = records.findIndex(r => {
                    const rid = (r.vendorNumber || r.vendorno || r.id || r.VENDOR_NUMBER || r.CustomerNumber || '').toString().trim();
                    const pn = (r.partNumber || r.PART_NUMBER || r.PartNumber || '').toString().trim().toUpperCase();
                    return pn === keyPart && rid === keyId;
                });
                if (idx !== -1) {
                    const rec = records[idx];
                    if (vendorName) { rec.vendorName = vendorName; rec.customer = vendorName; }
                    if (partDescription) rec.partDescription = partDescription;
                    rec.notes = notes;
                    if (date) rec.date = date;
                    rec.priceRanges = priceRanges;
                } else {
                    console.warn('No se encontró el registro local para actualizar después del guardado.', { id, partNumber });
                }

                renderRecords();

                // Collapse/hide the inline edit UI to indicate success
                try {
                    // If using Data Capture inline form container
                    const resultsArea = document.getElementById('captureResultsArea');
                    if (resultsArea && resultsArea.style) {
                        // Smooth collapse animation
                        resultsArea.style.overflow = 'hidden';
                        resultsArea.style.transition = 'max-height 0.25s ease, opacity 0.2s ease';
                        resultsArea.style.maxHeight = resultsArea.scrollHeight + 'px';
                        // Force reflow then collapse
                        void resultsArea.offsetHeight;
                        resultsArea.style.maxHeight = '0px';
                        resultsArea.style.opacity = '0';
                        setTimeout(() => {
                            resultsArea.style.display = 'none';
                            resultsArea.innerHTML = '<div id="captureCustomerInfo" style="display: none;"></div><div id="capturePartInfo" style="display: none;"></div>';
                            resultsArea.style.maxHeight = '';
                            resultsArea.style.opacity = '';
                            resultsArea.style.overflow = '';
                            resultsArea.style.transition = '';
                        }, 260);
                    }

                    // If using legacy/alternate container
                    const partDetailsForm = document.getElementById('partDetailsForm');
                    if (partDetailsForm) partDetailsForm.style.display = 'none';

                    // Show capture action buttons (New Search / Clear) if present
                    const actionBtns = document.getElementById('captureActionButtons');
                    if (actionBtns) actionBtns.style.display = 'flex';
                } catch (uiErr) {
                    console.warn('UI collapse after save failed:', uiErr);
                }

                showSuccessNotification('Cambios guardados', 'PicLan actualizado y la vista refrescada.');
            } catch (e) {
                console.error('Error al guardar desde Data Capture:', e);
                showErrorNotification('Error al guardar', (e && e.message) ? e.message : String(e));
            } finally {
                hideLoadingNotification();
            }
        }

        function saveAPIRecordToLocal(event, recordId) {
            if (event && typeof event.preventDefault === 'function') event.preventDefault();
            try {
                const ranges = [];
                const container = document.getElementById(`${recordId}_priceRangesContainer`);
                if (container) {
                    const rows = container.querySelectorAll('[id*="_range_"]');
                    rows.forEach(row => {
                        const idx = (row.id || '').split('_range_')[1];
                        const fromQty = parseInt(document.getElementById(`${recordId}_fromQty_${idx}`)?.value || '', 10);
                        const toQty = parseInt(document.getElementById(`${recordId}_toQty_${idx}`)?.value || '', 10);
                        const priceStr = document.getElementById(`${recordId}_price_${idx}`)?.value || '';
                        const priceNum = parseFloat(priceStr);
                        if (!isNaN(fromQty) && !isNaN(toQty) && !isNaN(priceNum)) {
                            ranges.push({ fromQty, toQty, price: priceNum.toFixed(3) });
                        }
                    });
                }

                const payload = {
                    partNumber: document.getElementById('partNumber')?.value?.trim() || '',
                    vendorNumber: document.getElementById('vendorno')?.value?.trim() || '',
                    customer: document.getElementById(`${recordId}_customer`)?.value?.trim() || '',
                    partDescription: document.getElementById(`${recordId}_partdesc`)?.value?.trim() || '',
                    notes: document.getElementById(`${recordId}_notes`)?.value?.trim() || '',
                    date: document.getElementById(`${recordId}_date`)?.value || '',
                    priceRanges: ranges
                };

                const key = 'TAIMEX_LOCAL_API_RECORDS';
                const store = JSON.parse(localStorage.getItem(key) || '{}');
                store[recordId] = payload;
                localStorage.setItem(key, JSON.stringify(store));

                if (typeof showSuccessNotification === 'function') {
                    showSuccessNotification('Guardado local', `${payload.partNumber} - Cliente ${payload.vendorNumber}`);
                } else {
                    console.log('[Local save]', payload);
                    try { alert('Registro guardado localmente.'); } catch (_) {}
                }
            } catch (e) {
                console.error('Error saving locally:', e);
                if (typeof showNotification === 'function') showNotification('❌ Error al guardar localmente', 'error');
            }
        }

        function saveAPIRecordToLocalDirectly(recordId, record) {
            try {
                const normalized = {
                    ...record,
                    priceRanges: Array.isArray(record.priceRanges) ? record.priceRanges.map(r => ({
                        fromQty: parseInt(r.fromQty || 0, 10),
                        toQty: parseInt(r.toQty || 0, 10),
                        price: parseFloat(r.price || 0).toFixed(3)
                    })) : []
                };
                const key = 'TAIMEX_LOCAL_API_RECORDS';
                const store = JSON.parse(localStorage.getItem(key) || '{}');
                store[recordId] = normalized;
                localStorage.setItem(key, JSON.stringify(store));
                if (typeof showSuccessNotification === 'function') {
                    showSuccessNotification('Guardado local (as-is)', `${normalized.partNumber} - Cliente ${normalized.vendorNumber || normalized.vendorno || ''}`);
                } else {
                    console.log('[Local save as-is]', normalized);
                    try { alert('Registro original guardado localmente.'); } catch (_) {}
                }
            } catch (e) {
                console.error('Error saving locally (as-is):', e);
                if (typeof showNotification === 'function') showNotification('❌ Error al guardar localmente (as-is)', 'error');
            }
        }

        // Define safe notification fallbacks only if not present
        (function ensureNotificationHelpers(){
            if (typeof window !== 'undefined') {
                if (typeof window.showNotification !== 'function') {
                    window.showNotification = (msg, type = 'info') => console.log(`[${type}]`, msg);
                }
                if (typeof window.showInfoMessage !== 'function') {
                    window.showInfoMessage = (msg) => window.showNotification(msg, 'info');
                }
                if (typeof window.showSuccessNotification !== 'function') {
                    window.showSuccessNotification = (title, msg) => window.showNotification(`${title}${msg ? `: ${msg}` : ''}`, 'success');
                }
                if (typeof window.showErrorNotification !== 'function') {
                    window.showErrorNotification = (title, msg) => window.showNotification(`${title}${msg ? `: ${msg}` : ''}`, 'error');
                }
            }
        })();

        // ============================================
        // FIN DE FUNCIONES PARA COPY-PASTE
        // ============================================

        // ============================================
        // AUTO-LOOKUP FUNCTIONS FOR VENDOR & PART
        // ============================================

        /**
         * Auto-lookup Vendor Name from VENDORS database
         * @param {string} vendorNumber - The vendor number to lookup
         * @param {string} targetFieldId - The ID of the field to populate with vendor name
         * @param {string} fallbackValue - Fallback value if vendor not found in database
         */
        async function autoLookupVendorName(vendorNumber, targetFieldId, fallbackValue = '') {
            if (!vendorNumber || !vendorNumber.trim()) {
                console.log('⚠️ autoLookupVendorName: Empty vendor number');
                return;
            }

            const vendorNum = vendorNumber.trim();
            console.log(`🔍 Looking up vendor name for: ${vendorNum}`);

            try {
                const cacheBuster = Date.now();
                const url = `http://54.189.226.145/GET_VENDORS.XML?VENDOR_NUMBER=${encodeURIComponent(vendorNum)}&_cb=${cacheBuster}`;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch(url, {
                    method: 'GET',
                    signal: controller.signal,
                    headers: { 'Accept': 'application/xml' }
                });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    console.warn(`⚠️ Vendor lookup failed: ${response.status}`);
                    // Use fallback if API fails
                    if (fallbackValue) {
                        const targetField = document.getElementById(targetFieldId);
                        if (targetField) {
                            targetField.value = fallbackValue;
                            console.log(`📝 Using fallback vendor name: ${fallbackValue}`);
                        }
                    }
                    return;
                }

                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                const vendorNameEl = xmlDoc.querySelector('vendor_name, VENDOR_NAME, name, NAME');
                if (vendorNameEl && vendorNameEl.textContent) {
                    const vendorName = vendorNameEl.textContent.trim();
                    console.log(`✅ Found vendor name: ${vendorName}`);
                    
                    const targetField = document.getElementById(targetFieldId);
                    if (targetField) {
                        targetField.value = vendorName;
                        // Add visual feedback
                        targetField.style.backgroundColor = '#d1fae5';
                        setTimeout(() => {
                            targetField.style.backgroundColor = '';
                        }, 1000);
                    }
                } else {
                    console.warn(`⚠️ Vendor ${vendorNum} not found in database`);
                    // Use fallback if vendor not found
                    if (fallbackValue) {
                        const targetField = document.getElementById(targetFieldId);
                        if (targetField) {
                            targetField.value = fallbackValue;
                            console.log(`📝 Using fallback vendor name: ${fallbackValue}`);
                        }
                    }
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.warn('⚠️ Vendor lookup timeout');
                } else {
                    console.error('❌ Error looking up vendor:', error);
                }
                // Use fallback on error
                if (fallbackValue) {
                    const targetField = document.getElementById(targetFieldId);
                    if (targetField) {
                        targetField.value = fallbackValue;
                        console.log(`📝 Using fallback vendor name due to error: ${fallbackValue}`);
                    }
                }
            }
        }

        /**
         * Auto-lookup Part Description from PARTS database
         * @param {string} partNumber - The part number to lookup
         * @param {string} targetFieldId - The ID of the field to populate with part description
         * @param {string} fallbackValue - Optional fallback value if not found in PARTS
         */
        async function autoLookupPartDescription(partNumber, targetFieldId, fallbackValue) {
            if (!partNumber || !partNumber.trim()) {
                console.log('⚠️ autoLookupPartDescription: Empty part number');
                return;
            }

            const partNum = partNumber.trim().toUpperCase();
            console.log(`🔍 Looking up part description for: ${partNum}`);

            try {
                const cacheBuster = Date.now();
                const url = `http://54.189.226.145/GET_PART.XML?PART_NUMBER=${encodeURIComponent(partNum)}&_cb=${cacheBuster}`;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);

                const response = await fetch(url, {
                    method: 'GET',
                    signal: controller.signal,
                    headers: { 'Accept': 'application/xml' }
                });
                clearTimeout(timeoutId);

                if (!response.ok) {
                    console.warn(`⚠️ Part lookup failed: ${response.status}`);
                    return;
                }

                const xmlText = await response.text();
                console.log(`📄 GET_PART.XML response for ${partNum}:`, xmlText.substring(0, 500));
                
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                
                const descriptionEl = xmlDoc.querySelector('description');
                // Get the status element that is direct child of part_info (not inside part)
                const statusEl = xmlDoc.querySelector('part_info > status');
                
                console.log(`📊 Parsed elements:`, {
                    statusEl: statusEl?.textContent,
                    descriptionEl: descriptionEl?.textContent,
                    hasDescription: !!descriptionEl,
                    descriptionLength: descriptionEl?.textContent?.length
                });
                
                if (statusEl && statusEl.textContent.trim() === 'found' && descriptionEl && descriptionEl.textContent) {
                    const partDesc = descriptionEl.textContent.trim();
                    console.log(`✅ Found part description in PARTS: ${partDesc}`);
                    
                    const targetField = document.getElementById(targetFieldId);
                    if (targetField) {
                        targetField.value = partDesc;
                        // Add visual feedback (blue = from PARTS master)
                        targetField.style.backgroundColor = '#dbeafe';
                        setTimeout(() => {
                            targetField.style.backgroundColor = '';
                        }, 1000);
                    }
                } else {
                    console.warn(`⚠️ Part ${partNum} not found in PARTS database`);
                    // Use fallback value from VENDPRC if available
                    if (fallbackValue && fallbackValue.trim()) {
                        console.log(`📝 Using fallback description from VENDPRC: ${fallbackValue}`);
                        const targetField = document.getElementById(targetFieldId);
                        if (targetField && !targetField.value.trim()) {
                            targetField.value = fallbackValue;
                            // Yellow background = from VENDPRC (not master)
                            targetField.style.backgroundColor = '#fef3c7';
                            setTimeout(() => {
                                targetField.style.backgroundColor = '';
                            }, 1000);
                        }
                    }
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.warn('⚠️ Part lookup timeout');
                } else {
                    console.error('❌ Error looking up part:', error);
                }
                // Use fallback on error
                if (fallbackValue && fallbackValue.trim()) {
                    console.log(`📝 Using fallback description after error: ${fallbackValue}`);
                    const targetField = document.getElementById(targetFieldId);
                    if (targetField && !targetField.value.trim()) {
                        targetField.value = fallbackValue;
                    }
                }
            }
        }

    </script>

    <!-- XML API Integration Script removed - GETCUST.XML is a server endpoint, not a JavaScript file -->

    <!-- API Sync Button - DISABLED to prevent 404 errors -->
    <!-- <div style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
        <button onclick="syncDataWithAPI()" 
                style="
                    background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%);
                    color: white;
                    border: none;
                    padding: 12px 16px;
                    border-radius: 8px;
                    cursor: pointer;
                    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                    font-size: 14px;
                    font-weight: 500;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    transition: all 0.2s ease;
                "
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 12px rgba(0,0,0,0.15)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';">
            <i class="fas fa-sync-alt"></i>
            Sync API
        </button>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <script>
        // ============================================
        // FUNCIONES PICLAN XML API INTEGRATION
        // ============================================

        // Función para consultar PicLan API directamente con retry automático
        async function getCustomerXMLFromAPI(custNumber, partNumber, retryCount = 0) {
            const maxRetries = 2;
            console.log(`🚀 [DEBUG] Iniciando consulta PicLan API (intento ${retryCount + 1}/${maxRetries + 1})`);
            console.log('🚀 [DEBUG] Parámetros recibidos:', { custNumber, partNumber });
            
            try {
                // URL directa al servidor PicLan
                const url = `http://54.189.226.145/GET_VENDPRC.XML?ID=${custNumber}&PART_NUMBER=${partNumber}`;
                
                console.log('🔄 [DEBUG] URL construida:', url);
                console.log('🔄 [DEBUG] Iniciando fetch request...');
                
                // Crear AbortController para timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => {
                    controller.abort();
                }, 8000); // 8 segundos timeout
                
                const response = await fetch(url, {
                    signal: controller.signal,
                    mode: 'cors',
                    cache: 'no-cache', // Evitar problemas de caché
                    headers: {
                        'Accept': 'application/xml, text/xml, */*',
                        'Cache-Control': 'no-cache, no-store, must-revalidate'
                    }
                });
                
                clearTimeout(timeoutId);
                console.log('✅ [DEBUG] Fetch completado. Status:', response.status);
                console.log('✅ [DEBUG] Response headers:', Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    console.error('❌ [DEBUG] Response no OK. Status:', response.status, 'StatusText:', response.statusText);
                    if (response.status === 404) {
                        console.warn('⚠️ [DEBUG] Endpoint no encontrado (404). Registro no existe en PicLan.');
                        return null;
                    }
                    throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                }
                
                console.log('📥 [DEBUG] Obteniendo texto de respuesta...');
                const xmlText = await response.text();
                console.log('📥 [DEBUG] Respuesta XML recibida (longitud:', xmlText.length, '):', xmlText.substring(0, 500) + (xmlText.length > 500 ? '...' : ''));
                
                // Verificar si la respuesta está vacía o indica "no encontrado"
                if (!xmlText || xmlText.trim().length === 0) {
                    console.error('❌ [DEBUG] Respuesta vacía del servidor PicLan');
                    throw new Error('El servidor PicLan devolvió una respuesta vacía.');
                }
                
                // Verificar si la respuesta indica "no encontrado" pero podría ser un problema temporal
                if (xmlText.includes('No record found') || xmlText.includes('Record not found') || xmlText.includes('<error>')) {
                    if (retryCount < maxRetries) {
                        console.warn(`⚠️ [DEBUG] Registro no encontrado en intento ${retryCount + 1}, reintentando en 1 segundo...`);
                        await new Promise(resolve => setTimeout(resolve, 1000)); // Esperar 1 segundo
                        return getCustomerXMLFromAPI(custNumber, partNumber, retryCount + 1);
                    } else {
                        console.warn('⚠️ [DEBUG] No se encontraron registros después de todos los intentos');
                        return null;
                    }
                }
                
                // Parsear XML y convertir a registros
                console.log('🔍 [DEBUG] Iniciando parsing de XML...');
                const parsedRecords = parseXMLToRecords(xmlText);
                console.log('📊 [DEBUG] Registros parseados:', parsedRecords);
                console.log('📊 [DEBUG] Número de registros encontrados:', parsedRecords ? parsedRecords.length : 0);
                
                // Si no se encontraron registros pero tenemos intentos disponibles, reintentar
                if ((!parsedRecords || parsedRecords.length === 0) && retryCount < maxRetries) {
                    console.warn(`⚠️ [DEBUG] No se encontraron registros en intento ${retryCount + 1}, reintentando en 1 segundo...`);
                    await new Promise(resolve => setTimeout(resolve, 1000)); // Esperar 1 segundo
                    return getCustomerXMLFromAPI(custNumber, partNumber, retryCount + 1);
                }
                
                return parsedRecords;
                
            } catch (error) {
                console.error(`❌ Error al consultar PicLan API (intento ${retryCount + 1}):`, error);
                
                // Si tenemos intentos disponibles, reintentar
                if (retryCount < maxRetries) {
                    console.warn(`⚠️ [DEBUG] Error en intento ${retryCount + 1}, reintentando en 2 segundos...`);
                    await new Promise(resolve => setTimeout(resolve, 2000)); // Esperar 2 segundos
                    return getCustomerXMLFromAPI(custNumber, partNumber, retryCount + 1);
                }
                
                // Manejar diferentes tipos de errores
                if (error.name === 'AbortError') {
                    throw new Error('Timeout: La consulta a PicLan tardó demasiado (8 segundos)');
                } else if (error.message.includes('CORS')) {
                    throw new Error('Error de CORS: No se puede acceder al servidor PicLan directamente');
                } else if (error.message.includes('NetworkError') || error.message.includes('Failed to fetch')) {
                    throw new Error('Error de red: No se puede conectar al servidor PicLan');
                }
                
                throw error;
            }
        }

        // Función para parsear XML a registros
        function parseXMLToRecords(xmlString) {
            console.log('🔍 [DEBUG parseXMLToRecords] Iniciando parsing...');
            console.log('🔍 [DEBUG parseXMLToRecords] XML string length:', xmlString.length);
            console.log('🔍 [DEBUG parseXMLToRecords] XML preview:', xmlString.substring(0, 200));
            
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, 'text/xml');
            
            // Verificar si hay errores de parsing
            const parseError = xmlDoc.querySelector('parsererror');
            if (parseError) {
                console.error('❌ [DEBUG parseXMLToRecords] Error de parsing XML:', parseError.textContent);
                return [];
            }
            
            console.log('🔍 [DEBUG parseXMLToRecords] XML parseado correctamente');
            console.log('🔍 [DEBUG parseXMLToRecords] Root element:', xmlDoc.documentElement.tagName);
            
            const parsed = [];
            
            // Intentar diferentes selectores basados en la estructura del XML
            let customerNodes = xmlDoc.querySelectorAll('CUSTOMER');
            console.log('🔍 [DEBUG parseXMLToRecords] Nodos CUSTOMER encontrados:', customerNodes.length);
            
            if (customerNodes.length === 0) {
                // Intentar con 'record' (basado en GET_VENDPRC.XML)
                customerNodes = xmlDoc.querySelectorAll('record');
                console.log('🔍 [DEBUG parseXMLToRecords] Nodos record encontrados:', customerNodes.length);
            }
            
            if (customerNodes.length === 0) {
                // Intentar con 'customers > record'
                customerNodes = xmlDoc.querySelectorAll('customers record');
                console.log('🔍 [DEBUG parseXMLToRecords] Nodos customers>record encontrados:', customerNodes.length);
            }
            
            if (customerNodes.length === 0) {
                console.warn('⚠️ [DEBUG parseXMLToRecords] No se encontraron nodos de customer en ningún formato');
                console.log('🔍 [DEBUG parseXMLToRecords] Estructura XML completa:', new XMLSerializer().serializeToString(xmlDoc));
                return [];
            }
            
            customerNodes.forEach(customerNode => {
                const record = {
                    id: getXMLTextContent(customerNode, 'ID') || getXMLTextContent(customerNode, 'id') ||
                        getXMLTextContent(customerNode, 'vendorNumber') || getXMLTextContent(customerNode, 'VENDOR_NUMBER'),
                    partNumber: getXMLTextContent(customerNode, 'partNumber') || getXMLTextContent(customerNode, 'PART_NUMBER'),
                    vendorno: getXMLTextContent(customerNode, 'vendorNumber') || getXMLTextContent(customerNode, 'VENDOR_NUMBER'),
                    customer: getXMLTextContent(customerNode, 'vendorName') || getXMLTextContent(customerNode, 'VENDOR_NAME'),
                    vendorNumber: getXMLTextContent(customerNode, 'vendorNumber') || getXMLTextContent(customerNode, 'VENDOR_NUMBER'),
                    vendorName: getXMLTextContent(customerNode, 'vendorName') || getXMLTextContent(customerNode, 'VENDOR_NAME'),
                    partDescription: getXMLTextContent(customerNode, 'partDescription') || getXMLTextContent(customerNode, 'DESCRIPTION'),
                    lastUpdated: getXMLTextContent(customerNode, 'LAST_UPDATED'),
                    notes: getXMLTextContent(customerNode, 'notes') || getXMLTextContent(customerNode, 'NOTES'),
                    date: getXMLTextContent(customerNode, 'date') || getXMLTextContent(customerNode, 'DATE'),
                    priceRanges: []
                };
                
                // Parsear price ranges
               // Parsear price ranges - CORREGIDO para tu estructura XML
               const priceRangeNodes = customerNode.querySelectorAll('range');
console.log('🔍 [DEBUG] Nodos <range> encontrados:', priceRangeNodes.length);

priceRangeNodes.forEach((rangeNode, index) => {
    console.log(`🔍 [DEBUG] Range ${index}:`, rangeNode);
    console.log(`🔍 [DEBUG] fromQty:`, getXMLTextContent(rangeNode, 'fromQty'));
    console.log(`🔍 [DEBUG] toQty:`, getXMLTextContent(rangeNode, 'toQty'));
    console.log(`🔍 [DEBUG] price:`, getXMLTextContent(rangeNode, 'price'));
    console.log(`🔍 [DEBUG] MIN_QTY (fallback):`, getXMLTextContent(rangeNode, 'MIN_QTY'));
    console.log(`🔍 [DEBUG] MAX_QTY (fallback):`, getXMLTextContent(rangeNode, 'MAX_QTY'));
    console.log(`🔍 [DEBUG] PRICE (fallback):`, getXMLTextContent(rangeNode, 'PRICE'));
    
    const fromQty = parseInt(getXMLTextContent(rangeNode, 'fromQty') || getXMLTextContent(rangeNode, 'MIN_QTY')) || 0;
    const toQty = parseInt(getXMLTextContent(rangeNode, 'toQty') || getXMLTextContent(rangeNode, 'MAX_QTY')) || 0;
    const price = parseFloat(getXMLTextContent(rangeNode, 'price') || getXMLTextContent(rangeNode, 'PRICE')) || 0;
    
    console.log(`🔍 [DEBUG] Converted values:`, { fromQty, toQty, price });
    
    if (fromQty > 0 || toQty > 0 || price > 0) {
        record.priceRanges.push({
            fromQty: fromQty,
            toQty: toQty,
            price: price
        });
        console.log('✅ [DEBUG] Range added to record');
    } else {
        console.log('❌ [DEBUG] Range NOT added - all values are 0');
    }
});

console.log('📊 [DEBUG] Final record.priceRanges:', record.priceRanges);     
         
        parsed.push(record);
    });
    
    return parsed;
}

        // (removed duplicate getXMLTextContent; unified varargs version is defined earlier)

        // Función para mostrar registros de la API en formato legible
        function displayAPIRecord(record) {
            // Validar que el record existe
            if (!record) {
                return '<div class="api-record-display"><p>❌ No se pudo mostrar el registro</p></div>';
            }
            
            // Asegurar que priceRanges existe como array
            const priceRanges = record.priceRanges || [];
            const recordId = `api_${record.id || Date.now()}`;
            
            return `
                <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border: 2px solid #3b82f6; border-radius: 8px; padding: 20px; margin-bottom: 16px;">
                    <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
                        <div style="background: #3b82f6; color: white; padding: 6px 12px; border-radius: 6px; font-size: 0.9em; font-weight: 600;">
                            <i class="fas fa-database"></i> Encontrado en PicLan
                        </div>
                        <h4 style="color: #3b82f6; margin: 0;">Part ${record.partNumber || 'N/A'} - Customer #${record.vendorno || 'N/A'}</h4>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 16px;">
                        <div><strong style="color: #374151;">ID:</strong> ${record.id || 'N/A'}</div>
                        <div><strong style="color: #374151;">Part Number:</strong> ${record.partNumber || 'N/A'}</div>
                        <div><strong style="color: #374151;">Vendor Number:</strong> ${record.vendorno || 'N/A'}</div>
                        <div><strong style="color: #374151;">Customer Name:</strong> ${record.customer || 'N/A'}</div>
                        <div><strong style="color: #374151;">Description:</strong> ${record.partDescription || 'N/A'}</div>
                        <div><strong style="color: #374151;">Notes:</strong> ${record.notes || 'N/A'}</div>
                    </div>
                    
                    <div style="background: white; border: 1px solid #3b82f6; border-radius: 6px; padding: 12px; margin-bottom: 16px;">
                        <h5 style="margin: 0 0 8px 0; color: #374151; display: flex; align-items: center; gap: 6px;">
                            <i class="fas fa-dollar-sign" style="color: #3b82f6;"></i> Price Ranges:
                        </h5>
                        ${priceRanges.length > 0 ? 
                            priceRanges.map(range => `
                                <div style="padding: 4px 0; border-bottom: 1px solid #e5e7eb;">
                                    <span style="color: #6b7280;">Qty ${range.fromQty || '?'}-${range.toQty || '?'}: </span>
                                    <span style="font-weight: 600; color: #059669;">$${(range.price != null && range.price !== '' ? parseFloat(range.price).toFixed(3) : '0.000')}</span>
                                </div>
                            `).join('') : 
                            '<p style="color: #6b7280; font-style: italic; margin: 0;">No price ranges available</p>'
                        }
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: center;">
                        <button onclick="saveAPIRecordToLocalDirectly('${recordId}', ${JSON.stringify(record).replace(/"/g, '&quot;')})" style="
                            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                            color: white; border: none; padding: 10px 20px; border-radius: 6px;
                            font-size: 0.95em; font-weight: 600; cursor: pointer;
                            display: flex; align-items: center; gap: 8px;
                            transition: all 0.2s ease;
                            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.25);
                        " onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                            <i class="fas fa-download"></i> Save to Local Storage
                        </button>
                    </div>
                </div>
            `;
        }


        // Función para integrar búsqueda PicLan en Data Capture
        async function searchPicLanInCapture(partNumber, vendorNumber) {
            try {
                console.log('🔍 Buscando en PicLan API:', { partNumber, vendorNumber });
                
                // Mostrar loading
                const resultArea = document.getElementById('captureResultsArea');
                if (resultArea) {
                    resultArea.innerHTML = `
                        <div style="text-align: center; padding: 20px; background: #f0f9ff; border: 2px solid #3b82f6; border-radius: 8px;">
                            <div style="display: inline-flex; align-items: center; gap: 12px; color: #3b82f6; font-weight: 600;">
                                <i class="fas fa-spinner fa-spin"></i>
                                Consultando PicLan Database...
                            </div>
                        </div>
                    `;
                    resultArea.style.display = 'block';
                }
                
                // Consultar API de PicLan con timeout
                console.log('🚀 [DEBUG] Iniciando consulta PicLan API con parámetros:', { vendorNumber, partNumber });
                
                const apiRecords = await Promise.race([
                    getCustomerXMLFromAPI(vendorNumber, partNumber),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout: PicLan API no responde')), 5000)
                    )
                ]);
                
                console.log('🚀 [DEBUG] Respuesta de PicLan API recibida:', apiRecords);
                
                if (apiRecords && apiRecords.length > 0) {
                    const apiRecord = apiRecords[0];
                    console.log('✅ Registro encontrado en PicLan API:', apiRecord);
                    
                    // Mostrar los datos de la API
                    if (resultArea) {
                        const htmlContent = displayAPIRecord(apiRecord);
                        resultArea.innerHTML = htmlContent;
                        resultArea.style.display = 'block';
                    }
                    
                    showNotification('✅ Encontrado en PicLan Database', 'success');
                    return apiRecord;
                } else {
                    console.log('ℹ️ No se encontraron registros en PicLan API');
                    return null;
                }
                
            } catch (error) {
                console.error('❌ Error al consultar PicLan API:', error);
                
                // Limpiar área de loading
                const resultArea = document.getElementById('captureResultsArea');
                if (resultArea) {
                    resultArea.innerHTML = '';
                    resultArea.style.display = 'none';
                }
                
                // Mostrar error específico
                let errorMessage = 'Error desconocido';
                if (error.message.includes('Timeout')) {
                    errorMessage = 'El servidor PicLan no responde. Verifique la conexión.';
                } else if (error.message.includes('CORS')) {
                    errorMessage = 'No se puede acceder al servidor PicLan directamente desde el navegador';
                } else if (error.message.includes('network') || error.message.includes('Failed to fetch')) {
                    errorMessage = 'No se puede conectar al servidor PicLan';
                } else {
                    errorMessage = error.message;
                }
                
                showNotification(`❌ Error PicLan: ${errorMessage}`, 'error');
                return null;
            }
        }

        // Función para agregar botón "Get XML" en Data Capture
        function addGetXMLButton() {
            const actionButtons = document.getElementById('captureActionButtons');
            if (actionButtons && !document.getElementById('getXMLButton')) {
                const getXMLButton = document.createElement('button');
                getXMLButton.id = 'getXMLButton';
                getXMLButton.type = 'button';
                getXMLButton.onclick = getCustomerXML;
                getXMLButton.style.cssText = `
                    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
                    color: white; padding: 12px 24px; border: none; border-radius: 6px;
                    font-size: 1em; cursor: pointer; display: inline-flex;
                    align-items: center; gap: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                    transition: all 0.2s ease;
                `;
                getXMLButton.innerHTML = '<i class="fas fa-database"></i> Get from PicLan';
                
                getXMLButton.onmouseover = function() {
                    this.style.transform = 'translateY(-1px)';
                    this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.15)';
                };
                getXMLButton.onmouseout = function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                };
                
                actionButtons.appendChild(getXMLButton);
            }
        }

        // Ensure loading toast is hidden on unhandled promise rejection
        window.addEventListener('unhandledrejection', (e) => {
          console.error('Unhandled promise rejection:', e.reason);
          if (typeof hideLoadingNotification === 'function') hideLoadingNotification();
          if (typeof showErrorNotification === 'function') {
            showErrorNotification('Error de red', 'La consulta tardó demasiado o falló. Intenta de nuevo.');
          }
        });

    </script>

</body>
</html>