<PRE>
PicLan-IP/BASIC

OPEN 'XMLDATA' TO XMLDATAF ELSE STOP 201,'XMLDATA'
OPEN 'PO2' TO PO2F ELSE STOP 201,'PO2'

XVM = CHAR(253)
XSM = CHAR(252)

PL_GETVAR PO_NUMBER FROM 'po_number' ELSE PO_NUMBER = ''
PL_GETVAR PO_DATE FROM 'po_date' ELSE PO_DATE = ''
PL_GETVAR VENDOR_CODE FROM 'vendor_code' ELSE VENDOR_CODE = ''
PL_GETVAR SHIPTO_CODE FROM 'shipto_code' ELSE SHIPTO_CODE = ''
PL_GETVAR BUYER_CODE FROM 'buyer_code' ELSE BUYER_CODE = ''
PL_GETVAR PO_STATUS FROM 'po_status' ELSE PO_STATUS = ''
PL_GETVAR EMAIL FROM 'email' ELSE EMAIL = ''
PL_GETVAR HEADER_NOTES FROM 'header_notes' ELSE HEADER_NOTES = ''
PL_GETVAR LINE_ITEMS_JSON FROM 'line_items' ELSE LINE_ITEMS_JSON = ''
PL_GETVAR SCHEDULE_DATA FROM 'schedule_data' ELSE SCHEDULE_DATA = ''
PL_GETVAR NEEDS_DATA FROM 'needs_data' ELSE NEEDS_DATA = ''
PL_GETVAR ACK_DATA FROM 'ack_data' ELSE ACK_DATA = ''

XML.RESPONSE = '<?xml version="1.0"?><update_response>'
XML.RESPONSE = XML.RESPONSE : '<debug_start>UPDATE_PO2_EXECUTING</debug_start>'

IF PO_NUMBER = "" THEN
    XML.RESPONSE = XML.RESPONSE : '<error>PO Number is required</error></update_response>'
    WRITE XML.RESPONSE ON XMLDATAF,'UPDATE_PO2.XML'
    ERR = ''
    CALL PLW.PAGE('/XMLDATA/UPDATE_PO2.XML','',ERR)
    RETURN
END

READ PO.RECORD FROM PO2F, PO_NUMBER ELSE GOTO PO_NOT_FOUND

XML.RESPONSE = XML.RESPONSE : '<debug_record_before>FIELD1=' : PO.RECORD<1> : '</debug_record_before>'
XML.RESPONSE = XML.RESPONSE : '<debug_record_before>FIELD7=' : PO.RECORD<7> : '</debug_record_before>'

* Update basic fields using same positions as GET_PO2_PRODUCTION.XML
IF PO_DATE <> "" THEN PO.RECORD<1> = PO_DATE
IF VENDOR_CODE <> "" THEN PO.RECORD<7> = VENDOR_CODE
IF SHIPTO_CODE <> "" THEN PO.RECORD<4> = SHIPTO_CODE
IF BUYER_CODE <> "" THEN PO.RECORD<8> = BUYER_CODE
IF PO_STATUS <> "" THEN PO.RECORD<15> = PO_STATUS 
IF EMAIL <> "" THEN PO.RECORD<80> = EMAIL

IF HEADER_NOTES <> "" THEN
    CONVERT "|" TO XVM IN HEADER_NOTES
    PO.RECORD<25> = HEADER_NOTES
END

IF LINE_ITEMS_JSON <> "" THEN
    PART_NUMBERS_MV = ""
    UNIT_PRICES_MV = ""
    QUANTITIES_MV = ""
    
    CONVERT "|" TO XVM IN LINE_ITEMS_JSON
    LINE_COUNT = DCOUNT(LINE_ITEMS_JSON, XVM)
    
    FOR I = 1 TO LINE_COUNT
        LINE_DATA = LINE_ITEMS_JSON<1,I>
        IF LINE_DATA <> "" THEN
            PART_NUM = FIELD(LINE_DATA, "*", 1)
            QTY = FIELD(LINE_DATA, "*", 2)  
            UNIT_PRICE = FIELD(LINE_DATA, "*", 3)
            
            IF PART_NUMBERS_MV = "" THEN
                PART_NUMBERS_MV = PART_NUM
            ELSE
                PART_NUMBERS_MV = PART_NUMBERS_MV : XVM : PART_NUM
            END
            
            IF QUANTITIES_MV = "" THEN
                QUANTITIES_MV = QTY
            ELSE
                QUANTITIES_MV = QUANTITIES_MV : XVM : QTY
            END
            
            IF UNIT_PRICE <> "" AND NUM(UNIT_PRICE) THEN
                PRICE_INT = UNIT_PRICE * 100
                IF UNIT_PRICES_MV = "" THEN
                    UNIT_PRICES_MV = PRICE_INT
                ELSE
                    UNIT_PRICES_MV = UNIT_PRICES_MV : XVM : PRICE_INT
                END
            END
        END
    NEXT I
    
    IF PART_NUMBERS_MV <> "" THEN PO.RECORD<32> = PART_NUMBERS_MV
    IF QUANTITIES_MV <> "" THEN PO.RECORD<31> = QUANTITIES_MV  
    IF UNIT_PRICES_MV <> "" THEN PO.RECORD<36> = UNIT_PRICES_MV
END

IF NEEDS_DATA <> "" THEN
    MAT TRACK_ARRAY = ""
    MAX_TRACK_IDX = 0
    CONVERT "|" TO XVM IN NEEDS_DATA
    DEBUG_VALUE = NEEDS_DATA
    CONVERT CHAR(252) TO '\\' IN DEBUG_VALUE
    CONVERT CHAR(253) TO '|' IN DEBUG_VALUE
    CONVERT CHAR(254) TO '^' IN DEBUG_VALUE
    XML.RESPONSE = XML.RESPONSE : '<debug_needs_received>' : DEBUG_VALUE : '</debug_needs_received>'
    NEEDS_COUNT = DCOUNT(NEEDS_DATA, XVM)
    FOR I = 1 TO NEEDS_COUNT
        NEED_ITEM = NEEDS_DATA<1,I>
        IF NEED_ITEM <> "" THEN
            TARGET_IDX = I
            RAW_SEGMENTS = NEED_ITEM
            IF INDEX(NEED_ITEM, ':', 1) > 0 THEN
                TARGET_IDX = FIELD(NEED_ITEM, ':', 1)
                RAW_SEGMENTS = FIELD(NEED_ITEM, ':', 2)
            END
            RAW_SEGMENTS = TRIM(RAW_SEGMENTS)
            IF NUM(TARGET_IDX) = 0 THEN TARGET_IDX = I
            SUB_BUFFER = ""
            IF RAW_SEGMENTS <> "" THEN
                NEED_DATE = FIELD(RAW_SEGMENTS, '*', 1)
                NEED_QTY = FIELD(RAW_SEGMENTS, '*', 2)
                IF INDEX(NEED_DATE, ':', 1) > 0 THEN NEED_DATE = FIELD(NEED_DATE, ':', 2)
                IF NEED_DATE <> "" AND NEED_QTY <> "" AND NEED_QTY <> "0" THEN
                    ENTRY_OUT = NEED_DATE : '*' : NEED_QTY
                    SUB_BUFFER = ENTRY_OUT
                    DEBUG_VALUE = ENTRY_OUT
                    CONVERT CHAR(252) TO '\' IN DEBUG_VALUE
                    CONVERT CHAR(253) TO ']' IN DEBUG_VALUE
                    CONVERT CHAR(254) TO '^' IN DEBUG_VALUE
                    XML.RESPONSE = XML.RESPONSE : '<debug_need_saved>' : DEBUG_VALUE : '</debug_need_saved>'
                ELSE
                    DEBUG_VALUE = RAW_SEGMENTS
                    CONVERT CHAR(252) TO '\' IN DEBUG_VALUE
                    CONVERT CHAR(253) TO ']' IN DEBUG_VALUE
                    CONVERT CHAR(254) TO '^' IN DEBUG_VALUE
                    XML.RESPONSE = XML.RESPONSE : '<debug_need_blocked>BLOCKED:'
                    XML.RESPONSE = XML.RESPONSE : DEBUG_VALUE : '</debug_need_blocked>'
                END
            END
            IF SUB_BUFFER <> "" THEN
                IF TRACK_ARRAY(TARGET_IDX) = "" THEN
                    TRACK_ARRAY(TARGET_IDX) = SUB_BUFFER
                ELSE
                    TRACK_ARRAY(TARGET_IDX) = TRACK_ARRAY(TARGET_IDX) : XSM : SUB_BUFFER
                END
                IF TARGET_IDX > MAX_TRACK_IDX THEN MAX_TRACK_IDX = TARGET_IDX
            END
        END
    NEXT I
    NEEDS_MV = ""
    FOR I = 1 TO MAX_TRACK_IDX
        LINE_DATA = TRACK_ARRAY(I)
        IF LINE_DATA <> "" THEN
            IF NEEDS_MV = "" THEN
                NEEDS_MV = LINE_DATA
            ELSE
                NEEDS_MV = NEEDS_MV : XVM : LINE_DATA
            END
        END
    NEXT I
    IF NEEDS_MV <> "" THEN PO.RECORD<38> = NEEDS_MV
END

IF ACK_DATA <> "" THEN
    MAT TRACK_ARRAY = ""
    MAX_TRACK_IDX = 0
    CONVERT "|" TO XVM IN ACK_DATA
    DEBUG_VALUE = ACK_DATA
    CONVERT CHAR(252) TO '\\' IN DEBUG_VALUE
    CONVERT CHAR(253) TO '|' IN DEBUG_VALUE
    CONVERT CHAR(254) TO '^' IN DEBUG_VALUE
    XML.RESPONSE = XML.RESPONSE : '<debug_ack_received>' : DEBUG_VALUE : '</debug_ack_received>'
    ACK_COUNT = DCOUNT(ACK_DATA, XVM)
    FOR I = 1 TO ACK_COUNT
        ACK_ITEM = ACK_DATA<1,I>
        IF ACK_ITEM <> "" THEN
            TARGET_IDX = I
            RAW_SEGMENTS = ACK_ITEM
            IF INDEX(ACK_ITEM, ':', 1) > 0 THEN
                TARGET_IDX = FIELD(ACK_ITEM, ':', 1)
                RAW_SEGMENTS = FIELD(ACK_ITEM, ':', 2)
            END
            RAW_SEGMENTS = TRIM(RAW_SEGMENTS)
            IF NUM(TARGET_IDX) = 0 THEN TARGET_IDX = I
            IF RAW_SEGMENTS <> "" THEN
                ACK_DATE = FIELD(RAW_SEGMENTS, '*', 1)
                ACK_QTY = FIELD(RAW_SEGMENTS, '*', 2)
                IF INDEX(ACK_DATE, ':', 1) > 0 THEN ACK_DATE = FIELD(ACK_DATE, ':', 2)
                IF ACK_DATE <> "" AND ACK_QTY <> "" AND ACK_QTY <> "0" THEN
                    ENTRY_OUT = ACK_DATE : '*' : ACK_QTY
                    IF TRACK_ARRAY(TARGET_IDX) = "" THEN
                        TRACK_ARRAY(TARGET_IDX) = ENTRY_OUT
                    ELSE
                        TRACK_ARRAY(TARGET_IDX) = TRACK_ARRAY(TARGET_IDX) : XSM : ENTRY_OUT
                    END
                    IF TARGET_IDX > MAX_TRACK_IDX THEN MAX_TRACK_IDX = TARGET_IDX
                    DEBUG_VALUE = ENTRY_OUT
                    CONVERT CHAR(252) TO '\' IN DEBUG_VALUE
                    CONVERT CHAR(253) TO ']' IN DEBUG_VALUE
                    CONVERT CHAR(254) TO '^' IN DEBUG_VALUE
                    XML.RESPONSE = XML.RESPONSE : '<debug_ack_saved>' : DEBUG_VALUE : '</debug_ack_saved>'
                END
            END
        END
    NEXT I
    ACK_MV = ""
    FOR I = 1 TO MAX_TRACK_IDX
        LINE_DATA = TRACK_ARRAY(I)
        IF LINE_DATA <> "" THEN
            IF ACK_MV = "" THEN
                ACK_MV = LINE_DATA
            ELSE
                ACK_MV = ACK_MV : XVM : LINE_DATA
            END
        END
    NEXT I
    IF ACK_MV <> "" THEN PO.RECORD<49> = ACK_MV
END

XML.RESPONSE = XML.RESPONSE : '<debug_record_after>FIELD1=' : PO.RECORD<1> : '</debug_record_after>'
XML.RESPONSE = XML.RESPONSE : '<debug_record_after>FIELD7=' : PO.RECORD<7> : '</debug_record_after>'

WRITE PO.RECORD ON PO2F, PO_NUMBER

XML.RESPONSE = XML.RESPONSE : '<status>SUCCESS</status>'
XML.RESPONSE = XML.RESPONSE : '<message>PO updated successfully</message>'
XML.RESPONSE = XML.RESPONSE : '<po_number>' : PO_NUMBER : '</po_number>'
XML.RESPONSE = XML.RESPONSE : '</update_response>'

WRITE XML.RESPONSE ON XMLDATAF,'UPDATE_PO2.XML'
ERR = ''
CALL PLW.PAGE('/XMLDATA/UPDATE_PO2.XML','',ERR)
RETURN

PO_NOT_FOUND:
XML.RESPONSE = XML.RESPONSE : '<status>ERROR</status>'
XML.RESPONSE = XML.RESPONSE : '<message>PO Number not found</message>'
XML.RESPONSE = XML.RESPONSE : '<po_number>' : PO_NUMBER : '</po_number>'
XML.RESPONSE = XML.RESPONSE : '</update_response>'

WRITE XML.RESPONSE ON XMLDATAF,'UPDATE_PO2.XML'
ERR = ''
CALL PLW.PAGE('/XMLDATA/UPDATE_PO2.XML','',ERR)

</PRE>
