<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TAIMEX - SHIPMENTS</title>
  
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta http-equiv="Last-Modified" content="0">
  <meta http-equiv="If-Modified-Since" content="0">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <style>
*{margin:0;padding:0;box-sizing:border-box}html,body{height:100vh;overflow:hidden;width:100%}body{font-family:Inter,-apple-system,BlinkMacSystemFont,Segoe UI,sans-serif;background:linear-gradient(135deg,#f1f5f9 0%,#e2e8f0 100%);color:#334155;width:100%}.container{width:100%;height:100vh;background:#fff;display:flex;flex-direction:column;overflow:hidden}.header{background:linear-gradient(135deg,#1e293b 0%,#1e3a8a 100%);color:#fff;padding:12px 24px;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 8px rgba(30,41,59,.25);position:relative;z-index:100;width:100%}.header-left{display:flex;align-items:center;gap:20px;position:relative;z-index:1}.logo-section img{height:40px;width:auto;object-fit:contain;filter:brightness(1.05)}.title-section{text-align:right;position:relative;z-index:1}.title-row{display:flex;align-items:center;justify-content:flex-end;gap:15px}.welcome-user{white-space:nowrap}.welcome-user span{color:#cbd5e1;font-size:.8em;font-weight:400}.welcome-user strong{color:#3b82f6;margin-left:4px;font-weight:600}.title-section h2{font-size:.95em;margin:0;font-weight:500;color:#cbd5e1;letter-spacing:.3px}.title-section p{font-size:.75em;margin:2px 0 0 0;color:#a2a8ba;font-weight:400}.hamburger-menu{background:none;border:none;color:#fff;font-size:1.2em;cursor:pointer;padding:8px;border-radius:6px;transition:background-color .2s ease}.hamburger-menu:hover{background-color:rgba(255,255,255,.12)}.hamburger-menu svg{width:20px;height:20px;fill:currentColor}.main-content{flex:1;display:flex;flex-direction:column;overflow:hidden;width:100%}.sidebar{position:fixed;top:0;left:-300px;width:300px;height:100vh;background:rgba(255,255,255,.08);backdrop-filter:blur(1px);-webkit-backdrop-filter:blur(1px);color:#fff;transition:left .2s ease;z-index:2000;box-shadow:2px 0 12px rgba(0,0,0,.35)}.sidebar.active{left:0}.sidebar-overlay{position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,.55);opacity:0;visibility:hidden;transition:all .25s ease;z-index:1500;pointer-events:none}#sb-toggle:checked~.sidebar-overlay{opacity:1;visibility:visible;pointer-events:auto}#sb-toggle:checked~.sidebar{left:0}#sb-toggle{display:none}.sidebar-header{background:linear-gradient(135deg,#1e293b 0%,#1e3a8a 100%);padding:20px;border-bottom:1px solid rgba(255,255,255,.1)}.sidebar-header h3{font-size:1.4em;font-weight:600;margin:0}.sidebar-content{padding:15px 0;overflow-y:auto;max-height:calc(100vh - 100px)}.sidebar-menu{list-style:none;padding:0;margin:0}.sidebar-menu li{margin-bottom:2px}.sidebar-menu li label{display:block;padding:14px 24px;cursor:pointer;transition:all .2s ease;color:#fff;font-weight:500;border-left:3px solid transparent}.sidebar-menu li label:hover{background:rgba(255,255,255,.15);border-left-color:rgba(255,255,255,.4)}.sidebar-menu li label.active{background:rgba(59,130,246,.25);border-left-color:#3b82f6}

.step-card{background:white;border-radius:8px;padding:16px;margin-bottom:12px;box-shadow:0 1px 4px rgba(0,0,0,0.04);border:1px solid transparent;transition:all 0.2s ease;display:none;max-width:95%;margin-left:auto;margin-right:auto}.step-card.active{display:block;border-color:#2a5298;box-shadow:0 2px 8px rgba(42,82,152,0.08)}.step-card-header{display:flex;align-items:center;gap:12px;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid #f1f5f9}.step-icon{width:36px;height:36px;border-radius:6px;background:linear-gradient(135deg,#eff6ff,#dbeafe);display:flex;align-items:center;justify-content:center;font-size:18px;color:#2a5298}.step-title{flex:1}.step-title h3{margin:0;font-size:15px;font-weight:700;color:#1e293b;display:flex;align-items:center;gap:6px}.step-title p{margin:2px 0 0 0;font-size:11px;color:#64748b}.field-group{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:12px;margin-bottom:12px}.field-wrapper{position:relative}.field-wrapper label{display:block;font-size:12px;font-weight:600;color:#374151;margin-bottom:5px}.field-wrapper label .required-mark{color:#ef4444;margin-left:2px}.field-wrapper input,.field-wrapper select,.field-wrapper textarea{width:100%;border:1px solid #e5e7eb;border-radius:4px;padding:7px 10px;font-size:13px;transition:all 0.15s ease;background:white}.field-wrapper input:focus,.field-wrapper select:focus,.field-wrapper textarea:focus{outline:none;border-color:#2a5298;box-shadow:0 0 0 2px rgba(42,82,152,0.08)}.field-wrapper input.valid{border-color:#2a5298}.field-wrapper input.invalid{border-color:#ef4444}.content-wrapper{padding:20px;overflow-y:auto;flex:1}.step-wizard{background:white;border-radius:12px;padding:24px;margin-bottom:20px;box-shadow:0 2px 8px rgba(0,0,0,0.08)}.step-navigation{display:flex;justify-content:space-between;align-items:center;margin-top:16px;padding-top:12px;border-top:1px solid #f1f5f9}.info-box{background:linear-gradient(135deg,#eff6ff 0%,#f0f9ff 100%);border:1px solid #dbeafe;border-radius:8px;padding:12px 16px;margin-bottom:16px;display:flex;gap:12px}.info-box-icon{font-size:18px;color:#2a5298}.info-box-content strong{display:block;color:#1e293b;font-size:13px;font-weight:600;margin-bottom:4px}.info-box-content p{margin:0;font-size:12px;color:#64748b;line-height:1.5}.form-group{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:20px}.form-group label{font-size:0.9em;font-weight:600;color:#475569;margin-bottom:6px}.form-group input,.form-group select,.form-group textarea{padding:10px 12px;border:1px solid #cbd5e1;border-radius:8px;font-size:0.95em;transition:all 0.2s}.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,0.1)}.form-group textarea{min-height:80px;resize:vertical;font-family:inherit}

.btn{padding:12px 24px;border:none;border-radius:8px;font-size:0.95em;font-weight:600;cursor:pointer;transition:all 0.2s;display:inline-flex;align-items:center;gap:8px}.btn-primary{background:linear-gradient(135deg,#3b82f6 0%,#1e40af 100%);color:white}.btn-primary:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(59,130,246,0.4)}.btn-success{background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:white}.btn-success:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(16,185,129,0.4)}.btn-secondary{background:#64748b;color:white}.btn-secondary:hover{background:#475569}.btn-danger{background:#ef4444;color:white}.btn-danger:hover{background:#dc2626}.btn-step{border:none;border-radius:6px;padding:10px 18px;font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s ease;display:inline-flex;align-items:center;gap:8px;background:white;color:#64748b;border:1px solid #e5e7eb}.btn-step:hover{background:#f9fafb}.btn-step-primary{background:linear-gradient(135deg,#2a5298 0%,#1e3c72 100%);color:white;border:none}.btn-step-primary:hover{box-shadow:0 4px 12px rgba(42,82,152,0.25)}.btn-step-primary:disabled{background:#cbd5e1;color:#94a3b8;cursor:not-allowed;box-shadow:none}.btn-step-secondary{background:white;color:#374151;border:1px solid #d1d5db}.btn-step-secondary:hover{border-color:#2a5298;color:#2a5298}

.line-items-table{width:100%;border-collapse:collapse;margin-top:20px}.line-items-table thead{background:linear-gradient(135deg,#2a5298 0%,#1e3c72 100%);color:white}.line-items-table th{padding:12px;text-align:left;font-weight:600;font-size:0.9em}.line-items-table td{padding:10px 12px;border-bottom:1px solid #e2e8f0}.line-items-table tbody tr:hover{background:#f8fafc}.line-items-table input{width:100%;padding:6px 8px;border:1px solid #cbd5e1;border-radius:4px}

.status-badge { padding: 4px 12px; border-radius: 12px; font-size: 0.85em; font-weight: 600; display: inline-block; }
.status-new { background: #dbeafe; color: #1e40af; }
.status-saved { background: #d1fae5; color: #065f46; }

.alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; display: flex; align-items: center; gap: 10px; }
.alert-info { background: #dbeafe; color: #1e40af; border-left: 4px solid #3b82f6; }
.alert-success { background: #d1fae5; color: #065f46; border-left: 4px solid #10b981; }
.alert-error { background: #fee2e2; color: #991b1b; border-left: 4px solid #ef4444; }

.field-hint{font-size:0.78em;color:#64748b;margin-top:6px;display:block}.action-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px}.search-box{display:flex;gap:10px;flex:1;max-width:100%}.search-box input{flex:1;padding:10px 12px;border:1px solid #cbd5e1;border-radius:8px}

.hidden{display:none !important}

/* Sidebar Styles - Matching SO_EDIT */
.sidebar-menu{list-style:none !important;padding:0 !important;margin:0 !important}.sidebar-menu li{margin-bottom:8px !important}.sidebar-menu a,.sidebar-menu label{display:block !important;padding:12px 16px !important;color:#f3f4f6 !important;text-decoration:none !important;border-radius:6px !important;transition:all 0.2s ease !important;font-weight:500 !important}.sidebar-menu a:hover,.sidebar-menu label:hover{background-color:rgba(30,64,175,0.1) !important;color:white !important}.sidebar-menu a.active,.sidebar-menu label.active{background-color:rgba(30,64,175,0.2) !important;color:#93c5fd !important}.sidebar-menu a i,.sidebar-menu label i{margin-right:12px !important;width:20px !important;text-align:center !important}.sidebar-menu label{cursor:pointer !important}
  </style>
</head>
<body>
  <input type="checkbox" id="sb-toggle" />
  <label for="sb-toggle" class="sidebar-overlay"></label>
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h3>Menu</h3>
    </div>
    <div class="sidebar-content">
      <ul class="sidebar-menu">
        <li><label for="sb-toggle">Main Menu</label></li>
        <li><label for="sb-toggle">Parts Management</label></li>
        <li><label for="sb-toggle">Work Orders</label></li>
        <li><label for="sb-toggle">Sales Orders</label></li>
        <li><label for="sb-toggle">Stock Transactions</label></li>
        <li><label for="sb-toggle">Commodities</label></li>
        <li><label for="sb-toggle" class="active">Shipments</label></li>
      </ul>
    </div>
  </div>

  <div class="container">
    <div class="header">
      <div class="header-left">
        <label class="hamburger-menu" for="sb-toggle" aria-label="Open menu">
          <svg viewBox="0 0 448 512" role="img" aria-hidden="true" focusable="false">
            <path d="M0 96C0 78.3 14.3 64 32 64H416C433.7 64 448 78.3 448 96C448 113.7 433.7 128 416 128H32C14.3 128 0 113.7 0 96zM0 256C0 238.3 14.3 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.3 288 0 273.7 0 256zM448 416C448 433.7 433.7 448 416 448H32C14.3 448 0 433.7 0 416C0 398.3 14.3 384 32 384H416C433.7 384 448 398.3 448 416z"></path>
          </svg>
        </label>
        <div class="logo-section">
          <img src="http://54.189.226.145/uploads/assets/images/taimex_logo.png" alt="TAIMEX INDUSTRIAL">
        </div>
      </div>
      <div class="title-section">
        <div class="title-row">
          <div class="welcome-user">
            <span>Welcome,</span>
            <strong id="currentUserDisplay">User</strong>
          </div>
          <div>
            <h2>TAIMEX - SHIPMENTS</h2>
            <p>TAIMEX - MANAGEMENT</p>
          </div>
        </div>
      </div>
    </div>

    <main class="main-content">
      <div class="content-wrapper">
        <div id="alertContainer"></div>

        <!-- INITIAL SELECTION SCREEN -->
        <div class="step-wizard" id="initialSelectionScreen">
          <h2 style="text-align: center; margin-bottom: 10px; color: #1e293b; font-size: 1.5em;">
            <i class="fas fa-shipping-fast"></i> Shipments Management
          </h2>
          <p style="text-align: center; color: #64748b; margin-bottom: 30px;">What would you like to do?</p>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; max-width: 800px; margin: 0 auto;">
            <button class="btn btn-primary" onclick="showSearchMode()" style="padding: 40px 30px; font-size: 1.1em; flex-direction: column; gap: 12px;">
              <i class="fas fa-search" style="font-size: 2.5em;"></i>
              <span>Search Existing Shipment</span>
              <small style="font-weight: normal; opacity: 0.9;">Find and view shipment records</small>
            </button>
            <button class="btn btn-success" onclick="showCreateMode()" style="padding: 40px 30px; font-size: 1.1em; flex-direction: column; gap: 12px;">
              <i class="fas fa-plus-circle" style="font-size: 2.5em;"></i>
              <span>Create New Shipment</span>
              <small style="font-weight: normal; opacity: 0.9;">Generate a new shipment record</small>
            </button>
          </div>
        </div>

        <!-- SEARCH MODE SCREEN -->
        <div class="step-wizard hidden" id="searchModeScreen">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;"><i class="fas fa-search"></i> Search Shipment</h2>
            <button class="btn btn-secondary" onclick="returnToHome()">
              <i class="fas fa-arrow-left"></i> Back
            </button>
          </div>
          <div class="search-box" style="max-width: 100%;">
            <input type="text" id="searchShipmentInput" placeholder="Enter Shipment Number..." style="flex: 1;">
            <button class="btn btn-primary" onclick="searchShipment()">
              <i class="fas fa-search"></i> Search
            </button>
          </div>
        </div>

        <!-- SHIPMENT FORM SCREEN -->
        <div class="step-wizard hidden" id="shipmentForm">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">
              <span id="formTitle">Shipment Details</span>
              <span id="statusBadge" class="status-badge status-new hidden">NEW</span>
            </h2>
            <button class="btn btn-secondary" onclick="returnToHome()">
              <i class="fas fa-arrow-left"></i> Back
            </button>
          </div>

          <!-- Steps Container with Scroll -->
          <div style="flex: 1; overflow-y: auto; overflow-x: hidden; padding-right: 8px;">

            <!-- STEP 1: Load Sales Order -->
            <div class="step-card active" id="step-1">
              <div class="step-card-header">
                <div class="step-icon">
                  <i class="fas fa-file-import"></i>
                </div>
                <div class="step-title">
                  <h3>Step 1: Load Sales Order</h3>
                  <p>Import line items from existing Sales Order</p>
                </div>
              </div>

              <div class="info-box">
                <div class="info-box-icon">
                  <i class="fas fa-lightbulb"></i>
                </div>
                <div class="info-box-content">
                  <strong>Quick Tip</strong>
                  <p>Enter the Sales Order number and press ENTER to automatically import all line items, customer info, and shipping details.</p>
                </div>
              </div>

              <div class="field-group">
                <div class="field-wrapper" style="grid-column: 1 / -1;">
                  <label>SO Number <span class="required-mark">*</span></label>
                  <input type="text" id="soNumber" placeholder="Enter SO number and press ENTER">
                  <div class="field-hint"><i class="fas fa-keyboard"></i> Press ENTER to load</div>
                </div>
              </div>

              <div class="step-navigation">
                <div></div>
                <button class="btn-step btn-step-primary" id="loadSoButton">
                  <i class="fas fa-download"></i> Continue
                </button>
              </div>
            </div>

            <!-- STEP 2: Shipment Details -->
            <div class="step-card" id="step-2">
              <div class="step-card-header">
                <div class="step-icon">
                  <i class="fas fa-shipping-fast"></i>
                </div>
                <div class="step-title">
                  <h3>Step 2: Shipment Details</h3>
                  <p>Configure shipment information</p>
                </div>
              </div>

              <div class="info-box">
                <div class="info-box-icon">
                  <i class="fas fa-info-circle"></i>
                </div>
                <div class="info-box-content">
                  <strong>Shipment Number</strong>
                  <p>The shipment number will be auto-generated when you save. Update ship date, waybill, and carrier as needed.</p>
                </div>
              </div>

              <div class="field-group">
                <div class="field-wrapper">
                  <label>Shipment Number</label>
                  <input type="text" id="shipmentNumber" readonly placeholder="Auto-generated" style="background-color: #f5f5f5; cursor: not-allowed;">
                  <div class="field-hint"><i class="fas fa-lock"></i> Auto-assigned on save</div>
                </div>

                <div class="field-wrapper">
                  <label>Ship Date <span class="required-mark">*</span></label>
                  <input type="date" id="shipDate">
                  <div class="field-hint"><i class="fas fa-calendar"></i> Shipment date</div>
                </div>
              </div>

              <div class="field-group">
                <div class="field-wrapper">
                  <label>Waybill / Tracking</label>
                  <input type="text" id="waybill" placeholder="Enter tracking number">
                </div>

                <div class="field-wrapper">
                  <label>Ship Via</label>
                  <select id="shipVia">
                    <option value="">Select Ship Via...</option>
                  </select>
                </div>
              </div>

              <div class="field-wrapper">
                <label>Notes</label>
                <textarea id="notes" placeholder="Enter shipment notes (one per line)" style="min-height: 80px; font-family: inherit;"></textarea>
                <div class="field-hint"><i class="fas fa-sticky-note"></i> One note per line</div>
              </div>

              <div class="step-navigation">
                <button class="btn-step btn-step-secondary" onclick="goToShipmentStep(1)">
                  <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button class="btn-step btn-step-primary" onclick="goToShipmentStep(3)">
                  Next: Line Items <i class="fas fa-arrow-right"></i>
                </button>
              </div>
            </div>

            <!-- STEP 3: Line Items -->
            <div class="step-card" id="step-3">
              <div class="step-card-header">
                <div class="step-icon">
                  <i class="fas fa-list"></i>
                </div>
                <div class="step-title">
                  <h3>Step 3: Review Line Items</h3>
                  <p>Verify and adjust quantities/boxes</p>
                </div>
              </div>

              <div class="info-box">
                <div class="info-box-icon">
                  <i class="fas fa-boxes"></i>
                </div>
                <div class="info-box-content">
                  <strong>Line Items Review</strong>
                  <p>Line items are imported from the SO. Adjust ship quantities, prices, or boxes as needed before saving.</p>
                </div>
              </div>

              <div style="margin-bottom: 12px;">
                <button class="btn-step btn-step-secondary" type="button" onclick="addLineItem()">
                  <i class="fas fa-plus"></i> Add Line Item
                </button>
              </div>

              <table class="line-items-table">
                <thead>
                  <tr>
                    <th style="width: 60px;">#</th>
                    <th>Line Item</th>
                    <th>Part Number</th>
                    <th style="width: 100px;">Ship Qty</th>
                    <th style="width: 100px;">Price</th>
                    <th style="width: 100px;">Boxes</th>
                    <th style="width: 80px;">Actions</th>
                  </tr>
                </thead>
                <tbody id="lineItemsBody">
                  <!-- Line items will be added here -->
                </tbody>
              </table>

              <div class="step-navigation">
                <button class="btn-step btn-step-secondary" onclick="goToShipmentStep(2)">
                  <i class="fas fa-arrow-left"></i> Previous
                </button>
                <button class="btn-step btn-step-primary" onclick="saveShipment()">
                  <i class="fas fa-save"></i> Save Shipment
                </button>
              </div>
            </div>

          </div> <!-- /steps container -->

        </div> <!-- /shipmentForm -->

      </div> <!-- /content-wrapper -->
    </main> <!-- /main-content -->
  </div> <!-- /container -->

  <script>
    let lineItemCounter = 0;
    let currentShipmentNumber = null;
    let isNewShipment = false;

    function parseXMLResponse(xmlText, contextLabel = '') {
      if (!xmlText || !xmlText.trim()) {
        throw new Error(`Empty XML response${contextLabel ? ` for ${contextLabel}` : ''}`);
      }

      let cleanedText = xmlText.trim();

      // If there is leading non-XML content (e.g. debug headers), strip everything before the first XML tag
      const firstTagIndex = cleanedText.indexOf('<?xml');
      if (firstTagIndex > 0) {
        cleanedText = cleanedText.slice(firstTagIndex);
      }

      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(cleanedText, 'text/xml');

      const parseErrors = xmlDoc.getElementsByTagName('parsererror');
      if (parseErrors.length > 0) {
        console.error(`âŒ XML parse error${contextLabel ? ` (${contextLabel})` : ''}:`, cleanedText);
        throw new Error(`Invalid XML response${contextLabel ? ` for ${contextLabel}` : ''}`);
      }

      return xmlDoc;
    }

    function getXMLValue(parent, tagName) {
      if (!parent) return '';
      const element = parent.getElementsByTagName(tagName)[0];
      return element ? element.textContent.trim() : '';
    }

    function normalizeDateForInput(rawValue) {
      if (!rawValue) return '';

      const trimmed = rawValue.trim();

      if (/^\d{4}-\d{2}-\d{2}$/.test(trimmed)) {
        return trimmed;
      }

      if (/^\d{8}$/.test(trimmed)) {
        const year = trimmed.slice(0, 4);
        const month = trimmed.slice(4, 6);
        const day = trimmed.slice(6, 8);
        return `${year}-${month}-${day}`;
      }

      const mdYMatch = /^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/.exec(trimmed);
      if (mdYMatch) {
        let [, month, day, year] = mdYMatch;
        if (year.length === 2) {
          const yearInt = parseInt(year, 10);
          year = (yearInt >= 70 ? '19' : '20') + year;
        }
        month = month.padStart(2, '0');
        day = day.padStart(2, '0');
        return `${year}-${month}-${day}`;
      }

      console.warn('âš ï¸ Unable to normalize date value:', rawValue);
      return '';
    }

    function parseNumericValue(raw) {
      if (typeof raw !== 'string') return NaN;
      const cleaned = raw.replace(/[^0-9.\-]/g, '');
      if (cleaned === '') return NaN;
      return Number(cleaned);
    }

    function calculateScheduleTotal(lineElement) {
      if (!lineElement) return null;
      
      const qtyNodes = Array.from(lineElement.querySelectorAll('schedule_qty'));
      let total = 0;
      let hasQty = false;
      
      if (qtyNodes.length > 0) {
        qtyNodes.forEach(node => {
          const numeric = parseNumericValue(node.textContent || '');
          if (!Number.isNaN(numeric)) {
            total += numeric;
            hasQty = true;
          }
        });
      } else {
        const scheduleContainer = lineElement.getElementsByTagName('schedule_entries')[0];
        if (scheduleContainer) {
          const rawScheduleText = scheduleContainer.textContent || '';
          const matches = rawScheduleText.match(/\*([-\d.]+)/g);
          if (matches) {
            matches.forEach(match => {
              const numeric = Number(match.replace('*', ''));
              if (!Number.isNaN(numeric)) {
                total += numeric;
                hasQty = true;
              }
            });
          }
        }
      }
      
      if (!hasQty) return null;
      return total;
    }

    // Simplified step management
    function activateStepsAfterSoLoad() {
      // Automatically go to step 2 after loading SO
      goToShipmentStep(2);
      showAlert('âœ… SO loaded! Review shipment details and line items.', 'success');
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      console.log('SHIPMENTS_EDIT initialized');
      setTodayDate();
      loadShipVias();
      
      const soNumberInput = document.getElementById('soNumber');
      if (soNumberInput) {
        soNumberInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            handleLoadSO();
          }
        });
      }
      
      const loadSoButton = document.getElementById('loadSoButton');
      if (loadSoButton) {
        loadSoButton.addEventListener('click', handleLoadSO);
      }

      // Add enter key support for search
      const searchInput = document.getElementById('searchShipmentInput');
      searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
          searchShipment();
        }
      });
    });

    // ========== SCREEN NAVIGATION ==========
    function showSearchMode() {
      document.getElementById('initialSelectionScreen').classList.add('hidden');
      document.getElementById('searchModeScreen').classList.remove('hidden');
      document.getElementById('shipmentForm').classList.add('hidden');
      document.getElementById('searchShipmentInput').focus();
    }

    function showCreateMode() {
      document.getElementById('initialSelectionScreen').classList.add('hidden');
      document.getElementById('searchModeScreen').classList.add('hidden');
      document.getElementById('shipmentForm').classList.remove('hidden');
      createNewShipment();
    }

    function returnToHome() {
      document.getElementById('initialSelectionScreen').classList.remove('hidden');
      document.getElementById('searchModeScreen').classList.add('hidden');
      document.getElementById('shipmentForm').classList.add('hidden');
      clearForm();
      clearAlerts();
    }

    function showShipmentForm() {
      document.getElementById('initialSelectionScreen').classList.add('hidden');
      document.getElementById('searchModeScreen').classList.add('hidden');
      document.getElementById('shipmentForm').classList.remove('hidden');
    }

    // ========== STEP NAVIGATION ==========
    function goToShipmentStep(stepNumber) {
      // Hide all steps
      document.querySelectorAll('.step-card').forEach(card => {
        card.classList.remove('active');
      });
      
      // Show requested step
      const stepCard = document.getElementById(`step-${stepNumber}`);
      if (stepCard) {
        stepCard.classList.add('active');
        stepCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }
    }

    function loadShipVias() {
      console.log('Loading ship vias...');
      
      fetch(`GET_SHIPVIAS.XML?_=${Date.now()}`)
        .then(response => response.text())
        .then(xmlText => {
          let xmlDoc;
          try {
            xmlDoc = parseXMLResponse(xmlText, 'GET_SHIPVIAS.XML');
          } catch (error) {
            console.error('Error loading ship vias:', error);
            showAlert('Error loading Ship Via list', 'error');
            return;
          }

          const shipvias = Array.from(xmlDoc.getElementsByTagName('shipvia'));
          
          const selectElement = document.getElementById('shipVia');
          selectElement.innerHTML = '<option value="">Select Ship Via...</option>';
          
          shipvias.forEach(shipvia => {
            const code = getXMLValue(shipvia, 'shipvia_code');
            const name = getXMLValue(shipvia, 'shipvia_name');
            const option = document.createElement('option');
            option.value = code;
            option.textContent = `${code} - ${name}`;
            selectElement.appendChild(option);
          });
          
          console.log(`âœ… Loaded ${shipvias.length} ship vias`);
        })
        .catch(error => {
          console.error('Error loading ship vias:', error);
        });
    }

    function handleLoadSO() {
      const soInput = document.getElementById('soNumber');
      if (!soInput) return;
      const soNumber = soInput.value.trim();
      if (!soNumber) {
        showAlert('Please enter a Sales Order number', 'error');
        document.getElementById('soNumber').focus();
        return;
      }
      loadSOLineItems(soNumber);
    }

    function loadSOLineItems(soNumber) {
      console.log('ðŸ” Loading line items for SO:', soNumber);
      showAlert(`Loading line items for SO ${soNumber}...`, 'info');
      
      fetch(`GET_SO.XML?so_number=${encodeURIComponent(soNumber)}&_=${Date.now()}`)
        .then(response => response.text())
        .then(xmlText => {
          let xmlDoc;
          try {
            xmlDoc = parseXMLResponse(xmlText, `SO ${soNumber}`);
          } catch (error) {
            console.error('Error parsing SO XML:', error);
            showAlert(`SO ${soNumber}: invalid response`, 'error');
            return;
          }
          
          // Check for errors
          const errorNode = xmlDoc.getElementsByTagName('error')[0];
          if (errorNode) {
            showAlert(`SO ${soNumber}: ${errorNode.textContent}`, 'error');
            return;
          }
          
          // Load Ship Via from SO
          const shipVia = getXMLValue(xmlDoc, 'ship_via');
          if (shipVia) {
            document.getElementById('shipVia').value = shipVia;
            console.log('âœ… Ship Via loaded:', shipVia);
          }
          
          // Clear existing line items
          const tbody = document.getElementById('lineItemsBody');
          tbody.innerHTML = '';
          lineItemCounter = 0;
          
          // Get line items
          const lineItems = Array.from(xmlDoc.getElementsByTagName('line_item'));
          
          if (lineItems.length === 0) {
            showAlert(`No line items found for SO ${soNumber}`, 'error');
            return;
          }
          
          lineItems.forEach(line => {
            const scheduleTotal = calculateScheduleTotal(line);
            const lineCode = getXMLValue(line, 'line_item_code');
            const partNumber = getXMLValue(line, 'part_number');
            let quantity = getXMLValue(line, 'quantity');
            const price = getXMLValue(line, 'unit_price');
            
            if (scheduleTotal !== null) {
              quantity = Number.isInteger(scheduleTotal) ? String(scheduleTotal) : scheduleTotal.toFixed(2);
            }
            
            // Add line item with SO data (boxes will be empty for user to fill)
            addLineItemRow(lineCode, partNumber, quantity, price, '');
          });
          
          activateStepsAfterSoLoad();
          console.log(`âœ… Loaded ${lineItems.length} line items`);
        })
        .catch(error => {
          console.error('Error loading SO line items:', error);
          showAlert('Error loading line items from SO', 'error');
        });
    }

    function setTodayDate() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('shipDate').value = today;
    }

    function showAlert(message, type = 'info') {
      const container = document.getElementById('alertContainer');
      const alertClass = `alert-${type}`;
      const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
      
      container.innerHTML = `
        <div class="alert ${alertClass}">
          <i class="fas fa-${icon}"></i>
          <span>${message}</span>
        </div>
      `;
      
      setTimeout(() => { container.innerHTML = ''; }, 5000);
    }

    function clearAlerts() {
      document.getElementById('alertContainer').innerHTML = '';
    }

    function createNewShipment() {
      console.log('Preparing new shipment draft...');
      
      clearForm();
      
      isNewShipment = true;
      currentShipmentNumber = null;
      
      const shipmentNumberInput = document.getElementById('shipmentNumber');
      if (shipmentNumberInput) {
        shipmentNumberInput.value = '';
      }
      
      const statusBadge = document.getElementById('statusBadge');
      if (statusBadge) {
        statusBadge.textContent = 'UNSAVED';
        statusBadge.className = 'status-badge status-new';
        statusBadge.classList.remove('hidden');
      }
      
      showShipmentForm();
      goToShipmentStep(1);
      showAlert('Enter the Sales Order number to begin.', 'info');
      
      setTimeout(() => {
        document.getElementById('soNumber').focus();
      }, 300);
    }

    function searchShipment() {
      const shipmentNumber = document.getElementById('searchShipmentInput').value.trim();
      
      if (!shipmentNumber) {
        showAlert('Please enter a shipment number', 'error');
        return;
      }
      
      console.log('Searching for shipment:', shipmentNumber);
      
      fetch(`GET_SHIPMENT.XML?shipment_number=${encodeURIComponent(shipmentNumber)}&_=${Date.now()}`)
        .then(response => response.text())
        .then(xmlText => {
          let xmlDoc;
          try {
            xmlDoc = parseXMLResponse(xmlText, `Shipment ${shipmentNumber}`);
          } catch (error) {
            console.error('Error parsing shipment XML:', error);
            showAlert('Invalid shipment response received', 'error');
            return;
          }
          
          const errorNode = xmlDoc.getElementsByTagName('error')[0];
          if (errorNode) {
            showAlert(errorNode.textContent, 'error');
            return;
          }
          
          loadShipmentData(xmlDoc);
          currentShipmentNumber = shipmentNumber;
          isNewShipment = false;
          
          document.getElementById('statusBadge').textContent = 'SAVED';
          document.getElementById('statusBadge').className = 'status-badge status-saved';
          document.getElementById('statusBadge').classList.remove('hidden');
          
          showShipmentForm();
          showAlert(`Shipment ${shipmentNumber} loaded successfully`, 'success');
        })
        .catch(error => {
          console.error('Error:', error);
          showAlert('Error loading shipment', 'error');
        });
    }

    function loadShipmentData(xmlDoc) {
      // Go to step 2 when loading existing shipment
      goToShipmentStep(2);
      
      // Load basic fields
      document.getElementById('shipmentNumber').value = getXMLValue(xmlDoc, 'shipment_number');
      document.getElementById('shipDate').value = normalizeDateForInput(getXMLValue(xmlDoc, 'ship_date'));
      document.getElementById('soNumber').value = getXMLValue(xmlDoc, 'so_number');
      document.getElementById('waybill').value = getXMLValue(xmlDoc, 'waybill');
      document.getElementById('shipVia').value = getXMLValue(xmlDoc, 'ship_via');
      
      // Load notes
      const notesParent = xmlDoc.getElementsByTagName('notes')[0];
      let notes = '';
      if (notesParent) {
        const noteNodes = notesParent.getElementsByTagName('note');
        notes = Array.from(noteNodes).map(node => node.textContent || '').join('\n');
      }
      document.getElementById('notes').value = notes;
      
      // Load line items
      const lineItemsBody = document.getElementById('lineItemsBody');
      lineItemsBody.innerHTML = '';
      lineItemCounter = 0;
      
      const lines = Array.from(xmlDoc.getElementsByTagName('line'));
      lines.forEach(line => {
        const lineItem = getXMLValue(line, 'line_item');
        const partNumber = getXMLValue(line, 'part_number');
        const shipQty = getXMLValue(line, 'ship_qty');
        const price = getXMLValue(line, 'price');
        const boxes = getXMLValue(line, 'boxes');
        
        addLineItemRow(lineItem, partNumber, shipQty, price, boxes);
      });
    }

    function addLineItem() {
      addLineItemRow('', '', '', '', '');
    }

    function addLineItemRow(lineItem = '', partNumber = '', shipQty = '', price = '', boxes = '') {
      lineItemCounter++;
      const tbody = document.getElementById('lineItemsBody');
      const row = tbody.insertRow();
      row.id = `lineItem${lineItemCounter}`;
      
      row.innerHTML = `
        <td>${lineItemCounter}</td>
        <td><input type="text" value="${lineItem}" id="lineItem_${lineItemCounter}"></td>
        <td><input type="text" value="${partNumber}" id="partNumber_${lineItemCounter}"></td>
        <td><input type="number" value="${shipQty}" id="shipQty_${lineItemCounter}"></td>
        <td><input type="number" step="0.01" value="${price}" id="price_${lineItemCounter}"></td>
        <td><input type="number" value="${boxes}" id="boxes_${lineItemCounter}"></td>
        <td style="text-align: center;">
          <button class="btn-danger" style="padding: 6px 10px; font-size: 0.85em;" onclick="removeLineItem(${lineItemCounter})">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      `;
    }

    function removeLineItem(id) {
      const row = document.getElementById(`lineItem${id}`);
      if (row) row.remove();
    }

    async function saveShipment() {
      const shipmentNumberInput = document.getElementById('shipmentNumber');
      // Validate required fields
      let shipmentNumber = shipmentNumberInput.value.trim();
      const shipDate = document.getElementById('shipDate').value;
      const soNumber = document.getElementById('soNumber').value.trim();

      if (!shipDate) {
        showAlert('Ship Date is required', 'error');
        return;
      }
      
      if (!soNumber) {
        showAlert('SO Number is required', 'error');
        return;
      }
      
      // Collect line items
      const lineItems = [];
      const partNumbers = [];
      const shipQtys = [];
      const prices = [];
      const boxes = [];
      
      const rows = document.querySelectorAll('#lineItemsBody tr');
      rows.forEach((row, index) => {
        const id = row.id.replace('lineItem', '');
        const lineItem = document.getElementById(`lineItem_${id}`)?.value || '';
        const partNumber = document.getElementById(`partNumber_${id}`)?.value || '';
        const shipQty = document.getElementById(`shipQty_${id}`)?.value || '';
        const price = document.getElementById(`price_${id}`)?.value || '';
        const boxCount = document.getElementById(`boxes_${id}`)?.value || '';
        
        if (lineItem || partNumber) {
          lineItems.push(lineItem);
          partNumbers.push(partNumber);
          shipQtys.push(shipQty);
          prices.push(price);
          boxes.push(boxCount);
        }
      });
      
      // Collect notes
      const notesText = document.getElementById('notes').value.trim();
      const notesArray = notesText.split('\n').filter(n => n.trim());

      if (isNewShipment) {
        if (!shipmentNumber) {
          try {
            const response = await fetch(`GET_LIID_SHIPMENTS.XML?_=${Date.now()}`);
            const xmlText = await response.text();
            const xmlDoc = parseXMLResponse(xmlText, 'GET_LIID_SHIPMENTS.XML');
            const generatedNumber = getXMLValue(xmlDoc, 'shipment_number');
            
            if (!generatedNumber) {
              showAlert('Unable to generate a shipment number. Please try again.', 'error');
              return;
            }
            
            shipmentNumber = generatedNumber;
            shipmentNumberInput.value = generatedNumber;
            currentShipmentNumber = generatedNumber;
            console.log('Generated shipment number for save:', generatedNumber);
          } catch (error) {
            console.error('Error generating shipment number:', error);
            showAlert('Error generating shipment number. Please try again.', 'error');
            return;
          }
        }
      } else if (!shipmentNumber) {
        showAlert('Shipment number is missing. Please reload the shipment and try again.', 'error');
        return;
      }
      
      // Build form data
      const formData = new URLSearchParams();
      formData.append('shipment_number', shipmentNumber);
      formData.append('ship_date', shipDate);
      formData.append('so_number', soNumber);
      formData.append('waybill', document.getElementById('waybill').value);
      formData.append('ship_via', document.getElementById('shipVia').value);
      formData.append('notes', notesArray.join('|'));
      formData.append('line_items', lineItems.join('|'));
      formData.append('part_numbers', partNumbers.join('|'));
      formData.append('ship_qtys', shipQtys.join('|'));
      formData.append('prices', prices.join('|'));
      formData.append('boxes', boxes.join('|'));
      formData.append('save_mode', isNewShipment ? 'CREATE' : 'UPDATE');
      
      console.log('Saving shipment:', Object.fromEntries(formData));
      
      try {
        const response = await fetch('UPDATE_SHIPMENT.XML', {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: formData.toString()
        });
        
        const xmlText = await response.text();
        console.log('Response:', xmlText);
        
        let xmlDoc;
        try {
          xmlDoc = parseXMLResponse(xmlText, 'UPDATE_SHIPMENT.XML');
        } catch (error) {
          console.error('Error parsing save response:', error);
          showAlert('Error saving shipment (invalid response)', 'error');
          return;
        }
        
        const status = getXMLValue(xmlDoc, 'status');
        const message = getXMLValue(xmlDoc, 'message');
        
        if (status === 'SUCCESS') {
          showAlert(message || 'Shipment saved successfully!', 'success');
          isNewShipment = false;
          currentShipmentNumber = shipmentNumber;
          const statusBadge = document.getElementById('statusBadge');
          if (statusBadge) {
            statusBadge.textContent = 'SAVED';
            statusBadge.className = 'status-badge status-saved';
            statusBadge.classList.remove('hidden');
          }
          // Success - shipment saved
        } else {
          const errorMsg = getXMLValue(xmlDoc, 'error') || 'Unknown error';
          showAlert(errorMsg, 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        showAlert('Error saving shipment', 'error');
      }
    }

    function clearForm() {
      document.getElementById('shipmentNumber').value = '';
      document.getElementById('shipDate').value = '';
      document.getElementById('soNumber').value = '';
      document.getElementById('waybill').value = '';
      document.getElementById('shipVia').value = '';
      document.getElementById('notes').value = '';
      document.getElementById('lineItemsBody').innerHTML = '';
      document.getElementById('searchShipmentInput').value = '';
      document.getElementById('statusBadge').classList.add('hidden');
      
      lineItemCounter = 0;
      currentShipmentNumber = null;
      isNewShipment = true;
      
      goToShipmentStep(1);
      setTodayDate();
    }
  </script>
</body>
</html>
