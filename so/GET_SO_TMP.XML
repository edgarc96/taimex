<pre>
PicLan-IP/BASIC ^ ^
*
* GET_SO_TMP.XML - Retrieve Sales Orders from TMP database
*
OPEN 'XMLDATA' TO XMLDATAF ELSE STOP 201,'XMLDATA'
OPEN 'TMP' TO TMPF ELSE STOP 201,'TMP'

XVM = CHAR(253)
XSM = CHAR(252)
XAM = CHAR(254)

PL_GETVAR USER_FILTER FROM 'user_initials' ELSE USER_FILTER = ''
PL_GETVAR LOAD_FULL FROM 'load_full' ELSE LOAD_FULL = ''
PL_ADD_HDR '"Content-Type: application/xml"'

* DEBUG
DEBUG_INFO = '<!-- DEBUG: USER_FILTER=[' : USER_FILTER : '] LOAD_FULL=[' : LOAD_FULL : '] -->'

* If load_full flag is set, build temp_id from user_initials and load full record
IF LOAD_FULL <> '' AND USER_FILTER <> '' THEN
  TEMP_ID_FILTER = 'SO*' : USER_FILTER
  GOSUB GET_TEMP_DETAIL
  GOTO FINISH_OUTPUT
END

* Start XML response for list view
XML_RESPONSE = '<?xml version="1.0" encoding="UTF-8"?><tmp_list>' : DEBUG_INFO

SELECT TMPF
LOOP
   READNEXT TEMP_ID ELSE EXIT
   IF TEMP_ID # "" THEN
      TEMP_ID_PREFIX = OCONV(TEMP_ID[1,2], "MCU")
      IF TEMP_ID_PREFIX = "SO" THEN
         INCLUDE_RECORD = 1
         IF USER_FILTER <> "" THEN
            TEMP_ID_UPPER = OCONV(TEMP_ID, "MCU")
            USER_FILTER_UPPER = OCONV(USER_FILTER, "MCU")
            IF INDEX(TEMP_ID_UPPER, USER_FILTER_UPPER, 1) = 0 THEN
               INCLUDE_RECORD = 0
            END
         END

         IF INCLUDE_RECORD THEN
            READ TMP_REC FROM TMPF, TEMP_ID ELSE CONTINUE

            SO_NUMBER = TMP_REC<1>
            CUSTOMER_CODE = TMP_REC<2>
            SHIPTO_CODE = TMP_REC<3>
            BILLTO_CODE = TMP_REC<4>
            TIMESTAMP = TMP_REC<5>
            SHIP_VIA = TMP_REC<6>
            TERMS = TMP_REC<7>
            EMAIL = TMP_REC<8>
            HEADER_NOTES = TMP_REC<9>
            SO_STATUS = TMP_REC<10>
            CARRIER_ACCOUNT = TMP_REC<11>
            
            * Convert SO_DATE from Julian to YYYY-MM-DD format
            SO_DATE_RAW = TMP_REC<12>
            SO_DATE = ""
            SO_DATE_DEBUG = "<!-- DATE_CONV: RAW_JULIAN=[" : SO_DATE_RAW : "] "
            IF SO_DATE_RAW # "" AND NUM(SO_DATE_RAW) THEN
               * Convert Julian to MM/DD/YY format
               SO_DATE_TEMP = OCONV(SO_DATE_RAW, "D2/")
               SO_DATE_DEBUG := "TEMP=[" : SO_DATE_TEMP : "] "
               IF SO_DATE_TEMP # "" THEN
                  * Parse MM/DD/YY and convert to YYYY-MM-DD
                  MONTH = SO_DATE_TEMP[1,2]
                  DAY = SO_DATE_TEMP[4,2]
                  YEAR_2DIGIT = SO_DATE_TEMP[7,2]
                  * Convert 2-digit year to 4-digit (25 -> 2025, 99 -> 1999)
                  IF NUM(YEAR_2DIGIT) THEN
                     IF YEAR_2DIGIT < 50 THEN
                        YEAR = "20" : YEAR_2DIGIT
                     END ELSE
                        YEAR = "19" : YEAR_2DIGIT
                     END
                  END ELSE
                     YEAR = YEAR_2DIGIT
                  END
                  SO_DATE = YEAR : "-" : MONTH : "-" : DAY
                  SO_DATE_DEBUG := "FINAL=[" : SO_DATE : "] -->"
               END
            END ELSE
               SO_DATE_DEBUG := "EMPTY_OR_NOT_NUM -->"
            END
            
            PART_NUMBERS = TMP_REC<32>
            DESCRIPTIONS = TMP_REC<33>
            LINE_QUANTITIES = TMP_REC<34>
            LINE_PRICES = TMP_REC<35>

            SAVE_DATE = ""
            SAVE_TIME = ""
            IF TIMESTAMP # "" THEN
               SAVE_DATE = FIELD(TIMESTAMP, XSM, 1)
               SAVE_TIME = FIELD(TIMESTAMP, XSM, 2)
            END

            SAVE_DATE_DISPLAY = ""
            IF SAVE_DATE # "" AND NUM(SAVE_DATE) THEN
               SAVE_DATE_DISPLAY = OCONV(SAVE_DATE, "D2/MDY[2,2,4]")
            END

            SAVE_TIME_DISPLAY = ""
            IF SAVE_TIME # "" AND NUM(SAVE_TIME) THEN
               SAVE_TIME_DISPLAY = OCONV(SAVE_TIME, "MT")
            END

            NUM_ITEMS = 0
            IF PART_NUMBERS <> "" THEN
               NUM_ITEMS = DCOUNT(PART_NUMBERS, XVM)
            END

            XML_RESPONSE = XML_RESPONSE : SO_DATE_DEBUG
            XML_RESPONSE = XML_RESPONSE : "<temp_so>"
            XML_RESPONSE = XML_RESPONSE : "<temp_id>" : TEMP_ID : "</temp_id>"
            XML_RESPONSE = XML_RESPONSE : "<so_number>" : SO_NUMBER : "</so_number>"
            XML_RESPONSE = XML_RESPONSE : "<customer_code>" : CUSTOMER_CODE : "</customer_code>"
            XML_RESPONSE = XML_RESPONSE : "<shipto_code>" : SHIPTO_CODE : "</shipto_code>"
            XML_RESPONSE = XML_RESPONSE : "<billto_code>" : BILLTO_CODE : "</billto_code>"
            XML_RESPONSE = XML_RESPONSE : "<ship_via>" : SHIP_VIA : "</ship_via>"
            XML_RESPONSE = XML_RESPONSE : "<terms>" : TERMS : "</terms>"
            XML_RESPONSE = XML_RESPONSE : "<email>" : EMAIL : "</email>"
            XML_RESPONSE = XML_RESPONSE : "<header_notes>" : HEADER_NOTES : "</header_notes>"
            XML_RESPONSE = XML_RESPONSE : "<so_status>" : SO_STATUS : "</so_status>"
            XML_RESPONSE = XML_RESPONSE : "<carrier_account>" : CARRIER_ACCOUNT : "</carrier_account>"
            XML_RESPONSE = XML_RESPONSE : "<so_date>" : SO_DATE : "</so_date>"
            XML_RESPONSE = XML_RESPONSE : "<part_numbers>" : PART_NUMBERS : "</part_numbers>"
            XML_RESPONSE = XML_RESPONSE : "<descriptions>" : DESCRIPTIONS : "</descriptions>"
            XML_RESPONSE = XML_RESPONSE : "<line_quantities>" : LINE_QUANTITIES : "</line_quantities>"
            XML_RESPONSE = XML_RESPONSE : "<line_prices>" : LINE_PRICES : "</line_prices>"
            XML_RESPONSE = XML_RESPONSE : "<save_date>" : SAVE_DATE_DISPLAY : "</save_date>"
            XML_RESPONSE = XML_RESPONSE : "<save_time>" : SAVE_TIME_DISPLAY : "</save_time>"
            XML_RESPONSE = XML_RESPONSE : "<num_items>" : NUM_ITEMS : "</num_items>"
            XML_RESPONSE = XML_RESPONSE : "</temp_so>"
         END
      END
   END
REPEAT

XML_RESPONSE = XML_RESPONSE : "</tmp_list>"

FINISH_OUTPUT:
WRITE XML_RESPONSE ON XMLDATAF, "RESPONSE.XML"
ERR = ""
CALL PLW.PAGE("/XMLDATA/RESPONSE.XML","",ERR)
RETURN

*------------------------------------------------
* Subroutine: GET_TEMP_DETAIL
*------------------------------------------------
GET_TEMP_DETAIL:
* Inicializar antes de leer
SO_NUMBER       = ""
CUSTOMER_CODE   = ""
SHIPTO_CODE     = ""
BILLTO_CODE     = ""
TIMESTAMP       = ""
SHIP_VIA        = ""
TERMS           = ""
EMAIL           = ""
HEADER_NOTES    = ""
SO_STATUS       = ""
CARRIER_ACCOUNT = ""
SO_DATE         = ""
PART_NUMBERS    = ""
DESCRIPTIONS    = ""
LINE_QUANTITIES = ""
LINE_PRICES     = ""

READ TMP_REC FROM TMPF, TEMP_ID_FILTER ELSE
   XML_RESPONSE = '<?xml version="1.0" encoding="UTF-8"?><tmp_record><error>Record not found</error></tmp_record>'
   RETURN
END

SO_NUMBER       = TMP_REC<1>
CUSTOMER_CODE   = TMP_REC<2>
SHIPTO_CODE     = TMP_REC<3>
BILLTO_CODE     = TMP_REC<4>
TIMESTAMP       = TMP_REC<5>
SHIP_VIA        = TMP_REC<6>
TERMS           = TMP_REC<7>
EMAIL           = TMP_REC<8>
HEADER_NOTES    = TMP_REC<9>
SO_STATUS       = TMP_REC<10>
CARRIER_ACCOUNT = TMP_REC<11>

* Convert SO_DATE from Julian to YYYY-MM-DD format
SO_DATE_RAW = TMP_REC<12>
SO_DATE = ""
SO_DATE_DEBUG_DETAIL = "<!-- DETAIL_DATE_CONV: RAW_JULIAN=[" : SO_DATE_RAW : "] "
IF SO_DATE_RAW # "" AND NUM(SO_DATE_RAW) THEN
   * Convert Julian to MM/DD/YY format
   SO_DATE_TEMP = OCONV(SO_DATE_RAW, "D2/")
   SO_DATE_DEBUG_DETAIL := "TEMP=[" : SO_DATE_TEMP : "] "
   IF SO_DATE_TEMP # "" THEN
      * Parse MM/DD/YY and convert to YYYY-MM-DD
      MONTH = SO_DATE_TEMP[1,2]
      DAY = SO_DATE_TEMP[4,2]
      YEAR_2DIGIT = SO_DATE_TEMP[7,2]
      * Convert 2-digit year to 4-digit (25 -> 2025, 99 -> 1999)
      IF NUM(YEAR_2DIGIT) THEN
         IF YEAR_2DIGIT < 50 THEN
            YEAR = "20" : YEAR_2DIGIT
         END ELSE
            YEAR = "19" : YEAR_2DIGIT
         END
      END ELSE
         YEAR = YEAR_2DIGIT
      END
      SO_DATE = YEAR : "-" : MONTH : "-" : DAY
      SO_DATE_DEBUG_DETAIL := "FINAL=[" : SO_DATE : "] -->"
   END
END ELSE
   SO_DATE_DEBUG_DETAIL := "EMPTY_OR_NOT_NUM -->"
END

PART_NUMBERS    = TMP_REC<32>
DESCRIPTIONS    = TMP_REC<33>
LINE_QUANTITIES = TMP_REC<34>
LINE_PRICES     = TMP_REC<35>

XML_RESPONSE = '<?xml version="1.0" encoding="UTF-8"?><tmp_record>'
XML_RESPONSE = XML_RESPONSE : SO_DATE_DEBUG_DETAIL
XML_RESPONSE = XML_RESPONSE : "<temp_id>" : TEMP_ID_FILTER : "</temp_id>"
XML_RESPONSE = XML_RESPONSE : "<so_number>" : SO_NUMBER : "</so_number>"
XML_RESPONSE = XML_RESPONSE : "<customer_code>" : CUSTOMER_CODE : "</customer_code>"
XML_RESPONSE = XML_RESPONSE : "<shipto_code>" : SHIPTO_CODE : "</shipto_code>"
XML_RESPONSE = XML_RESPONSE : "<billto_code>" : BILLTO_CODE : "</billto_code>"
XML_RESPONSE = XML_RESPONSE : "<ship_via>" : SHIP_VIA : "</ship_via>"
XML_RESPONSE = XML_RESPONSE : "<terms>" : TERMS : "</terms>"
XML_RESPONSE = XML_RESPONSE : "<email>" : EMAIL : "</email>"
XML_RESPONSE = XML_RESPONSE : "<header_notes>" : HEADER_NOTES : "</header_notes>"
XML_RESPONSE = XML_RESPONSE : "<so_status>" : SO_STATUS : "</so_status>"
XML_RESPONSE = XML_RESPONSE : "<carrier_account>" : CARRIER_ACCOUNT : "</carrier_account>"
XML_RESPONSE = XML_RESPONSE : "<so_date>" : SO_DATE : "</so_date>"
XML_RESPONSE = XML_RESPONSE : "<part_numbers>" : PART_NUMBERS : "</part_numbers>"
XML_RESPONSE = XML_RESPONSE : "<descriptions>" : DESCRIPTIONS : "</descriptions>"
XML_RESPONSE = XML_RESPONSE : "<line_quantities>" : LINE_QUANTITIES : "</line_quantities>"
XML_RESPONSE = XML_RESPONSE : "<line_prices>" : LINE_PRICES : "</line_prices>"
XML_RESPONSE = XML_RESPONSE : "</tmp_record>"
RETURN
END
</pre>
