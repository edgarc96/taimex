<PRE>

PicLan-IP/BASIC ^ ^
*
* GET_SO_TMP_DETAIL.XML - Load complete draft from TMP database
* Returns draft in same format as GET_SO.XML for compatibility
*
OPEN 'XMLDATA' TO XMLDATAF ELSE STOP 201,'XMLDATA'
OPEN 'TMP' TO TMPF ELSE STOP 201,'TMP'
OPEN 'CUSTOMER' TO CUSTOMERF ELSE STOP 201,'CUSTOMER'

XVM = CHAR(253)
XSM = CHAR(252)
XAM = CHAR(254)

PL_GETVAR TEMP_ID FROM 'temp_id' ELSE TEMP_ID = ''
PL_ADD_HDR '"Content-Type: application/xml"'

* Validate temp_id
IF TEMP_ID = '' THEN
  XML_RESPONSE = '<?xml version="1.0" encoding="UTF-8"?><error>Missing temp_id parameter</error>'
  GOTO FINISH_OUTPUT
END

* Read TMP record
READ TMP_REC FROM TMPF, TEMP_ID ELSE
  XML_RESPONSE = '<?xml version="1.0" encoding="UTF-8"?><error>Draft not found: ' : TEMP_ID : '</error>'
  GOTO FINISH_OUTPUT
END

* Extract fields from TMP record (MUST match GET_SO_TMP.XML structure)
SO_NUMBER = TMP_REC<1>
CUSTOMER_CODE = TMP_REC<2>
SHIPTO_CODE = TMP_REC<3>
BILLTO_CODE = TMP_REC<4>
TIMESTAMP = TMP_REC<5>
SHIP_VIA = TMP_REC<6>
TERMS = TMP_REC<7>
EMAIL = TMP_REC<8>
HEADER_NOTES = TMP_REC<9>
SO_STATUS = TMP_REC<10>
CARRIER_ACCOUNT = TMP_REC<11>

* Convert SO_DATE from Julian to YYYY-MM-DD format
SO_DATE_RAW = TMP_REC<12>
SO_DATE = ""
IF SO_DATE_RAW # "" AND NUM(SO_DATE_RAW) THEN
   * Convert Julian to MM/DD/YY format
   SO_DATE_TEMP = OCONV(SO_DATE_RAW, "D2/")
   IF SO_DATE_TEMP # "" THEN
      * Parse MM/DD/YY and convert to YYYY-MM-DD
      MONTH = SO_DATE_TEMP[1,2]
      DAY = SO_DATE_TEMP[4,2]
      YEAR_2DIGIT = SO_DATE_TEMP[7,2]
      * Convert 2-digit year to 4-digit (25 -> 2025, 99 -> 1999)
      IF NUM(YEAR_2DIGIT) THEN
         IF YEAR_2DIGIT < 50 THEN
            YEAR = "20" : YEAR_2DIGIT
         END ELSE
            YEAR = "19" : YEAR_2DIGIT
         END
      END ELSE
         YEAR = YEAR_2DIGIT
      END
      SO_DATE = YEAR : "-" : MONTH : "-" : DAY
   END
END

PART_NUMBERS = TMP_REC<32>
DESCRIPTIONS = TMP_REC<33>
SCHEDULE_DATA = TMP_REC<34>
LINE_QUANTITIES = TMP_REC<35>
LINE_PRICES = TMP_REC<36>
LINE_UOMS = TMP_REC<37>
NEED_DATA = TMP_REC<38>
LINE_NOTES = TMP_REC<40>
PROD_NOTES = TMP_REC<41>
LINE_TOTALS = TMP_REC<49>

* Get customer information
CUSTOMER_NAME = ''
CUSTOMER_ADDRESS1 = ''
CUSTOMER_ADDRESS2 = ''
CUSTOMER_CITY = ''
CUSTOMER_STATE = ''
CUSTOMER_ZIP = ''
SHIPTO_NAME = ''
SHIPTO_ADDRESS1 = ''
SHIPTO_ADDRESS2 = ''
SHIPTO_CITY = ''
SHIPTO_STATE = ''
SHIPTO_ZIP = ''

IF CUSTOMER_CODE <> '' THEN
  READ CUSTOMER_REC FROM CUSTOMERF, CUSTOMER_CODE ELSE CUSTOMER_REC = ''
  IF CUSTOMER_REC <> '' THEN
    CUSTOMER_NAME = CUSTOMER_REC<1>
    CUSTOMER_ADDRESS1 = CUSTOMER_REC<2>
    CUSTOMER_ADDRESS2 = CUSTOMER_REC<3>
    CUSTOMER_CITY = CUSTOMER_REC<4>
    CUSTOMER_STATE = CUSTOMER_REC<5>
    CUSTOMER_ZIP = CUSTOMER_REC<6>
    
    * Get REAL Bill To Code from position 8 (overrides what was saved in TMP)
    REAL_BILLTO_CODE = CUSTOMER_REC<8>
    IF INDEX(REAL_BILLTO_CODE, '*', 1) > 0 THEN REAL_BILLTO_CODE = FIELD(REAL_BILLTO_CODE, '*', 1)
    IF REAL_BILLTO_CODE <> '' THEN BILLTO_CODE = REAL_BILLTO_CODE
    
    * Ship To is same as customer
    SHIPTO_NAME = CUSTOMER_NAME
    SHIPTO_ADDRESS1 = CUSTOMER_ADDRESS1
    SHIPTO_ADDRESS2 = CUSTOMER_ADDRESS2
    SHIPTO_CITY = CUSTOMER_CITY
    SHIPTO_STATE = CUSTOMER_STATE
    SHIPTO_ZIP = CUSTOMER_ZIP
  END
END

* Convert multivalue separators to spaces first
CONVERT XVM TO ' ' IN CUSTOMER_NAME
CONVERT XSM TO ' ' IN CUSTOMER_NAME
CONVERT XAM TO ' ' IN CUSTOMER_NAME
CONVERT XVM TO ' ' IN CUSTOMER_ADDRESS1
CONVERT XSM TO ' ' IN CUSTOMER_ADDRESS1
CONVERT XAM TO ' ' IN CUSTOMER_ADDRESS1
CONVERT XVM TO ' ' IN CUSTOMER_ADDRESS2
CONVERT XSM TO ' ' IN CUSTOMER_ADDRESS2
CONVERT XAM TO ' ' IN CUSTOMER_ADDRESS2
CONVERT XVM TO ' ' IN CUSTOMER_CITY
CONVERT XSM TO ' ' IN CUSTOMER_CITY
CONVERT XAM TO ' ' IN CUSTOMER_CITY
CONVERT XVM TO ' ' IN SHIPTO_ADDRESS1
CONVERT XSM TO ' ' IN SHIPTO_ADDRESS1
CONVERT XAM TO ' ' IN SHIPTO_ADDRESS1
CONVERT XVM TO ' ' IN SHIPTO_ADDRESS2
CONVERT XSM TO ' ' IN SHIPTO_ADDRESS2
CONVERT XAM TO ' ' IN SHIPTO_ADDRESS2

* Clean XML special characters in customer data
* Remove characters that cause XML parsing errors
* Also remove control characters (ASCII 0-31 except tab, LF, CR)
BAD_CHARS = '&<>"' : "'" : CHAR(1):CHAR(2):CHAR(3):CHAR(4):CHAR(5):CHAR(6):CHAR(7):CHAR(8):CHAR(11):CHAR(12):CHAR(14):CHAR(15):CHAR(16):CHAR(17):CHAR(18):CHAR(19):CHAR(20):CHAR(21):CHAR(22):CHAR(23):CHAR(24):CHAR(25):CHAR(26):CHAR(27):CHAR(28):CHAR(29):CHAR(30):CHAR(31)

CONVERT BAD_CHARS TO '' IN CUSTOMER_NAME
CONVERT BAD_CHARS TO '' IN CUSTOMER_ADDRESS1
CONVERT BAD_CHARS TO '' IN CUSTOMER_ADDRESS2
CONVERT BAD_CHARS TO '' IN CUSTOMER_CITY
CONVERT BAD_CHARS TO '' IN SHIPTO_NAME
CONVERT BAD_CHARS TO '' IN SHIPTO_ADDRESS1
CONVERT BAD_CHARS TO '' IN SHIPTO_ADDRESS2
CONVERT BAD_CHARS TO '' IN SHIPTO_CITY
CONVERT BAD_CHARS TO '' IN HEADER_NOTES
CONVERT BAD_CHARS TO '' IN EMAIL
CONVERT BAD_CHARS TO '' IN SHIP_VIA
CONVERT BAD_CHARS TO '' IN TERMS

* Build XML response (same format as GET_SO.XML)
XML_RESPONSE = '<?xml version="1.0" encoding="UTF-8"?>'
XML_RESPONSE = XML_RESPONSE : '<so_data>'
XML_RESPONSE = XML_RESPONSE : '<so_number>' : SO_NUMBER : '</so_number>'
XML_RESPONSE = XML_RESPONSE : '<customer_code>' : CUSTOMER_CODE : '</customer_code>'
XML_RESPONSE = XML_RESPONSE : '<customer_name>' : CUSTOMER_NAME : '</customer_name>'
XML_RESPONSE = XML_RESPONSE : '<shipto_code>' : SHIPTO_CODE : '</shipto_code>'
XML_RESPONSE = XML_RESPONSE : '<billto_code>' : BILLTO_CODE : '</billto_code>'
XML_RESPONSE = XML_RESPONSE : '<ship_via>' : SHIP_VIA : '</ship_via>'
XML_RESPONSE = XML_RESPONSE : '<terms>' : TERMS : '</terms>'
XML_RESPONSE = XML_RESPONSE : '<email>' : EMAIL : '</email>'
XML_RESPONSE = XML_RESPONSE : '<header_notes>' : HEADER_NOTES : '</header_notes>'
XML_RESPONSE = XML_RESPONSE : '<so_status>' : SO_STATUS : '</so_status>'
XML_RESPONSE = XML_RESPONSE : '<carrier_account>' : CARRIER_ACCOUNT : '</carrier_account>'
XML_RESPONSE = XML_RESPONSE : '<po_date>' : SO_DATE : '</po_date>'
XML_RESPONSE = XML_RESPONSE : '<so_date>' : SO_DATE : '</so_date>'

* Customer info section
XML_RESPONSE = XML_RESPONSE : '<customer_info>'
XML_RESPONSE = XML_RESPONSE : '<name>' : CUSTOMER_NAME : '</name>'
XML_RESPONSE = XML_RESPONSE : '<address1>' : CUSTOMER_ADDRESS1 : '</address1>'
XML_RESPONSE = XML_RESPONSE : '<address2>' : CUSTOMER_ADDRESS2 : '</address2>'
XML_RESPONSE = XML_RESPONSE : '<city>' : CUSTOMER_CITY : '</city>'
XML_RESPONSE = XML_RESPONSE : '<state>' : CUSTOMER_STATE : '</state>'
XML_RESPONSE = XML_RESPONSE : '<zip>' : CUSTOMER_ZIP : '</zip>'
XML_RESPONSE = XML_RESPONSE : '</customer_info>'

* Ship To info section
XML_RESPONSE = XML_RESPONSE : '<shipto_info>'
XML_RESPONSE = XML_RESPONSE : '<name>' : SHIPTO_NAME : '</name>'
XML_RESPONSE = XML_RESPONSE : '<address1>' : SHIPTO_ADDRESS1 : '</address1>'
XML_RESPONSE = XML_RESPONSE : '<address2>' : SHIPTO_ADDRESS2 : '</address2>'
XML_RESPONSE = XML_RESPONSE : '<city>' : SHIPTO_CITY : '</city>'
XML_RESPONSE = XML_RESPONSE : '<state>' : SHIPTO_STATE : '</state>'
XML_RESPONSE = XML_RESPONSE : '<zip>' : SHIPTO_ZIP : '</zip>'
XML_RESPONSE = XML_RESPONSE : '</shipto_info>'

* Line items section
XML_RESPONSE = XML_RESPONSE : '<line_items>'

IF PART_NUMBERS <> '' THEN
  NUM_ITEMS = DCOUNT(PART_NUMBERS, XVM)
  FOR I = 1 TO NUM_ITEMS
    PART_NUM = FIELD(PART_NUMBERS, XVM, I)
    IF PART_NUM <> '' THEN
      DESC = FIELD(DESCRIPTIONS, XVM, I)
      QTY = FIELD(LINE_QUANTITIES, XVM, I)
      PRICE = FIELD(LINE_PRICES, XVM, I)
      UOM = FIELD(LINE_UOMS, XVM, I)
      LINE_NOTE = FIELD(LINE_NOTES, XVM, I)
      PROD_NOTE = FIELD(PROD_NOTES, XVM, I)
      TOTAL = FIELD(LINE_TOTALS, XVM, I)
      
      * Clean line item text fields
      CONVERT BAD_CHARS TO '' IN PART_NUM
      CONVERT BAD_CHARS TO '' IN DESC
      CONVERT BAD_CHARS TO '' IN LINE_NOTE
      CONVERT BAD_CHARS TO '' IN PROD_NOTE
      
      * Get tracking data for this line item
      NEED_ENTRIES = FIELD(NEED_DATA, XVM, I)
      SCHEDULE_ENTRIES = FIELD(SCHEDULE_DATA, XVM, I)
      
      XML_RESPONSE = XML_RESPONSE : '<line_item>'
      XML_RESPONSE = XML_RESPONSE : '<line_number>' : I : '</line_number>'
      XML_RESPONSE = XML_RESPONSE : '<part_number>' : PART_NUM : '</part_number>'
      XML_RESPONSE = XML_RESPONSE : '<description>' : DESC : '</description>'
      XML_RESPONSE = XML_RESPONSE : '<quantity>' : QTY : '</quantity>'
      XML_RESPONSE = XML_RESPONSE : '<unit_price>' : PRICE : '</unit_price>'
      XML_RESPONSE = XML_RESPONSE : '<unit_of_measure>' : UOM : '</unit_of_measure>'
      XML_RESPONSE = XML_RESPONSE : '<line_notes>' : LINE_NOTE : '</line_notes>'
      XML_RESPONSE = XML_RESPONSE : '<prod_notes>' : PROD_NOTE : '</prod_notes>'
      XML_RESPONSE = XML_RESPONSE : '<total>' : TOTAL : '</total>'
      
      * Add need entries (subvalues separated by CHAR(252))
      IF NEED_ENTRIES <> '' THEN
        XML_RESPONSE = XML_RESPONSE : '<need_entries>'
        NEED_COUNT = DCOUNT(NEED_ENTRIES, XSM)
        FOR N = 1 TO NEED_COUNT
          NEED_ENTRY = FIELD(NEED_ENTRIES, XSM, N)
          IF NEED_ENTRY <> '' AND INDEX(NEED_ENTRY, '*', 1) > 0 THEN
            NEED_DATE = FIELD(NEED_ENTRY, '*', 1)
            NEED_QTY = FIELD(NEED_ENTRY, '*', 2)
            XML_RESPONSE = XML_RESPONSE : '<need_entry>'
            XML_RESPONSE = XML_RESPONSE : '<need_date>' : NEED_DATE : '</need_date>'
            XML_RESPONSE = XML_RESPONSE : '<need_qty>' : NEED_QTY : '</need_qty>'
            XML_RESPONSE = XML_RESPONSE : '</need_entry>'
          END
        NEXT N
        XML_RESPONSE = XML_RESPONSE : '</need_entries>'
      END
      
      * Add schedule entries (subvalues separated by CHAR(252))
      IF SCHEDULE_ENTRIES <> '' THEN
        XML_RESPONSE = XML_RESPONSE : '<schedule_entries>'
        SCHED_COUNT = DCOUNT(SCHEDULE_ENTRIES, XSM)
        FOR S = 1 TO SCHED_COUNT
          SCHED_ENTRY = FIELD(SCHEDULE_ENTRIES, XSM, S)
          IF SCHED_ENTRY <> '' AND INDEX(SCHED_ENTRY, '*', 1) > 0 THEN
            SCHED_DATE = FIELD(SCHED_ENTRY, '*', 1)
            SCHED_QTY = FIELD(SCHED_ENTRY, '*', 2)
            XML_RESPONSE = XML_RESPONSE : '<schedule_entry>'
            XML_RESPONSE = XML_RESPONSE : '<schedule_date>' : SCHED_DATE : '</schedule_date>'
            XML_RESPONSE = XML_RESPONSE : '<schedule_qty>' : SCHED_QTY : '</schedule_qty>'
            XML_RESPONSE = XML_RESPONSE : '</schedule_entry>'
          END
        NEXT S
        XML_RESPONSE = XML_RESPONSE : '</schedule_entries>'
      END
      
      XML_RESPONSE = XML_RESPONSE : '</line_item>'
    END
  NEXT I
END

XML_RESPONSE = XML_RESPONSE : '</line_items>'
XML_RESPONSE = XML_RESPONSE : '</so_data>'

FINISH_OUTPUT:
WRITE XML_RESPONSE TO XMLDATAF, 'GET_SO_TMP_DETAIL.XML'
ERR = ''
CALL PLW.PAGE('/XMLDATA/GET_SO_TMP_DETAIL.XML','',ERR)
RETURN
</PRE>
