<pre>

PicLan-IP/BASIC ^ ^
*
OPEN 'XMLDATA' TO XMLDATAF ELSE STOP 201,'XMLDATA'
OPEN 'WO' TO WOF ELSE STOP 201,'WO'

* Get parameters from POST request
PL_GETVAR WORK_NUMBER FROM 'WORK_NUMBER' ELSE WORK_NUMBER = ''
PL_GETVAR WO_DATE FROM 'WO_DATE' ELSE WO_DATE = ''
PL_GETVAR WO_TYPE FROM 'WO_TYPE' ELSE WO_TYPE = ''
PL_GETVAR START_DATE FROM 'START_DATE' ELSE START_DATE = ''
PL_GETVAR ASSY_NO FROM 'ASSY_NO' ELSE ASSY_NO = ''
PL_GETVAR SCHEDULE_DATE FROM 'SCHEDULE_DATE' ELSE SCHEDULE_DATE = ''
PL_GETVAR SCHEDULE_QTY FROM 'SCHEDULE_QTY' ELSE SCHEDULE_QTY = ''
PL_GETVAR YIELD FROM 'YIELD' ELSE YIELD = ''
PL_GETVAR ORD_QTY FROM 'ORD_QTY' ELSE ORD_QTY = ''
PL_GETVAR NOTES FROM 'NOTES' ELSE NOTES = ''
PL_GETVAR ACTION FROM 'ACTION' ELSE ACTION = ''

PL_ADD_HDR '"Content-Type: application/xml"'

CRLF = CHAR(13):CHAR(10)
XML.RESPONSE = '<?xml version="1.0" encoding="UTF-8"?>':CRLF
XML.RESPONSE = XML.RESPONSE:'<WorkOrderSave>':CRLF
XML.RESPONSE = XML.RESPONSE:'  <action>':ACTION:'</action>':CRLF
XML.RESPONSE = XML.RESPONSE:'  <work_number>':WORK_NUMBER:'</work_number>':CRLF

* Validate required fields
ERRORS = ''
IF WORK_NUMBER = '' THEN ERRORS = ERRORS:'Work Number is required;'
IF WO_DATE = '' THEN ERRORS = ERRORS:'WO Date is required;'
IF WO_TYPE = '' THEN ERRORS = ERRORS:'WO Type is required;'
IF ASSY_NO = '' THEN ERRORS = ERRORS:'Assembly Number is required;'

IF ERRORS <> '' THEN
    XML.RESPONSE = XML.RESPONSE:'  <status>ERROR</status>':CRLF
    XML.RESPONSE = XML.RESPONSE:'  <message>Validation failed</message>':CRLF
    XML.RESPONSE = XML.RESPONSE:'  <errors>':ERRORS:'</errors>':CRLF
    GOTO FINISH
END

* Function to convert YYYY-MM-DD to MM/DD/YYYY for ICONV
* Convert WO_DATE from 2023-06-13 to 06/13/2023
WO_DATE_CONVERTED = ''
IF WO_DATE <> '' THEN
    IF LEN(WO_DATE) = 10 AND INDEX(WO_DATE, '-', 1) > 0 THEN
        YEAR_PART = FIELD(WO_DATE, '-', 1)
        MONTH_PART = FIELD(WO_DATE, '-', 2)
        DAY_PART = FIELD(WO_DATE, '-', 3)
        WO_DATE_CONVERTED = MONTH_PART:'/':DAY_PART:'/':YEAR_PART
    END
END

WO_DATE_JULIAN = ''
IF WO_DATE_CONVERTED <> '' THEN
    WO_DATE_JULIAN = ICONV(WO_DATE_CONVERTED, 'D4/')
END

* Convert START_DATE
START_DATE_CONVERTED = ''
START_DATE_JULIAN = ''
IF START_DATE <> '' THEN
    IF LEN(START_DATE) = 10 AND INDEX(START_DATE, '-', 1) > 0 THEN
        YEAR_PART = FIELD(START_DATE, '-', 1)
        MONTH_PART = FIELD(START_DATE, '-', 2)
        DAY_PART = FIELD(START_DATE, '-', 3)
        START_DATE_CONVERTED = MONTH_PART:'/':DAY_PART:'/':YEAR_PART
        START_DATE_JULIAN = ICONV(START_DATE_CONVERTED, 'D4/')
    END
END

* Convert SCHEDULE_DATE
SCHEDULE_DATE_CONVERTED = ''
SCHEDULE_DATE_JULIAN = ''
IF SCHEDULE_DATE <> '' THEN
    IF LEN(SCHEDULE_DATE) = 10 AND INDEX(SCHEDULE_DATE, '-', 1) > 0 THEN
        YEAR_PART = FIELD(SCHEDULE_DATE, '-', 1)
        MONTH_PART = FIELD(SCHEDULE_DATE, '-', 2)
        DAY_PART = FIELD(SCHEDULE_DATE, '-', 3)
        SCHEDULE_DATE_CONVERTED = MONTH_PART:'/':DAY_PART:'/':YEAR_PART
        SCHEDULE_DATE_JULIAN = ICONV(SCHEDULE_DATE_CONVERTED, 'D4/')
    END
END

* Combine schedule date and quantity (format: julian*qty)
SCHEDULE_DATE_FIELD = ''
IF SCHEDULE_DATE_JULIAN <> '' THEN
    SCHEDULE_DATE_FIELD = SCHEDULE_DATE_JULIAN
    IF SCHEDULE_QTY <> '' AND SCHEDULE_QTY > 0 THEN
        SCHEDULE_DATE_FIELD = SCHEDULE_DATE_FIELD:'*':SCHEDULE_QTY
    END
END

* Convert notes - replace newlines with value marks
NOTES_CONVERTED = ''
IF NOTES <> '' THEN
    NOTES_CONVERTED = CHANGE(NOTES, CHAR(10), @VM)
END

* Check if Work Order already exists
READ EXISTING.RECORD FROM WOF, WORK_NUMBER ELSE EXISTING.RECORD = ''

* Build WO record
WO.RECORD = ''
WO.RECORD<1> = WO_DATE_JULIAN
WO.RECORD<20> = WO_TYPE
WO.RECORD<25> = NOTES_CONVERTED
WO.RECORD<32> = ASSY_NO
WO.RECORD<34> = SCHEDULE_DATE_FIELD
WO.RECORD<35> = ORD_QTY
WO.RECORD<36> = YIELD
WO.RECORD<104> = START_DATE_JULIAN

* Write to database
WRITE WO.RECORD ON WOF, WORK_NUMBER ELSE
    XML.RESPONSE = XML.RESPONSE:'  <status>ERROR</status>':CRLF
    XML.RESPONSE = XML.RESPONSE:'  <message>Failed to write Work Order to database</message>':CRLF
    GOTO FINISH
END

* Success response
IF EXISTING.RECORD <> '' THEN
    XML.RESPONSE = XML.RESPONSE:'  <status>SUCCESS</status>':CRLF
    XML.RESPONSE = XML.RESPONSE:'  <message>Work Order updated successfully</message>':CRLF
END ELSE
    XML.RESPONSE = XML.RESPONSE:'  <status>SUCCESS</status>':CRLF
    XML.RESPONSE = XML.RESPONSE:'  <message>Work Order created successfully</message>':CRLF
END

XML.RESPONSE = XML.RESPONSE:'  <wo_id>':WORK_NUMBER:'</wo_id>':CRLF

FINISH:
XML.RESPONSE = XML.RESPONSE:'</WorkOrderSave>':CRLF

WRITE XML.RESPONSE ON XMLDATAF,'UPDATE_WO_FIXED.XML'
ERR = ''
CALL PLW.PAGE('/XMLDATA/UPDATE_WO_FIXED.XML','',ERR)
RETURN
</pre>