<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>BOM Editor</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  
  <!-- Application Scripts -->
  <script src="aflibs.pick_login2.js?_=^TS^"></script>
  <script src="quotepartimport.js?_=^TS^"></script>
  <script src="bomedit.js?_=^TS^"></script>
  
  <script type="text/javascript">
  function sizeUp() {
    var txts = document.getElementsByTagName('textarea');
    var sm = 0;
    var rta = '';
    var i;
    
    for(i=0;i<txts.length;i++) {
      txts[i].style.height = "20px";
      txts[i].style.height = (txts[i].scrollHeight+"px");
    }
  }
  
  function BomEdit(st,clevel,bompt) {
    expandInlineEditRow(st, clevel, bompt);
  }
  
  function PrintBom() {
    window.open("PRINTBOMCDA.HTM?ID=" + document.getElementById("NBOM").value, "_blank");
  }
  
  function YorkBom() {
    window.open("YORKBOM2.HTM?PARTNO=" + document.getElementById("NBOM").value + "&UPDATE=1", "_blank");
  }
  
  function GoMenu() {
    document.getElementById('EVENT').value = 'menu';
    document.frmBOM.submit();
  }
  
  function BomTxtEdit() {
    document.getElementById('EVENT').value = 'bomtxtedit';
    document.frmBOM.submit();
  }
  
  function BomAdd() {
    document.getElementById('EVENT').value = 'bomadd';
    document.frmBOM.submit();
  }
  
  function BooAdd() {
    document.getElementById('EVENT').value = 'booadd';
    document.frmBOM.submit();
  }
  
  function addBombLine(position) {
    console.log('addBombLine called with:', position);
    
    if (position === 'at-end') {
      console.log('Creating form at end of table');
      createInlineBomForm(null, 'at-end', false);
    } else if (position && typeof position === 'object' && 'referenceLine' in position) {
      console.log('Creating form after reference line:', position.referenceLine);
      createInlineBomForm(position.referenceLine, position.insertPosition || 'after', position.isBOO || false);
    } else {
      console.error('Invalid position parameter:', position);
      showNotification('Error', 'Invalid position parameter for adding BOM line', 'error');
    }
  }
  
  function createInlineBomForm(referenceLine, position, isBOO) {
    try {
      console.log('=== createInlineBomForm START ===');
      console.log('referenceLine:', referenceLine, 'position:', position, 'isBOO:', isBOO);
      
      var table = document.querySelector('.table-container table');
      if (!table) {
        console.error('Table not found!');
        showNotification('Error', 'BOM table not found', 'error');
        return;
      }
      console.log('Table found:', table);
      
      var existingForms = document.querySelectorAll('.inline-add-bom-row');
      console.log('Removing', existingForms.length, 'existing forms');
      for (var i = 0; i < existingForms.length; i++) {
        existingForms[i].remove();
      }
      
      var targetRow = null;
      
      if (position === 'at-end') {
        var rows = table.querySelectorAll('tr');
        for (var j = rows.length - 1; j >= 1; j--) {
          var cells = rows[j].querySelectorAll('td');
          if (cells.length > 0) {
            targetRow = rows[j];
            break;
          }
        }
        if (!targetRow) {
          targetRow = table.querySelector('tr:nth-child(2)');
        }
      } else if (position === 'after' && referenceLine) {
        var rows = table.querySelectorAll('tr');
        for (var k = 1; k < rows.length; k++) {
          var cells = rows[k].querySelectorAll('td');
          if (cells.length > 0) {
            var partNumber = cells[0].textContent.trim();
            if (partNumber === referenceLine) {
              targetRow = rows[k];
              break;
            }
          }
        }
      }
      
      if (!targetRow) {
        console.error('Target row not found!');
        showNotification('Error', 'Could not find insertion point', 'error');
        return;
      }
      console.log('Target row found:', targetRow);
      
      var addRow = document.createElement('tr');
      addRow.className = 'inline-add-bom-row';
      addRow.style.background = isBOO ? '#fef3c7' : '#f0f9ff';
      addRow.style.animation = 'slideDown 0.3s ease-out';
      console.log('Created add row');
      
      var cellCount = targetRow.querySelectorAll('td').length;
      var addCell = document.createElement('td');
      addCell.colSpan = cellCount;
      addCell.style.padding = '16px';
      addCell.style.borderTop = '2px dashed ' + (isBOO ? '#f59e0b' : '#3b82f6');
      addCell.style.borderBottom = '2px dashed ' + (isBOO ? '#f59e0b' : '#3b82f6');
      
      var itemType = isBOO ? 'BOO' : 'BOM';
      var timestamp = Date.now();
      var partId = 'add-part-' + timestamp;
      var seqId = 'add-seq-' + timestamp;
      var costId = 'add-cost-' + timestamp;
      var qtyId = 'add-qty-' + timestamp;
      var timeId = 'add-time-' + timestamp;
      var descId = 'add-desc-' + timestamp;
      var safeReference = (referenceLine || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
      
      var formHtml = `
        <div class="inline-add-bom-container">
          <div class="add-indicator" style="background: ${isBOO ? '#fef3c7' : '#dcfce7'}; color: ${isBOO ? '#92400e' : '#166534'};">
            <i class="fas fa-plus"></i> Adding New ${itemType} Line ${position === 'after' ? 'After ' + referenceLine : 'at End'}
          </div>
          <form class="inline-add-form" onsubmit="return saveInlineBomAdd(event, '${safeReference}', '${position}', ${isBOO})">
            <div class="inline-add-grid">
              <div class="inline-add-group">
                <label for="${partId}">
                  <i class="fas fa-${isBOO ? 'cogs' : 'tag'}" style="color: #1e40af;"></i> ${isBOO ? 'Operation' : 'Part Number'}
                </label>
                <input type="text" id="${partId}" name="part" placeholder="${isBOO ? 'Enter Operation Code' : 'Enter Part Number'}" required>
              </div>
              <div class="inline-add-group">
                <label for="${seqId}">
                  <i class="fas fa-sort-numeric-up" style="color: #1e40af;"></i> ${isBOO ? 'Sequence' : 'RM Sequence'}
                </label>
                <input type="text" id="${seqId}" name="seq" placeholder="Enter Sequence" required>
              </div>
              <div class="inline-add-group">
                <label for="${costId}">
                  <i class="fas fa-dollar-sign" style="color: #1e40af;"></i> Cost Level
                </label>
                <input type="text" id="${costId}" name="cost" placeholder="Enter Cost Level" required>
              </div>
              ${!isBOO ? `
              <div class="inline-add-group">
                <label for="${qtyId}">
                  <i class="fas fa-cubes" style="color: #1e40af;"></i> Quantity
                </label>
                <input type="number" id="${qtyId}" name="qty" value="1" min="0" step="0.01">
              </div>
              ` : `
              <div class="inline-add-group">
                <label for="${timeId}">
                  <i class="fas fa-clock" style="color: #1e40af;"></i> Standard Time (min)
                </label>
                <input type="number" id="${timeId}" name="time" value="0" min="0" step="0.01">
              </div>
              `}
              <div class="inline-add-group">
                <label for="${descId}">
                  <i class="fas fa-file-alt" style="color: #1e40af;"></i> Description
                </label>
                <textarea id="${descId}" name="desc" rows="2" placeholder="Enter Description"></textarea>
              </div>
            </div>
            <div class="inline-add-actions">
              <button type="button" class="inline-add-btn cancel" onclick="cancelInlineBomAdd()">
                <i class="fas fa-times"></i> Cancel
              </button>
              <button type="submit" class="inline-add-btn save">
                <i class="fas fa-save"></i> Save
              </button>
            </div>
          </form>
        </div>
      `;
      
      addCell.innerHTML = formHtml;
      addRow.appendChild(addCell);
      
      console.log('About to insert add row after target row');
      targetRow.parentNode.insertBefore(addRow, targetRow.nextSibling);
      console.log('Add row inserted successfully!');
      
      addRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      
      setTimeout(function() {
        var firstInput = addRow.querySelector('input[type="text"]');
        if (firstInput) {
          console.log('Focusing on first input');
          firstInput.focus();
        } else {
          console.log('First input not found');
        }
      }, 300);
      
      console.log('=== createInlineBomForm END ===');
    } catch (e) {
      console.error('Error creating inline BOM form:', e);
      showNotification('Error', 'Failed to create add form', 'error');
    }
  }
  
  function saveInlineBomAdd(event, referenceLine, position, isBOO) {
    try {
      event.preventDefault();
      
      var form = event.target;
      var part = form.querySelector('input[name="part"]').value.trim();
      var seq = form.querySelector('input[name="seq"]').value.trim();
      var cost = form.querySelector('input[name="cost"]').value.trim();
      var desc = form.querySelector('textarea[name="desc"]').value.trim();
      var reference = (referenceLine || '').trim();
      var positionValue = position || 'at-end';
      
      if (isBOO) {
        var time = form.querySelector('input[name="time"]').value;
        document.getElementById('EVENT').value = 'savebooaddafter';
        document.getElementById('BOMOP').value = part;
        document.getElementById('COSTLEVEL').value = cost;
        document.getElementById('REFERENCE_LINE').value = reference;
        document.getElementById('INSERT_POSITION').value = positionValue;
        document.getElementById('BOO_DESCRIPTION').value = desc;
        document.getElementById('BOO_TIME').value = time;
        document.getElementById('BOO_LABOR').value = '0';
        document.getElementById('BOMPT').value = '';
      } else {
        var qty = form.querySelector('input[name="qty"]').value;
        if (!qty) {
          qty = '1';
        }
        document.getElementById('EVENT').value = 'savebomaddafter';
        document.getElementById('BOMPT').value = part;
        document.getElementById('COSTLEVEL').value = cost;
        document.getElementById('RMSEQ').value = seq;
        document.getElementById('REFERENCE_LINE').value = reference;
        document.getElementById('INSERT_POSITION').value = positionValue;
        document.getElementById('QUANTITY').value = qty;
        document.getElementById('DESCRIPTION').value = desc;
        document.getElementById('BOMOP').value = '';
      }
      
      var saveBtn = form.querySelector('.inline-add-btn.save');
      var originalText = saveBtn.innerHTML;
      saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
      saveBtn.disabled = true;
      
      document.frmBOM.submit();
      
      return false;
    } catch (e) {
      console.error('Error saving inline BOM add:', e);
      return false;
    }
  }
  
  function cancelInlineBomAdd() {
    try {
      var addRows = document.querySelectorAll('.inline-add-bom-row');
      for (var i = 0; i < addRows.length; i++) {
        addRows[i].style.animation = 'slideUp 0.3s ease-out';
        setTimeout(function(row) {
          row.remove();
        }, 300, addRows[i]);
      }
    } catch (e) {
      console.error('Error canceling inline BOM add:', e);
    }
  }
  
  function BooEdit(clevel,bomop) {
    expandInlineEditBOORow(clevel, bomop);
  }
  
  function BomDelete(clevel,bompt,st) {
    BomDeleteInline(clevel, bompt, st);
  }
  
  function BooDelete(clevel,bomop) {
    BooDeleteInline(clevel, bomop);
  }

  function expandInlineEditRow(st, clevel, bompt) {
    try {
      console.log('=== expandInlineEditRow called ===');
      console.log('st:', st, 'clevel:', clevel, 'bompt:', bompt);
      
      var openRows = document.querySelectorAll('.inline-edit-row.active');
      console.log('Closing', openRows.length, 'open rows');
      for (var i = 0; i < openRows.length; i++) {
        openRows[i].classList.remove('active');
      }
      
      var table = document.querySelector('.table-container table');
      if (!table) {
        console.error('Table not found!');
        return;
      }
      
      var rows = table.querySelectorAll('tr');
      var targetRow = null;
      
      for (var j = 0; j < rows.length; j++) {
        var cells = rows[j].querySelectorAll('td');
        if (cells.length > 0) {
          var rowSt = cells[0].textContent.trim();
          var rowClevel = cells.length > 20 ? cells[20].textContent.trim() : '';
          var rowBompt = cells.length > 0 ? cells[0].textContent.trim() : '';
          
          if (rowSt === st || rowBompt === bompt) {
            targetRow = rows[j];
            break;
          }
        }
      }
      
      if (!targetRow) {
        console.error('Target row not found!');
        return;
      }
      
      console.log('Found target row:', targetRow);
      
      var existingEditRow = targetRow.nextElementSibling;
      if (existingEditRow && existingEditRow.classList.contains('inline-edit-row')) {
        console.log('Edit row already exists, activating it');
        existingEditRow.classList.add('active');
        return;
      }
      
      console.log('Creating new inline edit row');
      var editRow = document.createElement('tr');
      editRow.className = 'inline-edit-row active';
      
      var editCell = document.createElement('td');
      editCell.colSpan = targetRow.querySelectorAll('td').length;
      
      var editForm = createInlineEditForm(st, clevel, bompt);
      editCell.innerHTML = editForm;
      
      editRow.appendChild(editCell);
      
      targetRow.parentNode.insertBefore(editRow, targetRow.nextSibling);
      console.log('Inline edit row inserted successfully');
      
      editRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      
    } catch (e) {
      console.error('Error expanding inline edit row:', e);
    }
  }
  
  function createInlineEditForm(st, clevel, bompt) {
    return `
      <div class="inline-edit-container">
        <div class="edit-indicator">
          <i class="fas fa-edit"></i> Editing BOM Item
        </div>
        <form class="inline-edit-form" onsubmit="return saveInlineEdit(event, '${st}', '${clevel}', '${bompt}')">
          <div class="inline-edit-group">
            <label for="edit-part">
              <i class="fas fa-tag" style="color: #1e40af;"></i> Part Number
            </label>
            <input type="text" id="edit-part" name="part" value="${bompt || ''}" required>
          </div>
          <div class="inline-edit-group">
            <label for="edit-seq">
              <i class="fas fa-sort-numeric-up" style="color: #1e40af;"></i> Sequence
            </label>
            <input type="text" id="edit-seq" name="seq" value="${st || ''}" required>
          </div>
          <div class="inline-edit-group">
            <label for="edit-cost">
              <i class="fas fa-dollar-sign" style="color: #1e40af;"></i> Cost Level
            </label>
            <input type="text" id="edit-cost" name="cost" value="${clevel || ''}" required>
          </div>
          <div class="inline-edit-group">
            <label for="edit-qty">
              <i class="fas fa-cubes" style="color: #1e40af;"></i> Quantity
            </label>
            <input type="number" id="edit-qty" name="qty" value="1" min="0" step="0.01">
          </div>
          <div class="inline-edit-group">
            <label for="edit-desc">
              <i class="fas fa-file-alt" style="color: #1e40af;"></i> Description
            </label>
            <textarea id="edit-desc" name="desc" rows="3"></textarea>
          </div>
          <div class="inline-edit-actions">
            <button type="button" class="inline-edit-btn cancel" onclick="cancelInlineEdit()">
              <i class="fas fa-times"></i> Cancel
            </button>
            <button type="submit" class="inline-edit-btn save">
              <i class="fas fa-save"></i> Save Changes
            </button>
          </div>
        </form>
      </div>
    `;
  }
  
  function saveInlineEdit(event, st, clevel, bompt) {
    event.preventDefault();
    
    var form = event.target;
    var part = form.querySelector('#edit-part').value;
    var seq = form.querySelector('#edit-seq').value;
    var cost = form.querySelector('#edit-cost').value;
    
    document.getElementById('EVENT').value = 'bomedit';
    document.getElementById('BOMPT').value = part;
    document.getElementById('COSTLEVEL').value = cost;
    document.getElementById('RMSEQ').value = seq;
    
    document.frmBOM.submit();
    return false;
  }
  
  function cancelInlineEdit() {
    try {
      var editRows = document.querySelectorAll('.inline-edit-row.active');
      for (var i = 0; i < editRows.length; i++) {
        editRows[i].classList.remove('active');
      }
    } catch (e) {
      console.error('Error canceling inline edit:', e);
    }
  }
  
  function BomDeleteInline(clevel, bompt, st) {
    if (confirm('Are you sure you want to delete this BOM item?')) {
      document.getElementById('EVENT').value = 'bomdelete';
      document.getElementById('BOMPT').value = bompt;
      document.getElementById('COSTLEVEL').value = clevel;
      document.getElementById('RMSEQ').value = st;
      
      document.frmBOM.submit();
    }
  }

  function expandInlineEditBOORow(clevel, bomop) {
    try {
      var openRows = document.querySelectorAll('.inline-edit-row.active');
      for (var i = 0; i < openRows.length; i++) {
        openRows[i].classList.remove('active');
      }
      
      var table = document.querySelector('.table-container table');
      if (!table) return;
      
      var rows = table.querySelectorAll('tr');
      var targetRow = null;
      
      for (var j = 0; j < rows.length; j++) {
        var cells = rows[j].querySelectorAll('td');
        if (cells.length > 0) {
          var rowClevel = cells.length > 1 ? cells[1].textContent.trim() : '';
          var rowBomop = cells.length > 0 ? cells[0].textContent.trim() : '';
          
          if (rowClevel === clevel || rowBomop === bomop) {
            targetRow = rows[j];
            break;
          }
        }
      }
      
      if (!targetRow) return;
      
      var existingEditRow = targetRow.nextElementSibling;
      if (existingEditRow && existingEditRow.classList.contains('inline-edit-row')) {
        existingEditRow.classList.add('active');
        return;
      }
      
      var editRow = document.createElement('tr');
      editRow.className = 'inline-edit-row active';
      
      var editCell = document.createElement('td');
      editCell.colSpan = targetRow.querySelectorAll('td').length;
      
      var editForm = createInlineBOOEditForm(clevel, bomop);
      editCell.innerHTML = editForm;
      
      editRow.appendChild(editCell);
      
      targetRow.parentNode.insertBefore(editRow, targetRow.nextSibling);
      
      editRow.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      
    } catch (e) {
      console.error('Error expanding inline BOO edit row:', e);
    }
  }
  
  function createInlineBOOEditForm(clevel, bomop) {
    return `
      <div class="inline-edit-container">
        <div class="edit-indicator">
          <i class="fas fa-edit"></i> Editing BOO Item
        </div>
        <form class="inline-edit-form" onsubmit="return saveInlineBOOEdit(event, '${clevel}', '${bomop}')">
          <div class="inline-edit-group">
            <label for="edit-boo-op">
              <i class="fas fa-cogs" style="color: #1e40af;"></i> Operation
            </label>
            <input type="text" id="edit-boo-op" name="op" value="${bomop || ''}" required>
          </div>
          <div class="inline-edit-group">
            <label for="edit-boo-cost">
              <i class="fas fa-dollar-sign" style="color: #1e40af;"></i> Cost Level
            </label>
            <input type="text" id="edit-boo-cost" name="cost" value="${clevel || ''}" required>
          </div>
          <div class="inline-edit-group">
            <label for="edit-boo-desc">
              <i class="fas fa-file-alt" style="color: #1e40af;"></i> Description
            </label>
            <textarea id="edit-boo-desc" name="desc" rows="3"></textarea>
          </div>
          <div class="inline-edit-group">
            <label for="edit-boo-time">
              <i class="fas fa-clock" style="color: #1e40af;"></i> Standard Time (minutes)
            </label>
            <input type="number" id="edit-boo-time" name="time" value="0" min="0" step="0.01">
          </div>
          <div class="inline-edit-group">
            <label for="edit-boo-labor">
              <i class="fas fa-users" style="color: #1e40af;"></i> Labor Rate
            </label>
            <input type="number" id="edit-boo-labor" name="labor" value="0" min="0" step="0.01">
          </div>
          <div class="inline-edit-actions">
            <button type="button" class="inline-edit-btn cancel" onclick="cancelInlineEdit()">
              <i class="fas fa-times"></i> Cancel
            </button>
            <button type="submit" class="inline-edit-btn save">
              <i class="fas fa-save"></i> Save Changes
            </button>
          </div>
        </form>
      </div>
    `;
  }
  
  function saveInlineBOOEdit(event, clevel, bomop) {
    event.preventDefault();
    
    var form = event.target;
    var op = form.querySelector('#edit-boo-op').value;
    var cost = form.querySelector('#edit-boo-cost').value;
    
    document.getElementById('EVENT').value = 'booedit';
    document.getElementById('BOMOP').value = op;
    document.getElementById('COSTLEVEL').value = cost;
    
    document.frmBOM.submit();
    return false;
  }
  
  function BooDeleteInline(clevel, bomop) {
    if (confirm('Are you sure you want to delete this BOO item?')) {
      document.getElementById('EVENT').value = 'boodelete';
      document.getElementById('BOMOP').value = bomop;
      document.getElementById('COSTLEVEL').value = clevel;
      
      document.frmBOM.submit();
    }
  }

  function showNotification(title, message, type, primaryCallback, secondaryCallback) {
    try {
      var modal = document.getElementById('notificationModal');
      var icon = document.getElementById('notificationIcon');
      var titleEl = document.getElementById('notificationTitle');
      var messageEl = document.getElementById('notificationMessage');
      var primaryBtn = document.getElementById('notificationPrimaryBtn');
      var secondaryBtn = document.getElementById('notificationSecondaryBtn');
      
      titleEl.textContent = title;
      messageEl.textContent = message;
      
      icon.className = 'notification-icon ' + type;
      if (type === 'success') {
        icon.innerHTML = '<i class="fas fa-check"></i>';
      } else if (type === 'error') {
        icon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
      } else {
        icon.innerHTML = '<i class="fas fa-info"></i>';
      }
      
      primaryBtn.textContent = 'OK';
      primaryBtn.onclick = function() {
        modal.classList.remove('active');
        if (primaryCallback) primaryCallback();
      };
      
      if (secondaryCallback) {
        secondaryBtn.style.display = 'block';
        secondaryBtn.textContent = 'Cancel';
        secondaryBtn.onclick = function() {
          modal.classList.remove('active');
          if (secondaryCallback) secondaryCallback();
        };
      } else {
        secondaryBtn.style.display = 'none';
      }
      
      modal.classList.add('active');
    } catch (e) {
      console.error('Error showing notification:', e);
    }
  }

  function initializeBOMGrid() {
    try {
      console.log('=== Initializing BOM Grid ===');
      var tables = document.querySelectorAll('.table-container table');
      console.log('Found', tables.length, 'tables');
      for (var i = 0; i < tables.length; i++) {
        tables[i].classList.add('excel-grid-premium');
        
        var headers = tables[i].querySelectorAll('th');
        for (var j = 0; j < headers.length; j++) {
          headers[j].classList.add('excel-header');
          
          headers[j].addEventListener('click', function() {
            sortBOMTable(this);
          });
        }
        
        var rows = tables[i].querySelectorAll('tr');
        var processedRows = 0;
        console.log('Processing', rows.length, 'rows');
        for (var k = 0; k < rows.length; k++) {
          if (rows[k].querySelector('th')) continue;
          rows[k].classList.add('excel-row');
          
          addInlineEditButtons(rows[k]);
          processedRows++;
        }
        console.log('Processed', processedRows, 'data rows');
        
        var cells = tables[i].querySelectorAll('td');
        for (var l = 0; l < cells.length; l++) {
          cells[l].classList.add('excel-cell');
        }
      }
      
      var recordCount = document.querySelectorAll('.table-container tr').length - 1;
      var countElement = document.getElementById('recordsCount');
      if (countElement && recordCount > 0) {
        countElement.textContent = recordCount + ' BOM Records';
      }
    } catch (e) {
      console.error('Error initializing BOM grid:', e);
    }
  }
  
  function addInlineEditButtons(row) {
    try {
      if (row.dataset.processed === 'true') {
        return;
      }
      
      var cells = row.querySelectorAll('td');
      if (cells.length === 0) return;
      
      var removedCount = 0;
      for (var idx = 0; idx < cells.length; idx++) {
        var links = cells[idx].querySelectorAll('a');
        for (var linkIdx = links.length - 1; linkIdx >= 0; linkIdx--) {
          var link = links[linkIdx];
          var linkText = link.textContent.trim();
          var linkHref = link.getAttribute('href') || '';
          
          if (linkText.match(/\[(Edit|Delete)\]/i) || 
              linkText.match(/Edit|Delete/i) ||
              linkHref.includes('bomedit') ||
              linkHref.includes('bomdelete') ||
              linkHref.includes('booedit') ||
              linkHref.includes('boodelete')) {
            console.log('Removing legacy link:', linkText, linkHref);
            link.remove();
            removedCount++;
          }
        }
      }
      if (removedCount > 0) {
        console.log('Total legacy links removed from row:', removedCount);
      }
      
      var lastCell = cells[cells.length - 1];
      
      if (lastCell.querySelector('.btn-inline-edit, .btn-inline-delete, .btn-inline-add')) {
        console.log('Skipping row - inline buttons already exist');
        return;
      }
      
      row.dataset.processed = 'true';
      
      console.log('Clearing Actions cell and adding inline buttons');
      lastCell.innerHTML = '';
      lastCell.style.textAlign = 'center';
      
      var isBOORow = false;
      
      if (cells.length > 0) {
        var firstCellText = cells[0].textContent.trim();
        if (firstCellText.startsWith('OP') || cells.length < 10) {
          isBOORow = true;
        }
      }
      
      var actionContainer = document.createElement('div');
      actionContainer.className = 'action-buttons';
      actionContainer.style.display = 'flex';
      actionContainer.style.gap = '6px';
      actionContainer.style.justifyContent = 'center';
      actionContainer.style.alignItems = 'center';
      
      if (isBOORow) {
        var clevel = cells.length > 1 ? cells[1].textContent.trim() : '';
        var bomop = cells.length > 0 ? cells[0].textContent.trim() : '';
        
        var addBtn = document.createElement('button');
        addBtn.className = 'btn-inline-add';
        addBtn.innerHTML = '<i class="fas fa-plus"></i>';
        addBtn.title = 'Añadir elemento debajo';
        addBtn.type = 'button';
        addBtn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          addBombLine({
            insertPosition: 'after',
            referenceLine: bomop,
            isBOO: true
          });
        };
        
        var editBtn = document.createElement('button');
        editBtn.className = 'btn-inline-edit';
        editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit';
        editBtn.title = 'Edit this BOO item';
        editBtn.type = 'button';
        editBtn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          expandInlineEditBOORow(clevel, bomop);
        };
        
        var deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn-inline-delete';
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete';
        deleteBtn.title = 'Delete this BOO item';
        deleteBtn.type = 'button';
        deleteBtn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          BooDeleteInline(clevel, bomop);
        };
        
        actionContainer.appendChild(addBtn);
        actionContainer.appendChild(editBtn);
        actionContainer.appendChild(deleteBtn);
        
        addBtn.addEventListener('mouseenter', function() {
          showInsertionIndicator(row);
        });
        
        addBtn.addEventListener('mouseleave', function() {
          hideInsertionIndicator();
        });
      } else {
        var st = cells.length > 2 ? cells[2].textContent.trim() : '';
        var clevel = cells.length > 20 ? cells[20].textContent.trim() : '';
        var bompt = cells.length > 0 ? cells[0].textContent.trim() : '';
        
        var addBtn = document.createElement('button');
        addBtn.className = 'btn-inline-add';
        addBtn.innerHTML = '<i class="fas fa-plus"></i>';
        addBtn.title = 'Añadir elemento debajo';
        addBtn.type = 'button';
        addBtn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          addBombLine({
            insertPosition: 'after',
            referenceLine: bompt,
            isBOO: false
          });
        };
        
        var editBtn = document.createElement('button');
        editBtn.className = 'btn-inline-edit';
        editBtn.innerHTML = '<i class="fas fa-edit"></i> Edit';
        editBtn.title = 'Edit this BOM item';
        editBtn.type = 'button';
        editBtn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          expandInlineEditRow(st, clevel, bompt);
        };
        
        var deleteBtn = document.createElement('button');
        deleteBtn.className = 'btn-inline-delete';
        deleteBtn.innerHTML = '<i class="fas fa-trash"></i> Delete';
        deleteBtn.title = 'Delete this BOM item';
        deleteBtn.type = 'button';
        deleteBtn.onclick = function(e) {
          e.preventDefault();
          e.stopPropagation();
          BomDeleteInline(clevel, bompt, st);
        };
        
        actionContainer.appendChild(addBtn);
        actionContainer.appendChild(editBtn);
        actionContainer.appendChild(deleteBtn);
        
        addBtn.addEventListener('mouseenter', function() {
          showInsertionIndicator(row);
        });
        
        addBtn.addEventListener('mouseleave', function() {
          hideInsertionIndicator();
        });
      }
      
      lastCell.appendChild(actionContainer);
      console.log('Successfully added inline buttons to row');
      
    } catch (e) {
      console.error('Error adding inline edit buttons:', e);
    }
  }
  
  function showInsertionIndicator(row) {
    try {
      hideInsertionIndicator();
      
      var indicator = document.createElement('div');
      indicator.className = 'insertion-indicator';
      indicator.style.position = 'absolute';
      indicator.style.left = '0';
      indicator.style.right = '0';
      indicator.style.height = '2px';
      indicator.style.background = 'repeating-linear-gradient(90deg, #3b82f6, #3b82f6 5px, transparent 5px, transparent 10px)';
      indicator.style.zIndex = '1000';
      indicator.style.animation = 'pulse 1.5s infinite';
      
      var rowRect = row.getBoundingClientRect();
      var tableRect = row.closest('table').getBoundingClientRect();
      
      indicator.style.top = (rowRect.bottom - tableRect.top) + 'px';
      
      row.closest('.table-container').style.position = 'relative';
      row.closest('.table-container').appendChild(indicator);
      
      var tooltip = document.createElement('div');
      tooltip.className = 'insertion-tooltip';
      tooltip.textContent = 'Se insertará aquí';
      tooltip.style.position = 'absolute';
      tooltip.style.left = '50%';
      tooltip.style.transform = 'translateX(-50%)';
      tooltip.style.top = (rowRect.bottom - tableRect.top + 10) + 'px';
      tooltip.style.background = '#1e293b';
      tooltip.style.color = 'white';
      tooltip.style.padding = '4px 8px';
      tooltip.style.borderRadius = '4px';
      tooltip.style.fontSize = '12px';
      tooltip.style.whiteSpace = 'nowrap';
      tooltip.style.zIndex = '1001';
      
      row.closest('.table-container').appendChild(tooltip);
      
    } catch (e) {
      console.error('Error showing insertion indicator:', e);
    }
  }
  
  function hideInsertionIndicator() {
    try {
      var indicators = document.querySelectorAll('.insertion-indicator, .insertion-tooltip');
      for (var i = 0; i < indicators.length; i++) {
        indicators[i].remove();
      }
    } catch (e) {
      console.error('Error hiding insertion indicator:', e);
    }
  }
  
  function sortBOMTable(headerCell) {
    try {
      var table = headerCell.closest('table');
      var tbody = table.querySelector('tbody');
      var rows = Array.from(tbody.querySelectorAll('tr'));
      var headerIndex = Array.from(headerCell.parentNode.children).indexOf(headerCell);
      var isAscending = headerCell.classList.contains('sort-asc');
      
      var headers = table.querySelectorAll('.excel-header');
      for (var i = 0; i < headers.length; i++) {
        headers[i].classList.remove('sort-asc', 'sort-desc');
      }
      
      headerCell.classList.add(isAscending ? 'sort-desc' : 'sort-asc');
      
      rows.sort(function(a, b) {
        var aValue = a.children[headerIndex].textContent.trim();
        var bValue = b.children[headerIndex].textContent.trim();
        
        var aNum = parseFloat(aValue);
        var bNum = parseFloat(bValue);
        
        if (!isNaN(aNum) && !isNaN(bNum)) {
          return isAscending ? aNum - bNum : bNum - aNum;
        }
        
        return isAscending ?
          aValue.localeCompare(bValue) :
          bValue.localeCompare(aValue);
      });
      
      for (var j = 0; j < rows.length; j++) {
        tbody.appendChild(rows[j]);
      }
    } catch (e) {
      console.error('Error sorting table:', e);
    }
  }
  
  document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing grid in 100ms');
    setTimeout(initializeBOMGrid, 100);
  });
  </script>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      width: 100%;
    }

    body {
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
      color: #334155;
      min-height: 100vh;
    }

    .container {
      width: 100%;
      min-height: 100vh;
      background: #fff;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #1e293b 0%, #1e3a8a 100%);
      color: #fff;
      padding: 12px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(30, 41, 59, 0.25);
      position: relative;
      z-index: 100;
      width: 100%;
      flex-shrink: 0;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .logo-section img {
      height: 40px;
      width: auto;
      object-fit: contain;
      filter: brightness(1.05);
    }

    .title-section {
      text-align: right;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .title-row {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 16px;
    }

    .welcome-user {
      white-space: nowrap;
      text-align: right;
    }

    .welcome-user span {
      color: #cbd5e1;
      font-size: 0.8em;
      font-weight: 400;
    }

    .welcome-user strong {
      color: #3b82f6;
      margin-left: 4px;
      font-weight: 600;
      font-size: 0.9em;
    }

    .title-section h2 {
      font-size: 1em;
      margin: 0;
      font-weight: 600;
      color: #f1f5f9;
      letter-spacing: 0.3px;
    }

    .title-section p {
      font-size: 0.8em;
      margin: 0;
      color: #a2a8ba;
    }

    .hamburger-menu {
      background: none;
      border: none;
      color: #fff;
      font-size: 1.2em;
      cursor: pointer;
      padding: 8px;
      border-radius: 6px;
      transition: background-color 0.2s ease;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .hamburger-menu:hover {
      background-color: rgba(255, 255, 255, 0.12);
    }

    .hamburger-menu svg {
      width: 24px;
      height: 24px;
      fill: #fff;
    }

    .hamburger-menu svg path {
      fill: #fff;
    }

    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      width: 100%;
      background: #f8fafc;
      height: calc(100vh - 60px);
    }

    .sidebar {
      position: fixed;
      top: 0;
      left: -300px;
      width: 300px;
      height: 100vh;
      background: rgba(255, 255, 255, 0.08);
      backdrop-filter: blur(1px);
      -webkit-backdrop-filter: blur(1px);
      color: #fff;
      transition: left 0.2s ease;
      z-index: 2000;
      box-shadow: 2px 0 12px rgba(0, 0, 0, 0.35);
      overflow: hidden;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.05);
    }

    .sidebar-header h3 {
      font-size: 1.1em;
      color: #fff;
      margin: 0;
    }

    .sidebar-content {
      padding: 24px;
    }

    .sidebar-menu {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .sidebar-menu li {
      margin-bottom: 10px;
    }

    .sidebar-menu label {
      display: block;
      padding: 12px 16px;
      color: #f3f4f6;
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.2s ease;
      font-weight: 500;
      cursor: pointer;
    }

    .sidebar-menu label:hover {
      background-color: rgba(30, 64, 175, 0.12);
      color: #fff;
    }

    .sidebar-menu label.active {
      background-color: rgba(30, 64, 175, 0.25);
      color: #93c5fd;
    }

    .sidebar-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.55);
      opacity: 0;
      visibility: hidden;
      transition: all 0.25s ease;
      z-index: 1500;
      pointer-events: none;
    }

    #sb-toggle:checked ~ .sidebar {
      left: 0;
    }

    #sb-toggle:checked ~ .sidebar-overlay {
      opacity: 1;
      visibility: visible;
      pointer-events: auto;
    }

    #sb-toggle {
      position: absolute;
      left: -9999px;
    }

    .bom-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 24px;
      padding: 24px;
      overflow-y: auto;
    }

    .bom-card {
      background: #fff;
      border-radius: 16px;
      padding: 32px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .bom-header {
      text-align: center;
      margin-bottom: 16px;
    }

    .bom-header h1 {
      font-size: 28px;
      font-weight: 700;
      color: #1e293b;
      margin-bottom: 8px;
    }

    .bom-header p {
      font-size: 16px;
      color: #64748b;
    }

    .bom-info {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .bom-title {
      font-size: 24px;
      font-weight: 700;
      color: #1e293b;
    }

    .bom-number {
      font-size: 18px;
      font-weight: 600;
      color: #3b82f6;
    }

    .action-buttons {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9em;
      cursor: pointer;
      border: none;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #1d4ed8 0%, #1e3a8a 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(29, 78, 216, 0.25);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(29, 78, 216, 0.35);
    }

    .btn-secondary {
      background: linear-gradient(135deg, #64748b 0%, #475569 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(71, 85, 105, 0.25);
    }

    .btn-secondary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(71, 85, 105, 0.35);
    }

    .btn-success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
    }

    .btn-success:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(16, 185, 129, 0.35);
    }

    .btn-danger {
      background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
      color: #fff;
      box-shadow: 0 4px 12px rgba(185, 28, 28, 0.25);
    }

    .btn-danger:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(185, 28, 28, 0.35);
    }

    .bom-content {
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
      flex: 1;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .bom-table-container {
      flex: 1;
      overflow: auto;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
    }

    .bom-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9em;
    }

    .bom-table th {
      background: #1e293b;
      color: #fff;
      padding: 12px;
      text-align: left;
      font-weight: 600;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .bom-table td {
      padding: 10px 12px;
      border-bottom: 1px solid #e2e8f0;
    }

    .bom-table tr:last-child td {
      border-bottom: none;
    }

    .bom-table tr:hover {
      background: #f8fafc;
    }

    .excel-grid-wrapper {
      background: rgba(255,255,255,.95);
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      overflow: hidden;
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
      width: 100%;
    }

    .grid-toolbar {
      background: #f8f9fa;
      padding: 12px 20px;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
    }

    .results-count {
      background: rgba(59,130,246,0.1);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: .85em;
      color: #64748b;
    }

    .excel-grid-container {
      flex: 1;
      overflow-y: auto;
      overflow-x: auto;
      border: 1px solid #dee2e6;
      border-radius: 0 0 12px 12px;
      background: #fff;
      position: relative;
      min-height: 250px;
      height: calc(100vh - 240px);
      width: 100%;
    }

    .excel-grid-container::-webkit-scrollbar {
      width: 12px;
    }

    .excel-grid-container::-webkit-scrollbar-track {
      background: #f1f3f4;
      border-radius: 6px;
    }

    .excel-grid-container::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg,#2a5298 0%,#1e3c72 100%);
      border-radius: 6px;
      border: 2px solid #f1f3f4;
    }

    .excel-grid-container::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);
    }

    table.excel-grid-premium {
      width: 100%;
      border-collapse: collapse;
      font-family: "Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
      font-size: 11px;
      background: #fff;
      min-width: 100%;
      border: 1px solid #dee2e6;
    }

    .excel-header {
      background: linear-gradient(135deg,#2a5298 0%,#1e3c72 100%);
      color: white;
      padding: 8px 12px;
      font-weight: 600;
      text-align: left;
      border-right: 1px solid #1e3c72;
      position: sticky;
      top: 0;
      z-index: 10;
      cursor: pointer;
      user-select: none;
      transition: all .2s ease;
      font-size: 11px;
    }

    .excel-header:hover {
      background: linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);
    }

    .excel-header.sorted {
      background: linear-gradient(135deg,#2a5298 0%,#1e3c72 100%);
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .sort-icon {
      opacity: .7;
      font-size: 12px;
      transition: opacity .2s ease;
    }

    .excel-header:hover .sort-icon {
      opacity: 1;
    }

    .resize-handle {
      position: absolute;
      right: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      cursor: col-resize;
      background: rgba(255,255,255,.2);
      opacity: 0;
      transition: opacity .2s ease;
    }

    .excel-header:hover .resize-handle {
      opacity: 1;
    }

    .excel-row {
      transition: all .2s ease;
      cursor: pointer;
    }

    .excel-row:nth-child(even) {
      background: #fafafa;
    }

    .excel-row:hover {
      background: #eef2ff;
    }

    .excel-row.selected {
      background: #dbeafe;
    }

    .filter-row th {
      background: #f1f5f9;
      position: sticky;
      top: 36px;
      z-index: 5;
    }

    .filter-cell {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
    }

    .filter-input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #cbd5e1;
      border-radius: 6px;
      font-size: 12px;
    }

    .toolbar-right {
      display: flex;
      gap: 8px;
    }

    .grid-btn {
      background: #e2e8f0;
      color: #1e293b;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .grid-btn:hover {
      filter: brightness(.95);
    }

    .excel-cell {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
    }

    .excel-cell.readonly {
      opacity: .85;
    }

    .cell-content {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .action-buttons {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .btn-sm {
      border: none;
      padding: 6px 8px;
      border-radius: 6px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn-edit {
      background: linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);
      color: #fff;
    }

    .btn-delete {
      background: linear-gradient(135deg,#ef4444 0%,#dc2626 100%);
      color: #fff;
    }

    .actions-header {
      min-width: 120px;
    }

    .table-container {
      width: 100%;
      overflow-x: auto;
    }

    .table-container table {
      width: 100%;
      border-collapse: collapse;
      font-family: "Segoe UI",Tahoma,Geneva,Verdana,sans-serif;
      font-size: 11px;
      background: #fff;
      min-width: 100%;
      border: 1px solid #dee2e6;
    }

    .table-container th {
      background: linear-gradient(135deg,#2a5298 0%,#1e3c72 100%);
      color: white;
      padding: 8px 12px;
      font-weight: 600;
      text-align: left;
      border-right: 1px solid #1e3c72;
      position: sticky;
      top: 0;
      z-index: 10;
      cursor: pointer;
      user-select: none;
      transition: all .2s ease;
      font-size: 11px;
    }

    .table-container th:hover {
      background: linear-gradient(135deg,#1e3c72 0%,#2a5298 100%);
    }

    .table-container td {
      padding: 8px 10px;
      border-bottom: 1px solid #e5e7eb;
    }

    .table-container tr:nth-child(even) {
      background: #fafafa;
    }

    .table-container tr:hover {
      background: #eef2ff;
    }

    .table-container tr.selected {
      background: #dbeafe;
    }

    .sub-bom {
      text-decoration: underline;
      color: #3b82f6;
      cursor: pointer;
    }

    .sub-bom:hover {
      color: #1d4ed8;
    }

    .inline-edit-row {
      display: none;
      background: #f8fafc;
      animation: slideDown 0.3s ease-out;
    }

    .inline-edit-row.active {
      display: table-row;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
        max-height: 0;
      }
      to {
        opacity: 1;
        transform: translateY(0);
        max-height: 200px;
      }
    }
    
    @keyframes slideUp {
      from {
        opacity: 1;
        transform: translateY(0);
        max-height: 200px;
      }
      to {
        opacity: 0;
        transform: translateY(-10px);
        max-height: 0;
      }
    }

    .inline-edit-container {
      padding: 20px;
      background: #f8fafc;
      border-left: 4px solid #3b82f6;
    }

    .inline-edit-form {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }

    .inline-edit-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .inline-edit-group label {
      font-weight: 600;
      color: #374151;
      font-size: 0.9em;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .inline-edit-group input,
    .inline-edit-group select,
    .inline-edit-group textarea {
      padding: 10px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 0.9em;
      transition: all 0.2s ease;
      background: #fff;
    }

    .inline-edit-group input:focus,
    .inline-edit-group select:focus,
    .inline-edit-group textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }

    .inline-edit-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
    }

    .inline-edit-btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.9em;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .inline-edit-btn.save {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }

    .inline-edit-btn.save:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: translateY(-1px);
    }

    .inline-edit-btn.cancel {
      background: #e5e7eb;
      color: #374151;
    }

    .inline-edit-btn.cancel:hover {
      background: #d1d5db;
    }

    .edit-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      background: #dbeafe;
      color: #1e40af;
      border-radius: 4px;
      font-size: 0.8em;
      font-weight: 600;
      margin-bottom: 12px;
    }

    .btn-inline-edit {
      background: linear-gradient(135deg,#3b82f6 0%,#1d4ed8 100%);
      color: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 0.8em;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s ease;
    }

    .btn-inline-edit:hover {
      background: linear-gradient(135deg,#1d4ed8 0%,#1e40af 100%);
      transform: translateY(-1px);
    }

    .btn-inline-delete {
      background: linear-gradient(135deg,#ef4444 0%,#dc2626 100%);
      color: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 0.8em;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: all 0.2s ease;
    }

    .btn-inline-delete:hover {
      background: linear-gradient(135deg,#dc2626 0%,#b91c1c 100%);
      transform: translateY(-1px);
    }
    
    .btn-inline-add {
      background: linear-gradient(135deg,#10b981 0%,#059669 100%);
      color: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 0.8em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      transition: all 0.2s ease;
      width: 28px;
      height: 28px;
      position: relative;
    }
    
    .btn-inline-add:hover {
      background: linear-gradient(135deg,#059669 0%,#047857 100%);
      transform: translateY(-1px) scale(1.1);
      box-shadow: 0 4px 8px rgba(16, 185, 129, 0.3);
    }
    
    .btn-inline-add:active {
      transform: translateY(0) scale(0.95);
    }
    
    .inline-add-bom-row {
      background: #f0f9ff;
      animation: slideDown 0.3s ease-out;
    }
    
    .inline-add-bom-container {
      padding: 16px;
      background: #f0f9ff;
      border-left: 4px solid #10b981;
      border-radius: 0 8px 8px 0;
    }
    
    .add-indicator {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: #dcfce7;
      color: #166534;
      border-radius: 4px;
      font-size: 0.9em;
      font-weight: 600;
      margin-bottom: 12px;
    }
    
    .inline-add-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .inline-add-group {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .inline-add-group label {
      font-weight: 600;
      color: #374151;
      font-size: 0.9em;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .inline-add-group input,
    .inline-add-group textarea {
      padding: 8px 12px;
      border: 2px solid #e5e7eb;
      border-radius: 6px;
      font-size: 0.9em;
      transition: all 0.2s ease;
      background: #fff;
    }
    
    .inline-add-group input:focus,
    .inline-add-group textarea:focus {
      outline: none;
      border-color: #10b981;
      box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    .inline-add-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e5e7eb;
    }
    
    .inline-add-btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 600;
      font-size: 0.9em;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    .inline-add-btn.save {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    
    .inline-add-btn.save:hover {
      background: linear-gradient(135deg, #059669 0%, #047857 100%);
      transform: translateY(-1px);
    }
    
    .inline-add-btn.cancel {
      background: #e5e7eb;
      color: #374151;
    }
    
    .inline-add-btn.cancel:hover {
      background: #d1d5db;
    }
    
    @keyframes pulse {
      0% { opacity: 0.6; }
      50% { opacity: 1; }
      100% { opacity: 0.6; }
    }
    
    .insertion-indicator {
      position: absolute;
      left: 0;
      right: 0;
      height: 2px;
      background: repeating-linear-gradient(90deg, #3b82f6, #3b82f6 5px, transparent 5px, transparent 10px);
      z-index: 1000;
      animation: pulse 1.5s infinite;
    }
    
    .insertion-tooltip {
      position: absolute;
      background: #1e293b;
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1001;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
    
    .insertion-tooltip::after {
      content: '';
      position: absolute;
      top: -4px;
      left: 50%;
      transform: translateX(-50%);
      border-width: 0 4px 4px 4px;
      border-style: solid;
      border-color: transparent transparent #1e293b transparent;
    }

    .notification-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .notification-modal.active {
      display: flex;
    }

    .notification-content {
      background: white;
      border-radius: 12px;
      padding: 24px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
      animation: modalSlideIn 0.3s ease-out;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .notification-header {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
    }

    .notification-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 16px;
    }

    .notification-icon.success {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
    }

    .notification-icon.error {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
    }

    .notification-icon.info {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
    }

    .notification-title {
      font-size: 18px;
      font-weight: 600;
      color: #1e293b;
    }

    .notification-message {
      color: #64748b;
      margin-bottom: 20px;
    }

    .notification-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .notification-btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
    }

    .notification-btn.primary {
      background: #3b82f6;
      color: white;
    }

    .notification-btn.primary:hover {
      background: #2563eb;
    }

    .notification-btn.secondary {
      background: #e5e7eb;
      color: #374151;
    }

    .notification-btn.secondary:hover {
      background: #d1d5db;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 16px;
    }

    .form-group label {
      font-size: 0.9em;
      font-weight: 600;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .form-group input {
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-size: 0.95em;
      transition: all 0.2s ease;
      background: #fff;
      color: #0f172a;
      width: 100%;
    }

    .form-group input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }

    .bom-text {
      width: 100%;
      min-height: 500px;
      padding: 12px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      font-family: monospace;
      font-size: 14px;
      resize: vertical;
    }

    .bom-text:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }

    .linkspan {
      color: #3b82f6;
      text-decoration: none;
      margin-right: 10px;
      font-weight: 500;
      transition: color 0.2s ease;
    }

    .linkspan:hover {
      color: #1d4ed8;
      cursor: pointer;
    }

    .linkspan2 {
      color: #000;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.2s ease;
    }

    .linkspan2:hover {
      color: #3b82f6;
      cursor: pointer;
    }

    .error-message {
      color: #ef4444;
      font-size: 0.9em;
      font-weight: 600;
      padding: 8px 12px;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 8px;
      border: 1px solid rgba(239, 68, 68, 0.2);
      margin-top: 8px;
    }

    .table-container {
      width: 100%;
      overflow-x: auto;
    }
    
    .table-container td a:not(.btn-inline-edit):not(.btn-inline-delete):not(.btn-inline-add):not(.sub-bom) {
      display: none !important;
      opacity: 0 !important;
      visibility: hidden !important;
      width: 0 !important;
      height: 0 !important;
      position: absolute !important;
      left: -9999px !important;
    }
    
    .table-container td a[href^="javascript:"]:not(.btn-inline-edit):not(.btn-inline-delete):not(.btn-inline-add) {
      display: none !important;
    }

    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        align-items: flex-start;
        gap: 16px;
      }

      .title-section {
        text-align: left;
        align-items: flex-start;
      }

      .title-row {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }

      .bom-wrapper {
        padding: 16px;
      }

      .bom-card {
        padding: 24px;
      }

      .action-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body onload="sizeUp()">
  <input type="checkbox" id="sb-toggle">
  <label for="sb-toggle" class="sidebar-overlay" aria-hidden="true"></label>

  <aside class="sidebar" aria-label="Main menu">
    <div class="sidebar-header">
      <h3>Menu</h3>
    </div>
    <div class="sidebar-content">
      <ul class="sidebar-menu">
        <li><label for="sb-toggle">Main Menu</label></li>
        <li><label for="sb-toggle">Parts Management</label></li>
        <li><label for="sb-toggle">Work Orders</label></li>
        <li><label for="sb-toggle">Sales Orders</label></li>
        <li><label for="sb-toggle">Stock Transactions</label></li>
        <li><label for="sb-toggle" class="active">BOM Management</label></li>
      </ul>
    </div>
  </aside>

  <div class="container">
    <header class="header">
      <div class="header-left">
        <label class="hamburger-menu" for="sb-toggle" aria-label="Open menu">
          <svg viewBox="0 0 448 512" role="img" aria-hidden="true" focusable="false" width="20" height="20">
            <path d="M0 96C0 78.3 14.3 64 32 64H416C433.7 64 448 78.3 448 96C448 113.7 433.7 128 416 128H32C14.3 128 0 113.7 0 96zM0 256C0 238.3 14.3 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.3 288 0 273.7 0 256zM448 416C448 433.7 433.7 448 416 448H32C14.3 448 0 433.7 0 416C0 398.3 14.3 384 32 384H416C433.7 384 448 398.3 448 416z"></path>
          </svg>
        </label>
        <div class="logo-section">
          <img src="http://54.189.226.145/uploads/assets/images/taimex_logo.png" alt="TAIMEX INDUSTRIAL" onerror="this.onerror=null;this.src='http://54.189.226.145/uploads/assets/images/taimex_logo.png';">
        </div>
      </div>
      <div class="title-section">
        <div class="title-row">
          <div class="welcome-user">
            <span>Welcome,</span>
            <strong id="currentUserDisplay">Operator</strong>
          </div>
          <div>
            <h2>TAIMEX - BOM EDITOR</h2>
            <p>TAIMEX - MANAGEMENT</p>
          </div>
        </div>
      </div>
    </header>

    <main class="main-content">
      <div class="bom-wrapper">
        <div class="bom-card">
          <div class="bom-header">
            <h1>BOM Entry and Editor</h1>
            <p>Manage your Bill of Materials</p>
          </div>

          <form id="frmBOM" name="frmBOM" method="POST" action="BOM_EDIT_FIXED.HTM">
            <div class="bom-info">
              <div>
                <div class="bom-title">
                  <span class="linkspan2" onclick="YorkBom()">^NBOM^</span>
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="ECN">
                <i class="fas fa-file-alt" style="color: #1e40af;"></i>
                ECN:
              </label>
              <input type="text" id="ECN" name="ECN" value="^ECN^">
            </div>

            <div class="error-message" id="errorMessage" style="display: none;">
              ^EMSG^
            </div>

            <div class="action-buttons">
              <span class="linkspan" onclick="PrintBom()">
                <i class="fas fa-print"></i>
                View Print Copy
              </span>
            </div>

            <div class="excel-grid-wrapper">
              <div class="grid-toolbar">
                <div class="toolbar-left">
                  <span class="results-count">
                    <i class="fas fa-database"></i>
                    <span id="recordsCount">BOM Records</span>
                  </span>
                </div>
                <div class="toolbar-right">
                  <button type="button" class="grid-btn" onclick="PrintBom()">
                    <i class="fas fa-print"></i> Print BOM
                  </button>
                  <button type="button" class="grid-btn" onclick="YorkBom()">
                    <i class="fas fa-file-export"></i> York BOM
                  </button>
                  <button type="button" class="grid-btn" onclick="addBombLine('at-end')">
                    <i class="fas fa-plus"></i> Add BOM Line
                  </button>
                  <button type="button" class="grid-btn" onclick="BooAdd()">
                    <i class="fas fa-plus"></i> Add BOO Line
                  </button>
                </div>
              </div>
              <div class="excel-grid-container">
                <div class="table-container">
                  ^RAW(RESULT)^
                </div>
              </div>
            </div>

            <div class="form-group">
              <label for="BOMTXT">
                <i class="fas fa-file-code" style="color: #1e40af;"></i>
                BOM Text:
              </label>
              <textarea class="bom-text" id="BOMTXT" name="BOMTXT">
^BOMTXT.REC^
              </textarea>
            </div>

            <div class="action-buttons">
              <span class="linkspan" onclick="BomTxtEdit()">
                <i class="fas fa-save"></i>
                Update BOMTXT
              </span>
              <span class="linkspan" onclick="GoMenu()">
                <i class="fas fa-arrow-left"></i>
                Menu
              </span>
            </div>

            <input type="hidden" name="NBOM" id="NBOM" value="^NBOM^">
            <input type="hidden" name="BOMPT" id="BOMPT" value="">
            <input type="hidden" name="BOMOP" id="BOMOP" value="">
            <input type="hidden" name="COSTLEVEL" id="COSTLEVEL" value="">
            <input type="hidden" name="RMSEQ" id="RMSEQ" value="">
            <input type="hidden" name="EVENT" id="EVENT" value="">
            <input type="hidden" name="REFERENCE_LINE" id="REFERENCE_LINE" value="">
            <input type="hidden" name="INSERT_POSITION" id="INSERT_POSITION" value="">
            <input type="hidden" name="QUANTITY" id="QUANTITY" value="">
            <input type="hidden" name="DESCRIPTION" id="DESCRIPTION" value="">
            <input type="hidden" name="BOO_DESCRIPTION" id="BOO_DESCRIPTION" value="">
            <input type="hidden" name="BOO_TIME" id="BOO_TIME" value="">
            <input type="hidden" name="BOO_LABOR" id="BOO_LABOR" value="">
          </form>
        </div>
      </div>
    </main>
  </div>

  <!-- Notification Modal -->
  <div id="notificationModal" class="notification-modal">
    <div class="notification-content">
      <div class="notification-header">
        <div id="notificationIcon" class="notification-icon info">
          <i class="fas fa-info"></i>
        </div>
        <div>
          <h3 id="notificationTitle" class="notification-title">Notification</h3>
        </div>
      </div>
      <p id="notificationMessage" class="notification-message">Operation completed successfully.</p>
      <div class="notification-actions">
        <button id="notificationSecondaryBtn" class="notification-btn secondary" style="display: none;">Cancel</button>
        <button id="notificationPrimaryBtn" class="notification-btn primary">OK</button>
      </div>
    </div>
  </div>

  <div align="left">
<pre>
PicLan-IP/BASIC ^ ^
*
PL_GET_COOKIE INITIALS FROM 'INIT' ELSE
    ERR = '' ; INITIALS=  ''
    CALL PLW.PAGE('LOGINWH.HTM','',ERR)
    RETURN
END
*
PL_GETVAR NBOM FROM 'NBOM' ELSE NBOM = ''
PL_GETVAR ECN FROM 'ECN' ELSE ECN = ''
PL_GETVAR BOMPT FROM 'BOMPT' ELSE BOMPT = ''
PL_GETVAR BOMOP FROM 'BOMOP' ELSE BOMOP = ''
PL_GETVAR COSTLEVEL FROM 'COSTLEVEL' ELSE COSTLEVEL = ''
PL_GETVAR EVENT FROM 'EVENT' ELSE EVENT = ''
PL_GETVAR RMSEQ FROM 'RMSEQ' ELSE RMSEQ = ''
PL_GETVAR BOMTXT FROM 'BOMTXT' ELSE BOMTXT = ''
PL_GETVAR REFERENCE_LINE FROM 'REFERENCE_LINE' ELSE REFERENCE_LINE = ''
PL_GETVAR INSERT_POSITION FROM 'INSERT_POSITION' ELSE INSERT_POSITION = ''
PL_GETVAR QUANTITY FROM 'QUANTITY' ELSE QUANTITY = ''
PL_GETVAR DESCRIPTION FROM 'DESCRIPTION' ELSE DESCRIPTION = ''
PL_GETVAR BOO_DESCRIPTION FROM 'BOO_DESCRIPTION' ELSE BOO_DESCRIPTION = ''
PL_GETVAR BOO_TIME FROM 'BOO_TIME' ELSE BOO_TIME = ''
PL_GETVAR BOO_LABOR FROM 'BOO_LABOR' ELSE BOO_LABOR = ''
TS = DATE():TIME()
RESULT = ''
EMSG = ''
*
* Initialize working variables
TMP = ''
LINE = ''
PN = ''
CL = ''
ST = ''
DELIM = ''
NEW.LINE = ''
NEW.POS = 0
OP = ''
TOTAL = 0
INSERTED = 0
INTFND = 0
CNTR = 0
I = 0
J = 0
K = 0
EBOM = ''
EBOO = ''
BT.REC = ''
BOMTXT.REC = ''
*
OPEN 'EBOO' TO BOO.FILE ELSE GOTO done
OPEN 'EBOM' TO BOM.FILE ELSE GOTO done
OPEN 'BOMTXT' TO BOMTXT.FILE ELSE GOTO done
IF EVENT NE '' THEN
IF EVENT = 'menu' THEN
  EVENT = ''
  PL_PUTVAR EVENT IN 'EVENT' ELSE NULL
  ERR = ''
  CALL PLW.PAGE('CDABOMMENU.HTM','',ERR)
  RETURN
END
IF EVENT = 'bomadd' THEN
  EVENT = ''
  PL_PUTVAR NBOM IN 'NBOM' ELSE NULL
  PL_PUTVAR EVENT IN 'EVENT' ELSE NULL
  PL_PUTVAR ECN IN 'ECN' ELSE NULL
  ERR = ''
  CALL PLW.PAGE('CDABOMADD.HTM','',ERR)
  RETURN
END
IF EVENT = 'booadd' THEN
  EVENT = ''
  PL_PUTVAR NBOM IN 'NBOM' ELSE NULL
  PL_PUTVAR EVENT IN 'EVENT' ELSE NULL
  PL_PUTVAR ECN IN 'ECN' ELSE NULL
  ERR = ''
  CALL PLW.PAGE('CDABOOADD.HTM','',ERR)
  RETURN
END
IF EVENT = 'bomedit' THEN
  EVENT = ''
  PL_PUTVAR NBOM IN 'NBOM' ELSE NULL
  PL_PUTVAR BOMPT IN 'BOMPT' ELSE NULL
  PL_PUTVAR COSTLEVEL IN 'COSTLEVEL' ELSE NULL
  PL_PUTVAR EVENT IN 'EVENT' ELSE NULL
  PL_PUTVAR RMSEQ IN 'RMSEQ' ELSE NULL
  PL_PUTVAR ECN IN 'ECN' ELSE NULL
  ERR = ''
  CALL PLW.PAGE('CDABOMEDIT3.HTM','',ERR)
  RETURN
END
IF EVENT = 'booedit' THEN
  EVENT = ''
  PL_PUTVAR NBOM IN 'NBOM' ELSE NULL
  PL_PUTVAR BOMOP IN 'BOMOP' ELSE NULL
  PL_PUTVAR COSTLEVEL IN 'COSTLEVEL' ELSE NULL
  PL_PUTVAR EVENT IN 'EVENT' ELSE NULL
  PL_PUTVAR ECN IN 'ECN' ELSE NULL
  ERR = ''
  CALL PLW.PAGE('CDABOOEDIT.HTM','',ERR)
  RETURN
END
IF EVENT = 'savebomaddafter' THEN
  EVENT = ''
  IF QUANTITY = '' THEN QUANTITY = '1'
  IF NBOM = '' THEN
    EMSG = 'Missing BOM number'
    GOTO done
  END
  IF BOMPT = '' THEN
    EMSG = 'Part number is required'
    GOTO done
  END
  IF RMSEQ = '' THEN
    EMSG = 'Sequence is required'
    GOTO done
  END
  IF COSTLEVEL = '' THEN
    EMSG = 'Cost level is required'
    GOTO done
  END
  READ EBOM FROM BOM.FILE,NBOM ELSE
    EMSG = 'BOM Record not found'
    GOTO done
  END
  DELIM = ' '
  BOMPT = OCONV(BOMPT,'mcu')
  REFERENCE_LINE = OCONV(REFERENCE_LINE,'mcu')
  DESCRIPTION = OCONV(DESCRIPTION,'mcu')
  COSTLEVEL = OCONV(COSTLEVEL,'mcu')
  RMSEQ = OCONV(RMSEQ,'mcu')
  IF INSERT_POSITION = '' THEN INSERT_POSITION = 'at-end'
  NEW.LINE = BOMPT:DELIM:DESCRIPTION:DELIM:RMSEQ:DELIM:QUANTITY:DELIM:'EA':DELIM:'':DELIM:'':DELIM:'':DELIM:'':DELIM:'':DELIM:'':DELIM:'':DELIM:'':DELIM:'':DELIM:'':DELIM:'':DELIM:COSTLEVEL:DELIM:'':DELIM:'':DELIM:'':DELIM:'':DELIM:''
  TMP = ''
  INSERTED = 0
  TOTAL = DCOUNT(EBOM,@AM)
  IF TOTAL = 0 THEN
    TMP<1> = NEW.LINE
    INSERTED = 1
  END ELSE
    FOR I = 1 TO TOTAL
      LINE = EBOM<I>
      TMP<DCOUNT(TMP,@AM)+1> = LINE
      PN = FIELD(LINE,DELIM,1)
      PN = OCONV(PN,'mcu')
      IF INSERTED = 0 AND INSERT_POSITION = 'after' AND REFERENCE_LINE NE '' THEN
        IF PN = REFERENCE_LINE THEN
          TMP<DCOUNT(TMP,@AM)+1> = NEW.LINE
          INSERTED = 1
        END
      END
    NEXT I
  END
  IF INSERTED = 0 THEN
    TMP<DCOUNT(TMP,@AM)+1> = NEW.LINE
  END
  WRITE TMP ON BOM.FILE,NBOM
  BOMPT = ''
  COSTLEVEL = ''
  RMSEQ = ''
  QUANTITY = ''
  DESCRIPTION = ''
  REFERENCE_LINE = ''
  INSERT_POSITION = ''
  GOTO done
END
IF EVENT = 'savebooaddafter' THEN
  EVENT = ''
  IF NBOM = '' THEN
    EMSG = 'Missing BOM number'
    GOTO done
  END
  IF BOMOP = '' THEN
    EMSG = 'Operation code is required'
    GOTO done
  END
  IF COSTLEVEL = '' THEN
    EMSG = 'Cost level is required'
    GOTO done
  END
  READ EBOO FROM BOO.FILE,NBOM ELSE
    EMSG = 'BOO Record not found'
    GOTO done
  END
  BOMOP = OCONV(BOMOP,'mcu')
  REFERENCE_LINE = OCONV(REFERENCE_LINE,'mcu')
  BOO_DESCRIPTION = OCONV(BOO_DESCRIPTION,'mcu')
  COSTLEVEL = OCONV(COSTLEVEL,'mcu')
  IF INSERT_POSITION = '' THEN INSERT_POSITION = 'at-end'
  
  * Initialize BOO structure if empty
  IF EBOO = '' THEN
    EBOO = ''
    FOR I = 1 TO 20
      EBOO<I> = ''
    NEXT I
  END
  
  * Find insertion point
  TOTAL = DCOUNT(EBOO<7>,@VM)
  INSERTED = 0
  
  IF INSERT_POSITION = 'after' AND REFERENCE_LINE NE '' THEN
    * Find the reference operation and insert after it
    FOR I = 1 TO TOTAL
      OP = EBOO<7,I>
      OP = OCONV(OP,'mcu')
      IF OP = REFERENCE_LINE AND INSERTED = 0 THEN
        * Insert new operation after this one
        FOR J = TOTAL TO I+1 STEP -1
          EBOO<6,J+1> = EBOO<6,J>
          EBOO<7,J+1> = EBOO<7,J>
          EBOO<8,J+1> = EBOO<8,J>
          EBOO<9,J+1> = EBOO<9,J>
          EBOO<14,J+1> = EBOO<14,J>
        NEXT J
        * Set the new operation values
        EBOO<6,I+1> = COSTLEVEL
        EBOO<7,I+1> = BOMOP
        EBOO<8,I+1> = BOO_DESCRIPTION
        EBOO<9,I+1> = BOO_TIME
        EBOO<14,I+1> = BOO_LABOR
        INSERTED = 1
        EXIT
      END
    NEXT I
  END
  
  * If not inserted after reference, add at end
  IF INSERTED = 0 THEN
    NEW.POS = TOTAL + 1
    EBOO<6,NEW.POS> = COSTLEVEL
    EBOO<7,NEW.POS> = BOMOP
    EBOO<8,NEW.POS> = BOO_DESCRIPTION
    EBOO<9,NEW.POS> = BOO_TIME
    EBOO<14,NEW.POS> = BOO_LABOR
  END
  
  * Update sequence numbers
  EBOO<5> = ''
  FOR I = 1 TO DCOUNT(EBOO<7>,@VM)
    EBOO<5,I> = I
  NEXT I
  
  WRITE EBOO ON BOO.FILE,NBOM
  BOMOP = ''
  COSTLEVEL = ''
  BOO_DESCRIPTION = ''
  BOO_TIME = ''
  BOO_LABOR = ''
  REFERENCE_LINE = ''
  INSERT_POSITION = ''
  GOTO done
END
IF EVENT = 'bomdelete' THEN
  EVENT = ''
  CNTR = 0
  DELIM = ' '
  TMP = ''
*  IF BOMPT NE '' AND COSTLEVEL NE '' AND RMSEQ NE '' THEN
  IF BOMPT NE '' THEN
    READ EBOM FROM BOM.FILE,NBOM ELSE
      EMSG = 'BOM Record not found'
      GOTO done
    END
    INTFND = 0
    FOR I = 1 TO DCOUNT(EBOM,@AM)
      LINE = EBOM<I>
      PN = FIELD(EBOM<I>,DELIM,1)
      CL = FIELD(EBOM<I>,DELIM,21)
      CL = OCONV(CL,'mcn')
      ST = FIELD(EBOM<I>,DELIM,3)
*     IF BOMPT = PN AND COSTLEVEL = CL AND RMSEQ = ST THEN
      IF BOMPT = PN THEN
        INTFND = 1
      END ELSE
        CNTR = CNTR + 1
        TMP<CNTR> = LINE
      END
    NEXT I
    IF INTFND = 1 THEN
      WRITE TMP ON BOM.FILE,NBOM
    END
    BOMPT = ''
    COSTLEVEL = ''
  END
END
IF EVENT = 'boodelete' THEN
  EVENT = ''
  IF BOMOP NE '' AND COSTLEVEL NE '' THEN
    READ EBOO FROM BOO.FILE,NBOM ELSE
      EMSG = 'BOO Record not found'
      GOTO done
    END
    INTFND = 0
    FOR I = 1 TO DCOUNT(EBOO<5>,@VM)
      CL = EBOO<6,I>
      OP = EBOO<7,I>
      IF CL = COSTLEVEL AND OP = BOMOP AND INTFND NE '1' THEN
          INTFND = 1
          EBOO = DELETE(EBOO,6,I)
          EBOO = DELETE(EBOO,7,I)
          EBOO = DELETE(EBOO,8,I)
          EBOO = DELETE(EBOO,9,I)
          EBOO = DELETE(EBOO,14,I)
      END
    NEXT I
    IF INTFND = 1 THEN
      EBOO<5> = ''
      FOR I = 1 TO DCOUNT(EBOO<7>,@VM)
        EBOO<5,I> = I
      NEXT I
      WRITE EBOO ON BOO.FILE,NBOM
    END
    BOMOP = ''
    COSTLEVEL = ''
  END
END
IF EVENT = 'bomtxtedit' THEN
  IF BOMTXT NE '' THEN
    READ EBOM FROM BOM.FILE,NBOM ELSE
      EMSG = 'BOM Record not found'
      GOTO done
    END
    READ BT.REC FROM BOMTXT.FILE,NBOM ELSE
      EMSG = 'BOMTXT Record not found'
      GOTO done
    END
    BOMTXT = PL_CRLFTOAM(BOMTXT)
    BT.REC = BOMTXT
    BT.REC = OCONV(BT.REC,'mcu')
    WRITE BT.REC ON BOMTXT.FILE,NBOM
  END
END
END
done:
BOMTXT.REC = ''
CALL BUILDBOMTABLE(NBOM,RESULT,BOMTXT.REC,EMSG)
BOMTXT.REC = PL_AMTOCRLF(BOMTXT.REC)
</pre>
  </div>
</body>
</html>